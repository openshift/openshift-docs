[[install-config-deploy-registry-existing-clusters]]
= Deploying a Registry on Existing Clusters
{product-author}
{product-version]
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

ifdef::openshift-origin,openshift-enterprise,openshift-dedicated[]
== Overview

If the integrated registry was not previously deployed automatically during the
initial installation of your {product-title} cluster, or if it is no longer
running successfully and you need to redeploy it on your existing cluster, see
the following sections for options on deploying a new registry.

[NOTE]
====
This topic is not required if you installed a
xref:../../install_config/install/stand_alone_registry.adoc#install-config-registry-installing-stand-alone[stand-alone
registry].
====
endif::[]

[[deploy-registry]]
== Deploying the Registry

ifdef::atomic-registry[]
[NOTE]
====
Until an advanced installation method for {product-title} is tested and documented, refer to the
xref:../../registry_quickstart/administrators/index.adoc#registry-quickstart-administrators-index[quickstart install]
information.
====
endif::[]

ifdef::openshift-origin[]
To deploy the integrated Docker registry, use the `oadm registry` command from
the *_admin.kubeconfig_* file's location, as a user with cluster administrator
privileges:

----
$ oadm registry --config=admin.kubeconfig \//<1>
    --service-account=registry <2>
----
endif::[]
ifdef::openshift-enterprise[]
To deploy the integrated Docker registry, use the `oadm registry` command as a
user with cluster administrator privileges. For example:

----
$ oadm registry --config=/etc/origin/master/admin.kubeconfig \//<1>
    --service-account=registry \//<2>
    --images='registry.access.redhat.com/openshift3/ose-${component}:${version}' <3>
----
endif::[]
ifdef::openshift-origin,openshift-enterprise,openshift-dedicated[]
<1> `--config` is the path to the
xref:../../cli_reference/manage_cli_profiles.adoc#cli-reference-manage-cli-profiles[CLI configuration file] for
the xref:../../architecture/additional_concepts/authorization.adoc#roles[cluster
administrator].
<2> `--service-account` is the service account used to run the registry's pod.
endif::[]
ifdef::openshift-enterprise[]
<3> Required to pull the correct image for {product-title}.
endif::[]

ifdef::openshift-origin,openshift-enterprise,openshift-dedicated[]
This creates a service and a deployment configuration, both called
*docker-registry*. Once deployed successfully, a pod is created with a name
similar to *docker-registry-1-cpty9*.

To see a full list of options that you can specify when creating the registry:

----
$ oadm registry --help
----
endif::[]

=== Deploying the Registry as a DaemonSet

Use the `oadm registry` command to deploy the registry as a DaemonSet with the
`--daemonset` option.

Daemonsets ensure that when nodes are created, they contain copies of a
specified pod. When the nodes are removed, the pods are garbage collected.

For more information on DaemonSets, see the
link:http://kubernetes.io/docs/admin/daemons/[DaemonSet documentation].

[NOTE]
====
Using DaemonSets with {product-title} is a work in progress, and the only
supported process is creating a registry. Currently, using deployment
configurations to deploy a registry is recommended.
====

ifdef::openshift-enterprise,openshift-origin[]
[[registry-compute-resource]]
=== Registry Compute Resources

By default, the registry is created with no settings for
xref:../../dev_guide/compute_resources.adoc#dev-guide-compute-resources[compute resource requests or
limits]. For production, it is highly recommended that the deployment
configuration for the registry be updated to set resource requests and limits
for the registry pod. Otherwise, the registry pod will be considered a
xref:../../dev_guide/compute_resources.adoc#quality-of-service-tiers[*BestEffort*
pod].

See xref:../../dev_guide/compute_resources.adoc#dev-guide-compute-resources[Compute Resources] for more
information on configuring requests and limits.
endif::openshift-enterprise,openshift-origin[]

[[storage-for-the-registry]]
=== Storage for the Registry

The registry stores Docker images and metadata. If you simply deploy a pod with
the registry, it uses an ephemeral volume that is destroyed if the pod exits.
Any images anyone has built or pushed into the registry would disappear.

ifdef::atomic-registry[]
[IMPORTANT]
====
Be careful when re-deploying the registry if the
xref:../../registry_quickstart/administrators/index.adoc#registry-quickstart-administrators-index[quickstart method] was
used. The quickstart method maps the registry service to host ports. This mapping must be updated when the registry is
re-deployed.

----
$ oc patch service docker-registry -p \
     '{ "spec": { "type": "NodePort", "selector": {"docker-registry": "default"},
        "ports": [ {"nodePort": 5000, "port": 5000, "targetPort": 5000}] }}'
----
====
endif::[]

[[registry-production-use]]
==== Production Use

For production use, attach a remote volume or
xref:../../install_config/persistent_storage/index.adoc#install-config-persistent-storage-index[define and use the
persistent storage method of your choice].

For example, to use an existing persistent volume claim:

----
$ oc volume deploymentconfigs/docker-registry --add --name=registry-storage -t pvc \
     --claim-name=<pvc_name> --overwrite
----

Or, to attach an existing NFS volume to the registry:

----
$ oc volume deploymentconfigs/docker-registry \
     --add --overwrite --name=registry-storage --mount-path=/registry \
     --source='{"nfs": { "server": "<fqdn>", "path": "/path/to/export"}}'
----

[NOTE]
====
See xref:registry-known-issues[Known Issues] if using a scaled registry with a
shared NFS volume.
====

[[registry-amazon-s3-storage-back-end]]
===== Use Amazon S3 as a Storage Back-end

There is also an option to use Amazon Simple Storage Service storage with the
internal Docker registry. It is a secure cloud storage manageable through
link:https://aws.amazon.com/s3/getting-started/[AWS Management Console]. To use
it, the registry's configuration file must be manually edited and mounted to
the registry pod. However, before you start with the configuration, look at
upstream's
link:https://docs.docker.com/docker-trusted-registry/configure/config-storage/#amazon-s3[recommended
steps].

Take a xref:docker-registry-deploying-updated-configuration[default YAML
configuration file] as a base and replace the *filesystem* entry in the
*storage* section with *s3* entry such as below. The resulting storage section
may look like this:

====
[source,yaml]
----
storage:
  cache:
    layerinfo: inmemory
  delete:
    enabled: true
  s3:
    accesskey: awsaccesskey
    secretkey: awssecretkey
    region: us-west-1
    regionendpoint: http://myobjects.local
    bucket: bucketname
    encrypt: true
    keyid: mykeyid
    secure: true
    v4auth: false
    chunksize: 5242880
    rootdirectory: /s3/object/name/prefix
----
====

All of the *s3* configuration options are documented in upstream's
link:https://docs.docker.com/registry/storage-drivers/s3/[driver reference
documentation].

xref:advanced-overriding-the-registry-configuration[Overriding the registry
configuration] will take you through the additional steps on mounting the
configuration file into pod.

[WARNING]
====
When the registry runs on the S3 storage back-end, there are
xref:known-issue-s3-image-push-fails[reported issues].
====

[[registry-non-production-use]]
==== Non-Production Use

For non-production use, you can use the `--mount-host=<path>` option to specify
a directory for the registry to use for persistent storage. The registry volume
is then created as a host-mount at the specified `<path>`.

[IMPORTANT]
====
The `--mount-host` option mounts a directory from the node on which the registry
container lives. If you scale up the *docker-registry* deployment configuration,
it is possible that your registry pods and containers will run on different
nodes, which can result in two or more registry containers, each with its own
local storage. This will lead to unpredictable behavior, as subsequent requests
to pull the same image repeatedly may not always succeed, depending on which
container the request ultimately goes to.
====

The `--mount-host` option requires that the registry container run in privileged
mode. This is automatically enabled when you specify `--mount-host`.
However, not all pods are allowed to run
xref:prerequisites.adoc#security-warning[privileged containers] by default.
ifdef::openshift-enterprise[]
If you still want to use this option, create the registry and specify that it use the *registry* service account that was created during installation:
endif::[]
ifdef::openshift-origin[]
If you still want to use this option:

. Create a new xref:../../admin_guide/service_accounts.adoc#admin-guide-service-accounts[service account] in
the *default* project for the registry to run as. The following example creates
a service account named *registry*:
+
----
$ oc create serviceaccount registry -n default
----

. To add the new *registry* service account in the *default* namespace
to the list of users allowed to run privileged containers:
+
----
$ oadm policy add-scc-to-user privileged system:serviceaccount:default:registry
----

. Create the registry and specify that it use the new *registry* service
account:
+
----
$ oadm registry --service-account=registry \
    --config=admin.kubeconfig \
    --mount-host=<path>
----
endif::[]
ifdef::openshift-enterprise[]
----
$ oadm registry --service-account=registry \
    --config=/etc/origin/master/admin.kubeconfig \
    --images='registry.access.redhat.com/openshift3/ose-${component}:${version}' \
    --mount-host=<path>
----
endif::[]

[IMPORTANT]
====
The Docker registry pod runs as user *1001*. This user must be able to write to
the host directory. You may need to change directory ownership to user ID *1001*
with this command:

----
$ sudo chown 1001:root <path>
----
====
endif::[]
