[[install-config-redeploying-certificates]]
= Redeploying Certificates
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]

== Overview
This topic reviews how to back up and redeploy cluster certificates using the
`ansible-playbook` command. This method fixes common certificate errors. Possible use
cases include:

- The installer detected the wrong host names and the issue was identified too late.
- The certificates are expired and you need to update them.
- You have a new CA and would like to create certificates using it instead

[[install-config-running-the-certificate-redeploy-playbook]]
== Running the Certificate Redeploy Playbook

Running the certificate redeploy playbook will redeploy {product-title}
certificates that exist on systems (master, node, etcd):

----
$ ansible-playbook -i <inventory> playbooks/byo/openshift-cluster/redeploy-certificates.yml
----

[WARNING]
====
This playbook must be run with an inventory that is representative of the
cluster. The inventory must specify or override all host names and IP addresses
set via `*openshift_hostname*`, `*openshift_public_hostname*`, `*openshift_ip*`,
`*openshift_public_ip*`, `*openshift_master_cluster_hostname*`, or
`*openshift_master_cluster_public_hostname*` such that they match the current
cluster configuration.
====

By default, the redeploy playbook does _not_ redeploy the {product-title} CA.
New certificates are created using the original {product-title} CA.

To redeploy all certificates including the {product-title} CA, specify
`openshift_certificates_redeploy_ca=true`.

For example:

----
$ ansible-playbook -i <inventory> playbooks/byo/openshift-cluster/redeploy-certificates.yml \
--extra-vars "openshift_certificates_redeploy_ca=true"
----

This also adds a
xref:../install_config/certificate_customization.adoc#install-config-certificate-customization[custom
CA certificate]:

====
----
# Configure custom ca certificate
# NOTE: CA certificate will not be replaced with existing clusters.
# This option may only be specified when creating a new cluster or
# when redeploying cluster certificates with the redeploy-certificates
# playbook.
#openshift_master_ca_certificate={'certfile': '/path/to/ca.crt', 'keyfile': '/path/to/ca.key'}
----
====

All pods using service accounts to communicate with the {product-title} API must
be redeployed when the {product-title} CA is replaced so the certificate
redeploy playbook will serially evacuate all nodes in the cluster when this
variable is set.

[[manually-update-certificates-for-the-registry-and-router]]
== Manually Update Certificates for the Registry and Router

When nodes are evacuated, routers are restarted and outages to data plans are
possible. This results in the routers not being able to reach the masters
because they have old certificates. To manually update certificates:

. Add registry certificates to a secret named `registry-certificates`. To update
the certificate, create a new certificate, then update it within the
`registry-certificates` secret:
+
----
REGISTRY_IP=`oc get service docker-registry -o jsonpath='{.spec.clusterIP}'`

REGISTRY_HOSTNAME=`oc get route/docker-registry -o jsonpath='{.spec.host}'`

$ oc adm ca create-server-cert \
  --signer-cert=/etc/origin/master/ca.crt \
  --signer-key=/etc/origin/master/ca.key \
  --hostnames=$REGISTRY_IP,docker-registry.default.svc.cluster.local,$REGISTRY_HOSTNAME \
  --cert=/etc/origin/master/registry.crt \
  --key=/etc/origin/master/registry.key \
  --signer-serial=/etc/origin/master/ca.serial.txt

$ oc secret new registry-certificates \
  /etc/origin/master/registry.crt \
  /etc/origin/master/registry.key \
  -o json | oc replace -f -
----

. Redeploy the registry:
+
----
$ oc deploy dc/docker-registry --latest
----

. The router is secured using a service serving certificate secret, which was
automatically created after adding an annotation to the router service. That
service serving certificate can be triggered to be recreated by deleting the
service, then clearing or re-adding annotations to the router service:

----
$ oc delete secret router-certs

$ oc annotate service router \
  service.alpha.openshift.io/serving-cert-secret-name- \
  service.alpha.openshift.io/serving-cert-signed-by-

$ oc annotate service router \
  service.alpha.openshift.io/serving-cert-secret-name=router-certs

$ oc deploy dc/router --latest
----
