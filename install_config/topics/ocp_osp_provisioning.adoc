[[inventory_provision]]
=== Preparing the Inventory for Provisioning

With the installation of the `openshift-ansible` package complete via our
previous steps, there resides a 
`sample-inventory` directory that we will copy to our `cloud-user` home directory
of the deployment host.

On the deployment host, 

----
$ cp -r /usr/share/ansible/openshift-ansible/playbooks/openstack/sample-inventory/ ~/inventory
----

Within this inventory directory, the _all.yml_ file contains all the different 
parameters that must be set in to order to achieve successful provisioning of 
the RHOCP instances. The _OSEv3.yml_ file contains some references required by
the _all.yml_ file plus all the different OpenShift cluster parameter installation
customization one would want. 

[[all.yml]]
==== all.yml

The _all.yml_ has many options that can be modified to meet your specific needs.
The information gathered in this file is for the provisioning portion of the instances
required for a successful deployment of {product-title}. It
is important to review these carefully. This document will provide a condensed 
version of the _all.yml_ and focus on the most critical parameters that need to 
be set for a successful deployment.


[subs=+quotes]
----
*$ cat ~/inventory/group_vars/all.yml*
---
openshift_openstack_clusterid: "openshift"
openshift_openstack_public_dns_domain: *"example.com"*
openshift_openstack_dns_nameservers: *["10.19.115.228"]*
openshift_openstack_public_hostname_suffix: "-public"
openshift_openstack_nsupdate_zone: "{{ openshift_openstack_public_dns_domain }}"

openshift_openstack_keypair_name: *"openshift"*
openshift_openstack_external_network_name: *"public"*

openshift_openstack_default_image_name: *"rhel75"*

openshift_openstack_num_masters: *3*
openshift_openstack_num_infra: *3*
openshift_openstack_num_cns: *0*
openshift_openstack_num_nodes: *2*

openshift_openstack_master_flavor: *"m1.master"*
openshift_openstack_default_flavor: *"m1.node"*

openshift_openstack_use_lbaas_load_balancer: *true*

openshift_openstack_docker_volume_size: "15"

# # Roll-your-own DNS
*openshift_openstack_external_nsupdate_keys:*
  public:
    *key_secret: '/alb8h0EAFWvb4i+CMA12w=='*
    *key_name: "update-key"*
    *key_algorithm: 'hmac-md5'*
    *server: '<ip-of-DNS>'*
  private:
    *key_secret: '/alb8h0EAFWvb4i+CMA12w=='*
    *key_name: "update-key"*
    *key_algorithm: 'hmac-md5'*
    *server: '<ip-of-DNS>'*

ansible_user: openshift

## cloud config
openshift_openstack_disable_root: true
openshift_openstack_user: openshift
----

NOTE: Due to using an external DNS server, the private and public sections use
the public IP address of the DNS server as the DNS server does not reside in the
OpenStack environment.

The values above that are bold require modification based upon your OpenStack
environment and DNS server. 

In order to properly modify the DNS portion of the _all.yml_, login to the DNS
server and perform the following commands to capture the key name, 
key algorithm and key secret:

----
$ ssh <ip-of-DNS>
$ sudo -i
# cat /etc/named/<key-name.key>
key "update-key" {
	algorithm hmac-md5;
	secret "/alb8h0EAFWvb4i+CMA02w==";
};

----

NOTE: The key name may vary and the above is only an example. 

Brief description of each variable in the table below:


[[all_yml]]
.Description of Variables in all.yml
|===
|Variable |Description

|openshift_openstack_clusterid |Cluster identification name

|openshift_openstack_public_dns_domain |Public DNS domain name
|openshift_openstack_dns_nameservers | IP of DNS nameservers
|openshift_openstack_public_hostname_suffix | Adds a suffix to the node hostname in the DNS record for both public and private
|openshift_openstack_nsupdate_zone | Zone to be updated with OCP instance IPs
|openshift_openstack_keypair_name | Keypair name used to log into OCP instances
|openshift_openstack_external_network_name| OpenStack public network name
|openshift_openstack_default_image_name | OpenStack image used for OCP instances
|openshift_openstack_num_masters | Number of master nodes to deploy
|openshift_openstack_num_infra | Number of infrastructure nodes to deploy
|openshift_openstack_num_cns | Number of container native storage nodes to deploy
|openshift_openstack_num_nodes | Number of application nodes to deploy
|openshift_openstack_master_flavor| Name of the OpenStack flavor used for master instances
|openshift_openstack_default_flavor| Name of the Openstack flavor used for all instances, if specific flavor not specified.
|openshift_openstack_use_lbaas_load_balancer | Boolean value enabling Octavia load balancer (Octavia must be installed)
|openshift_openstack_docker_volume_size | Minimum size of the Docker volume (required variable)
|openshift_openstack_external_nsupdate_keys | Updating the DNS with the instance IP addresses
|ansible_user| Ansible user used to deploy {product-title}. "openshift" is the required name and must not be changed.
|openshift_openstack_disable_root| Boolean value that disables root access
|openshift_openstack_user| OCP instances created with this user
|===

==== OSEv3.yml

The OSEv3.yml file specificies all the different parameters and customizations
relating the installation of OpenShift. 

Below is a condensed version of the file with all required variables for a
successful deployment. Additional variables may be required depending on what
customization is required for your specific {product-title} deployment. 


[subs=+quotes]
----
*$ cat ~/inventory/group_vars/OSEv3.yml*
---

openshift_deployment_type: openshift-enterprise
openshift_release: v3.10

openshift_master_default_subdomain: "apps.{{ (openshift_openstack_clusterid|trim == '') | ternary(openshift_openstack_public_dns_domain, openshift_openstack_clusterid + '.' + openshift_openstack_public_dns_domain) }}"

openshift_master_cluster_public_hostname: "console.{{ (openshift_openstack_clusterid|trim == '') | ternary(openshift_openstack_public_dns_domain, openshift_openstack_clusterid + '.' + openshift_openstack_public_dns_domain) }}"

*#OpenStack Credentials:*
openshift_cloudprovider_kind: openstack
openshift_cloudprovider_openstack_auth_url: "{{ lookup('env','OS_AUTH_URL') }}"
openshift_cloudprovider_openstack_username: "{{ lookup('env','OS_USERNAME') }}"
openshift_cloudprovider_openstack_password: "{{ lookup('env','OS_PASSWORD') }}"
openshift_cloudprovider_openstack_tenant_name: "{{ lookup('env','OS_PROJECT_NAME') }}"
openshift_cloudprovider_openstack_blockstorage_version: v2
openshift_cloudprovider_openstack_domain_name: "{{ lookup('env','OS_USER_DOMAIN_NAME') }}"

*## Use Cinder volume for Openshift registry:*
openshift_hosted_registry_storage_kind: openstack
openshift_hosted_registry_storage_access_modes: ['ReadWriteOnce']
openshift_hosted_registry_storage_openstack_filesystem: xfs
openshift_hosted_registry_storage_volume_size: 30Gi


openshift_hosted_registry_storage_openstack_volumeID: d65209f0-9061-4cd8-8827-ae6e2253a18d
openshift_hostname_check: false
ansible_become: true

*#Setting SDN (defaults to ovs-networkpolicy) not part of OSEv3.yml*
#For more info, on which to choose, visit: 
#https://docs.openshift.com/container-platform/3.10/architecture/networking/sdn.html#overview
networkPluginName: redhat/ovs-networkpolicy
#networkPluginName: redhat/ovs-multitenant

*#Configuring identity providers with Ansible*
#For initial cluster installations, the Deny All identity provider is configured
#by default. It is recommended to be configured with either htpasswd
#authentication, LDAP authentication, or Allowing all authentication (not recommended)
#For more info, visit:
#https://docs.openshift.com/container-platform/3.10/install_config/configuring_authentication.html#identity-providers-ansible
#Example of Allowing All
#openshift_master_identity_providers: [{'name': 'allow_all', 'login': 'true', 'challenge': 'true', 'kind': 'AllowAllPasswordIdentityProvider'}]


*#Optional Metrics (uncomment below lines for installation)*

#openshift_metrics_install_metrics: true
#openshift_metrics_cassandra_storage_type: dynamic
#openshift_metrics_storage_volume_size: 25Gi
#openshift_metrics_cassandra_nodeselector: {"node-role.kubernetes.io/infra":"true"}
#openshift_metrics_hawkular_nodeselector: {"node-role.kubernetes.io/infra":"true"}
#openshift_metrics_heapster_nodeselector: {"node-role.kubernetes.io/infra":"true"}

*#Optional Aggregated Logging (uncomment below lines for installation)*

#openshift_logging_install_logging: true
#openshift_logging_es_pvc_dynamic: true
#openshift_logging_es_pvc_size: 30Gi
#openshift_logging_es_cluster_size: 3
#openshift_logging_es_number_of_replicas: 1
#openshift_logging_es_nodeselector: {"node-role.kubernetes.io/infra":"true"}
#openshift_logging_kibana_nodeselector: {"node-role.kubernetes.io/infra":"true"}
#openshift_logging_curator_nodeselector: {"node-role.kubernetes.io/infra":"true"}

----

For further details on any of the variables listed, visit: 
https://github.com/openshift/openshift-ansible/blob/master/inventory/hosts.example


=== OpenStack Prerequisites Playbook

The {product-title} Ansible Installer provides a playbook to ensure all the provisioning
steps of the OpenStack instances have been met. 

Prior to running the playbook, ensure to source the RC file

----
$ source path/to/examplerc
----

Via the `ansible-playbook` command on the deployment host, ensure all the
prerequisites are met using `prerequisites.yml` playbook:

[subs=+quotes]
----
$  ansible-playbook /usr/share/ansible/openshift-ansible/playbooks/openstack/openshift-cluster/prerequisites.yml
----

Once the prerequisite playbook completes successfully, run the provision playbook
as follows:

----
$ ansible-playbook /usr/share/ansible/openshift-ansible/playbooks/openstack/openshift-cluster/provision.yml
----

[IMPORTANT]

====
If _provision.yml_ prematurely errors, check if the status of the 
OpenStack stack and wait for it finish

----
$ watch openstack stack list
+--------------------------------------+-------------------+--------------------+----------------------+--------------+
| ID                                   | Stack Name        | Stack Status       | Creation Time        | Updated Time |
+--------------------------------------+-------------------+--------------------+----------------------+--------------+
| 87cb6d1c-8516-40fc-892b-49ad5cb87fac | openshift-cluster | CREATE_IN_PROGRESS | 2018-08-20T23:44:46Z | None         |
+--------------------------------------+-------------------+--------------------+----------------------+--------------+

----

If the stack shows a `CREATE_IN_PROGRESS`, wait for the stack to complete with a
final result such as `CREATE_COMPLETE`. If the stack does complete successfully,
re-run the _provision.yml_ playbook for it to finish all the additional required
steps.

If the stack shows a `CREATE_FAILED`, make sure to run the following command to
see what caused the errors:

----
$ openstack stack failures list openshift-cluster
----
====
