[[configuring-extended-ldap-attributes]]
= Configuring Extended LDAP Attributes
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Overview
This topic builds upon
xref:../advanced_ldap_configuration/sssd_for_ldap_failover.adoc#setting-up-for-ldap-failover[Setting up SSSD
for LDAP Failover] and focuses on configuring extended Lightweight
Directory Access Protocol (LDAP) attributes.

[[configuring-extended-ldap-attributes-prerequisites]]
== Prerequisites

* SSSD 1.12.0 or later. This is available on Red Hat Enterprise Linux 7.0 and
later.
* mod_lookup_identity 0.9.4 or later.
** The required version is not yet available on any version of Red Hat Enterprise
Linux. However, compatible packages (RPMs) are
https://copr.fedorainfracloud.org/coprs/adelton/identity_demo/[available from
upstream] until they arrive in Red Hat Enterprise Linux.

[[configuring-extended-ldap-attributes-config-sssd]]
== Configuring SSSD
You need to ask System Security Services Daemon (SSSD) to look up attributes in
LDAP that it normally does not care about for simple system-login use-cases.
One such attribute is email, but other attributes can be used as well:

. Modify the *[domain/DOMAINNAME]* section of *_/etc/sssd/sssd.conf_* on the
remote basic authentication server and add this attribute:
+
----
[domain/example.com]
...
ldap_user_extra_attrs = mail
----

. Tell SSSD that it is acceptable for this attribute to be retrieved by
Apache. Add the following two lines to the *[ifp]* section of
*_/etc/sssd/sssd.conf_*:
+
====
----
[ifp]
user_attributes = +mail
allowed_uids = apache, root
----
====

. Restart SSSD:
+
====
----
# systemctl restart sssd.service
----
====

. Test this configuration.

[[configuring-extended-ldap-attributes-config-apache]]
== Configuring Apache

Now that SSSD is set up and successfully serving extended attributes, configure
the web server to ask for them and to insert them in the correct places.

. Enable the module to be loaded by Apache.  To do so, modify
*_/etc/httpd/conf.modules.d/55-lookup_identity.conf_* and uncomment the line:
+
====
----
LoadModule lookup_identity_module modules/mod_lookup_identity.so
----
====

. Set an SELinux boolean so that SElinux allows Apache to connect to SSSD over
D-BUS:
+
====
----
# setsebool -P httpd_dbus_sssd on
----
====

. Edit *_/etc/httpd/conf.d/openshift-remote-basic-auth.conf_* and add the
following lines to the end of the *<Location /check_user.php>* section:
+
====
----
... <1>
<Location /check_user.php>
  ... <1>
  AuthPAMService openshift

  # Store attributes in environment variables
  LookupOutput Env <2>
  LookupUserAttr mail REMOTE_USER_MAIL <2>
  LookupUserGECOS REMOTE_USER_DISPLAY_NAME <2>

  # Other options that may be useful

  # While REMOTE_USER is used as the sub field and serves as the immutable ID,
  # REMOTE_USER_PREFERRED_USERNAME could be used to have a different username
  # LookupUserAttr <attr_name> REMOTE_USER_PREFERRED_USERNAME

  # Group support may be added in a future release
  # LookupUserGroupsIter REMOTE_USER_GROUP
</Location>
----
<1> Omitted content.
<2> Added line.
====

. Replace the contents of *_/var/www/html/check_user.php_* with the following:
+
====
----
<?php
// Get the user based on the Apache var, this should always be
// set because we 'Require valid-user' in the configuration
$user = apache_getenv('REMOTE_USER');

// However, we assume it may not be set and
// build an error response by default
$data = array(
    'error' => 'remote PAM authentication failed'
);

// Build a success response if we have a user
if (!empty($user)) {
    $data = array(
        'sub' => $user
    );
<1>
    // Map of optional environment variables to optional JSON fields
    $env_map = array(
        'REMOTE_USER_MAIL' => 'email',
        'REMOTE_USER_DISPLAY_NAME' => 'name',
        'REMOTE_USER_PREFERRED_USERNAME' => 'preferred_username'
    );

    // Add all non-empty environment variables to JSON data
    foreach ($env_map as $env_name => $json_name) {
        $env_data = apache_getenv($env_name)
        if (!empty($env_data)) {
            $data[$json_name] = $env_data
        }
    }
<2>
}

// We always output JSON from this script
header('Content-Type: application/json', true);

// Write the response as JSON
echo json_encode($data);
?>
----
<1> Start new content.
<2> End new content.
====

. Restart Apache to pick up the changes:
+
====
----
# systemctl restart httpd.service
----
====

[[testing-extended-ldap-attributes-config-openshift]]
== Testing {product-title}

. Log into {product-title} as a new user with the web console.
+
You should see their full name appear in the upper-right of the
screen. You can also verify with `oc get identities -o yaml` that both email
addresses and full names are available.

[[configuring-extended-ldap-attributes-debugging]]
== Debugging Notes

{product-title} only saves these attributes to the user at the time
of the first login and does not update them again after that. So, while you are
testing (*_and only while testing_*), run `oc delete users,identities --all` to
clear the identities out so you can log in again.
