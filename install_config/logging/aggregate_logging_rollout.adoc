[[install-config-aggregate-logging-rollout]]
= Manual Elasticsearch Rollouts
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]


As of {product-title} 3.7 the Aggregated Logging stack updated the Elasticsearch
Deployment Config object so that it no longer has a Config Change Trigger, meaning
any changes to the `dc` will not result in an automatic rollout. This was to prevent
unintended restarts happening in the ES cluster, which could create excessive shard
rebalancing as cluster members restart.

This section presents two restart procedures: xref:elasticsearch-rolling-restart[rolling-restart]
and xref:elasticsearch-full-restart[full-restart]. Where a rolling restart
applies appropriate changes to the Elasticsearch cluster without down time
(provided three masters are configured) and a full restart safely applies major
changes without risk to existing data.

[[elasticsearch-rolling-restart]]
=== Performing an Elasticsearch Rolling Cluster Restart

A rolling restart is recommended, when any of the following changes are made:

* nodes on which Elasticsearch pods run require a reboot
* logging-elasticsearch configmap
* logging-es-* deployment configuration
* new image deployment, or upgrade

This will be the recommended restart policy going forward.

[NOTE]
====
Any action you do for an ES cluster will need to be repeated for the ops cluster
if `openshift_logging_use_ops` was configured to be `True`.
====

. Prevent shard balancing when purposely bringing down nodes:
+
----
$ oc exec -c elasticsearch <any_es_pod_in_the_cluster> --
          curl -s
          --cacert /etc/elasticsearch/secret/admin-ca \
          --cert /etc/elasticsearch/secret/admin-cert \
          --key /etc/elasticsearch/secret/admin-key \
          -XPUT 'https://localhost:9200/_cluster/settings' \
          -d '{ "transient": { "cluster.routing.allocation.enable" : "none" } }'
----

. Once complete, for each `dc` you have for an ES cluster, run `oc rollout latest`
to deploy the latest version of the `dc` object:
+
----
$ oc rollout latest <dc_name>
----
+
You will see a new pod deployed. Once the pod has two ready containers, you can
move on to the next `dc`.

. Once all `dc`s for the cluster have been rolled out, re-enable shard balancing:
+
----
$ oc exec -c elasticsearch <any_es_pod_in_the_cluster> --
          curl -s
          --cacert /etc/elasticsearch/secret/admin-ca \
          --cert /etc/elasticsearch/secret/admin-cert \
          --key /etc/elasticsearch/secret/admin-key \
          -XPUT 'https://localhost:9200/_cluster/settings' \
          -d '{ "transient": { "cluster.routing.allocation.enable" : "all" } }'
----

[[elasticsearch-full-restart]]
=== Performing an Elasticsearch Full Cluster Restart

A full restart is recommended when changing major versions of Elasticsearch or
other changes which might put data integrity a risk during the change process.

[NOTE]
====
Any action you do for an ES cluster will need to be repeated for the ops cluster
if `openshift_logging_use_ops` was configured to be `True`.
====

[NOTE]
====
When making changes to the `logging-es-ops` service use components
"es-ops-blocked" and "es-ops" instead in the patch
====

. Disable all external communications to the ES cluster while it is down. Edit
your non-cluster logging service (for example, `logging-es`, `logging-es-ops`)
to no longer match the ES pods running:
+
----
$  oc patch svc/logging-es -p '{"spec":{"selector":{"component":"es-blocked","provider":"openshift"}}}'
----

. Perform a shard synced flush to ensure there are no pending operations waiting
to be written to disk prior to shutting down:
+
----
$ oc exec -c elasticsearch <any_es_pod_in_the_cluster> --
          curl -s
          --cacert /etc/elasticsearch/secret/admin-ca \
          --cert /etc/elasticsearch/secret/admin-cert \
          --key /etc/elasticsearch/secret/admin-key \
          -XPOST 'https://localhost:9200/_flush/synced'
----

. Prevent shard balancing when purposely bringing down nodes:
+
----
$ oc exec -c elasticsearch <any_es_pod_in_the_cluster> --
          curl -s
          --cacert /etc/elasticsearch/secret/admin-ca \
          --cert /etc/elasticsearch/secret/admin-cert \
          --key /etc/elasticsearch/secret/admin-key \
          -XPUT 'https://localhost:9200/_cluster/settings' \
          -d '{ "transient": { "cluster.routing.allocation.enable" : "none" } }'
----

. Once complete, for each `dc` you have for an ES cluster, run `oc rollout latest`
to deploy the latest version of the `dc` object:
+
----
$ oc rollout latest <dc_name>
----
+
You will see a new pod deployed. Once the pod has two ready containers, you can
move on to the next `dc`.

. Once the restart is complete, enable all external communications to the ES
cluster. Edit your non-cluster logging service (for example, `logging-es`,
`logging-es-ops`) to match the ES pods running again:
+
----
$ oc patch svc/logging-es -p '{"spec":{"selector":{"component":"es","provider":"openshift"}}}'
----
