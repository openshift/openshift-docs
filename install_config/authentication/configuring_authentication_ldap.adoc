[[install-config-configuring-authentication-ldap]]
= Configuring the LDAP Identity Provider
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:


toc::[]

== Overview


You can configure the {product-title} master configuration file to use the LDAP (Lightweight Directory Access Protocol) identity provider for authentication within your cluster.

== Configuring LDAP Authentication


Set `LDAPPasswordIdentityProvider` in the `identityProviders` stanza to
validate user names and passwords against an LDAPv3 server, using simple bind
authentication.

For information on using LDAP, see xref:ldap-identity-provider-using[Using LDAP with {product-title}] below.

To configure the LDAP identity provider:

include::install_config/authentication/configuring_authentication_allow_all.adoc[tag=configuring_authentication_common_steps1]

. Specify the `mappingMethod` parameter to determine how identities are mapped to users.
include::install_config/authentication/configuring_authentication_allow_all.adoc[tag=configuring_authentication_common_steps2]

. Specify the following values to configure LDAP authentication:
+
[[ldap-example-config]]
.Master Configuration Using `LDAPPasswordIdentityProvider`
====
----
oauthConfig:
  ...
  identityProviders:
  - challenge: true
    login: true 
    mappingMethod: claim 
    name: "my_ldap_provider" <1>    
    provider:
      apiVersion: v1
      kind: LDAPPasswordIdentityProvider <2>
      attributes: <3>
        id: <4>
        - dn
        email: <5>
        - mail
        name: <6>
        - cn
        preferredUsername: <7>
        - uid
      bindDN: "" <8>
      bindPassword: "" <9>
      ca: my-ldap-ca-bundle.crt <10>
      insecure: false <11>
      url: "ldap://ldap.example.com/ou=users,dc=acme,dc=com?uid" <11>
----
<1> This provider name is prefixed to the returned user ID to form an identity
name.
<2> Specify *_LDAPPasswordIdentityProvider_* as the provider kind.
<3> List of attributes to use as the identity. First non-empty attribute is
used. At least one attribute is required. If none of the listed attributes has a
value, authentication fails.
<4> The unique id of the user, this is being mapped to the dn field in ldap
<5> List of attributes to use as the email address. First non-empty attribute is
used.
<6> List of attributes to use as the display name. First non-empty attribute is
used.
<7> List of attributes to use as the preferred user name when provisioning a
user for this identity. First non-empty attribute is used.
<8> Optional DN to use to bind during the search phase.
<9> Optional password to use to bind during the search phase. This value may also be
provided in an
xref:../../install_config/master_node_configuration.adoc#master-node-configuration-passwords-and-other-data[environment
variable, external file, or encrypted file].
<10> Certificate bundle to validate server certificates for the
configured URL. If empty, system trusted roots are used. Only applies if
`insecure: false`.
<11> When `true`, no TLS connection is made to the server. When `false`,
`ldaps://` URLs connect using TLS, and `ldap://` URLs are upgraded to TLS.
<11> An RFC 2255 URL which specifies the LDAP host and search parameters to use,
xref:ldap-url[as described above].
====

include::install_config/authentication/configuring_authentication_allow_all.adoc[tag=restart-after-config-master] 


[[ldap-identity-provider-using]]
== Using LDAP with {product-title} 

// tag::ldapblurb[]

During authentication, {product-title} searches the LDAP directory for an entry that matches
the provided user name. If a single unique match is found, a simple bind is
attempted using the distinguished name (DN) of the entry plus the provided
password. If the search does not return exactly one entry, access is denied.

// end::ldapblurb[]


When using LDAP, {product-title}:

. generates a search filter by combining the attribute and filter in the
configured `url` with the user-provided user name;
. searches the directory using the generated filter;
. attempts to bind to the LDAP server using the DN of the entry retrieved from
the search, and the user-provided password:
.. If the bind is successful, {product-title} builds an identity using the configured attributes
as the identity, email address, display name, and preferred user name.
.. If the bind is unsuccessful, {product-title} denies access.

[[ldap-url]]
The configured `url` is an RFC 2255 URL, which specifies the LDAP host and
search parameters to use. The syntax of the URL is:

----
ldap://host:port/basedn?attribute?scope?filter
----

For the above example:

[cols="2a,8a",options="header"]
|===
|URL Component | Description
.^|`ldap`      | For regular LDAP, use the string `ldap`. For secure LDAP
(LDAPS), use `ldaps` instead.
.^|`host:port` | The name and port of the LDAP server. Defaults to
`localhost:389` for ldap and `localhost:636` for LDAPS.
.^|`basedn`    | The DN of the branch of the directory where all searches should
start from. At the very least, this must be the top of your directory tree, but
it could also specify a subtree in the directory.
.^|`attribute` | The attribute to search for. Although RFC 2255 allows a
comma-separated list of attributes, only the first attribute will be used, no
matter how many are provided. If no attributes are provided, the default is to
use `uid`. It is recommended to choose an attribute that will be unique across
all entries in the subtree you will be using.
.^|`scope`     | The scope of the search. Can be either either `one` or `sub`.
If the scope is not provided, the default is to use a scope of `sub`.
.^|`filter`    | A valid LDAP search filter. If not provided, defaults to
`(objectClass=*)`
|===

When doing searches, the attribute, filter, and provided user name are combined
to create a search filter that looks like:

----
(&(<filter>)(<attribute>=<username>))
----

For example, consider a URL of:

----
ldap://ldap.example.com/o=Acme?cn?sub?(enabled=true)
----

When a client attempts to connect using a user name of `bob`, the resulting
search filter will be `(&(enabled=true)(cn=bob))`.

If the LDAP directory requires authentication to search, specify a `bindDN` and
`bindPassword` to use to perform the entry search.


