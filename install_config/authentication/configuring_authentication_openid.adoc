[[install-config-configuring-authentication-openid]]
= Configuring OpenID Connect Authentication
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Overview

You can configure the {product-title} master configuration file to use the OpenID Connect identity provider for authentication within your cluster.

== Configuring the OpenID Connect Identity Provider

Set `OpenIDIdentityProvider` in the `identityProviders` stanza to integrate
with an OpenID Connect identity provider using an
link:http://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth[Authorization Code Flow].

[NOTE]
====
`ID Token` and `UserInfo` decryptions are not supported. 
====

By default, the `openid` scope is requested. If required, extra scopes can be
specified in the `extraScopes` field.

Claims are read from the JWT `id_token` returned from the OpenID identity
provider and, if specified, from the JSON returned by the `UserInfo` URL.

[NOTE]
====
Using an OpenID Connect identity provider requires users to get a token using
`<master>/oauth/token/request` to use with command-line tools.
====

Configure either of the following:

* xref:open_id_connect_standard[Standard Master Configuration]
* xref:open_id_connect_full[Full Master Configuration]

[[open_id_connect_standard]]
=== Configuring Standard Master Configuration

To configure the standard OpenID Connect identity provider:

include::install_config/authentication/configuring_authentication_allow_all.adoc[tag=configuring_authentication_common_steps1]

. Specify the `mappingMethod` parameter to determine how identities are mapped to users.
include::install_config/authentication/configuring_authentication_allow_all.adoc[tag=configuring_authentication_common_steps2]

. Set the name parameter to an appropriate string. This provider name is prefixed to provider user names to form an identity name and is used to build the redirect URL.
+
----
name: my_ww_authenticate_provider
----

. Specify the following values to configure OpenID authentication:
+
.Standard Master Configuration Using `OpenIDIdentityProvider`
====
----
oauthConfig:
  ...
  identityProviders:
  - challenge: true 
    login: true
    mappingMethod: claim 
    name: my_openid_connect
    provider:
      apiVersion: v1
      kind: OpenIDIdentityProvider <1>
      clientID: ... <2>
      clientSecret: ... <3>
      claims:
        id:
        - sub <4>
        preferredUsername:
        - preferred_username
        name:
        - name
        email:
        - email
      urls:
        authorize: https://myidp.example.com/oauth2/authorize <5>
        token: https://myidp.example.com/oauth2/token <6>
----
<1> Specify `OpenIDIdentityProvider` as provider kind. 
<2> The client ID of a client registered with the OpenID provider. The client
must be allowed to redirect to `<master>/oauth2callback/<identityProviderName>`.
<3> The client secret. This value may also be provided in an
xref:../../install_config/master_node_configuration.adoc#master-node-configuration-passwords-and-other-data[environment
variable, external file, or encrypted file].
<4> Use the value of the `sub` claim in the returned `id_token` as the user's
identity.
<5> link:http://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint[Authorization Endpoint]
described in the OpenID spec. Must use `https`.
<6> link:http://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint[Token Endpoint]
described in the OpenID spec. Must use `https`.
====

include::install_config/authentication/configuring_authentication_allow_all.adoc[tag=restart-after-config-master] 

[[open_id_connect_full]]
=== Configuring Full Master Configuration

A custom certificate bundle, extra scopes, extra authorization request
parameters, and `userInfo` URL can also be specified.

To configure the full OpenID Connect identity provider:

. Edit the master configuration file:
+
----
/etc/origin/master/master-config.yaml
----

. Set the `challenge` parameter to `false`.
+
----
oauthConfig:
  ...
  identityProviders:
  - challenge: false
----

. Specify the `mappingMethod` parameter to determine how identities are mapped to users.

include::install_config/authentication/configuring_authentication_allow_all.adoc[tag=configuring_authentication_common_steps2]

. Set the name parameter to an appropriate string. This provider name is prefixed to provider user names to form an identity name and is used to build the redirect URL.
+
----
name: my_ww_authenticate_provider
----

. Specify the following values to configure OpenID authentication:

+
.Full Master Configuration Using `OpenIDIdentityProvider`
====

----
oauthConfig:
  ...
  identityProviders:
  - challenge: false
    login: true
    mappingMethod: claim
    name: my_openid_connect
    provider:
      apiVersion: v1
      kind: OpenIDIdentityProvider <1>
      clientID: ...
      clientSecret: ...
      ca: my-openid-ca-bundle.crt <2>
      extraScopes: <3>
      - email
      - profile
      extraAuthorizeParameters: <4>
        include_granted_scopes: "true"
      claims:
        id: <5>
        - custom_id_claim
        - sub
        preferredUsername: <6>
        - preferred_username
        - email
        name: <7>
        - nickname
        - given_name
        - name
        email: <8>
        - custom_email_claim
        - email
      urls:
        authorize: https://myidp.example.com/oauth2/authorize
        token: https://myidp.example.com/oauth2/token
        userInfo: https://myidp.example.com/oauth2/userinfo <9>
----
<1> Specify `OpenIDIdentityProvider` as provider kind.
<2> Certificate bundle to use to validate server certificates for the configured
URLs. If empty, system trusted roots are used.
<3> Optional list of scopes to request, in addition to the `openid` scope,
during the authorization token request.
<4> Optional map of extra parameters to add to the authorization token request.
<5> List of link:http://openid.net/specs/openid-connect-core-1_0.html#StandardClaims[claims] to use as the identity. Indicate which claims to use as the user's preferred user name,
display name, and email address. If multiple claims are specified, the first one
with a non-empty value is used. At least one claim is required. If none of the listed claims have a value,
authentication fails.
<6> List of claims to use as the preferred user name when provisioning a user
for this identity. First non-empty claim is used.
<7> List of claims to use as the display name. First non-empty claim is used.
<8> List of claims to use as the email address. First non-empty claim is used.
<9> link:http://openid.net/specs/openid-connect-core-1_0.html#UserInfo[UserInfo Endpoint] described in the OpenID spec. Must use `https`.
====

include::install_config/authentication/configuring_authentication_allow_all.adoc[tag=restart-after-config-master]

