include::_snippets/glusterfs.adoc[]
[[install-config-persistent-storage-persistent-storage-glusterfs]]
= Persistent Storage Using {gluster}
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Overview

include::install_config/persistent_storage/topics/glusterfs_intro.adoc[]

[[overview-containerized-glusterfs]]
=== {gluster-native}

include::install_config/persistent_storage/topics/glusterfs_overview_containerized.adoc[]

[[overview-external-glusterfs]]
=== {gluster-external}

include::install_config/persistent_storage/topics/glusterfs_overview_external.adoc[]

[[overview-standalone-glusterfs]]
=== Standalone {gluster}

include::install_config/persistent_storage/topics/glusterfs_overview_standalone.adoc[]

[[overview-volumes]]
=== GlusterFS Volumes

include::install_config/persistent_storage/topics/glusterfs_overview_volumes.adoc[]

[[overview-block-volumes]]
=== gluster-block Volumes

include::install_config/persistent_storage/topics/glusterfs_overview_block_volumes.adoc[]

[[overview-s3-storage]]
=== Gluster S3 Storage

include::install_config/persistent_storage/topics/glusterfs_overview_s3_storage.adoc[]

[[considerations]]
== Considerations

This section covers a few topics that should be taken into consideration when
using {gluster} with {product-title}.

[[considerations-software-prereqs]]
=== Software Prerequisites

include::install_config/persistent_storage/topics/glusterfs_prereqs_software.adoc[]

[[considerations-hardware-prereqs]]
=== Hardware Requirements

include::install_config/persistent_storage/topics/glusterfs_prereqs_hardware.adoc[]

[[considerations-storage-sizing]]
=== Storage Sizing

include::install_config/persistent_storage/topics/glusterfs_storage_sizing.adoc[]

[[considerations-volume-ops]]
=== Volume Operation Behaviors

include::install_config/persistent_storage/topics/glusterfs_volume_ops.adoc[]

[[considerations-volume-security]]
=== Volume Security

This section covers {gluster} volume security, including Portable Operating
System Interface [for Unix] (POSIX) permissions and SELinux considerations.
Understanding the basics of xref:pod_security_context.adoc#install-config-persistent-storage-pod-security-context[Volume Security],
POSIX permissions, and SELinux is presumed.

[[considerations-volume-security-posix]]
==== POSIX Permissions

include::install_config/persistent_storage/topics/glusterfs_security_posix.adoc[]

[[considerations-volume-security-selinux]]
==== SELinux

include::install_config/persistent_storage/topics/glusterfs_security_selinux.adoc[]

ifdef::openshift-enterprise[]
[[support-requirements]]
== Support Requirements

include::install_config/persistent_storage/topics/glusterfs_support_requirements.adoc[]

endif::[]

[[install]]
== Installation

For standalone {gluster}, there is no component installation required to use it
with {product-title}. {product-title} comes with a built-in GlusterFS volume
driver, allowing it to make use of existing volumes on existing clusters. See
xref:provisioning[provisioning] for more on how to make use of existing volumes.

For {gluster-native} and {gluster-external}, it is recommended to use the
xref:../../install/index.adoc#install-planning[cluster installation] process to
install the required components.

[[install-gluster-nodes]]
=== {gluster-external}: Installing {gluster} Nodes

include::install_config/persistent_storage/topics/glusterfs_install_nodes.adoc[]

[[install-advanced-installer]]
=== Using the Installer

The xref:../../install/index.adoc#install-planning[cluster installation] process
can be used to install one or both of two GlusterFS node groups:

- `glusterfs`: A general storage cluster for use by user applications.
- `glusterfs_registry`: A dedicated storage cluster for use by infrastructure
applications such as an integrated OpenShift Container Registry.

It is recommended to deploy both groups to avoid potential impacts on
performance in I/O and volume creation. Both of these are defined in the
inventory hosts file.

To define the storage clusters, include the relevant names in the
`[OSEv3:children]` group, creating similarly named groups. Then populate
the groups with the node information.

In the `[OSEv3:children]` group, you add the `masters`, `nodes`, `etcd`, and the
`glusterfs` and `glusterfs_registry` storage clusters.

After the groups are created and populated, you then configure the clusters
by defining more parameter values in the `[OSEv3:vars]` group. The variables interact
with the GlusterFS clusters. and are stored in the inventory file, as shown in the
following example.

- `glusterfs` variables begin with `openshift_storage_glusterfs_`.
- `glusterfs_registry` variables begin with `openshift_storage_glusterfs_registry_`.

The following example of an inventory file illustrates the use of variables
when deploying the two GlusterFS node groups:

----
`[OSEv3:children]
masters
nodes
etcd
glusterfs
glusterfs_registry`

[OSEv3:vars]
install_method=rpm
os_update=false
install_update_docker=true
docker_storage_driver=devicemapper
ansible_ssh_user=root
openshift_release=v3.11
oreg_url=registry.access.redhat.com/openshift3/ose-${component}:v3.11
#openshift_cockpit_deployer_prefix=registry.access.redhat.com/openshift3/
openshift_docker_insecure_registries=registry.access.redhat.com
openshift_deployment_type=openshift-enterprise
openshift_web_console_install=true
openshift_enable_service_catalog=false
osm_use_cockpit=false
osm_cockpit_plugins=['cockpit-kubernetes']
debug_level=5
openshift_set_hostname=true
openshift_override_hostname_check=true
openshift_disable_check=docker_image_availability
openshift_check_min_host_disk_gb=2
openshift_check_min_host_memory_gb=1
openshift_portal_net=172.31.0.0/16
openshift_master_cluster_method=native
openshift_clock_enabled=true
openshift_use_openshift_sdn=true

openshift_master_dynamic_provisioning_enabled=true


# logging
openshift_logging_install_logging=true
openshift_logging_es_pvc_dynamic=true
openshift_logging_kibana_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_logging_curator_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_logging_es_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_logging_es_pvc_size=20Gi
openshift_logging_es_pvc_storage_class_name="glusterfs-registry-block"


# metrics
openshift_metrics_install_metrics=true
openshift_metrics_storage_kind=dynamic
openshift_metrics_hawkular_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_metrics_cassandra_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_metrics_heapster_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_metrics_storage_volume_size=20Gi
openshift_metrics_cassandra_pvc_storage_class_name="glusterfs-registry-block"


# glusterfs
openshift_storage_glusterfs_timeout=900
openshift_storage_glusterfs_namespace=glusterfs
openshift_storage_glusterfs_storageclass=true
openshift_storage_glusterfs_storageclass_default=false
openshift_storage_glusterfs_block_storageclass=true
openshift_storage_glusterfs_block_storageclass_default=false
openshift_storage_glusterfs_block_deploy=true
openshift_storage_glusterfs_block_host_vol_create=true
openshift_storage_glusterfs_block_host_vol_size=100


# glusterfs_registry
openshift_storage_glusterfs_registry_namespace=glusterfs-registry
openshift_storage_glusterfs_registry_storageclass=true
openshift_storage_glusterfs_registry_storageclass_default=false
openshift_storage_glusterfs_registry_block_storageclass=true
openshift_storage_glusterfs_registry_block_storageclass_default=false
openshift_storage_glusterfs_registry_block_deploy=true
openshift_storage_glusterfs_registry_block_host_vol_create=true
openshift_storage_glusterfs_registry_block_host_vol_size=100

# glusterfs_registry_storage
openshift_hosted_registry_storage_kind=glusterfs
openshift_hosted_registry_storage_volume_size=20Gi
openshift_hosted_registry_selector="node-role.kubernetes.io/infra=true"


openshift_storage_glusterfs_heketi_admin_key='adminkey'
openshift_storage_glusterfs_heketi_user_key='heketiuserkey'


openshift_storage_glusterfs_image='registry.access.redhat.com/rhgs3/rhgs-server-rhel7:v3.11'

openshift_storage_glusterfs_heketi_image='registry.access.redhat.com/rhgs3/rhgs-volmanager-rhel7:v3.11'

openshift_storage_glusterfs_block_image='registry.access.redhat.com/rhgs3/rhgs-gluster-block-prov-rhel7:v3.11'


openshift_master_cluster_hostname=node101.redhat.com
openshift_master_cluster_public_hostname=node101.redhat.com

[masters]
node101.redhat.com

[etcd]
node101.redhat.com

[nodes]
node101.redhat.com openshift_node_group_name="node-config-master"
node102.redhat.com openshift_node_group_name="node-config-infra"
node103.redhat.com openshift_node_group_name="node-config-compute"
node104.redhat.com openshift_node_group_name="node-config-compute"
node105.redhat.com openshift_node_group_name="node-config-compute"
node106.redhat.com openshift_node_group_name="node-config-compute"
node107.redhat.com openshift_node_group_name="node-config-compute"
node108.redhat.com openshift_node_group_name="node-config-compute"

[glusterfs]
node103.redhat.com glusterfs_zone=1 glusterfs_devices='["/dev/sdd"]'
node104.redhat.com glusterfs_zone=2 glusterfs_devices='["/dev/sdd"]'
node105.redhat.com glusterfs_zone=3 glusterfs_devices='["/dev/sdd"]'

[glusterfs_registry]
node106.redhat.com glusterfs_zone=1 glusterfs_devices='["/dev/sdd"]'
node107.redhat.com glusterfs_zone=2 glusterfs_devices='["/dev/sdd"]'
node108.redhat.com glusterfs_zone=3 glusterfs_devices='["/dev/sdd"]'

----

[[install-advanced-installer-host-variables]]
==== Host variables

Each host in the `glusterfs` and `glusterfs_registry` groups must have the
`glusterfs_devices` variable defined. This variable defines the list of block
devices that will be managed as part of the GlusterFS cluster. You must have at
least one device, which must be bare, with no partitions or LVM PVs.

You can also define the following variables for each host. If they are defined,
these variables further control the host configuration as a GlusterFS node:

- `glusterfs_cluster`: The ID of the cluster this node belongs to.
- `glusterfs_hostname`: A host name or IP address to be used for internal
  GlusterFS communication.
- `glusterfs_ip`: The IP address that the pods use to communicate with
the GlusterFS node.
- `glusterfs_zone`: A zone number for the node. Within the cluster, zones
determine how to distribute the bricks of GlusterFS volumes.

[[install-advanced-installer-role-variables]]
==== Role variables

To control the integration of a GlusterFS cluster into a new or existing
{product-title} cluster, you can also define a number of role variables,
which are stored in the inventory file. Each role variable also has a
corresponding variable to optionally configure a separate GlusterFS cluster
for use as storage for an integrated Docker registry.

[[install-advanced-installer-image-name]]
==== Image name and version tag variables

To prevent {product-title} pods from upgrading after an outage leading to a cluster
with different {product-title} versions, it is recommended that you specify the
image name and version tags for all containerized components. These variables are:

- `openshift_storage_glusterfs_image`
- `openshift_storage_glusterfs_block_image`
- `openshift_storage_glusterfs_s3_image`
- `openshift_storage_glusterfs_heketi_image`

[NOTE]
====
The image variables for *_gluster-block_* and *_gluster-s3_* are only necessary
if the corresponding deployment variables (the variables ending in
`_block_deploy` and `_s3_deploy`) are true.
====

// List the specific images in the registry for OSE only
ifdef::openshift-enterprise[]
include::install_config/persistent_storage/topics/glusterfs_images.adoc[]
endif::[]

For a complete list of variables, see the
link:{gluster-role-link}[GlusterFS role README] on GitHub.

Once the variables are configured, there are several playbooks available
depending on the circumstances of the installation:

- The main playbook for cluster installations can be used to deploy the
GlusterFS clusters in tandem with an initial installation of {product-title}.
  ** This includes deploying an integrated OpenShift Container Registry that
  uses GlusterFS storage.
  ** This does not include OpenShift Logging or OpenShift Metrics, as that is
  currently still a separate step. See xref:install-example-infra[{gluster-native} for OpenShift Logging and Metrics]
  for more information.
- `playbooks/openshift-glusterfs/config.yml` can be used to deploy the clusters
onto an existing {product-title} installation.
- `playbooks/openshift-glusterfs/registry.yml` can be used to deploy the
clusters onto an existing {product-title} installation. In addition, this will
deploy an integrated OpenShift Container Registry which uses GlusterFS storage.
+
[IMPORTANT]
====
There must not be a pre-existing registry in the {product-title} cluster.
====
- `playbooks/openshift-glusterfs/uninstall.yml` can be used to remove existing
clusters matching the configuration in the inventory hosts file. This is useful
for cleaning up the {product-title} environment in the case of a failed
deployment due to configuration errors.
+
[NOTE]
====
The GlusterFS playbooks are not guaranteed to be idempotent.
====
+
[NOTE]
====
Running the playbooks more than once for a given installation is currently not supported without deleting the entire GlusterFS installation (including disk data) and starting over.
====

[[install-example-basic]]
==== Example: Basic {gluster-native} Installation

include::install_config/persistent_storage/topics/glusterfs_example_basic.adoc[]
+
include::install_config/persistent_storage/persistent_storage_glusterfs.adoc[tag=commonexampleglusterfsnote]
+
include::install_config/persistent_storage/topics/glusterfs_run_installer.adoc[]

[[install-example-basic-external]]
==== Example: Basic {gluster-external} Installation

include::install_config/persistent_storage/topics/glusterfs_example_basic_external.adoc[]
+
include::install_config/persistent_storage/persistent_storage_glusterfs.adoc[tag=commonexampleglusterfsnote]
+
include::install_config/persistent_storage/topics/glusterfs_run_installer.adoc[]

[[install-example-registry]]
==== Example: {gluster-native} with an Integrated OpenShift Container Registry

include::install_config/persistent_storage/topics/glusterfs_example_registry.adoc[]
+
include::install_config/persistent_storage/persistent_storage_glusterfs.adoc[tag=commonexampleglusterfsnote]
+
include::install_config/persistent_storage/topics/glusterfs_run_installer.adoc[]

[[install-example-infra]]
==== Example: {gluster-native} for OpenShift Logging and Metrics

include::install_config/persistent_storage/topics/glusterfs_example_infra.adoc[]
+
include::install_config/persistent_storage/persistent_storage_glusterfs.adoc[tag=commonexampleglusterfsnote]
+
include::install_config/persistent_storage/topics/glusterfs_run_installer.adoc[]

[[install-example-full]]
==== Example: {gluster-native} for Applications, Registry, Logging, and Metrics

include::install_config/persistent_storage/topics/glusterfs_example_full.adoc[]
+
include::install_config/persistent_storage/persistent_storage_glusterfs.adoc[tag=commonexampleglusterfsnote]
+
include::install_config/persistent_storage/topics/glusterfs_run_installer.adoc[]

[[install-example-full-external]]
==== Example: {gluster-external} for Applications, Registry, Logging, and Metrics

include::install_config/persistent_storage/topics/glusterfs_example_full_external.adoc[]
+
include::install_config/persistent_storage/persistent_storage_glusterfs.adoc[tag=commonexampleglusterfsnote]
+
include::install_config/persistent_storage/topics/glusterfs_run_installer.adoc[]

[[uninstall]]
== Uninstall {gluster-native}

include::install_config/persistent_storage/topics/glusterfs_uninstall.adoc[]

[[provisioning]]
== Provisioning

GlusterFS volumes can be provisioned either statically or dynamically. Static
provisioning is available with all configurations. Only {gluster-native} and
{gluster-external} support dynamic provisioning.

[[provisioning-static]]
=== Static Provisioning

include::install_config/persistent_storage/topics/glusterfs_static_provisioning.adoc[]

[[provisioning-dynamic]]
=== Dynamic Provisioning

include::install_config/persistent_storage/topics/glusterfs_dynamic_provisioning.adoc[]

ifdef::openshift-nextgen[]
// tag::commonexampleglusterfsnote[]
[NOTE]
====
The preceding steps only provide some of the options that must be added to the
inventory file. Use the complete inventory file to deploy {gluster}.
====
// end::commonexampleglusterfsnote[]
endif::[]
