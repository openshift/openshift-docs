[[persistent_storage_manila]]
= Persistent Storage Using OpenStack Manila
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Overview

[IMPORTANT]
====
Persistent volume (PV) provisioning using OpenStack Manila is a Technology Preview
feature only.
ifdef::openshift-enterprise[]
Technology Preview features are not supported with Red Hat production service
level agreements (SLAs), might not be functionally complete, and Red Hat does
not recommend to use them for production. These features provide early access to
upcoming product features, enabling customers to test functionality and provide
feedback during the development process.

For more information on Red Hat Technology Preview features support scope, see
https://access.redhat.com/support/offerings/techpreview/.
endif::[]
====

{product-title} is capable of provisioning PVs using the
link:https://wiki.openstack.org/wiki/Manila[OpenStack Manila] shared file system service.

It is assumed the OpenStack Manila service has been correctly set up and is
accessible from the {product-title} cluster. Only the NFS share types can be
provisioned.

Familiarity with
link:https://kubernetes.io/docs/concepts/storage/persistent-volumes/[PVs],
link:https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims[persistent
volume claims (PVCs)],
link:http://blog.kubernetes.io/2016/10/dynamic-provisioning-and-storage-in-kubernetes.html[dynamic
provisioning], and
link:https://kubernetes.io/docs/admin/authorization/rbac/[RBAC authorization] is recommended.

[[manilla-installation-setup]]
== Installation and Setup

The feature is provided by an external provisioner. You must install and
configure it in the {product-title} cluster.

=== Starting the External Provisioner

The external provisioner service is distributed as a container image and can be run in the
{product-title} cluster as usual.

To allow the containers managing the API objects, configure the required role-based access
control (RBAC) rules as a cluster administrator:

. Create a `ServiceAccount`:
+
[source,yaml]
----
apiVersion: v1
kind: ServiceAccount
metadata:
  name: manila-provisioner-runner
----

. Create a `ClusterRole`:
+
[source,yaml]
----
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: manila-provisioner-role
rules:
  - apiGroups: [""]
    resources: ["persistentvolumes", "endpoints"]
    verbs: ["get", "list", "watch", "create", "delete", "update"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["list", "watch", "create", "update", "patch"]
  - apiGroups: ["v1"]
    resources: ["secrets"]
    verbs: ["get", "list"]
----

. Bind the rules via `ClusterRoleBinding`:
+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: manila-provisioner
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: manila-provisioner-role
subjects:
- kind: ServiceAccount
  name: manila-provisioner-runner
  namespace: default
----

. Create a new `Secret`:

[source,yaml]
+
----
apiVersion: v1
kind: Secret
metadata:
  name: manila-secret <1>
  namespace: default <2>
data:
  os-authURL: <base64 encoded OpenStack Keystone URL>
  os-userName: <base64 encoded Manila username>
  os-password: <base64 encoded password>
  os-projectName: <base64 encoded OpenStack project (tenant) name>
  os-domainName: <base64 encoded OpensStack Manila service domain>
  os-region: <base64 encoded OpenStack region>
----
<1> The `Secret` name will be referenced by the Manila volumes `StorageClass`
(see below).
<2> Dtto.

. Create a new `StorageClass`:
+
[source,yaml]
----
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: "manila-share"
provisioner: "externalstorage.k8s.io/manila"
parameters:
  type: "default" <1>
  zones: "nova" <2>
  protocol: "NFS" <3>
  backend: "nfs" <4>
  osSecretName: "manila-secret" <5>
  osSecretNamespace: "defaulr" <6>
  nfs-share-client: "0.0.0.0" <7>
----
<1> The link:https://docs.openstack.org/manila/latest/admin/shared-file-systems-share-types.html[Manila share type]
the provisioner will create for the volume. This field is optional, default
value is `default`.
<2> Set of Manila availability zones that the volume might be created in. This
field is optional, default value is `nova`.
<3> Protocol used when provisioning a share, valid options are `NFS` and `CEPHFS`.
This field is required.
<4> Share backend used for granting access and creating
`PersistentVolumeSource`, valid options are `nfs`, `cephfs`. This filed is
required.
<5> Name of the Secret object containing OpenStack credentials. This field is
required.
<6> Namespace of the OpenStack credentials Secret object. This field is
optional, default value is `default`.
<7> Default NFS client for the share exported. This filed is optional and valid
only for the NFS protocol. Default value is `0.0.0.0`.

The last step is to start the provisioner itself, for example, using a deployment:

[source, yaml]
----
kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: manila-provisioner
spec:
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: manila-provisioner
    spec:
      serviceAccountName: manila-provisioner-runner
      containers:
        - image: "registry.redhat.io/openshift/manila-provisioner:latest"
          imagePullPolicy: "IfNotPresent"
          name: manila-provisioner
----

[[usage]]
== Usage

After the provisioner is running, you can provision PVs using a PVC and the corresponding StorageClass:
[source,yaml]
----
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: manila-nfs-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2G
  storageClassName: manila-share
----

The `PersistentVolumeClaim` is then bound to a `PersistentVolume` backed by
the newly provisioned Manila share. When the `PersistentVolumeClaim` and
subsequently the `PersistentVolume` are deleted, the provisioner deletes and unexports
the Manila share.
