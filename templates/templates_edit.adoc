[[dev-guide-templates-editing]]
= Modifying Templates
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]
{nbsp} +

This section describes some of the modifications you can make to a template. 
Because templates contain lists of objects, you can make all object changes
through a template and you can with an object specification.   


[[dev-guide-templates-using-cli]]
== Working with Templates
//tag::creating-templates-cli[]

You can use the CLI to process templates and use the configuration that is
generated to create objects.

[[dev-guide-templates-using-cli-view]]
=== Viewing a List of Objects in a Template

----
$ oc process -f <filename>
----

If the template has already been uploaded to the current project:

----
$ oc process <template_name>
----

You can override any
xref:../../dev_guide/templates/template_components.adoc#dev-guide-templates-components-parameters[parameter] values defined
in the file by adding the `-p` option for each `<name>=<value>` pair you want
to override. A parameter reference may appear in any text field inside the
template items.

For example, the following command overrides the *`POSTGRESQL_USER`* and *`POSTGRESQL_DATABASE`*
parameters of a template with
customized environment variables:

----
$ oc process -f my-rails-postgresql \
    -p POSTGRESQL_USER=bob \
    -p POSTGRESQL_DATABASE=mydatabase
----

The JSON file can either be redirected to a file or applied directly without
uploading the template by piping the processed output to the `oc create`
command:

----
$ oc process -f my-rails-postgresql \
    -p POSTGRESQL_USER=bob \
    -p POSTGRESQL_DATABASE=mydatabase \
    | oc create -f -
----

If you have large number of parameters, you can store them in a file and then
pass this file to `oc process`:

----
$ cat postgres.env
POSTGRESQL_USER=bob
POSTGRESQL_DATABASE=mydatabase
$ oc process -f my-rails-postgresql --param-file=postgres.env
----

You can also read the environment from standard input by using `"-"` as the
argument to `--param-file`:

----
$ sed s/bob/alice/ postgres.env | oc process -f my-rails-postgresql --param-file=-
----
//end::creating-templates-cli[]

[[dev-guide-templates-using-cli-labels]]
=== Changing the Labels 

xref:../../architecture/core_concepts/pods_and_services.adoc#labels[Labels] are
used to manage and organize generated objects, such as pods. The labels
specified in the template are applied to every object that is generated from
the template.

Use the following command to add or modify labels in the template from the command line.

----
$ oc process -f <project> <filename>.json -l name=otherLabel
----

[[dev-guide-templates-using-cli-parameters]]
=== Editing the Parameters

The parameters that you can override are listed in the
xref:../../dev_guide/templates/template_components.adoc#dev-guide-templates-components-parameters[`parameters` section of the template]. You can list them
with the CLI by using the following command and specifying the file to be used:

----
$ oc process --parameters -f <filename>
----

If the template is already uploaded:

----
$ oc process --parameters -n <project> <template_name>
----

For example, the following shows the output when listing the parameters for one
of the Quickstart templates in the default *openshift* project:

----
$ oc process --parameters -n openshift rails-postgresql-example

NAME                         DESCRIPTION                                                                                                 GENERATOR           VALUE
NAME                         The name assigned to all of the frontend objects defined in this template.                                                      rails-postgresql-example
NAMESPACE                    The OpenShift Namespace where the ImageStream resides.                                                                          openshift
MEMORY_LIMIT                 Maximum amount of memory the Rails container can use.                                                                           512Mi
MEMORY_POSTGRESQL_LIMIT      Maximum amount of memory the PostgreSQL container can use.                                                                      512Mi
SOURCE_REPOSITORY_URL        The URL of the repository with your application source code.                                                                    https://github.com/openshift/rails-ex.git
SOURCE_REPOSITORY_REF        Set this to a branch name, tag or other ref of your repository if you are not using the default branch.                         
CONTEXT_DIR                  Set this to the relative path to your project if it is not in the root of your repository.                                      
APPLICATION_DOMAIN           The exposed hostname that will route to the Rails service, if left blank a value will be defaulted.                             
GITHUB_WEBHOOK_SECRET        Github trigger secret.  A difficult to guess string encoded as part of the webhook URL.  Not encrypted.     expression          [a-zA-Z0-9]{40}
SECRET_KEY_BASE              Your secret key for verifying the integrity of signed cookies.                                              expression          [a-z0-9]{127}
APPLICATION_USER             The application user that is used within the sample application to authorize access on pages.                                   openshift
APPLICATION_PASSWORD         The application password that is used within the sample application to authorize access on pages.                               secret
RAILS_ENV                    Environment under which the sample application will run. Could be set to production, development or test.                       production
DATABASE_SERVICE_NAME                                                                                                                                        postgresql
DATABASE_USER                                                                                                                            expression          user[A-Z0-9]{3}
DATABASE_PASSWORD                                                                                                                        expression          [a-zA-Z0-9]{8}
DATABASE_NAME                                                                                                                                                root
POSTGRESQL_MAX_CONNECTIONS                                                                                                                                   100
POSTGRESQL_SHARED_BUFFERS                                                                                                                                    12MB
RUBYGEM_MIRROR               The custom RubyGems mirror URL                                                                                                  

----

For example, the following command creates a JSON file based on the *rails-postgresql-example* template. The new configuration
has a new name and memory limit:

----
$ oc process -f openshift rails-postgresql-example -l name=rails-postgresql-example-small -p MEMORY_LIMIT=256Mi -p MEMORY_POSTGRESQL_LIMIT=256Mi
----

See _Example Template Files_ for xref:../../dev_guide/templates/template_examples.adoc#dev-guide-templates-example[the output of this command].


[[dev-guide-templates-edit-project-resources]]
== Limiting the Resource Quotas 

You can use templates to limit the resources that can be consumed by a project.

[[dev-guide-templates-edit-project-containers]]
=== Limiting the Resource Quotas 

//tag::template-limit-replicas[]
You can set a number of quotas in a project by adding a `ResourceQuota` object to the template.

include::admin_guide/quota.adoc[tag=admin_quota_compute_resources]

For more information on requsource quotas, see xref:../../admin_guide/quota.adoc#admin-guide-quota[Setting Quotas].
//end::template-limit-replicas[]

[[dev-guide-templates-edit-project-size]]
=== Limiting the Size of Containers

//tag::template-limit-size[]
You can control the size of the containers in a project by adding a `LimitRange` object to the template. 

include::admin_guide/limits.adoc[tag=admin_limits_sample_definitions]

For more information on limit ranges, see xref:../../admin_guide/limits.adoc#admin-guide-limits[Setting Limit Ranges].
//end::template-limit-size[]

[[admin-guide-templates-edit-project-containers]]
=== Limiting the Number of Replicas or Containers 

You can limit the number of containers that can be created with a specific template by adding a *ResourceQuota* object to the template.

include::admin_guide/quota.adoc[tag=admin_quota_compute_resources]

Create the template to include the new object:

----
# oc create -f template.yaml 

resourcequota "compute-resources" created
----

For more information on *requsource* quotas, see xref:../../admin_guide/quota.adoc#admin-guide-quota[Setting Quotas].

[[dev-guide-templates-edit-project-size]]
=== Limiting the Size of Containers

You can control the size of the containers created with a specific template by adding a *LimitRange* object to the template.

include::admin_guide/limits.adoc[tag=admin_limits_sample_definitions]

Create the template to include the new object:

----
# oc create -f template.yaml 

limitrange "core-resource-limits" created
----

For more information on limit ranges, see xref:../../admin_guide/limits.adoc#admin-guide-limits[Setting Limit Ranges].

[[dev-guide-templates-edit-project-volume]]
=== Limiting Persistent Volume Usage

include::dev_guide/templates/templates_edit.adoc[tag=template-limit-volume]

Create the template to include the new object:

----
# oc create -f template.yaml 
----

[[dev-guide-templates-edit-project-volume]]
=== Limiting Persistent Volume Usage

//tag::template-limit-volume[]
You can limit the persistent volume usage for objects based on a template using disk partitions to enforce disk quotas and size constraints. 
Each partition can be its own export. Each export is one PV. {product-title} enforces unique names for PVs, 
but the uniqueness of the NFS volumeâ€™s server and path is up to the administrator.

Enforcing quotas in this way allows the developer to request persistent storage by a specific amount (for example, 10Gi) 
and be matched with a corresponding volume of equal or greater capacity.
//end::template-limit-volume[]

[[dev-guide-templates-edit-project-pods]]
=== Limiting the Number of Pods per Node

You can configure the maximum number of pods that can be launched on a node through the node specification, which is _*/etc/origin/node/node-config*_ by default
on each node.

Add the following under kubeletArguments: 

----
kubeletArguments
  max-pods: 
    - "30"
----

[[dev-guide-templates-components-assign-permissions]]
== Assigning Permissions
//https://access.redhat.com/support/cases/#/case/01503177
The project templates will be defined by the platform administrators. 

By default a project admin does not have Authorization create or edit resource limits. Only `cluster-admin` have access to create and edit these. 

* To allow users to create a project then when they do they become admin of that project: 
+
----
# oc new-project <project-name>
# oc get rolebinding
----

[[dev-guide-templates-components-object-fields]]
== Exposing Object Fields

Template authors can indicate that fields of particular objects in a template
be exposed. The template service broker recognizes exposed fields on
configuration map, secret, service and route objects, and returns the values of the
exposed fields when a user binds a service backed by the broker.

To expose one or more fields of an object, add annotations prefixed by
`template.openshift.io/expose-` or `template.openshift.io/base64-expose-` to  
the object in the template.

----
- kind: Service
  apiVersion: v1
  metadata:
    annotations:
      template.openshift.io/expose-service_ip_port: "{.spec.clusterIP}:{.spec.ports[?(.name==\"web\")].port}"
----

Each annotation key, with its prefix removed, is passed through to become a key
in a `bind` response.

Each annotation value is a
link:https://kubernetes.io/docs/user-guide/jsonpath/[Kubernetes
JSONPath expression], which is resolved at bind time to indicate the object
field whose value should be returned in the `bind` response.

[NOTE]
====
*Bind* response key/value pairs can be used in other parts of the system as
environment variables. Therefore, it is recommended that every annotation key
with its prefix removed should be a valid environment variable name --
beginning with a character `A-Z`, `a-z`, or `_`, and being followed by zero or
more characters `A-Z`, `a-z`, `0-9`, or `_`.
====

Use the `template.openshift.io/expose-` annotation to return the field value as
a string. This is convenient, although it does not handle arbitrary binary data.
If you want to return binary data, use the
`template.openshift.io/base64-expose-` annotation instead to base64 encode the
data before it is returned.

[NOTE]
====
Unless escaped with a backslash, Kubernetes' JSONPath implementation interprets
characters such as `.`, `@`, and others as metacharacters, regardless of their
position in the expression. Therefore, for example, to refer to a `ConfigMap`
datum named `my.key`, the required JSONPath expression would be
`{.data['my\.key']}`.
====

The following is an example of different objects' fields being exposed:

[source,yaml]
----
kind: Template
apiVersion: v1
metadata:
  name: my-template
objects:
- kind: ConfigMap
  apiVersion: v1
  metadata:
    annotations:
      template.openshift.io/expose-username: "{.data['my.username']}"
  data:
    my.username: foo
- kind: Secret
  apiVersion: v1
  metadata:
    annotations:
      template.openshift.io/base64-expose-password: "{.data['password']}"
  stringData:
    password: bar
- kind: Service
  apiVersion: v1
  metadata:
    annotations:
      template.openshift.io/expose-service_ip_port: "{.spec.clusterIP}:{.spec.ports[?(.name==\"web\")].port}"
  spec:
    ports:
    - name: "web"
      port: 8080
- kind: Route
  apiVersion: v1
  metadata:
    annotations:
      template.openshift.io/expose-uri: "http://{.spec.host}{.spec.path}"
  spec:
    path: mypath
----

An example response to a *bind* operation given the above partial template
follows:

[source,json]
----
{
  "credentials": {
    "username": "foo",
    "password": "YmFy",
    "service_ip_port": "172.30.12.34:8080",
    "uri": "http://route-test.router.default.svc.cluster.local/mypath"
  }
}
----

[[dev-guide-templates-components-readiness]]
== Waiting for Template Readiness

Template authors can indicate that certain objects within a template
should be waited for before a template instantiation by the Service Catalog,
Template Service Broker, or Template Instance API is considered complete.

[NOTE]
====
Template Completion Detection is a Technology Preview feature only.
ifdef::openshift-enterprise[]
Technology Preview features are not
supported with Red Hat production service level agreements (SLAs), might not be
functionally complete, and Red Hat does not recommend to use them for
production. These features provide early access to upcoming product features,
enabling customers to test functionality and provide feedback during the
development process.

For more information on Red Hat Technology Preview features support scope, see
https://access.redhat.com/support/offerings/techpreview/.
endif::[]
====

To use this feature, mark one or more objects of kind
`Build`, `BuildConfig`, `Deployment`, `DeploymentConfig`, `Job`, or `StatefulSet`
in a template with the following annotation:

----
"template.alpha.openshift.io/wait-for-ready": "true"
----

Template instantiation will not complete until all objects marked with the
annotation report ready. Similarly, if any of the annotated objects report
failed, or if the template fails to become ready within a fixed timeout of one
hour, the template instantiation will fail.

For the purposes of instantiation, readiness and failure of each object kind are
defined as follows:

[cols="1a,2a,2a", options="header"]
|===

| Kind
| Readiness
| Failure

| `Build`
| Object reports phase Complete
| Object reports phase Canceled, Error, or Failed

| `BuildConfig`
| Latest associated Build object reports phase Complete
| Latest associated Build object reports phase Canceled, Error, or Failed

| `Deployment`
| Object reports new ReplicaSet and deployment available (this honors readiness
probes defined on the object)
| Object reports Progressing condition as false

|`DeploymentConfig`
| Object reports new ReplicationController and deployment available (this
honors readiness probes defined on the object)
| Object reports Progressing condition as false

| `Job`
| Object reports completion
| Object reports that one or more failures have occurred

| `StatefulSet`
| Object reports all replicas ready (this honors readiness probes defined on
the object)
| Not applicable
|===

The following is an example template extract, which uses the `wait-for-ready`
annotation. Further examples can be found in the {product-title} quickstart templates.

[source,yaml]
----
kind: Template
apiVersion: v1
metadata:
  name: my-template
objects:
- kind: BuildConfig
  apiVersion: v1
  metadata:
    name: ...
    annotations:
      # wait-for-ready used on BuildConfig ensures that template instantiation
      # will fail immediately if build fails
      template.alpha.openshift.io/wait-for-ready: "true"
           spec:
    ...
- kind: DeploymentConfig
  apiVersion: v1
  metadata:
    name: ...
    annotations:
      template.alpha.openshift.io/wait-for-ready: "true"
  spec:
    ...
- kind: Service
  apiVersion: v1
  metadata:
    name: ...
  spec:
    ...
----

