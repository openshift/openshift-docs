[id="dedicated-aws-peering"]
= AWS VPC Peering Configuration
include::modules/common-attributes.adoc[]
:context: dedicated-aws-peering
toc::[]

This is the sample process for configuring an AWS VPC containing an OpenShift
Dedicated cluster to peer with another AWS VPC network.  For more information
about creating an AWS VPC Peering connection or for other possible
configurations, see the
link:http://docs.aws.amazon.com/AmazonVPC/latest/PeeringGuide/Welcome.html[AWS Peering Guide].

[id="dedicated-vpc-peering"]
== VPC Peering
This section details the steps required to set up a VPC peering connection between two VPCs on two separate AWS accounts. To keep things clear, these are the terms that will be used for the rest of this explanation:

* *{product-title} AWS Account* - The AWS account that contains the OpenShift Dedicated cluster.
* *{product-title} Cluster VPC* - The VPC that contains the OpenShift Dedicated.
* *Customer AWS Account* - Your non-{product-title} AWS account that you would like to peer with.
* *Customer VPC* - The VPC in your AWS Account that you would like to peer with.
* *Customer VPC Region* - The region that the customer’s VPC resides.

[NOTE]
====
As of July 2018, AWS supports inter-region VPC peering between all commercial regions link:https://aws.amazon.com/vpc/faqs/#Peering_Connections[excluding China].
====

[id="initiate-accept-peering"]
== Initiate and Accept the VPC Peer Request

.Prerequisites

* Gather some information about the Customer VPC that you’ll need to initiate the peering request - Customer AWS account number, Customer VPC ID, Customer VPC Region, Customer VPC CIDR
* Check the CIDR block used by the {product-title} Cluster VPC. If it overlaps or matches the CIDR block for the Customer VPC, then peering between these two VPCs is link:https://docs.aws.amazon.com/vpc/latest/peering/invalid-peering-configurations.html[not possible]. If the CIDR blocks do not overlap, proceed to step 3.

.Procedure - Initiate the VPC Peering Request
The first step in this process is to send a VPC peering connection request from the OpenShift Dedicated AWS Account to the Customer AWS Account.

. xref:../../getting_started/cloud_infrastructure_access/dedicated-aws-access.html#dedicated-aws-ocm-iam-role[Log into the Web Console for the {product-title} AWS Account] and navigate to the *VPC Dashboard* in the region where the cluster is being hosted.
. Go to the *Peering Connections* page and click the *Create Peering Connection* button.
. Double check details of the account you are logged in to and double-check the details of the account/VPC you are connecting to (from the first step above).
.. Peering connection name tag - A descriptive name for the VPC Peering Connection.
.. VPC (Requester) - This should be the {product-title} Cluster VPC ID, select from the dropdown.
.. Account - Select *Another account*, and then provide the Customer AWS Account number (without dashes).
.. Region - If the Customer VPC Region differs from the current region, select *Another Region* and select the customer VPC Region from the dropdown.
.. VPC (Accepter) - The Customer VPC ID.
. Click *Create Peering Connection*.
. Confirm that the request enters a *Pending* state. If it enters a *Failed* state, confirm the details and repeat the process.

.Procedure - Accept the VPC Peering Request
Now that you have created the peering connection, you will need to accept the request in the Customer AWS Account.

. Log into the AWS Web Console.
. Navigate to *VPC Service*.
. Go to *Peering Connections*.
. Click on *Pending peering connection*.
. Confirm the AWS Account and VPC ID that the request originated from. This should be from the {product-title} AWS Account and {product-title} Cluster VPC.
. Click *Accept Request*.

[id="peering-routing-tables"]
== Configure the routing tables

.Procedure
When you accept the peering request, both VPCs will need to configure their routes to communicate across the peering connection.

. Log into the AWS Web Console for the {product-title} AWS Account.
. Go to the *VPC Service*, then *Route Tables*.
. Select the Route Table for the {product-title} Cluster VPC.
+
[NOTE]
====
On some clusters there may be more than one route table for a particular VPC. Select the private one that has a number of explicitly associated subnets.
====

. Select the *Routes* tab, then *Edit*.
. Enter the Customer VPC CIDR block in the *Destination* text box.
. Enter the Peering Connection ID in the *Target* text box.
. Click *Save*.

You will need to complete the same process with the other VPC’s CIDR block:

. Log into the Customer AWS Web Console → *VPC Service* → *Route Tables*.
. Select the Route Table for your VPC.
. Select the *Routes* tab, then *Edit*.
. Enter the {product-title} Cluster VPC CIDR block in the *Destination* text box.
. Enter the Peering Connection ID in the *Target* text box.
. Click *Save*.

The VPC peering connection is now complete. Follow the steps in the verification section to ensure connectivity across the peering connection is working.

[id="peering-verification-troubleshooting"]
== Verification and Troubleshooting VPC Peering

After setting up a VPC peering connection, it is best to confirm it has been configured and is working correctly.

[id="peering-verification"]
=== Confirm configuration and routing tables
In the AWS console, look at the route table for the cluster VPC that is peered. Ensure that the steps in the section above "Configuring the routing tables" were followed and that there is a route table entry pointing the VPC CIDR range destination to the peering connection target.

If the routes look correct on both the {product-title} Cluster VPC route table and Customer VPC route table , then the connection should be tested using the netcat method below. If the test calls are successful, then VPC peering is working correctly.

[id="peering-troubleshooting"]
=== Networking troubleshooting with netcat

If you need to test network connectivity to an endpoint device, `nc` (or `netcat`) is a helpful troubleshooting tool. It's included in the default image, and provides quick and clear output if a connection can be established.

----
# Create a throw-away pod with busybox; cleans up after itself
$ oc run netcat-test --image=busybox -i -t --restart=Never --rm -- /bin/sh

# Successful connection
/ nc -zvv 192.168.1.1 8080
10.181.3.180 (10.181.3.180:8080) open
sent 0, rcvd 0

# Failed connection
/ nc -zvv 192.168.1.2 8080
nc: 10.181.3.180 (10.181.3.180:8081): Connection refused
sent 0, rcvd 0

# Exit the container, which will automatically delete the pod
/ exit
----
