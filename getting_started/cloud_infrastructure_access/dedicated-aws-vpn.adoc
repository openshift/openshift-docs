[id="dedicated-aws-vpn"]
= AWS VPN Configuration
include::modules/common-attributes.adoc[]
:context: dedicated-aws-vpn
toc::[]

This is a sample process for configuring an AWS dedicated cluster to use a customer’s onsite hardware VPN device.

[NOTE]
====
AWS VPN does not currently provide a managed option to apply NAT to VPN traffic. More information can be found link:https://aws.amazon.com/premiumsupport/knowledge-center/configure-nat-for-vpn-traffic/[here].
====

[NOTE]
====
Routing all traffic (ie: 0.0.0.0/0) through a private connection is not supported. This requires deleting the internet gateway, which disables SRE management traffic.
====

For more information about connecting an AWS VPC to remote networks using a hardware VPN device, see the link:https://docs.aws.amazon.com/vpc/latest/userguide/vpn-connections.html[VPN connections guide].

[id="vpn-creation"]
== VPN Creation

.Prerequisites
The following information is needed to configure a hardware VPN connection:

* Hardware VPN gateway device model and software version (eg. Cisco ASA running version 8.3). Confirm your link:https://docs.aws.amazon.com/vpc/latest/adminguide/Introduction.html#DevicesTested[gateway device] is supported by AWS.
* Public, static IP address for the VPN gateway device
* BGP or static routing - if BGP, the ASN will be required. If static routing, you will be required to configure at least one static route.
* (Optional) IP and Port/Protocol of a reachable service to test the VPN connection

[id="vpn-configure"]
=== Configuring the VPN Connection

.Procedure
. Log into the OSD AWS Account Dashboard, and navigate to the VPC Dashboard.
. Click on *Your VPCs* and identify the name and VPC ID for the VPC containing the OSD cluster.
. From the VPC Dashboard, click *Customer Gateway*.
. Click *Create Customer Gateway* and give it a meaningful name.
. Select the routing method: *Dynamic* or *Static*.
. If Dynamic, enter the BGP ASN in the field that appears.
. Paste in the VPN gateway endpoint IP address.
. Click *Create*.
. If you do not already have a Virtual Private Gateway attached to the intended VPC:
.. From the VPC Dashboard, click on *Virtual Private Gateway*.
.. Click *Create Virtual Private Gateway*, give it a meaningful name, and click *Create*.
.. Leave the default Amazon default ASN.
.. Select the newly created gateway, click *Attach to VPC*, and attach it to the cluster VPC you identified earlier.

[id="vpn-establish"]
=== Establishing the VPN Connection

.Procedure
. From the VPC dashboard, click on *Site-to-Site VPN Connections*.
. Click *Create VPN Connection*.
.. Give it a meaningful name tag.
.. Select the virtual private gateway created previously.
.. For Customer Gateway, Select *Existing*.
.. Select the customer gateway device by name.
.. If the VPN will be using BGP, select *Dynamic*, otherwise select *Static*. Enter Static IP CIDRs. If there are multiple CIDRs, add each CIDR as *Another Rule*.
.. Click "Create*.
.. Wait for VPN status to change to *Available* (approximately 5-10 minutes).
. Select the VPN you just created, and click *Download Configuration*.
.. From the dropdown, select the vendor, platform, and version of the customer gateway device, then click *Download*.
.. The *Generic* vendor configuration is also available for retrieving information in a plain text format.

[NOTE]
====
Once the VPN connection has been established, be sure to set up Route Propagation or the VPN may not function as expected.
====

[NOTE]
====
You will also need the VPC subnet information, which you must add to your configuration as the remote network.
====

[id="route-propagation"]
=== VPN Route Propagation

Once you have set up the VPN connection, you’ll need to ensure that route propagation is enabled so that the necessary routes will be added to the VPC’s route table.

.Procedure
. From the VPC Dashboard, click on *Route Tables*.
. Select the private Route table associated with the VPC that contains your OSD cluster.
+
[NOTE]
====
On some clusters, there may be more than one route table for a particular VPC. Select the private one that has a number of explicitly associated subnets.
====

. Click on the *Route Propagation* tab.
. In the table that appears, you should see the virtual private gateway you created previously. Check the value in the *Propagate column*.
.. If Propagate is set to *No*, click *Edit route propagation*, check the Propagate checkbox next to the virtual private gateway’s name, and click *Save*.

Now, once you configure your VPN tunnel and AWS detects it as *Up*, your static or BGP routes will automatically be added to the route table.

[id="vpn-troubleshooting"]
== Verification and Troubleshooting

Once you have set up your side of the VPN tunnel, you should be able to see that the tunnel is up in the AWS console.

[id="aws-verification"]
=== AWS Verification

.Procedure
. From the VPC Dashboard, click on *VPN Connections*.
. Select the VPN connection you created previously and click the *Tunnel Details* tab.
. You should be able to see that at least one of the VPN tunnels is *Up*.

Once you can see the customer gateway has been configured and the connection is UP, then we are ready to verify that connectivity across the tunnel is working.

[id="connection-verification"]
=== Connection verification

If you need to test network connectivity to an endpoint device, `nc` (or `netcat`) is a handy troubleshooting tool. It's included in the default image, and provides quick and clear output if a connection can be made:

----
# Create a throw-away pod with busybox; cleans up after itself
$ oc run netcat-test --image=busybox -i -t --restart=Never --rm -- /bin/sh

# Successful connection
/ nc -zvv 192.168.1.1 8080
10.181.3.180 (10.181.3.180:8080) open
sent 0, rcvd 0

# Failed connection
/ nc -zvv 192.168.1.2 8080
nc: 10.181.3.180 (10.181.3.180:8081): Connection refused
sent 0, rcvd 0

# Exit the container, which will automatically delete the pod
/ exit
----

[id="vpn-troubleshooting"]
=== VPN Troubleshooting

[id="vpn-tunnel"]
==== Tunnel does not connect

If the tunnel connection is still *Down*, there are several things you can verify:

* The AWS tunnel will not initiate a VPN connection. The connection attempt must be initiated from the Customer Gateway.
* Ensure that your source traffic is coming from the same IP as the configured customer gateway. AWS will silently drop all traffic to the gateway who’s source IP address does not match
* Ensure that your configuration matches values link:https://docs.aws.amazon.com/vpc/latest/adminguide/Introduction.html#CGRequirements[supported by AWS]. This includes IKE versions, DH groups, IKE lifetime, etc.
* Recheck the route table for the VPC. Ensure that propagation is enabled and that there are entries in the route table that have the virtual private gateway you created earlier as a target.
* Confirm that you don’t have any firewall rules that could be causing an interruption.
* Check if you are using a policy-based VPN as this can cause complications depending on how it is configured.
* Further troubleshooting steps can be found link:https://aws.amazon.com/premiumsupport/knowledge-center/vpn-tunnel-troubleshooting/[here].

[id="tunnel-stay-connected"]
==== Tunnel does not stay connected

If the tunnel connection has trouble staying UP consistently, know that all AWS tunnel connections must be initiated from your gateway. AWS tunnels link:https://docs.aws.amazon.com/vpn/latest/s2svpn/VPC_VPN.html#CustomerGateway[do not initiate tunneling].

Red Hat's recommendation is to set up an SLA Monitor (Cisco ASA) or some device on your side of the tunnel that constantly sends "interesting" traffic (e.g., `ping`, `nc`, or `telnet`) at any IP address configured within the VPC CIDR range. It doesn’t matter whether the connection is successful, just that the traffic is being directed at the tunnel.

[id="secondary-tunnel-down"]
==== Secondary tunnel in Down state

When a VPN tunnel is created, AWS creates an additional failover tunnel. Depending upon the gateway device, sometimes the secondary tunnel will be seen as in the *Down* state.
