[[dev-guide-pod-presets]]
= Inject Information into Pods Using Pod Presets
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]

== Overview

A _pod preset_ is an object that injects certain information into pods as they are created. 

Administrators can use pod presets to inject: 

* xref:../../dev_guide/secrets.html[secrets]
* xref:../../dev_guide/configmaps.html[ConfigMap objects] 
* xref:../../dev_guide/volumes.html[storage volumes] 
* container volume mounts
* environment variables 

Developers only need to add the appropriate label to the pod specification in order to add all that information to the pod. The label on a pod associates the pod with one or more pod presets that have a matching xref:../../architecture/core_concepts/pods_and_services.html#services[label selectors].

Using pod presets, a developer can provision pods without needing to know the details about the service the pod will consume. An administrator can keep configuration items of a service invisible from a developer without preventing the developer from deploying pods. For example, an administrator can create a pod preset that provides the name, username, and password for a database through a secret and the database port through an environment variable. The pod developer only needs to know the label to use.

When a pod preset is applied to a pods, {product-title} modifies the pod spec, adding the injectable data and annotating the pod spec to show that it was modified by a pod preset. The annotation is of the form `podpreset.admission.kubernetes.io/<pod-preset name>: `resource version``. 

If the pod creation encounters an error, the pod is created without any injected resources from the pod preset.

.Sample pod preset object
----
kind: PodPreset
apiVersion: settings.k8s.io/v1alpha1 <1>
metadata:
  name: allow-database <2>
  namespace: myns
spec:
  selector:
    matchLabels:
      role: frontend <3>
  env: <3>
    - name: DB_PORT
      value: "6379"
  envFrom: <4>
    - configMapRef:
      name: etcd-env-config
    - secretKeyRef: <5>
      name: test-secret
  volumeMounts: <6>
    - mountPath: /cache
      name: cache-volume
  volumes: <7>
    - name: cache-volume
      emptyDir: {}
----

<1> Specify the `settings.k8s.io/v1alpha1` API.
<2> Name of the pod preset. The annotation indicating the pod preset was injected references this name.
<3> Add a label selector that matches the label in the pod specification.
<4> Create an environment variable to pass to the container.
<5> Add a secret file to the pod specification.
<6> Add a ConfigMap to the pod specification.
<7> Specify where external storage volumes should be mounted within the container.
<8> Define storage volumes that are available to its container(s) to use.


.Sample pod specification after a pod preset
----
apiVersion: v1
kind: Pod
metadata:
  name: website
  labels:
    app: website
    role: frontend
  annotations: 
    podpreset.admission.kubernetes.io/allow-database: "resource version" <1>
spec:
  containers:
    - name: website
      image: ecorp/website
      volumeMounts: <2>
        - mountPath: /cache
          name: cache-volume
      ports:
        - containerPort: 80
      env: <3>
        - name: DB_PORT
          value: "6379"
      envFrom: <4>
        - configMapRef:
          name: etcd-env-config
  volumes: <5>
    - name: cache-volume
      emptyDir: {}
----

<1> The annotation added to show a pod preset was injected.
<2> Tne volume mount is added to the pod.
<3> Tne environment variable is added to the pod.
<4> The ConfigMap added by the pod preset.
<5> Tne volume mount is added to the pod.

In order to use pod presets in your cluster you must:

* Enable the pod preset admission controller plug-in through the *_/etc/origin/master/master-config.yaml_*;
* Enable the api type `settings.k8s.io/v1alpha1/podpreset` throuh the pod preset;
* Define your pod presets.

[[dev-guide-pod-presets-create]]
== Creating Pod Presets

The following example demonstrates how to create and use pod presets.

. Make sure the pod preset admission controller plug-in is present in the *_/etc/origin/master/master-config.yaml_* file:
+
----
admissionConfig:
  pluginConfig:
    PodPreset:
      configuration:
        kind: DefaultAdmissionConfig
        apiVersion: v1
        disable: false# systemctl restart atomic-openshift-master.service
----
+
If you need to add the plug-in, restart the {product-title} services:
+
ifdef::openshift-enterprise[]
----
# systemctl restart atomic-openshift-master
----
endif::[]
ifdef::openshift-origin[]
----
# systemctl restart origin-master
----
endif::[]

. The administrator creates a pod preset, similar to the following, with environment variables, mount points, and/or storage volumes:
+
----
kind: PodPreset
apiVersion: settings.k8s.io/v1alpha1 
metadata:
  name: allow-database
  namespace: myns
spec:
  selector:
    matchLabels:
      role: frontend <1>
  env:
    - name: DB_PORT
      value: "6379"
  volumeMounts:
    - mountPath: /cache
      name: cache-volume
  volumes:
    - name: cache-volume
      emptyDir: {}
----
+
<1> Add a label selector that matches the label that the developer uses in the pod specification.

+
For more information on pod creation, see xref:../../architecture/core_concepts/pods_and_services.html#pods[Pods and Services].

. The developer creates a standard pod specification:
+
----
apiVersion: v1
kind: Pod
metadata:
  name: website
  labels:
    app: website
    role: frontend <1>
spec:
  containers:
    - name: website
      image: ecorp/website
      ports:
        - containerPort: 80
----
+
<1> Add a label to the pod specification that matches the label selector in the pod preset.

. Create the pod:
+
----
oc create -f pod.yaml
----

. Check the pod spec after creation:
+
----
oc get pod pod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: website
  labels:
    app: website
    role: frontend
  annotations: 
    podpreset.admission.kubernetes.io/allow-database: "resource version"
spec:
  containers:
    - name: website
      image: ecorp/website
      volumeMounts:
        - mountPath: /cache
          name: cache-volume
      ports:
        - containerPort: 80
      env: 
        - name: DB_PORT
          value: "6379"
  volumes: 
    - name: cache-volume
      emptyDir: {}
----

[[dev-guide-pod-presets-delete]]
== Deleting Pod Presets

You can delete a pod preset using the following command:

----
$ oc delete podpreset <name>
----

For example:

----
$ oc delete podpreset allow-database

podpreset "allow-database" deleted
----

[[dev-guide-pod-presets-example]]
== Examples

The following examples show different ways to use pod presets.

[[dev-guide-pod-presets-example-config]]
=== Using a Pod Preset Including a ConfigMap

You can use a pod preset to inject a ConfigMap in a pod.

The following example uses a pod preset and a ConfigMap to inject environment variables:

* Make sure the pod preset admission controller plug-in has been enabled.

* Create a ConfigMap with environment variables:
+
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: env-config
data:
  number_of_members: "1"
  initial_cluster_state: new
  initial_cluster_token: DUMMY_ETCD_INITIAL_CLUSTER_TOKEN
  discovery_token: DUMMY_ETCD_DISCOVERY_TOKEN
  discovery_url: http://etcd_discovery:2379
  etcdctl_peers: http://etcd:2379
  duplicate_key: FROM_CONFIG_MAP
  REPLACE_ME: "a value"
----

* Create a pod preset, similar to the following, calling the ConfigMap using the `envFrom` parameter. This example also contains environment variables, mount points, and/or storage volumes:
+
----
kind: PodPreset
apiVersion: settings.k8s.io/v1alpha1
metadata:
  name: allow-database
  namespace: myns
spec:
  selector:
    matchLabels:
      role: frontend
  env:
    - name: DB_PORT
      value: 6379
    - name: duplicate_key
      value: FROM_ENV
    - name: expansion
      value: $(REPLACE_ME)
  envFrom: <1>
    - configMapRef:
        name: env-config
  volumeMounts:
    - mountPath: /cache
      name: cache-volume
    - mountPath: /etc/app/config.json
      readOnly: true
      name: secret-volume
  volumes:
    - name: cache-volume
      emptyDir: {}
    - name: secret-volume
      secretName: config-details
----
+
<1> Specify the ConfigMap to use.

* Create a standard pod specification with the appropriate label:
+
----
apiVersion: v1
kind: Pod
metadata:
  name: website
  labels:
    app: website
    role: frontend
spec:
  containers:
    - name: website
      image: ecorp/website
      ports:
        - containerPort: 80
----

* Create the pod:
+
----
oc create -f pod.yaml
----

* Check the pod spec after creation:
+
----
oc get pod pod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: website
  labels:
    app: website
    role: frontend
  annotations:
    podpreset.admission.kubernetes.io/allow-database: "resource version"
spec:
  containers:
    - name: website
      image: ecorp/website
      volumeMounts:
        - mountPath: /cache
          name: cache-volume
        - mountPath: /etc/app/config.json
          readOnly: true
          name: secret-volume
      ports:
        - containerPort: 80
      env:
        - name: DB_PORT
          value: "6379"
        - name: duplicate_key
          value: FROM_ENV
        - name: expansion
          value: $(REPLACE_ME)
      envFrom: <1>
        - configMapRef:
          name: etcd-env-config
  volumes:
    - name: cache-volume
      emptyDir: {}
    - name: secret-volume
      secretName: config-details
----
+
<1> The ConfigMap is added to the pod.

[[dev-guide-pod-presets-example-multi]]
=== Using Multiple Pod Presets

You can use multiple pod presets to inject multiple pod injection policies.

* Make sure the pod preset admission controller plug-in has been enabled.

* Create a pod preset, similar to the following, with environment variables, mount points, and/or storage volumes:
+
----
kind: PodPreset
apiVersion: settings.k8s.io/v1alpha1
metadata:
  name: allow-database
  namespace: myns
spec:
  selector:
    matchLabels:
      role: frontend <1>
  env:
    - name: DB_PORT
      value: "6379"
  volumeMounts:
    - mountPath: /cache
      name: cache-volume
  volumes:
    - name: cache-volume
      emptyDir: {}
----
+
<1> Label selector to match the pod label.

* Create a second pod preset, similar to the following:
+
----
kind: PodPreset
apiVersion: settings.k8s.io/v1alpha1
metadata:
  name: proxy
  namespace: myns
spec:
  selector:
    matchLabels:
      role: frontend <1>
  volumeMounts:
    - mountPath: /etc/proxy/configs
      name: proxy-volume
  volumes:
    - name: proxy-volume
      emptyDir: {}
----
+
<1> Label selector to match the pod label.

* Create a standard pod specification:
+
----
apiVersion: v1
kind: Pod
metadata:
  name: website
  labels:
    app: website 
    role: frontend <1>
spec:
  containers:
    - name: website
      image: ecorp/website
      ports:
        - containerPort: 80
----
+
<1> Label to match the pod preset label selector.

* Create the pod:
+
----
oc create -f pod.yaml
----

* Check the pod spec after creation:
+
----
apiVersion: v1
kind: Pod
metadata:
  name: website
  labels:
    app: website
    role: frontend
  annotations:
    podpreset.admission.kubernetes.io/allow-database: "resource version" <1>
    podpreset.admission.kubernetes.io/proxy: "resource version" <1>
spec:
  containers:
    - name: website
      image: ecorp/website
      volumeMounts:
        - mountPath: /cache
          name: cache-volume
        - mountPath: /etc/proxy/configs
          name: proxy-volume
      ports:
        - containerPort: 80
      env:
        - name: DB_PORT
          value: "6379"
  volumes:
    - name: cache-volume
      emptyDir: {}
    - name: proxy-volume
      emptyDir: {}
----
+
<1> Annotation indicating that multiple pod presets were injected.

