:_mod-docs-content-type: ASSEMBLY
[id="three-scale-oadp"]
= Backing up and restoring 3scale using OADP
include::_attributes/common-attributes.adoc[]
include::_attributes/attributes-openshift-dedicated.adoc[]
:context: three-scale-oadp

toc::[]


Red Hat 3scale API Management (APIM) makes it easy to manage your APIs for internal or external users. Share, secure, distribute, control, and monetize your APIs on an infrastructure platform built with performance, customer control, and future growth in mind.

3scale components can be deployed on-premise, in the cloud, as a managed service, or in any combination required.

This document describes how the {oadp-first} Operator can be used to back up and restore 3scale with on-cluster storage.

The backup scenario covers a situation in which you are not using custom domains, and you need to recover to a cluster with a different domain than the source cluster.

The flow of backup in this document is divided into 3 phases:

. Backup and restore of the 3scale Operator
. Backup and restore of the 3scale data
. Backup and restore of the capabilities

The backup is done in multiple phases for the purpose of a clean explanation of the entire flow but can potentially be done in a single phase using a more sophisticated version of Backup CR.

However, the restoration must be done in a few phases due to how the 3scale-operator interacts with the APIM and general operator's installation flow.

There are a couple of assumptions made in this document:

* Source and destination clusters are of the same OCP/OSD version.

* 3scale installation will have all of its job queue drained before running the backup.

* 3scale installation is fully functional at the time of backup

* There are two approaches for backing up the system database, recommended by OADP: the service-affecting approach and the non-service-affecting approach.
+
[NOTE]
====
This would need to be approved by the OADP team because of the potential impact of using this approach.
====

* The operator is restored by re-creating the subscription and operator groups. Meaning that if customers have changed any values of their operator via the CSV, the operator will not be properly recovered. However, the use case for updating CSV to edit values in the operator when it comes to 3scale should be none, and customers should use subscription configuration instead.

* This scenario does not use a custom domain; with a custom domain, with a custom domain the restoration might be easier, mainly due to routes not having to be updated manually in the database. If a default cluster domain is used, customers will have to update their domains in the database post-migration.

* Installation and configuration of OADP follow the setup for OADP with AWS as the S3 provider. The important bit is to enable Restic (when creating the DataProtectionApplication CR), since it is what we are going to use to perform the backup and restoration of the PVs. These steps need to be performed for **both** the source cluster and the destination cluster.

[NOTE]
====
Enable Restic when creating the DataProtectionApplication (DPA) custom resource (CR) as this is what it used to perform the backup and restoration of the PVs. Enabling Restic must be completed on both the source cluster and the destination cluster.
====

// We will have to discuss with QE how to enable Kopia for this.

include::modules/oadp-three-scale-operator-back-and-restore.adoc[leveloffset=+1]

[id="backing-up-secrets-and-apim_{context}"]
== Backing up secrets and APIM

After you have restored the operator on the destination cluster, and it is running, you need to backup and restore the operator resources, these include:

* Secrets
* APIManager

This is to ensure that the operator recreates with the same credentials as the source cluster, but not with the same state of data, as this is will be covered by subsequent phases.

include::modules/backing-up-api-manager-custom-resources.adoc[leveloffset=+2]
include::modules/backing-up-secrets-custom-resources.adoc[leveloffset=+2]
