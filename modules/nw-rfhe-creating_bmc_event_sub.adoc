// Module included in the following assemblies:
//
// * networking/using-rfhe.adoc

:_content-type: PROCEDURE
[id="nw-rfhe-creating_bmc_event_sub_{context}"]
= Subscribing to Redfish hardware events

You can configure the baseboard management controller (BMC) to send Redfish hardware events to subscribed applications running in {product-title} cluster. Example Redfish events include an increase in device temperature, or removal of a device. Applications subscribe to Redfish hardware events using a REST API.

[IMPORTANT]
====
You can only create a `BMCEventSubscription` CR for physical hardware that supports Redfish and has a vendor interface set to `redfish` or `idrac-redfish`.
====

[NOTE]
====
Use the `BMCEventSubscription` CR to subscribe to pre-defined Redfish events. The Redfish standard does not provide an option to create specific alerts and thresholds. For example, to receive an alert event when an enclosure's temperature exceeds 40Â° Celsius, you need to manually configure the event according to the vendor's recommendations.
====

To subscribe to Redfish hardware events for the node using a `BMCEventSubscription` custom resource (CR), perform the following procedure:

.Prerequisites
* Install the OpenShift CLI (`oc`).
* Log in as a user with `cluster-admin` privileges.
* Get the user name and password for the BMC.
* Deploy a bare-metal node with Redfish hardware in your cluster, and enable Redfish events on the BMC.
+
[NOTE]
====
Enabling Redfish events on specific hardware is outside the scope of this information. For more information about enabling Redfish events for your specific hardware, consult the BMC manufacturer documentation.
====

.Procedure
. Confirm the node hardware has the Redfish `EventService` enabled using the following `curl` command:
+
[source,terminal]
----
curl https://<bmc_ip_address>/redfish/v1/EventService --insecure -H 'Content-Type: application/json' -u "<user_name>:<password>"
----
+
where:
+
--
bmc_ip_address:: is the IP address of the BMC controller.
--
+
.Example output
[source,terminal]
----
{
   "@odata.context": "/redfish/v1/$metadata#EventService.EventService",
   "@odata.id": "/redfish/v1/EventService",
   "@odata.type": "#EventService.v1_0_2.EventService",
   "Actions": {
      "#EventService.SubmitTestEvent": {
         "EventType@Redfish.AllowableValues": ["StatusChange", "ResourceUpdated", "ResourceAdded", "ResourceRemoved", "Alert"],
         "target": "/redfish/v1/EventService/Actions/EventService.SubmitTestEvent"
      }
   },
   "DeliveryRetryAttempts": 3,
   "DeliveryRetryIntervalSeconds": 30,
   "Description": "Event Service represents the properties for the service",
   "EventTypesForSubscription": ["StatusChange", "ResourceUpdated", "ResourceAdded", "ResourceRemoved", "Alert"],
   "EventTypesForSubscription@odata.count": 5,
   "Id": "EventService",
   "Name": "Event Service",
   "ServiceEnabled": true,
   "Status": {
      "Health": "OK",
      "HealthRollup": "OK",
      "State": "Enabled"
   },
   "Subscriptions": {
      "@odata.id": "/redfish/v1/EventService/Subscriptions"
   }
}
----

. Get the hardware event proxy service route for the cluster:
+
[source,terminal]
----
$ oc get route -n openshift-hw-events
----
+
.Example output
[source,terminal]
----
NAME                      HOST/PORT                                                                            PATH   SERVICES                  PORT    TERMINATION            WILDCARD
hw-event-proxy            hw-event-proxy-cloud-native-events.apps.compute-1.example.com                               hw-event-proxy-service    9087    edge                   None
----

. Create a `BMCEventSubscription` resource to subscribe to the Redfish events:

.. Save the following YAML in the `bmc_sub.yaml` file:
+
[source,yaml]
----
apiVersion: metal3.io/v1alpha1
kind: BMCEventSubscription
metadata:
  name: sub-01
  namespace: openshift-machine-api
spec:
   hostName: <hostname> <1>
   destination: <proxy_service_url> <2>
   context: ''
----
<1> Specifies the name or UUID of the worker node where the Redfish events are generated.
<2> Specifies the baremetal hardware event proxy service, for example, `https://hw-event-proxy-cloud-native-events.apps.compute-1.example.com/webhook`.
+

.. Create the `BMCEventSubscription` CR:
+
[source,terminal]
----
$ oc create -f bmc_sub.yaml
----

. Optional: To delete the BMC event subscription, run the following command:
+
[source,terminal]
----
$ oc delete -f bmc_sub.yaml
----
