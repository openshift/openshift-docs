// Module included in the following assemblies:
//
// * installing/installing_ocp/install-central-ocp.adoc
:_mod-docs-content-type: PROCEDURE
[id="install-central-operator-external-db_{context}"]

= Installing Central with an external database using the Operator method

[role="_abstract"]
The main component of {product-title} is called Central. You can install Central on {ocp} by using the `Central` custom resource. You deploy Central only once, and you can monitor multiple separate clusters by using the same Central installation.

[IMPORTANT]
====
When you install {product-title} for the first time, you must first install the `Central` custom resource because the `SecuredCluster` custom resource installation is dependent on certificates that Central generates.
====

For more information about {product-title-short} databases, see the link:https://access.redhat.com/articles/7045053#database-scope-of-coverage-7[Database Scope of Coverage].

.Prerequisites
* You must be using {ocp} {ocp-supported-version} or later. For more information about supported {ocp} versions, see the link:https://access.redhat.com/articles/7045053[Red Hat Advanced Cluster Security for Kubernetes Support Matrix].
* You must have a database in your database instance that supports PostgreSQL 13 and a user with the following permissions:
** Connection rights to the database.
** `Usage` and `Create` on the schema.
** `Select`, `Insert`, `Update`, and `Delete` on all tables in the schema.
** `Usage` on all sequences in the schema.

.Procedure
. On the {ocp} web console, go to the *Operators* -> *Installed Operators* page.
. Select the {product-title} Operator from the list of installed Operators.
. If you have installed the Operator in the recommended namespace, {ocp} lists the project as `rhacs-operator`. Select *Project: rhacs-operator* -> *Create project*.
+
[WARNING]
====
* If you have installed the Operator in a different namespace, {ocp} shows the name of that namespace rather than `rhacs-operator`.
* Red{nbsp}Hat recommends installing the {product-title} `Central` custom resource in a dedicated project. Do not install it in the project where you have installed the {product-title} Operator. Additionally, do not install it in any projects with names that begin with `kube`, `openshift`, or `redhat`, and in the `istio-system` project.
====
. Enter the new project name (for example, `stackrox`), and click *Create*. Red{nbsp}Hat recommends that you use `stackrox` as the project name.
. Create a password secret in the deployed namespace by using the {ocp} web console or the terminal.
** On the {ocp} web console, go to the *Workloads* â†’ *Secrets* page. Create a *Key/Value secret* with the key `password` and the value as the path of a plain text file containing the password for the superuser of the provisioned database.
** Or, run the following command in your terminal:
+
[source,terminal]
----
$ oc create secret generic external-db-password \// <1>
  --from-file=password=<password.txt> <2>
----
<1> If you use Kubernetes, enter `kubectl` instead of `oc`.
<2> Replace `password.txt` with the path of the file which has the plain text password.
. Return to the {product-title} operator page in the {ocp} web console. Under the *Provided APIs* section, select *Central*. Click *Create Central*.
. Optional: If you are using declarative configuration, next to *Configure via:*, click *YAML view*.
. Add the information for the declarative configuration, such as shown in the following example:
+
[source,yaml]
----
...
spec:
  central:
    declarativeConfiguration:
      configMaps:
      - name: <declarative-configs> <1>
      secrets:
      - name: <sensitive-declarative-configs> <2>
...
----
<1> Replace <declarative-configs> with the name of the config maps that you are using.
<2> Replace <sensitive-declarative-configs> with the name of the secrets that you are using.
. Enter a name for your `Central` custom resource and add any labels you want to apply.
. Go to *Central Component Settings* -> *Central DB Settings*.
. For *Administrator Password* specify the referenced secret as `external-db-password` (or the secret name of the password created previously).
. For *Connection String* specify the connection string in `keyword=value` format, for example, `host=<host> port=5432 database=stackrox user=stackrox sslmode=verify-ca`
. For *Persistence* -> *PersistentVolumeClaim* -> *Claim Name*, remove `central-db`.
. If necessary, you can specify a Certificate Authority so that there is trust between the database certificate and Central. To add this, go to the YAML view and add a TLS block under the top-level spec, as shown in the following example:
+
[source,yaml]
----
spec:
  tls:
    additionalCAs:
    - name: db-ca
      content: |
        <certificate>
----
//Add a link for customization options
. Click *Create*.

[NOTE]
====
If you are using the cluster-wide proxy, {product-title} uses that proxy configuration to connect to the external services.
====

.Next Steps
. Verify Central installation.
. Optional: Configure Central options.
. Generate an init bundle containing the cluster secrets that allows communication between the `Central` and `SecuredCluster` resources. You need to download this bundle, use it to generate resources on the clusters you want to secure, and securely store it.
. Install secured cluster services on each cluster you want to monitor.
