// Module included in the following assemblies:
//
// * networking/network_security/network_policy/nw-networkpolicy-full-multitenant-isolation.adoc

:_mod-docs-content-type: PROCEDURE
[id="nw-networkpolicy-enable-pod-pod-communication-egress_{context}"]
= Enabling pod-to-pod communication

After creating a `default-deny-all` network policy that isolates pods for egress, pod-to-pod communication is broken for ingress. To re-establish ingress communication for pods, you must create a complementary egress network policy that _mirrors_ the network policy that allowed for ingress pod-to-pod communication across namespaces.

The following procedure shows you how to create a complementary egress network policy named `egress-allow-n1-a-to-n2-b`. The `egress-allow-n1-a-to-n2-b` network policy mirrors the the `allow-n1-a-to-n2-b` network policy that was created in "Creating a network policy for cross-namespace communication" and is applied to the opposite namespace that the `allow-n1-a-to-n2-b` network policy was applied to. Mirroring the `allow-n1-a-to-n2-b` network policy requires you to adjust the following fields of that network policy:

* Change the `policyTypes` field to be an array that contains only `Egress`.
* Take the `spec.podSelector` field, and put it inside of a `spec.egress.to.podSelector` block.
*  Remove the `ingress.from` section for your new egress policy, but copy the `ingress.from.podSelector` reference and make it the `spec.podSelector` of the egress policy.

.Prerequisites 

* You have created the following `allow-n1-a-to-n2-b` ingress network policy:
+
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-n1-a-to-n2-b
spec:
  podSelector:
    matchLabels:
      app: receive-data
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          networking/namespace:
      podSelector:
        matchLabels:
          app: send-data
----

.Procedure

. Create the following `egress-allow-n1-a-to-n2-b` network policy that mirrors the `allow-n1-a-to-n2-b` network policy:
+
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-n1-a-to-n2-b-egress
spec:
  podSelector:
    matchLabels:
      app: send-data
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          networking/namespace: n2
      podSelector:
        matchLabels:
          app: receive-data
  policyTypes:
  - Egress
----

. Apply the `allow-n1-a-to-n2-b-egress` network policy to the `project-a` namespace by running the following command:
+
[source,terminal]
----
$ oc apply -f allow-n1-a-to-n2-b-egress.yaml -n project-a
----

.Verification

. Obtain the IP addresses of pods in the `project-b` namespace by running the following command:
+
[source,terminal]
----
$ oc get pod -n project-a -o wide
----
+
.Example output
+
[source,terminal]
----
NAME            READY   STATUS    RESTARTS   AGE   IP            NODE                           NOMINATED NODE   READINESS GATES
busybox-pod-b   1/1     Running   0          10m   10.132.0.42   ip-10-0-138-121.ec2.internal   <none>           <none>
test-pod-b      1/1     Running   0          10m   10.132.0.44   ip-10-0-138-121.ec2.internal   <none>           <none>
----

. Ensure that a pod in the `project-a` namespace can communicate with a pod in the `project-b` namespace. For example:
+
[source,terminal]
----
$ oc exec -it busybox-pod-a -n project-a -- ping 10.132.0.44
----
+
.Example output
+
[source,terminal]
----
PING 10.132.0.44 (10.132.0.44): 56 data bytes
64 bytes from 10.132.0.44: seq=0 ttl=42 time=1.129 ms
64 bytes from 10.132.0.44: seq=1 ttl=42 time=0.608 ms
----