// Module included in the following assemblies:
//
// * service_mesh/v2x/customizing-installation-ossm.adoc

[id="ossm-cr-example_{context}"]
= {ProductName} custom resources

[NOTE]
====
The `istio-system` project is used as an example throughout the {ProductShortName} documentation, but you can use other projects as necessary.
====

A _custom resource_ allows you to extend the API in an {ProductName} project or cluster. When you deploy {ProductShortName} it creates a default `ServiceMeshControlPlane` that you can modify to change the project parameters.

The {ProductShortName} operator extends the API by adding the `ServiceMeshControlPlane` resource type, which enables you to create `ServiceMeshControlPlane` objects within projects. By creating a `ServiceMeshControlPlane` object, you instruct the Operator to install a {ProductShortName} control plane into the project, configured with the parameters you set in the `ServiceMeshControlPlane` object.

This example `ServiceMeshControlPlane` definition contains all of the supported parameters and deploys {ProductName} {ProductVersion} images based on Red Hat Enterprise Linux (RHEL).

[IMPORTANT]
====
The 3scale Istio Adapter is deployed and configured in the custom resource file. It also requires a working 3scale account (link:https://www.3scale.net/signup/[SaaS] or link:https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.4/html/infrastructure/onpremises-installation[On-Premises]).
====

.Example istio-installation.yaml

[source,yaml]
----
apiVersion: maistra.io/v1
kind: ServiceMeshControlPlane
metadata:
  name: basic-install
spec:
  proxy:
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 128Mi

  gateways:
    ingress: # _the_ istio-ingressgateway
      service:
        type: ClusterIP
        ports:
        - name: status-port
          port: 15020
        - name: http2
          port: 80
          targetPort: 8080
        - name: https
          port: 443
          targetPort: 8443
      meshExpansionPorts: []
    egress: # _the_ istio-egressgateway
      service:
        type: ClusterIP
        ports:
        - name: status-port
          port: 15020
        - name: http2
          port: 80
          targetPort: 8080
        - name: https
          port: 443
          targetPort: 8443
    additionalIngress:
      some-other-ingress-gateway: {}
    additionalEgress:
      some-other-egress-gateway: {}

  policy:
    mixer:
      enableChecks: false # default
      failOpen: false # default
      runtime:
        container:
          image: mixer # default mixer image
          resources: {} # mixer resources

  telemetry:
    type: <istiod_#or_Mixer_or_Remote>
    mixer: # legacy v1
      sessionAffinity: false
      batching:
        maxEntries: 100
        maxTime: 1s
      adapters:
        useAdapterCRDs: false
        kubernetesenv: true
        stdio:
          outputAsJSON: false
        prometheus:
          metricsExpiryDuration: 10m
        stackdriver: null

  runtime:
    pilot:
      deployment:
        replicas: 2
      pod:
        affinity: {}
      container:
        resources:
          limits: {}
          requirements: {}

  addons:
    visualization:
      grafana:
        address: some-grafana-url # use existing grafana install, or...
        install: # install grafana if not null
          selfManaged: true # use grafana CR, maybe poor naming?
          config:
            env: {} # .Values.grafana.env
            envSecrets: {} # .Values.grafana.envSecrets
          persistence:
            storageClassName: ""
            accessMode: ReadWriteOnce
            capacity: 5Gi # not supported in charts
          service: # similar to addons.tracing.jaeger.install.config.service
            ingress:
              contextPath: /grafana
              tls:
                termination: reencrypt
          runtime:
            deployment: {}
            pod: {}
      kiali:
        name: kiali # kiali CR to create/reference
        install: # install kiali CR if not present
          config:
            dashboard:
              viewOnly: false
              enableGrafana: true
              enableTracing: true
              enablePrometheus: true
          service: 
            ingress:
              contextPath: /kiali
          runtime:
            deployment: {}
            pod: {}
----
