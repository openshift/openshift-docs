// Module included in the following assemblies:
//
// * security/tls-profiles.adoc

[id="tls-profiles-kubelet-configuring_{context}"]
= Configuring TLS profiles for the Kubelet

To configure a TLS security profile for the kubelet HTTP server, create a `KubeletConfig` object to specify a predefined or custom TLS profile for specific nodes.

[NOTE]
====
By default, when the kubelet acts as a client with the Kubernetes API server, it automatically negotiates the TLS parameters with the API server.
====

.Sample `KubeletConfig` CR that configures the `Intermediate` TLS security profile on master nodes
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: KubeletConfig
metadata:
  name: set-kubelet-tls-intermediate-profile
spec:
  tlsSecurityProfile:
    type: Intermediate
  machineConfigPoolSelector:
    matchLabels:
      node-role.kubernetes.io/master= ""
----

.Prerequisites

* You have access to the cluster as a user with the `cluster-admin` role.

.Procedure

. Create a `KubeletConfig` custom resource (CR) to configure the TLS security profile:
+
.Sample `KubeletConfig` CR for a `Custom` profile
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: KubeletConfig
metadata:
  name: set-kubelet-tls-security-profile
spec:
  tlsSecurityProfile:
    custom: <1>
      ciphers: <2>
      - ECDHE-ECDSA-CHACHA20-POLY1305
      - ECDHE-RSA-CHACHA20-POLY1305
      - ECDHE-RSA-AES128-GCM-SHA256
      - ECDHE-ECDSA-AES128-GCM-SHA256
      minTLSVersion: VersionTLS11
  machineConfigPoolSelector:
    matchLabels:
      pools.operator.machineconfiguration.openshift.io/worker: "" <3>
----
+
--
<1> Specify the TLS security profile type. The default is `Intermediate`.
* `Old`
* `Intermediate`
* `Custom`
<2> For the `Custom` type, specify a list of TLS ciphers and minimum accepted TLS version.
<3> Specify the machine config pool label for the nodes you want to apply the TLS security profile.
--
+
[NOTE]
====
The `Modern` TLS profile is not supported for the kubelet.
====

. Create the `KubeletConfig` object:
+
[source,terminal]
----
$ oc create -f <file-name>
----

.Verification

// TODO: Update these to top-level steps?

. After the nodes are in the `Ready` state, verify that the profile is set on a node:
+
[source,terminal]
----
$ oc debug node/<node_name>
----
+
[source,terminal]
----
sh-4.4# chroot /host
----
+
[source,terminal]
----
sh-4.4# cat /etc/kubernetes/kubelet.conf
----
+
.Sample TLS ciphers and minimum version in the `kubelet.conf` file
[source,terminal]
----
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
 ...
  "tlsCipherSuites": [
    "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256",
    "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256",
    "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384",
    "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",
    "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256",
    "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256"
  ],
  "tlsMinVersion": "VersionTLS12",
 ...
----
