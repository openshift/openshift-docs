// Module included in the following assemblies:
//
// serverless/eventing/serverless-event-transformation.adoc

:_mod-docs-content-type: CONCEPT
[id="serverless-event-advanced-jsonata-features_{context}"]
= Advanced JSONata features

You can use JSONata to transform events more effectively by applying advanced features such as array processing and built-in functions.

[id="serverless-event-array-processing_{context}"]
== Array processing

JSONata makes it easy to work with arrays in event payloads. You can count items, filter them based on conditions, and calculate aggregate values.

.Example of processing items in an order and compute totals
[source,terminal]
----
{
  "specversion": "1.0",
  "id": id,
  "type": "order.processed",
  "source": source,
  "time": $now(),
  "itemcount": $count(order.items),
  "multiorder": $count(order.items) > 1,
  "data": {
    "order": order.id,
    "items": order.items[quantity > 1].{
      "product": name,
      "quantity": quantity,
      "lineTotal": price * quantity
    },
    "totalvalue": $sum(order.items.(price * quantity))
  }
}
----

Given this as an input:

[source,terminal]
----
{
  "id": "12345",
  "source": "https://example.com/orders",
  "order": {
    "id": "order-67890",
    "items": [
      { "name": "Laptop", "price": 1000, "quantity": 1 },
      { "name": "Mouse", "price": 50, "quantity": 2 },
      { "name": "Keyboard", "price": 80, "quantity": 3 }
    ]
  }
}
----

The transformation produces the following output:

[source,terminal]
----
{
  "specversion": "1.0",
  "id": "12345",
  "type": "order.processed",
  "source": "https://example.com/orders",
  "time": "2025-03-03T09:13:23.753Z",
  "itemcount": 3,
  "multiorder": true,
  "data": {
    "order": "order-67890",
    "items": [
      { "product": "Mouse", "quantity": 2, "lineTotal": 100 },
      { "product": "Keyboard", "quantity": 3, "lineTotal": 240 }
    ],
    "totalvalue": 1340
  }
}
----

In this example:

* `$count(order.items)` counts how many items are in the array.
* The filter `[quantity > 1]` selects only items with quantity greater than one.
* `$sum(order.items.(price * quantity))` calculates the total value.

[id="serverless-event-using-built-in-functions_{context}"]
== Using built-in functions

JSONata includes a wide range of built-in functions that can manipulate strings, numbers, dates, and arrays. These functions can enrich events with new fields derived from existing data.

.Example of adding metadata using built-in functions
[source,terminal]
----
{
  "specversion": "1.0",
  "id": id,
  "type": "user.event",
  "source": source,
  "time": time,
  "timestamp": $now(),
  "username": $lowercase(data.user.name),
  "initials": $join($map($split(data.user.name, " "), function($v) { $substring($v, 0, 1) }), ""),
  "data": $
}
----

In this example:

* `$now()` adds the current timestamp.
* `$lowercase()` converts the user name to lowercase.
* `$split()` breaks the name into parts, `$map()` extracts the first letter of each, and `$join()` combines them into initials.