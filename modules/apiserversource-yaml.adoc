// Module included in the following assemblies:
//
// serverless/event_workflows/serverless-listing-event-sources.adoc

[id="apiserversource-yaml_context"]
= Creating an API server source by using YAML files

This section describes the steps required to create an `ApiServerSource` object by using YAML files.

.Prerequisites

* You must have the {ServerlessOperatorName}, Knative Serving, and Knative Eventing installed in your {product-title} cluster. This can be installed by a cluster administrator.
* Event sources need a service to use as an event _sink_. The sink is the service or application that events are sent to from the event source.
* You must create or update a service account, role and role binding for the event source.
* You have created the `default` broker in the same namespace as the one defined in the `ApiServerSource` object.

.Procedure

. To create an API server source, create a YAML file and copy the following sample code into it:
+
[source,yaml]
----
apiVersion: sources.knative.dev/v1alpha1
kind: ApiServerSource
metadata:
  name: <source_name> <1>
spec:
  serviceAccountName: events-sa
  mode: Resource
  resources:
    - apiVersion: v1
      kind: Event
  sink:
    ref:
      apiVersion: eventing.knative.dev/v1
      kind: Broker
      name: default
----
<1> Add a name for your API server source.
. Apply the YAML file:
+
[source,terminal]
----
$ oc apply -f <filename>
----
. To check that the API server source is set up correctly, create a Knative service that dumps incoming messages to its log.
.. Copy the following sample code into a YAML file:
+
[source,yaml]
----
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: <service_name> <1>
  namespace: default
spec:
  template:
    spec:
      containers:
        - image: quay.io/openshift-knative/knative-eventing-sources-event-display:latest <2>
----
<1> Add a name for your service.
<2> You can use this sample image, or provide a container image of your own.
.. Apply the YAML file:
+
[source,terminal]
----
$ oc apply -f <filename>
----
. To create a trigger from the `default` broker that filters events to the service created in the previous step, create a YAML file and copy the following sample code into it:
+
[source,yaml]
----
apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: <trigger_name> <1>
  namespace: default
spec:
  broker: default
  subscriber:
    ref:
      apiVersion: serving.knative.dev/v1
      kind: Service
      name: <service_name>
----
<1> Add a name for your trigger.
<2> The name of the service you created earlier, that you want to connect the trigger to.
. Apply the YAML file:
+
[source,terminal]
----
$ oc apply -f <filename>
----
. To create events, launch a pod in the default namespace:
+
.Example command
[source,terminal]
----
$ oc create deployment hello-node --image=quay.io/openshift-knative/knative-eventing-sources-event-display
----
. To check that the controller is mapped correctly, enter the following command and inspect the output:
+
[source,terminal]
----
$ oc get apiserversource.sources.knative.dev testevents -o yaml
----
+
.Example output
[source,yaml]
----
apiVersion: sources.knative.dev/v1alpha1
kind: ApiServerSource
metadata:
  annotations:
  creationTimestamp: "2020-04-07T17:24:54Z"
  generation: 1
  name: testevents
  namespace: default
  resourceVersion: "62868"
  selfLink: /apis/sources.knative.dev/v1alpha1/namespaces/default/apiserversources/testevents2
  uid: 1603d863-bb06-4d1c-b371-f580b4db99fa
spec:
  mode: Resource
  resources:
  - apiVersion: v1
    controller: false
    controllerSelector:
      apiVersion: ""
      kind: ""
      name: ""
      uid: ""
    kind: Event
    labelSelector: {}
  serviceAccountName: events-sa
  sink:
    ref:
      apiVersion: eventing.knative.dev/v1
      kind: Broker
      name: default
----

.Verification steps

To verify that the Kubernetes events were sent to Knative, you can look at the message dumper function logs.

. Get the pods:
+
[source,terminal]
----
$ oc get pods
----
. View the message dumper function logs for the pods:
+
[source,terminal]
----
$ oc logs $(oc get pod -o name | grep event-display) -c user-container
----
+
.Example output
[source,terminal]
----
☁️  cloudevents.Event
Validation: valid
Context Attributes,
  specversion: 1.0
  type: dev.knative.apiserver.resource.update
  datacontenttype: application/json
  ...
Data,
  {
    "apiVersion": "v1",
    "involvedObject": {
      "apiVersion": "v1",
      "fieldPath": "spec.containers{hello-node}",
      "kind": "Pod",
      "name": "hello-node",
      "namespace": "default",
       .....
    },
    "kind": "Event",
    "message": "Started container",
    "metadata": {
      "name": "hello-node.159d7608e3a3572c",
      "namespace": "default",
      ....
    },
    "reason": "Started",
    ...
  }
----
