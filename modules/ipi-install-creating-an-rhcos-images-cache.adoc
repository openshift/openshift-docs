// Module included in the following assemblies:
//
// * list of assemblies where this module is included
// ipi-install-installation-process.adoc

:_content-type: PROCEDURE
[id="ipi-install-creating-an-rhcos-images-cache_{context}"]
= Creating an {op-system} images cache (optional)

To employ image caching, you must download two images: the {op-system-first} image used by the bootstrap VM and the {op-system} image used by the installer to provision the different nodes. Image caching is optional, but especially useful when running the installer on a network with limited bandwidth.

If you are running the installer on a network with limited bandwidth and the {op-system} images download takes more than 15 to 20 minutes, the installer will timeout. Caching images on a web server will help in such scenarios.

Install a container that contains the images.

.Procedure

. Install `podman`:
+
[source,terminal]
----
$ sudo dnf install -y podman
----

. Open firewall port `8080` to be used for {op-system} image caching:
+
[source,terminal]
----
$ sudo firewall-cmd --add-port=8080/tcp --zone=public --permanent
----
+
[source,terminal]
----
$ sudo firewall-cmd --reload
----


. Create a directory to store the `bootstraposimage` and `clusterosimage`:
+
[source,terminal]
----
$ mkdir /home/kni/rhcos_image_cache
----

. Set the appropriate SELinux context for the newly created directory:
+
[source,terminal]
----
$ sudo semanage fcontext -a -t httpd_sys_content_t "/home/kni/rhcos_image_cache(/.*)?"
----
+
[source,terminal]
----
$ sudo restorecon -Rv /home/kni/rhcos_image_cache/
----

. Get the URI for the {op-system} image that the installation program will deploy on the bootstrap VM:
+
[source,terminal]
----
$ export RHCOS_QEMU_URI=$(/usr/local/bin/openshift-baremetal-install coreos print-stream-json | jq -r --arg ARCH "$(arch)" '.architectures[$ARCH].artifacts.qemu.formats["qcow2.gz"].disk.location')
----

. Get the name of the image that the installation program will deploy on the bootstrap VM:
+
[source,terminal]
----
$ export export RHCOS_QEMU_NAME=${RHCOS_QEMU_URI##*/}
----

. Get the SHA hash for the {op-system} image that will be deployed on the nodes:
+
[source,terminal]
----
$ export RHCOS_QEMU_UNCOMPRESSED_SHA256=$(/usr/local/bin/openshift-baremetal-install coreos print-stream-json | jq -r --arg ARCH "$(arch)" '.architectures[$ARCH].artifacts.qemu.formats["qcow2.gz"].disk["uncompressed-sha256"]')
----

. Get the URI for the image that the installation program will deploy on the cluster nodes:
+
[source,terminal]
----
$ export RHCOS_OPENSTACK_URI=$(/usr/local/bin/openshift-baremetal-install coreos print-stream-json | jq -r --arg ARCH "$(arch)" '.architectures[$ARCH].artifacts.openstack.formats["qcow2.gz"].disk.location')
----

. Get the name of the image that the installation program will deploy on the cluster nodes:
+
[source,terminal]
----
$ export RHCOS_OPENSTACK_NAME=${RHCOS_OPENSTACK_URI##*/}
----

. Get the SHA hash for the image that the installation program will deploy on the cluster nodes:
+
[source,terminal]
----
$ export RHCOS_OPENSTACK_UNCOMPRESSED_SHA256=$(/usr/local/bin/openshift-baremetal-install coreos print-stream-json | jq -r --arg ARCH "$(arch)" '.architectures[$ARCH].artifacts.openstack.formats["qcow2.gz"].disk["uncompressed-sha256"]')
----

. Download the images and place them in the `/home/kni/rhcos_image_cache` directory:
+
[source,terminal]
----
$ curl -L ${RHCOS_QEMU_URI} -o /home/kni/rhcos_image_cache/${RHCOS_QEMU_NAME}
----
+
[source,terminal]
----
$ curl -L ${RHCOS_OPENSTACK_URI} -o /home/kni/rhcos_image_cache/${RHCOS_OPENSTACK_NAME}
----

. Confirm SELinux type is of `httpd_sys_content_t` for the newly created files:
+
[source,terminal]
----
$ ls -Z /home/kni/rhcos_image_cache
----

. Create the pod:
+
[source,terminal]
----
$ podman run -d --name rhcos_image_cache \
-v /home/kni/rhcos_image_cache:/var/www/html \
-p 8080:8080/tcp \
quay.io/centos7/httpd-24-centos7:latest
----
ifndef::upstream[]
+
The above command creates a caching webserver with the name `rhcos_image_cache`, which serves the images for deployment. The first image `${RHCOS_PATH}${RHCOS_QEMU_URI}?sha256=${RHCOS_QEMU_SHA_UNCOMPRESSED}` is the `bootstrapOSImage` and the second image `${RHCOS_PATH}${RHCOS_OPENSTACK_URI}?sha256=${RHCOS_OPENSTACK_SHA_COMPRESSED}` is the `clusterOSImage` in the `install-config.yaml` file.
endif::[]

. Generate the `bootstrapOSImage` and `clusterOSImage` configuration:
+
[source,terminal]
----
$ export BAREMETAL_IP=$(ip addr show dev baremetal | awk '/inet /{print $2}' | cut -d"/" -f1)
----
+
[source,terminal]
----
$ export BOOTSTRAP_OS_IMAGE="http://${BAREMETAL_IP}:8080/${RHCOS_QEMU_NAME}?sha256=${RHCOS_QEMU_UNCOMPRESSED_SHA256}"
----
+
[source,terminal]
----
$ export CLUSTER_OS_IMAGE="http://${BAREMETAL_IP}:8080/${RHCOS_OPENSTACK_NAME}?sha256=${RHCOS_OPENSTACK_UNCOMPRESSED_SHA256}"
----
+
[source,terminal]
----
$ echo "    bootstrapOSImage=${BOOTSTRAP_OS_IMAGE}"
----
+
[source,terminal]
----
$ echo "    clusterOSImage=${CLUSTER_OS_IMAGE}"
----

. Add the required configuration to the `install-config.yaml` file under `platform.baremetal`:
+
[source,terminal]
----
platform:
  baremetal:
    bootstrapOSImage: <bootstrap_os_image>  <1>
    clusterOSImage: <cluster_os_image>  <2>
----
<1> Replace `<bootstrap_os_image>` with the value of `$BOOTSTRAP_OS_IMAGE`.
<2> Replace `<cluster_os_image>` with the value of `$CLUSTER_OS_IMAGE`.
+
See the "Configuration files" section for additional details.
