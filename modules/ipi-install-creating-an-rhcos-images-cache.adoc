// Module included in the following assemblies:
//
// * list of assemblies where this module is included
// ipi-install-installation-process.adoc

:_content-type: PROCEDURE
[id="ipi-install-creating-an-rhcos-images-cache_{context}"]
= (Optional) Creating an {op-system} images cache

To employ image caching, you must download the {op-system-first} image used by the bootstrap VM to provision the different nodes. Image caching is optional, but especially useful when running the installation program on a network with limited bandwidth.

[NOTE]
====
The installation program no longer needs the `clusterOSImage` {op-system} image because the correct image is in the release payload.
====

If you are running the installation program on a network with limited bandwidth and the {op-system} images download takes more than 15 to 20 minutes, the installation program will timeout. Caching images on a web server will help in such scenarios.

Install a container that contains the images.

.Procedure

. Install `podman`:
+
[source,terminal]
----
$ sudo dnf install -y podman
----

. Open firewall port `8080` to be used for {op-system} image caching:
+
[source,terminal]
----
$ sudo firewall-cmd --add-port=8080/tcp --zone=public --permanent
----
+
[source,terminal]
----
$ sudo firewall-cmd --reload
----

. Create a directory to store the `bootstraposimage`:
+
[source,terminal]
----
$ mkdir /home/kni/rhcos_image_cache
----

. Set the appropriate SELinux context for the newly created directory:
+
[source,terminal]
----
$ sudo semanage fcontext -a -t httpd_sys_content_t "/home/kni/rhcos_image_cache(/.*)?"
----
+
[source,terminal]
----
$ sudo restorecon -Rv /home/kni/rhcos_image_cache/
----


. Get the commit ID from the installation program:
+
[source,terminal]
----
$ export COMMIT_ID=$(/usr/local/bin/openshift-baremetal-install version | grep '^built from commit' | awk '{print $4}')
----
+
The ID determines which image the installation program must download.

. Get the URI for the {op-system} image that the installation program will deploy on the bootstrap VM:
+
[source,terminal]
----
$ export RHCOS_QEMU_URI=$(curl -s -S https://raw.githubusercontent.com/openshift/installer/$COMMIT_ID/data/data/coreos/rhcos.json  | jq .images.qemu.path | sed 's/"//g')
----

. Get the path where the image is published:
+
[source,terminal]
----
$ export RHCOS_PATH=$(curl -s -S https://raw.githubusercontent.com/openshift/installer/$COMMIT_ID/data/data/coreos/rhcos.json | jq .baseURI | sed 's/"//g')
----

. Get the SHA hash for the {op-system} image that will be deployed on the bootstrap VM:
+
[source,terminal]
----
$ export RHCOS_QEMU_SHA_UNCOMPRESSED=$(curl -s -S https://raw.githubusercontent.com/openshift/installer/$COMMIT_ID/data/data/coreos/rhcos.json  | jq -r '.images.qemu["uncompressed-sha256"]')
----

. Download the image and place it in the `/home/kni/rhcos_image_cache` directory:
+
[source,terminal]
----
$ curl -L ${RHCOS_PATH}${RHCOS_QEMU_URI} -o /home/kni/rhcos_image_cache/${RHCOS_QEMU_URI}
----

. Confirm SELinux type is of `httpd_sys_content_t` for the new file:
+
[source,terminal]
----
$ ls -Z /home/kni/rhcos_image_cache
----

. Create the pod:
+
[source,terminal]
----
$ podman run -d --name rhcos_image_cache \ <1>
-v /home/kni/rhcos_image_cache:/var/www/html \
-p 8080:8080/tcp \
registry.centos.org/centos/httpd-24-centos7:latest
----
ifndef::upstream[]
+
<1> Creates a caching webserver with the name `rhcos_image_cache`. This pod serves the `bootstrapOSImage` image in the `install-config.yaml` file for deployment.   
endif::[]

. Generate the `bootstrapOSImage` configuration:
+
[source,terminal]
----
$ export BAREMETAL_IP=$(ip addr show dev baremetal | awk '/inet /{print $2}' | cut -d"/" -f1)
----
+
[source,terminal]
----
$ export RHCOS_QEMU_SHA256=$(zcat /home/kni/rhcos_image_cache/${RHCOS_QEMU_URI} | sha256sum | awk '{print $1}')
----
+
[source,terminal]
----
$ export BOOTSTRAP_OS_IMAGE="http://${BAREMETAL_IP}:8080/${RHCOS_QEMU_URI}?sha256=${RHCOS_QEMU_SHA256}"
----
+
[source,terminal]
----
$ echo "    bootstrapOSImage=${BOOTSTRAP_OS_IMAGE}"
----

. Add the required configuration to the `install-config.yaml` file under `platform.baremetal`:
+
[source,terminal]
----
platform:
  baremetal:
    bootstrapOSImage: http://<BAREMETAL_IP>:8080/<RHCOS_QEMU_URI>?sha256=<RHCOS_QEMU_SHA256>
----
+
See the "Configuration files" section for additional details.
