// Module included in the following assemblies:
//
// * service_mesh/v2x/ossm-security.adoc

:_content-type: PROCEDURE
[id="ossm-installing-ossm-operator-to-infrastructure-node_{context}"]
== Editing the OpenShift operator subscription to specify an infrastructure node

.Prerequisites

* The Service Mesh operator must be installed using the Operator hub.

.Procedure

. Edit the Subscription resource for the OpenShift Service Mesh operator to specify where the subscription should be installed.
+
[source,terminal]
----
$ oc -n openshift-operators edit subscription <servicemeshoperator>
----

. Add the nodeSelector and tolerations to .spec.config in the Subscription resource.
+
[source,yaml]
----
spec:
 config:
   nodeSelector:
     node-role.kubernetes.io/infra: "" <1>
   tolerations:
   - effect: NoSchedule
     key: node-role.kubernetes.io/infra <2>
     value: reserved
   - effect: NoExecute
     key: node-role.kubernetes.io/infra <3>
     value: reserved
----
<1> Specifies that the node only accepts pods with the `node-role.kubernetes.io/infra` label empty.
<2> Specifies that the node does not schedule pods that do not accept infrastructure nodes.
<3> Specifies that the node does not execute pods that do not accept infrastructure nodes.

. Mark one of the worker nodes as an infrastructure node.
+
[source,terminal]
----
$ oc label node <node-name> node-role.kubernetes.io/infra=
oc label node <node-name> node-role.kubernetes.io=infra
oc adm taint nodes -l node-role.kubernetes.io/infra node-role.kubernetes.io/infra=reserved:NoSchedule node-role.kubernetes.io/infra=reserved:NoExecute
----

. To run all control plane components, including Istiod, the ingress gateway, and the egress gateway, on an infrastructure node edit the name of the SMCP object.
+
[source,terminal]
----
$ oc -n istio-system edit smcp <name>
----

. Add the nodeSelector and tolerations to .spec.config in the Subscription resource.
+
[source,yaml]
----
spec:
  runtime:
    defaults:
      pod:
        nodeSelector:
          node-role.kubernetes.io/infra: "" <1>
        tolerations:
        - effect: NoSchedule
          key: node-role.kubernetes.io/infra <2>
          value: reserved
        - effect: NoExecute
          key: node-role.kubernetes.io/infra <3>
          value: reserved
----
<1> Specifies that the node only accepts pods with the `node-role.kubernetes.io/infra` label empty.
<2> Specifies that the node does not schedule pods that do not accept infrastructure nodes.
<3> Specifies that the node does not execute pods that do not accept infrastructure nodes.

. Run the Istiod component on an infrastructure node
+
[source,yaml]
----
spec:
  runtime:
    components:
      pilot:
        pod:
          nodeSelector:
            node-role.kubernetes.io/infra: ""
          tolerations:
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            value: reserved
          - effect: NoExecute
            key: node-role.kubernetes.io/infra
            value: reserved
----

. Run the ingress or egress gateway on infra nodes
+
[source,yaml]
----
spec:
  gateways:
    ingress:
      runtime:
        pod:
          nodeSelector:
            node-role.kubernetes.io/infra: ""
          tolerations:
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            value: reserved
          - effect: NoExecute
            key: node-role.kubernetes.io/infra
            value: reserved
----

. Run the egress or egress gateway on infra nodes
+
[source,yaml]
----
spec:
  gateways:
    egress:
      runtime:
        pod:
          nodeSelector:
            node-role.kubernetes.io/infra: ""
          tolerations:
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            value: reserved
          - effect: NoExecute
            key: node-role.kubernetes.io/infra
            value: reserved
----
