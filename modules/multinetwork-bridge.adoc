// admin_guide/multinetwork.adoc
ifdef::context[:parent-context: {context}]

[id='multinetwork-bridge-{context}']
= Configuring additional interfaces using bridges

[NOTE]
====
Please note that the bridge plugin, while packaged with OpenShift, is not officially supported. The following information is provided as it may be useful for test scenarios.
====

The bridge plugin attaches pods to a bridge device on the node. Pods with additional interfaces with the bridge plugin can only communicate over the bridge attached interfaces with other pods also connected to that bridge on the same node.

Firstly, create a custom resource with a bridge configuration, in this case we create one with the name `bridge-conf` which implemented the bridge plugin (note the `type` is set to `bridge`). In this case a bridge named `mynet0` will be created on the node.

[source,bash]
----
cat <<EOF | kubectl create -f -
| apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: bridge-conf
spec:
  config: '{
      "name": "bridge-conf",
      "type": "bridge",
      "bridge": "mynet0",
      "isDefaultGateway": true,
      "forceAddress": false,
      "ipMasq": true,
      "hairpinMode": true,
      "ipam": {
        "type": "host-local",
        "subnet": "10.10.0.0/16"
      }
    }'
EOF
----

In order to create pods on the same host, we'll label a node and use a nodeSelector in order to place pods on that node.

[source,bash]
----
oc label nodes {your-worker-node-name} bridgenode=true
oc get nodes --show-labels
----

Next we'll create two pods that use the bridge. The first pod:

[source,bash]
----
cat <<EOF | oc create -f -
| apiVersion: v1
kind: Pod
metadata:
  name: bridgepoda
  annotations:
    k8s.v1.cni.cncf.io/networks: bridge-conf
spec:
  containers:
** name: bridgepoda
    command: ["/bin/bash", "-c", "sleep 2000000000000"]
    image: centos/tools
  nodeSelector:
    bridgenode: "true"
EOF
----

And the second pod (note: only the pod name differs):

[source,bash]
----
cat <<EOF | oc create -f -
| apiVersion: v1
kind: Pod
metadata:
  name: bridgepodb
  annotations:
    k8s.v1.cni.cncf.io/networks: bridge-conf
spec:
  containers:
** name: bridgepoda
    command: ["/bin/bash", "-c", "sleep 2000000000000"]
    image: centos/tools
  nodeSelector:
    bridgenode: "true"
EOF
----

We can use the status annotations in order to determine the IP address of each pod.

We can use that information in order to ping from one pod b to pod a on the bridge interface.

[source,bash]
----
ip_bridge_a=$(oc get pod bridgepoda -o json | jq -r '.metadata.annotations["k8s.v1.cni.cncf.io/networks-status"] | fromjson | .[] | select(.name | contains ("bridge-conf")) | .ips[0]')
oc exec bridgepodb -- ping -c5 $ip_bridge_a
----
