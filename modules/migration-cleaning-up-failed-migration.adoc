// Module included in the following assemblies:
//
// * migrating_from_ocp_3_to_4/troubleshooting-3-4.adoc
// * migration-toolkit-for-containers/troubleshooting-mtc.adoc


[id="migration-cleaning-up-failed-migration_{context}"]
= Cleaning up a failed migration

.Prerequisites

* You must be logged in to the {product-title} cluster as a user with the `cluster-admin` role.
* You must have the OpenShift CLI installed.

.Procedure

.  Delete resources
+
If a direct volume migration (DVM) fails during Stage or Copy, some resources are preserved to allow debugging and need to be removed manually.
+
The following resources must be deleted:

* `Rsync` and `Stunnel` pods, both in the source and target namespaces
* Secret CRs and config maps, both in the source and target namespaces
* Route and services only in the target namespaces

. Unquiesce applications
+
If your application was quiesced during migration, you must unquiesce it by scaling it back to its initial replica count. The original replica count is indicated in a label that {mtc-short} adds to the `deployment` custom resource when an application is quiesced during migration:

+
----
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
 annotations:
    deployment.kubernetes.io/revision: "1"
    migration.openshift.io/preQuiesceReplicas: "1"
----
+
Scale your deployment back as follows:
+
----
$ oc scale deployment <deployment_name> --replicas=<desired_replicas>
----


. Delete the MTC Operator and cluster-scoped resources

+
NOTE: This procedure entirely removes Velero. Perform it only if there are no more Velero instances deployed on the cluster.

.. Delete the *Migration Controller* CR and its resources:
+
[source,terminal]
----
$ oc delete migrationcontroller <resource_name>
----
+
Wait for the {mtc-short} Operator to finish deleting the resources.

.. Uninstall the MTC Operator:

   ** OpenShift 4: Uninstall the Operator in the https://docs.openshift.com/container-platform/4.7/operators/admin/olm-deleting-operators-from-cluster.html#olm-deleting-operators-from-a-cluster-using-web-console_olm-deleting-operators-from-a-cluster[web console] or by running the following command:
+
[source,terminal]
----
$ oc delete ns openshift-migration
----

   ** OpenShift 3: Uninstall the operator by deleting it:
+
[source,terminal]
----
$ oc delete -f operator.yml
----

.. Delete the cluster-scoped resources:

   ** `Migration` custom resource definition:
+
----
$ oc delete $(oc get crds -o name | grep 'migration.openshift.io')
----
   ** `Velero` custom resource definition:
+
----
$ oc delete $(oc get crds -o name | grep 'velero')
----
   ** Migration cluster role:
+
----
$ oc delete $(oc get clusterroles -o name | grep 'migration.openshift.io')
----
   ** Migration-operator cluster role:
+
----
$ oc delete clusterrole migration-operator
----
   ** Velero cluster role:
+
----
$ oc delete $(oc get clusterroles -o name | grep 'velero')
----
   ** Migration cluster role bindings:
+
----
$ oc delete $(oc get clusterrolebindings -o name | grep 'migration.openshift.io')
----
   ** Migration-operator cluster role bindings:
+
----
$ oc delete clusterrolebindings migration-operator
----
   ** Velero cluster role bindings:
+
----
$ oc delete $(oc get clusterrolebindings -o name | grep 'velero')
----
