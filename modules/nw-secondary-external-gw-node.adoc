[id="nw-secondary-external-gw-node_{context}"]
= Configuring an external gateway for a node

As a cluster administrator, you can configure a node to use a secondary network interface for the external gateway.

.Prerequisites

* You are logged in to the cluster with a user with `cluster-admin` privileges.
* You have at least one machine in your cluster with a secondary Network Interface Controller (NIC) configured.

.Procedure

. Create a machine config pool:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfigPool
metadata:
  name: <worker_role>
spec:
  machineConfigSelector:
    matchExpressions:
    - key: machineconfiguration.openshift.io/role
      operator: In
      values:
      - worker
      - <worker_role>
  nodeSelector:
    matchLabels:
      node-role.kubernetes.io/<worker_role>: ""
----
+
--
where:

`<worker_role>`:: Specifies the name for this machine config pool, the match configuration for the machine config, and the node selector to apply to nodes that are part of the machine pool.
--

. Create a machine config for the machine config pool in the previous step:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  name: create-second-bridge
  labels:
    machineconfiguration.openshift.io/role: <worker_role>
spec:
  config:
    ignition:
      version: 3.2.0
      storage:
        files:
        - contents:
            source: data:text/plain;charset=utf-8,<interface>
          filesystem: root
          mode: 420
          path: /etc/ovnk/extra_bridge
----
+
--
where:

`<interface>`:: Specifies the name of the network device to use for the secondary external gateway. For example, if the interface name is `eno2` then the complete value is: `data:text/plain;charset=utf-8,eno2`.
`<worker_role>`:: Specifies the same value as you used in the previous step.
--

. To add a label to the node, enter the following command:
+
[source,terminal]
----
$ oc label node <node> node-role.kubernetes.io/<worker_role>=
----
+
--
where:

`<node>`:: Specifies the name of the node to apply the apply to.
`<worker_role>`:: Specifies the same value as you used in the previous step.
--

.Verification

You can verify that the secondary network external gateway is configured for your cluster by looking for the `br-ex1` bridge interface on a node.

. To access a node, enter the following command:
+
[source,terminal]
----
$ oc debug node/<node_name>
----
+
.Example output
[source,text]
----
Starting pod/cnfdt08examplecom-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.46.55.22
If you don't see a command prompt, try pressing enter.
----

. To access the host file system, enter the following command:
+
[source,terminal]
----
# chroot /host
----

. To display the `br-ex1` bridge, enter the following command:
+
[source,terminal]
----
# ip a show br-ex1
----
+
.Example output
[source,text]
----
12: br-ex: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 0c:42:a1:6c:af:7c brd ff:ff:ff:ff:ff:ff
    inet 10.46.55.22/24 brd 10.46.55.255 scope global dynamic noprefixroute br-ex
       valid_lft 30554sec preferred_lft 30554sec
    inet6 fe80::aed4:5ac0:fa9a:2c9b/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
----

. To confirm that the `br-ex1` bridge is part of the Open vSwitch (OVS)configuration, enter the following command:
+
[source,terminal]
----
# nmcli conn
----
+
.Example output
[source,text]
----
NAME              UUID                                  TYPE           DEVICE
ovs-if-br-ex      4a727543-6ea4-40ee-91c8-a2e70d3137a7  ovs-interface  br-ex
ovs-if-br-ex1     64c6e4c6-9b2b-473e-8ca4-de418567fd6e  ovs-interface  br-ex1
br-ex             cd3fdad1-67c0-4e29-b732-dd0aad820152  ovs-bridge     br-ex
br-ex1            deae697f-5dd6-4d37-8176-e45ad42e2b6c  ovs-bridge     br-ex1
ovs-if-phys0      716e81a9-2e24-414f-b04c-c7c6b9a8e4f5  ethernet       eno1
ovs-if-phys1      e7418b82-931b-47f5-9abf-cc28bd9d109d  ethernet       eno2
ovs-port-br-ex    941fc8c4-d4f2-4187-89d0-785506c2fbd0  ovs-port       br-ex
ovs-port-br-ex1   2f873db1-ed4d-4e01-8fa5-4ad287d0c389  ovs-port       br-ex1
ovs-port-phys0    4dc36b5b-5690-405f-a4cd-b95d9f0fa772  ovs-port       eno1
ovs-port-phys1    3034f602-9f0c-4856-94a7-4f6128798a46  ovs-port       eno2
Wired Connection  85446fbd-802b-4c7f-b501-86506c5eaf3b  ethernet       --
Wired Connection  18e51b16-9e1e-4503-8386-dce770ca49c5  ethernet       --
eno2              e82a18cf-080b-4c52-acae-faaa69458afe  ethernet       --
----
