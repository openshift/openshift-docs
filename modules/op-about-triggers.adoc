// This module is included in the following assemblies:
// * about/understanding-openshift-pipelines.adoc

:_mod-docs-content-type: CONCEPT
[id="about-triggers_{context}"]
= Triggers

[role="_abstract"]
You can use Triggers in conjunction with pipelines to create a comprehensive CI/CD system driven by Kubernetes resources. Triggers capture external events, such as Git pull requests, and process them to extract information, enabling you to automatically instantiate pipelines and deploy resources based on event data.

For example, you define a CI/CD workflow by using {pipelines-title} for your application. The pipeline must start for any new changes to take effect in the application repository. Triggers automate this process by capturing and processing any change event and by triggering a pipeline run that deploys the new image with the latest changes.

Triggers consist of the following main resources that work together to form a reusable, decoupled, and self-sustaining CI/CD system:

* The `TriggerBinding` resource extracts the fields from an event payload and stores them as parameters.
+
The following example shows a code snippet of the `TriggerBinding` resource, from which you extract the Git repository information from the received event payload:
+
[source,yaml]
----
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: vote-app
spec:
  params:
  - name: git-repo-url
    value: $(body.repository.url)
  - name: git-repo-name
    value: $(body.repository.name)
  - name: git-revision
    value: $(body.head_commit.id)
----

`apiVersion`:: The API version of the `TriggerBinding` resource. In this example, `v1beta1`.

`kind`:: Specifies the type of Kubernetes object. In this example, `TriggerBinding`.

`metadata.name`:: A unique name to identify the `TriggerBinding` resource.

`spec.params`:: The list of parameters extracted from the received event payload and passed to the `TriggerTemplate` resource. In this example, the `TriggerTemplate` extracts the Git repository URL, name, and revision from the body of the event payload.

* The `TriggerTemplate` resource acts as a standard for creating resources. It specifies how the parameterized data from the `TriggerBinding` resource defines the new resources. A trigger template receives input from the trigger binding, then performs a series of actions that results in the creation of new pipeline resources and the initiation of a new pipeline run.
+
The following example shows a code snippet of a `TriggerTemplate` resource, which creates a pipeline run by using the Git repository information received from the `TriggerBinding` resource you just created:
+
[source,yaml,subs="attributes+"]
----
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: vote-app
spec:
  params:
  - name: git-repo-url
    description: The git repository url
  - name: git-revision
    description: The git revision
    default: {pipelines-ver}
  - name: git-repo-name
    description: The name of the deployment to be created / patched

  resourcetemplates:
  - apiVersion: tekton.dev/v1
    kind: PipelineRun
    metadata:
      name: build-deploy-$(tt.params.git-repo-name)-$(uid)
    spec:
      taskRunTemplate:
        serviceAccountName: pipeline
      pipelineRef:
        name: build-and-deploy
      params:
      - name: deployment-name
        value: $(tt.params.git-repo-name)
      - name: git-url
        value: $(tt.params.git-repo-url)
      - name: git-revision
        value: $(tt.params.git-revision)
      - name: IMAGE
        value: image-registry.openshift-image-registry.svc:5000/pipelines-tutorial/$(tt.params.git-repo-name)
      workspaces:
      - name: shared-workspace
        volumeClaimTemplate:
         spec:
          accessModes:
           - ReadWriteOnce
          resources:
            requests:
              storage: 500Mi
----

`apiVersion`:: The API version of the `TriggerTemplate` resource. In this example, `v1beta1`.

`kind`:: Specifies the type of Kubernetes object. In this example, `TriggerTemplate`.

`metadata.name`:: Unique name to identify the `TriggerTemplate` resource.

`spec.params`:: Parameters supplied by the `TriggerBinding` resource.

`resourcetemplates`:: List of templates that specify how you create resources by using the parameters received through the `TriggerBinding` or `EventListener` resources.

* The `Trigger` resource combines the `TriggerBinding` and `TriggerTemplate` resources, and optionally, the `interceptors` event processor.
+
Interceptors process all the events for a specific platform that runs before the `TriggerBinding` resource. You can use interceptors to filter the payload, verify events, define and test trigger conditions, and implement other useful processing. Interceptors use secret for event verification. After the event data passes through an interceptor, it then goes to the trigger before you pass the payload data to the trigger binding. You can also use an interceptor to change the behavior of the associated trigger referenced in the `EventListener` specification.
//image::op-triggers.png[alt="Diagram showing the flow of an event through the EventListener, Interceptors, Trigger, TriggerBinding, and finally creating a PipelineRun by using the TriggerTemplate.", width="100%"] //It seems like this was removed. It's not in the image directory.
+
The following example shows a code snippet of a `Trigger` resource, named `vote-trigger` that connects the `TriggerBinding` and `TriggerTemplate` resources, and the `interceptors` event processor.
+
[source,yaml]
----
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: vote-trigger
spec:
  taskRunTemplate:
    serviceAccountName: pipeline
  interceptors:
    - ref:
        name: "github"
      params:
        - name: "secretRef"
          value:
            secretName: github-secret
            secretKey: secretToken
        - name: "eventTypes"
          value: ["push"]
  bindings:
    - ref: vote-app
  template:
     ref: vote-app
---
apiVersion: v1
kind: Secret
metadata:
  name: github-secret
type: Opaque
stringData:
  secretToken: "1234567"
----

`apiVersion`:: The API version of the `Trigger` resource. In this example, `v1beta1`.

`kind`:: Specifies the type of Kubernetes object. In this example, `Trigger`.

`metadata.name`:: A unique name to identify the `Trigger` resource.

`spec.taskRunTemplate.serviceAccountName`:: The service account name to use.

`interceptors.ref.name`:: Interceptor name to reference. In this example, `github`.

`interceptors.params`:: The required parameters to specify.

`bindings.ref`:: The name of the `TriggerBinding` resource to connect to the `TriggerTemplate` resource.

`template.ref`:: The name of the `TriggerTemplate` resource to connect to the `TriggerBinding` resource.

`kind`:: The Secret to use to verify events.

* The `EventListener` resource provides an endpoint, or an event sink, that listens for incoming HTTP-based events with a JSON payload. You extract event parameters from each `TriggerBinding` resource, and then process this data to create Kubernetes resources as specified by the corresponding `TriggerTemplate` resource. The `EventListener` resource also performs lightweight event processing or basic filtering on the payload by using event `interceptors`, which identify the type of payload and optionally change it. Currently, pipeline triggers support five types of interceptors: 

** Webhook Interceptors 
** GitHub Interceptors 
** GitLab Interceptors 
** Bitbucket Interceptors, and 
** Common Expression Language (CEL) Interceptors.
+
The following example shows an `EventListener` resource, which references the `Trigger` resource named `vote-trigger`.
+
[source,yaml]
----
apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: vote-app
spec:
  taskRunTemplate:
    serviceAccountName: pipeline
  triggers:
    - triggerRef: vote-trigger
----

`apiVersion`:: The API version of the `EventListener` resource. In this example, `v1beta1`.

`kind`:: Specifies the type of Kubernetes object. In this example, `EventListener`.

`metadata.name`:: A unique name to identify the `EventListener` resource.

`spec.taskRunTemplate.serviceAccountName`:: The service account name to use.

`spec.triggers.triggerRef`:: The name of the `Trigger` resource that the `EventListener` resource references.
