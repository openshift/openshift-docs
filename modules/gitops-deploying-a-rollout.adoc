// Module included in the following assemblies:
//
// * argo_rollouts/getting-started-with-argo-rollouts.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-deploying-a-rollout_{context}"]
= Deploying a rollout

[role="_abstract"]
As a cluster administrator, you can configure Argo Rollouts to progressively route a subset of user traffic to a new application version. Then you can test whether the application is deployed and working.

The following example procedure creates a `rollouts-demo` rollout and service. The rollout then routes 20% of traffic to a canary version of the application, waits for a manual promotion, and then performs multiple automated promotions until it routes the entire traffic to the new application version.

.Procedure 

. In the *Administrator* perspective of the web console, click *Operators* -> *Installed Operators* -> *{gitops-title}* -> *Rollout*.

. Create or select the project in which you want to create and configure a `Rollout` custom resource (CR) from the *Project* drop-down menu.

. Click *Create Rollout* and enter the following configuration in the YAML view:
+
[source,yaml]
----
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollouts-demo
spec:
  replicas: 5
  strategy:
    canary: #<1>        
      steps: #<2>
      - setWeight: 20 #<3>       
      - pause: {}  #<4>         
      - setWeight: 40 
      - pause: {duration: 45}  #<5>     
      - setWeight: 60
      - pause: {duration: 20}       
      - setWeight: 80
      - pause: {duration: 10}
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: rollouts-demo
  template: #<6>
    metadata:
      labels:
        app: rollouts-demo
    spec:
      containers:
      - name: rollouts-demo
        image: argoproj/rollouts-demo:blue
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        resources:
          requests:
            memory: 32Mi
            cpu: 5m
----
<1> The deployment strategy that the rollout must use.
<2> Specify the steps for the rollout. This example gradually routes 20%, 40%, 60%, and 80% of traffic to the canary version.
<3> The percentage of traffic that must be directed to the canary version. A value of 20 means that 20% of traffic is directed to the canary version.
<4> Specify to the Argo Rollouts controller to pause indefinitely until it finds a request for promotion.
<5> Specify to the Argo Rollouts controller to pause for a duration of 45 seconds. You can set the duration value in seconds (`s`), minutes (`m`), or hours (`h`). For example, you can specify `1h` for an hour. If no value is specified, the duration value defaults to seconds.
<6> Specifies the pods that are to be created.

. Click *Create*.
+
[NOTE]
====
To ensure that the rollout becomes available quickly on creation, the Argo Rollouts controller automatically treats the `argoproj/rollouts-demo:blue` initial container image specified in the `.spec.template.spec.containers.image` field as a stable version. In the initial instance, the creation of the `Rollout` resource routes all of the traffic towards the stable version of the application and skips the part where the traffic is sent to the canary version. However, for all subsequent application upgrades with the modifications to the `.spec.template.spec.containers.image` field, the Argo Rollouts controller performs the canary steps, as usual.
====

. Verify that your rollout was created correctly by running the following command:
+
[source,terminal]
----
$ oc argo rollouts list rollouts -n <namespace> <1>
----
<1> Specify the namespace where the `Rollout` resource is defined.
+
.Example output
[source,terminal]
----
NAME           STRATEGY   STATUS        STEP  SET-WEIGHT  READY  DESIRED  UP-TO-DATE  AVAILABLE
rollouts-demo  Canary     Healthy       8/8   100         5/5    5        5           5        
----

. Create the Kubernetes services that targets the `rollouts-demo` rollout.
.. In the *Administrator* perspective of the web console, click *Networking* -> *Services*.
.. Click *Create Service* and enter the following configuration in the YAML view:
+
[source,yaml]
----
apiVersion: v1
kind: Service
metadata:
  name: rollouts-demo
spec:
  ports: #<1>
  - port: 80
    targetPort: http
    protocol: TCP
    name: http

  selector: #<2>
    app: rollouts-demo
----
<1> Specifies the name of the port used by the application for running inside the container.
<2> Ensure that the contents of the `selector` field are the same as in the `Rollout` custom resource (CR).
.. Click *Create*.
+
Rollouts automatically update the created service with pod template hash of the canary `ReplicaSet`. For example, `rollouts-pod-template-hash: 687d76d795`.

. Watch the progression of your rollout by running the following command:
+
[source,terminal]
----
$ oc argo rollouts get rollout rollouts-demo --watch -n <namespace> <1>
----
<1> Specify the namespace where the `Rollout` resource is defined.
+
.Example output
[source,terminal]
----
Name:            rollouts-demo
Namespace:       spring-petclinic
Status:          ✔ Healthy
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Images:          argoproj/rollouts-demo:blue (stable)
Replicas:
  Desired:       5
  Current:       5
  Updated:       5
  Ready:         5
  Available:     5

NAME                                       KIND        STATUS     AGE    INFO
⟳ rollouts-demo                            Rollout     ✔ Healthy  4m50s  
└──# revision:1                                                          
   └──⧉ rollouts-demo-687d76d795           ReplicaSet  ✔ Healthy  4m50s  stable
      ├──□ rollouts-demo-687d76d795-75k57  Pod         ✔ Running  4m49s  ready:1/1
      ├──□ rollouts-demo-687d76d795-bv5zf  Pod         ✔ Running  4m49s  ready:1/1
      ├──□ rollouts-demo-687d76d795-jsxg8  Pod         ✔ Running  4m49s  ready:1/1
      ├──□ rollouts-demo-687d76d795-rsgtv  Pod         ✔ Running  4m49s  ready:1/1
      └──□ rollouts-demo-687d76d795-xrmrj  Pod         ✔ Running  4m49s  ready:1/1
----
+
After the rollout has been created, you can verify that the *Status* field of the rollout shows *Phase: Healthy*.

. In the *Rollout* tab, under the *Rollouts* section, verify that the *Status* field of the `rollouts-demo` rollout shows as *Phase: Healthy*.
+
[TIP]
====
Alternatively, you can verify that the rollout is healthy by running the following command:

[source,terminal]
----
$ oc argo rollouts status rollouts-demo -n <namespace> <1>
----
<1> Specify the namespace where the `Rollout` resource is defined.

.Example output
[source,terminal]
----
Healthy
----
====

You are now ready to perform a canary deployment, with the next update of the `Rollout` CR.
