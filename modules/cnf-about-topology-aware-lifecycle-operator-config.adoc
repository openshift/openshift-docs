// Module included in the following assemblies:
// Epic CNF-2600 (CNF-2133) (4.10), Story TELCODOCS-285
// * scalability_and_performance/cnf-topology-aware-lifecycle-operator.adoc

:_content-type: CONCEPT
[id="cnf-about-topology-aware-lifecycle-operator-config_{context}"]
= About the Topology Aware Lifecycle Operator configuration

The Topology Aware Lifecycle Operator manages the deployment of policies for one or more {product-title} clusters. The Operator allows you to control the following actions:
* The timing of the update
* The number of {rh-rhacm}-managed clusters
* The update order of the clusters

The Operator supports the orchestration of the following update scenarios:

* {product-title} y-stream and z-stream updates
* Day-two operations on y-stream and z-streams

The `ClusterGroupUpgrade` custom resource (CR) defines the remediation plan that you want to apply to a group of clusters based on the following specifications:

* Clusters in the group
* Blocking `ClusterGroupUpgrade` CRs
* Applicable list of managed policies
* Number of concurrent updates
* Applicable canary updates
* Pre- and post-update actions
* Update timing

The `ClusterGroupUpgrade` CR can be in the following states:

`UpgradeNotStarted`:: This is the initial state of the `ClusterGroupUpgrade` CR.
+
The Operator builds a remediation plan based on the following fields:
+
* The `clusterSelector` field specifies the labels of the clusters that you want to update.
* The `clusters` field specifies a list of clusters to update.
* The `canaries` fields specifies the clusters for canary updates.
* The `maxConcurrency` field specifies the number of clusters to update in a batch.
+
The `ClusterGroupUpgrade` CR transitions to the `UpgradeNotCompleted` state after the remediation plan is successfully completed and after the `enable` field is set to `true`. At this point, the Operator starts to update the `NonCompliant` clusters with the specified managed policies.
+
[NOTE]
====
You can only make changes to the `spec` fields if the `ClusterGroupUpgrade` CR is either in the `UpgradeNotStarted` or the `UpgradeCannotStart` state. 
====
+
.Sample CR
+
[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: cgu
  namespace: default
spec:
  clusters: <1>
  - spoke1
  - spoke2
  - spoke3
  enable: false
  managedPolicies: <2>
  - policy1-common-cluster-version-policy
  - policy2-common-pao-sub-policy
  - policy3-common-ptp-sub-policy
  remediationStrategy: <3>
    canaries: <4>
    - spoke1
    maxConcurrency: 2 <5>
    timeout: 240
status: <6>
  conditions:
  - message: The ClusterGroupUpgrade CR is not enabled
    reason: UpgradeNotStarted
    status: "False"
    type: Ready
----
<1> Defines the list of clusters to update.
<2> Lists the user-defined set of policies to remediate.
<3> Defines the specifics of the cluster updates.
<4> The remediation plan starts with the clusters listed in the `canaries` field. Each canary cluster forms a single-cluster batch.
<5> Defines the maximum number of concurrent updates in a batch. The number of remediation batches is the number of canary clusters, plus the number of clusters (except the canary clusters) divided by `maxConcurrency`. The clusters that are already compliant` with all the managed policies are excluded from the remediation plan.
<6> Displays information about the status of the updates.

`UpgradeNotCompleted`:: In this state, the Operator enforces the policies following the remediation plan defined in the `UpgradeNotStarted` state.
+
Enforcing the policies of subsequent batches starts immediately after all the clusters of the current batch are compliant with all the managed policies. If the batch times out, the Operator moves on to the next batch. The timeout value of a batch  is the `spec.timeout` field divided by the number of batches in the remediation plan.
+
[NOTE]
====
The managed policies are applied in the order they are listed in the `managedPolicies` field in the `ClusterGroupUpgrade` CR. One managed policy is applied at a time. After the specified clusters become compliant to the current policy, the next managed policy on the list will be applied.
====
+
The Operator transitions to the `UpgradeTimedOut` state in two cases:
+
* If the current batch is a canary type and the cluster in the batch does not change to compliant with all the managed policies.
* If the clusters are not compliant with the managed policies within the `timeout` value specified in `remediationStrategy`.

`UpgradeTimedOut`:: In this state, the Operator periodically checks if all the policies for the `ClusterGroupUpgrade` CR are compliant.
The periodic checks allow the updates to complete if the updates are prolonged due to network, CPU, or other issues. If the policies are compliant, the Operator transitions to the `UpgradeCompleted` state.

`UpgradeCompleted`:: In this state, the cluster updates are complete.
+
[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: cgu-upgrade-starts-complete
  namespace: default
spec:
  deleteObjects: true <1>
  clusters:
  - spoke1
  enable: false
  managedPolicies:
  - policy1-common-cluster-version-policy
  - policy2-common-pao-sub-policy
  remediationStrategy:
    maxConcurrency: 1
    timeout: 240
status:
  conditions:
  - message: The ClusterGroupUpgrade CR has all clusters already compliant with the specified managed policies
    reason: UpgradeCompleted
    status: "False"
    type: Ready
----
<1> The `deleteObjects` field is set to `true` by default. After the update, the Operator deletes the underlying {rh-rhacm} objects that were created during the update. The {rh-rhacm} Hub does not check for compliance after a successful update.