// Module included in the following assemblies:
//
// * osd_planning/gcp-ccs.adoc
:_mod-docs-content-type: PROCEDURE
[id="ccs-gcp-customer-procedure_{context}"]

= Required customer procedure

The Customer Cloud Subscription (CCS) model allows Red Hat to deploy and manage {product-title} into a customer's Google Cloud Platform (GCP) project. Red Hat requires several prerequisites to provide these services.
[NOTE]
====
The following requirements in this topic apply to {product-title} on {GCP} clusters created using both the service account and Workload Identity Federation authentication type. For additional requirements that apply to the service account authentication type only, see _Service account authentication type procedure_. For additional requirements that apply to the Workload Identity Federation authentication type only, see _Workload Identity Federation authentication type procedure_.
====

[WARNING]
====
To use {product-title} in your GCP project, the following GCP organizational policy constraints cannot be in place:

* `constraints/iam.allowedPolicyMemberDomains` (This policy constraint is supported only if Red Hat's `DIRECTORY_CUSTOMER_ID C02k0l5e8` is included in the allow list. Use this policy constraint with caution).
* `constraints/compute.restrictLoadBalancerCreationForTypes`
* `constraints/compute.requireShieldedVm` (This policy constraint is supported only if the cluster is installed with "Enable Secure Boot support for Shielded VMs" selected during the initial cluster creation).
* `constraints/compute.vmExternalIpAccess` (This policy constraint is supported only after installation).
====

.Procedure

. link:https://cloud.google.com/resource-manager/docs/creating-managing-projects[Create a Google Cloud project] to host the {product-title} cluster.

. link:https://cloud.google.com/service-usage/docs/enable-disable#enabling[Enable] the following required APIs in the project that hosts your {product-title} cluster:
+
.Required API services
[cols="2a,3a,3a",options="header"]

|===

|API service |Console service name |Purpose

|link:https://cloud.google.com/deployment-manager/docs/apis#google-cloud-deployment-manager-v2-api[Cloud Deployment Manager V2 API]
|`deploymentmanager.googleapis.com`
|Used for automated deployment and management of infrastructure resources.

|link:https://cloud.google.com/compute/docs/reference/rest/v1[Compute Engine API]
|`compute.googleapis.com`
|Used for creating and managing virtual machines, firewalls, networks, persistent disk volumes, and load balancers.

// |link:https://cloud.google.com/apis/docs/overview[Google Cloud APIs]
// |`cloudapis.googleapis.com`
// |

|link:https://cloud.google.com/resource-manager/reference/rest[Cloud Resource Manager API]
|`cloudresourcemanager.googleapis.com`
|Used for getting projects, getting or setting an IAM policy for projects, validating required permissions, and tagging.

|link:https://cloud.google.com/dns/docs/reference/rest/v1[Cloud DNS API]
|`dns.googleapis.com`
|Used for creating DNS zones and managing DNS records for the cluster domains.

// |link:https://cloud.google.com/firewall/docs/reference/network-security/rest[Network Security API]
// |`networksecurity.googleapis.com`
// |Purpose

|link:https://cloud.google.com/iam/docs/reference/credentials/rest[IAM Service Account Credentials API]
|`iamcredentials.googleapis.com`
|Used for creating short-lived credentials for impersonating IAM service accounts.

|link:https://cloud.google.com/iam/docs/reference/rest[Identity and Access Management (IAM) API]
|`iam.googleapis.com`
|Used for managing the IAM configuration for the cluster.

|link:https://cloud.google.com/service-infrastructure/docs/service-management/reference/rest[Service Management API]
|`servicemanagement.googleapis.com`
|Used indirectly to fetch quota information for GCP resources.

|link:https://cloud.google.com/service-usage/docs/reference/rest[Service Usage API]
|`serviceusage.googleapis.com`
|Used for determining what services are available in the customer’s Google Cloud account.

|link:https://cloud.google.com/storage/docs/json_api[Cloud Storage JSON API]
|`storage-api.googleapis.com`
|Used for accessing Cloud Storage for the image registry, ignition, and cluster backups (if applicable).

|link:https://cloud.google.com/storage/docs/apis[Cloud Storage]
|`storage-component.googleapis.com`
|Used for managing Cloud Storage for the image registry, ignition, and cluster backups (if applicable).

|link:https://cloud.google.com/resource-manager/docs/reference/orgpolicy/rest[Organization Policy API]
|`orgpolicy.googleapis.com`
|Used to identify governance rules applied to customer’s Google Cloud that might impact cluster creation or management.

|link:https://cloud.google.com/iap/docs/reference/rest[Cloud Identity-Aware Proxy API]
|`iap.googleapis.com` ^[*]^
|Used in emergency situations to troubleshoot cluster nodes that are otherwise inaccessible.

This API is required for clusters deployed with Private Service Connect.

|===


. To ensure that Red Hat can perform necessary actions, you must create an `osd-ccs-admin` IAM link:https://cloud.google.com/iam/docs/creating-managing-service-accounts#creating_a_service_account[service account] user within the GCP project.

+

The following roles must be link:https://cloud.google.com/iam/docs/granting-roles-to-service-accounts#granting_access_to_a_service_account_for_a_resource[granted to the service account]:
+
.Required roles
[cols="2a,3a",options="header"]

|===

|Role|Console role name

|Compute Admin
|`roles/compute.admin`

|DNS Administrator
|`roles/dns.admin`

|Organization Policy Viewer
|`roles/orgpolicy.policyViewer`

|Service Management Administrator
|`roles/servicemanagement.admin`

|Service Usage Admin
|`roles/serviceusage.serviceUsageAdmin`

|Storage Admin
|`roles/storage.admin`

|Compute Load Balancer Admin
|`roles/compute.loadBalancerAdmin`

|Role Viewer
|`roles/viewer`

|Role Administrator
|`roles/iam.roleAdmin`

|Security Admin
|`roles/iam.securityAdmin`

|Service Account Key Admin
|`roles/iam.serviceAccountKeyAdmin`

|Service Account Admin
|`roles/iam.serviceAccountAdmin`

|Service Account User
|`roles/iam.serviceAccountUser`

|IAP-Secured Tunnel User
|`roles/iap.tunnelResourceAccessor`^[*]^

|===

+
[.small]
--
*Required for clusters deployed with Private Service Connect.
--

. link:https://cloud.google.com/iam/docs/creating-managing-service-account-keys#creating_service_account_keys[Create the service account key] for the `osd-ccs-admin` IAM service account. Export the key to a file named `osServiceAccount.json`; this JSON file will be uploaded in {cluster-manager-first} when you create your cluster.