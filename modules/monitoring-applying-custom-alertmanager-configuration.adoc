// Module included in the following assemblies:
//
// * monitoring/configuring-monitoring-stack.adoc

[id='applying-custom-alertmanager-configuration-{context}']
= Applying custom Alertmanager configuration

You can overwrite the default Alertmanager configuration by editing the `alertmanager-main` secret inside the `openshift-monitoring` namespace. This procedure shows how to.

.Procedure

. Print the currently active Alertmanager configuration into file `alertmanager.yaml`:
// FIXME s/kubectl/oc/g ?
+
  $ kubectl -n openshift-monitoring get secret alertmanager-main -o=json | jq -r '.data["alertmanager.yaml"]' | base64 -d > alertmanager.yaml
+
. Change the configuration in file `alertmanager.yaml` to your new configuration:
+
[subs='quotes']
  global:
    resolve_timeout: 5m
  route:
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 12h
    receiver: default
    routes:
    - match:
        alertname: DeadMansSwitch
      repeat_interval: 5m
      receiver: deadmansswitch
    *- match:
        service: _your service_
      routes:
      - match:
          _your matching rules_
        receiver: _receiver_*
  receivers:
  - name: default
  - name: deadmansswitch
  *- name: _receiver_
    _receiver configuration_*
+
For example, this listing configures PagerDuty for notifications:
+
[subs='quotes']
----
  global:
    resolve_timeout: 5m
  route:
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 12h
    receiver: default
    routes:
    - match:
        alertname: DeadMansSwitch
      repeat_interval: 5m
      receiver: deadmansswitch
    *- match:
        service: example-app <1>
      routes:
      - match:
          severity: critical <2>
        receiver: team-frontend-page* <3>
  receivers:
  - name: default
  - name: deadmansswitch
  *- name: team-frontend-page <4>
    pagerduty_configs:
    - service_key: "_your-key_"*
----
<1> Specifies the service that fires the alerts.
<2> Specifies the severity of the alert.
<3> Specifies the receiver to use for the alert.
<4> Specifies the receiver configuration.
+
With this configuration, alerts of `critical` severity fired by the `example-app` service are sent using the `team-frontend-page` receiver, which means that these alerts are paged to a chosen person.
+
. Apply the new configuration in the file:
// FIXME s/kubectl/oc/g ?
+
  $ kubectl -n openshift-monitoring create secret generic alertmanager-main --from-literal=alertmanager.yaml="$(< alertmanager.yaml)" --dry-run -o=yaml | kubectl -n openshift-monitoring replace secret --filename=-

.Additional resources

* See link:https://www.pagerduty.com/[the PagerDuty official site] for more information on PagerDuty.
* See link:https://www.pagerduty.com/docs/guides/prometheus-integration-guide/[the PagerDuty Prometheus Integration Guide] to learn how to retrieve the `service_key`.
* See link:https://prometheus.io/docs/alerting/configuration/[Alertmanager configuration] for configuring alerting through different alert receivers.
