// CNF-950 4.7 Installing the operators
// Module included in the following assemblies:
//
// *cnf-provisioning-and-deploying-a-distributed-unit.adoc

[id="cnf-installing-the-operators_{context}"]
= Installing the operators

== Installing the Performance Addon Operator

Install the Performance Addon Operator using the OpenShift Container Platform CLI or the web console.

.Procedure

. Create the `operator-namespace.yaml` file:
+
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  labels:
    openshift.io/cluster-monitoring: "true"
  name: openshift-performance-addon-operator
spec: {}
----

. Create the `operator_catalogsource.yaml` file:
+
[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: performance-addon-operator
  namespace: openshift-marketplace
spec:
  displayName: Openshift Performance Addon Operator
  icon:
    base64data: ""
    mediatype: ""
  image: quay.io/openshift-kni/performance-addon-operator-index:4.7-snapshot
  publisher: Red Hat
  sourceType: grpc
----

. Create the `operator_operatorgroup.yaml` file:
+
[source,yaml]
----
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: performance-addon-operator
  namespace: openshift-performance-addon-operator
----

. Create the `operator_subscription.yaml` file:
+
[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: performance-addon-operator
  namespace: openshift-performance-addon-operator
spec:
  channel: "4.7"
  name: performance-addon-operator
  source: performance-addon-operator
  sourceNamespace: openshift-marketplace
----

. Configure the `kustomization.yaml` file:
+
[source,yaml]
----
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# TODO handle namespace with var

resources:
  - operator-namespace.yaml
  - operator_operatorgroup.yaml
  - operator_catalogsource.yaml
  - operator_subscription.yaml
----

== Installing the Precision Time Protocol (PTP) operator

Install the PTP Operator using the OpenShift Container Platform CLI or the web console.

.Procedure

. Create the `01_namespace.yaml` file:
+
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  name: openshift-ptp
  labels:
    openshift.io/run-level: "1"
    openshift.io/cluster-monitoring: "true"
----

. Create the `02_operator_group.yaml` file:
+
[source,yaml]
----
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: ptp-operators
  namespace: openshift-ptp
spec:
  targetNamespaces:
    - openshift-ptp
----

. Create the `03_subscription.yaml` file:
+
[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: ptp-operator-subscription
  namespace: openshift-ptp
spec:
  channel: "4.6"
  name: ptp-operator
  source: "redhat-operators"
  sourceNamespace: openshift-marketplace
----

. Configure the `kustomization.yaml` file:
+
[source,yaml]
----
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - 01_namespace.yaml
  - 02_operator_group.yaml
  - 03_subscription.yaml
----

== Applying the Stream Control Transmission Protocol (SCTP) patch

Load and enable the blacklisted SCTP kernel module on worker nodes in your cluster.

.Procedure

. Create the `is_ready.sh` executable file:
+
[source,yaml]
----
#!/bin/sh

# no output means that the new machine config wasn't picked by MCO yet
if [ -z "$(oc get mcp worker-cnf -o jsonpath='{.spec.configuration.source[?(@.name=="load-sctp-module")].name}')" ]; then
    exit 1
fi

oc wait mcp/worker-cnf --for condition=updated --timeout 1s
----

. Create the `sctp_module_mc.yaml` file:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker-cnf
  name: load-sctp-module
spec:
  config:
    ignition:
      version: 2.2.0
    storage:
      files:
        - contents:
            source: data:,
            verification: {}
          filesystem: root
          mode: 420
          path: /etc/modprobe.d/sctp-blacklist.conf
        - contents:
            source: data:text/plain;charset=utf-8,sctp
          filesystem: root
          mode: 420
          path: /etc/modules-load.d/sctp-load.conf
----

. Configure the `kustomization.yaml` file:
+
[source,yaml]
----
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - sctp_module_mc.yaml
----

== Installing the SR-IOV Network Operator

Install the SR-IOV Network Operator by using the OpenShift Container Platform CLI or the web console.

. Create the ` 01-sriov-namespace.yaml` file:
+
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  name: openshift-sriov-network-operator
  labels:
    openshift.io/run-level: "1"
----

. Create the `02-sriov-operatorgroup.yaml` file:
+
[source,yaml]
----
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: sriov-network-operators
  namespace: openshift-sriov-network-operator
spec:
  targetNamespaces:
  - openshift-sriov-network-operator
----

. Create the `03-sriov-subscription.yaml` file:
+
[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: sriov-network-operator-subscription
  namespace: openshift-sriov-network-operator
spec:
  channel: "4.6"
  name: sriov-network-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
----

. Configure the `kustomization.yaml` file:
+
[source,yaml]
----
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - 01-sriov-namespace.yaml
  - 02-sriov-operatorgroup.yaml
  - 03-sriov-subscription.yaml
----
