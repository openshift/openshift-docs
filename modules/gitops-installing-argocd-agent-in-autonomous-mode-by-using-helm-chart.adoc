// Module included in the following assembly:
//
// * argocd-agent-installation/gitops-installing-argocd-agent-in-autonomous-mode-by-using-helm-chart.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-installing-argocd-agent-in-autonomous-mode-by-using-helm-chart_{context}"]
= Installing the Argo CD Agent in autonomous mode by using a Helm chart

[role="_abstract"]
Use the Helm chart provided by the Argo CD Agent project to install the autonomous mode Agent component on the spoke (workload) cluster. In *autonomous* mode, the Agent must communicate with the spoke Redis server. However, the default network policy created by the {gitops-title} Operator does not allow this.

.Procedure

. To enable communication, you must create a custom network policy by using the following YAML configuration.
+
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: custom-agent-redis-network-policy
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: <ArgoCD Instance Name>-redis
  ingress:
    - ports:
        - protocol: TCP
          port: 6379
      from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: argocd-agent-agent
  policyTypes:
    - Ingress
----
+
where:

`<podSelector>`:: Selects the pods this policy applies to, for example, the Redis pod labeled `app.kubernetes.io/name: <ArgoCD Instance Name>-redis`.
`<ingress>`:: Defines the allowed inbound traffic rules for the selected pods.
`<policyTypes>`:: Indicates that this policy is an Ingress policy, meaning it only checks incoming connections.

. Apply the network policy by using the following command:
+
[source,terminal]
----
$ oc apply -f network-policy.yaml -n "<agent_namespace>" --context "<agent_context>"
----
+
where:

`agent_namespace`:: Specifies the namespace where the Agent instance is deployed. Use this value to specify the target namespace when you apply the network policy.
`agent_context`:: Specifies the context for the cluster that runs the Agent instance. Use this value to ensure that the command is executed on the correct cluster when multiple contexts are configured.

. Add the {OCP} Helm chart repository by running the following command:
+
[source,terminal]
----
$ helm repo add openshift-helm-charts https://charts.openshift.io/
----

. Install the autonomous Agent using Helm by using the following command:
+
[source,terminal]
----
$ helm install argocd-agent openshift-helm-charts/redhat-argocd-agent \
--version "<chart_version>" \
--set namespaceOverride=<agent_namespace> \
--set agentMode="autonomous" \
--set server="<principal_route_dns>" \
--set argoCdRedisSecretName="<argocd_name>-redis-initial-password" \
--set argoCdRedisPasswordKey="admin.password" \
--set redisAddress="<argocd_name>-redis:6379" \
--kube-context "<agent_context>"
----
+
where:

`chart_version`:: Specifies the version of the `redhat-argocd-agent` Helm chart that you want to install.
`agent_namespace`::  Defines the namespace where the Argo CD Agent component will be installed on the spoke cluster.
`agent_context`::  Defines the `kube-context` for the spoke cluster where the Agent is deployed.
`principal_route_dns`:: Specifies the hostname of the Principal service. Agents use this value to connect to the Principal's gRPC service. This should match the `.spec.host` value of the Principal's route, or `.status.loadBalancer.ingress.hostname` when the Principal service is of type `LoadBalancer`.
`argocd_name`:: Specifies the name of the Argo CD instance installed alongside the Agent. This value is used to construct Redis-related resource names.
`<argocd_name>-redis-initial-password`:: Defines the name of the Kubernetes secret that stores the initial Redis password for the Argo CD instance. 

. Create an `AppProject` in the agent namespace.
+
[source,yaml]
----
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: default
  namespace: <AGENT_NAMESPACE>
spec:
  clusterResourceWhitelist:
  - group: '*'
    kind: '*'
  destinations:
  - name: '*'
    namespace: '*'
    server: '*'
  sourceRepos:
  - '*'
----
+
For more information, see the _Additional Resources_ section, which includes the upstream documentation link on creating `AppProject` resources in Agents.