// Module included in the following assemblies:
//
// * operating/manage_security_policies/about-security-policies.adoc

:_mod-docs-content-type: CONCEPT
[id="policy-evaluation-engine_{context}"]
= Understanding the {product-title-short} policy evaluation engine

[role="_abstract"]

The {product-title-short} policy engine evaluates policies that you have created based on policy criteria. It operates differently in each of the build, deploy, and runtime stages.

Build stage::

--
{product-title-short} can evaluate policy rules upon request by using the `roxctl` CLI. When a policy is violated during the build stage, the violation text and error code let developers know what failed and how to fix it. You can configure the error code to fail the pipeline. During this stage, {product-title-short} can evaluate both standalone images and deployments against applicable policies. Violations from the build stage are not stored or routed using notifiers.
--

Deploy stage::

--
{product-title-short} uses deploy stage policies when inspecting workloads during a deployment attempt. These policies are composed of workload criteria, such as the following criteria:

* Container configuration, including environment variables and privileges
* Deployment metadata, such as required or disallowed annotations and labels
* Storage volume information, such as volume name and mount configuration
* Networking configuration, such as port exposure and ingress or egress policy
* Kubernetes access configuration, which consists of criteria such as service account configuration and Role-based Access Control (RBAC) permissions

You can also include image criteria, such as image registry, image content, and CVE data, when building deploy stage policies. This is helpful if you want to evaluate the same requirements in both pipeline builds and deployment attempts. This eliminates the need to duplicate policies, because you can create a policy that includes both image and workload criteria and use it for both the build and deploy stages.

{product-title-short} prevents Kubernetes or {ocp} from creating or updating workloads, for example, deployments, daemon sets or jobs, that match the conditions of the policy. This is useful for shutting down deployments with serious problems even if the build was successful.
--

Runtime stage::
--
{product-title-short} continuously evaluates deployments against applicable policies after a deployment is running. Runtime policies are used to monitor running pods within a Kubernetes cluster and report or prevent unauthorized workload activity, baseline deviations, or prohibited Kubernetes resource operations. {product-title-short} can monitor unsafe Kubernetes requests and selectively block them by using the API. F example, {product-title-short} can block attempted access to config maps or secrets.

Runtime policies can inspect the following two event sources:

* Deployment events: Real-time events such as running pods, process activity inside pods, deviations from networking or process baselines, or user-pod interaction such as port forwarding or port exec actions
* Audit log events: Logs that can be inspected for actions such as access to sensitive Kubernetes resources

Runtime policies can also include build and deploy stage criteria for the following reasons:

* These criteria can be used to identify high-risk situations combining runtime and workload/image criteria.
* These criteria can ensure that the build and deploy stage requirements are met during runtime, for example, when a new vulnerability is discovered, or a new requirement has been introduced.

Audit log policies are used to inspect the Kubernetes audit log for actions related to sensitive Kubernetes resources, such as secrets and `ClusterRoleBinding`. They have the following characteristics:

* Audit log policies are only composed of the audit log criteria.
* They are not associated with images or deployments. For this reason, audit log policies can only be associated with the runtime lifecycle stage.
* These policies are not enforceable, because the audited action has already occurred.
--

