// Module included in the following assemblies:

// * service-mesh-docs-main/install/ossm-istio-ambient-mode.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-installing-istio-ambient-mode_{context}"]
= Installing Istio ambient mode

You can install {istio} ambient mode on {ocp-product-title} 4.19 or later and {SMProductName} 3.1.0 or later with the required Gateway API custom resource definitions (CRDs).

.Prerequisites

* You have deployed a cluster on {ocp-product-title} 4.19 or later.
* You have installed the {SMProduct} Operator 3.1.0 or later in the {ocp-product-title} cluster.
* You are logged in to the {ocp-product-title} cluster either through the web console as a user with the `cluster-admin` role, or with the `oc login` command, depending on the installation method.
* You have configured the OVN-Kubernetes Container Network Interface (CNI) to use local gateway mode by setting the `routingViaHost` field as `true` in the `gatewayConfig` specification for the Cluster Network Operator. For more information, see "Configuring gateway mode".

.Procedure

. Install the {istio} control plane:

.. Create the `istio-system` namespace by running the following command:
+
[source,terminal]
----
$ oc create namespace istio-system
----

.. Create an `{istio}` resource named `istio.yaml` similar to the following example:
+
.Example configuration
[source,yaml]
----
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: default
spec:
  namespace: istio-system
  profile: ambient
  values:
    pilot:
      trustedZtunnelNamespace: ztunnel
----
+
[IMPORTANT]
====
You must set the `profile` field to `ambient`, and configure the `.spec.values.pilot.trustedZtunnelNamespace` value to match the namespace where the `ZTunnel` resource will be installed.
====

.. Apply the `{istio}` custom resource (CR) by running the following command:
+
[source,terminal]
----
$ oc apply -f istio.yaml
----

.. Wait for the {istio} control plane to contain the `Ready` status condition by running the following command:
+
[source,terminal]
----
$ oc wait --for=condition=Ready istios/default --timeout=3m
----

. Install the {istio} Container Network Interface (CNI):

.. Create the `istio-cni` namespace by running the following command:
+
[source,terminal]
----
$ oc create namespace istio-cni
----

.. Create the `IstioCNI` resource named `istio-cni.yaml` similar to the following example:
+
.Example configuration
[source,yaml]
----
apiVersion: sailoperator.io/v1
kind: IstioCNI
metadata:
  name: default
spec:
  namespace: istio-cni
  profile: ambient
  values:
    cni:
      ambient:
        reconcileIptablesOnStartup: true
----
+
Set the `spec.profile` field to `ambient` and `spec.values.cni.ambient.reconcileIptablesOnStartup` field to `true`. `reconcileIptablesOnStartup` field enables the `IstioCNI`` agent to detect and fix incompatible iptables rules in already-running ambient pods when the CNI agent starts up, handling scenarios like upgrades or rule drift.

.. Apply the `IstioCNI` CR by running the following command:
+
[source,terminal]
----
$ oc apply -f istio-cni.yaml
----

.. Wait for the `IstioCNI` pods to contain the `Ready` status condition by running the following command:
+
[source,terminal]
----
$ oc wait --for=condition=Ready istios/default --timeout=3m
----

. Install the Ztunnel proxy:

.. Create the `ztunnel` namespace for Ztunnel proxy by running the following command:
+
[source,terminal]
----
$ oc create namespace ztunnel
----
+
The namespace name for `ztunnel` project must match the `trustedZtunnelNamespace` parameter in {istio} configuration.

.. Create the `Ztunnel` resource named `ztunnel.yaml` similar to the following example:
+
.Example configuration
[source,yaml]
----
apiVersion: sailoperator.io/v1alpha1
kind: ZTunnel
metadata:
  name: default
spec:
  namespace: ztunnel
  profile: ambient
----

.. Apply the `Ztunnel` CR by running the following command:
+
[source,terminal]
----
$ oc apply -f ztunnel.yaml
----

.. Wait for the `Ztunnel` pods to contain the `Ready` status condition by running the following command:
+
[source,terminal]
----
$ oc wait --for=condition=Ready ztunnel/default --timeout=3m
----