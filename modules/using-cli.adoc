// Module included in the following assemblies:
//
// * cli/using-roxctl-cli.adoc
:_mod-docs-content-type: CONCEPT
[id="using-cli_{context}"]
= Using the roxctl CLI

Review the following sections to learn how to complete common tasks using the CLI.

[NOTE]
====

* Export the following variables before using these commands:
+
[source,terminal]
----
$ export ROX_API_TOKEN=<api_token>
----
+
[source,terminal]
----
$ export ROX_CENTRAL_ADDRESS=<address>:<port_number>
----

* You can use the `--help` option to get more information about the commands.

* In {product-title-managed}, when using `roxctl` commands that require the Central address, use the *Central instance address* as displayed in the *Instance Details* section of the {cloud-console}. For example, use `acs-ABCD12345.acs.rhcloud.com` instead of `acs-data-ABCD12345.acs.rhcloud.com`.
====

[id="manage-central-db_{context}"]
== Managing Central's database
Central stores information about:

* Activity observed in your clusters,
* Information retrieved from integrated image registries  or scanners, and
* {product-title} configuration.
//TODO Add links to registries and scanners

You can back up and restore Central's database by using the `roxctl` CLI.

=== Backing up Central database

Run the following command to back up Central's database:
[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" central backup
----

=== Restoring Central database

Run the following command to restore Central's database:
[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" central db restore <backup_filename>
----

[id="manage-secure-clusters_{context}"]
== Managing secured clusters

To secure a Kubernetes or an {ocp} cluster, you must deploy {product-title} services into the cluster.
You can generate deployment files in the {product-title-short} portal by selecting *Platform Configuration* -> *Clusters*, or you can use the `roxctl` CLI.

=== Generating Sensor deployment files

.Kubernetes

[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" sensor generate k8s --name <cluster_name> --central "$ROX_CENTRAL_ADDRESS"
----

.{ocp}

[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" sensor generate openshift --openshift-version <ocp-version> --name <cluster_name> --central "$ROX_CENTRAL_ADDRESS" <1>
----
<1> For the `--openshift-version` option specify the major {ocp} version number for your cluster. For example, specify `3` for {ocp} version `3.x` and specify `4` for {ocp} version `4.x`.

Read the `--help` output to see other options that you might need to use depending on your system architecture.

Verify that the endpoint you provide for `--central` can be reached from the cluster where you are deploying {product-title} services.

[NOTE]
====
If you are using a non-gRPC capable load balancer, such as HAProxy, AWS Application Load Balancer (ALB), or AWS Elastic Load Balancing (ELB):

* Use the WebSocket Secure (`wss`) protocol.
To use `wss`, prefix the address with *`wss://`*, and
* Add the port number after the address, for example:
+
[source,terminal]
----
$ roxctl sensor generate k8s --central wss://stackrox-central.example.com:443
----
====

=== Installing Sensor by using the generate YAML files
When you generate the Sensor deployment files, `roxctl` creates a directory called `sensor-<cluster_name>` in your working directory. The script to install Sensor is present in this directory. Run the sensor installation script to install Sensor.

[source,terminal]
----
$ ./sensor-<cluster_name>/sensor.sh
----

If you get a warning that you do not have the required permissions to install Sensor, follow the on-screen instructions, or contact your cluster administrator for help.

=== Downloading Sensor bundle for existing clusters

Use the following command to download Sensor bundles for existing clusters by specifying a cluster name or ID.

[source,terminal]
----
$ roxctl sensor get-bundle <cluster_name_or_id>
----

=== Deleting cluster integration

[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" cluster delete --name=<cluster_name>
----

[IMPORTANT]
====
Deleting cluster integration will not remove {product-title} services running in the cluster.
You can remove them by running the `delete-sensor.sh` script from the Sensor installation bundle.
====

[id="check-policy-compliance_{context}"]
== Checking policy compliance

You can use the `roxctl` CLI to check deployment YAML files and images for policy compliance.

=== Configuring output format
When you check policy compliance by using the `deployment check`, `image check`, or `image scan` commands, you can specify the output format by using the `-o` option. This option determines how the output of a command is displayed in the terminal.

You can change the output format by adding the `-o` option to the command and specifying the format as `json`, `table`, `csv`, or `junit`.

For example, the following command checks a deployment and then displays the result in `csv` format:
[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" \
  deployment check --file =<yaml_filename> \
  -o csv
----

[NOTE]
====
When you do not specify the `-o` option for the output format, the following default behavior is used:

* The format for the `deployment check` and the `image check` commands is `table`.
* The default output format for the `image scan` command is `json`. This is the old JSON format output for compatibility with older versions of the CLI. To get the output in the new JSON format, specify the option with format, as `-o json`.
====

Different options are available to configure the output. The following table lists the options and the format in which they are available.

[%header,cols="1,2,1"]
|===
|Option
|Description
|Formats

|`--compact-output`
|Use this option to display the JSON output in a compact format.
|`json`

|`--headers`
|Use this option to specify custom headers.
|`table` and `csv`

|`--no-header`
|Use this option to omit the header row from the output.
|`table` and `csv`

|`--row-jsonpath-expressions`
a|Use this option to specify link:https://github.com/tidwall/gjson[GJSON paths] to select specific items from the output. For example, to get the *Policy name* and *Severity* for a deployment check, use the following command:
[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" \
  deployment check --file=<yaml_filename> \
  -o table --headers POLICY-NAME,SEVERITY \
  --row-jsonpath-expressions="{results.#.violatedPolicies.#.name,results.#.violatedPolicies.#.severity}"
----
|`table` and `csv`

|`--merge-output`
|Use this options to merge table cells that have the same value.
|`table`

|`headers-as-comment`
|Use this option to include the header row as a comment in the output.
|`csv`

|`--junit-suite-name`
|Use this option to specify the name of the JUnit test suite.
|`junit`

|===

=== Checking deployment YAML files

The following command checks build-time and deploy-time violations of your security policies in YAML deployment files.
//TODO: Add link to security policies section
Use this command to validate:

* Configuration options in a YAML file, such as resource limits or privilege options;
or
* Aspects of the images used in a YAML file, such as components or vulnerabilities.

[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" deployment check --file=<yaml_filename>
----

=== Checking images

The following command checks build-time violations of your security policies in images.
//TODO: Add link to security policy section
[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" image check --image=<image_name>
----

=== Checking image scan results

You can also check the scan results for specific images.

The following command returns the components and vulnerabilities found in the image in JSON format.
The format is defined in the API reference.
//TODO: Add link to the API reference.

[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" image scan --image <image_name>
----

To cause {product-title} to re-pull image metadata and image scan results from the associated registry and scanner, add the `--force` option.

[NOTE]
====
To check specific image scan results, you must have a token with both `read` and `write` permissions for the `Image` resource.
The default *Continuous Integration* system role already has the required permissions.
//TODO: Add link to the system role topic.
====

[id="debug-issues_{context}"]
== Debugging issues

=== Managing Central log level

Central saves information to its container logs.

==== Viewing the logs
You can see the container logs for Central by running:

.Kubernetes
[source,terminal]
----
$ kubectl logs -n stackrox <central_pod>
----

.{ocp}
[source,terminal]
----
$ oc logs -n stackrox <central_pod>
----

==== Viewing current log level
You can change the log level to see more or less information in Central logs.
Run the following command to view the current log level:
[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" central debug log
----

==== Changing the log level
Run the following command to change the log level:

[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" central debug log --level=<log_level> <1>
----
<1> The acceptable values for `<log_level>` are `Panic`, `Fatal`, `Error`, `Warn`, `Info`, and `Debug`.

=== Retrieving debugging information

To gather debugging information for investigating issues, run the following command:

[source,terminal]
----
$ roxctl -e "$ROX_CENTRAL_ADDRESS" central debug dump
----
