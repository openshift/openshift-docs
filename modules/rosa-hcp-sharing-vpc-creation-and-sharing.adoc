// Module included in the following assemblies:
//
// * networking/rosa-hcp-shared-vpc-config.adoc

:_mod-docs-content-type: PROCEDURE
[id="rosa-hcp-sharing-vpc-creation-and-sharing_{context}"]
= Step One - VPC Owner: Configuring a VPC to share within your AWS organization

You can share subnets within a VPC with another AWS account in your AWS organization.

image::522-shared-vpc-step-1.png[]

.Procedure

. Create or modify a VPC to your specifications in the link:https://us-east-1.console.aws.amazon.com/vpc/[VPC section of the AWS console]. Make sure you have selected the correct region.
. Create the `Route 53 role`.
+
[NOTE]
====
You must create the `Route 53 role` in the same account where you plan to create the Amazon Route 53 hosted zones (which are created in Step 3). For example, if you want to create the hosted zones in the centrally-managed VPC account, you must create the `Route 53 role` in the *VPC Owner* account. If you want to create the hosted zones in the workload account, you must create the `Route 53 role` in the *Cluster Creator* account.
====
+
.. Create a custom trust policy file that grants permission to assume roles:
+
[source,terminal]
----
$ cat <<EOF > /tmp/route53-role.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::<Account-ID>:root"  <1>
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
EOF
----
+
--
<1> The trust policy principals may be scoped down to the ingress Operator role and installer account role rather than `root`.
--
+
.. Create the IAM role for the AWS managed policy link:https://docs.aws.amazon.com/rosa/latest/userguide/security-iam-awsmanpol.html#security-iam-awsmanpol-rosasharedvpcroute53policy[`ROSASharedVPCRoute53Policy`].
+
[source,terminal]
----
$ aws iam create-role --role-name <role_name> \  <1>
    --assume-role-policy-document file:///tmp/route53-role.json
----
+
--
<1> Replace _<role_name>_ with the name of the role you want to create.
--
+
.. Attach the AWS managed policy `ROSASharedVPCRoute53Policy` to allow for necessary shared VPC permissions.
+
[source,terminal]
----
$ aws iam attach-role-policy --role-name <role_name> \  <1> 
--policy-arn arn:aws:iam::aws:policy/ROSASharedVPCRoute53Policy
----
+
--
<1> Replace _<role_name>_ with the name of the role you created.
--
+
. Create the `VPC endpoint role`.
.. Create a custom trust policy file that grants permission to assume roles:
+
[source,terminal]
----
$ cat <<EOF > /tmp/shared-vpc-role.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::<Account-ID>:root"  <1>
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
EOF
----
+
--
<1> The trust policy principals may be scoped down to the ingress Operator role and installer account role rather than `root`.
--
+
.. Create the IAM role for the AWS managed policy link:https://docs.aws.amazon.com/rosa/latest/userguide/security-iam-awsmanpol.html#security-iam-awsmanpol-rosasharedvpcendpointpolicy[`ROSASharedVPCEndpointPolicy`]:
+
[source,terminal]
----
$ aws iam create-role --role-name <role_name> \  <1>
    --assume-role-policy-document file:///tmp/vpce-role.json
----
+
--
<1> Replace _<role_name>_ with the name of the role you want to create.
--
+
.. Attach the AWS managed policy `ROSASharedVPCEndpointPolicy` to allow for necessary shared VPC permissions.
+
[source,terminal]
----
$ aws iam attach-role-policy --role-name <role_name> \  <1> 
--policy-arn arn:aws:iam::aws:policy/ROSASharedVPCEndpointPolicy
----
+
--
<1> Replace _<role_name>_ with the name of the role you created.
--
+
. Provide the `Route 53 role` ARN and the `VPC endpoint role` ARN to the *Cluster Creator* to continue configuration.
