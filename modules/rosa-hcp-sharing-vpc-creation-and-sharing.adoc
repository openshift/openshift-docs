// Module included in the following assemblies:
//
// * networking/rosa-hcp-shared-vpc-config.adoc

:_mod-docs-content-type: PROCEDURE
[id="rosa-hcp-sharing-vpc-creation-and-sharing_{context}"]
= Step One - VPC Owner: Configuring a VPC to share within your AWS organization

You can share subnets within a VPC with another AWS account in your AWS organization.

image::522-shared-vpc-step-1.png[]
.Procedure

. Create or modify a VPC to your specifications in the link:https://us-east-1.console.aws.amazon.com/vpc/[VPC section of the AWS console]. Make sure you have selected the correct region.
+
. Create the `Route 53 role`.
+
[NOTE]
====
You must create the `Route 53 role` in the same account where you plan to create the Amazon Route 53 hosted zones (which are created in Step 3). For example, if you want to create the hosted zones in the centrally-managed VPC account, you must create the `Route 53 role` in the *VPC Owner* account. If you want to create the hosted zones in the workload account, you must create the `Route 53 role` in the *Cluster Creator* account.
====
+
.. Create a custom policy file to allow for necessary shared VPC permissions that uses the name `Route53Policy`:
+
[source,terminal]
----
$ cat <<EOF > /tmp/route53-policy.json
{
  "Version" : "2012-10-17",
  "Statement" : [
    {
      "Sid" : "ReadPermissions",
      "Effect" : "Allow",
      "Action" : [
        "elasticloadbalancing:DescribeLoadBalancers",
        "route53:GetHostedZone",
        "route53:ListResourceRecordSets",
	"route53:ListHostedZones",
        "tag:GetResources"
      ],
      "Resource" : "*"
    },
    {
      "Sid" : "ChangeResourceRecordSetsRestrictedRecordNames",
      "Effect" : "Allow",
      "Action" : [
        "route53:ChangeResourceRecordSets"
      ],
      "Resource" : [
        "*"
      ],
      "Condition" : {
        "ForAllValues:StringLike" : {
          "route53:ChangeResourceRecordSetsNormalizedRecordNames" : [
            "*.hypershift.local",
            "*.openshiftapps.com",
            "*.devshift.org",
            "*.openshiftusgov.com",
            "*.devshiftusgov.com"
          ]
        }
      }
    },
    {
      "Sid" : "ChangeTagsForResourceNoCondition",
      "Effect" : "Allow",
      "Action" : [
        "route53:ChangeTagsForResource"
      ],
      "Resource" : "*"
    }
  ]
}
EOF
----
+
.. Create the policy in AWS:
+
[source,terminal]
----
$ aws iam create-policy \
    --policy-name Route53Policy \
    --policy-document file:///tmp/route53-policy.json
----
+
.. Create a custom trust policy file that grants permission to assume roles:
+
[source,terminal]
----
$ cat <<EOF > /tmp/route53-role.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::<VPC-Owner-AWS-Account-ID>:root"  <1>
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
EOF
----
+
--
<1> During the initial creation of the principal, you must create a root user placeholder by using the *VPC Owner's* AWS account ID as `arn:aws:iam::{Account}:root`. This is only a temporary placeholder, and the principal is reduced in scope after the *Cluster Creator* creates the necessary cluster roles. 
--
+
.. Create the IAM role:
+
[source,terminal]
----
$ aws iam create-role --role-name <role_name> \  <1>
    --assume-role-policy-document file:///tmp/route53-role.json
----
+
--
<1> Replace _<role_name>_ with the name of the role you want to create.
--
+
.. Attach the custom `Route53Policy` permissions policy:
+
[source, terminal]
----
$ aws iam attach-role-policy --role-name <role_name> --policy-arn \  <1>
    arn:aws:iam::<VPC_Owner_AWS_Account_ID>:policy/Route53Policy  <2>
----
+
--
<1> Replace _<role_name>_ with the name of the role you created.
<2> Replace _<VPC_Owner_AWS_Account_ID>_ with the *VPC Owner's* AWS account ID.
--
+
. Create the `VPC endpoint role`.
.. Create a custom policy file to allow for necessary shared VPC permissions that uses the name `VPCEPolicy`:
+
[source,terminal]
----
$ cat <<EOF > /tmp/vpce.json
{
  "Version" : "2012-10-17",
  "Statement" : [
    {
      "Sid" : "ReadPermissions",
      "Effect" : "Allow",
      "Action" : [
        "ec2:DescribeVpcEndpoints",
        "ec2:DescribeVpcs",
        "ec2:DescribeSecurityGroups"
      ],
      "Resource" : "*"
    },
    {
      "Sid" : "CreateSecurityGroups",
      "Effect" : "Allow",
      "Action" : [
        "ec2:CreateSecurityGroup"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:security-group*/*"
      ],
      "Condition" : {
        "StringEquals" : {
          "aws:RequestTag/red-hat-managed" : "true"
        }
      }
    },
    {
      "Sid" : "DeleteSecurityGroup",
      "Effect" : "Allow",
      "Action" : [
        "ec2:DeleteSecurityGroup"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:security-group*/*"
      ],
      "Condition" : {
        "StringEquals" : {
          "aws:ResourceTag/red-hat-managed" : "true"
        }
      }
    },
    {
      "Sid" : "SecurityGroupIngressEgress",
      "Effect" : "Allow",
      "Action" : [
        "ec2:AuthorizeSecurityGroupIngress",
        "ec2:AuthorizeSecurityGroupEgress",
        "ec2:RevokeSecurityGroupIngress",
        "ec2:RevokeSecurityGroupEgress"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:security-group*/*"
      ],
      "Condition" : {
        "StringEquals" : {
          "aws:ResourceTag/red-hat-managed" : "true"
        }
      }
    },
    {
      "Sid" : "CreateSecurityGroupsVPCNoCondition",
      "Effect" : "Allow",
      "Action" : [
        "ec2:CreateSecurityGroup"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:vpc/*"
      ]
    },
    {
      "Sid" : "VPCEndpointWithCondition",
      "Effect" : "Allow",
      "Action" : [
        "ec2:CreateVpcEndpoint"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:vpc-endpoint/*"
      ],
      "Condition" : {
        "StringEquals" : {
          "aws:RequestTag/red-hat-managed" : "true"
        }
      }
    },
    {
      "Sid" : "VPCEndpointResourceTagCondition",
      "Effect" : "Allow",
      "Action" : [
        "ec2:CreateVpcEndpoint"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:security-group*/*"
      ],
      "Condition" : {
        "StringEquals" : {
          "aws:ResourceTag/red-hat-managed" : "true"
        }
      }
    },
    {
      "Sid" : "VPCEndpointNoCondition",
      "Effect" : "Allow",
      "Action" : [
        "ec2:CreateVpcEndpoint"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:vpc/*",
        "arn:aws:ec2:*:*:subnet/*",
        "arn:aws:ec2:*:*:route-table/*"
      ]
    },
    {
      "Sid" : "ManageVPCEndpointWithCondition",
      "Effect" : "Allow",
      "Action" : [
        "ec2:ModifyVpcEndpoint",
        "ec2:DeleteVpcEndpoints"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:vpc-endpoint/*"
      ],
      "Condition" : {
        "StringEquals" : {
          "aws:ResourceTag/red-hat-managed" : "true"
        }
      }
    },
    {
      "Sid" : "ModifyVPCEndpoingNoCondition",
      "Effect" : "Allow",
      "Action" : [
        "ec2:ModifyVpcEndpoint"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:subnet/*"
      ]
    },
    {
      "Sid" : "CreateTagsRestrictedActions",
      "Effect" : "Allow",
      "Action" : [
        "ec2:CreateTags"
      ],
      "Resource" : [
        "arn:aws:ec2:*:*:vpc-endpoint/*",
        "arn:aws:ec2:*:*:security-group/*"
      ],
      "Condition" : {
        "StringEquals" : {
          "ec2:CreateAction" : [
            "CreateVpcEndpoint",
            "CreateSecurityGroup"
          ]
        }
      }
    }
  ]
}
EOF
----
+
.. Create the policy in AWS:
+
[source,terminal]
----
$ aws iam create-policy \
    --policy-name VPCEPolicy \
    --policy-document file:///tmp/vpce-role.json
----
+
.. Create a custom trust policy file that grants permission to assume roles:
+
[source,terminal]
----
$ cat <<EOF > /tmp/vpce-role.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::<VPC-Owner-AWS-Account-ID>:root"  <1>
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
EOF
----
+
--
<1> During the initial creation of the principal, you must create a root user placeholder by using the *VPC Owner's* AWS account ID as `arn:aws:iam::{Account}:root`. This is only a temporary placeholder, and the principal is reduced in scope after the *Cluster Creator* creates the necessary cluster roles.
--
+
.. Create the IAM role:
+
[source,terminal]
----
$ aws iam create-role --role-name <role_name> \  <1>
    --assume-role-policy-document file:///tmp/vpce-role.json
----
+
--
<1> Replace _<role_name>_ with the name of the role you want to create.
--
+
.. Attach the custom `VPCEPolicy` permissions policy:
+
[source, terminal]
----
$ aws iam attach-role-policy --role-name <role_name> --policy-arn \  <1>
    arn:aws:iam::<VPC-Owner-AWS_Account_ID>:policy/VPCEPolicy  <2>
----
+
--
<1> Replace _<role_name>_ with the name of the role you created.
<2> Replace _<VPC_Owner_AWS_Account_ID>_ with the *VPC Owner's* AWS account ID.
--
+
. Provide the `Route 53 role` ARN and the `VPC endpoint role` ARN to the *Cluster Creator* to continue configuration.
