// Module included in the following assemblies:
//
// * service-mesh-docs-main/install/ossm-cert-manager.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-verifying-cert-manager_{context}"]
= Verifying Service Mesh with the cert-manager Operator using the istio-csr agent

You can use the sample `httpbin` service and `sleep` application to verify traffic between workloads. Check the workload proxy certificate to verify that the cert-manager Operator is installed correctly.

. Create the namespaces:

.. Create the `apps-1` namespace by running the following command:
+
[source, terminal]
----
$ oc new-project apps-1
----

.. Create the `apps-2` namespace by running the following command:
+
[source, terminal]
----
$ oc new-project apps-2
----

. Add the `istio-injection=enabled` label on the namespaces:

.. Add the `istio-injection=enabled` label on the `apps-1` namespace by running the following command:
+
[source, terminal]
----
$ oc label namespaces apps-1 istio-injection=enabled
----

.. Add the `istio-injection=enabled` label on the `apps-2` namespace by running the following command:
+
[source, terminal]
----
$ oc label namespaces apps-2 istio-injection=enabled
----

. Deploy the `httpbin` app in the namespaces:

.. Deploy the `httpbin` app in the `apps-1` namespace by running the following command:
+
[source, terminal]
----
$ oc apply -n apps-1 -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/httpbin/httpbin.yaml
----

.. Deploy the `httpbin` app in the `apps-2` namespace by running the following command:
+
[source, terminal]
----
$ oc apply -n apps-2 -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/httpbin/httpbin.yaml
----

. Deploy the `sleep` app in the namespaces:

.. Deploy the `sleep` app in the `apps-1` namespace by running the following command:
+
[source, terminal]
----
$ oc apply -n apps-1 -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/sleep/sleep.yaml
----

.. Deploy the `sleep` app in the `apps-2` namespace by running the following command:
+
[source, terminal]
----
$ oc apply -n apps-2 -f https://raw.githubusercontent.com/openshift-service-mesh/istio/release-1.24/samples/sleep/sleep.yaml
----

. Verify that the created apps have sidecars injected:

.. Verify that the created apps have sidecars injected for `apps-1` namespace by running the following command:
+
[source, terminal]
----
$ oc get pods -n apps-1
----

.. Verify that the created apps have sidecars injected for `apps-2` namespace by running the following command:
+
[source, terminal]
----
$ oc get pods -n apps-2
----

. Create a mesh-wide strict mutual Transport Layer Security (mTLS) policy similar to the following example:
+
[NOTE]
====
Enabling `PeerAuthentication` in strict mTLS mode verifies that certificates are distributed correctly and that mTLS communication functions between workloads.
====
+
.Example `peer_auth.yaml` file
[source, yaml]
----
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: istio-system
spec:
  mtls:
    mode: STRICT
----

. Apply the mTLS policy by running the following command:
+
[source, terminal]
----
$ oc apply -f peer_auth.yaml
----

. Verify that the `apps-1/sleep` app can access the `apps-2/httpbin` service by running the following command:
+
[source, terminal]
----
$ oc -n apps-1 exec "$(oc -n apps-1 get pod \
  -l app=sleep -o jsonpath={.items..metadata.name})" \
  -c sleep -- curl -sIL http://httpbin.apps-2.svc.cluster.local:8000
----
+
.Example output
+
[source, terminal]
----
HTTP/1.1 200 OK
access-control-allow-credentials: true
access-control-allow-origin: *
content-security-policy: default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' camo.githubusercontent.com
content-type: text/html; charset=utf-8
date: Wed, 18 Jun 2025 09:20:55 GMT
x-envoy-upstream-service-time: 14
server: envoy
transfer-encoding: chunked
----

. Verify that the `apps-2/sleep` app can access the `apps-1/httpbin` service by running the following command:
+
[source, terminal]
----
$ oc -n apps-2 exec "$(oc -n apps-1 get pod \
  -l app=sleep -o jsonpath={.items..metadata.name})" \
  -c sleep -- curl -sIL http://httpbin.apps-2.svc.cluster.local:8000
----
+
.Example output
+
[source, terminal]
----
HTTP/1.1 200 OK
access-control-allow-credentials: true
access-control-allow-origin: *
content-security-policy: default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' camo.githubusercontent.com
content-type: text/html; charset=utf-8
date: Wed, 18 Jun 2025 09:21:23 GMT
x-envoy-upstream-service-time: 16
server: envoy
transfer-encoding: chunked
----

. Verify that the `httpbin` workload certificate matches as expected by running the following command:
+
[source, terminal]
----
$ istioctl proxy-config secret -n apps-1 \
  $(oc get pods -n apps-1 -o jsonpath='{.items..metadata.name}' --selector app=httpbin) \
  -o json | jq -r '.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes' \
  | base64 --decode | openssl x509 -text -noout
----
+
.Example output
+
[source, terminal]
----
...
Issuer: O = cert-manager + O = cluster.local, CN = istio-ca
...
X509v3 Subject Alternative Name:
URI:spiffe://cluster.local/ns/apps-1/sa/httpbin
----