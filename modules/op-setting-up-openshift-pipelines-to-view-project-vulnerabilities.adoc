// This module is included in the following assemblies:
// * secure/setting-up-openshift-pipelines-to-view-software-supply-chain-security-elements.adoc

:_mod-docs-content-type: PROCEDURE
[id="op-setting-up-openshift-pipelines-to-view-project-vulnerabilities_{context}"]
= Setting up {pipelines-shortname} to view project vulnerabilities 

The PipelineRun details page provides a visual representation of identified vulnerabilities,  categorized by the severity (critical, high, medium, and low). This streamlined view facilitates prioritization and remediation efforts.

.Viewing vulnerabilities on the `PipelineRun` details page
image::vulnerabilities_details.png[]

You can also review the vulnerabilities in the *Vulnerabilities* column in the pipeline run list view page.

.Viewing vulnerabilities on the `PipelineRun` list view
image::vulnerabilities_list.png[]

[NOTE]
====
Visual representation of identified vulnerabilities is available starting from the {OCP} version 4.15 release.
====

.Prerequisites

* You have link:https://docs.openshift.com/container-platform/4.14/web_console/web-console.html#web-console[logged in to the web console].

* You have the appropriate link:https://docs.openshift.com/container-platform/4.14/authentication/using-rbac.html#default-roles_using-rbac[roles and permissions] in a project to create applications and other workloads in OpenShift Container Platform.

* You have an existing vulnerability scan task.

.Procedures

. In the *Developer* or *Administrator* perspective, switch to the relevant project where you want a visual representation of vulnerabilities.

. Update your existing vulnerability scan task to ensure that it stores the output in the .json file and then extracts the vulnerability summary in the following format:

+
[source,yaml]
----
# The format to extract vulnerability summary (adjust the jq command for different JSON structures).
jq -rce \ 
    '{vulnerabilities:{
      critical: (.result.summary.CRITICAL),
      high: (.result.summary.IMPORTANT),
      medium: (.result.summary.MODERATE),
      low: (.result.summary.LOW)
      }}' scan_output.json | tee $(results.SCAN_OUTPUT.path)

----
+
[NOTE]
====
You might need to adjust the link:https://jqlang.github.io/jq/download/[jq] command for different JSON structures.
====

.. (Optional) If you do not have a vulnerability scan task, create one in the following format:
+
*Example vulnerability scan task using Roxctl*
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: vulnerability-scan  # <1>
  annotations:
    task.output.location: results  # <2>
    task.results.format: application/json
    task.results.key: SCAN_OUTPUT  # <3>
spec:
  params:
    - description: Image to be scanned
      name: image
      type: string
  results:
    - description: CVE result format  # <4>
      name: SCAN_OUTPUT
  steps:
    - name: roxctl
      image: 'quay.io/lrangine/crda-maven:11.0'  # <5>
      env:
        - name: ROX_CENTRAL_ENDPOINT  
          valueFrom:
            secretKeyRef:
              key: rox_central_endpoint    # <6>        
              name: roxsecrets
        - name: ROX_API_TOKEN  
          valueFrom:
            secretKeyRef:
              key: rox_api_token   # <7>         
              name: roxsecrets
      
      name: roxctl-scan
      script: | # <8>
        #!/bin/sh
        curl -k -L -H "Authorization: Bearer $ROX_API_TOKEN" https://$ROX_CENTRAL_ENDPOINT/api/cli/download/roxctl-linux --output ./roxctl
        chmod +x ./roxctl 
        ./roxctl image scan --insecure-skip-tls-verify -e $ROX_CENTRAL_ENDPOINT --image $(params.image) --output json  > roxctl_output.json
        jq -rce \ 
        "{vulnerabilities:{
        critical: (.result.summary.CRITICAL),
        high: (.result.summary.IMPORTANT),
        medium: (.result.summary.MODERATE),
        low: (.result.summary.LOW)
        }}" roxctl_output.json | tee $(results.SCAN_OUTPUT.path)
----
<1> The name of your task.
<2> The location for storing the task outputs.
<3> The naming convention of the scan task result. A valid naming convention must end with the `SCAN_OUTPUT` string. For example, SCAN_OUTPUT, MY_CUSTOM_SCAN_OUTPUT, or ACS_SCAN_OUTPUT.
<4> The description of the result.
<5> The location of the container image to run the scan tool.
<6> The `rox_central_endpoint` key obtained from Advanced Cluster Security for Kubernetes (ACS).
<7> The `rox_api_token` obtained from ACS.
<8> The shell script performs the vulnerability scanning and sets the scan output in the Task run results.

+
[NOTE]
====
This is an example configuration. Modify the values according to your specific scanning tool to set results in the expected format.
====

. Update an appropriate Pipeline to add vulnerabilities specifications in the following format:

+
[source,yaml]
----
...
spec:
  results:
    - description: The common vulnerabilities and exposures (CVE) result
      name: SCAN_OUTPUT
      value: $(tasks.vulnerability-scan.results.SCAN_OUTPUT)
----

.Verification

* Navigate to the `PipelineRun` details page and review the *Vulnerabilities* row for a visual representation of identified vulnerabilities.

* Alternatively, you can navigate to the `PipelineRun` list view page, and review the *Vulnerabilities* column.

[role="_additional-resources"]
.Additional resources

* link:https://developers.redhat.com/products/trusted-application-pipeline/overview[Review Red{nbsp}Hat Trusted Application Pipeline (RHTAP) for a customizable end-to-end solution for building applications] 

* link:https://docs.redhat.com/en/documentation/red_hat_trusted_application_pipeline/1.0/html/getting_started_with_red_hat_trusted_application_pipeline/index[Getting Started with Red{nbsp}Hat Trusted Application Pipeline]