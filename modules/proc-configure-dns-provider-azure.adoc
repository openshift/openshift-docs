// Module included in the following assemblies:
//
// *install-guide/install-guide.adoc

:_mod-docs-content-type: PROCEDURE
[id="proc-configure-dns-provider-azure_{context}"]
= Configuring Azure DNS provider credentials

[role="_abstract"]
If you want to configure Microsoft Azure DNS policies in {prodname}, you must configure the DNS credentials.

[IMPORTANT]
====
* You must perform the steps on each {ocp} cluster that you want to use {prodname} on.
* You must configure the secret in the same namespace that includes your gateway.
* You must configure a DNS hosted zone. The credentials for your DNS provider must have permissions to update DNS records within this zone.
====
//admonition can be a snippet

.Prerequisites
//could also be a snippet
* You installed {prodname}.
* You have access to the namespace in which your gateway is to be created, for example, `api-gateway`.
+
[NOTE]
====
If you already know your environment variable values, you can set up the required `.yaml` files as required for your use case.
====
//there are no yamls in this procedure

.Procedure

. Create a new Azure service principal for managing DNS as follows:
+
[source,bash]
----
DNS_NEW_SP_NAME=kuadrantDnsPrincipal
DNS_SP=$(az ad sp create-for-rbac --name $DNS_NEW_SP_NAME)
DNS_SP_APP_ID=$(echo $DNS_SP | jq -r '.appId')
DNS_SP_PASSWORD=$(echo $DNS_SP | jq -r '.password')
----
+
For more details on service principals, see the https://learn.microsoft.com/en-us/entra/identity-platform/app-objects-and-service-principals?tabs=browser#service-principal-object[Microsoft Azure documentation].

. To grant read and contributor access to the zones that you want managed for the service principal you are using, perform the following steps:

.. Fetch the DNS ID used to grant access to the service principal as follows:
+
[source,bash]
----
$ DNS_ID=$(az network dns zone show --name example.com \
 --resource-group ExampleDNSResourceGroup --query "id" --output tsv)

# Get your resource group ID
$ RESOURCE_GROUP_ID=az group show --resource-group ExampleDNSResourceGroup | jq ".id" -r
----

.. Provide reader access to the resource group as follows:
+
[source,bash]
----
$ az role assignment create --role "Reader" --assignee $DNS_SP_APP_ID --scope $DNS_ID
----

.. Provide contributor access to the DNS zone as follows:
+
[source,bash]
----
$ az role assignment create --role "Contributor" --assignee $DNS_SP_APP_ID --scope $DNS_ID
----

. Because you are setting up advanced traffic rules for geographic and weighted responses, you must also grant traffic manager and DNS zone access as follows:
+
[source,bash]
----
$ az role assignment create --role "Traffic Manager Contributor" --assignee $DNS_SP_APP_ID --scope $RESOURCE_GROUP_ID

$ az role assignment create --role "DNS Zone Contributor" --assignee $DNS_SP_APP_ID --scope $RESOURCE_GROUP_ID

cat <<-EOF > /local/path/to/azure.json
{
  "tenantId": "$(az account show --query tenantId -o tsv)",
  "subscriptionId": "$(az account show --query id -o tsv)",
  "resourceGroup": "ExampleDNSResourceGroup",
  "aadClientId": "$DNS_SP_APP_ID",
  "aadClientSecret": "$DNS_SP_PASSWORD"
}
EOF
----

. Create a `Secret` resource for your credentials as follows:
+
[source,bash]
----
$ kubectl create secret generic test-azure-credentials \
  --namespace=api-gateway \
  --type=kuadrant.io/azure \
  --from-file=azure.json=/local/path/to/azure.json
----
+
Set the secret `type` to `azure`.
//still need kuadrant?