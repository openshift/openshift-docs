// Module included in the following assemblies:
//
// * rosa_getting_started_sts/rosa-sts-creating-cluster.adoc

[id="rosa-sts-creating-cluster_{context}"]
= Creating your cluster using STS

You can use the {product-title} CLI (`rosa`) to create an OpenShift cluster that uses the AWS security token service (STS).

[IMPORTANT]
====
Only public and AWS PrivateLink clusters are supported with STS. Private clusters that are not created with AWS Private link are not available for use with STS.
====

.Prerequisites

* You have completed the AWS prerequisites for ROSA with STS.
* You have the required AWS service quotas.
* You have enabled the ROSA service in the AWS Console.
* You have installed and configured the latest AWS, ROSA, and `oc` CLIs on your installation host.

[NOTE]
====
link:https://docs.aws.amazon.com/vpc/latest/userguide/vpc-sharing.html[AWS Shared VPCs] are not currently supported for ROSA installations.
====

.Procedure

. Create the required account-wide roles and policies, including Operator policies:
+
[source,terminal]
----
$ rosa create account-roles --version 4.8 --prefix ManagedOpenShift <1> <2>
----
<1> You must specify an OpenShift release by using the `--version` option.
<2> The `ManagedOpenShift` prefix is the default. If you specify a different prefix, you must reference it when declaring the Amazon Resource Names (ARNs) when you create the cluster.
+
You can select from the following modes in the interactive prompt:
+
* `auto`: The account roles and policies are created directly using the current AWS account.
* `manual`: The role and policy JSON files are saved in the current directory. The command output includes the `aws` CLI commands required to create the roles.
+
[NOTE]
====
Alternatively, you can specify the mode by using the `--mode auto -y` or `--mode manual` CLI arguments.
====

. Create a cluster by specifying the custom settings shown below or by using the interactive mode. To view other options when creating a cluster, enter `rosa create cluster --help`.
+
Creating a cluster can take up to 40 minutes.
+
[NOTE]
====
Multiple availability zones (Multi-AZ) are recommended for production workloads. The default is a single availability zone. Use `--help` for an example of how to set this option manually or use interactive mode to be prompted for this setting.
====
+
* To create a cluster with STS using custom settings:
+
[source,terminal]
----
$ rosa create cluster \
  --cluster-name ${name} \
  --region ${region} \
  --version ${version} \
  --role-arn arn:aws:iam::${aws_account_id}:role/ManagedOpenShift-Installer-Role \ <1>
  --support-role-arn arn:aws:iam::${aws_account_id}:role/ManagedOpenShift-Support-Role \
  --master-iam-role arn:aws:iam::${aws_account_id}:role/ManagedOpenShift-ControlPlane-Role \
  --worker-iam-role arn:aws:iam::${aws_account_id}:role/ManagedOpenShift-Worker-Role \
  --operator-roles-prefix ManagedOpenShift
----
<1> If you specified a custom prefix in the preceding command, you must replace the `ManagedOpenShift` prefix with the custom one in each ARN declaration.
+
.Example output
[source,terminal]
----
I: Creating cluster with identifier '<cluster_id>' and name '<cluster_name>'
I: To view list of clusters and their status, run `rosa list clusters`
I: Cluster '<cluster_name>' has been created.
I: Once the cluster is 'Ready' you will need to add an Identity Provider and define the list of cluster administrators. See `rosa create idp --help` and `rosa create user --help` for more information.
I: To determine when your cluster is Ready, run `rosa describe cluster <cluster_name>`.
----
+
[NOTE]
====
You can configure the following default network IP ranges:

* Machine CIDR: 10.0.0.0/16
* Service CIDR: 172.30.0.0/16
* Pod CIDR: 10.128.0.0/14

For the CIDR-related `rosa` CLI arguments, see `rosa create cluster --help | grep cidr`. In the interactive mode, you are prompted for the settings.
====

* To create a cluster with STS using interactive prompts:
+
[source,terminal]
----
$ rosa create cluster --interactive
----

. Create the cluster-specific Operator IAM roles. The roles created include the relevant prefix for the cluster name:
+
[source,terminal]
----
$ rosa create operator-roles --cluster <cluster_name|cluster_id> <1>
----
<1> Replace `<cluster_name|cluster_id>` with the cluster name or the ID of the cluster.
+
You can select from the following modes in the interactive prompt:
+
* `auto`: The Operator roles are created directly using the current AWS account.
* `manual`: The role JSON files are saved in the current directory. The command output includes the `aws` CLI commands required to create the roles.
+
[NOTE]
====
Alternatively, you can specify the mode by using the `--mode auto -y` or `--mode manual` CLI arguments.
====

. Create the OpenID Connect (OIDC) provider that the Operators will use to authenticate:
+
[source,terminal]
----
$ rosa create oidc-provider --cluster <cluster_name|cluster_id> <1>
----
<1> Replace `<cluster_name|cluster_id>` with the cluster name or the ID of the cluster.
+
You can select from the following modes in the interactive prompt:
+
* `auto`: The OIDC provider is created directly using the current AWS account.
* `manual`: The command output includes the `aws` CLI commands required to create the OIDC provider.
+
[NOTE]
====
Alternatively, you can specify the mode by using the `--mode auto -y` or `--mode manual` CLI arguments.
====

. Check the status of your cluster and retrieve your cluster ID. The `State` field changes from `pending` to `installing` to `ready`:
+
[source,terminal]
----
$ rosa describe cluster --cluster=<cluster_name|cluster_id> <1>
----
<1> Replace `<cluster_name|cluster_id>` with the cluster name or the ID of the cluster.
+
.Example output
[source,terminal]
----
Name:                       <cluster_name>
ID:                         <cluster_id>
External ID:                <external_id>
OpenShift Version:          <version>
Channel Group:              stable
DNS:                        *.openshiftapps.com
AWS Account:                123456789012
API URL:                    https://api.<cluster_name>.openshiftapps.com:6443
Console URL:                https://console-openshift-console.apps.<cluster_name>.openshiftapps.com
Region:                     <region>
Multi-AZ:                   false
Nodes:
 - Master:                  3
 - Infra:                   2
 - Compute:                 2
Network:
 - Service CIDR:            172.30.0.0/16
 - Machine CIDR:            10.0.0.0/16
 - Pod CIDR:                10.128.0.0/14
 - Host Prefix:             /23
State:                      pending (Waiting for OIDC configuration)
Private:                    No
Created:                    Jun 10 2021 15:47:56 UTC
Details Page:               https://cloud.redhat.com/openshift/details/s/<subscription_id>
OIDC Endpoint URL:          https://rh-oidc.s3.us-east-1.amazonaws.com/<cluster_id>
----
+
[NOTE]
====
If installation fails or the `State` field does not change to `ready` after 40 minutes, check the installation troubleshooting documentation for more details.
====

. Track the progress of the cluster creation by watching the OpenShift installer logs:
+
[source,terminal]
----
$ rosa logs install --cluster=<cluster_name|cluster_id> --watch <1>
----
<1> Replace `<cluster_name|cluster_id>` with the cluster name or the ID of the cluster.
