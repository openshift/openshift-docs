// This procedure is used in the following assembly:
// * gateways/ossm-getting-traffic-into-a-mesh.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-exposing-service-using-istio-gateway-and-virtualservice_{context}"]
= Exposing a service by using the {istio} Gateway and VirtualService resources

[role="_abstract"]
You can use the {istio} `Gateway` and `VirtualService` resources to configure a gateway that was deployed by using gateway injection. The resources expose a service in the mesh to traffic outside the mesh. You can set the gateway `Service` type to `LoadBalancer` to allow traffic from outside the cluster.

.Prerequisites

* You have installed {istio} gateways using gateway injection.

* You are using the {istio} `Gateway` and `VirtualService` resources.

* You have existing `VirtualService` configurations and do not plan on migrating to ambient mode.


.Procedure

. Create namespace called `httpbin` by running the following command:
+
[source,terminal]
----
$ oc create namespace httpbin
----

. Enable sidecar injection in the namespace. If you are using the `InPlace` upgrade strategy, run the following command:
+
[source,terminal]
----
$ oc label namespace httpbin istio-injection=enabled
----
+
[NOTE]
====
If you are using the `RevisionBased` upgrade strategy, run the following commands:

. To find your `<revision-name>`, run the following command:
+
[source, terminal]
----
$ oc get istiorevisions.sailoperator.io
----
You will get an output similar to the following example:
[source,terminal]
----
NAME      TYPE    READY   STATUS    IN USE   VERSION   AGE
default   Local   True    Healthy   True    v1.24.3   3m33s
----

. Label the namespace with the revision name to enable sidecar injection:
+
[source, terminal]
----
$ oc label namespace httpbin istio.io/rev=default
----
====

. Deploy a sample service named `httpbin` by running the following command:
+
[source,terminal]
----
$ oc apply -n httpbin -f https://raw.githubusercontent.com/openshift-service-mesh/istio/refs/heads/master/samples/httpbin/httpbin.yaml
----

. Create a YAML file named `httpbin-gw.yaml` that defines an {istio} `Gateway` resource. This resource configures gateway proxies to expose port 80 (HTTP) for the host, `httpbin.example.com`.
+
[source,yaml]
----
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: httpbin-gateway
  namespace: httpbin
spec:
  selector:
    istio: <gateway_name> <1>
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - httpbin.example.com <2>
----
<1> Set the `selector` to the unique label or set of labels specified in the pod template of the gateway proxy `Deployment`. By default, the {istio} `Gateway` resource configuration will apply to matching gateway pods in all namespaces.
<2> Using the `hosts` field, specify a list of addresses that can be used by clients when attempting to access a mesh service at the associated port.

. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f httpbin-gw.yaml
----

. Create a YAML file named `httpbin-vs.yaml` for a `VirtualService`. The `VirtualService` defines the rules that route traffic from the gateway proxy to the `httpbin` service.
+
[source,yaml]
----
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: httpbin
  namespace: httpbin
spec:
  hosts:
  - httpbin.example.com <1>
  gateways:
  - httpbin-gateway <2>
  http:
  - match:
    - uri:
        prefix: /status
    - uri:
        prefix: /headers
    route:
    - destination: <3>
        port:
          number: 8000
        host: httpbin
----
<1> Specify the `hosts` that the routing rules of the `VirtualService` will be applied to. The `hosts` specified must be exposed by the {istio} `Gateway` resource the VirtualService is bound to.
<2> Bind the `VirtualService` to the {istio} `Gateway` resource created in the previous step by adding the `Gateway` name to the list of gateways.
<3> Route matching traffic to the `httpbin` service deployed earlier by defining a `destination` that includes the `host` and `port` of the `httpbin` `Service`.

. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f httpbin-vs.yaml
----

. For verification purposes, create a namespace for a `curl` client by running the following command:
+
[source,terminal]
----
$ oc create namespace curl
----

. Deploy the `curl` client by running the following command:
+
[source,terminal]
----
$ oc apply -n curl -f https://raw.githubusercontent.com/openshift-service-mesh/istio/refs/heads/master/samples/curl/curl.yaml
----

. Set a `CURL_POD` variable with the name of the `curl` pod by running the following command:
+
[source,terminal]
----
$ CURL_POD=$(oc get pods -n curl -l app=curl -o jsonpath='{.items[*].metadata.name}')
----

. Using the `curl` client, send a request to the `/headers` endpoint of the `httpbin` application through the ingress gateway `Service` resource. Set the `Host` header of the request to `httpbin.example.com` to match the host that the {istio} `Gateway` and `VirtualService` resources specify. Run the following `curl` command to send the request:
+
[source,terminal]
----
$ oc exec $CURL_POD -n curl -- \
  curl -s -I \
    -H Host:httpbin.example.com \
    <gateway_name>.<gateway_namespace>.svc.cluster.local/headers
----

. The response should have a `200 OK HTTP` status indicating that the request was successful.
+
[source,terminal]
----
HTTP/1.1 200 OK
server: istio-envoy
...
----

. Send a curl request to an endpoint that does not have a corresponding URI prefix match defined in the `httpbin` `VirtualService` by running the following command:
+
[source,terminal]
----
$ oc exec $CURL_POD -n curl -- \
  curl -s -I \
    -H Host:httpbin.example.com \
    <gateway_name>.<gateway_namespace>.svc.cluster.local/get
----
+
The response should return a `404 Not Found` status. This is expected because the `/get` endpoint does not have a matching URI prefix in the `httpbin` `VirtualService` resource.
+
[source,terminal]
----
HTTP/1.1 404 Not Found
server: istio-envoy
...
----

. Expose the gateway proxy to traffic outside the cluster by setting the `Service` type to `LoadBalancer`:
+
[source,terminal]
----
$ oc patch service <gateway_name> -n <gateway_namespace> -p '{"spec": {"type": "LoadBalancer"}}'
----
+
[NOTE]
====
A gateway can also be exposed to traffic outside the cluster by using {ocp-short-name} Routes. For more information, see "Exposing a gateway to traffic outside the cluster using {ocp-short-name} Routes".
====

. Verify that `httpbin` service can be accessed from outside the cluster when using the external hostname or IP address of the gateway `Service` resource. Ensure that you set the `INGRESS_HOST` variable appropriately for the environment that your cluster is running in.

.. If the cluster runs on AWS, set the `INGRESS_HOST` variable by running the following command:
+
[source,terminal]
----
$ INGRESS_HOST=$(oc get service <gateway_name> -n <gateway_namespace> -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
----

.. If the cluster runs on GCP or Azure, set the `INGRESS_HOST` variable by running the following command:
+
[source,terminal]
----
$ INGRESS_HOST=$(oc get service <gateway_name> -n <gateway_namespace> -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
----

.. Send a `curl` request to the `httpbin` service using the host of the gateway by running the following command:
+
[source,terminal]
----
$ curl -s -I -H Host:httpbin.example.com http://$INGRESS_HOST/headers
----

. Verify that the response has the `HTTP/1.1 200 OK` status, which indicates that the request was successful.