// Module included in the following assemblies:
//
// * operators/operator_sdk/golang/osdk-golang-tutorial.adoc
// * operators/operator_sdk/ansible/osdk-ansible-tutorial.adoc
// * operators/operator_sdk/helm/osdk-helm-tutorial.adoc

ifeval::["{context}" == "osdk-golang-tutorial"]
:golang:
:app-proper: Memcached
:app: memcached
:group: cache
endif::[]
ifeval::["{context}" == "osdk-ansible-tutorial"]
:ansible:
:app-proper: Memcached
:app: memcached
:group: cache
endif::[]
ifeval::["{context}" == "osdk-helm-tutorial"]
:helm:
:app-proper: Nginx
:app: nginx
:group: demo
endif::[]

[id="osdk-run-proxy_{context}"]

= Running on a proxied cluster

You can configure your Operator to run on a proxied cluster.

.Prerequisites

* Example {app-proper} Operator installed on a cluster

.Procedure

ifdef::golang[]
. Add the `proxy.ReadProxyVarsFromEnv` helper function to the Reconcile loop in `controllers/memcached_controller.go`:
+
[source,golang,subs="attributes+"]
----
for i, container := range dep.Spec.Template.Spec.Containers {
		dep.Spec.Template.Spec.Containers[i].Env = append(container.Env, proxy.ReadProxyVarsFromEnv()...)
}
----
endif::[]

ifdef::ansible[]
. ??? Dear SME, what file is getting modified or added to? Thx ???:
+
[source,yaml,subs="attributes+"]
----
- name: start proxy-test job
  kubernetes.core.k8s:
    definition:
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: env-job
        namespace: "{{ ansible_operator_meta.namespace }}"
      spec:
        template:
          spec:
            containers:
              - name: curl-example
                image: registry.access.redhat.com/ubi8/ubi:8.4-209
                command: ["curl"]
                args: ["http://example.com/job-request"]
                env:
                  - name: HTTP_PROXY
                    value: '{{ lookup("env", "HTTP_PROXY") | default("", True) }}'
                  - name: http_proxy
                    value: '{{ lookup("env", "HTTP_PROXY") | default("", True) }}'
            restartPolicy: Never
        backoffLimit: 4
----

endif::[]

ifdef::helm[]
. Add the `proxy.http` variable in `helmcharts/nginx/Values.yaml`:
+
[source,yaml,subs="attributes+"]
----
proxy:
  http: ""
  https: ""
  no_proxy: ""
----

. Edit the chart template at `helm-charts/nginx/templates/deployment.yaml` to contain the following specification:
+
[source,yaml,subs="attributes+"]
----
containers:
  - name: {{ .Chart.Name }}
    securityContext:
      {{- toYaml .Values.securityContext | nindent 12 }}
    image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
    imagePullPolicy: {{ .Values.image.pullPolicy }}
    env:
      - name: http_proxy
        value: "{{ .Values.proxy.http }}"
----

. Modify `watches.yaml` to override `proxy.http`:
+
[source,yaml,subs="attributes+"]
----
- group: demo.example.com
  version: v1alpha1
  kind: Nginx
  chart: helm-charts/nginx
  overrideValues:
    proxy.http: $HTTP_PROXY
#+kubebuilder:scaffold:watch
----

endif::[]

. Set the environment variable on the Operator deployment in `config/manager/manager.yaml`:
+
[source,yaml,subs="attributes+"]
----
containers:
 args:
   --leader-elect
   --leader-election-id={app}-proxy-demo
 image: controller:latest
 name: manager
 env:
     name: "HTTP_PROXY"
     value: "http_proxy_test"
----


ifeval::["{context}" == "osdk-golang-tutorial"]
:!golang:
:!app-proper:
:!app:
:!group:
endif::[]
ifeval::["{context}" == "osdk-ansible-tutorial"]
:!ansible:
:!app-proper:
:!app:
:!group:
endif::[]
ifeval::["{context}" == "osdk-helm-tutorial"]
:!helm:
:!app-proper:
:!app:
:!group:
endif::[]
