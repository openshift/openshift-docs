// Module is included in the following assemblies:
//
// * securing_openshift_gitops/managing-secrets-securely-using-sscsid-with-gitops.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-configuring-gitops-managed-resources-to-use-vault-mounted-secrets_{context}"]
= Configuring GitOps managed resources to use Vault-mounted secrets

[role="_abstract"]
Securely inject secrets from HashiCorp Vault into GitOps-managed Kubernetes workloads using the Secrets Store CSI driver and Vault provider. The secrets are mounted as files in the pod's filesystem, allowing applications to access the data without storing it in Kubernetes Secret objects.

.Procedure

. Creating the `SecretProviderClass`.

.. Create a `SecretProviderClass` resource in the application's manifest directory for example, `environments/dev/apps/demo-app/manifest/secretProviderClass.yaml`. This resource defines how the Secrets Store CSI driver retrieves secrets from Vault.
+
.Example `vault-secret-provider-app.yaml` file
[source,yaml]
----
apiVersion: secrets-store.csi.x-k8s.io/v1
  kind: SecretProviderClass
     metadata:
         name: demo-app-creds
         namespace: demo-app
 spec:
        provider: vault #<1>
        parameters:
              vaultAddress: http://vault.vault-csi-provider:8200 # <name>.<namespace>:port #<2>
              roleName: app #<3>
        objects: | #<4>
           - objectName: "demoAppUsername"
             secretPath: "secret/demo/config"
             secretKey: "username"
          - objectName: "demoAppPassword"
            secretPath: "secret/demo/config"
             secretKey: "password"
----
<1> `<provider: vault>` - Specifies the name of the HashiCorp Vault.
<2> `<vaultAddress>` - Specifies the network address of the Vault server. Adjust this based on your Vault setup, such as, in-cluster service or an external URL.
<3> `<roleName>` - Specifies the Vault Kubernetes authentication role used by the application Service Account.
Describes an array that defines which secrets to retrieve and how to map them to file names.
<4> `<objects>` - Specifies an array that defines which secrets to retrieve and how to map them to file names. The `secretPath` for KV v2 includes `/data/`.

. Create an Application, such as, `ServiceAccount`.

.. Create a Kubernetes `ServiceAccount` for the application workload. The `ServiceAccount` name must match the `bound_service_account_names` value defined in the Vault Kubernetes authentication role. Store the manifest in the GitOps repository, for example, `environments/dev/apps/demo-app/manifest/serviceAccount.yaml`.
+
.Example `ServiceAccount.yaml` file
[source,yaml]
----
apiVersion: v1
kind: ServiceAccount
metadata:
  name: demo-app-sa
  namespace: demo-app
----

. Create the Application deployment:

.. Modify the application's deployment to use the designated `ServiceAccount` and mount secrets using the CSI volume. Store the updated manifest in the GitOps repository, for example, `environments/dev/apps/demo-app/manifest/deployment.yaml`:
+
.Example `deployment.yaml` file
[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
   name: app
   namespace: demo-app
   labels:
     app: demo
spec:
   replicas: 1
   selector:
     matchLabels:
        app: demo
   template:
      metadata:
       labels:
         app: demo
   spec:
        serviceAccountName: demo-app-sa # <1>
        containers:
           - name: app
             image: nginxinc/nginx-unprivileged:latest
             volumeMounts: # <2>
             - name: vault-secrets
               mountPath: /mnt/secrets-store
               readOnly: true
   volumes: # <3>
        - name: vault-secrets
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
            secretProviderClass: demo-app-creds
----
<1> `serviceAccountName` - Assigns the Kubernetes `ServiceAccount` name, for example, `demo-app-sa`, used by the application pod. This `ServiceAccount` is fundamental for authenticating with HashiCorp Vault, as it is linked to a Vault role that grants permissions to retrieve the necessary secrets.
<2> `volumeMounts` - Mounts the vault-secrets volume into the container at the `/mnt/secrets-store` directory.
<3> `volumes` - Defines the vault-secrets volume using the `secrets-store.csi.k8s.io` driver and references the `demo-app-creds` `SecretProviderClass`.

. Define the Argo CD application for the workload:

.. Define an Argo CD application resource to deploy application components such as `ServiceAccount`, `SecretProviderClass`, and `Deployment` from the GitOps repository. Store the Argo CD manifest in a directory location, such as, `environments/dev/apps/demo-app/argocd/demo-app.yaml`.
+
.Example `demo-app.yaml` file
[source,yaml]
----
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: demo-app
  namespace: openshift-gitops
spec:
  project: default
  source:
    repoURL: https://your-git-repo-url.git
    targetRevision: HEAD
    path: environments/dev/apps/demo-app/manifest
  destination:
    server: https://kubernetes.default.svc
    namespace: demo-app
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
----