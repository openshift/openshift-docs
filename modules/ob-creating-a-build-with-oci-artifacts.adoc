// This module is included in the following assembly:
//
// * work-with-builds/using-builds.adoc

:_mod-docs-content-type: PROCEDURE
[id="ob-creating-a-build-with-OCI-artifacts_{context}"]
= Creating a build with OCI artifacts

[role="_abstract"]
Use Open Container Initiative (OCI) artifacts, also called scratch images, that you store in a registry as source code to build a container image. Pull and extract them to use as the source for your build; they contain only source code, not a runnable container.

.Prerequisites

* You have installed the {builds-operator} on the {ocp-product-title} cluster.
* You have installed the `oc` command-line interface (CLI).
* You have installed the link:https://console.redhat.com/openshift/downloads[`shp` CLI].

.Procedure

. Create a `Build` resource and apply it to the {ocp-product-title} cluster. See the following example configuration:
+
[source,yaml]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: Build
metadata:
  name: <build_resource_name>
spec:
  source:
    type: OCI
    ociArtifact:
      image: <quay.io/org/image:tag>
  strategy:
    name: <strategy_name>
    kind: ClusterBuildStrategy
  output: 
    image: <target_image_registry/repository/image:tag> 
    pushSecret: <secret_name_for_credentials>
EOF
----
+
where:

`<build_resource_name>`:: Specifies the name of the `Build` resource.
`<quay.io/org/image:tag>`:: Specifies the location of the OCI artifact source image.
`<strategy_name>`:: Specifies the name of the build strategy to build the container.
`<target_image_registry/repository/image:tag>`:: Specifies the location where you want to push the built image.
`<secret_name_for_credentials>`:: (Optional) Specifies the secret name that stores the credentials for pushing container images. To generate a secret for a private registry for authentication, see link:https://docs.redhat.com/en/documentation/builds_for_red_hat_openshift/1.5/html-single/authentication/index#ob-authentication-to-container-registries_understanding-authentication-at-runtime[Authentication to container registries].

. Choose one of the following methods to upload your source code to the required registry and run the build:
* Upload the source code using the `shp` CLI:

** Run the following command in the directory containing the local source code. It packages your source code into a scratch container image, pushes it to the required registry, and runs the build:
+
[source,terminal]
----
$ shp build upload <build_resource_name>
----
+
where:

`<build_resource_name>`:: Specifies the name of the `Build` resource.

* Upload the OCI artifact manually: 

.. Create a `Containerfile` in the root directory of your source code and add the following configuration:
+
[source,dockerfile]
----
FROM scratch
COPY . /
----

.. Run the following command in the root directory of your source code to build the container image using Podman:
+
[source,terminal]
----
$ podman build -t <registry_path>/<image_name>:<tag> .
----
+
where:

`<registry_path>`:: Specifies the build location for the registry where the image is stored.
`<image_name>`:: Specifies the name of the container image.
`<tag>`:: Specifies the tag of the image.
+

When the container image is built successfully, a success message is displayed. See the following example command and output:
+
[source,terminal]
----
podman build -t quay.io/example/oci:latest .
----
+
[source,terminal]
----
STEP 1/2: FROM scratch
STEP 2/2: COPY . /
--> Using cache 31f2530b092a8e0d75586407052900e9946043eca09deb9a2c9e50c2541bfcfd
COMMIT quay.io/example/oci:latest
--> 31f2530b092a
Successfully tagged quay.io/example/oci:latest
31f2530b092a8e0d75586407052900e9946043eca09deb9a2c9e50c2541bfcfd
----

.. Push the container image to the required location using the following command:
+
[source,terminal]
----
$ podman push <registry_path>/<image_name>:<tag>
----
+
where:

`<registry_path>`:: Specifies the build location for the registry where the image is stored.
`<image_name>`:: Specifies the name of the container image.
`<tag>`:: Specifies the tag of the image.

.. Run the build using the following command:
+
[source,terminal]
----
$ shp build run <build_resource_name>
----
+
where:

`<build_resource_name>`:: Specifies the name of the `Build` resource.

.Verification

After all the containers complete their tasks, verify the statuses of the following resources:

. Check whether the pod shows the `STATUS` field as `Completed`:
+
[source,terminal]
----
$ oc get pods -w
----
+
Example output:
+
[source,terminal]
----
NAME                                READY   STATUS     RESTARTS   AGE
oci-artifact-buildrun-pxg9w-pod     2/2     Running    0          58s
oci-artifact-buildrun-pxg9w-pod     0/2     Completed  0          1m42s
----

. Check whether the respective `TaskRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get tr
----
+
Example output:
+
[source,terminal]
----
NAME                           SUCCEEDED  REASON     STARTTIME   COMPLETIONTIME
oci-artifact-buildrun-pxg9w    True       Succeeded  2m10s       28s
----

. Check whether the respective `BuildRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get br
----
+
Example output:
+
[source,terminal]
----
NAME                     SUCCEEDED   REASON       STARTTIME     COMPLETIONTIME
oci-artifact-buildrun    True        Succeeded    2m12s         30s
----

. During verification, if a build run fails, you can check the `status.failureDetails` field in your `BuildRun` resource to identify the exact point where the failure happened in the pod or container.
+
[NOTE]
====
The pod might switch to a `NotReady` state because one of the containers has completed its task. This is an expected behavior.
====

. Validate whether the image has been pushed to the registry that is specified in the `build.spec.output.image` field. Log in to the registry and run the following command to pull the image:
+
[source,terminal]
----
$ podman manifest inspect image-registry.openshift-image-registry.svc:5000/oci-artifacts-example/taxi-app
----
+
In the previous example, the project name is `oci-artifacts-example`, and the image name is `taxi-app`.
+
Example output:
+
[source,terminal]
----
   "schemaVersion": 2,
    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
    "manifests": [
        {
            "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
            "size": 594,
            "digest": "sha256:6a05100e302c86c03fec6277f4b3107f1fdde6c69d3ca9a4207e4735a5213e32",
            "platform": {
                "architecture": "amd64",
                "os": "linux"
            }
     ]
----
