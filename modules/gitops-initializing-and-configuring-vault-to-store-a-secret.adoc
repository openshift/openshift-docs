// Module is included in the following assemblies:
//
// * securing_openshift_gitops/managing-secrets-securely-using-sscsid-with-gitops.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-initializing-and-configuring-vault-to-store-a-secret_{context}"]
= Initializing and configuring Vault to store a Secret

[role="_abstract"]
After deploying Vault using Argo CD and applying the necessary SCC permissions and DaemonSet patches, initialize Vault, unseal it, and configure Kubernetes authentication to enable secure secret storage and access.

.Procedure

. Access the Vault Pod.

.. If Vault is running within your {OCP} cluster, for example, as the `vault-0` pod in the `vault-csi-provider` namespace, run the following command to access the Vault CLI inside the pod:
+
[source,terminal]
----
$ oc exec -it vault-0 -n vault-csi-provider -- /bin/sh
----

. Initialize Vault.

.. If your Vault instance is not yet initialized, run the following command:
+
[source,terminal]
----
$ vault operator init
----
+
As a result, the following output is displayed.
+
[source,output]
----
5 Unseal Keys - required to unseal the Vault.
Initial Root Token - required to log in and configure Vault.
----
+
[IMPORTANT]
====
Store these credentials securely. At least 3 out of 5 unseal keys are required to unseal Vault. If the keys are lost, access to stored secrets is permanently blocked.
====

. Unseal Vault.

.. Vault starts in a sealed state. Run the following commands to use three of the five Unseal Keys obtained in the earlier step:
+
[source,terminal]
----
$ vault operator unseal <Unseal Key 1>
  vault operator unseal <Unseal Key 2>
  vault operator unseal <Unseal Key 3>
----
+
Once unsealed, the Vault becomes active and ready for use.

. Log into Vault.

.. To use the root token to log in to Vault, run the following command:
+
[source,terminal]
----
$ vault login <Initial Root Token>
----
+
This provides administrator access to enable and configure secret engines and authentication methods.

. Enable Kubernetes Authentication in Vault.

.. Run the following command to enable Kubernetes authentication in Vault.
+
[source,terminal]
----
$ vault auth enable kubernetes
----
+
This allows Kubernetes workloads, for example, pods, to authenticate with Vault using their service accounts.

. Configure Kubernetes authentication method in Vault.

.. To configure Vault for communicating with the Kubernetes API, run the following command:
+
[source,terminal]
----
$ vault write auth/kubernetes/config \
issuer="https://kubernetes.default.svc" \
token_reviewer_jwt="$(cat/var/run/secrets/kubernetes.io/serviceaccount/token)" \
kubernetes_host="https://${KUBERNETES_PORT_443_TCP_ADDR}:443" \
kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
----
+
As a result, the following output is displayed.
+
[source,output]
----
Success! Data written to: auth/kubernetes/config
----
+
Where:
+
* `<issuer>` is the name of the Kubernetes token issuer URL.
* `<token_reviewer_jwt>` is a JSON Web Token (JWT) that Vault uses to call the Kubernetes `TokenReview` API and to validate service account tokens.
* `<kubernetes_host>` is the URL that Vault uses to communicate with the Kubernetes API server.
* `<kubernetes_ca_cert>` is the CA certificate that Vault uses for secure communication with the Kubernetes API server.

