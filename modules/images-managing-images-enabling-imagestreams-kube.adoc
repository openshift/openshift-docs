// Module included in the following assemblies:
//
// * openshift_images/managing-images/using-imagestreams-with-kube-resources.adoc


:_mod-docs-content-type: PROCEDURE
[id="images-managing-images-enabling-imagestreams-kube_{context}"]
= Enabling image streams with Kubernetes resources

When using ImageStreams with Kubernetes resources, you must specify the full image reference from the internal image registry of {product-title}. Additionally, the ImageStream must exist in the same project as the resource. For example:

[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: <application_name>
  namespace: <project_name>
spec:
  replicas: 1
  template:
    spec:
      containers:
      - name: mysql
        image: image-registry.openshift-image-registry.svc:5000/<myproject>/<imagestream_name>:<tag>
        imagePullPolicy: Always
----

Direct ImageStream references, for example, `<imagestreamname>: <tag>` do not automatically resolve to full image URIs in some cases.

[NOTE]
====
Previously, it was documented that image stream references using a single-segment value, such as `ruby:2.5`, could be used with Kubernetes resources. In this format, `ruby` represents the name of an image stream with a tag named `2.5` that resides in the same project as the referencing resource.  

Because of a known issue related to `Imagestream.spec.lookupPolicy.local` being set to `true`, this method is currently invalid and results in the creation of pods that fail to pull the image. You must use the full image reference from the {product-title} internal image registry.
====

include::snippets/default-projects.adoc[]

The following procedure shows you how to enable image streams with Kubernetes resources by using direct `ImageStream` references.

.Prerequisites

* You have created a namespace.

.Procedure

. Create an ImageStream resource for your application by entering the following command:
+
[source,terminal]
----
$ cat <<EOF | oc apply -f -
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  name: <application_name>
  namespace: <project_name>
EOF
----

. Import an image into the `ImageStream` resource by entering the following command:
+
[source,terminal]
----
$ oc import-image <application_name>:latest --from=<registry>/<image>:<tag> --confirm -n <project_name>
----

. Create a pod that references the image stream by entering the following command. Note that it must include the full image registry URL:
+
[source,terminal]
----
cat <<EOF | oc apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: <application_name>-deployment
  namespace: <project_name>
spec:
  replicas: 1
  selector:
    matchLabels:
      app: <application_name>
  template:
    metadata:
      labels:
        app: <application_name>
    spec:
      containers:
      - name: <application_name>
        image: <image_registry_url>/<project_name>/<application_name>:latest
        imagePullPolicy: Always
EOF
----

.Verification

* Confirm that the `ImageStream` resource exists by entering the following command:
+
[source,terminal]
----
$ oc get imagestream -n <project_name> -o yaml
----
+
.Example output
+
[source,terminal]
----
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  annotations:
    openshift.io/image.dockerRepositoryCheck: "2025-03-18T15:53:54Z"
  creationTimestamp: "2025-03-18T15:53:42Z"
  generation: 3
  name: mysql
  namespace: myproject
  resourceVersion: "34706"
  uid: 47c3ffd2-a217-4797-8169-5543c3d49c6c
spec:
  lookupPolicy:
    local: true
  tags:
  - annotations: null
    from:
      kind: DockerImage
      name: registry.redhat.io/rhel8/mysql-80
    generation: 2
    importPolicy:
      importMode: Legacy
    name: latest
    referencePolicy:
      type: Source
status:
  dockerImageRepository: image-registry.openshift-image-registry.svc:5000/myproject/mysql
  tags:
  - items:
    - created: "2025-03-18T15:53:54Z"
      dockerImageReference: registry.redhat.io/rhel8/mysql-80@sha256:5a771c8d21f7755bf9d0845242ba7d566603de8e09c89781589ed1e9c4e4388b
      generation: 2
      image: sha256:5a771c8d21f7755bf9d0845242ba7d566603de8e09c89781589ed1e9c4e4388b
    tag: latest
----

* Confirm that the pod is using the correct image by entering the following command:
+
[source,terminal]
----
$ oc get pod -l app=<application_name> -o jsonpath='{.items[*].spec.containers[*].image}'
----
+
.Example output
+
[source,terminal]
----
image-registry.openshift-image-registry.svc:5000/myproject/myapp:latest
----

////
When using image streams with Kubernetes resources, you can only reference image streams that exist in the same project as the resource. The image stream reference must consist of a single segment value, for example `ruby:2.5`, where `ruby` is the name of an image stream that has a tag named `2.5` and resides in the same project as the resource making the reference.


There are two ways to enable image streams with Kubernetes resources:

* Enabling image stream resolution on a specific resource. This allows only this resource to use the image stream name in the image field.
* Enabling image stream resolution on an image stream. This allows all resources pointing to this image stream to use it in the image field.

.Procedure

You can use `oc set image-lookup` to enable image stream resolution on a specific resource or image stream resolution on an image stream.

. To allow all resources to reference the image stream named `mysql`, enter the following command:
+
[source,terminal]
----
$ oc set image-lookup mysql
----
+
This sets the `Imagestream.spec.lookupPolicy.local` field to true.
+
.Imagestream with image lookup enabled
[source,yaml]
----
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  annotations:
    openshift.io/display-name: mysql
  name: mysql
  namespace: myproject
spec:
  lookupPolicy:
    local: true
----
+
When enabled, the behavior is enabled for all tags within the image stream.
+
. Then you can query the image streams and see if the option is set:
+
[source,terminal]
----
$ oc set image-lookup imagestream --list
----

You can enable image lookup on a specific resource.

* To allow the Kubernetes deployment named `mysql` to use image streams, run the following command:
+
[source,terminal]
----
$ oc set image-lookup deploy/mysql
----
+
This sets the `alpha.image.policy.openshift.io/resolve-names` annotation
on the deployment.
+
.Deployment with image lookup enabled
[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: myproject
spec:
  replicas: 1
  template:
    metadata:
      annotations:
        alpha.image.policy.openshift.io/resolve-names: '*'
    spec:
      containers:
      - image: mysql:latest
        imagePullPolicy: Always
        name: mysql
----

You can disable image lookup.

* To disable image lookup, pass `--enabled=false`:
+
[source,terminal]
----
$ oc set image-lookup deploy/mysql --enabled=false
----
////