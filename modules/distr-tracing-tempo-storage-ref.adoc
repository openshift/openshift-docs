// Module included in the following assemblies:
//
//* observability/distr_tracing/distr_tracing_tempo/distr-tracing-tempo-installing.adoc

:_mod-docs-content-type: REFERENCE
[id="distr-tracing-tempo-object-storage-setup_{context}"]
= Object storage setup

You can use the following configuration parameters when setting up a supported object storage.

--
include::snippets/distr-tracing-tempo-required-secret-parameters.adoc[]
--

=== AWS Security Token Service (STS) installation

.Procedure

. Create a custom AWS IAM Role associated with a trust relationship to Tempo's Kubernetes `ServiceAccount`:
+
[source,yaml]
----
{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": {
          "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}" <1>
        },
        "Action": "sts:AssumeRoleWithWebIdentity",
        "Condition": {
          "StringEquals": {
            "${OIDC_PROVIDER}:sub": [
              "system:serviceaccount:${TEMPOSTACK_NS}:tempo-${TEMPOSTACK_NAME}", <2>
              "system:serviceaccount:${TEMPOSTACK_NS}:tempo-${TEMPOSTACK_NAME}-query-frontend"
           ]
         }
       }
     }
    ]
}
----
<1> Substitute `AWS_ACCOUNT_ID` to AWS account ID and `OIDC_PROVIDER` to OpenShift OIDC provider e.g. `oc get authentication cluster -o json | jq -r '.spec.serviceAccountIssuer' | sed 's~http[s]*://~~g'`.
<2> Substitute `TEMPOSTACK_NS` to namespace where Tempo instance will be created. Substitute `TEMPOSTACK_NAME` to name of the Tempo instance.

. Create an AWS IAM role:
+
[source,terminal]
----
$ aws iam create-role \
      --role-name "tempo-s3-access" \
      --assume-role-policy-document "file:///tmp/trust.json" \
      --query Role.Arn \
      --output text
----

. Attach a specific policy to that role:
+
[source,terminal]
----
$ aws iam attach-role-policy \
      --role-name "tempo-s3-access" \
      --policy-arn "arn:aws:iam::aws:policy/AmazonS3FullAccess"
----

. Create an Object Storage secret with keys as follows:
+
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: minio-test
stringData:
  bucket: <s3_bucket_name>
  region: <s3_region>
  role_arn: <s3_role_arn>
type: Opaque
----
