// This module is included in the following assemblies:
// * about/understanding-openshift-pipelines.adoc

:_mod-docs-content-type: CONCEPT
[id="about-whenexpression_{context}"]
= When expression

[role="_abstract"]
You can use 'when' expressions to guard task execution by defining specific criteria that must be met before a task runs. These expressions allow you to control the flow of your pipeline, including the execution of tasks in the `finally` section, based on static inputs, variables, or results from previous tasks.

When expressions guard task execution by setting criteria for running tasks within a pipeline. They contain a list of components that allow a task to run only when certain criteria are met. You can also include when expressions in the final set of tasks that you specify by using the `finally` field in the pipeline YAML file.

The key components of a when expression are as follows:

* `input`: Specifies static inputs or variables such as a parameter, task result, and execution status. You must enter a valid input. If you do not enter a valid input, its value defaults to an empty string.
* `operator`: Specifies the relationship of an input to a set of `values`. Enter `in` or `notin` as your operator values.
* `values`: Specifies an array of string values. Enter a non-empty array of static values or variables such as parameters, results, and a bound state of a workspace.

The declared when expressions evaluate before the task runs. If the when expression evaluates to `True`, the task runs. If the when expression evaluates to `False`, the task skips.

You can use the when expressions in various use cases. For example, whether:

* The result of a preceding task is as expected.
* A file in a Git repository has changed in the earlier commits.
* An image exists in the registry.
* An optional workspace is available.

The following example shows the when expressions for a pipeline run. The pipeline run will run the `create-file` task only if the following criteria are met: the `path` parameter is `README.md`, and the `echo-file-exists` task runs only if the `exists` result from the `check-file` task is `yes`.

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: guarded-pr-
spec:
  taskRunTemplate:
    serviceAccountName: pipeline
  pipelineSpec:
    params:
      - name: path
        type: string
        description: The path of the file to be created
    workspaces:
      - name: source
        description: |
          This workspace is shared among all the pipeline tasks to read/write common resources
    tasks:
      - name: create-file
        when:
          - input: "$(params.path)"
            operator: in
            values: ["README.md"]
        workspaces:
          - name: source
            workspace: source
        taskSpec:
          workspaces:
            - name: source
              description: The workspace to create the readme file in
          steps:
            - name: write-new-stuff
              image: ubuntu
              script: 'touch $(workspaces.source.path)/README.md'
      - name: check-file
        params:
          - name: path
            value: "$(params.path)"
        workspaces:
          - name: source
            workspace: source
        runAfter:
          - create-file
        taskSpec:
          params:
            - name: path
          workspaces:
            - name: source
              description: The workspace to check for the file
          results:
            - name: exists
              description: indicates whether the file exists or is missing
          steps:
            - name: check-file
              image: alpine
              script: |
                if test -f $(workspaces.source.path)/$(params.path); then
                  printf yes | tee /tekton/results/exists
                else
                  printf no | tee /tekton/results/exists
                fi
      - name: echo-file-exists
        when:
          - input: "$(tasks.check-file.results.exists)"
            operator: in
            values: ["yes"]
        taskSpec:
          steps:
            - name: echo
              image: ubuntu
              script: 'echo file exists'
...
      - name: task-should-be-skipped-1
        when:
          - input: "$(params.path)"
            operator: notin
            values: ["README.md"]
        taskSpec:
          steps:
            - name: echo
              image: ubuntu
              script: exit 1
...
    finally:
      - name: finally-task-should-be-executed
        when:
          - input: "$(tasks.echo-file-exists.status)"
            operator: in
            values: ["Succeeded"]
          - input: "$(tasks.status)"
            operator: in
            values: ["Succeeded"]
          - input: "$(tasks.check-file.results.exists)"
            operator: in
            values: ["yes"]
          - input: "$(params.path)"
            operator: in
            values: ["README.md"]
        taskSpec:
          steps:
            - name: echo
              image: ubuntu
              script: 'echo finally done'
  params:
    - name: path
      value: README.md
  workspaces:
    - name: source
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 16Mi
----

`kind`:: Specifies the type of Kubernetes object. In this example, `PipelineRun`.

`tasks[0].name`:: Task `create-file` used in the pipeline.

`tasks[2].name.when`:: The `when` expression that specifies to run the `echo-file-exists` task only if the `exists` result from the `check-file` task is `yes`.

`tasks[3].name.when`:: The `when` expression that specifies to skip the `task-should-be-skipped-1` task only if the `path` parameter is `README.md`.

`tasks[4].name.when`:: The `when` expression that specifies to run the `finally-task-should-be-executed` task only if the execution status of the `echo-file-exists` task and the task status is `Succeeded`, the `exists` result from the `check-file` task is `yes`, and the `path` parameter is `README.md`.

The *Pipeline Run details* page of the {OCP} web console shows the status of the tasks and when expressions as follows:

* All the criteria are met: Tasks and the when expression symbol, which is represented as a diamond shape, appear in a **success** state.

* Any one of the criteria are not met: The Task skips. Skipped tasks and the when expression symbol appear in a **skipped** state.

* None of the criteria are met: The Task skips. Skipped tasks and the when expression symbol appear in a **skipped** state.

* Task run fails: Failed tasks and the when expression symbol appear in a **failed** state.