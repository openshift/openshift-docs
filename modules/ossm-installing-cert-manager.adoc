// Module included in the following assemblies:
//
// * service-mesh-docs-main/install/ossm-cert-manager.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-installing-cert-manager_{context}"]
= Integrating Service Mesh with the cert-manager Operator by using the istio-csr agent

You can integrate the cert-manager Operator with {SMProduct} by deploying the `istio-csr` agent and configuring an `{istio}` resource that uses the `istio-csr` agent to process workload and control plane certificate signing requests. The following procedure creates a self-signed `issuer` object.

.Prerequisites

* You have installed the {cert-manager-operator} version 1.15.1.
* You are logged in to {ocp-product-title} 4.14 or later.
* You have installed the {SMProduct} Operator.
* You have a `IstioCNI` instance running in the cluster.
* You have installed the `istioctl` command.

.Procedure

. Create the `istio-system` namespace by running the following command:
+
[source, terminal]
----
$ oc create namespace istio-system
----

. Patch the cert-manager Operator to install the `istio-csr` agent by running the following command:
+
[source, terminal]
----
$ oc -n cert-manager-operator patch subscription openshift-cert-manager-operator \
  --type='merge' -p \
  '{"spec":{"config":{"env":[{"name":"UNSUPPORTED_ADDON_FEATURES","value":"IstioCSR=true"}]}}}'
----

. Create the root certificate authority (CA) issuer by creating an `Issuer` object for the `istio-csr` agent:

.. Create a new project for installing the `istio-csr` agent by running the following command:
+
[source, terminal]
----
$ oc new-project istio-csr
----

.. Create an `Issuer` object similar to the following example:
+
[NOTE]
====
The `selfSigned` issuer is intended for demonstration, testing, or proof-of-concept environments. For production deployments, use a secure and trusted CA.
====
+
.Example `issuer.yaml` file
[source, yaml]
----
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned
  namespace: istio-system
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: istio-ca
  namespace: istio-system
spec:
  isCA: true
  duration: 87600h
  secretName: istio-ca
  commonName: istio-ca
  privateKey:
    algorithm: ECDSA
    size: 256
  subject:
    organizations:
      - cluster.local
      - cert-manager
  issuerRef:
    name: selfsigned
    kind: Issuer
    group: cert-manager.io
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: istio-ca
  namespace: istio-system
spec:
  ca:
    secretName: istio-ca
----

.. Create the objects by running the following command:
+
[source, terminal]
+
----
$ oc apply -f issuer.yaml
----

.. Wait for the `istio-ca` certificate to contain the "Ready" status condition by running the following command:
+
[source, terminal]
----
$ oc wait --for=condition=Ready certificates/istio-ca -n istio-system
----

. Create the `IstioCSR` custom resource:

.. Create the `IstioCSR` custom resource similar to the following example:
+
.Example `istioCSR.yaml` file
[source, yaml]
----
apiVersion: operator.openshift.io/v1alpha1
kind: IstioCSR
metadata:
  name: default
  namespace: istio-csr
spec:
  istioCSRConfig:
    certManager:
      issuerRef:
        name: istio-ca
        kind: Issuer
        group: cert-manager.io
    istiodTLSConfig:
      trustDomain: cluster.local
    istio:
      namespace: istio-system
----

.. Create the `istio-csr` agent by by running the following command:
+
[source, terminal]
+
----
$ oc create -f istioCSR.yaml
----

.. Verify that the `istio-csr` deployment is ready by running the following command:
+
[source, terminal]
+
----
$ oc get deployment -n istio-csr
----

. Install the `istio` resource:
+
[NOTE]
====
The configuration disables the built-in CA server for {istio} and forwards certificate signing requests from `istiod` to the `istio-csr` agent. The `istio-csr` agent obtains certificates for both `istiod` and mesh workloads from the cert-manager Operator. The `istiod` TLS certificate that is generated by the `istio-csr` agent is mounted into the pod at a known location for use.
====

.. Create the `{istio}` object similar to the following example:
+
.Example `istio.yaml` file
[source, yaml]
----
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: default
spec:
  version: v1.24-latest
  namespace: istio-system
  values:
    global:
      caAddress: cert-manager-istio-csr.istio-csr.svc:443
    pilot:
      env:
        ENABLE_CA_SERVER: "false"
----

.. Create the `{istio}` resource by running the following command:
+
[source, terminal]
+
----
$ oc apply -f istio.yaml
----

.. Verify that the `istio` resource displays the "Ready" status condition by running the following command:
+
[source, terminal]
----
$ oc wait --for=condition=Ready istios/default -n istio-system
----