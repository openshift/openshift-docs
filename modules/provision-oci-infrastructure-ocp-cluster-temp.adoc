// Module included in the following assemblies:
//
// * installing/installing_oci/installing-oci-assisted-installer.adoc

:_mod-docs-content-type: PROCEDURE
[id="provision-oci-infrastructure-ocp-cluster-temp_{context}"]
= Provisioning {oci} infrastructure for your cluster - 2

By using the {ai-full} to create details for your {product-title} cluster, you can specify these details in a stack. A stack is an {oci} feature where you can automate the provisioning of all necessary {oci} infrastructure resources, such as the custom image, that are required for installing an {product-title} cluster on {oci}.

The {oci-first} Compute Service creates a virtual machine (VM) instance on {oci}. This instance can then automatically attach to a virtual network interface controller (vNIC) in the virtual cloud network (VCN) subnet. On specifying the IP address of your {product-title} cluster in the custom manifest template files, the {oci} instance can communicate with your cluster over the VCN.

== Uploading the Discovery ISO

Upload the discovery ISO image from your local drive to the new object storage bucket you created in {oci}.

.Prerequisites

* You downloaded the discovery ISO image to a local directory. For more information, see "Using the {ai-full} to generate an {oci}-compatible discovery ISO image".

.Procedure

. Log in to your link:https://cloud.oracle.com/a/[{oci-first-no-rt}] account.

. Navigate to *Storage* > *Buckets*. 

. On the *Buckets* page, select the new bucket you created for the integration. 

. Under *Objects*, click *Upload*. 

. On the *Upload Objects* page, click *select files*.

. Under *Downloads*, select the ISO file and click *Open*.

. On the *Upload Objects* page, click *Upload*. Then click *Close*. The new ISO file appears for the bucket under *Objects*.
+
For details, see link:https://docs.oracle.com/en-us/iaas/Content/Object/Tasks/managingobjects_topic-To_upload_objects_to_a_bucket.htm[Uploading an Object Storage Object to a Bucket].

== Creating a Pre-Authenticated Request for the discovery ISO image

Create a Pre-Authenticated Request for the discovery ISO image.

.Prerequisites

* You uploaded the discovery ISO image.

.Procedure

.. In the Objects table, locate the uploaded discovery ISO. 

.. From the options menu for the ISO, select *Create Pre-Authenticated Request*.

.. Leave the default values and select *Create Pre-Authenticated Request*.

.. On the *Pre-Authenticated Request Details* page, copy the Pre-Authenticated Request URL by using the copy button. This is the URL from which the control plane and compute nodes will be booted. 

.. Click *Close*.
+
The URL is used as the `openshift_image_source_uri`, in the steps that follow. For more details, see link:https://docs.oracle.com/iaas/Content/Object/Tasks/usingpreauthenticatedrequests.htm[Pre-Authenticated Requests for Object Storage].

== Creating the terraform stack

Upload the stack template stored locally, and use it to create the terraform stack. The terraform stack includes files for creating cluster resources and custom manifests. The stack also includes a script, and when you run apply the stack, the script creates OCI resources, such as DNS records, an instance, and so on. 

For details, see link:https://docs.oracle.com/en-us/iaas/Content/openshift-on-oci/installing-assisted.htm#install-cluster-apply-stack[Creating {product-title}Infrastructure Using Resource Manager].

.Prerequisites

* You uploaded the discovery ISO image.
* You created a Pre-Authenticated Request URL and copied the link to the clipboard.

.Procedure

. From the navigation menu, select *Developer Services* > *Stacks*.

. Click *Create Stack*. 

.. Select *My configuration* for the origin of the Terraform configuration.

. Under *Stack Configuration*, select the *Zip file* checkbox and click *Browse*.

. Select the zip file from your local drive and click *Next*. 

. Complete the fields for the stack variables: 
+
[cols="1,3",options="header",subs="quotes"]
|===
|Field |Action required

|*Compartment*
|Select the child compartment you created previously.

|*Cluster Name*
|Specify the name of your cluster, such as `oci`. Use the same cluster name that you entered during the creation of
the ISO image in the Red Hat Hybrid Cloud Console. For details, see "Using the Assisted Installer to generate an OCI-compatible discovery ISO image".

|*OpenShift Image Source URI*
|Enter the Pre-Authenticated Request URL created in the previous task. For details, see "Provisioning OCI infrastructure for your cluster".

|*Control Plane Shape*
|Instance shape of the control plane nodes. Currently shapes are available for virtual machines and bare metal. For details, see link:docs.oracle.com/en-us/iaas/Content/Compute/References/computeshapes.htm[Compute Shapes].

|*Compute Shape*
|Instance shape of the compute nodes. Currently shapes are available for virtual machines and bare metal. For details, see link:docs.oracle.com/en-us/iaas/Content/Compute/References/computeshapes.htm[Compute Shapes].

|*Zone DNS*
|Specify DNS name server that stores DNS records for a zone, for example `openshift-demo.devcluster.openshift.com`. This is the same value as the base domain in {oci}.

|*Enable Private DNS*
|Set the DNS zone to public or private. Specifying a value of `true`, creates a private DNS zone. Specifying a value of `false` creates a public DNS zone. For a private DNS zone, you must configure your local `/etc/hosts` file to reach the cluster.
|===

. (Optional) Edit the default values for the other fields as needed. By default, the
cluster has 3 control plane nodes and 3 compute nodes.

. Click *Next* and review the stack information and variables.

. Click *Create* to create the stack. The console redirects to the stack details page
for the new stack. 

. On the stack details page, click *Apply* to create an apply job and provision the infrastructure for the cluster.
+
After running an apply job, get the job's details to check its status. Succeeded (SUCCEEDED) indicates that the job has completed.

== Getting the custom manifests

After provisioning the infrastructure in the Resource Manager service, from the "Outputs" of the stack job, get the “dynamic_custom_manifest”. This output contains all the required manifests, concatenated and preformatted with the configuration values for CCM and CSI. *Not sure what CCM and CSI are*
////
The dynamic_custom_manifest file contains the following manifests:

** `oci-ccm.yml` - CCM manifest

** `oci-csi.yml` - CSI driver manifest

** `machineconfig-ccm.yml` - CCM machine configuration manifest

** `machineconfig-csi.yml` - CSI driver machine configuration manifest

** `machineconfig-consistent-device-path.yml` - Consistent device path machine configuration manifest
////
For clusters deployed on bare-metal instance (BMI) nodes using iSCSI, two additional manifests are included that provide a second vNIC to be used for the iSCSI service:
////
** `oci-configure-secondary-nic-worker.yml` - If the installation has compute nodes defined as BMIs.

** `oci-configure-secondary-nic-master.yml` - If the installation has control plane nodes defined as BMIs. 
This output contains all the required manifests, concatenated and preformatted with the configuration values for CCM and CSI. 
////

For details, see TBD. *waiting for them to publish so I can provide a link*

.Prerequisites

* You created the terraform stack.
* You confirmed that the *Apply* job completed successfully.

.Procedure

. On the Stacks page in the Resource Manager service, click the name of the stack to see the stack details. If the list view of jobs isn't displayed, select *Jobs* under the *Resources* section to see the list of jobs. 

. From the job page, select *Outputs* in the menu. 

. Under *Outputs*, locate the `custom_manifest.yml` key.

. Optionally select *View* to view the manifest contents. 

. Click *Copy* to copy the contents of the manifest to your machine clipboard. 