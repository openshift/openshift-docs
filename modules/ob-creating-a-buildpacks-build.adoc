:_mod-docs-content-type: PROCEDURE
[id="ob-creating-a-buildpacks-build_{context}"]
= Creating a buildpacks build

[role="_abstract"]
Use a `buildpacks` build to create and push container images to the target registry. The `buildpacks` cluster build strategy supports `buildpacks` and `buildpacks-extender` strategies.

[IMPORTANT]
====
{builds-title-uppercase} supports the execution process for Cloud Native Buildpacks (CNB) within the build strategies. Red{nbsp}Hat does not provide support for the content of user-provided builder and runtime images. For more information on Cloud Native Buildpacks (CNB), see link:https://buildpacks.io/[Cloud Native Buildpacks].
====

.Prerequisites

* You have installed the {builds-operator} on the {ocp-product-title} cluster.
* You have installed the `oc` CLI.
* You have created the project where your final application image is stored by using the command `oc new-project buildpacks-example`.
* Optional: You have installed the link:https://console.redhat.com/openshift/downloads[`shp` CLI].

[IMPORTANT]
====
Using `shp` CLI with buildpacks requires additional permissions setup that
you must complete before you start creating a buildpacks build.
====

.Procedure

. Optional: Run the following commands to use the `shp` CLI with `buildpacks` and grant the `pipeline` service account permission to access the image registry in the `buildpacks-example` project.
+
[source,terminal]
----
$ oc policy add-role-to-user system:image-puller system:serviceaccount:default:pipeline --namespace=buildpacks-example
----
+
[source,terminal]
----
$ oc policy add-role-to-user system:image-pusher system:serviceaccount:default:pipeline --namespace=buildpacks-example
----

. Optional: Continue with `shp` CLI by switching back to the primary working project:
+
[source,terminal]
----
$ oc project default
----

. Optional: Run the following command to apply the permission and finish `shp` CLI setup:
+
[source,terminal]
----
$ oc create rolebinding allow-builds-to-push \

  --clusterrole=edit \

 --serviceaccount=default:pipeline \

--namespace=buildpacks-example
----

. Create a `Build` resource and apply it to the {ocp-product-title} cluster. You can do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: Build
metadata:
  name: buildpack-nodejs-build
spec:
  source:
    type: Git
    git:
      url: https://github.com/redhat-openshift-builds/samples.git
  strategy:
    name: buildpacks
    kind: ClusterBuildStrategy
  retention:
    atBuildDeletion: true
  paramValues:
    - name: run-image
      value: paketobuildpacks/run-ubi8-base:latest
    - name: cnb-builder-image
      value: paketobuildpacks/builder-jammy-tiny:0.0.344
    - name: source-subpath 
      value: "buildpacks/nodejs"
  output:
    image: image-registry.openshift-image-registry.svc:5000/buildpacks-example/taxi-app
EOF
----
+
where:

`source`:: Specifies the Git repository containing your application source code.
`strategy`:: Specifies the build strategy to build the container.
`paramValues`:: Specifies the parameters set for the buildpacks strategy.
`name: run-image`:: Specifies the base image on which your application runs.
`name: cnb-builder-image`:: Specifies the builder image used by Cloud Native Buildpacks (CNB) to detect and build your application.
`name: source-subpath`:: Specifies the subdirectory within your Git repository where the application source code is located.
`output`:: Specifies the location where the built image is pushed.

+
[source,terminal]
----
$ shp build create buildpack-nodejs-build \
--source-git-url="https://github.com/redhat-openshift-builds/samples.git" \
--strategy-name="buildpacks" \
--output-image="image-registry.openshift-image-registry.svc:5000/buildpacks-example/taxi-app" \
--param-value="source-subpath=buildpacks/nodejs" \
--param-value="cnb-builder-image=paketobuildpacks/builder-jammy-tiny:0.0.344" \
--param-value="run-image=paketobuildpacks/run-ubi8-base:latest"
----

. Check if the `Build` resource is created. You can do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc get builds.shipwright.io buildpack-nodejs-build
----

+
[source,terminal]
----
$ shp build list
----

. Create a `BuildRun` resource and apply it to the {ocp-product-title} cluster.  You can do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: BuildRun
metadata:
  name: buildpack-nodejs-buildrun
  namespace: builds-test
spec:
  build:
    name: buildpack-nodejs-build
EOF
----
+
where:

`spec.build.name`:: Specifies the `buildpack-nodejs-build` resource that will be executed.

+
--
[source,terminal]
----
$ shp build run buildpack-nodejs-buildrun --follow
----
--

+
[IMPORTANT]
====
The `shp` CLI version 0.16.0 cannot automatically generate a name for the `BuildRun` resource.
You must create the name manually:

. Create a `BuildRun` resource with a unique name.
+
[source,terminal]
----
$ shp buildrun create buildpack-nodejs-<buildrun_resource_name>  --buildref-name buildpack-nodejs-build
----
+
where:

`<buildrun_resource_name>`:: Specifies the buildrun resource name

`--buildref-name buildpack-nodejs-build`:: Defines the flag referencing the build.

. Follow the logs:
+
[source,terminal]
----
$ shp buildrun logs buildpack-nodej-<buildrun_resource_name> --follow
----
====

. Check if the `BuildRun` resource is created. You can do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc get buildrun buildpack-nodejs-buildrun
----

+
[source,terminal]
----
$ shp buildrun list
----

+
[NOTE]
====
The `BuildRun` resource creates a `TaskRun` resource, which then creates the pods to execute build strategy steps.
====

.Verification

. Wait for all containers to complete their tasks.

. Check if the pod shows the `STATUS` field as `Completed`:
+
[source,terminal]
----
$ oc get pods -w
----
+
Example output:
+
[source,terminal]
----
NAME                                 READY   STATUS     RESTARTS   AGE
buildpack-go-build-ttwkl-d8x97-pod   2/8     NotReady   0          63s
buildpack-go-build-ttwkl-d8x97-pod   0/8     Completed   0          72s
buildpack-go-build-ttwkl-d8x97-pod   0/8     Completed   0          73s
----

. Check if the `TaskRun` resource shows the `SUCCESS` field as `True`:
+
[source,terminal]
----
$ oc get tr
----
+
Example output:
+
[source,terminal]
----
NAME                             SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME
buildpack-go-build-ttwkl-d8x97   True        Succeeded   112s        38s
----

. Check if the `BuildRun` resource shows the `SUCCESS` field as `True`:
+
[source,terminal]
----
$ oc get br
----
+
Example output:
+
[source,terminal]
----
NAME                       SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME
buildpack-go-build-ttwkl   True        Succeeded   107s        33s
----
+
[NOTE]
====
If the build run fails, you can check the `status.failureDetails` field in your `BuildRun` resource to identify the exact point where the failure happened in the pod or container.

The pod might switch to a `NotReady` state because one of the containers has completed its task. This is an expected behavior.
====

. Run the following command from a node that can access internal registry to pull the image to check if the image has been pushed to the registry you specified in the `build.spec.output.image` field:
+
[source,terminal]
----
$ podman manifest inspect image-registry.openshift-image-registry.svc:5000/buildpacks-example/taxi-app
----
+
In the previous example, the project name is `buildpacks-example`, and the image name is `taxi-app`.
+
Example output:
+
[source,terminal]
----
   "schemaVersion": 2,
    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
    "manifests": [
        {
            "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
            "size": 594,
            "digest": "sha256:6a05100e302c86c03fec6277f4b3107f1fdde6c69d3ca9a4207e4735a5213e32",
            "platform": {
                "architecture": "amd64",
                "os": "linux"
            }
     ]
----