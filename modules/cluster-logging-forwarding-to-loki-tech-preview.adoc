:_content-type: PROCEDURE
[id="cluster-logging-forwarding-to-loki-tech-preview_{context}"]
:FeatureName: Loki
include::snippets/technology-preview.adoc[]

[id="cluster-logging-forwarding-to-loki-tech-preview"]
= Forwarding to LokiStack gateway

.Deploy the Loki Operator and a Lokistack instance with the gateway flag enabled.

.Deploy the OpenShift Logging Operator from the Operator Hub or using the following command locally:

[source, terminal]
----
make deploy-image deploy-catalog install
----

.Create a Cluster Logging instance in the openshift-logging namespace with only collection defined.

[source, YAML]
----
apiVersion: logging.openshift.io/v1
kind: ClusterLogging
metadata:
  name: instance
  namespace: openshift-logging
spec:
  collection:
    logs:
      type: fluentd
      fluentd: {}
----

The LokiStack Gateway requires a bearer token for communication with fluentd. Therefore, create a secret with token key and the path to the file.

[source, terminal]
----
kubectl -n openshift-logging create secret generic lokistack-gateway-bearer-token \
--from-literal=token="/var/run/secrets/kubernetes.io/serviceaccount/token"
----

.Create the following ClusterRole and ClusterRoleBinding which will allow the cluster to authenticate the user(s) submitting the logs:

[source, YAML]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: lokistack-dev-tenant-logs
rules:
- apiGroups:
  - 'loki.grafana.com'
  resources:
  - application
  - infrastructure
  - audit
  resourceNames:
  - logs
  verbs:
  - 'create'
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: lokistack-dev-tenant-logs
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: lokistack-dev-tenant-logs
subjects:
- kind: ServiceAccount
  name: logcollector
  namespace: openshift-logging
----

.Now create a ClusterLogForwarder CR to forward logs to LokiStack:

[source, YAML]
----
apiVersion: logging.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: instance
  namespace: openshift-logging
spec:
  outputs:
   - name: loki-app
     type: loki
     url: http://lokistack-dev-gateway-http.openshift-logging.svc:8080/api/logs/v1/application
     secret:
       name: lokistack-gateway-bearer-token
   - name: loki-infra
     type: loki
     url: http://lokistack-dev-gateway-http.openshift-logging.svc:8080/api/logs/v1/infrastructure
     secret:
       name: lokistack-gateway-bearer-token
   - name: loki-audit
     type: loki
     url: http://lokistack-dev-gateway-http.openshift-logging.svc:8080/api/logs/v1/audit
     secret:
       name: lokistack-gateway-bearer-token
  pipelines:
   - name: send-app-logs
     inputRefs:
     - application
     outputRefs:
     - loki-app
   - name: send-infra-logs
     inputRefs:
     - infrastructure
     outputRefs:
     - loki-infra
   - name: send-audit-logs
     inputRefs:
     - audit
     outputRefs:
     - loki-audit
----
