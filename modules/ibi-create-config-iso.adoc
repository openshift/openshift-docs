// Module included in the following assemblies:
//
// * edge_computing/ibi-edge-image-based-install.adoc 

:_content-type: PROCEDURE
[id="create-config-iso_{context}"]
= Performing an image-based deployment for {sno} clusters

Create the following site-specific configuration resources in the hub cluster to prepare for the deployment of a preinstalled host. When you apply these configuration resources in the hub cluster, the Image Based Install (IBI) Operator generates a configuration ISO and attaches it to the target host. The host mounts the configuration ISO and runs the reconfiguration process. When the reconfiguration completes, the single-node OpenShift cluster is ready.

* `BareMetalHost`
* `ImageClusterInstall`
* `ClusterDeployment`
* `ClusterImageSet`
* `ManagedCluster`
* `Secret` for the bare-metal host
* `Secret` for the image registry
* `Namespace`
* `ConfigMap` (optional)

.Prerequisites

* You preinstalled a host with {sno} using an image-based installation.
* You logged in as a user with `cluster-admin` privileges.
* You deployed a {rh-rhacm-first} hub cluster or you deployed the multicluster engine for Kubernetes operator (MCE).
* You installed the IBI Operator on the hub cluster.
* You created a pull secret to authenticate pull requests. See the _Additional resources_ section for more information about using image pull secrets.

.Procedure

. Create the `ibi-ns` namespace by running the following command:
+
[source,terminal]
----
$ oc create namespace ibi-ns
----

. Create the `Secret` resource for your image registry:

.. Create a YAML file that defines the `Secret` resource for your image registry:
+
.Example `secret-image-registry.yaml` file
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: ibi-image-pull-secret
  namespace: ibi-ns
stringData:
  .dockerconfigjson: <base64-docker-auth-code> <1>
type: kubernetes.io/dockerconfigjson
----
<1> You must provide base64-encoded credential details. See the _Additional resources_ section for more information about using image pull secrets.

.. Create the `Secret` resource for your image registry by running the following command:
+
[source,terminal]
----
$ oc create -f secret-image-registry.yaml
----

. Create the `BareMetalHost` and `Secret` resources:

.. Create a YAML file that defines the `BareMetalHost` and `Secret` resources:
+
.Example `ibi-bmh.yaml` file
[source,yaml]
----
apiVersion: metal3.io/v1alpha1
kind: BareMetalHost
metadata:
  name: ibi-bmh <1>
  namespace: openshift-machine-api
spec:
  online: true <2>
  bootMACAddress: 00:a5:12:55:62:64 <3>
  bmc:
    address: redfish-virtualmedia+http://192.168.111.1:8000/redfish/v1/Systems/8a5babac-94d0-4c20-b282-50dc3a0a32b5 <4>
    credentialsName: ibi-bmh-bmc-secret <5>
---
apiVersion: v1
kind: Secret
metadata:
  name: ibi-bmh-secret <6>
  namespace: openshift-machine-api
type: Opaque
data:
  username: <user_name> <7>
  password: <password> <8>
----
<1> Specify the name for the `BareMetalHost` resource.
<2> Specify if the host should be online. 
<3> Specify the host boot MAC address.
<4> Specify the BMC address. You can only use bare-metal host drivers that support virtual media networking booting, for example redfish-virtualmedia and idrac-virtualmedia.
<5> Specify the name of the bare-metal host `Secret` resource.
<6> Specify the name for the `Secret` resource.
<7> Specify the username.
<8> Specify the password.

.. Create the `BareMetalHost` and `Secret` resources by running the following command:
+
[source,terminal]
----
$ oc create -f ibi-bmh.yaml
----

. Create the `ClusterImageSet` resource:

.. Create a YAML file that defines the `ClusterImageSet` resource:
+
.Example `ibi-cluster-image-set.yaml` file
[source,yaml]
----
apiVersion: hive.openshift.io/v1
kind: ClusterImageSet
metadata:
  name: ibi-img-version-arch <1>
spec:
  releaseImage: ibi.example.com:path/to/release/images:version-arch <2>
----
<1> Specify the name for the `ClusterImageSet` resource.
<2> Specify the address for the release image to use for the deployment. If you use a different image registry compared to the image registry used during seed image generation, ensure that the {product-title} version for the release image remains the same.

.. Create the `ClusterImageSet` resource by running the following command:
+
[source,terminal]
----
$ oc apply -f ibi-cluster-image-set.yaml
----

. Optional. Create a `ConfigMap` object for your networking setting.

.. Create a YAML file named `network-cm.yaml`:
+
.Example `network-cm.yaml` file
[source,yaml]
----
apiVersion: v1
data:
  network-config: |
    interfaces:
    - name: enp1s0 <1>
      type: ethernet
      state: up
      identifier: mac-address
      mac-address: <mac_address>
      ipv4:
        dhcp: false <2>
        address:
        - ip: <ip_address>
          prefix-length: "24"
        enabled: true
      ipv6:
        enabled: false
    routes:
      config:
        - destination: 0.0.0.0/0
          next-hop-address: <hop_address>
          next-hop-interface: enp1s0
    dns-resolver:
      config:
        server:
          - <server_ip_address>
kind: ConfigMap
metadata:
  name: target-nmstate-config
  namespace: target
----
<1> The name of the interface must match the actual NIC name as shown in the operating system.
<2> When using static IP, ensure that you set the `dhcp: false` configuration. Otherwise, the installation fails while waiting for DHCP.

.. Create the `ConfigMap` object by running the following command:
+
[source,terminal]
----
$ oc apply -f network-cm.yaml
----

. Create the `ImageClusterInstall` resource:

.. Create a YAML file that defines the `ImageClusterInstall` resource:
+
.Example `ibi-image-cluster-install.yaml` file
[source,yaml]
----
apiVersion: extensions.hive.openshift.io/v1alpha1
kind: ImageClusterInstall
metadata:
  name: ibi-image-install <1>
  namespace: ibi-ns
spec:
  bareMetalHostRef:
    name: ibi-bmh <2>
    namespace: openshift-machine-api
  clusterDeploymentRef:
    name: ibi-cluster-deployment <3>
  hostname: ibi-host <4>
  imageSetRef:
    name: ibi-image-install <5>
  machineNetwork: 10.0.0.0/24 <6>
  networkConfigRef:
      name: <node-name>-nmstate-config <7>
  proxy: <8>
    httpProxy: "http://proxy.example.com:8080"
    #httpsProxy: "http://proxy.example.com:8080"
    #noProxy: "no_proxy.example.com"
----
<1> Specify the name for the `ImageClusterInstall` resource.
<2> Specify the `BareMetalHost` resource that you want to target for the image-based installation.
<3> Specify the name of the `ClusterDeployment` resource that you want to use for the image-based installation of the target host.
<4> Specify the hostname for the cluster.
<5> Specify the name of the `ClusterImageSet` resource you used to define the container release images to use for deployment.
<6> Specify the public CIDR (Classless Inter-Domain Routing) of the external network.
<7> Optional. Specify the `ConfigMap` object that contains the network configuration files.
<8> Specify a proxy to use for the cluster deployment.
+
[IMPORTANT]
====
If your cluster deployment requires a proxy configuration, you must create a seed image from a seed cluster featuring a proxy configuration. The proxy configurations do not have to match.
====

.. Create the `ClusterDeployment` resource by running the following command:
+
[source,terminal]
----
$ oc create -f ibi-image-cluster-install.yaml
----

. Create the `ClusterDeployment` resource:

.. Create a YAML file that defines the `ClusterDeployment` resource:
+
.Example `ibi-cluster-deployment.yaml` file
[source,yaml]
----
apiVersion: hive.openshift.io/v1
kind: ClusterDeployment
metadata:
  name: ibi-cluster-deployment <1>
  namespace: ibi-ns <2>
spec:
  baseDomain: example.com <3>
  clusterInstallRef:
    group: extensions.hive.openshift.io
    kind: ImageClusterInstall 
    name: ibi-image-install <4>
    version: v1alpha1
  clusterName: ibi-cluster <5>
  platform:
    none: {}
  pullSecretRef:
    name: pull-secret <6>
----
<1> Specify the name for the `ClusterDeployment` resource.
<2> Specify the namespace for the `ClusterDeployment` resource.
<3> Specify the base domain that the cluster should belong to.
<4> Specify the name of the `ImageClusterInstall` in which you defined the container images to use for the image-based installation of the target host.
<5> Specify a name for the cluster.
<6> Specify the deployment platform for the cluster.

.. Create the `ClusterDeployment` resource by running the following command:
+
[source,terminal]
----
$ oc apply -f ibi-cluster-deployment.yaml
----

. Create the `ManagedCluster` resource:

.. Create a YAML file that defines the `ManagedCluster` resource:
+
.Example `ibi-managed.yaml` file
[source,yaml]
----
apiVersion: cluster.open-cluster-management.io/v1
kind: ManagedCluster
metadata:
  name: sno-ibi <1>
spec:
  hubAcceptsClient: true <2>
----
<1> Specify the name for the `ManagedCluster` resource.
<2> Specify `true` to enable {rh-rhacm} to mange the cluster.

.. Create the `ManagedCluster` resource by running the following command:
+
[source,terminal]
----
$ oc apply -f ibi-managed.yaml
----

.Verification

. Check the status of the `ImageClusterInstall` in the hub cluster to monitor the progress of the target host installation by running the following command:
+
[source,terminal]
----
$ oc get imageclusterinstall
----
+
.Example output
[source,terminal]
----
NAME       REQUIREMENTSMET           COMPLETED                      CONFIGURATIONIMAGEURL                                                                                 BAREMETALHOSTREF
target-0   HostValidationSucceeded   ClusterInstallationSucceeded   https://configuration-image-url/config.iso   ibi-bmh
----
