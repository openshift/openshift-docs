// Module included in the following assembly:
//
// * declarative_clusterconfig/customizing-permissions-by-creating-aggregated-cluster-roles.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-creating-user-defined-cluster-roles-and-configuring-user-defined-permissions-for-application-controller_{context}"]
= Creating user-defined cluster roles and configuring user-defined permissions for Application Controller

[role="_abstract"]
As a cluster administrator, to add user-defined permissions to your aggregated cluster role, you must create one or more user-defined cluster roles and then configure the user-defined permissions for the Argo CD Application Controller component of a cluster-scoped Argo CD instance.

.Prerequisites

* You have enabled the creation of aggregated cluster roles for the Argo CD Application Controller component of a cluster-scoped Argo CD instance.
* You have the following default cluster roles that are created and managed by the {gitops-title} Operator:
+
** `<argocd_name>-<argocd_namespace>-argocd-application-controller` aggregated cluster role with a predefined `aggregationRule` field
** `<argocd_name>-<argocd_namespace>-argocd-application-controller-view` with predefined `view` permissions
** `<argocd_name>-<argocd_namespace>-argocd-application-controller-admin` with no predefined permissions

.Procedure

. Create a new cluster role with the required labels and permissions by using the following command:
+
[source,terminal]
----
$ oc apply -n <namespace> -f <cluster_role_name>.yaml
----
+
where:

`<namespace>`:: Specifies the name of your defined namespace.
`<cluster_role_name>`:: Specifies the name of your defined cluster role YAML file.
+
.Example user-defined cluster role YAML
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata: 
  name: user-application-controller # <1>
  labels: # <2>
    app.kubernetes.io/managed-by: spring-petclinic
    app.kubernetes.io/name: example
    app.kubernetes.io/part-of: argocd
    argocd/aggregate-to-admin: 'true'
rules: # <3>
  - verbs:
      - '*'
    apiGroups:
      - ''
    resources:
      - namespaces
      - persistentvolumeclaims
      - persistentvolumes
      - configmaps
  - verbs:
      - '*'
    apiGroups:
      - compliance.openshift.io
    resources:
      - scansettingbindings
----
<1> The name of the user-defined cluster role.
<2> The labels match the predefined list of an existing `<argocd_name>-<argocd_namespace>-argocd-application-controller-admin` cluster role.
<3> The user-defined permissions that are to be added into the aggregated cluster role through the `<argocd_name>-<argocd_namespace>-argocd-application-controller-admin` cluster role.
+
[TIP]
====
Alternatively, you can use the web console to create a user-defined cluster role from the *Administrator* perspective. You can go to *User Management* -> *Roles* -> *Create Role*, use the preceding YAML template to add permissions, and click *Create*.
====
+
.Example output
[source,terminal]
----
clusterrole.rbac.authorization.k8s.io/user-application-controller created
----
+
A user-defined cluster role is created. 

. Verify that the `<argocd_name>-<argocd_namespace>-argocd-application-controller-admin` cluster role inherits permissions from the user-defined cluster role by running the following command:
+
[source,terminal]
----
$ oc get ClusterRole/<argocd_name>-<argocd_namespace>-argocd-application-controller-admin -o yaml
----
+
where:

`<argocd_name>`:: Specifies the name of your user-defined cluster-scoped Argo CD instance.
`<argocd_namespace>`:: Specifies the namespace where Argo CD is installed.
+
.Example output
[source,terminal]
----
aggregationRule:
  clusterRoleSelectors:
  - matchLabels:
      app.kubernetes.io/managed-by: spring-petclinic
      argocd/aggregate-to-admin: "true"
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    argocds.argoproj.io/name: example
    argocds.argoproj.io/namespace: spring-petclinic
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"argoproj.io/v1beta1","kind":"ArgoCD","metadata":{"annotations":{},"name":"example","namespace":"spring-petclinic"},"spec":{"aggregatedClusterRoles":true}}
  creationTimestamp: "2024-08-14T09:59:15Z"
  labels:
    app.kubernetes.io/managed-by: spring-petclinic
    app.kubernetes.io/name: example
    app.kubernetes.io/part-of: argocd
    argocd/aggregate-to-controller: "true"
  name: example-spring-petclinic-argocd-application-controller-admin
  resourceVersion: "79202"
  uid: e2d35b6f-0832-4993-8b24-915a725454f9
rules:
- apiGroups:
  - ""
  resources:
  - namespaces
  - persistentvolumeclaims
  - persistentvolumes
  - configmaps
  verbs:
  - '*'
- apiGroups:
  - compliance.openshift.io
  resources:
  - scansettingbindings
  verbs:
  - '*'
----
+
[TIP]
====
Alternatively, you can use the {OCP} web console to verify from the *Administrator* perspective. You can go to *User Management* -> *Roles*, use the *Filter* option, select *Cluster-wide Roles*, and search for the `<argocd_name>-<argocd_namespace>-argocd-application-controller-admin` cluster role. You must open the cluster role to check the details and configurations.
====

. Verify that the `<argocd_name>-<argocd_namespace>-argocd-application-controller` aggregated cluster role inherits permissions from the `<argocd_name>-<argocd_namespace>-argocd-application-controller-admin` and `<argocd_name>-<argocd_namespace>-argocd-application-controller-view` cluster roles by running the following command:
+
[source,terminal]
----
$ oc get ClusterRole/<argocd_name>-<argocd_namespace>-argocd-application-controller -o yaml
----
+
where:

`<argocd_name>`:: Specifies the name of your user-defined cluster-scoped Argo CD instance.
`<argocd_namespace>`:: Specifies the namespace where Argo CD is installed.
+
.Example output of the aggregated cluster role
[source,terminal]
----
aggregationRule:
  clusterRoleSelectors:
  - matchLabels:
      app.kubernetes.io/managed-by: spring-petclinic
      argocd/aggregate-to-controller: "true"
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    argocds.argoproj.io/name: example
    argocds.argoproj.io/namespace: spring-petclinic
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"argoproj.io/v1beta1","kind":"ArgoCD","metadata":{"annotations":{},"name":"example","namespace":"spring-petclinic"},"spec":{"aggregatedClusterRoles":true}}
    rbac.authorization.kubernetes.io/autoupdate: "true"
  creationTimestamp: "2024-08-14T08:20:58Z"
  labels:
    app.kubernetes.io/managed-by: spring-petclinic
    app.kubernetes.io/name: example
    app.kubernetes.io/part-of: argocd
  name: example-spring-petclinic-argocd-application-controller
  resourceVersion: "79203"
  uid: aeeb2ef5-b531-4fe3-a61a-b5ad8dd8ca6e
rules:
- apiGroups:
  - ""
  resources:
  - namespaces
  - persistentvolumeclaims
  - persistentvolumes
  - configmaps
  verbs:
  - '*'
- apiGroups:
  - compliance.openshift.io
  resources:
  - scansettingbindings
  verbs:
  - '*'
- apiGroups:
  - '*'
  resources:
  - '*'
  verbs:
  - get
  - list
  - watch
- nonResourceURLs:
  - '*'
  verbs:
  - get
  - list
----
+
[TIP]
====
Alternatively, you can use the {OCP} web console to verify from the *Administrator* perspective. You can go to *User Management* -> *Roles*, use the *Filter* option, select *Cluster-wide Roles*, and search for the aggregated cluster role. You must open the cluster role to check the details and configurations.
====