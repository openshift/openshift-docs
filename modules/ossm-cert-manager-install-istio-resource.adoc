// Module included in the following assemblies:
//
// * service-mesh-docs-main/install/ossm-cert-manager-assembly.adoc

:_mod-docs-content-type: PROCEDURE
[id="install-istio-resource_{context}"]
= Install your Istio resource

//TP1 content influx. Title, etc may change.
//Content is very similar to 2.x content
//all kinds of formatting things to fix. want to see if a build will generate to have a look, and see how it fits structurally with the IA.


After you have installed `istio-csr` by following the procedure for either `InPlace` or `RevisionBased`, you can install the `Istio` resource.

You need to disable Istio's built in CA server and tell istiod to use the `istio-csr` CA server. The `istio-csr` CA server issues certificates for both istiod and user workloads.

.Procedure

. Create the `Istio` object as in the following example:
+
.Example `istio.yaml` object
[source, yaml]
----
apiVersion: sailoperator.io/v1alpha1
kind: Istio
metadata:
  name: default
spec:
  version: v1.23.0
  namespace: istio-system
  values:
    global:
      caAddress: cert-manager-istio-csr.cert-manager.svc:443
    pilot:
      env:
        ENABLE_CA_SERVER: "false"
      volumeMounts:
        - mountPath: /tmp/var/run/secrets/istiod/tls
          name: istio-csr-dns-cert
          readOnly: true
----
+
[NOTE]
====
If you followed the instructions for "istio-csr installation: RevisionBased update strategy", then you need to add the following to your `Istio` object yaml:

[source, yaml]
----
kind: Istio
metadata:
  name: default
spec:
  updateStrategy:
    type: RevisionBased
----
====

. Create the `Istio` resource using the following command:
+
[source, terminal]
----
$ oc apply -f istio.yaml
----

. Wait for `Istio` to become ready:
+
[source, terminal]
----
$ oc wait --for=condition=Ready istios/default -n istio-system
----

.Verification

Use the sample `httpbin` service and `sleep` app to check communication between the workloads is possible and to check the workload certificate of the proxy to verify that the cert-manager tool is installed correctly.

. Create the `sample` namespace:
+
[source, terminal]
----
$ oc new-project sample
----

. Find your active `IstioRevision`:
+
[source, terminal]
----
$ oc get istiorevisions
----

. Add the injection label for your active revision to the `sample` namespace:
+
[source, terminal]
----
$ oc label namespace sample istio.io/rev=<your-active-revision-name> --overwrite=true
----

. Deploy the sample `httpbin` app:
+
[source, terminal]
----
$ oc apply -n sample -f https://raw.githubusercontent.com/istio/istio/refs/heads/master/samples/httpbin/httpbin.yaml
----

. Deploy the sample `sleep` app:
+
[source, terminal]
----
$ oc apply -n sample -f https://raw.githubusercontent.com/istio/istio/refs/heads/master/samples/sleep/sleep.yaml
----

. Wait for both apps to become ready:
+
[source, terminal]
----
$ oc rollout status -n sample deployment httpbin sleep
----

. Verify that `sleep` can access the `httpbin` service:
+
[source, terminal]
----
$ oc exec "$(oc get pod -l app=sleep -n sample \
     -o jsonpath={.items..metadata.name})" -c sleep -n sample -- \
     curl http://httpbin.sample:8000/ip -s -o /dev/null \
     -w "%{http_code}\n"
----
+
.Example output
[source, terminal]
----
200
----

. Verify `httpbin` workload certificate matches what is expected:
+
[source, terminal]
----
istioctl proxy-config secret -n sample $(oc get pods -n sample -o jsonpath='{.items..metadata.name}' --selector app=httpbin) -o json | jq -r '.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes' | base64 --decode | openssl x509 -text -noout
----
+
.Example output
[source, terminal]
----
...
Issuer: O = cert-manager + O = cluster.local, CN = istio-ca
...
X509v3 Subject Alternative Name:
  URI:spiffe://cluster.local/ns/sample/sa/httpbin
----