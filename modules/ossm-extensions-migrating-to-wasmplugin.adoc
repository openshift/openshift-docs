////
This module included in the following assemblies:
*service_mesh_/v2x/ossm-extensions.adoc
////
:_content-type: PROCEDURE
[id="ossm-smextensions-migrating-to-wasmplugin_{context}"]
= Migrating to `WasmPlugin` resources

The `ServiceMeshExtension` API is deprecated as of {SMProductName} version 2.2 and will be removed in a future release. If you use it you need to migrate to the `WasmPlugin` API.

The APIs are similar, so the migration should be easy. There are two points that need attention:

== The container image format

While in the `ServiceMeshExtension` container format there must be a metadata file named `manifest.yaml` in the root of the container filesystem, it does not exist in the `WasmPlugin` container format. The `.wasm` file (the actual plugin) that previously could have any filename now must be named `plugin.wasm` and must live in the root of the container filesystem.

== The API

The new `WasmPlugin` API is quite similar to the `ServiceMeshExtensions`, with a few differences, especially in the field names:

- `spec.config` is now `spec.pluginConfig`
- `spec.workloadSelector` is now `spec.selector`
- `spec.image` is now `spec.url`
- `spec.phase` field remains the same, but the values it can hold changed slightly. Check the table 6 (`PluginPhase`) in the xref:#ossm-wasm-ref-wasmplugin_ossm-extensions[WasmPlugin API reference] above.

As an example, see below how a `ServiceMeshExtension` resource could be converted into a `WasmPlugin`:

.Old ServiceMeshExtension resource
[source,yaml]
----
apiVersion: maistra.io/v1
kind: ServiceMeshExtension
metadata:
  name: header-append
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      app: httpbin
  config:
    first-header: some-value
    another-header: another-value
  image: quay.io/maistra-dev/header-append-filter:2.2
  phase: PostAuthZ
  priority: 100
----

.New WasmPlugin resource equivalent to the ServiceMeshExtension above
[source,yaml]
----
apiVersion: extensions.istio.io/v1alpha1
kind: WasmPlugin
metadata:
  name: header-append
  namespace: istio-system
spec:
  selector:
    matchLabels:
      app: httpbin
  url: oci://quay.io/maistra-dev/header-append-filter:2.2
  phase: STATS
  pluginConfig:
    first-header: some-value
    another-header: another-value
----

[NOTE]
====
You might want to remove the old `ServiceMeshExtension` resource before creating the new `WasmPlugin` as you might get undesired results if both are active at the same time, since both plugins will be invoked for every request.
====
