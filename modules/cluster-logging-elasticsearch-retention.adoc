// Module included in the following assemblies:
//
// * logging/cluster-logging-elasticsearch.adoc

[id="cluster-logging-elasticsearch-retention_{context}"]
= Configuring Elasticsearch retention policy



You can specify how long Elasticsearch stores indices. You can set a separate _retention policy_ for each of the three log sources, infrastucture logs, application logs, and audit logs. You configure the retention policies using the Cluster Logging CR, which writes the policy to the Elasticsearch CR.

When each index reaches the defined maximums, Elasticsearch rolls over the index, deleting the current index and creating a new index. 

You can specify any of the following conditions:

* `max_age`. The maximum age that is allowed before triggering a rollover. Specify a value in days (d), hours (h), minutes (m), or seconds (s). 

* `max_docs`. The maximum number of documents allowed in an index before triggering a rollover. Documents added since the last refresh are not included in the document count. The document count does not include documents in replica shards.

* `max_size`. The maximum size the index can be before a rollover is triggered. Specify a value in bytes (b), kilobytes (kb), megabytes (mb), or gigabytes (gb). 




---
apiVersion: "logging.openshift.io/v1"
kind: "ClusterLogging"
...
spec:
  managementState: "Managed"
  logStore:
    type: "elasticsearch"
    elasticsearch:
      nodeCount: 2
    retentionPolicy: <4>
      application:
        maxAge: 1d
      infra:
        maxAge: 7d
      audit:
        maxAge: 7d

<1> maximum age that is allowed before triggering a rollover


Creates a congigmap named indexmanagement-scripts
$ oc get cm
NAME                            DATA   AGE
indexmanagement-scripts         2      103s


$ oc get cronjobs
NAME                           SCHEDULE       SUSPEND   ACTIVE   LAST SCHEDULE   AGE
elasticsearch-delete-app       */15 * * * *   False     0        <none>          27s
elasticsearch-delete-audit     */15 * * * *   False     0        <none>          27s
elasticsearch-delete-infra     */15 * * * *   False     0        <none>          27s
elasticsearch-rollover-app     */15 * * * *   False     0        <none>          27s
elasticsearch-rollover-audit   */15 * * * *   False     0        <none>          27s
elasticsearch-rollover-infra   */15 * * * *   False     0        <none>          27s


apiVersion: "logging.openshift.io/v1"
kind: "Elasticsearch"
metadata:
  name: "elasticsearch"
spec:
  indexManagement:
    policies:
    - name: infra-policy
      pollInterval: 5m
      phases:
        hot:
          actions:
            rollover:
              maxAge:   3d
        delete:
          minAge: 7d
    mappings:
    - name:  infra               #creates infra-00001 aliased infra-write
      policyRef: infra-policy         #policy applies to index patterns infra*
      aliases:
      - infra  

