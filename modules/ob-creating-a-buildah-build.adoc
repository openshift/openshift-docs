// This module is included in the following assembly:
//
// * work-with-builds/using-builds.adoc

:_mod-docs-content-type: PROCEDURE
[id="ob-creating-a-buildah-build_{context}"]
= Creating a buildah build

You can create a `buildah` build and push the created image to the target registry.

.Prerequisites

* You have installed the {builds-operator} on the {ocp-product-title} cluster.
* You have created a `ShipwrightBuild` resource.
* You have installed the `oc` CLI.
* Optional: You have installed the link:https://developers.redhat.com/content-gateway/rest/browse/pub/openshift-v4/clients/openshift-builds/1.0.1-222/[`shp` CLI].

.Procedure

. Create a `Build` resource and apply it to the {ocp-product-title} cluster by using one of the CLIs:
+
.Example: Using `oc` CLI
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: Build
metadata:
  name: buildah-golang-build
spec:
  source: <1>
    git:
      url: https://github.com/shipwright-io/sample-go
    contextDir: docker-build
  strategy: <2>
    name: buildah
    kind: ClusterBuildStrategy
  paramValues: <3>
  - name: dockerfile
    value: Dockerfile
  output: <4>
    image: image-registry.openshift-image-registry.svc:5000/buildah-example/sample-go-app
EOF
----
<1> The location where the source code is placed.
<2> The build strategy that you use to build the container.
<3> The parameter defined in the build strategy. To set the value of the `dockerfile` strategy parameter, specify the Dockerfile location required to build the output image.
<4> The location where the built image is pushed. In this procedural example, the built image is pushed to the {ocp-product-title} cluster internal registry. `buildah-example` is the name of the current project. Ensure that the specified project exists to allow the image push.

+
.Example: Using `shp` CLI
[source,terminal]
----
$ shp build create buildah-golang-build \
--source-url="https://github.com/shipwright-io/sample-go" --source-context-dir="docker-build" \// <1>
--strategy-name="buildah" \// <2>
--dockerfile="Dockerfile" \// <3>
--output-image="image-registry.openshift-image-registry.svc:5000/buildah-example/go-app" <4>
----
<1> The location where the source code is placed.
<2> The build strategy that you use to build the container.
<3> The parameter defined in the build strategy. To set the value of the `dockerfile` strategy parameter, specify the Dockerfile location required to build the output image.
<4> The location where the built image is pushed. In this procedural example, the built image is pushed to the {ocp-product-title} cluster internal registry. `buildah-example` is the name of the current project. Ensure that the specified project exists to allow the image push.

. Check if the `Build` resource is created by using one of the CLIs:
+
.Example: Using `oc` CLI
[source,terminal]
----
$ oc get builds.shipwright.io buildah-golang-build
----
+
.Example: Using `shp` CLI
[source,terminal]
----
$ shp build list
----

. Create a `BuildRun` resource and apply it to the {ocp-product-title} cluster by using one of the CLIs:
+
.Example: Using `oc` CLI
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: BuildRun
metadata:
  name: buildah-golang-buildrun
spec:
  build:
    name: buildah-golang-build <1>
EOF
----
<1> The `spec.build.name` field denotes the respective build to run, which is expected to be available in the same namespace.
+
.Example: Using `shp` CLI
[source,terminal]
----
$ shp build run buildah-golang-build --follow <1>
----
<1> Optional: By using the `--follow` flag, you can view the build logs in the output result.

. Check if the `BuildRun` resource is created by using one of the CLIs:
+
.Example: Using `oc` CLI
[source,terminal]
----
$ oc get buildrun buildah-golang-buildrun
----
+
.Example: Using `shp` CLI
[source,terminal]
----
$ shp buildrun list
----
+
The `BuildRun` resource creates a `TaskRun` resource, which then creates the pods to execute build strategy steps.

.Verification

. After all the containers complete their tasks, verify the following:
+
* Check whether the pod shows the `STATUS` field as `Completed`:
+
[source,terminal]
----
$ oc get pods -w
----
+
.Example output
[source,terminal]
----
NAME                                READY   STATUS    RESTARTS   AGE
buildah-golang-buildrun-dtrg2-pod   2/2     Running   0          4s
buildah-golang-buildrun-dtrg2-pod   1/2     NotReady  0          7s
buildah-golang-buildrun-dtrg2-pod   0/2     Completed 0          55s
----
+
* Check whether the respective `TaskRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get tr
----
+
.Example output
[source,terminal]
----
NAME                           SUCCEEDED  REASON     STARTTIME   COMPLETIONTIME
buildah-golang-buildrun-dtrg2  True       Succeeded  11m         8m51s
----
+
* Check whether the respective `BuildRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get br
----
+
.Example output
[source,terminal]
----
NAME                     SUCCEEDED   REASON       STARTTIME     COMPLETIONTIME
buildah-golang-buildrun  True        Succeeded    13m           11m
----
+
During verification, if a build run fails, you can check the `status.failureDetails` field in your `BuildRun` resource to identify the exact point where the failure happened in the pod or container.
+
[NOTE]
====
The pod might switch to a `NotReady` state because one of the containers has completed its task. This is an expected behavior.
====

. Validate whether the image has been pushed to the registry that is specified in the `build.spec.output.image` field. You can try to pull the image by running the following command from a node that can access the internal registry:
+
[source,terminal]
----
$ podman pull image-registry.openshift-image-registry.svc:5000/<project>/<image> <1>
----
<1> The project name and image name used when creating the `Build` resource. For example, you can use `buildah-example` as the project name and `sample-go-app` as the image name.