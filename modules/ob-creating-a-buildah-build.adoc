// This module is included in the following assembly:
//
// * work-with-builds/using-builds.adoc

:_mod-docs-content-type: PROCEDURE
[id="ob-creating-a-buildah-build_{context}"]
= Creating a buildah build

[role="_abstract"]
Use a `buildah` build strategy to build and push a container image using a Dockerfile.

.Prerequisites

* You have installed the {builds-operator} on the {ocp-product-title} cluster.
* You have installed the `oc` CLI.
* Optional: You have installed the link:https://console.redhat.com/openshift/downloads[`shp` CLI].

.Procedure

. Create a `Build` resource and apply it to the {ocp-product-title} cluster. You can 
do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: Build
metadata:
  name: buildah-golang-build
spec:
  source:
    type: Git
    git:
      url: https://github.com/shipwright-io/sample-go
    contextDir: docker-build
  strategy:
    name: buildah
    kind: ClusterBuildStrategy
  paramValues:
  - name: dockerfile
    value: Dockerfile
  output:
    image: image-registry.openshift-image-registry.svc:5000/buildah-example/sample-go-app
EOF
----
+
--
where:

`source`:: Defines the location where the source code is placed.
`strategy`:: Defines the build strategy that you use to build the container.
`paramValues`:: Defines the parameter defined in the build strategy. To set the value of the `dockerfile` strategy parameter, specify the Dockerfile location required to build the output image.
`output`:: Defines the location where the built image is pushed. In this procedural example, the built image is pushed to the {ocp-product-title} cluster internal registry. `buildah-example` is the name of the current project. Ensure that the specified project exists to allow the image push.
--

+
[source,terminal]
----
$ shp build create buildah-golang-build \
--source-url="https://github.com/redhat-openshift-builds/samples" 
--source-context-dir="buildah-build" \
--strategy-name="buildah" \
--dockerfile="Dockerfile" \
--output-image="image-registry.openshift-image-registry.svc:5000/buildah-example/go-app"
----
+
where:

`source-context-dir`:: Defines the location where the source code is placed.
`strategy-name`:: Defines the build strategy that you use to build the container.
`dockerfile`:: Defines the parameter defined in the build strategy. To set the value of the `dockerfile` strategy parameter, specifies the Dockerfile location required to build the output image.
`output-image`:: Defines the location where the built image is pushed. In this procedural example, the built image is pushed to the {ocp-product-title} cluster internal registry. `buildah-example` is the name of the current project. Ensure that the specified project exists to allow the image push.

. Check if the `Build` resource is created. You can do so by using the `oc` command or 
the `shp` command:
+
[source,terminal]
----
$ oc get builds.shipwright.io buildah-golang-build
----

+
[source,terminal]
----
$ shp build list
----

. Create a `BuildRun` resource and apply it to the {ocp-product-title} cluster. You can do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: BuildRun
metadata:
  name: buildah-golang-buildrun
spec:
  build:
    name: buildah-golang-build
EOF
----
+
where:

`spec.build.name`:: Defines the build to run, which is expected to be available in the same namespace.

+
[source,terminal]
----
$ shp build run buildah-golang-build --follow
----
* `--follow`:: (Optional) Use the `--follow` flag to view the build logs in the output result.

. Check if the `BuildRun` resource is created. You can do so by using the `oc` command or 
the `shp` command:
+
[source,terminal]
----
$ oc get buildrun buildah-golang-buildrun
----

+
[source,terminal]
----
$ shp buildrun list
----
+
The `BuildRun` resource creates a `TaskRun` resource, which then creates the pods to execute build strategy steps.

.Verification

After all the containers complete their tasks, verify the following resources:

. Check whether the pod shows the `STATUS` field as `Completed`:
+
[source,terminal]
----
$ oc get pods -w
----
+
Example output:
+
[source,terminal]
----
NAME                                READY   STATUS    RESTARTS   AGE
buildah-golang-buildrun-dtrg2-pod   2/2     Running   0          4s
buildah-golang-buildrun-dtrg2-pod   1/2     NotReady  0          7s
buildah-golang-buildrun-dtrg2-pod   0/2     Completed 0          55s
----

. Check whether the respective `TaskRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get tr
----
+
Example output:
+
[source,terminal]
----
NAME                           SUCCEEDED  REASON     STARTTIME   COMPLETIONTIME
buildah-golang-buildrun-dtrg2  True       Succeeded  11m         8m51s
----

. Check whether the respective `BuildRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get br
----
+
Example output:
+
[source,terminal]
----
NAME                     SUCCEEDED   REASON       STARTTIME     COMPLETIONTIME
buildah-golang-buildrun  True        Succeeded    13m           11m
----

. During verification, if a build run fails, you can check the `status.failureDetails` field in your `BuildRun` resource to identify the exact point where the failure happened in the pod or container.
+
[NOTE]
====
The pod might switch to a `NotReady` state because one of the containers has completed its task. This is an expected behavior.
====

. Validate whether the image has been pushed to the registry that is specified in the `build.spec.output.image` field. Run the following command to pull the image from a node that can access the internal registry:
+
[source,terminal]
----
$ podman manifest inspect image-registry.openshift-image-registry.svc:5000/buildah-example/taxi-app
----
+
In the previous example, the project name is `buildah-example`, and the image name is `taxi-app`.
+
Example output:
+
[source,terminal]
----
   "schemaVersion": 2,
    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
    "manifests": [
        {
            "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
            "size": 594,
            "digest": "sha256:6a05100e302c86c03fec6277f4b3107f1fdde6c69d3ca9a4207e4735a5213e32",
            "platform": {
                "architecture": "amd64",
                "os": "linux"
            }
     ]
----