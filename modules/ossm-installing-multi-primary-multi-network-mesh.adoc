// This procedure is used in the following assembly:
// * install/ossm-multi-cluster-topologies.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-installing-multi-primary-multi-network-mesh_{context}"]
= Installing a multi-primary multi-network mesh

[role="_abstract"]
Install {istio} in the multi-primary multi-network topology on two {ocp-product-title} clusters.

[NOTE]
====
In this procedure, `CLUSTER1` is the East cluster and `CLUSTER2` is the West cluster.
====

You can adapt these instructions for a mesh spanning more than two clusters.

.Prerequisites

* You have installed the {SMProduct} 3 Operator on all of the clusters that include the mesh.

* You have created certificates for the multi-cluster mesh.

* You have applied certificates to the multi-cluster topology.

* You have created an {istio} Container Network Interface (CNI) resource.

* You have `istioctl` installed.

[IMPORTANT]
====
In on-premise environments, such as those running on bare metal, {ocp-product-title} clusters often do not include a native load-balancer capability. A service of type `LoadBalancer`, such as the `istio-eastwestgateway`, will not automatically be assigned an external IP address.
To ensure the required external IP assignment for cross-cluster communication, cluster administrators must install and configure the MetalLB Operator.
MetalLB is valuable in bare metal or bare metal-like infrastructures when fault-tolerant access to an application via an external IP address is necessary. Once deployed, MetalLB provides a platform-native load balancer.
In addition to bare metal, the MetalLB Operator can offer load balancing for installations on other infrastructures that might lack native load-balancer capability, including:

* VMware vSphere

* IBM Z® and IBM® LinuxONE

* IBM Z® and IBM® LinuxONE for Red Hat Enterprise Linux (RHEL) KVM

* IBM Power®

For more information, see link:https://docs.redhat.com/en/documentation/openshift_container_platform/latest/html/networking_operators/metallb-operator[MetalLB Operator].
====


.Procedure

. Create an `ISTIO_VERSION` environment variable that defines the {istio} version to install by running the following command:
+
[source,terminal]
----
$ export ISTIO_VERSION=1.24.3
----

. Install {istio} on the East cluster:

.. Create an `Istio` resource on the East cluster by running the following command:
+
[source,terminal]
----
$ cat <<EOF | oc --context "${CTX_CLUSTER1}" apply -f -
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: default
spec:
  version: v${ISTIO_VERSION}
  namespace: istio-system
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster1
      network: network1
EOF
----

.. Wait for the control plane to return the `Ready` status condition by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER1}" wait --for condition=Ready istio/default --timeout=3m
----

.. Create an East-West gateway on the East cluster by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER1}" apply -f https://raw.githubusercontent.com/istio-ecosystem/sail-operator/main/docs/deployment-models/resources/east-west-gateway-net1.yaml
----

.. Expose the services through the gateway by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER1}" apply -n istio-system -f https://raw.githubusercontent.com/istio-ecosystem/sail-operator/main/docs/deployment-models/resources/expose-services.yaml
----

. Install {istio} on the West cluster:

.. Create an `Istio` resource on the West cluster by running the following command:
+
[source,terminal]
----
$ cat <<EOF | oc --context "${CTX_CLUSTER2}" apply -f -
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: default
spec:
  version: v${ISTIO_VERSION}
  namespace: istio-system
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster2
      network: network2
EOF
----

.. Wait for the control plane to return the `Ready` status condition by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER2}" wait --for condition=Ready istio/default --timeout=3m
----

.. Create an East-West gateway on the West cluster by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER2}" apply -f https://raw.githubusercontent.com/istio-ecosystem/sail-operator/main/docs/deployment-models/resources/east-west-gateway-net2.yaml
----

.. Expose the services through the gateway by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER2}" apply -n istio-system -f https://raw.githubusercontent.com/istio-ecosystem/sail-operator/main/docs/deployment-models/resources/expose-services.yaml
----

. Create the `istio-reader-service-account` service account for the East cluster by running the following command:
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER1}" create serviceaccount istio-reader-service-account -n istio-system
----

. Create the `istio-reader-service-account` service account for the West cluster by running the following command:
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER2}" create serviceaccount istio-reader-service-account -n istio-system 
----

. Add the `cluster-reader` role to the East cluster by running the following command: 
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER1}" adm policy add-cluster-role-to-user cluster-reader -z istio-reader-service-account -n istio-system
----

. Add the `cluster-reader` role to the West cluster by running the following command: 
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER2}" adm policy add-cluster-role-to-user cluster-reader -z istio-reader-service-account -n istio-system
----

. Install a remote secret on the East cluster that provides access to the API server on the West cluster by running the following command:
+
[source,terminal]
----
$ istioctl create-remote-secret \
  --context="${CTX_CLUSTER2}" \
  --name=cluster2 \
  --create-service-account=false | \
  oc --context="${CTX_CLUSTER1}" apply -f - 
----

. Install a remote secret on the West cluster that provides access to the API server on the East cluster by running the following command:
+
[source,terminal]
----
$ istioctl create-remote-secret \
  --context="${CTX_CLUSTER1}" \
  --name=cluster1 \
  --create-service-account=false | \
  oc --context="${CTX_CLUSTER2}" apply -f -  
----