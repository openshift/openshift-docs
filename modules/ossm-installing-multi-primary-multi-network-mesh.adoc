// This procedure is used in the following assembly:
// * install/ossm-multi-cluster-topologies.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-installing-multi-primary-multi-network-mesh_{context}"]
= Installing a multi-primary multi-network mesh

Install {istio} in the multi-primary multi-network topology on two {ocp-product-title} clusters.

[NOTE]
====
In this procedure, `CLUSTER1` is the East cluster and `CLUSTER2` is the West cluster.
====

You can adapt these instructions for a mesh spanning more than two clusters.

.Prerequisites

* You have installed the {SMProduct} 3 Operator on all of the clusters that comprise the mesh.

* You have completed "Creating certificates for a multi-cluster mesh".

* You have completed "Applying certificates to a multi-cluster topology".

* You have created an {istio} Container Network Interface (CNI) resource.

* You have `istioctl` installed on the laptop you can use to run these instructions.

.Procedure

. Create an `ISTIO_VERSION` environment variable that defines the {istio} version to install by running the following command:
+
[source,terminal]
----
$ export ISTIO_VERSION=1.24.3
----

. Install {istio} on the East cluster:

.. Create an `Istio` resource on the East cluster by running the following command:
+
[source,terminal]
----
$ cat <<EOF | oc --context "${CTX_CLUSTER1}" apply -f -
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: default
spec:
  version: v${ISTIO_VERSION}
  namespace: istio-system
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster1
      network: network1
EOF
----

.. Wait for the control plane to return the `Ready` status condition by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER1}" wait --for condition=Ready istio/default --timeout=3m
----

.. Create an East-West gateway on the East cluster by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER1}" apply -f https://raw.githubusercontent.com/istio-ecosystem/sail-operator/main/docs/multicluster/east-west-gateway-net1.yaml
----

.. Expose the services through the gateway by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER1}" apply -n istio-system -f https://raw.githubusercontent.com/istio-ecosystem/sail-operator/main/docs/multicluster/expose-services.yaml
----

. Install {istio} on the West cluster:

.. Create an `Istio` resource on the West cluster by running the following command:
+
[source,terminal]
----
$ cat <<EOF | oc --context "${CTX_CLUSTER2}" apply -f -
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: default
spec:
  version: v${ISTIO_VERSION}
  namespace: istio-system
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster2
      network: network2
EOF
----

.. Wait for the control plane to return the `Ready` status condition by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER2}" wait --for condition=Ready istio/default --timeout=3m
----

.. Create an East-West gateway on the West cluster by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER2}" apply -f https://raw.githubusercontent.com/istio-ecosystem/sail-operator/main/docs/multicluster/east-west-gateway-net2.yaml
----

.. Expose the services through the gateway by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER2}" apply -n istio-system -f https://raw.githubusercontent.com/istio-ecosystem/sail-operator/main/docs/multicluster/expose-services.yaml
----

. Create the `istio-reader-service-account` service account for the East cluster by running the following command:
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER1}" create serviceaccount istio-reader-service-account -n istio-system
----

. Create the `istio-reader-service-account` service account for the West cluster by running the following command:
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER2}" create serviceaccount istio-reader-service-account -n istio-system 
----

. Add the `cluster-reader` role to the East cluster by running the following command: 
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER1}" adm policy add-cluster-role-to-user cluster-reader -z istio-reader-service-account -n istio-system
----

. Add the `cluster-reader` role to the West cluster by running the following command: 
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER2}" adm policy add-cluster-role-to-user cluster-reader -z istio-reader-service-account -n istio-system
----

. Install a remote secret on the East cluster that provides access to the API server on the West cluster by running the following command:
+
[source,terminal]
----
$ istioctl create-remote-secret \
  --context="${CTX_CLUSTER2}" \
  --name=cluster2 \
  --create-service-account=false | \
  oc --context="${CTX_CLUSTER1}" apply -f - 
----

. Install a remote secret on the West cluster that provides access to the API server on the East cluster by running the following command:
+
[source,terminal]
----
$ istioctl create-remote-secret \
  --context="${CTX_CLUSTER1}" \
  --name=cluster1 \
  --create-service-account=false | \
  oc --context="${CTX_CLUSTER2}" apply -f -  
----
