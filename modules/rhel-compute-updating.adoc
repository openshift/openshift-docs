// Module included in the following assemblies:
//
// * updating/updating-cluster-rhel-compute.adoc

[id="rhel-compute-updating-minor_{context}"]
= Updating {op-system-base} compute machines in your cluster

After you update your cluster, you must update the {op-system-base-full} compute machines in your cluster.

[IMPORTANT]
====
{op-system-base-full} version 7.9 and version 8.4 is supported for {op-system-base} worker (compute) machines.
====

You can also update your compute machines to another minor version of {product-title} if you are using {op-system-base} as the operating system. You do not need to exclude any RPM packages from {op-system-base} when performing a minor version update.

[IMPORTANT]
====
You cannot upgrade {op-system-base} 7 compute machines to {op-system-base} 8. You must deploy new {op-system-base} 8 hosts, and the old {op-system-base} 7 hosts should be removed.
====

// TODO: This module needs to be updated to reflect RHEL 8 compute machines in 4.10. Because initial support for RHEL 8 starts in 4.9, and upgrading RHEL 7 -> 8 in-place is not supported, this is being left to reflect RHEL 7 upgrades.

.Prerequisites

* You updated your cluster.
+
[IMPORTANT]
====
Because the {op-system-base} machines require assets that are generated by the cluster to complete the update process, you must update the cluster before you update the {op-system-base} worker machines in it.
====

* You have access to the local machine that you used to add the {op-system-base} compute machines to your cluster. You must have access to the `hosts` Ansible inventory file that defines your {op-system-base} machines and the `upgrade` playbook.

* For updates to a minor version, the RPM repository is using the same version of {product-title} that is running on your cluster.

.Procedure

. Stop and disable firewalld on the host:
+
[source,terminal]
----
# systemctl disable --now firewalld.service
----
+
[NOTE]
====
By default, the base OS RHEL with "Minimal" installation option enables firewalld serivce.  Having the firewalld service enabled on your host prevents you from accessing {product-title} logs on the worker. Do not enable firewalld later if you wish to continue accessing {product-title} logs on the worker.
====

. Enable the repositories that are required for {product-title} {product-version}:
.. On the machine that you run the Ansible playbooks, update the required repositories:
+
[source,terminal]
----
# subscription-manager repos --disable=rhel-7-server-ose-4.8-rpms \
                             --enable=rhel-7-server-ansible-2.9-rpms \
                             --enable=rhel-7-server-ose-4.9-rpms
----

.. On the machine that you run the Ansible playbooks, update the required packages, including `openshift-ansible`:
+
[source,terminal]
----
# yum update openshift-ansible openshift-clients
----

.. On each {op-system-base} compute node, update the required repositories:
+
[source,terminal]
----
# subscription-manager repos --disable=rhel-7-server-ose-4.8-rpms \
                             --enable=rhel-7-server-ose-4.9-rpms  \
                             --enable=rhel-7-fast-datapath-rpms   \
                             --enable=rhel-7-server-optional-rpms
----

. Update a {op-system-base} worker machine:
.. Review the current node status to determine which {op-system-base} worker to update:
+
[source,terminal]
----
# oc get node
----
+
.Example output
[source,terminal]
----
NAME                        STATUS                        ROLES    AGE    VERSION
mycluster-control-plane-0   Ready                         master   145m   v1.22.1
mycluster-control-plane-1   Ready                         master   145m   v1.22.1
mycluster-control-plane-2   Ready                         master   145m   v1.22.1
mycluster-rhel7-0           NotReady,SchedulingDisabled   worker   98m    v1.22.1
mycluster-rhel7-1           Ready                         worker   98m    v1.22.1
mycluster-rhel7-2           Ready                         worker   98m    v1.22.1
mycluster-rhel7-3           Ready                         worker   98m    v1.22.1
----
+
Note which machine has the `NotReady,SchedulingDisabled` status.

.. Review your Ansible inventory file at `/<path>/inventory/hosts` and update its contents so that only the machine with the `NotReady,SchedulingDisabled` status is listed in the `[workers]` section, as shown in the following example:
+
----
[all:vars]
ansible_user=root
#ansible_become=True

openshift_kubeconfig_path="~/.kube/config"

[workers]
mycluster-rhel7-0.example.com
----

.. Change to the `openshift-ansible` directory:
+
[source,terminal]
----
$ cd /usr/share/ansible/openshift-ansible
----

.. Run the `upgrade` playbook:
+
[source,terminal]
----
$ ansible-playbook -i /<path>/inventory/hosts playbooks/upgrade.yml <1>
----
<1> For `<path>`, specify the path to the Ansible inventory file that you created.
+
[NOTE]
====
The `upgrade` playbook only upgrades the {product-title} packages. It does not update the operating system packages.
====
+
. Follow the process in the previous step to update each {op-system-base} worker machine in your cluster.

. After you update all of the workers, confirm that all of your cluster nodes have updated to the new version:
+
[source,terminal]
----
# oc get node
----
+
.Example output
[source,terminal]
----
NAME                        STATUS                        ROLES    AGE    VERSION
mycluster-control-plane-0   Ready                         master   145m   v1.22.1
mycluster-control-plane-1   Ready                         master   145m   v1.22.1
mycluster-control-plane-2   Ready                         master   145m   v1.22.1
mycluster-rhel7-0           NotReady,SchedulingDisabled   worker   98m    v1.22.1
mycluster-rhel7-1           Ready                         worker   98m    v1.22.1
mycluster-rhel7-2           Ready                         worker   98m    v1.22.1
mycluster-rhel7-3           Ready                         worker   98m    v1.22.1
----
. Optional: Update the operating system packages that were not updated by the `upgrade` playbook. To update packages that are not on {product-version}, use the following command:
+
[source,terminal]
----
# yum update
----
+
[NOTE]
====
You do not need to exclude RPM packages if you are using the same RPM repository that you used when you installed {product-version}.
====
