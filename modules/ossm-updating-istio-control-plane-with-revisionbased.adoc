// Module included in the following assemblies:
// update/ossm-updating-openshift-service-mesh.adoc

:_mod-docs-content-type: PROCEDURE
[id="updating-istio-control-plane-with-revisionbased_{context}"]
= Updating Istio control plane with RevisionBased strategy

When updating {istio} using the `RevisionBased` strategy, you can upgrade by more than one minor version at a time. The {SMProductName} Operator creates a new `IstioRevision` resource for each change to the `.spec.version` field and deploys a corresponding control plane instance. To migrate workloads to the new control plane, set the `istio.io/rev` label on the namespace to match the name of the `IstioRevision` resource, and then restart the workloads.

.Prerequisites

* You are logged in to {ocp-product-title} as a user with the `cluster-admin` role.
* You have installed the {SMProductName} Operator 3, and deployed {istio} with the `RevisionBased` strategy. In this example, the `{istio}` resource named `default` is deployed in the `istio-system` namespace.
* You have installed the {istio} CNI plugin with the desired version. In this example, the `IstioCNI` resource named `default` is deployed in the `istio-cni` namespace.
* You have labeled the `bookinfo` namespace to enable sidecar injection.
* You have application workloads running in the cluster. In this example, the `bookinfo` application is deployed in the `bookinfo` namespace.
* You have installed `istioctl` on your local machine.

.Procedure

. Change the version in the `{istio}` resource. For example, to update to {istio} `1.24.4`, set the `spec.version` field to `v1.24.4` by running the following command:
+
[source,terminal]
----
$ oc patch istio default --type='merge' -p '{"spec":{"version":"v1.24.4"}}'
----
+
.Version Update in {istio} CR
+
[source,yaml]
----
kind: Istio
spec:
  version: v1.24.4
  updateStrategy:
    type: RevisionBased
----
+
The {SMProductShortName} Operator deploys a new version of the control plane alongside the old version of the control plane. The sidecars remain connected to the old control plane.

. Confirm that both `{istio}` and `IstioRevision` resources are ready with the new revision.

.. Confirm that `{istio}` resource is ready by running the following command:
+
[source,terminal]
----
$ oc get istio
----
+
.Example output
+
[source,terminal]
----
NAME      REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
default   2           2       1        default-v1-2-4   Healthy   v1.24.4   9m23s
----

.. Confirm that `IstioRevision` resource is ready by running the following command:
+
[source,terminal]
----
$ oc get istiorevision
----
+
.Example output
+
[source,terminal]
----
NAME              TYPE    READY   STATUS    IN USE   VERSION   AGE
default-v1-24-3   Local   True    Healthy   True     v1.24.3   10m
default-v1-24-4   Local   True    Healthy   False    v1.24.4   66s
----

. Confirm that there are two control plane pods running, one for each revision by running the following command:
+
[source,terminal]
----
$ oc get pods -n istio-system
----
+
.Example output
+
[source,terminal]
----
NAME                                      READY   STATUS    RESTARTS   AGE
istiod-default-v1-24-3-c98fd9675-r7bfw    1/1     Running   0          10m
istiod-default-v1-24-4-7495cdc7bf-v8t4g   1/1     Running   0          113s
----

. Confirm that the workload sidecars are still connected to the previous control plane by running the following command:
+
[source,terminal]
----
$ istioctl proxy-status
----
+
.Example output
+
[source,terminal]
----
NAME                                                    CLUSTER        CDS                LDS                EDS                RDS                ECDS        ISTIOD                                     VERSION
details-v1-7d775cb4f6-5t9zm.bookinfo                    Kubernetes     SYNCED (2m25s)     SYNCED (2m25s)     SYNCED (2m17s)     SYNCED (2m25s)     IGNORED     istiod-default-v1-24-3-c98fd9675-r7bfw     1.24.3
productpage-v1-7c4b6b857-mxrw6.bookinfo                 Kubernetes     SYNCED (2m35s)     SYNCED (2m35s)     SYNCED (2m17s)     SYNCED (2m35s)     IGNORED     istiod-default-v1-24-3-c98fd9675-r7bfw     1.24.3
ratings-v1-5b896f8544-r552l.bookinfo                    Kubernetes     SYNCED (2m21s)     SYNCED (2m21s)     SYNCED (2m17s)     SYNCED (2m21s)     IGNORED     istiod-default-v1-24-3-c98fd9675-r7bfw     1.24.3
reviews-v1-746f96c9d4-9pw8k.bookinfo                    Kubernetes     SYNCED (2m17s)     SYNCED (2m17s)     SYNCED (2m17s)     SYNCED (2m17s)     IGNORED     istiod-default-v1-24-3-c98fd9675-r7bfw     1.24.3
reviews-v2-97bdf5876-4mzx5.bookinfo                     Kubernetes     SYNCED (2m35s)     SYNCED (2m35s)     SYNCED (2m17s)     SYNCED (2m35s)     IGNORED     istiod-default-v1-24-3-c98fd9675-r7bfw     1.24.3
reviews-v3-77d9db6844-djgjk.bookinfo                    Kubernetes     SYNCED (2m19s)     SYNCED (2m19s)     SYNCED (2m17s)     SYNCED (2m19s)     IGNORED     istiod-default-v1-24-3-c98fd9675-r7bfw     1.24.3
----
+
The `VERSION` column should match the old control plane version.

. Move the workloads to the new control plane by updating the `istio.io/rev` label on the application namespace or pods to the revision name. For example, update the label for the entire namespace by running the following command:
+
[source,terminal]
----
$ oc label namespace bookinfo istio.io/rev=<new_revision_name> --overwrite
----

. Restart the application workloads so that the new version of the sidecar gets injected by running the following command:
+
[source,terminal]
----
$ oc rollout restart deployment -n bookinfo
----

.Verification

. Verify that the new version of the sidecar is running by entering the following command:
+
[source,terminal]
----
$ istioctl proxy-status
----
+
The `VERSION` column should match the new control plane version.

. Verify that the old control plane, `{istio}`, and `IstioRevision` resources has been deleted.

.. Verify that the old control plane has beend deleted by running the following command:
+
[source,terminal]
----
$ oc get pods -n istio-system
----

.. Verify that the `{istio}` resource has been deleted by running the following command:
+
[source,terminal]
----
$ oc get istio
----

.. Verify that the `IstioRevision` resource has been deleted by running the following command:
+
[source,terminal]
----
$ oc get istiorevision
----

The {SMProduct} Operator deletes the old `IstioRevision` resource and the associated control plane after the grace period defined in the `spec.updateStrategy.inactiveRevisionDeletionGracePeriodSeconds` field expires. The default grace period is 30 seconds.

You can increase the grace period to allow sufficient time to test the new control plane before removing the previous revision. Set a higher value during canary upgrades to ensure workload stability before fully transitioning.