// Module included in the following assemblies:
//
// * logging/efk-logging-manual-rollout.adoc

[id='efk-logging-manual-rollout-full-{context}']
= Performing an Elasticsearch full cluster restart

A full restart is recommended when changing major versions of Elasticsearch or
other changes which might put data integrity a risk during the change process.

[NOTE]
====
Any action you do for an ES cluster will need to be repeated for the ops cluster
if `openshift_logging_use_ops` was configured to be `True`.
====

[NOTE]
====
When making changes to the `logging-es-ops` service use components
"es-ops-blocked" and "es-ops" instead in the patch
====

. Disable all external communications to the ES cluster while it is down. Edit
your non-cluster logging service (for example, `logging-es`, `logging-es-ops`)
to no longer match the ES pods running:
+
----
$  oc patch svc/logging-es -p '{"spec":{"selector":{"component":"es-blocked","provider":"openshift"}}}'
----

. Perform a shard synced flush to ensure there are no pending operations waiting
to be written to disk prior to shutting down:
+
----
$ oc exec -c elasticsearch <any_es_pod_in_the_cluster> --
          curl -s
          --cacert /etc/elasticsearch/secret/admin-ca \
          --cert /etc/elasticsearch/secret/admin-cert \
          --key /etc/elasticsearch/secret/admin-key \
          -XPOST 'https://localhost:9200/_flush/synced'
----

. Prevent shard balancing when purposely bringing down nodes:
+
----
$ oc exec -c elasticsearch <any_es_pod_in_the_cluster> --
          curl -s
          --cacert /etc/elasticsearch/secret/admin-ca \
          --cert /etc/elasticsearch/secret/admin-cert \
          --key /etc/elasticsearch/secret/admin-key \
          -XPUT 'https://localhost:9200/_cluster/settings' \
          -d '{ "transient": { "cluster.routing.allocation.enable" : "none" } }'
----

. Once complete, for each `dc` you have for an ES cluster, scale down all replicas:
+
----
$ oc scale dc <dc_name> --replicas=0
----

. Once scale down is complete, for each `dc` you have for an ES cluster, run
`oc rollout latest` to deploy the latest version of the `dc` object:
+
----
$ oc rollout latest <dc_name>
----
+
You will see a new pod deployed. Once the pod has two ready containers, you can
move on to the next `dc`.

. Once deployment is complete, for each `dc` you have for an ES cluster, scale up
replicas:
+
----
$ oc scale dc <dc_name> --replicas=1
----

. Once the scale up is complete, enable all external communications to the ES
cluster. Edit your non-cluster logging service (for example, `logging-es`,
`logging-es-ops`) to match the ES pods running again:
+
----
$ oc patch svc/logging-es -p '{"spec":{"selector":{"component":"es","provider":"openshift"}}}'
----
