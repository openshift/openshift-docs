// Module included in the following assemblies:

// * service-mesh-docs-main/migrating/cluster-wide/ossm-migrating-cluster-wide-assembly.adoc

:_mod-docs-content-type: CONCEPT
[id="ossm-about-cluster-wide-migration_{context}"]
= Control plane configuration migration requirements

During the migration process, two cluster-wide control planes run in the same cluster while the data plane namespaces are gradually migrated to the {SMProductName} 3.0 installation. One control plane is associated with the {SMProductName} {SMv2Version} installation and the other is associated with the {SMProduct} 3.0 installation. You must carefully plan out the migration steps to avoid possible conflicts between the two control planes.

[id="ossm-cluster-wide-migration-root-certificate_{context}"]
== Root certificate

During the migration, both control planes must share a root certificate. This can be achieved by installing the 3.0 control plane into the same namespace as 2.6 control plane. The migration procedures show how to verify that the root certificate is shared.

[id="ossm-cluster-wide-migration-discovery-selectors_{context}"]
== Discovery selectors and namespace access

Both control planes must have access to all namespaces in the mesh. During the migration, some proxies are controlled by the 3.0 control plane while other proxies remain controlled by the 2.6 control plane. To ensure that mesh communication works during the migration, both control planes must be aware of the same set of services. Service discovery is provided by `istiod` component, which runs in the control plane namespace.

In the {SMProduct} 3.0 installation, you can control how {istio} discovers services by using discovery selectors. When using discovery selectors, ensure that the `discoverySelectors` expression that is defined in the {SMProduct} 3.0 {istio} resource match the namespaces that comprise the {SMProduct} 2.6 mesh. You might have to add additional labels to the {SMProduct} 2.6 application namespaces to ensure that they are captured in the {SMProduct} 3.0 installation. For more information, see "Scoping the service mesh with DiscoverySelectors".

[NOTE]
====
In {SMProduct} 2.6 installations, the `maistra.io/member-of` label is automatically created. This label cannot be used because it is automatically removed during the migration process.
====

[id="ossm-cluster-wide-migration-network-policies_{context}"]
== Network policies

By default, {SMProduct} 2.6 manages network policies that block traffic to the 3.0 control plane. 

For both control planes, during the migration ensure that network policies do not block traffic:

* Between the control plane and the data plane namespaces
* Between the data plane namespaces and the control plane
* Between the data plane namespaces themselves

In the premigration checklist, you are instructed to disable network policies. However, you can manually re-create them. Manually created network policies must allow traffic for both control planes. When a data plane namespace is migrated to 3.0, the `maistra.io/member-of` label is automatically removed. Do not use this label in network policies. For more information, see "Migration of Network Policies".

[NOTE]
====
Incorrectly configured network policies can disrupt mesh traffic. When performing the migration, exercise caution when creating network policies to prevent traffic disruption. For more information, see "Network Policy migration".
====

[id="ossm-cluster-wide-migration-sidecar-injection_{context}"]
== Sidecar injection

If both control planes try to perform sidecar injection the proxy will not start and the migration cannot be completed. To ensure that only one control plane performs sidecar injection during the migration, use injection labels. For more information, see "Installing the Sidecar".

[NOTE]
====
During the migration, you must disable the 2.6 injector. Use the `maistra.io/ignore-namespace: "true"` label to prevent the 2.6 control plane from injecting a proxy in the namespace.
====

[id="ossm-cluster-wide-migration-label-selection_{context}"]
== Label selection

For {SMProduct} 3.0, you must decide if you want to use the `istio.io/rev` label or the `istio-injection` label to configure sidecar injection. For more information, see "Installing the Sidecar".

In the {SMProduct} 2.6 installation, the member selection configuration in the `ServiceMeshMemberRoll` resource can impact how injection labels are used in the {SMProduct} 3.0 installation.

By default, in a 2.6 installation, the `spec.memberSelectors` field in the `ServiceMeshMemberRoll` resource is configured to match the `istio-injection=enabled` label and all of the data plane namespaces in a 2.6 installation have the `istio-injection=enabled` label applied. If you are using the default 2.6 installation settings, you can keep using that label or switch to the `istio.io/rev` label for the 3.0 installation.

If the `spec.memberSelectors` field in the `ServiceMeshMemberRoll` resource is not configured to match the `istio-injection=enabled` label and the 2.6 data plane namespace uses a custom label, you must add the `istio.io/rev` label or the `istio-injection` label during the migration. The custom labels defined in the `spec.memberSelectors` parameter of the `ServiceMeshMemberRoll` resource have no effect on sidecar injection in the {SMProduct} 3 installation and cannot be used. 

If projects in the 2.6 installation were added to the mesh by manually creating the `ServiceMeshMember` resource, you must add the `istio.io/rev` or `istio-injection` label to the project namespaces during the migration.
