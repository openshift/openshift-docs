// This module is included in the following assemblies:
// * release_notes/op-release-notes-1-18.adoc

:_mod-docs-content-type: REFERENCE
[id="op-release-notes_{context}"]
= Release notes for {pipelines-title} 1.18

With this update, {pipelines-title} General Availability (GA) 1.18 is available on {OCP} 4.15 and later versions.

[id="new-features-1-18_{context}"]
== New features

In addition to fixes and stability improvements, the following sections highlight what is new in {pipelines-title} 1.18:

[id="pipelines-new-features-1-18_{context}"]
=== Pipelines

* With this release, log messages for the {pipelines-shortname} controller are improved to enhance readability, especially when empty variables are present.

* With this release, you can configure resolution timeout settings for pipeline resolvers to gain greater flexibility and control when running a pipeline.
+
.Example of configuring the timeout settings for pipeline resolvers
[source,yaml]
----
apiVersion: operator.tekton.dev/v1alpha1
kind: TektonConfig
metadata:
  name: config
spec:
# ...
  pipeline:
    options:
      configMaps:
        config-defaults:
          data:
            default-maximum-resolution-timeout: 5m # <1>
        bundleresolver-config:
          data:
            fetch-timeout: 1m # <2>
# ...
----
<1> Specify a global maximum timeout for resolution requests. The default value is `1m`.
<2> Specify a timeout that is used for bundle resolution requests.


[id="Operator-new-features-1-18_{context}"]
=== Operator

* With this release, the {pipelines-shortname} now support community tasks.
+
The following community tasks are installed by default in the `openshift-pipelines` namespace:
+
** `argocd-task-sync-and-wait`
** `git-cli`
** `helm-upgrade-from-repo`
** `helm-upgrade-from-source`
** `jib-maven`
** `kubeconfig-creator`
** `pull-request`
** `trigger-jenkins-job`

* With this release, {pipelines-shortname} supports the deployment of new containers through the `TektonConfig` CR.
+
.Example of deploying a new `kube-rbac-proxy` container by using the `TektonConfig` CR
[source,yaml]
----
apiVersion: operator.tekton.dev/v1alpha1
kind: TektonConfig
metadata:
  name: config
# ...
spec:
  result:
    options:
      deployments:
        tekton-results-watcher:
          spec:
            template:
              spec:
                containers:
                - name: kube-rbac-proxy
                  args:
                    - --secure-listen-address=0.0.0.0:8443
                    - --upstream=http://127.0.0.1:9090/
                    - --logtostderr=true
                  image: registry.redhat.io/openshift4/ose-kube-rbac-proxy:v4.12
# ...
----

* With this release, the high availability options of the {pipelines-shortname} controller are enhanced with `StatefulSet` ordinals as an alternative to the existing leader election mechanism. This enables the Operator to use either quick recovery with leader election or consistent workload distribution with `StatefulSet` ordinals.
+
Leader election, which is the default option, offers failover capabilities but might cause hot-spotting. In contrast, the new `StatefulSet` ordinals approach ensures keys are evenly spread across replicas for a more balanced workload distribution.
+
You can switch to the `StatefulSet` ordinals method by setting the `statefulset-ordinals` parameter to `true` in the `TektonConfig` custom resource:
+
--
.Example of enabling the `StatefulSet` ordinals feature
[source,yaml]
----
apiVersion: operator.tekton.dev/v1alpha1
kind: TektonConfig
metadata:
  name: config
spec:
# ...
  pipeline:
    performance:
      disable-ha: false
      buckets: 4
      replicas: 4
      statefulset-ordinals: true
# ...
----

:FeatureName: Using `StatefulSet` ordinals for high availability
include::snippets/technology-preview.adoc[]
--

[id="triggers-new-features-1-18_{context}"]
=== Triggers

* With this release, the `EventListener` object for {pipelines-shortname} triggers now includes the `ImagePullSecrets` field to specify a secret that the listener uses to pull images from private registries.
+
.Example of using the `ImagePullSecrets` field
[source,yaml]
----
apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: imagepullsecrets-example
# ...
spec:
  serviceAccountName: triggers-example
  resources:
    kubernetesResource:
      spec:
        template:
          spec:
            imagePullSecrets:
              - name: docker-login
# ...
----

[id="cli-new-features-1-18_{context}"]
=== CLI

* With this release, the `opc` command line utility is now shipped with the following components:
** {pac} version 0.33.0
** CLI version 0.40.0
** Results version 0.14.0
** Manual Approval Gate version 0.5.0

[id="pac-new-features-1-18_{context}"]
=== {pac}

* With this release, a `PipelineRun` resource can be triggered based on which files have changed by using the `on-path-change` and `on-path-change-ignore` annotations, which simplifies the process by not requiring writing complex CEL expressions.
+
.Example of using the `on-path-change` and `on-path-change-ignore` annotations
[source,yaml]
----
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: "on-path-change"
  annotations:
    pipelinesascode.tekton.dev/on-path-change: ["docs/**"] # <1>
    pipelinesascode.tekton.dev/on-path-change-ignore: [".github/**"] #<2>
spec:
# ...
----
<1> Matches if changes occur in the `docs` directory.
<2> Matches if no changes occur in the `.github` directory.

* With this release, a `PipelineRun` resource can now be triggered by pushed commits on GitHub by using the `on-comment` annotation. This feature gives you more control over when a `PipelineRun` is triggered, enabling you to match it based on specific comments.
+
You must configure a pipeline run to enable the triggering with the `on-comment` annotation:
+
.Example of enabling triggering of a pipeline run through pushed commits
[source,yaml]
----
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: "on-comment-pr"
  annotations:
    pipelinesascode.tekton.dev/on-comment: "^/hello-world" # <1>
spec:
# ...
----
<1> The example configures the `/hello-world` command. When you use this command on a pushed commit, for example, on the `main` branch, the `on-comment-pr` pipeline run is triggered.


* With this release, you can use the `tkn pac info globbing [-s | -d] “<pattern>”` command to test patterns with sample input data or in the working directory where the command is run. The command tests if the patterns are working properly in the `PipelineRun` definition.
+
For example, you can test the following `on-target-branch` annotation to ensure that it matches the `main` branch in the git event payload:
+
.Example `on-target-branch` annotation
[source,yaml]
----
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: "on-target-branch"
  annotations:
    pipelinesascode.tekton.dev/on-target-branch: "[refs/heads/*]"
spec:
# ...
----
+
.Example command
[source,console]
----
$ tkn pac info globbing -s "refs/heads/main" "refs/heads/*"
----

* With this release, {pac} supports commas within annotations by using the `&#44;` HTML entity. Now, you can use comma-separated values together with commas used directly in the values.
+
For example, to match two branches called `main` and `branchWith,comma`, specify the annotation as follows:
+
.Example annotation with commas
[source,yaml]
----
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: "comma-annotation"
  annotations:
    pipelinesascode.tekton.dev/on-target-branch: "[main, branchWith&#44;comma]"
spec:
# ...
----

* With this release, after a pull request is closed or merged, all associated `PipelineRun` resources that have the `cancel-in-progress: true` annotation are automatically canceled. To enable this feature, specify the `cancel-in-progress` annotation in your `PipelineRun` definition:
+
--
.Example `cancel-in-progress` annotation
[source,yaml]
----
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: "cancel-in-progress"
  annotations:
    pipelinesascode.tekton.dev/cancel-in-progress: "true"
spec:
# ...
----

:FeatureName: Cancellation-in-progress in {pac}
include::snippets/technology-preview.adoc[]
--

* With this release, an active `PipelineRun` resource that has the `cancel-in-progress: true` annotation is automatically canceled when a new `PipelineRun` resource with the same name is triggered by {pac}. Now, after a pull request is raised and triggers a `PipelineRun`, and subsequent commits to the same pull request trigger a new `PipelineRun`, the older obsolete `PipelineRun` is canceled to save resources.
+
To enable the feature, set the `pipelinesascode.tekton.dev/cancel-in-progress` annotation to `true` in the `PipelineRun` resource:
+
.Example of enabling the cancellation of older pipeline runs
[source,yaml]
----
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: "cancel-in-progress"
  annotations:
    pipelinesascode.tekton.dev/cancel-in-progress: "true"
spec:
# ...
----

* Before this update, the `.pathChanged()` function used in CEL expressions with Bitbucket Data Center did not work. With this release, the functionality is implemented.

* With this release, you can match pipeline runs to pull requests by using labels. To match a pipeline run to a label, set the `pipelinesascode.tekton.dev/on-label` annotation in `PipelineRun` resources. Adding the label to a pull request or push event immediately triggers the pipeline run. If a push request or pull event still has the label and is updated with a commit, the pipeline run is triggered again.
+
This functionality is supported on GitHub, GitLab, and Gitea repository providers. It is not supported on Bitbucket Cloud and Bitbucket Data Center.

[id="tekton-results-new-features-1-18_{context}"]
=== {tekton-results}

* With this release, {tekton-results} is a General Availability (GA) feature.

* With this release, the Operator installs and adds configuration for {tekton-results} by default through the `TektonConfig` CR.

* With this release, the {tekton-results} API server uses proxy environment variables in the {pipelines-shortname} console plugin to send authorization headers to the {tekton-results} API.

* With this release, the {tekton-results} logging information fetched from LokiStack includes the container name for each log entry.

[id="tekton-cache-new-features-1-18_{context}"]
=== Tekton Cache

With this release, {pipelines-shortname} includes the new `tekton-caches` tool functionality.

:FeatureName: Tekton Cache
include::snippets/technology-preview.adoc[]

The `tekton-caches` tool includes the following features:

* Use the `cache-upload` and `cache-fetch` step actions to preserve the cache directory where a build process keeps its dependencies, storing it in an S3 bucket, Google Cloud Services (GCS) bucket, or an OCI repository.
+
The `cache-fetch` and `cache-upload` step actions are installed by default in the `openshift-pipelines` namespace.

[id="breaking-changes-1-18_{context}"]
== Breaking changes

* With this release, {tekton-results} no longer supports forwarding of logs by the {tekton-results} watcher to storage in a persistent volume (PV), an S3 bucket, or a GCS bucket.

* Before this update, older versioned tasks and step actions were installed in the `openshift-pipelines` namespace. With this update, these older versions are removed, and only the latest two minor versions of tasks and step actions are installed. For example, in {pipelines-shortname} 1.18, the installed versioned tasks and step actions are `pass:[*]-1-17-0` and `pass:[*]-1-18-0`.

[id="known-issues-1-18_{context}"]
== Known issues

* If you add or change any parameters in the `result:` section of the `TektonConfig` CR, the changes do not apply automatically. To apply the changes, restart the deployment or pod of the Results API server in the `openshift-pipelines` namespace.

[id="fixed-issues-1-18_{context}"]
== Fixed issues

* Before this update, if you defined a task that included both regular parameters and `matrix` parameters, the `tekton-pipelines-controller` component crashed and logged a segmentation fault message. If the task was not removed, the component continued to crash and did not run any pipelines. With this update, the controller no longer crashes in such cases.

* Before this update, when a user tried to rerun a resolver-based `PipelineRun` resource by using the {OCP} web console, the attempt resulted in an error with the `Invalid PipelineRun configuration, unable to start Pipeline.` message. With this update, the rerun no longer causes an error and works as expected.

* Before this update, when the `PipelineRun` resource failed, the *Output* tab of the `PipelineRun` resource in the {OCP} web console displayed an error message instead of available results. With this update, the web console correctly shows the results.

* Before this update, the `buildah` task from the `openshift-pipelines` namespace failed when values for `CONTEXT` and `DOCKERFILE` parameters pointed to different directories. With this update, the issue is fixed.

* Before this update, referencing parameters as default values in step actions caused the `TaskRun` resource referencing that step action to fail. With this release, the issue is fixed.
+
.Example of using a parameter as a value
[source,yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: StepAction
metadata:
  name: simple-step-action
# ...
spec:
  params:
    - name: param1 # This parameter is required
      type: string
    - name: param2 # This parameter uses the value of `param1` as default value
      type: string
      default: $(params.param1)
# ...
----

* Before this update, when you created a `PipelineRun` resource that referenced a remote Git repository that contained a symlink pointing outside of that repository, the `PipelineRun` would fail. With this release, the `PipelineRun` no longer fails even if the symlink is invalid.

* Before this update, the resource requests for memory and ephemeral storage could sometimes exceed the defined limits. With this release, the issue is fixed.

* Before this update, running pipelines in a cluster that uses injected sidecars sometimes did not affect the {pipelines-shortname} controller. This was caused by faulty minor Kubernetes version checking. With this update, the issue is fixed.

* Before this update, when the list of results contained duplicate keys with an invalid result, the duplicates were removed and replaced with the last result for each key, which could change the order of the result list. With this release, when duplicate keys are removed, the order of the results is preserved, ensuring that the last valid result for each key is kept as the final result.

* Before this update, when using {pac}, GitLab instances hosted under a relative path, for example, `\https://example.servehttp.com/gitlab`, failed to correctly update status for merge requests. Although the initial event updates worked correctly, subsequent updates, for example, marking the pipeline run as `Finished`, did not appear in GitLab, leaving the status in the `Running` state. With this update, the status updates work correctly.

* Before this update, when using {pac}, if you passed the `onEvent` or `onTargetBranch` annotations in a `PipelineRun` resource with an empty `[]` value, it prevented matching of any `PipelineRun` resources. With this update, passing the annotations with an empty value returns an error.

* Before this update, when using {pac}, you could create the `Repository` custom resource (CR) without a URL or with an invalid URL. With this update, you can only create the `Repository` CR if you provide a valid URL. You can still create the `Repository` CR in the `openshift-pipelines` namespace without a URL to provide default settings for all repositories.

* Before this update, when using {pac}, if a pull request was raised through a forked repository in GitLab, the `PipelineRun` resource was created successfully, but its final status was not reported in the GitLab UI. With this update, the issue is fixed.

* Before this update, when using {pac}, GitLab displayed check names for pipeline runs as a single entry for a pipeline. This caused issues when multiple pipeline runs were running simultaneously and one of them failed. If the other pipeline run succeeded, it would override the failed status and the pipeline would appear as successful. With this update, every check name shows separately for each pipeline run. Therefore, the status of pipelines shows correctly as failed if any of the pipeline runs fail.

* Before this update, when using {pac}, if you used the `{{ trigger_comment }}` variable in the `PipelineRun` resource definition and then submitted a multiline comment in GitHub, {pac} could repost YAML validation errors for the pipeline run. With this update, the issue is fixed.

* Before this update, when using {pac}, a `/test branch:<branch>` command where a branch name contained parts that could be interepreted as other commands did not work properly. For example, in the command `/test branch:a/testbranch` the branch branch name contains `/test`, and this command would fail. With this update, only the first `/test` substring in a comment is considered a command to prevent any malfunction.

* Before this update, when using {pac}, if an unauthorized user sent `/test`, `/retest`, or other GitOps commands on pushed commits in GitHub, `PipelineRun` resources were triggered, even though the user was not authorized to trigger them. With this update, an additional user authorization check is added, preventing the `PipelineRun` resources from being triggered without proper verification.

* Before this update, when using {pac}, if an unauthorized user raised a pull request and the repository administrator sent the `/ok-to-test` command, a pending check was created, even if there was no matching `PipelineRun` resource for the pull request event. With this update, no pending checks are created if there is no matching `PipelineRun` resource. Instead, a neutral check is created describing that there is no matching `PipelineRun`.

* Before this update, when using {pac} with Bitbucket Data Center, in a push event users could not reference all fields of event payload in the `PipelineRun` resource, for example, the `body.changes` object. This update fixes the issue.
+
.Example of using the {{ body.changes }} dynamic variable
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
# ...
spec:
    params:
      - name: ref_id
        value: "{{ body.changes[0].ref.id }}"
# ...
----

* Before this update, when using {pac}, if you used the `generateName` field in a `PipelineRun` resource to match the resource to the `incoming` webhook, the match would not work correctly. With this update, the issue is fixed.

* Before this update, when using {pac}, the `on-cel-expression` annotation was not working on push events in Bitbucket Data Center. With this update, the issue is fixed.

[id="release-notes-1-18-1_{context}"]
== Release notes for {pipelines-title} 1.18.1

With this update, {pipelines-title} General Availability (GA) 1.18.1 is available on {OCP} 4.15 and later versions.

[id="fixed-issues-1-18-1_{context}"]
== Fixed issues

* Before this update, when you set configuration options for  {tekton-results} in the `TektonConfig` custom resource (CR), they were not propagated to the `TektonResult` CR and were not applied to the {tekton-results} component. With this update, configuration options from the `TektonConfig` CR are correctly propagated to the `TektonResult` CR and applied to the {tekton-results} component.

* Before this update, if {pac} started a pipeline run without the `cancel-in-progress` annotation because of a pull request (PR) and that PR was closed, the pipeline run was automatically canceled. With this update, {pac} does not cancel the pipeline run unless the `cancel-in-progress` annotation is explicitly specified.

* Before this update, the {pac} controller sometimes stopped working and logged an `index out of range` error. With this update, this issue is resolved and the {pac} controller does not stop working.

* Before this update, the web console for a `PipelineRun` object displayed duplicate `TaskRun` objects and incorrect step completion status based on archived data. With this update, the console displays only the `TaskRun` objects that belong to the current pipeline run and the status bar in the console shows the status of the current task tun.

* Before this update, if you used the `cancel-in-progress` annotation in a {pac} pipeline run and specified the `generateName` field for this pipeline run, {pac} could not cancel this pipeline run when another copy of the pipeline run started. With this update, {pac} cancels the pipeline run normally.

* Before this update, when you used `skopeo` or a similar tool to inspect the {pipelines-title} Operator bundle, an incorrect name, `serverless-operator`, was displayed. With this update, the issue is resolved and the correct name, `openshift-pipelines-operator-rh`, is displayed.

* Before this update, when using {pac}, adding a label to a pull request could unintentionally trigger a pipeline run. With this update, a `PipelineRun` resource is triggered only after you add a label to a pull request.