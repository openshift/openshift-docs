// Module included in the following assemblies:
// * networking/installing-albo-sts-cluster.adoc

:_content-type: PROCEDURE
[id="bootstra-aws-load-balancer-operator-using-aws-cli_{context}"]
= Bootstrapping AWS Load Balancer Operator on Security Token Service cluster by using the AWS CLI

.Prerequisites

* You have installed link:https://docs.aws.amazon.com/cli/latest/#aws-cli-command-reference[AWS CLI].

.Procedure

. Create the `aws-load-balancer-operator` namespace by running the following command:
+
[source,terminal]
----
$ oc create namespace aws-load-balancer-operator
----

. Generate a trusted policy file using your identity provider by running the following command:
+
[source,terminal]
----
$ cat <<EOF > albo-operator-trusted-policy.json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "${IDP_ARN}"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"${IDP}:sub": "system:serviceaccount:aws-load-balancer-operator:aws-load-balancer-operator-controller-manager"
                }
             }
}
]
}
EOF
----

. Create the role with the generated trusted policy by running the following command:
+
[source,terminal]
----
$ aws iam create-role \
    --role-name albo-operator \
    --assume-role-policy-document file://albo-operator-trusted-policy.json \
    OPERATOR_ROLE_ARN=$(aws iam get-role --role-name albo-operator | \grep '^ROLE' | \grep -Po 'arn:aws:iam[0-9a-z/:\-_]+')
----

. Download the operator's permission policy by running the following command:
+
[source,terminal]
----
$ curl -o albo-operator-permission-policy.json https://raw.githubusercontent.com/alebedev87/aws-load-balancer-operator/aws-cli-commands-for-sts/hack/operator-permission-policy.json
----

. Attach the permission policy of the AWS Load Balancer Operator to the role by running the following command:
+
[source,terminal]
----
$ aws iam put-role-policy --role-name albo-operator \
    --policy-name perms-policy-albo-operator \
    --policy-document file://albo-operator-permission-policy.json
----

. Generate the operator's aws credentials by runing the following command:
+
[source,terminal]
----
$ cat <<EOF > albo-operator-aws-credentials.cfg
[default]
sts_regional_endpoints = regional
role_arn = ${OPERATOR_ROLE_ARN}
web_identity_token_file = /var/run/secrets/openshift/serviceaccount/token
EOF
----

. Create the credentials secret of the AWS Load Balancer Operator with the generated aws credentials by running the following command:
+
[source,terminal]
----
$ oc -n aws-load-balancer-operator create secret generic aws-load-balancer-operator --from-file=credentials=albo-operator-aws-credentials.cfg
----