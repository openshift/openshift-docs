[id="app-developer-workflow_{context}"]
= Override your Gateway policies for auth and rate limiting 

As an application developer, you can override your existing Gateway-level policies to configure your application-level auth and rate limiting requirements. 


.Prerequisites

* Your {prodname} policies are configured as described in xref:platform-engineer-workflow_{context}[].


== Override the Gateway's deny-all AuthPolicy

You can allow authenticated access to the Toystore API by defining a new `AuthPolicy` that targets the `HTTPRoute` resource created in the previous section.

NOTE: Any new HTTPRoutes will still be affected by the existing Gateway-level policy. Because you want users to now access this API, you must override that Gateway policy. For simplicity, you can use API keys to authenticate the requests, but other options such as OpenID Connect are also available.

.Procedure

. Ensure that your {prodname} system namespace is set correctly as follows:
+
[source,bash]
----
export KUADRANT_SYSTEM_NS=$(kubectl get kuadrant -A -o jsonpath="{.items[0].metadata.namespace}")
----

. Define API keys for *bob* and *alice* users as follows:
+
[source,bash]
----
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: bob-key
  namespace: ${KUADRANT_SYSTEM_NS}
  labels:
    authorino.kuadrant.io/managed-by: authorino
    app: toystore
  annotations:
    secret.kuadrant.io/user-id: bob
stringData:
  api_key: IAMBOB
type: Opaque
---
apiVersion: v1
kind: Secret
metadata:
  name: alice-key
  namespace: ${KUADRANT_SYSTEM_NS}
  labels:
    authorino.kuadrant.io/managed-by: authorino
    app: toystore
  annotations:
    secret.kuadrant.io/user-id: alice
stringData:
  api_key: IAMALICE
type: Opaque
EOF
----

. Create a new `AuthPolicy` in a different namespace that overrides the `deny-all` policy created earlier and accepts the API keys as follows:
+
[source,bash]
----
kubectl apply -f - <<EOF
apiVersion: kuadrant.io/v1
kind: AuthPolicy
metadata:
  name: toystore-auth
  namespace: ${KUADRANT_DEVELOPER_NS}
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: toystore
  defaults:
   when:
     - predicate: "request.path != '/health'"  
   rules:
    authentication:
      "api-key-users":
        apiKey:
          selector:
            matchLabels:
              app: toystore
        credentials:
          authorizationHeader:
            prefix: APIKEY
    response:
      success:
        filters:
          "identity":
            json:
              properties:
                "userid":
                  selector: auth.identity.metadata.annotations.secret\.kuadrant\.io/user-id
EOF
----

== Override the Gateway's low-limit RateLimitPolicy for specific users

The configured Gateway limits provide a good set of limits for the general case. However, as the developer of the Toystore API, you might want to only allow a certain number of requests for specific users, and a general limit for all other users.

.Procedure

. Create a new `RateLimitPolicy` in a different namespace to override the default `low-limit` policy created previously and set rate limits for specific users as follows:
+
[source,bash]
----
kubectl apply -f - <<EOF
apiVersion: kuadrant.io/v1
kind: RateLimitPolicy
metadata:
  name: toystore-rlp
  namespace: ${KUADRANT_DEVELOPER_NS}
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: toystore
  limits:
    "general-user":
      rates:

      - limit: 5
        window: 10s
      counters:
      - expression: auth.identity.userid
      when:
      - predicate: "auth.identity.userid != 'bob'"
    "bob-limit":
      rates:
      - limit: 2
        window: 10s
      when:
      - predicate: "auth.identity.userid == 'bob'"
EOF
----
+
NOTE: It might take a few minutes for the `RateLimitPolicy` to be applied, depending on your cluster.
+
. Check that the `RateLimitPolicy` has a status of `Accepted` and `Enforced` as follows:
+
[source,bash]
----
kubectl get ratelimitpolicy -n ${KUADRANT_DEVELOPER_NS} toystore-rlp -o=jsonpath='{.status.conditions[?(@.type=="Accepted")].message}{"\n"}{.status.conditions[?(@.type=="Enforced")].message}'
----

. Check that the status of the HTTPRoute is now affected by the `RateLimitPolicy` in the same namespace:
+
[source,bash]
----
kubectl get httproute toystore -n ${KUADRANT_DEVELOPER_NS} -o=jsonpath='{.status.parents[0].conditions[?(@.type=="kuadrant.io/RateLimitPolicyAffected")].message}'
----

== Test the new Rate limit and Auth policies

. Send requests as user *alice* as follows:
+
[source,bash]
----
while :; do curl -k --write-out '%{http_code}\n' --silent --output /dev/null -H 'Authorization: APIKEY IAMALICE' "https://api.$KUADRANT_ZONE_ROOT_DOMAIN/cars" | grep -E --color "\b(429)\b|$"; sleep 1; done
----
+
You should see HTTP status `200` every second for 5 seconds, followed by HTTP status `429` every second for 5 seconds.

. Send requests as user *bob* as follows:
+
[source,bash]
----
while :; do curl -k --write-out '%{http_code}\n' --silent --output /dev/null -H 'Authorization: APIKEY IAMBOB' "https://api.$KUADRANT_ZONE_ROOT_DOMAIN/cars" | grep -E --color "\b(429)\b|$"; sleep 1; done
----
+
You should see HTTP status `200` every second for 2 seconds, followed by HTTP status `429` every second for 8 seconds.

