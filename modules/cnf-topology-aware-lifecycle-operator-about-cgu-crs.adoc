// Module included in the following assemblies:
// Epic CNF-2600 (CNF-2133) (4.10), Story TELCODOCS-285
// * scalability_and_performance/cnf-topology-aware-lifecycle-operator.adoc

:_content-type: CONCEPT
[id="talo-about-cgu-crs_{context}"]
= About the ClusterGroupUpgrade CR

TALO builds the remediation plan from the `ClusterGroupUpgrade` CR for a group of clusters. You can define the following specifications:

* Clusters in the group
* Blocking `ClusterGroupUpgrade` CRs
* Applicable list of managed policies
* Number of concurrent updates
* Applicable canary updates
* Actions to perform before and after the update
* Update timing

The `ClusterGroupUpgrade` CR can be in the following states:

* `UpgradeNotStarted`
* `UpgradeNotComplete`
* `UpgradeCannotStart`
* `UpgradeTimedOut`
* `UpgradeCompleted`

// UpgradeCannotStart needs to be added below. Most probably, this state is applicable when using blocking CRs, but has to check with SME.

[NOTE]
====
After a cluster update performed by TALO is complete, the cluster will not be updated again under the control of the same `ClusterGroupUpgrade` CR. You need to create a new `ClusterGroupUpgrade` CR in the following cases:

* If you need to update the cluster again
* If the cluster changes to non-compliant with the `inform` policy after being updated
====

[discrete]
== The UpgradeNotStarted state

`UpgradeNotStarted` is the initial state of the `ClusterGroupUpgrade` CR.

TALO builds a remediation plan based on the following fields:

* The `clusterSelector` field specifies the labels of the clusters that you want to update.
* The `clusters` field specifies a list of clusters to update.
* The `canaries` fields specifies the clusters for canary updates.
* The `maxConcurrency` field specifies the number of clusters to update in a batch.

You can use the `clusters` and the `clusterSelector` fields together to create a combined list of clusters.

The `ClusterGroupUpgrade` CR transitions to the `UpgradeNotCompleted` state after the remediation plan is successfully created and after the `enable` field is set to `true`. At this point, TALO starts to update the non-compliant clusters with the specified managed policies.

[NOTE]
====
You can only make changes to the `spec` fields if the `ClusterGroupUpgrade` CR is either in the `UpgradeNotStarted` or the `UpgradeCannotStart` state. 
====

.Sample ClusterGroupUpgrade CR in the UpgradeNotStarted state

[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: cgu-upgrade-complete
  namespace: default
spec:
  clusters: <1>
  - spoke1
  enable: false
  managedPolicies: <2>
  - policy1-common-cluster-version-policy
  - policy2-common-pao-sub-policy
  remediationStrategy: <3>
    canaries: <4>
      - spoke1
    maxConcurrency: 1 <5>
    timeout: 240
status: <6>
  conditions:
  - message: The ClusterGroupUpgrade CR is not enabled
    reason: UpgradeNotStarted
    status: "False"
    type: Ready
  copiedPolicies:
  - cgu-upgrade-complete-policy1-common-cluster-version-policy
  - cgu-upgrade-complete-policy2-common-pao-sub-policy
  managedPoliciesForUpgrade:
  - name: policy1-common-cluster-version-policy
    namespace: default
  - name: policy2-common-pao-sub-policy
    namespace: default
  placementBindings:
  - cgu-upgrade-complete-policy1-common-cluster-version-policy
  - cgu-upgrade-complete-policy2-common-pao-sub-policy
  placementRules:
  - cgu-upgrade-complete-policy1-common-cluster-version-policy
  - cgu-upgrade-complete-policy2-common-pao-sub-policy
  remediationPlan:
  - - spoke1
----
<1> Defines the list of clusters to update.
<2> Lists the user-defined set of policies to remediate.
<3> Defines the specifics of the cluster updates.
<4> The remediation plan starts with the clusters listed in the `canaries` field. Any failures during the update of a canary cluster stops the update process. Each canary cluster forms a single-cluster batch.
<5> Defines the maximum number of concurrent updates in a batch. The number of remediation batches is the number of canary clusters, plus the number of clusters (except the canary clusters) divided by `maxConcurrency`. The clusters that are already compliant with all the managed policies are excluded from the remediation plan.
<6> Displays information about the status of the updates.

[discrete]
== The UpgradeNotCompleted state

In the `UpgradeNotCompleted` state, TALO enforces the policies following the remediation plan defined in the `UpgradeNotStarted` state.

Enforcing the policies of subsequent batches starts immediately after all the clusters of the current batch are compliant with all the managed policies. If the batch times out, TALO moves on to the next batch. The timeout value of a batch  is the `spec.timeout` field divided by the number of batches in the remediation plan.

[NOTE]
====
The managed policies apply in the order they are listed in the `managedPolicies` field in the `ClusterGroupUpgrade` CR. One managed policy is applied to the specified clusters at a time. After the specified clusters become compliant to the current policy, the next managed policy, for which the cluster is non-compliant, will be applied.
====

.Sample ClusterGroupUpgrade CR in the UpgradeNotCompleted state

[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: cgu-upgrade-complete
  namespace: default
spec:
  clusters:
  - spoke1
  enable: true <1>
  managedPolicies:
  - policy1-common-cluster-version-policy
  - policy2-common-pao-sub-policy
  remediationStrategy:
    maxConcurrency: 1
    timeout: 240
status: <2>
  conditions:
  - message: The ClusterGroupUpgrade CR has upgrade policies that are still non compliant
    reason: UpgradeNotCompleted
    status: "False"
    type: Ready
  copiedPolicies:
  - cgu-upgrade-complete-policy1-common-cluster-version-policy
  - cgu-upgrade-complete-policy2-common-pao-sub-policy
  managedPoliciesForUpgrade:
  - name: policy1-common-cluster-version-policy
    namespace: default
  - name: policy2-common-pao-sub-policy
    namespace: default
  placementBindings:
  - cgu-upgrade-complete-policy1-common-cluster-version-policy
  - cgu-upgrade-complete-policy2-common-pao-sub-policy
  placementRules:
  - cgu-upgrade-complete-policy1-common-cluster-version-policy
  - cgu-upgrade-complete-policy2-common-pao-sub-policy
  remediationPlan:
  - - spoke1
  status:
    currentBatch: 1
    remediationPlanForBatch: <3>
      spoke1: 0
----
<1> The update starts when the value of the `spec.enable` field is `true`.
<2> The `status` fields change accordingly when the update begins.
<3> Lists the clusters in the batch and the index of the policy that is being currently applied to each cluster. The index of the policies starts with `0` and the index follows the order of the `spec.managedPolicies` list.

[discrete]
== The UpgradeTimedOut state

In the `UpgradeTimedOut` state, TALO checks every hour if all the policies for the `ClusterGroupUpgrade` CR are compliant. The checks continue until the `ClusterGroupUpgrade` CR is deleted or the updates are completed.
The periodic checks allow the updates to complete if they get prolonged due to network, CPU, or other issues. 

TALO transitions to the `UpgradeTimedOut` state in two cases:

* If the current batch is a canary type and the cluster in the batch does not become compliant with all the managed policies within the batch timeout.
* If the clusters are not compliant with the managed policies within the `timeout` value specified in `remediationStrategy`.

If the policies are compliant, TALO transitions to the `UpgradeCompleted` state.

[discrete]
== The UpgradeCompleted state

In the `UpgradeCompleted` state, the cluster updates are complete.

.Sample ClusterGroupUpgrade CR in the UpgradeCompleted state

[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: cgu-upgrade-complete
  namespace: default
spec:
  actions:
    afterCompletion:
      deleteObjects: true <1>
  clusters:
  - spoke1
  enable: true
  managedPolicies:
  - policy1-common-cluster-version-policy
  - policy2-common-pao-sub-policy
  remediationStrategy:
    maxConcurrency: 1
    timeout: 240
status: <2>
  conditions:
  - message: The ClusterGroupUpgrade CR has all clusters compliant with all the managed policies
    reason: UpgradeCompleted
    status: "True"
    type: Ready
  managedPoliciesForUpgrade:
  - name: policy1-common-cluster-version-policy
    namespace: default
  - name: policy2-common-pao-sub-policy
    namespace: default
  remediationPlan:
  - - spoke1
  status:
    remediationPlanForBatch:
      spoke1: -2 <3>
----
<1> The value of `spec.action.afterCompletion.deleteObjects` field is `true` by default. After the update is completed, TALO deletes the underlying {rh-rhacm} objects that were created during the update. This option is to prevent the {rh-rhacm} Hub from continuously checking for compliance after a successful update.
<2> The `status` fields show that the updates completed successfully.
<3> Displays that all the policies are applied to the cluster.