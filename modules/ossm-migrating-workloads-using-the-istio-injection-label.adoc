// Module included in the following assemblies:
//
// * service-mesh-docs-main/migrating/cluster-wide/ossm-migrating-cluster-wide.adoc

ifeval::["{context}" == "cw-injection"]
:ossm-cluster-wide-istio-injection:
endif::[]
ifeval::["{context}" == "cw-injection-cm"]
:ossm-cert-manager-istio-injection:
endif::[]

:_mod-docs-content-type: PROCEDURE
[id="ossm-migrating-workloads-using-the-istio-injection-label_{context}"]
ifdef::ossm-cluster-wide-istio-injection[= Migrating workloads by using the Istio injection label]
ifdef::ossm-cert-manager-istio-injection[= Migrating workloads by using the Istio injection label with cert-manager]

Now you can migrate your workloads from the {SMProduct} 2.6 control plane to the {SMproduct} 3.0 control plane.

[NOTE]
====
You can migrate workloads and gateways separately, and in any order. For more information, see "Migrating gateways".
====

.Procedure

. Find the current `IstioRevision` resource for your {SMProduct} 3.0 control plane by running the following command:
+
[source,terminal]
----
$ oc get istios
----
+
.Example output
+
[source,terminal]
----
NAME             REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
ossm-3           1           1       0        ossm-3-v1-24-3    Healthy   v1.24.3   30s
----

. Copy the `ACTIVE REVISION` value to use as your `istio.io/rev` label in the next step.
+
[NOTE]
====
The naming format of your revisions depends on which upgrade strategy you choose for your `Istio` instance.
====

. Update the injection labels on the data plane namespace by running the following command:
+
[source,terminal]
----
$ oc label ns bookinfo istio.io/rev=ossm-3-v1-24-3 maistra.io/ignore-namespace="true" istio-injection- --overwrite=true
----
+
The `oc label` command performs the following actions:

.. Removes the `istio-injection` label: This label prevents the 3.0 control plane from injecting the proxy. The `istio-injection` label takes precedence over the `istio.io/rev` label. You must temporarily remove the `istio-injection=enabled` because you cannot create the default `IstioRevisionTag` tag yet. Leaving the `istio-injection=enabled` label applied would prevent the 3.0 control plane from performing proxy injection.

.. Adds the `istio.io/rev=ossm-3-v1-24-3` label: This label ensures that any newly created or restarted pods in the namespace connect to the {SMProduct} 3.0 proxy.

.. Adds the `maistra.io/ignore-namespace: "true"` label: This label disables sidecar injection for {SMProduct} 2.6 proxies in the namespace. With the label applied, {SMProduct} 2.6 stops injecting proxies in this namespace, and any new proxies are injected by {SMProduct} 3.0. Without this label, the {SMProduct} 2.6 injection webhook tries to inject the pod and the injected sidecar proxy refuses to start since it will has both the {SMProduct} 2.6 and the {SMProduct} 3.0 Container Network Interface(CNI) annotations.
+
[NOTE]
====
After you apply the `maistra.io/ignore-namespace` label, any new pod that gets created in the namespace connects to the {SMProduct} 3.0 proxy. Workloads can still communicate with each other regardless of which control plane they are connected to.
====

. Restart the workloads by using one of the following options:
+
.. To restart all the workloads at the same time so that the new pods are injected with the {SMProduct} 3.0 proxy, run the following command:
+
.Example command for `bookinfo` application
[source,terminal]
----
$ oc rollout restart deployments -n bookinfo
----

.. To restart each workload individually, run the following command for each workload:
+
.Example command for `bookinfo` application
[source,terminal]
----
$ oc rollout restart deployments productpage-v1 -n bookinfo
----

. Wait for the `productpage` application to restart by running the following command:
+
[source,terminal]
----
$ oc rollout status deployment productpage-v1 -n bookinfo
----

.Verification

. Verify that the the new control plane manages the expected workloads by running the following command:
+
[source,terminal]
----
$ istioctl ps -n bookinfo
----
+
.Example output:
[source,terminal]
----
NAME                                          CLUSTER        CDS             LDS             EDS             RDS             ECDS         ISTIOD                                           VERSION
details-v1-7f46897b-d497c.bookinfo            Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
productpage-v1-74bfbd4d65-vsxqm.bookinfo      Kubernetes     SYNCED (4s)     SYNCED (4s)     SYNCED (3s)     SYNCED (4s)     IGNORED      istiod-ossm-3-v1-24-3-797bb4d78f-xpchx           1.24.3
ratings-v1-559b64556-c5ppg.bookinfo           Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
reviews-v1-847fb7c54d-qxt5d.bookinfo          Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
reviews-v2-5c7ff5b77b-8jbhd.bookinfo          Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
reviews-v3-5c5d764c9b-rrx8w.bookinfo          Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
----
+
The output shows that the `productpage-v1` deployment is the only deployment that has been restarted and was injected with the 3.0 proxy. Even if there are different versions of the proxies, communication between the services still works.

. If the 2.6 installation contains additional namespaces, migrate the next namespace now.
+
[NOTE]
====
Remove the `maistra.io/ignore-namespace="true"` label only after the 2.6 control plane has been uninstalled.
====

ifeval::["{context}" == "cw-injection"]
:!ossm-cluster-wide-istio-injection:
endif::[]
ifeval::["{context}" == "cw-injection-cm"]
:!ossm-cert-manager-istio-injection:
endif::[]