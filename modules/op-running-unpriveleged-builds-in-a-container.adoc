// Module included in the following assemblies:
//
// * cicd/pipelines/running-workloads-and-buildah-as-user-namespaces-on-openshift-pipelines.adoc
:_content-type: PROCEDURE

[id="op-running-unpriveleged-builds-in-a-container_{context}"]
= Running unprivileged builds in a container

You can run builds as a non-root user inside a container to restrict specific container activities and enhance security.

[IMPORTANT]
====
To run as a non-root user inside the container, your container must contain the `/etc/subuid` and `/etc/subgid` files with the latest shadow-utils.
====

.Prerequisites

* [A `ConfigMap` storage volume](https://kubernetes.io/docs/concepts/storage/volumes/#configmap) that the build can use as a workspace.

.Procedure

. Use the public https://catalog.redhat.com/software/containers/ubi8/buildah/602686f7b16b1eb2e30807ee?container-tabs=dockerfile[Containerfile] image based on Red Hat UBI.

. Force run the container as the “build” user to prevent it from being “randomed” which will not have the setup needed to run as non-root.

. Add `securityContext` to each build and push steps to directly edit or export to a specific namespace the buildah `ClusterTask` resource.
+
[source,yaml,subs="attributes+"]
----
...
securityContext:
    runAsUser: 1000
...
----

. Change the `mountPath` so that the build uses the local container directory of the new user:
+
[source,yaml,subs="attributes+"]
----
...
volumeMounts:
    - name: varlibcontainers
      mountPath: /home/build/.local/share/containers
...
----

.Verification

. Use the `configMap` field to reference https://kubernetes.io/docs/concepts/storage/volumes/#configmap[an existing `ConfigMap` storage volume] that the build can use as a workspace:
+
.Example `workspaces` element in the Taskrun definition
[source,yaml,subs="attributes+"]
----
...
workspaces:
  - name: <workspace>
    configmap:
      name: <configmap>
...
----

. Test it using the above `ConfigMap` object workspace along with a sample DockerFile and a sample taskrun.
+
[source,terminal,subs="attributes+"]
----
$ tkn tr logs -Lf buildah-run
----
+
Review the command output to verify that the image runs as a user:
+
.Example output
[source,terminal]
----
[build] ++ id
[build] Running as USER ID uid=1000(build) gid=1000(build) groups=1000(build),1000690000
[build] + echo 'Running as USER ID uid=1000(build) gid=1000(build) groups=1000(build),1000690000'
[build] + buildah --storage-driver=vfs bud --format=oci --tls-verify=true --no-cache -f ./Dockerfile -t image-registry.openshift-image-registry.svc:5000/test/buildahuser .
[build] STEP 1: FROM registry.access.redhat.com/ubi8/ubi AS buildah-runner
[build] Getting image source signatures
[build] Checking if image destination supports signatures
[build] Copying blob sha256:adffa69631469a649556cee5b8456f184928818064aac82106bd08bd62e51d4e
[build] Copying blob sha256:26f1167feaf74177f9054bf26ac8775a4b188f25914e23bda9574ef2a759cce4
[build] Copying config sha256:fca12da1dc30ed8e7d03afb84b287fc695673fff9c04bfcb2ff404b558670a36
[build] Writing manifest to image destination
[build] Storing signatures
[build] STEP 2: RUN dnf -y update &&     dnf -y install git &&     dnf clean all
[build] Updating Subscription Management repositories.
[...]
----
