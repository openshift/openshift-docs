// Module included in the following assemblies:
//
// * installing/disconnected_install/installing-mirroring-disconnected.adoc
// * updating/updating_a_cluster/updating_disconnected_cluster/mirroring-image-repository.adoc
// * microshift_running_apps/microshift_operators/microshift-operators-oc-mirror.adoc

:_mod-docs-content-type: PROCEDURE
[id="oc-mirror-mirror-to-mirror_{context}"]
= Mirroring an image set in a partially disconnected environment:

You can use the oc-mirror plugin v1 to mirror an image set directly to a target mirror registry that is accessible during image set creation. 

[NOTE]
====
You must specify a storage backend in the image set configuration file. See "Setting up incremental mirroring".
====

[IMPORTANT]
====
Do not delete or modify the metadata that is generated by the oc-mirror plugin v1. You must use the same storage backend every time you run the oc-mirror plugin v1 for the same mirror registry.
====

.Prerequisites

* You have access to the internet to get the necessary container images.
* You have access to the target mirror registry.
* You have installed the OpenShift CLI (`oc`).
* You have installed the `oc-mirror` CLI plugin v1.
* You have created the image set configuration file.
* You have set the umask parameter to `0022` on the underlying operating system that uses oc-mirror plugin v1.

.Procedure

* Run the `oc mirror` command to mirror the images from the specified image set configuration to a specified registry:
+
[source,terminal]
----
$ oc mirror --config=./<imageset-config.yaml> \// <1>
  docker://registry.example:5000             <2>
----
<1> Specify the image set configuration file that you created. For example, `imageset-config.yaml`.
<2> Specify the registry to mirror the image set file to. The registry must start with `docker://`. If you specify a top-level namespace for the mirror registry, you must also use this same namespace on subsequent executions.

ifdef::microshift[]
.Example output
[source,terminal]
----
Rendering catalog image "registry.example.com/redhat/redhat-operator-index:v{ocp-version}" with file-based catalog
----
endif::microshift[]

.Verification

. Navigate into the `oc-mirror-workspace/` directory that was generated.
. Navigate into the results directory, for example, `results-1639608409/`.
. Verify that YAML files are present for the `ImageContentSourcePolicy` and `CatalogSource` resources.

ifndef::microshift[]
[NOTE]
====
The `repositoryDigestMirrors` section of the `ImageContentSourcePolicy` YAML file is used for the `install-config.yaml` file during installation.
====
endif::microshift[]
// TODO: Test and get some better wording/example output.

ifdef::microshift[]
[IMPORTANT]
====
The `ImageContentSourcePolicy` YAML file is used as reference content for manual configuration of CRI-O in {microshift-short}. You cannot apply the resource directly into a {microshift-short} cluster.
====
endif::microshift[]

.Next steps
ifdef::microshift[]
* Convert the `ImageContentSourcePolicy` YAML content for use in manually configuring CRI-O.
* If required, mirror the images from mirror to disk for disconnected or offline use.
endif::microshift[]
* Configure your cluster to use the resources generated by the oc-mirror plugin. See "Configuring your cluster to use the resources generated by oc-mirror".

.Troubleshooting

* link:https://access.redhat.com/solutions/7032017[What to do when encountering "manifest unknown error: unable to retrieve source image" while using oc-mirror?]