// Module included in the following assemblies:
//
//* observability/distr_tracing/distr-tracing-tempo-installing.adoc

:_mod-docs-content-type: PROCEDURE
[id="distr-tracing-tempo-object-storage-setup-azure-sts-install_{context}"]
= Setting up the Azure storage with the Security Token Service

You can set up Azure storage with the Security Token Service (STS) by using the Azure Command Line Interface (AZ CLI).

:FeatureName: Azure storage with the Security Token Service
include::snippets/technology-preview.adoc[leveloffset=+1]

.Prerequisites

* You have installed the latest version of the AWS CLI.
* Created an Azure Storage Account.
* Created an Azure Blob Storage Container.

.Procedure
. Create an Azure Managed identity
[source,terminal]
----
az identity create \
  --name <IDENTITY_NAME> \ <1>
  --resource-group <RESOURCE_GROUP> \ <2>
  --location <REGION> \ <3>
  --subscription <SUBSCRIPTION_ID> <4>
----
<1> Name of the identity to be created.
<2> The Azure resource group where the identity will be created.
<3> The Azure region; it should be the same region as the resource group.
<4> Azure subscription ID.
+
. Create federated credentials. Federated credentials allow Kubernetes service accounts to authenticate as the Azure managed identity without storing secrets or using service principals. You need to create one per Kubernetes service account. In this case, the operator will create one service account for all components and one specific for the frontend component.
[source,terminal]
----
az identity federated-credential create \
  --name <CREDENTIAL_NAME> \ <1>
  --identity-name <IDENTITY_NAME> \
  --resource-group <RESOURCE_GROUP> \
  --issuer <CLUSTER_ISSUER> \ <2>
  --subject <TEMPO_SA_SUBJECT> \ <3>
  --audiences <AUDIENCE> <4>
----
<1> Name of the federated credential.
<2> The OIDC issuer URL of the Kubernetes cluster. You can get it using the following command: `oc get authentication cluster -o json | jq -r .spec.serviceAccountIssuer`
<3> The Kubernetes service account subject, in the format: `system:serviceaccount:<namespace>:tempo-<tempo-instance-name>`
<4> The expected audience used to validate tokens, commonly set to `api://AzureADTokenExchange`.
+
Create frontend federated credential.
[source,terminal]
----
az identity federated-credential create \
  --name <CREDENTIAL_NAME>-frontend \ <1>
  --identity-name <IDENTITY_NAME> \
  --resource-group <RESOURCE_GROUP> \
  --issuer <CLUSTER_ISSUER> \
  --subject <TEMPO_SA_QUERY_FRONTEND_SUBJECT> \ <2>
  --audiences <AUDIENCE> | jq
----
<1> Name of the federated credential.
<2> The Kubernetes service account subject, in the format: `system:serviceaccount:<namespace>:tempo-<tempo-instance-name>`
+
. Assign the "Storage Blob Data Contributor" role to the managed identity's service principal.
[source,terminal]
----
az role assignment create \
  --assignee <ASSIGNEE_NAME> \ <1>
  --role "Storage Blob Data Contributor" \
  --scope "/subscriptions/<SUBSCRIPTION_ID>
----
<1> Managed identity principal. Can be obtained with the following command: `az ad sp list --all --filter "servicePrincipalType eq 'ManagedIdentity'" | jq -r --arg idName <IDENTITY_NAME> '.[] | select(.displayName == $idName) | .appId'`
+
. Fetch the client ID of the existing managed identity.
[source,terminal]
----
CLIENT_ID=$(az identity show \
  --name <IDENTITY_NAME> \
  --resource-group <RESOURCE_GROUP> \
  --query clientId \
  -o tsv)
----
+
. Create a Kubernetes secret for Azure WIF.
[source,terminal]
----
kubectl create -n <TEMPO_NAMESPACE> secret generic azure-secret \
  --from-literal=container=<$AZURE_STORAGE_AZURE_CONTAINER> \ <1>
  --from-literal=account_name=<AZURE_STORAGE_AZURE_ACCOUNTNAME> \ <2>
  --from-literal=client_id=<CLIENT_ID> \ <3>
  --from-literal=audience=<AUDIENCE> \ <4>
  --from-literal=tenant_id=<TENANT_ID> <5>
----
<1> Azure Blob storage container.
<2> Azure Storage account name.
<3> Client ID of the managed identity (obtained in the previous step).
<4> Audience, optional (defaults to `api://AzureADTokenExchange`).
<5> Azure Tenant ID.