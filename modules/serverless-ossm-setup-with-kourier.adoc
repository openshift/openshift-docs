// Module included in the following assemblies:
//
// * serverless/service_mesh/serverless-ossm.adoc

[id="serverless-ossm-setup-with-kourier_{context}"]
= Using {ProductShortName} with Kourier enabled

If the default Kourier ingress is enabled for your {ServerlessProductName} deployment, you can follow this procedure to enable additional {ProductShortName} functionality on the cluster.

.Prerequisites

* Install the {ServerlessOperatorName} and Knative Serving.
* Install {ProductName}.

.Procedure

. Add the namespaces that you would like to integrate with {ProductShortName} to the `ServiceMeshMemberRoll` object as members:
+
[source,yaml]
----
$ oc apply -f - <<EOF
apiVersion: maistra.io/v1
kind: ServiceMeshMemberRoll
metadata:
  name: default
  namespace: istio-system
spec:
  members: <1>
    - default
    - example-namespace
EOF
----
<1> A list of namespaces to be integrated with {ProductShortName}.
+
[IMPORTANT]
====
Adding sidecar injection to pods in system namespaces such as `knative-serving` and `knative-serving-ingress` is not supported.
====
. Create a network policy that permits traffic flow from Knative system pods to Knative services:
.. Add the `serving.knative.openshift.io/system-namespace=true` label to the `knative-serving` namespace:
+
[source,terminal]
----
$ oc label namespace knative-serving serving.knative.openshift.io/system-namespace=true
----
.. Add the `serving.knative.openshift.io/system-namespace=true` label to the `knative-serving-ingress` namespace:
+
[source,terminal]
----
$ oc label namespace knative-serving-ingress serving.knative.openshift.io/system-namespace=true
----
.. For each namespace that you would like to integrate with {ProductShortName}, copy the following `NetworkPolicy` resource into a YAML file:
+
[source,yaml]
----
$ oc apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-serving-system-namespace
  namespace: <namespace>
spec:
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          serving.knative.openshift.io/system-namespace: "true"
  podSelector: {}
  policyTypes:
  - Ingress
EOF
----
