// Module included in the following assemblies:
// * serverless-logic/serverless-logic-upgrading-operator-from-1-36-to-1-37

:_mod-docs-content-type: PROCEDURE
[id="serverless-logic-upgrade-1-37-redeploying-workflows-with-gitops-profile_{context}"]
= Redeploying workflows with the gitops profile

[role="_abstract"]
After upgrading the {ServerlessLogicOperatorName} to version 1.37.0, you must rebuild and redeploy workflows that use the `gitops` profile to complete the upgrade process.

.Procedure

. Rebuild the workflow image using the OpenShift Serverless Logic 1.37.0 serverless workflow builder image:
+
[source,terminal]
----
registry.redhat.io/openshift-serverless-1/logic-swf-builder-rhel9:1.37.0
----
+
When rebuilding the image, consider the following behavior.
+
By default, the {ServerlessLogicOperatorName} generates a workflow deployment with `imagePullPolicy: IfNotPresent`. This means that if an already deployed workflow `<workflow_name>` is redeployed with the same image name, even when that image was rebuilt, the previously downloaded image is reused.

. Ensure that the new image is picked up by using one of the following alternatives:

.. Use a new image tag and configure the workflow to use it.
+
Current image:
+
[source,terminal]
----
quay.io/my-images/my-workflow:1.0
----
+
New image:
+
[source,terminal]
----
quay.io/my-images/my-workflow:1.0-1
----
+
Update the workflow custom resource as follows:
+
[source,yaml]
----
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlow
metadata:
  name: my-workflow
  annotations:
    sonataflow.org/description: My Workflow
    sonataflow.org/version: '1.0'
    sonataflow.org/profile: gitops
spec:
  podTemplate:
    container:
      # only change the image name/tag
      image: quay.io/my-images/my-workflow:1.0-1
  flow:
    # the workflow definition (don't change)
----

.. Preserve the image name and configure the workflow with `imagePullPolicy: Always` as follows:
+
[source,yaml]
----
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlow
metadata:
  name: my-workflow
  annotations:
    sonataflow.org/description: My Workflow
    sonataflow.org/version: '1.0'
    sonataflow.org/profile: gitops
spec:
  podTemplate:
    container:
      image: quay.io/my-images/my-workflow:1.0
      # only change the imagePullStrategy
      imagePullPolicy: Always
  flow:
    # the workflow definition (don't change).
----
+
[NOTE]
====
When rebuilding the image and redeploying the workflow, do not change the workflow definition or any workflow-related assets. This includes the workflow name, version, and description.
====

. Ensure that all Kubernetes resources required by the workflow are created. This includes any user-provided resources, such as a `ConfigMap` containing the `application.properties` file.

. Redeploy the workflow by running the following command:
+ 
[source,terminal]
----
$ oc apply -f <workflow_yaml> -n <target_namespace>
----
