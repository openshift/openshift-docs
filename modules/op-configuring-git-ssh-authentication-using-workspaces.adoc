// This module is included in the following assemblies:
// * secure/authenticating-pipelines-and-tasks-using-secrets.adoc

:_mod-docs-content-type: PROCEDURE
[id="op-configuring-git-ssh-authentication-using-workspaces_{context}"]
= Configuring SSH authentication for Git using workspaces

[role="_abstract"]
For a pipeline to retrieve resources from repositories configured with SSH keys, you must configure the SSH-based authentication for that pipeline.

To configure SSH-based authentication for a pipeline, create an authentication secret with the SSH private key, configure a named workspace for this secret in the task, and specify the secret when running the task.

.Procedure

. Create the Git SSH authentication secret from files in an existing `.ssh` directory by entering the following command:
+
[source,terminal]
----
$ oc create secret generic my-github-ssh-credentials \
  --from-file=id_ed25519=/home/user/.ssh/id_ed25519 \ 
  --from-file=known_hosts=/home/user/.ssh/known_hosts 
----
+
`my-github-ssh-credentials`:: The name of the secret, in this example, `my-github-ssh-credentials`
`id_ed25519`:: The name and full path name of the private key file, in this example, `/home/user/.ssh/id_ed25519`
`known_hosts`:: The name and full path name of the known hosts file, in this example, `/home/user/.ssh/known_hosts`

. In your task definition, configure a named workspace for the Git authentication, for example, `ssh-directory`:
+
.Example definition of a workspace
[source, yaml]
----
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: git-clone
spec:
  workspaces:
    - name: ssh-directory
      description: |
        A .ssh directory with private key, known_hosts, config, etc.
----

. In the steps of the task, access the directory using the path in the `$(workspaces.<workspace_name>.path)` environment variable, for example, `$(workspaces.ssh-directory.path)`

. When running the task, specify the secret for the named workspace by including the `--workspace` argument in the `tkn task start` command:
+
[source, terminal]
----
$ tkn task start <task_name>
      --workspace name=<workspace_name>,secret=<secret_name>
      # ...
----
+
Replace `<workspace_name>` with the name of the workspace that you configured and `<secret_name>` with the name of the secret that you created.

.Example task for cloning a Git repository using an SSH key for authentication
[source,yaml,subs="attributes+"]
----
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: git-clone
spec:
  workspaces:
    - name: output
      description: The git repo will be cloned onto the volume backing this Workspace.
    - name: ssh-directory
      description: |
        A .ssh directory with private key, known_hosts, config, etc. Copied to
        the user's home before git commands are executed. Used to authenticate
        with the git remote when performing the clone. Binding a Secret to this
        Workspace is strongly recommended over other volume types
  params:
    - name: url
      description: Repository URL to clone from.
      type: string
    - name: revision
      description: Revision to checkout. (branch, tag, sha, ref, etc...)
      type: string
      default: ""
    - name: gitInitImage
      description: The image providing the git-init binary that this Task runs.
      type: string
      default: "gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.37.0"
  results:
    - name: commit
      description: The precise commit SHA that was fetched by this Task.
    - name: url
      description: The precise URL that was fetched by this Task.
  steps:
    - name: clone
      image: "$(params.gitInitImage)"
      script: |
        #!/usr/bin/env sh
        set -eu
        # This is necessary for recent version of git
        git config --global --add safe.directory '*'
        cp -R "$(workspaces.ssh-directory.path)" "${HOME}"/.ssh
        chmod 700 "${HOME}"/.ssh
        chmod -R 400 "${HOME}"/.ssh/*
        CHECKOUT_DIR="$(workspaces.output.path)/"
        /ko-app/git-init \
          -url="$(params.url)" \
          -revision="$(params.revision)" \
          -path="${CHECKOUT_DIR}"
        cd "${CHECKOUT_DIR}"
        RESULT_SHA="$(git rev-parse HEAD)"
        EXIT_CODE="$?"
        if [ "${EXIT_CODE}" != 0 ] ; then
          exit "${EXIT_CODE}"
        fi
        printf "%s" "${RESULT_SHA}" > "$(results.commit.path)"
        printf "%s" "$(params.url)" > "$(results.url.path)"
----
+
`${HOME}/.ssh`:: The script copies the content of the secret (in the form of a folder) to `${HOME}/.ssh`, which is the standard folder where `ssh` searches for credentials.
+
.Example command for running the task
[source, terminal]
----
$ tkn task start git-clone
      --param url=git@github.com:example-github-user/buildkit-tekton
      --workspace name=output,emptyDir=""
      --workspace name=ssh-directory,secret=my-github-ssh-credentials
      --use-param-defaults --showlog
----
