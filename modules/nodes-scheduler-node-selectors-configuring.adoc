// Module included in the following assemblies:
//
// * nodes/nodes-scheduler-node-selector.adoc

[id="nodes-scheduler-node-selectors-configuring_{context}"]
= Configuring the Pod Node Constraints admission controller to use node selectors in {product-title}

You can configure the Pod Node Constraints admission controller to ensure that pods are only placed onto nodes with specific labels.

.Prerequisites

. Ensure you have the desired labels
ifdef::openshift-enterprise,openshift-origin[]
labels on your nodes. 
endif::openshift-enterprise,openshift-origin[]
ifdef::openshift-dedicated[]
labels on your nodes (request changes by opening a support case on the
https://access.redhat.com/support/[Red Hat Customer Portal]).
endif::openshift-dedicated[]
and node selector set up in your environment.
+
For example, make sure that your pod configuration features the `nodeSelector`
value indicating the desired label:
+
[source,yaml]
----
apiVersion: v1
kind: Pod
spec:
  nodeSelector:
    <key>: <value>
...
----

. Create a file containing the admission controller information:
+
[source,yaml]
----
podNodeSelectorPluginConfig:
 clusterDefaultNodeSelector: name-of-node-selector
 namespace1: name-of-node-selector
 namespace2: name-of-node-selector
----
+
For example:
+
[source,yaml]
----
podNodeConstraintsPluginConfig:
 clusterDefaultNodeSelector: ns1
 ns1: region=west,env=test,infra=fedora,os=fedora
----

. Edit the `kubeapiserver` to add an `admissionPluginConfig`:
+
----
oc edit kubeapiserver
----
+
[source,yaml]
----
apiVersion: autoscaling.openshift.io <1>
kind: KubeAPIServer

....

unsupportedConfigOverrides:
  admissionPluginConfig:
    enabledPlugins:
    - name: PodNodeConstraints  <2>
      path: podnodeconstraints.yaml
      nodeSelectorLabelBlacklist: <3>
      kubernetes.io/hostname:
      - <label>
----
<1> Specify the `autoscaling.openshift.io` API.
<2> Add the `PodNodeConstraints` admission controller and the path to the controller file you created. 
<3>

[NOTE] 
====
If you are using node selectors and node affinity in the same pod configuration, note the following:

* If you configure both `nodeSelector` and `nodeAffinity`, both conditions must be satisfied for the pod to be scheduled onto a candidate node.

* If you specify multiple `nodeSelectorTerms` associated with `nodeAffinity` types, then the pod can be scheduled onto a node if one of the `nodeSelectorTerms` is satisfied.

* If you specify multiple `matchExpressions` associated with `nodeSelectorTerms`, then the pod can be scheduled onto a node only if all `matchExpressions` are satisfied.
====

