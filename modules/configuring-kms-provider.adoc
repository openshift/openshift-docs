// Module included in the following assemblies:
//
//security/kms_encryption_provider/index.adoc

:_mod-docs-content-type: PROCEDURE
[id="kms-provider-configuring_{context}"]
= Configuring the KMS Encryption Provider

To use your third party key management service (KMS) with {product-title} you need to configure the KMS Encryption Provider.

.Prerequisites

* You are logged in to {product-title} as a user with the `cluster-admin` role.
* The TechPreviewNoUpgrade feature gate is enabled.
* The KMS Encryption Provider is installed.

.Procedure

. Clone the kms-setup repository:
//I assume this step isn't accurate. Where do customers get the repository?
[source,terminal]
----
$ git clone git@github.com:gangwgr/kms-setup.git
----

. Navigate to the `kms-setup` folder.

. Generate the KMS key:

.. Identify the IAM policy attached to the master node from the AWS web console *EC2* -> *Instances* -> *Master node* -> *Instance ID* -> *IAM role*.

.. Execute the `aws-key-setup2.sh` script, providing the IAM role and a role name.
+
[source,terminal]
----
$ chmod 777 aws-key-setup2.sh
$ ./aws-key-setup2.sh <above_IAM_role> <role_name><1>
----
<1> You can use any role name for this variable.

.. Note the generated KMS Key ARN.

. Generate the KMS key ID:

.. Edit the `hashcode.go` file to update the KeyARN with the KMS Key ARN obtained in the previous step.

.. Run the `hashcode.go` file.

[source,terminal]
----
$ export PATH=$PATH:/usr/local/go/bin
$ go run hashcode.go
----

.. Note the generated key ID.

. Create the KMS plugin manifest:

.. Edit the `kms-demonset.yaml` file to include the key ARN and the hashcode key ID you generated.

.. Apply the daemonset manifest.

[source,terminal]
----
$ oc apply -f kms-demonset.yaml
----

.Verification

. Verify the KMS plugin pods are in the `Running` state in the `openshift-kube-apiserver` namespace.

[source,terminal]
----
$ oc get pods -n openshift-kube-apiserver
----