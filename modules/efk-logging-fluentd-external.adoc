// Module included in the following assemblies:
//
// * logging/efk-logging-external.adoc

[id="efk-logging-fluentd-external-{context}"]
= Configuring Fluentd to send logs to an external log aggregator

You can configure Fluentd to send a copy of its logs to an external log
aggregator, and not the default Elasticsearch, using the `secure-forward`
plug-in. From there, you can further process log records after the locally
hosted Fluentd has processed them. 

ifdef::openshift-origin[]
The `secure-forward` plug-in is provided with the Fluentd image as of v1.4.0.
endif::openshift-origin[]

The logging deployment provides a `secure-forward.conf` section in the Fluentd configmap
for configuring the external aggregator:

.Prerequisites

Set cluster logging to the unmanaged state.

.Procedure

To send a copy of Fluentd logs to an external log aggregator:

. Edit the Fluentd configuration map:
+
----
$ oc edit configmap/fluentd -n openshift-logging

secure-forward.conf: |
  # <store> 
  # @type secure_forward

  # self_hostname ${hostname}
  # shared_key <SECRET_STRING>

  # secure yes
  # enable_strict_verification yes

  # ca_cert_path /etc/fluent/keys/your_ca_cert
  # ca_private_key_path /etc/fluent/keys/your_private_key
    # for private CA secret key
  # ca_private_key_passphrase passphrase

  # <server>
    # or IP
  #   host server.fqdn.example.com
  #   port 24284
  # </server>
  # <server>
    # ip address to connect
  #   host 203.0.113.8
    # specify hostlabel for FQDN verification if ipaddress is used for host
  #   hostlabel server.fqdn.example.com
  # </server>
  # </store>
----

. Add certificates to be used in `secure-forward.conf` to the existing
secret that is mounted on the Fluentd pods. The `your_ca_cert` and
`your_private_key` values must match what is specified in `secure-forward.conf`
in `configmap/logging-fluentd`:
+
----
$ oc patch secrets/fluentd --type=json \
  --patch "[{'op':'add','path':'/data/your_ca_cert','value':'$(base64 /path/to/your_ca_cert.pem)'}]"
$ oc patch secrets/fluentd --type=json \
  --patch "[{'op':'add','path':'/data/your_private_key','value':'$(base64 /path/to/your_private_key.pem)'}]"
----
+
[NOTE]
====
Replace `your_private_key` with a generic name. This is a link to the JSON path,
not a path on your host system.
====
+
When configuring the external aggregator, it must be able to accept messages
securely from Fluentd.
+
* If using Fluentd 1.0 or later, configure the built-in *in_forward* plug-in with the appropriate security parameters. 
+
In Fluentd 1.0 and later, *in_forward* implements the server (receiving) side, and *out_forward* implements the client (sending) side.
+
For Fluentd versions 1.0 or higher, you can find further explanation of link:https://docs.fluentd.org/v1.0/articles/in_forward[how to set up the *inforward* plugin]
and link:https://docs.fluentd.org/v1.0/articles/out_forward[the *out_forward* plugin].

* If using Fluentd 0.12 or earlier, you must have the *fluent-plugin-secure-forward* plug-in installed and 
make use of the input plug-in it provides. In Fluentd 0.12, the same `fluent-plugin-secure-forward` plugin implements both the client (sending) side and the server (receiving) side.
+
For Fluentd 0.12 you can find further explanation of link:https://github.com/tagomoris/fluent-plugin-secure-forward[*fluent-plugin-secure-forward* plug-in in fluent-plugin-secure-forward repository].


The following is an example of a `in_forward` configuration for Fluentd 1.0 and later:

----
<source>
  @type forward
  @id my-secure-forward
  port 24284
  bind 0.0.0.0
  <security>
    self_hostname server.fqdn.example.com
    shared_key    <shared_key_between_forwarder_and_forwardee>
  </security>
  <transport tls>
    cert_path        /path/to/my/tlsservercert
    private_key_path /path/to/my/tlsserverkey
    private_key_passphrase not_used_if_key_is_unencrypted
  </transport>
</source>
----

