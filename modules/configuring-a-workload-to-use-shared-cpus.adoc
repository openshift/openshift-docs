:_mod-docs-content-type: PROCEDURE

[id="configuring-a-workload-to-use-shared-cpus_{context}"]
= Configuring a workload to use shared CPUs

You can pin lightweight workload tasks to shared CPUs to improve CPU resource efficiency. When you enable shared CPUs for a node by using a performance profile, and request shared CPUs by using a workload's pod specification, containers deployed on the pod feature the `OPENSHIFT_SHARED_CPUS` and `OPENSHIFT_ISOLATED_CPUS` environment variables. These variables show the IDs of the shared and isolated CPUs. 

You can use the `OPENSHIFT_SHARED_CPUS` environment variable to pin latency-tolerant application threads to shared CPUs. 

For latency-sentsitive application threads, use the `OPENSHIFT_ISOLATED_CPUS` environment variable.

.Prerequisites

* Log in as a user with `cluster-admin` privileges.

* You defined and enabled shared CPUs by using a performance profile.

//* You enabled the `TechPreviewNoUpgrade` feature set on the cluster. For more information about enabling a feature set, see the _Additional resources_ section.
// +
// [WARNING]
// ====
// Enabling the `TechPreviewNoUpgrade` feature set cannot be undone and prevents minor version updates. These feature sets are not recommended on production clusters.
// ====

.Procedure

. Create a namespace by running the following command.
+
[source,terminal]
----
$ oc create namespace <namespace_name>
----
+
[NOTE]
====
To use shared CPUs, you must use a namespace with the `workload.mixedcpus.openshift.io/allowed` annotation.
====

. Add the required annotation to the namespace by running the following command:
+
[source,terminal]
----
$ oc annotate namespace <namespace_name> workload.mixedcpus.openshift.io/allowed=''
----
+
.Example output
[source,terminal]
----
namespace/<namespace_name> annotate
----

. Create a `Pod` resource that requests shared CPUs:

.. Create a YAML file that defines the `Pod` resource:
+
--
.Example `shared-cpu-pod.yaml` file
[source,yaml]
----
apiVersion: v1
kind: Pod
metadata: 
  name: dpdk-pod
  metadata: <namespace_name> <1>
spec:
 runtimeClassName: performance-example-shared-cpu-pp <2>
 containers:
  - name: dpdk-cnt
    image: image-address
    resources:
     requests: 
      cpu: “2” <3>
      memory: “100m” <4>
      workload.openshift.io/enable-shared-cpus: ”1” <5>
     limits:
      cpu: “2”
      memory: “100m”
      workload.openshift.io/enable-shared-cpus: ”1”
----
<1> Specify the namespace with the `workload.mixedcpus.openshift.io/allowed=''` annotation.
<2> Specify the performance profile with the shared CPU configuration in the format `performance-<performance_profile_name>`.
<3> Specify the number of cores required.
+
[IMPORTANT]
====
To use shared CPUs, you must create a pod with a QoS class of `Guaranteed`. To specify a pod with a QoS class of `Guaranteed`, the memory limit must equal the memory request, and the CPU limit must equal the CPU request. The CPU limit and CPU request values must be integers. 
====
<4> Specify the memory required. 
<5> This is a boolean field to enable shared CPUs for the pod. Enter `1` to enable shared CPUs. The shared CPUs feature is disabled by default.
--

.. Create the `Pod` resource by running the following command:
+
[source,terminal]
----
$ oc create -f shared-cpu-pod.yaml
----
+
.Example output
[source,terminal]
----
pod/dpdk-pod created
----

.Verification

. Verify that you can access the `OPENSHIFT_SHARED_CPUS` and `OPENSHIFT_ISOLATED_CPUS` environment variables from within the pod. You can use this information to pin lightweight tasks from the pod's container processes to shared CPUs:

.. Start an interactive shell within the target pod by running the following command:
+
[source,terminal]
----
$ oc exec -it dpdk-pod -- /bin/sh
----

.. Verify that you can access the environment variables by running the following command:
+
[source,terminal]
----
# env | grep OPENSHIFT
----
+
.Example output
[source,terminal]
----
OPENSHIFT_SHARED_CPUS=<CPU_ID> <1>
OPENSHIFT_ISOLATED_CPUS=<CPUD_ID>
----
<1> You can view the CPU ID for shared CPUs and isolated CPUs in the `OPENSHIFT_SHARED_CPUS` and `OPENSHIFT_ISOLATED_CPUS`environment variables.
