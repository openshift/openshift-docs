// CNF-1498 Validate and Document Intel SRO and SRIOV FEC Operator
// Module included in the following assemblies:
//
// *cnf-optimize-data-performance-n3000.adoc

[id="cnf-verify-sriov-operator-n3000_{context}"]
= Verifying application pod access and FPGA usage on OpenNESS

OpenNESS is an edge computing software toolkit that you can use to onboard and manage applications and network functions on any type of network.

To verify all OpenNESS features are working together, including SR-IOV binding, the device plugin, Wireless Base Band Device (bbdev) configuration, and SR-IOV (FEC) VF functionality inside a non-root pod, you can build an image and run a simple validation application for the device.

For more information, go to link:http://www.openness.org[openess.org].

.Prerequisites

* Optional: Intel FPGA PAC N3000 card
* Node or nodes installed with the n3000-operator
* Node or nodes installed with the SR-IOV-FEC operator
* Real-Time kernel and huge pages configured with Performance Addon Operator
* Log in as a user with `cluster-admin` privileges

.Procedure

. Create a namespace for the test by completing the following actions:

.. Define the `test-bbdev` namespace by creating a file named `test-bbdev-namespace.yaml` file as shown in the following example:
+
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  name: test-bbdev
  labels:
    openshift.io/run-level: "1"
----

.. Create the namespace by running the following command:
+
[source,terminal]
----
$ oc create -f test-bbdev-namespace.yaml
----

. Create the following `Pod` specification, and then save the YAML in the `pod-test.yaml` file:
+
[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: pod-bbdev-sample-app
  namespace: test-bbdev <1>
spec:
  containers:
  - securityContext:
      privileged: false
      capabilities:
        add:
         - IPC_LOCK
         - SYS_NICE
    name: bbdev-sample-app
    image: bbdev-sample-app:1.0  <2>
    command: [ "sudo", "/bin/bash", "-c", "--" ]
    runAsUser: 0 <3>
    resources:
      requests:
        hugepages-1Gi: 4Gi <4>
        memory: 1Gi
        cpu: "4" <5>
        intel.com/intel_fec_5g: '1' <6>
        #intel.com/intel_fec_acc100: '1'
        #intel.com/intel_fec_lte: '1'
      limits:
        memory: 4Gi
        cpu: "4"
        hugepages-1Gi: 4Gi
        intel.com/intel_fec_5g: '1'
        #intel.com/intel_fec_acc100: '1'
        #intel.com/intel_fec_lte: '1
----
<1> Specify the `namespace` you created in step 1.
<2> This defines the test image containing the compiled DPDK.
<3> Make the container execute internally as the root user.
<4> Specify hugepage size `hugepages-1Gi` and the quantity of hugepages that will be allocated to the pod. Hugepages and isolated CPUs need to be configured using the Performance Addon Operator.
<5> Specify the number of CPUs.
<6> Testing of the N3000 5G FEC configuration is supported by `intel.com/intel_fec_5g`.
+
[NOTE]
====
To test the ACC100 configuration, uncomment `intel.com/intel_fec_acc100` by removing the # symbol.
To test the N3000 4G/LTE configuration, uncomment `intel.com/intel_fec_lte` by removing the # symbol.
Only one resource can be active at any time.
====

. Create the pod:
+
[source,terminal]
----
$ oc apply -f pod-test.yaml
----

. Check that the pod is created:
+
[source,terminal]
----
$ oc get pods -n test-bbdev
----
+
.Example output
[source,terminal]
----
NAME                                            READY           STATUS          RESTARTS        AGE
pod-bbdev-sample-app                            1/1             Running         0               80s
----

. Use a remote shell to log in to the `pod-bbdev-sample-app`:
+
[source,terminal]
----
$ oc rsh pod-bbdev-sample-app
----
+
.Example output
[source,terminal]
----
sh-4.4#
----

. Print a list of environment variables:
+
[source,terminal]
----
sh-4.4# env
----
+
.Example output
[source,terminal]
----
N3000_CONTROLLER_MANAGER_METRICS_SERVICE_PORT_8443_TCP_ADDR=172.30.133.131
SRIOV_FEC_CONTROLLER_MANAGER_METRICS_SERVICE_PORT_8443_TCP_PROTO=tcp
DPDK_VERSION=20.11
PCIDEVICE_INTEL_COM_INTEL_FEC_5G=0.0.0.0:1d.00.0 <1>
~/usr/bin/env
HOSTNAME=fec-pod
----
+
<1> This is the PCI address of the virtual function. Depending on the resource that you requested in the `pod-test.yaml` file, this can be any one of following three PCI addresses:

* PCIDEVICE_INTEL_COM_INTEL_FEC_ACC100
* PCIDEVICE_INTEL_COM_INTEL_FEC_5G
* PCIDEVICE_INTEL_COM_INTEL_FEC_LTE

. Change to the `test-bbdev` directory:
+
[source,terminal]
----
sh-4.4# cd test/test-bbdev/
----
+
[NOTE]
====
The directory is in the pod and not on your local computer.
====

. Check the CPUs that are assigned to the pod:
+
[source,terminal]
----
sh-4.4# export CPU=$(cat /sys/fs/cgroup/cpuset/cpuset.cpus)
sh-4.4# echo ${CPU}
----
This prints out the CPUs that are assigned to the `fec.pod`.
+
.Example output
[source,terminal]
----
24,25,64,65
----

. Run the `test-bbdev` application to test the device:
+
[source,terminal]
----
sh-4.4# ./test-bbdev.py -e="-l ${CPU} -a ${PCIDEVICE_INTEL_COM_INTEL_FEC_5G}" -c validation \ -n 64 -b 32 -l 1 -v ./test_vectors/*"
----
+
.Example output
[source,terminal]
----
Executing: ../../build/app/dpdk-test-bbdev -l 24-25,64-65 0000:1d.00.0 -- -n 64 -l 1 -c validation -v ./test_vectors/bbdev_null.data -b 32
EAL: Detected 80 lcore(s)
EAL: Detected 2 NUMA nodes
Option -w, --pci-whitelist is deprecated, use -a, --allow option instead
EAL: Multi-process socket /var/run/dpdk/rte/mp_socket
EAL: Selected IOVA mode 'VA'
EAL: Probing VFIO support...
EAL: VFIO support initialized
EAL:   using IOMMU type 1 (Type 1)
EAL: Probe PCI driver: intel_fpga_5ngr_fec_vf (8086:d90) device: 0000:1d.00.0 (socket 1)
EAL: No legacy callbacks, legacy socket not created



===========================================================
Starting Test Suite : BBdev Validation Tests
Test vector file = ldpc_dec_v7813.data
Device 0 queue 16 setup failed
Allocated all queues (id=16) at prio0 on dev0
Device 0 queue 32 setup failed
Allocated all queues (id=32) at prio1 on dev0
Device 0 queue 48 setup failed
Allocated all queues (id=48) at prio2 on dev0
Device 0 queue 64 setup failed
Allocated all queues (id=64) at prio3 on dev0
Device 0 queue 64 setup failed
All queues on dev 0 allocated: 64
+ ------------------------------------------------------- +
== test: validation
dev:0000:b0:00.0, burst size: 1, num ops: 1, op type: RTE_BBDEV_OP_LDPC_DEC
Operation latency:
        avg: 23092 cycles, 10.0838 us
        min: 23092 cycles, 10.0838 us
        max: 23092 cycles, 10.0838 us
TestCase [ 0] : validation_tc passed
 + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ +
 + Test Suite Summary : BBdev Validation Tests
 + Tests Total :        1
 + Tests Skipped :      0
 + Tests Passed :       1 <1>
 + Tests Failed :       0
 + Tests Lasted :       177.67 ms
 + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ +
----
+
<1> While some tests can be skipped, be sure that the vector tests pass.
