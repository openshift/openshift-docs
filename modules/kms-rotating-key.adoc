// Module included in the following assemblies:
//
//security/kms_encryption_provider/index.adoc

:_mod-docs-content-type: PROCEDURE
[id="kms-provider-rotating-key_{context}"]
= Rotating the KMS Encryption Provider encryption key



.Prerequisites

* You are logged in to {product-title} as a user with the `cluster-admin` role.
* The TechPreviewNoUpgrade feature gate is enabled.
* The KMS Encryption Provider is installed.
* Your data is not encrypted.

.Procedure

.Enable KMS encryption with a new key

.. Generate a new ARN:KMS key by following the instructions in the "Configuring the KMS Encryption Provider" section of the document. This new key must be different from the previous one.

.. Using the new KMS ARN, generate the KMS key ID as you did in the "Configuring the KMS Encryption Provider" section of the document.

.. Edit the `hashcode.go` file to update the KeyARN with the new KMS Key ARN from the previous step.

.. Run the `hashcode.go` file.
+
[source,terminal]
----
$ export PATH=$PATH:/usr/local/go/bin
$ go run hashcode.go
----
+
.. Note the generated key ID.

.. Copy the `kms-demonset.yaml` file and save it as `kms-daemonset_new.yaml`. Update the file with the newly generated KMS ARN, key ID, and hashcode.

.. Change the port number in the `kms-daemonset_new.yaml` file to any port number other than the one used before.

.. Change all occurrences of the name field to reflect the new daemonset name. For example, aws-kms-plugin-new.

.. Apply this new kms-daemonset_new.yaml configuration:
+
[source,terminal]
----
$ oc apply -f kms-daemonset_new.yaml
----
+
.. Verify that the new triplet KMS plugin pods are running:
+
[source,terminal]
----
$ oc get po -n openshift-kube-apiserver
----
+
.. Enable KMS encryption with the newly generated KMS key ID:
+
[source,terminal]
----
$ oc patch apiserver cluster --type=merge -p '{ "spec": { "encryption": { "type": "KMS", "kms": { "type": "AWS", "aws": { "keyARN": "arn:aws:kms:us-east-2:301721915996:key/291760ae-349c-42ce-b898-0202a83425d2", "region": "us-east-2" } } } } }'
----
+
Wait for the revision rollout to complete.

.. Retrieve the latest API server revision. Enter the following command to check currentRevision and targetRevision.
+
[source,terminal]
----
$ oc get kubeapiserver cluster -o json | jq '.status.nodeStatuses'
----
+
Wait for the `currentRevision` value to attain the same `targetRevision` value, if it is non-zero, to ensure you have the latest active revision.

.. Check the active encryption configuration to confirm the old KMS entry is no longer present:
+
[source,terminal]
----
$ oc get secrets -n openshift-kube-apiserver encryption-config-<currentRevision> -o json | jq -r '.data["encryption-config"]' | base64 -d | jq
----
+
The output should show only three encryption entries: the new KMS, identity, and aesgcm. If the old KMS entry is not present, you can safely delete the old plugin.

.. Delete the old KMS daemonset plugin by entering the following command.
+
[source,terminal]
----
$ oc delete -f kms-demonset.yaml
----

.Verification

.. Verify that only the new plugin pods are running and the old plugin pods are deleted:

[source,terminal]
----
$ oc get po -n openshift-kube-apiserver
----

.. Verify that the cluster is healthy and no cluster operators are degraded:

[source,terminal]
----
$ oc get co
----