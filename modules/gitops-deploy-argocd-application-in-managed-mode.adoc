// Module included in the following assembly:
//
// * argocd-agent-installation/gitops-deploy-argocd-application-in-managed-mode.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-deploy-argocd-application-in-managed-mode_{context}"]
= Deploying an Argo CD application in managed mode

[role="_abstract"]
In managed agent mode, the *hub* acts as the source of truth. Argo CD applications must be created in the hub cluster. The agent creates and manages the application in the spoke cluster based on the configuration defined in the hub.

.Prerequisites

* You have deployed and configured the Principal and Agent component.
* You have the `oc` CLI installed and are logged in with sufficient permissions.
* You know the context names for both the hub (control plane) and spoke (workload) clusters.

.Procedure

. Create the Argo CD application manifest file, `application.yaml`, with the following configuration:
+
[source,yaml]
----
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-demo-app
  namespace: agent-managed
spec:
  project: default
  source:
    repoURL: https://github.com/redhat-developer/openshift-gitops-getting-started
    targetRevision: HEAD
    path: app
  destination:
    name: agent-managed  
    namespace: my-app
  syncPolicy:
    automated: 
      prune: true
      selfHeal: true
   managedNamespaceMetadata:
      labels:
        argocd.argoproj.io/managed-by: openshift-gitops
    syncOptions:
    - CreateNamespace=true
----
+
where:

`<namespace>`:: Specifies the namespace on the principal cluster where the Agent's managed applications are stored.
`<name>`:: Specifies the name of the Agent cluster on the hub.

. Apply the configuration in the hub cluster by running the following command:
+
[source,terminal]
----
$ oc apply -f application.yaml -n agent-managed --context "<principal_context>"
----
+
where:

`principal_context`:: Specifies the context that points to the hub cluster where the Principal component is running.

.Verification

. To verify that the application is created in the spoke cluster, run the following command:
+
[source,terminal]
----
$ oc get application.argoproj.io/my-demo-app -n openshift-gitops --context "<agent_context>"
----
+
where:

`agent_context`:: Specifies the context that points to the Agent cluster where the Agent component is running.

. To verify that the application is synced and healthy from the hub, run the following command:
+
[source,terminal]
----
$ oc get application.argoproj.io/my-demo-app -n agent-managed --context "<principal_context>"
----
+
where:

`principal_context`:: Specifies the context that points to the hub cluster where the Principal component is running.

. If the configuration is correct, the Agent creates the application and its associated resources in the spoke cluster.
Because the hub is the source of truth, any direct changes made in the spoke cluster are automatically reverted by the agent.