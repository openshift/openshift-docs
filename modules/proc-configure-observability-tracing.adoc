// Module included in the following assemblies:
//
// *observability/observability.adoc

:_mod-docs-content-type: PROCEDURE
[id="configure-observability-tracing_{context}"]
= Configuring tracing in {prodname}

[role="_abstract"]
You can enable tracing in {service-mesh} and the {prodname} components of Authorino and Limitador by directing traces to a central collector for improved observability and troubleshooting.
//TODO make the admonition a snippet
[IMPORTANT]
====
You must perform these steps on each {ocp} cluster that you want to use {prodname} on.
====

.Prerequisites

* You configured Grafana dashboards.
* You have a trace collector such as Tempo or Jaeger installed and configured to support OpenTelemetry.
//Q:OpenTelemetry Operator?

.Procedure

. Enable tracing in {service-mesh} by configuring your `Telemetry` custom resource as follows:
+
[source,bash]
----
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: mesh-default
  namespace: gateway-system
spec:
  tracing:
  - providers:
    - name: tempo-otlp
    randomSamplingPercentage: 100
----

. Configure a tracing `extensionProvider` for {service-mesh} in your `Istio` custom resource as follows:
+
[source,bash]
----
apiVersion: operator.istio.io/v1alpha1
kind: Istio
metadata:
  name: default
spec:
  namespace: gateway-system
  values:
    meshConfig:
      defaultConfig:
        tracing: {}
      enableTracing: true
      extensionProviders:
      - name: tempo-otlp
        opentelemetry:
          port: 4317
          service: tempo.tempo.svc.cluster.local

----
+
[IMPORTANT]
====
You must set the OpenTelemetry collector protocol in the service port `name` or `appProtocol` fields as described in the {service-mesh} documentation. For example, when using gRPC, the port name should begin with `grpc-` or the `appProtocol` should be `grpc`.
====

. Enable request tracing in your `Authorino` Custom Resource (CR) and send authentication and authorization traces to the central collector as follows:
+
[source,bash]
----
apiVersion: operator.authorino.kuadrant.io/v1beta1
kind: Authorino
metadata:
  name: authorino
spec:
  tracing:
    endpoint: rpc://tempo.tempo.svc.cluster.local:4317
----

. Enable request tracing in your `Limitador` CR and send rate limit traces to the central collector as follows:
+
[source,bash]
----
apiVersion: limitador.kuadrant.io/v1alpha1
kind: Limitador
metadata:
  name: limitador
spec:
  tracing:
    endpoint: rpc://tempo.tempo.svc.cluster.local:4317
----
+
[TIP]
====
Ensure that the tracing collector is the same one that {service-mesh} is sending traces to so that they can all be correlated later.
====
+
When the changes are applied, the Authorino and Limitador components are redeployed with tracing enabled.
+
[IMPORTANT]
====
Trace IDs do not propagate to WASM modules in {service-mesh} currently. This means that requests passed to Limitador do not have the relevant parent trace ID. However, if the trace initiation point is outside Service Mesh, the parent trace ID is available to Limitador and included in traces. This impacts on correlating traces from Limitador with traces from Authorino, the Gateway, and any other components in the request path.
====
