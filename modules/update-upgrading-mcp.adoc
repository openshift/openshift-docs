// Module included in the following assemblies:
//
// * storage/persistent_storage/persistent-storage-hostpath.adoc

[id="update-upgrading-mcp_{context}"]
= Delaying the update for specific nodes

There might be situations where you do not want to update specific nodes when you update a cluster. Updating nodes requires the nodes to be cordoned and drained, which marks the nodes as unschedulable and evicts all pods. For example, you can ensure that critical applications stay available during the update process. Delaying the update can also be helpful if you do not have a single maintenance window to complete the entire update process.

If you have specific nodes that you do not want to cordon and drain at the time of an update, before the update, create one or more machine config pools (MCPs) and move the nodes from their current MCP to one of the new MCPs. Then, pause the new MCPs. The nodes associated with the paused MCPs do not get cordoned, drained and updated. When you are ready to update those nodes, unpause the new MCPs, which starts the update process on those nodes. After the nodes are updated, verify that your applications are functioning properly. Then, move the nodes back to their original MCP, so that the nodes receive any configuration changes made to those MCPs. If you have more than one custom MCP, you can update one set of nodes at a time, to ensure everything is functioning properly before updating the other nodes.

[NOTE]
====
To ensure that the cluster remains stable, creating a custom MCP for the control plane nodes (also known as the master nodes) is not supported. The Machine Config Operator ignores any custom MCP created for the control plane nodes.
====

.Procedure

To delay updating specific nodes when you update your cluster:

. Create one or more MCP from a worker node.

.. List the worker nodes in your cluster.
+
[source,terminal]
----
$ oc get -l 'node-role.kubernetes.io/master!=' -o 'jsonpath={range .items[*]}{.metadata.name}{"\n"}{end}' nodes
----
+
.Example output
+
[source,terminal]
----
ci-ln-pwnll6b-f76d1-s8t9n-worker-a-s75z4
ci-ln-pwnll6b-f76d1-s8t9n-worker-b-dglj2
ci-ln-pwnll6b-f76d1-s8t9n-worker-c-lldbm
----

.. For the nodes you want to delay, add a custom label to the node:
+
[source,terminal]
----
$ oc label node <node name> node-role.kubernetes.io/<custom-label>=
----
+
For example:
+
[source,terminal]
----
$ oc label node ci-ln-0qv1yp2-f76d1-kl2tq-worker-a-j2ssz node-role.kubernetes.io/node-noupdate=
----
+
.Example output
+
[source,terminal]
----
node/ci-ln-gtrwm8t-f76d1-spbl7-worker-a-xk76k labeled
----

.. Create the new MCP:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfigPool
metadata:
  name: node-noupdate <1>
spec:
  machineConfigSelector:
    matchExpressions: <2>
      - {
         key: machineconfiguration.openshift.io/role
         operator: In 
         values: [worker,node-noupdate]
        } 
  nodeSelector:
    matchLabels:
      node-role.kubernetes.io/node-noupdate: "" <3>
----
<1> Specify a name for the machine config pool
<2> Specify a selector to filter keys. This selects all nodes with the `machineconfiguration.openshift.io/role` value equal to `worker` and `mcp-noupdate`.
<3> Specify the custom label you added to the node(s) that you want in this machine config pool.
+
[source,terminal]
----
$ oc create -f <file_name>
----
+
.Example output
+
[source,terminal]
----
machineconfigpool.machineconfiguration.openshift.io/mcp-noupdate created
----
+
.. View the list of MCPs in the cluster and their current state:
+
[source,terminal]
----
$ oc get machineconfigpool
----
+
.Example output
[source,terminal]
----
NAME       CONFIG                                                      UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
master     rendered-master-b0bb90c4921860f2a5d8a2f8137c1867            True      False      False      3              3                   3                     0                      97m
node-noupdate rendered-node-noudate-87ba3dec1ad78cb6aecebf7fbb476a36   True      False      False      1              1                   1                     0                      2m42s
worker     rendered-worker-87ba3dec1ad78cb6aecebf7fbb476a36            True      False      False      2              2                   2                     2                      97m
----
+
The new machine config pool, `node-noupdate`, is created and the number of nodes to which you added the custom label are shown in the machine counts. The worker MCP machine counts are reduced by the same number.  

. Pause the machine config pools that contain the nodes that you do not want to update:
+
[NOTE]
====
Pausing a machine config pool pauses the `kube-apiserver-to-kubelet-signer` automatic CA certificates rotation. Ensure that the pools not unpaused when the CA cert rotation is scheduled to occur. New CA certificates are generated at 292 days from the installation date and removed at 365 days from that date. To determine the next automatic CA certificate rotation, see the link:https://access.redhat.com/articles/5651701[Understand CA cert auto renewal in Red Hat OpenShift 4]. 
====
+
[source,terminal]
----
$ oc patch mcp/<mcp_name> --patch '{"spec":{"paused":true}}' --type=merge
----
+
For example:
+
[source,terminal]
----
$  oc patch mcp/node-noupdate --patch '{"spec":{"paused":true}}' --type=merge
----
+
.Example output
[source,terminal]
----
machineconfigpool.machineconfiguration.openshift.io/node-noupdate patched
----
+
. Start the update process. The update process only updates the MCPs that are not paused, including the control plane nodes.
+
. After the update is complete, when you want to update the nodes in the paused MCPs, unpause one MCP. Unpausing the MCP starts the update process for the pool of nodes:
+
[NOTE]
====
You can use the `maxUnavailable` parameter to specify the maximum number of pods that can be unavailable during the update. The default is 1.
====
+
[source,terminal]
----
$ oc patch mcp/node-noupdate --patch '{"spec":{"paused":false}}' --type=merge
----
+
For example:
+
[source,terminal]
----
$  oc patch mcp/node-noupdate --patch '{"spec":{"paused":false}}' --type=merge
----
+
.Example output
+
[source,terminal]
----
machineconfigpool.machineconfiguration.openshift.io/node-noupate patched
----
+
You can check the progress of the update by using the `oc get machineconfigpools` command.

. Test your applications on the updated nodes to ensure that they are working as expected.

. Move the newly-updated nodes back to their original MCP:

.. Ensure that the nodes have a `worker` label or a label from an MCP that is updated.
+
[source,terminal]
----
$ oc label node ci-ln-0qv1yp2-f76d1-kl2tq-worker-a-j2ssz node-role.kubernetes.io/worker=
----
+
.Example output if the `worker` label is present:
+
[source,terminal]
----
error: 'node-role.kubernetes.io/worker' already has a value (), and --overwrite is false
----
+
If the node does not have a `worker` label, or a label from an updated MCP, add the label. A node must have a role to be properly functioning in the cluster.

.. Remove the custom label from the node. 
+
[source,terminal]
----
$ oc label node <node_name> node-role.kubernetes.io/<custom-label>-
----
+
For example:
+
[source,terminal]
----
$ oc label node ci-ln-0qv1yp2-f76d1-kl2tq-worker-a-j2ssz node-role.kubernetes.io/node-noupdate-
----
+
.Example output
+
----
node/ci-ln-0qv1yp2-f76d1-kl2tq-worker-a-j2ssz labeled
----
+
The MCO moves the node(s) back to the original MCP and reconciles the node to the MCP configuration:
+
[source,terminal]
----
$oc get mcp
----
+
[source,terminal]
----
NAME           CONFIG                                                   UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
master         rendered-master-1203f157d053fd987c7cbd91e3fbc0ed         True      False      False      3              3                   3                     0                      61m
worker         rendered-worker-5ad4791166c468f3a35cd16e734c9028         True      False      False      3              3                   3                     0                      61m
---- 

. Optional: Delete the MCP:
+
[source,terminal]
----
$ oc delete mcp <mcp_name>
----

