// Module included in the following assemblies:
//
// * observability/logging/cluster-logging-upgrading.adoc

:_mod-docs-content-type: PROCEDURE
[id="logging-upgrading-clo_{context}"]
= Updating the {clo}

The {clo} does not provide an automated upgrade from Logging 5.x to Logging 6.x because of the different combinations in which Logging can be configured. You must install all the different operators for managing logging separately.

You can update {clo} by either changing the subscription channel in the {ocp-product-title} web console, or by uninstalling it. The following procedure demonstrates updating {clo} by changing the subscription channel in the {ocp-product-title} web console.

[IMPORTANT]
====
When you migrate, all the logs that have not been compressed will be reprocessed by Vector. The reprocessing might lead to the following issues:

* Duplicated logs during migration.
* Too many requests in the Log storage receiving the logs, or requests reaching the rate limit.
* Impact on the disk and performance because of reading and processing of all old logs in the collector.
* Impact on the Kube API.
* A peak in memory and CPU use by Vector until all the old logs are processed. The logs can be several GB per node. 
====

.Prerequisites

* You have updated the log collection and forwarding configurations to the link:https://github.com/openshift/cluster-logging-operator/blob/master/docs/reference/operator/api_observability_v1.adoc[`observability.openshift.io`] API.
* You have administrator permissions.
* You have access to the {ocp-product-title} web console and are viewing the *Administrator* perspective.

.Procedure

. Create a service account by running the following command:
+
[NOTE]
====
If your previous log forwarder is deployed in the namespace `openshift-logging` and named `instance`, the earlier versions of the operator created a `logcollector` service account. This service account gets removed when you delete cluster logging. Therefore, you need to create a new service account. Any other service account will be preserved. and can be used in Logging 6.x.
====
+
[source,terminal]
----
$ oc create sa logging-collector -n openshift-logging
----

. Provide the required RBAC permissions to the service account.

.. Bind the `ClusterRole` role to the service account to be able to write the logs to the Red{nbsp}Hat LokiStack
+
[source,terminal]
----
$ oc adm policy add-cluster-role-to-user logging-collector-logs-writer -z logging-collector -n openshift-logging
----

.. Assign permission to collect and forward application logs by running the following command:
+
[source,terminal]
----
$ oc adm policy add-cluster-role-to-user collect-application-logs -z logging-collector -n openshift-logging
----

.. Assign permission to collect and forward audit logs by running the following command:
+
[source,terminal]
----
$ oc adm policy add-cluster-role-to-user collect-audit-logs -z logging-collector -n openshift-logging
----

.. Assign permission to collect and forward infrastructure logs by running the following command:
+
[source,terminal]
----
 $ oc adm policy add-cluster-role-to-user collect-infrastructure-log -z logging-collector -n openshift-logging
----
+
////
. Transfom the current configuration to the new API in Logging 6.
+
For more information, see link:[Changes to Cluster logging and forwarding in Logging 6].
////

. Move Vector checkpoints to the new path.
+
The Vector checkpoints in Logging v5 are located at the path `/var/lib/vector/input*/checkpoints.json`. Move these checkpoints to the path `/var/lib/vector/<namespace>/<clusterlogforwarder cr name>/*`. The following example uses `openshift-logging` as the namespace and `collector` as the ClusterForwarder custom resource name. 
+
[source,terminal]
----
$ ns="openshift-logging"
$ cr="collector"
$ for node in $(oc get nodes -o name); do oc debug $node -- chroot /host /bin/bash -c "mkdir -p /var/lib/vector/$ns/$cr" ; done
$ for node in $(oc get nodes -o name); do oc debug $node -- chroot /host /bin/bash -c "chmod -R 755 /var/lib/vector/$ns" ; done
$ for node in $(oc get nodes -o name); do echo "### $node ###"; oc debug $node -- chroot /host /bin/bash -c "cp -Ra /var/lib/vector/input* /var/lib/vector/$ns/$cr/"; done
----

. Update the {clo} by using the {ocp-product-title} web console.
.. Navigate to *Operators* -> *Installed Operators*.

.. Select the *openshift-logging* project.

.. Click the *Red Hat OpenShift Logging* Operator.

.. Click *Subscription*. In the *Subscription details* section, click the *Update channel* link.

.. In the *Change Subscription Update Channel* window, select the update channel, *stable-6.x*, and click *Save*. Note the `cluster-logging.v6.y.z` version.
+
[IMPORTANT]
====
Only update to an N+2 version, where N is your current version. For example, if you are upgrading from Logging 5.8, select `stable-6.0` as the update channel. Updating to a version that is more than two versions newer is not supported.
====

.. Wait for a few seconds, and then go to *Operators* -> *Installed Operators* to verify that the {clo} version matches the latest `cluster-logging.v6.y.z` version.

.. On the *Operators* -> *Installed Operators* page, wait for the *Status* field to report *Succeeded*.
+
Your existing Logging v5 resources will continue to run, but are no longer managed by your operator. These unmanaged resources can be removed once your new resources are ready to be created. 
