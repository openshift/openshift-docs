[id="update-service-create-service-cli_{context}"]
= Creating an Update Service by using the CLI

You can use the {product-title} CLI to create an Update Service by using the {product-title} Update Service Operator.

.Procedure

To create an Update Service by using the {product-title} CLI:

. Configure the Update Service target namespace:
+
[source,terminal]
----
$ NAMESPACE=FIXME-default-operand-namespace
----
+
The namespace must match the `targetNamespaces` value from the OperatorGroup.

. Configure the name of the Update Service:
+
[source,terminal]
----
$ NAME=example
----

. Configure the local registry and repository for the release images:
+
[source,terminal]
----
$ RELEASE_IMAGES=registry.example.com/openshift/release
----

. Configure the local pullspec for the graph-data image:
+
[source,terminal]
----
$ GRAPH_DATA_IMAGE=registry.example.com/openshift/graph-data:latest
----

. Create an Update Service object:
+
[source,terminal]
----
$ oc -n "${NAMESPACE}" create -f - <<EOF
apiVersion: updateservice.operator.openshift.io/v1
kind: UpdateService
metadata:
  name: ${NAME}
spec:
  replicas: 2
  repository:
  registry:
  releaseImages: ${RELEASE_IMAGES}  # FIXME: aspirational
  graphDataImage: ${GRAPH_DATA_IMAGE}
EOF
----

. Verify the Update Service:

.. Use the following command to obtain a policy engine route:
+
[source,terminal]
----
$ while sleep 1; do POLICY_ENGINE_GRAPH_URI="$(oc -n "${NAMESPACE}" get -o jsonpath='{.status.policyEngineURI}/api/upgrades_info/v1/graph{"\n"}' updateservice "${NAME}")"; SCHEME="${POLICY_ENGINE_GRAPH_URI%%:*}"; if test "${SCHEME}" = http -o "${SCHEME}" = https; then break; fi; done
----
+
You might need to poll until the command succeeds.

.. Retrieve a graph from the policy engine:
+
[source,terminal]
----
$ while sleep 10; do HTTP_CODE="$(curl --header Accept:application/json --output /dev/stderr --write-out "%{http_code}" "${POLICY_ENGINE_GRAPH_URI}?channel=stable-4.6")"; if test "${HTTP_CODE}" -eq 200; then break; fi; echo "${HTTP_CODE}"; done
----
+
This polls until the graph request succeeds, although depending on which release images you have mirrored, the resulting graph might be empty.
