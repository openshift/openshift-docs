// Module included in the following assemblies:
//
// * serverless/serverless-logic/serverless-logic-configuring-workflow-services.adoc

:_mod-docs-content-type: CONCEPT
[id="serverless-logic-kubernetes-service-discovery_{context}"]
= Kubernetes service discovery

You can use Kubernetes service discovery to describe Kubernetes resources for HTTP requests by using a custom URI. The OpenShift Serverless Logic Operator resolves this URI into a network endpoint (URL) during the workflow deployment process or application startup.

[NOTE]
====
If application startup time is critical, consider using a known static URL instead of service discovery to avoid the configuration scan.
====

== URI pattern in Kubernetes service discovery

The custom URI pattern for service discovery follows a structure based on the Group, Version, and Kind (GVK) of the resource.

[source,terminal]
----
kubernetes:<kind>.<version>.<group>/<namespace>/<resource_name>?<attribute_name>=<attribute_value>
----
where:

`<kind>.<version>.<group>`:: Specifies the GVK of the resource.
`<namespace>`:: Specifies the namespace. This value is optional; if ommited, the command uses the current namespace.
`<resource_name>`:: Specifies the name of the target resource.
`<attribute_name>=<attribute_value>`:: Specifies additional resource attributes, such as custom labels or ports.


== Supported schemes and resources

The URI pattern supports the following scheme values:

* `kubernetes`
* `openshift`
* `knative`

You can use a simplified `knative:<namespace>/<service_name>` pattern for Knative services.

The following table lists the supported Kubernetes resources for GVK identifiers:

[cols="1,1", options="header"]
|===
| Resource | GVK identifier

| Kubernetes Service
| `services.v1`

| Knative Service
| `services.v1.serving.knative.dev`

| Pod
| `pods.v1`

| Deployment
| `deployments.v1.apps`

| DeploymentConfig
| `deploymentconfigs.v1.apps.openshift.io`

| StatefulSet
| `statefulsets.v1.apps`

| Route
| `routes.v1.route.openshift.io`

| Ingress
| `ingresses.v1.networking.k8s.io`
|===

== Role-based access control requirements

The service discovery engine requires that the Kubernetes service account running the application has read permissions for the discovered objects. You must create a `Role` and a `RoleBinding` in every namespace where service discovery is enabled.

[IMPORTANT]
====
For security reasons, avoid using a `ClusterRole` to grant global permissions. Use namespace-scoped `Role` resources instead.
====

== Query parameters in URI

Query parameters assign values to specific attributes to help the engine be more precise when querying a Kubernetes resource.

Custom labels:: Used to filter services when multiple services share the same label selector but expose different ports. Use an ampersand (`&`) to define multiple labels.
Custom port:: Used to determine which port to use when multiple ports are configured in the target service. Use the `port=<PORT_NAME>` pattern.

== Service discovery resolution


The OpenShift Serverless Logic Operator performing service discovery scans the workflow configuration parameters for the URI pattern. The Operator queries the Kubernetes API and overrides the parameters with the resolved URL in the managed properties `ConfigMap`.

The OpenShift Serverless Logic Operator performs service discovery during the deployment of a managed workflow. The Operator scans the workflow configuration parameters in the associated `ConfigMap` for the URI pattern.

If the Operator identifies a service discovery URI, it attempts to parse the URI and query the Kubernetes API for the specified resource.




=== Resolution paths and error handling
The Operator follows specific resolution paths based on the resource type:

* *Direct URL resolution*: For `Service`, `KnativeService`, `Ingress`, or `Route` resources, the Operator returns the Service URL or host IP. The Operator uses `https` automatically if TLS is detected.
* *Indirect service resolution*: For `Pod`, `Deployment`, `DeploymentConfig`, or `StatefulSet` resources, the Operator verifies if an associated service exists. If found, the Operator returns the Service URL.
* *Exceptions*: The Operator logs an exception if the URI parsing fails or the resource is not found. If a resource exists but lacks an associated service, the Operator issues a warning.


[IMPORTANT]
====
The Operator overrides the configuration parameters with the resolved value in the managed properties `ConfigMap`. Any external changes to this `ConfigMap` are overwritten during the next reconciliation cycle.
====
