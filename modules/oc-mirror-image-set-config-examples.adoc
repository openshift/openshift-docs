// Module included in the following assemblies:
//
// * installing/disconnected_install/installing-mirroring-disconnected.adoc
// * updating/updating_a_cluster/updating_disconnected_cluster/mirroring-image-repository.adoc

:_mod-docs-content-type: REFERENCE
[id="oc-mirror-image-set-examples_{context}"]
= Optimizing the image set configuration

The following `ImageSetConfiguration` file examples show the configuration for various mirroring use cases.

[id="oc-mirror-image-set-example-specific-ocp-release_{context}"]
== Use case: Preparing for installing a specific {product-title} release

See "About ImageSetConfiguration" for further information.

[NOTE]
====
Regularly running oc-mirror plugin v1 facilitates the automatic retrieval of the latest {product-title} releases.
====

The following example `ImageSetConfiguration` file uses a local storage backend, including all {product-title} versions from the minimum version of 4.15.13:

.Example `ImageSetConfiguration` file
[source,yaml]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: /home/user/metadata
mirror:
  platform:
    channels:
      - name: stable-4.15
        minVersion: 4.15.13
----

[id="oc-mirror-image-set-example-multi-architecture_{context}"]
== Use case: Preparing for installing for multiple architectures

If you set the architectures to `multi` in the `imageSetConfiguration` file, it implies that the images in the set support multiple architectures.

[NOTE]
====
The `multi` value only supports the {product-title} releases and not the Operators.
====

.Example `ImageSetConfiguration` file
[source,yaml]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  registry:
    imageURL: example.com/mirror/oc-mirror-metadata
    skipTLS: false
mirror:
  platform:
    architectures:
      - "multi"
    channels:
      - name: stable-4.15
        minVersion: 4.15.13
----

[id="oc-mirror-image-set-examples-shortest-upgrade-path_{context}"]
== Use case: Preparing for an {product-title} upgrade including the shortest update path

The following `ImageSetConfiguration` file uses a local storage backend and includes all {product-title} versions along with the shortest update path from the minimum version of 4.14.25 to the maximum version of 4.15.13:

.Example `ImageSetConfiguration` file
[source,yaml]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: /home/user/metadata
mirror:
  platform:
    channels:
      - name: stable-4.15
        minVersion: 4.14.25
        maxVersion: 4.15.13
        shortestPath: true
----

[IMPORTANT]
====
When using EUS channels and more than one channel is specified in the `imagesetconfig`, you might need to include non-EUS channels to make sure that all required intermediate versions are included in the `imageset`. See link:https://access.redhat.com/labs/ocpupgradegraph/update_path[Red Hat OpenShift Container Platform Update Graph] to check all versions forming the upgrade graph.
====

[id="oc-mirror-image-set-examples-operator-versions_{context}"]
== Use case: Including Operator versions from a minimum to the latest

The following `ImageSetConfiguration` file uses a local storage backend and includes only the Red Hat Advanced Cluster Security for Kubernetes Operator, versions starting at 4.0.1 and later regardless of the channel.

[NOTE]
====
When you specify a minimum or maximum version range, you might not receive all Operator versions in that range.

By default, oc-mirror plugin v1 excludes any versions that are skipped or replaced by a newer version in the Operator Lifecycle Manager (OLM) specification. Operator versions that are skipped might be affected by a CVE or contain bugs. Use a newer version instead. For more information on skipped and replaced versions, see link:https://olm.operatorframework.io/docs/concepts/olm-architecture/operator-catalog/creating-an-update-graph/[Creating an update graph with OLM].

To receive all Operator versions in a specified range, you can set the `mirror.operators.full` field to `true`.
====

.Example `ImageSetConfiguration` file
[source,yaml,subs=attributes+]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: /home/user/metadata
mirror:
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v{product-version}
      packages:
        - name: rhacs-operator
            - minVersion: 4.0.1
----

In this example, if you set the `minVersion` to the latest possible version and omit the `maxVersion`, no additional versions are mirrored.

The oc-mirror plugin v1 automatically evaluates the latest Operator version with each use. Running the oc-mirror plugin v1 regularly ensures automatic updates to receive the latest versions of the Red Hat Advanced Cluster Security for Kubernetes Operator.

When selecting channels for your package, consider their suitability. Enabling all channels within `minVersion` and `maxVersion` or specifying only `minVersion` allows for gradual updates with minimal configuration changes.

[NOTE]
====
To specify a maximum version instead of the latest, set the `mirror.operators.packages.channels.maxVersion` field.
====

[discrete]
[id="oc-mirror-image-set-examples-nutanix-operator_{context}"]
== Use case: Including the Nutanix CSI Operator

The following `ImageSetConfiguration` file uses a local storage backend and includes the Nutanix CSI Operator, the OpenShift Update Service (OSUS) graph image, and an additional Red Hat Universal Base Image (UBI).

.Example `ImageSetConfiguration` file
[source,yaml,subs=attributes+]
----
kind: ImageSetConfiguration
apiVersion: mirror.openshift.io/v1alpha2
storageConfig:
  registry:
    imageURL: mylocalregistry/ocp-mirror/openshift4
    skipTLS: false
mirror:
  platform:
    channels:
    - name: stable-4.11
      type: ocp
    graph: true
  operators:
  - catalog: registry.redhat.io/redhat/certified-operator-index:v{product-version}
    packages:
    - name: nutanixcsioperator
      channels:
      - name: stable
  additionalImages:
  - name: registry.redhat.io/ubi9/ubi:latest
----

[id="oc-mirror-image-set-examples-default-channel_{context}"]
== Use case: Including an Operator version that is not available in the default channel

To include an Operator version not available in the default channel, consider installing `aws-load-balancer-operator`, specifically version 0.2.0.

In the `ImageSetConfiguration` file, include the `stable-v0.2` and `stable-v1` channels for the AWS Load Balancer Operator. Even if only the packages from the `stable-v0.2` channel are needed, you must include the `stable-v1` channel in the `ImageSetConfiguration` file, as it is the default channel for the Operator. It's important to always include the default channel for the Operator package, even if you do not use the bundles in that channel.

[TIP]
====
You can find the default channel by running the following command: `oc mirror list operators --catalog=<catalog_name> --package=<package_name>`.
====

.Example `ImageSetConfiguration` file
[source,yaml,subs=attributes+]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  registry:
    imageURL: example.com/mirror/oc-mirror-metadata
    skipTLS: false
mirror:
  operators:
  - catalog: registry.redhat.io/redhat/redhat-operator-index:{product-version}
    packages:
    - name: aws-load-balancer-operator
      channels:
      - name: stable-v0.2
      - name: stable-v1
----

[id="oc-mirror-image-set-examples-default-channel-alternative_{context}"]
== Use case: Alternative example to include an Operator version that is not available in the default channel

Another possibility is to redefine the default channel as follows:

.Example `ImageSetConfiguration` file

[source,yaml]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  registry:
    imageURL: example.com/mirror/oc-mirror-metadata
    skipTLS: false
mirror:
  operators:
  - catalog: registry.redhat.io/redhat/redhat-operator-index:{product-version}
    packages:
    - name: aws-load-balancer-operator
      defaultChannel: stable-v0.2 <1>
      channels:
      - name: stable-v0.2
----
<1> The value for `defaultChannel` must be specified in the `channels` list.

[id="oc-mirror-image-set-examples-entire-catalog-full_{context}"]
== Use case: Including an entire catalog (channel heads only)

The following `ImageSetConfiguration` file includes the channel heads for an entire Operator catalog.

By default, for each Operator in the catalog, oc-mirror plugin v1 includes the latest Operator version (channel head) from the default channel. If you want to mirror all Operator versions, and not just the channel heads, you must set the `mirror.operators.full` field to `true`.

This example also uses the `targetCatalog` field to specify an alternative namespace and name to mirror the catalog as.

.Example `ImageSetConfiguration` file
[source,yaml,subs=attributes+]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  registry:
    imageURL: example.com/mirror/oc-mirror-metadata
    skipTLS: false
mirror:
  operators:
  - catalog: registry.redhat.io/redhat/redhat-operator-index:v{product-version}
    targetCatalog: my-namespace/my-operator-catalog
----

[id="oc-mirror-image-set-examples-helm_{context}"]
== Use case: Including arbitrary images and helm charts

The following `ImageSetConfiguration` file uses a registry storage backend and includes helm charts and an additional Red Hat Universal Base Image (UBI).

.Example `ImageSetConfiguration` file
[source,yaml,subs=attributes+]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
archiveSize: 4
storageConfig:
  registry:
    imageURL: example.com/mirror/oc-mirror-metadata
    skipTLS: false
mirror:
 platform:
   architectures:
     - "s390x"
   channels:
     - name: stable-{product-version}
 operators:
   - catalog: registry.redhat.io/redhat/redhat-operator-index:v{product-version}
 helm:
   repositories:
     - name: redhat-helm-charts
       url: https://raw.githubusercontent.com/redhat-developer/redhat-helm-charts/master
       charts:
         - name: ibm-mongodb-enterprise-helm
           version: 0.2.0
 additionalImages:
   - name: registry.redhat.io/ubi9/ubi:latest
----