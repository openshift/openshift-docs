// Module included in the following assemblies:
//
// * osd_install_access_delete_cluster/creating-a-gcp-cluster-with-workload-identity-federation.adoc


:_mod-docs-content-type: PROCEDURE
[id="create-wif-cluster-cli_{context}"]
= Creating a cluster with Workload Identity Federation using the OCM CLI

You can create an {product-title} on {GCP} cluster with Workload Identity Federation (WIF) using the OCM CLI. Before creating the cluster, you must first create a WIF configuration.

.Procedure

. Use the following command to create a WIF configuration:
+
[source,terminal]
----
$ ocm gcp create wif-config --name $WIF_NAME  <1>
--project $GCP_PROJECT_ID <2>
--versions $REQUIRED_VERSIONS <3>
----
<1> Replace `$WIF_NAME` with the name of your WIF configuration.
<2> Replace `$GCP_PROJECT_ID` with the ID  of the {GCP} project where the WIF configuration will be implemented.
<3> Optional: Replace `$REQUIRED_VERSIONS` with the list of Openshift versions that the WIF configuration will need to support. If no value is provided, the latest available version will be supported by default.
+
--
.Example output
[source,terminal]
----
2024/08/29 15:05:53 Workload identity pool created with name 2df7h3goduhcoltrkklldhai2do46dhi
2024/08/29 15:05:53 workload identity provider created with name oidc
2024/08/29 15:05:54 IAM service account wlif-osd-6dhi-000 created
2024/08/29 15:05:54 IAM service account unkn-osd-6dhi-001 created
2024/08/29 15:05:55 IAM service account unkn-osd-6dhi-002 created
2024/08/29 15:05:56 IAM service account impr-osd-6dhi-003 created
2024/08/29 15:05:56 IAM service account impr-osd-6dhi-004 created
2024/08/29 15:05:57 IAM service account wlif-osd-6dhi-005 created
2024/08/29 15:05:57 IAM service account wlif-osd-6dhi-006 created
2024/08/29 15:05:58 IAM service account wlif-osd-6dhi-007 created
2024/08/29 15:05:58 IAM service account wlif-osd-6dhi-008 created
2024/08/29 15:05:59 IAM service account wlif-osd-6dhi-009 created
2024/08/29 15:06:00 IAM service account wlif-osd-6dhi-010 created
----
--

[id="wif-cluster-auto-mode_{context}"]
== Interactive mode command

. Use the following interactive mode OCM CLI command to create your OpenShift Dedicated on Google Cloud Platform (GCP) cluster with Workload Identity Federation:
+
[source,terminal]
----
ocm create cluster --interactive <1>
----
<1> `interactive` mode enables you to specify configuration options at the interactive prompts.

//Table will be used for OCM CLI support feature once it is completed
// The following table describes the interactive cluster creation mode options:

// .`--interactive` cluster creation mode options
// [cols=".^2,.^3a",options="header"]
// |===

// |Field|Description

// |`Cluster name`
// |Enter a name for your cluster, for example `my-osd-cluster`.

// |`Subscription type`
// |Select your subscription type from the three available options:

// - `standard (Annual: Fixed capacity subscription from Red Hat)`
// - `marketplace-rhm (On-Demand: Flexible usage billed through the Red Hat Marketplace)`
// - `marketplace-gcp (On-Demand: Flexible usage billed through the Google Cloud Marketplace)`

// [NOTE]
// ====
// If you select `marketplace-gcp (On-Demand: Flexible usage billed through the Google Cloud Marketplace)` as your subscription type, the CCS billing model and GCP cloud provider is selected by default.
// ====

// |`Cloud provider`
// |Select `gcp`.

// |`CCS`
// |Select `y`.

// |`Authentication method`
// |Select `Workload Identity Federation`.

// |`WIF configuration`
// |Select the WIF configuration that you want to be used for the new cluster.

// |`Multiple AZ (optional)`
// |Deploy the cluster to multiple availability zones in the GCP region. The default is `No`, which results in a cluster being deployed to a single availability zone. If you deploy a cluster into multiple availability zones, the GCP region must have at least 3 availability zones. Multiple availability zones are recommended for production workloads.

// |`Secure boot support for Shielded VMs (optional)`
// |Secure Boot enables the use of Shielded VMs in the Google Cloud Platform.
// [IMPORTANT]
// ====
// To successfully create a cluster, you must select `y` if your organization has the policy constraint `constraints/compute.requireShieldedVm` enabled. For more information regarding GCP organizational policy constraints, see link:https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints[Organization policy constraints].
// ====

// |`Region`
// |Select your region.

// |`Openshift version`
// |Select the version of OpenShift to install. The default is the latest version.
// [NOTE]
// ====
// Clusters created using Workload Identity Federation are supported by versions 4.17.0 and up.
// ====


// |`Compute machine type`
// |Select a compute machine type. The compute machine type determines the amount of memory and vCPU allocated to each compute node.

// |`Enable autoscaling (optional)`
// |Enable compute node autoscaling. The autoscaler adjusts the size of the cluster to meet your deployment demands. The default is `No`.

// |`Compute nodes`
// |Specify the number of compute nodes to provision into each availability zone. Clusters deployed in a single availability zone require at least 2 nodes. Clusters deployed in multiple zones must have at least 3 nodes. The maximum number of worker nodes is 180 nodes. The default value is `2`.

// |`Install into an existing VPC (optional)`
// |Install a cluster into an existing GCP VPC. To use this option, your VPC must have 2 subnets for each availability zone that you are installing the cluster into. The default is `No`.

// |`Machine CIDR`
// |The block of IP addresses used by Openshift while installing the cluster. The default is `10.0.0.0/16`.

// |`Service CIDR`
// |The block of IP addresses for services. It is recommended, but not required, that the address block is the same between clusters. This will not create IP address conflicts. The range must be large enough to accommodate your workload. The address block must not overlap with any external service accessed from within the cluster. The default is `172.30.0.0/16`.

// |`Pod CIDR`
// |The block of IP addresses from which IP addresses are allocated. It is recommended, but not required, that the address block is the same between clusters. This will not create IP address conflicts. The range must be large enough to accommodate your workload. The address block must not overlap with any external service accessed from within the cluster. The default is `10.128.0.0/14`.

// |`Host Prefix`
// |Specify the subnet prefix length assigned to pods scheduled to individual machines. The host prefix determines the pod IP address pool for each machine. For example, if the host prefix is set to `/23`, each machine is assigned a `/23` subnet from the pod CIDR address range. The default is `/23`, allowing 512 cluster nodes and 512 pods per node, both of which are beyond our supported maximums. For information on the supported maximums, see the Additional resources section below.

// |`Private cluster (Optional)`
// |Enabling private cluster restricts the master AP endpoint and application routes to direct, private connectivity. The default is `No`.

// |`Domain prefix` (Optional)
// |An optional unique domain prefix of the cluster. If not provided, the cluster name will be used if it contains at most 15 characters, otherwise a generated value will be used. Once set, the cluster domain prefix cannot be changed.
// |===

[id="wif-cluster-manual-mode_{context}"]
== Non-interactive mode command

You can create a {product-title} on {GCP} cluster using the non - interactive OCM command. Using this command method allows you to specify the variables within the command itself. Variables that are not specified within the command will be assigned their default values.

. Use the following non-interactive mode OCM CLI command to create your OpenShift Dedicated on Google Cloud Platform (GCP) cluster with Workload Identity Federation:
+
[NOTE]
====
The example below shows the minimum required variables that must be included within the manual mode command to create an OSD on GCP cluster using WIF.
====
+
--
[source,terminal]
----
ocm create cluster --provider gcp --ccs --wif-config $WIF_ID \ <1>
--region $GCP_REGION \ <2>
--$CLUSTER_NAME  <3>
----
<1> Replace `$WIF_ID` with the ID of the newly created WIF configuration.
<2> Replace `$GCP_REGION` with the {GCP} region where the new cluster will be deployed.
<3> Replace `$CLUSTER_NAME` with the name of your new cluster.
--

[id="wif-configuration-update_{context}"]
== Updating a Workload Identity Federation configuration

You can update a WIF configuration to the latest Openshift version by running the following command:

--
[source,terminal]
----
ocm gcp update wif-config --version=<openshift_version> <1>
--name  <WIF_NAME> <2>
----
<1> Replace <openshift_version> with the latest Openshift version.
<2> Replace <WIF_NAME> with name of the WIF configuration you want to update.
--