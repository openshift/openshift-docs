// Module included in the following assemblies:
// Epic CNF-2600 (CNF-2133) (4.10), Story TELCODOCS-285
// * scalability_and_performance/cnf-topology-aware-lifecycle-operator.adoc

:_content-type: PROCEDURE
[id="talo-precache-feature_{context}"]
= Using the container image pre-cache feature

The clusters might have limited bandwidth to access the container image registry, which can cause a timeout before the updates are completed. 
The pre-cache feature allows the required container images to be present on the spoke cluster before the update starts.

[NOTE]
====
The time of the update is not set by TALO. You can apply the `ClusterGroupUpgrade` CR at the beginning of the update by manual application or by external automation.
====

The container image pre-caching starts when the `preCaching` field is set to `true` in the `ClusterGroupUpgrade` CR. After a successful pre-caching process, you can start remediating policies. The remediation actions start when the `enable` field is set to `true`.

//Review of the pre-caching statuses is needed

The pre-caching process can be in the following statuses:

`PrecacheNotStarted`:: This is the initial state all clusters are automatically assigned to on the first reconciliation pass of the `ClusterGroupUpgrade` CR. 
+
In this state, TALO deletes any pre-caching namespace and Hub view resources of spoke clusters that remain from previous incomplete updates. TALO then creates a new `ManagedClusterView` resource for the spoke pre-caching namespace to verify its deletion in the `PrecachePreparing` state.
`PrecachePreparing`:: In this state, cleaning up any remaining resources from previous incomplete updates is in progress.
`PrecacheStarting`:: In this state, pre-caching job pre-requisites and the job are created.
`PrecacheActive`:: The job is in "Active" state.
`PrecacheSucceeded`:: In this state, the pre-cache job has succeeded.
`PrecacheTimeout`:: In this state, the artifact pre-caching has been partially done.
`PrecacheUnrecoverableError`:: In this sate, the job ends with a non-zero exit code.


[id="talo-precache-start_and_update_{context}"]
== Creating a ClusterGroupUpgrade CR with pre-caching

.Prerequisites

* Install the Topology Aware Lifecycle Operator.
* Provision one or more managed clusters using ZTP.
* Log in as a user with `cluster-admin` privileges.

.Procedure

. Create the `ClusterGroupUpgrade` CR with the `preCaching` field set to `true`, and then save the YAML in the `clustergroupupgrades-group-du.yaml` file:
+
[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: du-upgrade-4918
  namespace: ztp-group-du-sno
spec:
  actions:
    preCaching: true <1>
    afterCompletion:
      deleteObjects: true
  clusters:
  - cnfdb1
  - cnfdb2
  enable: true
  managedPolicies:
  - du-upgrade-platform-upgrade
  remediationStrategy:
    maxConcurrency: 2
    timeout: 240
----
<1> The `preCaching` field is set to `true`, which enables TALO to pull the container images before starting the update.

. When you want to start the update, apply the `ClusterGroupUpgrade` CR by running the following command:
+
[source,terminal]
----
$ oc apply -f clustergroupupgrades-group-du.yaml
----

.Verification

. Check if the `ClusterGroupUpgrade` CR exists in the Hub cluster by running the following command:
+
[source,terminal]
----
$ oc get cgu -A
----
+
.Example output
+
[source,terminal]
----
NAMESPACE          NAME              AGE
ztp-group-du-sno   du-upgrade-4918   10s <1>
----
<1> The CR is created.

. Check the status of the pre-caching task by running the following command:
+
[source,terminal]
----
$ oc get cgu -n ztp-group-du-sno du-upgrade-4918 -o jsonpath='{.status}' | jq
----
+
.Example output
+
[source,json]
----
{
  "conditions": [
    {
      "lastTransitionTime": "2022-01-27T19:07:24Z",
      "message": "Precaching is not completed (required)", <1>
      "reason": "PrecachingRequired",
      "status": "False",
      "type": "Ready"
    },
    {
      "lastTransitionTime": "2022-01-27T19:07:24Z",
      "message": "Precaching is required and not done",
      "reason": "PrecachingNotDone",
      "status": "False",
      "type": "PrecachingDone"
    },
    {
      "lastTransitionTime": "2022-01-27T19:07:34Z",
      "message": "Pre-caching spec is valid and consistent",
      "reason": "PrecacheSpecIsWellFormed",
      "status": "True",
      "type": "PrecacheSpecValid"
    }
  ],
  "precaching": {
    "clusters": [
      "cnfdb1" <2>
    ],
    "spec": {
      "platformImage": "image.example.io"
 },
    "status": {
      "cnfdb1": "Active"
----
<1> Displays that the update is in progress.
<2> Displays the list of identified clusters.

. Check the status of the pre-caching job by running the following command:
+
[source,terminal]
----
$ oc get jobs,pods -n openshift-talo-pre-cache
----
+
.Example output
+
[source,terminal]
----
NAME                  COMPLETIONS   DURATION   AGE
job.batch/pre-cache   0/1           3m10s      3m10s

NAME                     READY   STATUS    RESTARTS   AGE
pod/pre-cache--1-9bmlr   1/1     Running   0          3m10s
----

 . Check the status of the `ClusterGroupUpgrade` CR by running the following command:
+
[source,terminal]
----
$ oc get cgu -n ztp-group-du-sno du-upgrade-4918 -o jsonpath='{.status}' | jq
----
+
.Example output
+
[source,json]
----
conditions": [
    {
      "lastTransitionTime": "2022-01-27T19:30:41Z",
      "message": "The ClusterGroupUpgrade CR has all clusters compliant with all the managed policies",
      "reason": "UpgradeCompleted",
      "status": "True",
      "type": "Ready"
    },
    {
      "lastTransitionTime": "2022-01-27T19:28:57Z",
      "message": "Precaching is completed",
      "reason": "PrecachingCompleted",
      "status": "True",
      "type": "PrecachingDone" <1>
    }
----
<1> The pre-cache tasks are done.