// Module included in the following assemblies:
// Epic CNF-2600 (CNF-2133) (4.10), Story TELCODOCS-285
// * scalability_and_performance/cnf-topology-aware-lifecycle-operator.adoc

:_content-type: PROCEDURE
[id="talo-precache-feature_{context}"]
= Using the container image pre-cache feature

The clusters might have limited bandwidth to access the container image registry, which can cause a timeout before the updates are completed. 
The pre-cache feature allows the required container images to be present on the spoke cluster before the update starts.

[NOTE]
====
The time of the update is not set by TALO. You can apply the `ClusterGroupUpgrade` CR at the beginning of the update by manual application or by external automation.
====

The container image pre-caching starts when the `preCaching` field is set to `true` in the `ClusterGroupUpgrade` CR. After a successful pre-caching process, you can start remediating policies. The remediation actions start when the `enable` field is set to `true`.

[id="talo-precache-autocreated-cgu-for-ztp_{context}"]
== About the auto-created ClusterGroupUpgrade CR for ZTP

TALO has a controller called `ManagedClusterForCGU` that monitors the `Ready` state of the `ManagedCluster` CRs on the Hub cluster and creates the `ClusterGroupUpgrade` CRs for ZTP (zero touch provisioning).

For any managed cluster in the `Ready` state without a "ztp-done" label applied, the `ManagedClusterForCGU` controller automatically creates a `ClusterGroupCluster` CR in the `ztp-install` namespace with its associated {rh-rhacm} policies that are created during the ZTP process. TALO then remediates the set of configuration policies that are listed in the auto-created `ClusterGroupUpgrade` CR to push the configuration CRs to the managed cluster.

[NOTE]
====
If the managed cluster has no bound policies when the cluster becomes `Ready`, no `ClusterGroupUpgrade` CR is created.
====

.Example of an auto-created `ClusterGroupUpgrade` CR for ZTP

[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  generation: 1
  name: spoke1
  namespace: ztp-install
  ownerReferences:
  - apiVersion: cluster.open-cluster-management.io/v1
    blockOwnerDeletion: true
    controller: true
    kind: ManagedCluster
    name: spoke1
    uid: 98fdb9b2-51ee-4ee7-8f57-a84f7f35b9d5
  resourceVersion: "46666836"
  uid: b8be9cd2-764f-4a62-87d6-6b767852c7da
spec:
  actions:
    afterCompletion:
      addClusterLabels:
        ztp-done: "" <1>
      deleteClusterLabels:
        ztp-running: ""
      deleteObjects: true
    beforeEnable:
      addClusterLabels:
        ztp-running: "" <2>
  clusters:
  - spoke1
  enable: true
  managedPolicies:
  - common-spoke1-config-policy
  - common-spoke1-subscriptions-policy
  - group-spoke1-config-policy
  - spoke1-config-policy
  - group-spoke1-validator-du-policy
  preCaching: false
  remediationStrategy:
    maxConcurrency: 1
    timeout: 240
----
<1> Applied to the managed cluster when TALO completes the cluster configuration.
<2> Applied to the managed cluster when TALO starts deploying the configuration policies.


[id="talo-precache-start_and_update_{context}"]
== Creating a ClusterGroupUpgrade CR with pre-caching

.Prerequisites

* Install the Topology Aware Lifecycle Operator.
* Provision one or more managed clusters using ZTP.
* Log in as a user with `cluster-admin` privileges.

.Procedure

. Create the `ClusterGroupUpgrade` CR with the `preCaching` field set to `true`, and then save the YAML in the `clustergroupupgrades-group-du.yaml` file:
+
[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: du-upgrade-4918
  namespace: ztp-group-du-sno
spec:
  actions:
    preCaching: true <1>
    afterCompletion:
      deleteObjects: true
  clusters:
  - cnfdb1
  - cnfdb2
  enable: true
  managedPolicies:
  - du-upgrade-platform-upgrade
  remediationStrategy:
    maxConcurrency: 2
    timeout: 240
----
<1> The `preCaching` field is set to `true`, which enables TALO to pull the container images before starting the update.

. When you want to start the update, apply the `ClusterGroupUpgrade` CR by running the following command:
+
[source,terminal]
----
$ oc apply -f clustergroupupgrades-group-du.yaml
----

.Verification

. Check if the `ClusterGroupUpgrade` CR exists in the Hub cluster by running the following command:
+
[source,terminal]
----
$ oc get cgu -A
----
+
.Example output
+
[source,terminal]
----
NAMESPACE          NAME              AGE
ztp-group-du-sno   du-upgrade-4918   10s <1>
----
<1> The CR is created.

. Check the status of the pre-caching task by running the following command:
+
[source,terminal]
----
$ oc get cgu -n ztp-group-du-sno du-upgrade-4918 -o jsonpath='{.status}' | jq
----
+
.Example output
+
[source,json]
----
{
  "conditions": [
    {
      "lastTransitionTime": "2022-01-27T19:07:24Z",
      "message": "Precaching is not completed (required)", <1>
      "reason": "PrecachingRequired",
      "status": "False",
      "type": "Ready"
    },
    {
      "lastTransitionTime": "2022-01-27T19:07:24Z",
      "message": "Precaching is required and not done",
      "reason": "PrecachingNotDone",
      "status": "False",
      "type": "PrecachingDone"
    },
    {
      "lastTransitionTime": "2022-01-27T19:07:34Z",
      "message": "Pre-caching spec is valid and consistent",
      "reason": "PrecacheSpecIsWellFormed",
      "status": "True",
      "type": "PrecacheSpecValid"
    }
  ],
  "precaching": {
    "clusters": [
      "cnfdb1" <2>
    ],
    "spec": {
      "platformImage": "image.example.io"
 },
    "status": {
      "cnfdb1": "Active"
----
<1> Displays that the update is in progress.
<2> Displays the list of identified clusters.

. Check the status of the pre-caching job by running the following command:
+
[source,terminal]
----
$ oc get jobs,pods -n openshift-talo-pre-cache
----
+
.Example output
+
[source,terminal]
----
NAME                  COMPLETIONS   DURATION   AGE
job.batch/pre-cache   0/1           3m10s      3m10s

NAME                     READY   STATUS    RESTARTS   AGE
pod/pre-cache--1-9bmlr   1/1     Running   0          3m10s
----

 . Check the status of the `ClusterGroupUpgrade` CR by running the following command:
+
[source,terminal]
----
$ oc get cgu -n ztp-group-du-sno du-upgrade-4918 -o jsonpath='{.status}' | jq
----
+
.Example output
+
[source,json]
----
conditions": [
    {
      "lastTransitionTime": "2022-01-27T19:30:41Z",
      "message": "The ClusterGroupUpgrade CR has all clusters compliant with all the managed policies",
      "reason": "UpgradeCompleted",
      "status": "True",
      "type": "Ready"
    },
    {
      "lastTransitionTime": "2022-01-27T19:28:57Z",
      "message": "Precaching is completed",
      "reason": "PrecachingCompleted",
      "status": "True",
      "type": "PrecachingDone" <1>
    }
----
<1> The pre-cache tasks are done.