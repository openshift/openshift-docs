// This is included in the following assemblies:
//
// installing_sno/install-sno-installing-sno.adoc

:_content-type: PROCEDURE
[id="installing-sno-on-ibm-power_{context}"]
= Installing {sno} with {ibmpowerProductName}

.Prerequisites

* You need to setup bastion.
+
--
** PXE is used for SNO installation. It requires the following services to be configured and run:
*** DNS to define api, api-int and *.apps
*** DHCP service to enable PXE and assign IP to SNO node
*** HTTP to provide ignition and RHCOS rootfs image
*** TFTP to enable PXE
** You will need to install dnsmasq to support DNS, DHCP and PXE, httpd for HTTP.
--
+
Perform the following steps to configure bastion to meet these requirements:
+
. Use the following command to install `grub2`, which is required to enable PXE for PowerVM:
+
[source,terminal]
----
grub2-mknetdir --net-directory=/var/lib/tftpboot
----
+
.Example `/var/lib/tftpboot/boot/grub2/grub.cfg` file
[source,terminal]
----
default=0
fallback=1
timeout=1
if [ ${net_default_mac} == fa:b0:45:27:43:20 ]; then
menuentry "CoreOS (BIOS)" {
   echo "Loading kernel"
   linux "/rhcos/kernel" ip=dhcp rd.neednet=1 ignition.platform.id=metal ignition.firstboot coreos.live.rootfs_url=http://192.168.10.5:8000/install/rootfs.img ignition.config.url=http://192.168.10.5:8000/ignition/sno.ign
   echo "Loading initrd"
   initrd  "/rhcos/initramfs.img"
}
fi
----

. Use the following commands to download RHCOS image files from the mirror repo for PXE:
+
[source,terminal]
----
$ export RHCOS_URL=https://mirror.openshift.com/pub/openshift-v4/ppc64le/dependencies/rhcos/4.12/latest/
----
+
[source,terminal]
----
$ cd /var/lib/tftpboot/rhcos
----
+
[source,terminal]
----
$ wget ${RHCOS_URL}/rhcos-live-kernel-ppc64le -o kernel
----
+
[source,terminal]
----
$ wget ${RHCOS_URL}/rhcos-live-initramfs.ppc64le.img -o initramfs.img
----
+
[source,terminal]
----
$ cd /var//var/www/html/install/
----
+
[source,terminal]
----
$ wget ${RHCOS_URL}/rhcos-live-rootfs.ppc64le.img -o rootfs.img
----

. To create the ignition file for SNO, you need to create the `install-config.yaml` file:

.. Use the following commands to create the work directory to hold the file:
+
[source,terminal]
----
mkdir -p ~/sno-work
cd ~/sno-work
----

.. Use the following sample file can to create the required `install-config.yaml` in the `~/sno-work` directory:
+
[source,yaml]
----
apiVersion: v1
baseDomain: <domain> <1>
compute:
- name: worker
  replicas: 0 <2>
controlPlane:
  name: master
  replicas: 1 <3>
metadata:
  name: <name> <4>
networking: <5>
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  machineNetwork:
  - cidr: 10.0.0.0/16 <6>
  networkType: OVNKubernetes
  serviceNetwork:
  - 172.30.0.0/16
platform:
  none: {}
bootstrapInPlace:
  installationDisk: /dev/disk/by-id/<disk_id> <7>
pullSecret: '<pull_secret>' <8>
sshKey: |
  <ssh_key> <9>
----
<1> Add the cluster domain name.
<2> Set the `compute` replicas to `0`. This makes the control plane node schedulable.
<3> Set the `controlPlane` replicas to `1`. In conjunction with the previous `compute` setting, this setting ensures the cluster runs on a single node.
<4> Set the `metadata` name to the cluster name.
<5> Set the `networking` details. OVN-Kubernetes is the only allowed network plugin type for single-node clusters.
<6> Set the `cidr` value to match the subnet of the {sno} cluster.
<7> Set the path to the installation disk drive, for example, `/dev/disk/by-id/wwn-0x64cd98f04fde100024684cf3034da5c2`.
<8> Copy the {cluster-manager-url-pull} and add the contents to this configuration setting.
<9> Add the public SSH key from the administration host so that you can log in to the cluster after installation.

.. Use the following commands to download the `openshift-install` image to create the ignition file and copy it to the http directory:
+
[source,terminal]
----
$ wget https://mirror.openshift.com/pub/openshift-v4/ppc64le/clients/ocp/4.12.0/openshift-install-linux-4.12.0.tar.gz
----
+
[source,terminal]
----
$ tar xzvf openshift-install-linux-4.12.0.tar.gz
----
+
[source,terminal]
----
$ ./openshift-install --dir=~/sno-work create create single-node-ignition-config
----
+
[source,terminal]
----
$ cp ~/sno-work/single-node-ignition-config.ign /var/www/html/ignition/sno.ign
----
+
[source,terminal]
----
$ restorecon -vR /var/www/html || true
----
+
Bastion now has all the required files and is properly configured in order to install {sno}.

.Procedure

There are two steps for SNO installation. First the {sno} logical partition (LPAR) needs to boot up with PXE, then you need to monitor the installation progress.

. Use the following command to boot powerVM with netboot:
+
[source,terminal]
----
$ lpar_netboot -i -D -f -t ent -m <sno_mac> -s auto -d auto -S <server_ip> -C <sno_ip> -G <gateway> <lpar_name> default_profile <cec_name>
----
+
where:
+
--
sno_mac:: Specifies the MAC address of SNO.
sno_ip:: Specifies the IP address of SNO.
server_ip:: Specifies the IP address of bastion (PXE server).
gateway:: Specifies the Network's gateway IP.
lpar_name:: Specifies the SNO lpar name in HMC.
cec_name:: Specifies the System name where the sno_lpar resides
--

. After the {sno} LPAR boots up with PXE, use the `openshift-install` command to monitor the progress of installation:

.. Run the following command after the bootstrap is complete:
+
[source,terminal]
---- 
./openshift-install wait-for bootstrap-complete
----

.. Run the following command after it returns successfully:
+
[source,terminal]
----
./openshift-install wait-for install-complete
----

