// Module included in the following assemblies:
//
// * machine_management/creating_machinesets/creating-machineset-azure.adoc
// * machine_management/control_plane_machine_management/cpmso_provider_configurations/cpmso-config-options-azure.adoc

ifeval::["{context}" == "cpmso-config-options-azure"]
:cpmso:
endif::[]

:_mod-docs-content-type: PROCEDURE
[id="machineset-azure-confidential-vms_{context}"]
= Configuring {azure-first} confidential virtual machines by using machine sets

[role="_abstract"]
{product-title} {product-version} supports {azure-full} confidential virtual machines (VMs).

[NOTE]
====
Confidential VMs are currently not supported on 64-bit ARM architectures.
====

By editing the machine set YAML file, you can configure the confidential VM options that a machine set uses for machines that it deploys. For example, you can configure these machines to use UEFI security features such as Secure Boot or a dedicated virtual Trusted Platform Module (vTPM) instance.

ifdef::cpmso[]
[WARNING]
====
Not all instance types support confidential VMs. Do not change the instance type for a control plane machine set that is configured to use confidential VMs to a type that is incompatible. Using an incompatible instance type can cause your cluster to become unstable.
====
endif::cpmso[]

For more information about related features and functionality, see the {azure-full} documentation about link:https://learn.microsoft.com/en-us/azure/confidential-computing/confidential-vm-overview[Confidential virtual machines].

.Procedure

. In a text editor, open the YAML file for an existing machine set or create a new one.

. Edit the following section under the `providerSpec` field:
+
--
.Sample configuration
[source,yaml]
----
ifndef::cpmso[]
apiVersion: machine.openshift.io/v1beta1
kind: MachineSet
endif::cpmso[]
ifdef::cpmso[]
apiVersion: machine.openshift.io/v1
kind: ControlPlaneMachineSet
endif::cpmso[]
# ...
spec:
  template:
    spec:
      providerSpec:
        value:
          osDisk:
            # ...
            managedDisk:
              securityProfile:
                securityEncryptionType: VMGuestStateOnly
            # ...
          securityProfile:
            settings:
                securityType: ConfidentialVM
                confidentialVM:
                  uefiSettings:
                    secureBoot: Disabled
                    virtualizedTrustedPlatformModule: Enabled
          vmSize: Standard_DC16ads_v5
# ...
----
where:
`spec.template.spec.providerSpec.value.osDisk.managedDisk.securityProfile`:: Specifies security profile settings for the managed disk when using a confidential VM.
`spec.template.spec.providerSpec.value.osDisk.managedDisk.securityProfile.securityEncryptionType`:: Enables encryption of the {azure-full} VM Guest State (VMGS) blob. This setting requires the use of vTPM.
`spec.template.spec.providerSpec.value.osDisk.securityProfile`:: Specifies security profile settings for the confidential VM.
`spec.template.spec.providerSpec.value.osDisk.securityProfile.settings.securityType`:: Enables the use of confidential VMs. This value is required for all valid configurations.
`spec.template.spec.providerSpec.value.osDisk.securityProfile.settings.confidentialVM.uefiSettings`::  Specifies which UEFI security features to use. This section is required for all valid configurations.
`spec.template.spec.providerSpec.value.osDisk.securityProfile.settings.confidentialVM.uefiSettings.secureBoot`:: Disables UEFI Secure Boot.
`spec.template.spec.providerSpec.value.osDisk.securityProfile.settings.confidentialVM.uefiSettings.virtualizedTrustedPlatformModule`:: Enables the use of a vTPM.
`spec.template.spec.providerSpec.value.osDisk.vmSize`:: Specifies an instance type that supports confidential VMs.
--

.Verification

* On the {azure-full} portal, review the details for a machine deployed by the machine set and verify that the confidential VM options match the values that you configured.

ifeval::["{context}" == "cpmso-config-options-azure"]
:!cpmso:
endif::[]