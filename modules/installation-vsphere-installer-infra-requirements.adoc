// Module included in the following assemblies:
//
// * installing/installing_vsphere/installing-vsphere-installer-provisioned.adoc
// * installing/installing_vsphere/installing-vsphere-installer-provisioned-customizations.adoc
// * installing/installing_vsphere/installing-vsphere-installer-provisioned-network-customizations.adoc
// * installing/installing_vsphere/installing-restricted-networks-installer-provisioned-vsphere.adoc
// * installing/installing_vmc/installing-vmc.adoc
// * installing/installing_vmc/installing-vmc-customizations.adoc
// * installing/installing_vmc/installing-vmc-network-customizations.adoc
// * installing/installing_vmc/installing-restricted-networks-vmc.adoc

ifeval::["{context}" == "installing-restricted-networks-installer-provisioned-vsphere"]
:restricted:
endif::[]
ifeval::["{context}" == "installing-restricted-networks-vmc"]
:restricted:
endif::[]

[id="installation-vsphere-installer-infra-requirements_{context}"]
= vCenter requirements

Before you install an {product-title} cluster on your vCenter that uses infrastructure that the installer provisions, you must prepare your environment.

[discrete]
[id="installation-vsphere-installer-infra-requirements-account_{context}"]
== Required vCenter account privileges

To install an {product-title} cluster in a vCenter, the installation program requires access to an account with privileges to read and create the required resources. Using an account that has global administrative privileges is the simplest way to access all of the necessary permissions.

If you cannot use an account with global adminstrative privileges, you must create roles to grant the privileges necessary for {product-title} cluster installation. While most of the privileges are always required, some are required only if you plan for the installation program to provision a folder to contain the {product-title} cluster on your vCenter instance, which is the default behavior. You must create or amend vSphere roles for the specified objects to grant the required privileges.

An additional role is required if the installation program is to create a vSphere virtual machine folder.

.Roles and privileges required for installation
[%collapsible]
====
[cols="3a,3a,3a",options="header"]
|===
|vSphere object for role
|When required
|Required privileges

|vSphere vCenter
|Always
|
[%hardbreaks]
`Cns.Searchable`
`InventoryService.Tagging.AttachTag`
`InventoryService.Tagging.CreateCategory`
`InventoryService.Tagging.CreateTag`
`InventoryService.Tagging.DeleteCategory`
`InventoryService.Tagging.DeleteTag`
`InventoryService.Tagging.EditCategory`
`InventoryService.Tagging.EditTag`
`Sessions.ValidateSession`
`StorageProfile.View`

|vSphere vCenter Cluster
|Always
|
[%hardbreaks]
`Host.Config.Storage`
`Resource.AssignVMToPool`
`VApp.AssignResourcePool`
`VApp.Import`
`VirtualMachine.Config.AddNewDisk`

|vSphere Datastore
|Always
|
[%hardbreaks]
`Datastore.AllocateSpace`
`Datastore.Browse`
`Datastore.FileManagement`
`InventoryService.Tagging.ObjectAttachable`

|vSphere Port Group
|Always
|`Network.Assign`

|Virtual Machine Folder
|Always
|
[%hardbreaks]
`Resource.AssignVMToPool`
`VApp.Import`
`VirtualMachine.Config.AddExistingDisk`
`VirtualMachine.Config.AddNewDisk`
`VirtualMachine.Config.AddRemoveDevice`
`VirtualMachine.Config.AdvancedConfig`
`VirtualMachine.Config.Annotation`
`VirtualMachine.Config.CPUCount`
`VirtualMachine.Config.DiskExtend`
`VirtualMachine.Config.DiskLease`
`VirtualMachine.Config.EditDevice`
`VirtualMachine.Config.Memory`
`VirtualMachine.Config.RemoveDisk`
`VirtualMachine.Config.Rename`
`VirtualMachine.Config.ResetGuestInfo`
`VirtualMachine.Config.Resource`
`VirtualMachine.Config.Settings`
`VirtualMachine.Config.UpgradeVirtualHardware`
`VirtualMachine.Interact.GuestControl`
`VirtualMachine.Interact.PowerOff`
`VirtualMachine.Interact.PowerOn`
`VirtualMachine.Interact.Reset`
`VirtualMachine.Inventory.Create`
`VirtualMachine.Inventory.CreateFromExisting`
`VirtualMachine.Inventory.Delete`
`VirtualMachine.Provisioning.Clone`

|vSphere vCenter Datacenter
|If the installation program creates the virtual machine folder
|
[%hardbreaks]
`Resource.AssignVMToPool`
`VApp.Import`
`VirtualMachine.Config.AddExistingDisk`
`VirtualMachine.Config.AddNewDisk`
`VirtualMachine.Config.AddRemoveDevice`
`VirtualMachine.Config.AdvancedConfig`
`VirtualMachine.Config.Annotation`
`VirtualMachine.Config.CPUCount`
`VirtualMachine.Config.DiskExtend`
`VirtualMachine.Config.DiskLease`
`VirtualMachine.Config.EditDevice`
`VirtualMachine.Config.Memory`
`VirtualMachine.Config.RemoveDisk`
`VirtualMachine.Config.Rename`
`VirtualMachine.Config.ResetGuestInfo`
`VirtualMachine.Config.Resource`
`VirtualMachine.Config.Settings`
`VirtualMachine.Config.UpgradeVirtualHardware`
`VirtualMachine.Interact.GuestControl`
`VirtualMachine.Interact.PowerOff`
`VirtualMachine.Interact.PowerOn`
`VirtualMachine.Interact.Reset`
`VirtualMachine.Inventory.Create`
`VirtualMachine.Inventory.CreateFromExisting`
`VirtualMachine.Inventory.Delete`
`VirtualMachine.Provisioning.Clone`
`VirtualMachine.Provisioning.DeployTemplate`
`VirtualMachine.Provisioning.MarkAsTemplate`
`Folder.Create`
`Folder.Delete`
|===
====


Additionally, the user requires some `ReadOnly` permissions, and some of the roles require permission to propogate the permissions to child objects. These settings vary depending on whether or not you install the cluster into an existing folder.

.Required permissions and propagation settings
[%collapsible]
====
[cols="3a,3a,3a,3a",options="header"]
|===
|vSphere object
|Folder type
|Propagate to children
|Permissions required

|vSphere vCenter
|Always
|False
|Listed required privileges

.2+|vSphere vCenter Datacenter
|Existing folder
|False
|`ReadOnly` permission

|Installation program creates the folder
|True
|Listed required privileges

|vSphere vCenter Cluster
|Always
|True
|Listed required privileges

|vSphere vCenter Datastore
|Always
|False
|Listed required privileges

|vSphere Switch
|Always
|False
|`ReadOnly` permission

|vSphere Port Group
|Always
|False
|Listed required privileges

|vSphere vCenter Virtual Machine Folder
|Existing folder
|True
|Listed required privileges
|===
====

For more information about creating an account with only the required privileges, see link:https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-5372F580-5C23-4E9C-8A4E-EF1B4DD9033E.html[vSphere Permissions and User Management Tasks] in the vSphere documentation.

[discrete]
[id="installation-vsphere-installer-infra-requirements-vmotion_{context}"]
== Using {product-title} with vMotion

[IMPORTANT]
====
{product-title} generally supports compute-only vMotion. Using Storage vMotion can cause issues and is not supported.
====

If you are using vSphere volumes in your pods, migrating a VM across datastores either manually or through Storage vMotion causes invalid references within {product-title} persistent volume (PV) objects. These references prevent affected pods from starting up and can result in data loss.

Similarly, {product-title} does not support selective migration of VMDKs across datastores, using datastore clusters for VM provisioning or for dynamic or static provisioning of PVs, or using a datastore that is part of a datastore cluster for dynamic or static provisioning of PVs.

[discrete]
[id="installation-vsphere-installer-infra-requirements-resources_{context}"]
== Cluster resources

When you deploy an {product-title} cluster that uses installer-provisioned infrastructure, the installation program must be able to create several resources in your vCenter instance.

A standard {product-title} installation creates the following vCenter resources:

* 1 Folder
* 1 Tag category
* 1 Tag
* Virtual machines:
** 1 template
** 1 temporary bootstrap node
** 3 control plane nodes
** 3 compute machines

Although these resources use 856 GB of storage, the bootstrap node is destroyed during the cluster installation process. A minimum of 800 GB of storage is required to use a standard cluster.

If you deploy more compute machines, the {product-title} cluster will use more storage.

[discrete]
[id="installation-vsphere-installer-infra-requirements-limits_{context}"]
== Cluster limits

Available resources vary between clusters. The number of possible clusters within a vCenter is limited primarily by available storage space and any limitations on the number of required resources. Be sure to consider both limitations to the vCenter resources that the cluster creates and the resources that you require to deploy a cluster, such as IP addresses and networks.

[discrete]
[id="installation-vsphere-installer-infra-requirements-networking_{context}"]
== Networking requirements

You must use DHCP for the network and ensure that the DHCP server is configured to provide persistent IP addresses to the cluster machines.
ifdef::restricted[]
The VM in your restricted network must have access to vCenter so that it can provision and manage nodes, persistent volume claims (PVCs), and other resources.
endif::restricted[]
Additionally, you must create the following networking resources before you install the {product-title} cluster:

[NOTE]
====
It is recommended that each {product-title} node in the cluster must have access to a Network Time Protocol (NTP) server that is discoverable via DHCP. Installation is possible without an NTP server. However, asynchronous server clocks will cause errors, which NTP server prevents.
====

[discrete]
[id="installation-vsphere-installer-infra-requirements-_{context}"]
=== Required IP Addresses
An installer-provisioned vSphere installation requires two static IP addresses:

* The **API** address is used to access the cluster API.
* The **Ingress** address is used for cluster ingress traffic.

You must provide these IP addresses to the installation program when you install the {product-title} cluster.

[discrete]
[id="installation-vsphere-installer-infra-requirements-dns-records_{context}"]
=== DNS records
You must create DNS records for two static IP addresses in the appropriate DNS server for the vCenter instance that hosts your {product-title} cluster. In each record, `<cluster_name>` is the cluster name and `<base_domain>` is the cluster base domain that you specify when you install the cluster. A complete DNS record takes the form: `<component>.<cluster_name>.<base_domain>.`.

.Required DNS records
[cols="1a,5a,3a",options="header"]
|===

|Component
|Record
|Description

|API VIP
|`api.<cluster_name>.<base_domain>.`
|This DNS A/AAAA or CNAME record must point to the load balancer
for the control plane machines. This record must be resolvable by both clients
external to the cluster and from all the nodes within the cluster.

|Ingress VIP
|`*.apps.<cluster_name>.<base_domain>.`
|A wildcard DNS A/AAAA or CNAME record that points to the load balancer that targets the
machines that run the Ingress router pods, which are the worker nodes by
default. This record must be resolvable by both clients external to the cluster
and from all the nodes within the cluster.
|===

ifeval::["{context}" == "installing-restricted-networks-installer-provisioned-vsphere"]
:!restricted:
endif::[]
ifeval::["{context}" == "installing-restricted-networks-vmc"]
:!restricted:
endif::[]
