// Module included in the following assemblies:
//
// * virt/advanced_vm_management/virt-configuring-usb-host-passthrough.adoc

:_mod-docs-content-type: PROCEDURE
[id="virt-enabling-usb-host-passthrough_{context}"]
= Enabling USB host passthrough

[role="_abstract"]
To attach a USB device to a virtual machine (VM), you must first enable USB host passthrough at the cluster level.

To do this, specify a resource name and USB device name for each device you want first to add and then assign to a VM. You can allocate more than one device, each of which is known as a `selector` in the `HyperConverged` custom resource (CR), to a single resource name. If you have multiple identical USB devices on the cluster, you can choose to allocate a VM to a specific device.

.Prerequisites

* You have access to an {product-title} cluster as a user who has the `cluster-admin` role.
* You have installed the {oc-first}.

.Procedure

. Ensure that the `HostDevices` feature gate is enabled:
+
[source,terminal]
----
$ oc get featuregate cluster -o yaml
----
+
*Successful output*
+
[source,yaml]
----
  featureGates:
# ...
    enabled:
    - name: HostDevices
----

. Identify the USB device vendor and product:
+
[source,terminal]
----
$ lsusb
----
+
*Example output*
+
[source,terminal]
----
Bus 003 Device 007: ID 1b1c:0a60 example_manufacturer example_product_name
----

** If you cannot use the `lsusb` command, inspect the USB device configurations in the host's `/sys/bus/usb/devices/` directory:
+
[source,terminal]
----
for dev in *; do
    if [[ -f "$dev/idVendor" && -f "$dev/idProduct" ]]; then
        echo "Device: $dev"
        echo -n "  Manufacturer : "; cat "$dev/manufacturer"
        echo -n "  Product: "; cat "$dev/product"
        echo -n "  Vendor ID : "; cat "$dev/idVendor"
        echo -n "  Product ID: "; cat "$dev/idProduct"
        echo
    fi
done
----
+
*Example output*
+
[source,terminal]
----
Device: 3-7
  Manufacturer : example_manufacturer
  Product: example_product_name
  Vendor ID : 1b1c
  Product ID: 0a60
----


. Add the required USB device to the `permittedHostDevices` stanza of the `HyperConvered` CR. The following example adds a device with vendor ID `045e` and product ID `07a5`: 
+
[source,terminal]
----
oc patch hyperconverged kubevirt-hyperconverged \
  -n openshift-cnv \
  --type=merge \
  -p '{
    "metadata": {
      "annotations": {
        "kubevirt.kubevirt.io/jsonpatch": "[{\"op\": \"add\", \"path\": \"/spec/permittedHostDevices/usbHostDevices/-\", \"value\": {\"resourceName\": \"kubevirt.io/peripherals\", \"selectors\": [{\"vendor\": \"045e\", \"product\": \"07a5\"}]}}]"
      }
    }
  }'
----

.Verification

* Ensure that the HCO CR contains the required USB devices:
+
[source,terminal]
----
$ oc get hyperconverged kubevirt-hyperconverged -n openshift-cnv
----
+
*Example output*
+
[source,yaml,subs="attributes+"]
----
apiVersion: hco.kubevirt.io/v1beta1
kind: HyperConverged
metadata:
   name: kubevirt-hyperconverged
   namespace: {CNVNamespace}
spec:
    permittedHostDevices: <1>
      usbHostDevices: <2>
        - resourceName: kubevirt.io/peripherals <3>
          selectors:
            - vendor: "045e"
              product: "07a5"
            - vendor: "062a"
              product: "4102"
            - vendor: "072f"
              product: "b100"

----
<1> Lists the host devices that have permission to be used in the cluster.
<2> Lists the available USB devices.
<3> Uses `resourceName: deviceName` for each device you want to add and assign to the VM. In this example, the resource is bound to three devices, each of which is identified by `vendor` and `product` and is known as a `selector`.
