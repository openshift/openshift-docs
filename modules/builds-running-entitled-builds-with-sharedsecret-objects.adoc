:_content-type: PROCEDURE
[id="builds-running-entitled-builds-with-sharedsecret-objects_{context}"]
= Running entitled builds using SharedSecret objects

You can configure and perform a build in one namespace that securely uses RHEL entitlements from a `Secret` object in another namespace.

You can access RHEL entitlements from OpenShift Builds by creating a `Secret` object with your subscription credentials in the same namespace as your `Build` object. However, in {product-title} 4.10 and later, you can access your credentials and certificates from a `Secret` object in one of the {product-title} system namespaces. You can use a CSI volume mount connected to a 'SharedSecret' custom resource (CR) instance to run builds that require specific entitlements. This instance should reference a 'Secret' object.

This procedure relies on the Shared Resources CSI Driver feature, which you can use to declare CSI Volume mounts in {product-title} Builds. It also relies on the {product-title} Insights Operator.

:FeatureName: Managing machines with the Cluster API
include::snippets/technology-preview.adoc[]

The Shared Resources CSI Driver feature also belongs to the `TechPreviewNoUpgrade` feature set, which is a subset of the current Technology Preview features. You can enable the `TechPreviewNoUpgrade` feature set on test clusters, where you can fully test them while leaving the features disabled on production clusters. Enabling this feature set cannot be undone and prevents minor version updates. This feature set is not recommended on production clusters. See "Enabling Technology Preview features using feature gates" in the following "Additional resources" section.

.Prerequisites

* You have enabled the `TechPreviewNoUpgrade` feature set by using the feature gates.
* You have a `SharedSecret` custom resource (CR) instance that references the `Secret` object where the Insights Operator stores the subscription credentials.
* You must have access to Red Hat entitlements through your subscription.
* You must have permission to perform the following actions:
** Create build configs and start builds.
** Discover which `SharedSecret` CR instances are available by entering the `oc get sharedsecrets` command and getting a non-empty list back.
** Determine if the `builder` service account available to you in your namespace is allowed to use the given `SharedSecret` CR instance. In other words, you can run `oc adm policy who-can use <identifier of specific SharedSecret>` to see if the `builder` service account in your namespace is listed.

[NOTE]
====
If neither of the last two prerequisites in this list are met, establish, or ask someone to establish, the necessary role-based access control (RBAC) so that you can discover `SharedSecret` CR instances and enable service accounts to use `SharedSecret` CR instances.
====

[IMPORTANT]
====
Ensure that you activate the TechPreviewNoUpgrade feature set using the feature gates to prevent any errors in future operations.
====

.Procedure

. Grant the `builder` service account RBAC permissions to use the `SharedSecret` CR instance by using `oc apply` with YAML content:
+
[NOTE]
====
Currently, `kubectl` and `oc` have hard-coded special case logic restricting the `use` verb to roles centered around pod security. Therefore, you cannot use `oc create role ...` to create the role needed for consuming `SharedSecret` CR instances.
====
+
.Example `oc apply -f` command with YAML `Role` object definition
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: shared-resource-my-share
  namespace: my-namespace
rules:
  - apiGroups:
      - sharedresource.openshift.io
    resources:
      - sharedsecrets
    resourceNames:
      - my-share
    verbs:
      - use
EOF
----
+
. Create the `RoleBinding` associated with the role by using the `oc` command:
+
.Example `oc create rolebinding` command
[source,terminal]
----
$ oc create rolebinding shared-resource-my-share --role=shared-resource-my-share --serviceaccount=my-namespace:builder
----
+
. Add a volume to mount the `rhsm.conf` file into the container. Specify the path to `rhsm.conf` as the source for this volume.
+
[TIP]
=== 
You must have access to Red Hat entitlements through your subscription. The entitlement secret is automatically created by the Insights Operator. When you perform an Entitlement Build using Red Hat Enterprise Linux (RHEL) 7, you must have the following instructions in your Dockerfile before you run any yum commands:

[source,terminal]
----
RUN rm /etc/rhsm-host
----
====
+
.. Add the etc-pki-entitlement secret as a build volume in the build configurationâ€™s Docker strategy:
+
.Example YAML `BuildConfig` object definition
[source,yaml]
----
strategy:
  dockerStrategy:
    from:
      kind: ImageStreamTag
      name: ubi:latest
    volumes:
    - name: etc-pki-entitlement
      mounts:
      - destinationPath: /etc/pki/entitlement
      source:
        type: Secret
        secret:
          secretName: etc-pki-entitlement
----
+
. Create a `BuildConfig` object that accesses the RHEL entitlements.
+
.Example YAML `BuildConfig` object definition
[source,yaml]
----
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: entitled-build
  namespace: entitlement-test
spec:
  runPolicy: Serial
  source:
    dockerfile: |
      FROM registry.access.redhat.com/ubi8/ubi:8.7-1112
      RUN rm /etc/rhsm-host
      RUN yum --enablerepo=codeready-builder-for-rhel-8-x86_64-rpms \
          install \
          sudo \
          procps-ng \
          curl \
          cronie \
          crontabs \
          nss_wrapper \
          uid_wrapper -y && \
          yum clean all -y
  strategy:
    type: Docker
    dockerStrategy:
      from:
        kind: DockerImage
        name: registry.access.redhat.com/ubi8/ubi:8.7-1112
      volumes:
        - mounts:
            - destinationPath: "/etc/pki/entitlement"
          name: etc-pki-entitlement
          source:
            secret:
              defaultMode: 420
              secretName: etc-pki-entitlement
            type: Secret
----
+
. Start a build from the `BuildConfig` object and follow the logs with the `oc` command.
+
.Example oc start-build command
[source,terminal]
----
$ oc start-build my-csi-bc -F
----
+
.Example output from the oc start-build command
[%collapsible]
====
[NOTE]
=====
Some sections of the following output have been replaced with `...`
=====
[source,terminal]
----
build.build.openshift.io/entitled-build-14 started
Replaced Dockerfile FROM image registry.access.redhat.com/ubi8/ubi:8.7-1112
time="..." level=info msg="Not using native diff for overlay, this may cause degraded performance for building images: kernel has CONFIG_OVERLAY_FS_REDIRECT_DIR enabled"
I1129 19:52:10.934058       1 defaults.go:112] Defaulting to storage driver "overlay" with options [mountopt=metacopy=on].
Caching blobs under "/var/cache/blobs".

Pulling image registry.access.redhat.com/ubi8/ubi:8.7-1112 ...
Trying to pull registry.access.redhat.com/ubi8/ubi:8.7-1112...
Getting image source signatures
Copying blob sha256:6208c5a2e205726f3a2cd42a392c5e4f05256850d13197a711000c4021ede87b
Copying config sha256:768688a189716f9aef8d33a9eef4209f57dc2e66e9cb5fc3b8862940f314b9bc
Writing manifest to image destination
Storing signatures
Adding transient rw bind mount for /run/secrets/rhsm
STEP 1/5: FROM registry.access.redhat.com/ubi8/ubi:8.7-1112
STEP 2/5: RUN rm /etc/rhsm-host
--> cf2bd7bd3c6
STEP 3/5: RUN yum --enablerepo=codeready-builder-for-rhel-8-x86_64-rpms     install     sudo     procps-ng     curl     cronie     crontabs     nss_wrapper     uid_wrapper -y &&     yum clean all -y
Updating Subscription Management repositories.
Unable to read consumer identity

This system is not registered with an entitlement server. You can use subscription-manager to register.

Red Hat Enterprise Linux 8 for x86_64 - AppStre  43 MB/s |  58 MB     00:01    
Red Hat Enterprise Linux 8 for x86_64 - BaseOS   45 MB/s |  64 MB     00:01    
Red Hat CodeReady Linux Builder for RHEL 8 x86_  14 MB/s | 8.8 MB     00:00    
Red Hat Universal Base Image 8 (RPMs) - BaseOS  942 kB/s | 717 kB     00:00    
Red Hat Universal Base Image 8 (RPMs) - AppStre 2.9 MB/s | 3.0 MB     00:01    
Red Hat Universal Base Image 8 (RPMs) - CodeRea  89 kB/s | 103 kB     00:01    
Last metadata expiration check: 0:00:01 ago on Wed Nov 29 19:53:11 2023.
Package curl-7.61.1-25.el8_7.3.x86_64 is already installed.
Dependencies resolved.
=========================================================================================================================
 Package                  Arch    Version                                 Repository                                 Size
=========================================================================================================================
Installing:
 cronie                   x86_64  1.5.2-8.el8                             rhel-8-for-x86_64-baseos-rpms             119 k
 crontabs                 noarch  1.11-17.20190603git.el8                 rhel-8-for-x86_64-baseos-rpms              25 k
 nss_wrapper              x86_64  1.1.13-1.el8                            rhel-8-for-x86_64-appstream-rpms           18 k
 procps-ng                x86_64  3.3.15-14.el8                           rhel-8-for-x86_64-baseos-rpms             330 k
 sudo                     x86_64  1.8.29-10.el8                           rhel-8-for-x86_64-baseos-rpms             926 k
 uid_wrapper              x86_64  1.2.4-4.el8                             codeready-builder-for-rhel-8-x86_64-rpms   41 k
Upgrading:
 curl                     x86_64  7.61.1-33.el8                           rhel-8-for-x86_64-baseos-rpms             353 k
 libcurl                  x86_64  7.61.1-33.el8                           rhel-8-for-x86_64-baseos-rpms             303 k
Installing dependencies:
 cmake-data               noarch  3.20.2-5.el8                            rhel-8-for-x86_64-appstream-rpms          1.7 M
 cmake-filesystem         x86_64  3.20.2-5.el8                            rhel-8-for-x86_64-appstream-rpms           45 k
 cmake-rpm-macros         noarch  3.20.2-5.el8                            rhel-8-for-x86_64-appstream-rpms           44 k
 cronie-anacron           x86_64  1.5.2-8.el8                             rhel-8-for-x86_64-baseos-rpms              42 k
 emacs-filesystem         noarch  1:26.1-11.el8                           rhel-8-for-x86_64-baseos-rpms              70 k
 groff-base               x86_64  1.22.3-18.el8                           rhel-8-for-x86_64-baseos-rpms             1.0 M
 libpkgconf               x86_64  1.4.2-1.el8                             rhel-8-for-x86_64-baseos-rpms              35 k
 libuv                    x86_64  1:1.41.1-1.el8_4                        rhel-8-for-x86_64-appstream-rpms          156 k
 make                     x86_64  1:4.2.1-11.el8                          rhel-8-for-x86_64-baseos-rpms             498 k
 ncurses                  x86_64  6.1-9.20180224.el8                      rhel-8-for-x86_64-baseos-rpms             387 k
 nss_wrapper-libs         x86_64  1.1.13-1.el8                            rhel-8-for-x86_64-appstream-rpms           40 k
 openssl                  x86_64  1:1.1.1k-9.el8_7                        rhel-8-for-x86_64-baseos-rpms             710 k
 perl-Carp                noarch  1.42-396.el8                            rhel-8-for-x86_64-baseos-rpms              30 k
 perl-Data-Dumper         x86_64  2.167-399.el8                           rhel-8-for-x86_64-baseos-rpms              58 k
 perl-Digest              noarch  1.17-395.el8                            rhel-8-for-x86_64-appstream-rpms           27 k
 perl-Digest-MD5          x86_64  2.55-396.el8                            rhel-8-for-x86_64-appstream-rpms           37 k
 perl-Encode              x86_64  4:2.97-3.el8                            rhel-8-for-x86_64-baseos-rpms             1.5 M
 perl-Errno               x86_64  1.28-422.el8                            rhel-8-for-x86_64-baseos-rpms              77 k
 perl-Exporter            noarch  5.72-396.el8                            rhel-8-for-x86_64-baseos-rpms              34 k
 perl-File-Path           noarch  2.15-2.el8                              rhel-8-for-x86_64-baseos-rpms              38 k
 perl-File-Temp           noarch  0.230.600-1.el8                         rhel-8-for-x86_64-baseos-rpms              63 k
 perl-Getopt-Long         noarch  1:2.50-4.el8                            rhel-8-for-x86_64-baseos-rpms              63 k
 perl-HTTP-Tiny           noarch  0.074-2.el8                             rhel-8-for-x86_64-baseos-rpms              58 k
 perl-IO                  x86_64  1.38-422.el8                            rhel-8-for-x86_64-baseos-rpms             142 k
 perl-IO-Socket-IP        noarch  0.39-5.el8                              rhel-8-for-x86_64-appstream-rpms           47 k
 perl-IO-Socket-SSL       noarch  2.066-4.module+el8.3.0+6446+594cad75    rhel-8-for-x86_64-appstream-rpms          298 k
 perl-MIME-Base64         x86_64  3.15-396.el8                            rhel-8-for-x86_64-baseos-rpms              31 k
 perl-Mozilla-CA          noarch  20160104-7.module+el8.3.0+6498+9eecfe51 rhel-8-for-x86_64-appstream-rpms           15 k
 perl-Net-SSLeay          x86_64  1.88-2.module+el8.6.0+13392+f0897f98    rhel-8-for-x86_64-appstream-rpms          379 k
 perl-PathTools           x86_64  3.74-1.el8                              rhel-8-for-x86_64-baseos-rpms              90 k
 perl-Pod-Escapes         noarch  1:1.07-395.el8                          rhel-8-for-x86_64-baseos-rpms              20 k
 perl-Pod-Perldoc         noarch  3.28-396.el8                            rhel-8-for-x86_64-baseos-rpms              88 k
 perl-Pod-Simple          noarch  1:3.35-395.el8                          rhel-8-for-x86_64-baseos-rpms             213 k
 perl-Pod-Usage           noarch  4:1.69-395.el8                          rhel-8-for-x86_64-baseos-rpms              34 k
 perl-Scalar-List-Utils   x86_64  3:1.49-2.el8                            rhel-8-for-x86_64-baseos-rpms              68 k
 perl-Socket              x86_64  4:2.027-3.el8                           rhel-8-for-x86_64-baseos-rpms              59 k
 perl-Storable            x86_64  1:3.11-3.el8                            rhel-8-for-x86_64-baseos-rpms              98 k
 perl-Term-ANSIColor      noarch  4.06-396.el8                            rhel-8-for-x86_64-baseos-rpms              46 k
 perl-Term-Cap            noarch  1.17-395.el8                            rhel-8-for-x86_64-baseos-rpms              23 k
 perl-Text-ParseWords     noarch  3.30-395.el8                            rhel-8-for-x86_64-baseos-rpms              18 k
 perl-Text-Tabs+Wrap      noarch  2013.0523-395.el8                       rhel-8-for-x86_64-baseos-rpms              24 k
 perl-Time-Local          noarch  1:1.280-1.el8                           rhel-8-for-x86_64-baseos-rpms              34 k
 perl-URI                 noarch  1.73-3.el8                              rhel-8-for-x86_64-appstream-rpms          116 k
 perl-Unicode-Normalize   x86_64  1.25-396.el8                            rhel-8-for-x86_64-baseos-rpms              82 k
 perl-constant            noarch  1.33-396.el8                            rhel-8-for-x86_64-baseos-rpms              25 k
 perl-interpreter         x86_64  4:5.26.3-422.el8                        rhel-8-for-x86_64-baseos-rpms             6.3 M
 perl-libnet              noarch  3.11-3.el8                              rhel-8-for-x86_64-appstream-rpms          121 k
 perl-libs                x86_64  4:5.26.3-422.el8                        rhel-8-for-x86_64-baseos-rpms             1.6 M
 perl-macros              x86_64  4:5.26.3-422.el8                        rhel-8-for-x86_64-baseos-rpms              73 k
 perl-parent              noarch  1:0.237-1.el8                           rhel-8-for-x86_64-baseos-rpms              20 k
 perl-podlators           noarch  4.11-1.el8                              rhel-8-for-x86_64-baseos-rpms             118 k
 perl-threads             x86_64  1:2.21-2.el8                            rhel-8-for-x86_64-baseos-rpms              61 k
 perl-threads-shared      x86_64  1.58-2.el8                              rhel-8-for-x86_64-baseos-rpms              48 k
 pkgconf                  x86_64  1.4.2-1.el8                             rhel-8-for-x86_64-baseos-rpms              38 k
 pkgconf-m4               noarch  1.4.2-1.el8                             rhel-8-for-x86_64-baseos-rpms              17 k
 pkgconf-pkg-config       x86_64  1.4.2-1.el8                             rhel-8-for-x86_64-baseos-rpms              15 k
 vim-filesystem           noarch  2:8.0.1763-19.el8_6.4                   rhel-8-for-x86_64-appstream-rpms           50 k
Installing weak dependencies:
 cmake                    x86_64  3.20.2-5.el8                            rhel-8-for-x86_64-appstream-rpms           12 M
Enabling module streams:
 perl                             5.26                                                                                   
 perl-IO-Socket-SSL               2.066                                                                                  
 perl-libwww-perl                 6.34                                                                                   

Transaction Summary
=========================================================================================================================
Install  64 Packages
Upgrade   2 Packages

Total download size: 31 M
Downloading Packages:
(1/66): perl-IO-Socket-IP-0.39-5.el8.noarch.rpm 270 kB/s |  47 kB     00:00    
[...]

Complete!
Updating Subscription Management repositories.
Unable to read consumer identity

This system is not registered with an entitlement server. You can use subscription-manager to register.

51 files removed
--> 87ad7bf9444
STEP 4/5: ENV "OPENSHIFT_BUILD_NAME"="entitled-build-14" "OPENSHIFT_BUILD_NAMESPACE"="entitlement-test"
--> 24d3580ea34
STEP 5/5: LABEL "io.openshift.build.name"="entitled-build-14" "io.openshift.build.namespace"="entitlement-test"
COMMIT temp.builder.openshift.io/entitlement-test/entitled-build-14:478df926
--> c7a1b01d71f
Successfully tagged temp.builder.openshift.io/entitlement-test/entitled-build-14:478df926
c7a1b01d71faa8a4502ee07f398189f8881963c1a8815b700b100c0c482b8149
Build complete, no image push requested
----
====
