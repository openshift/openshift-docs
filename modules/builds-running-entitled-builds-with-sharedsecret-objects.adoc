:_mod-docs-content-type: PROCEDURE
[id="builds-running-entitled-builds-with-sharedsecret-objects_{context}"]
= Running entitled builds using SharedSecret objects

You can configure and perform a build in one namespace that securely uses RHEL entitlements from a `Secret` object in another namespace.

You can access RHEL entitlements from OpenShift Builds by creating a `Secret` object with your subscription credentials in the same namespace as your `Build` object. However, in {product-title} 4.10 and later, you can access your credentials and certificates from a `Secret` object in one of the {product-title} system namespaces. You can use a CSI volume mount connected to a 'SharedSecret' custom resource (CR) instance to run builds that require specific entitlements. This instance should reference a 'Secret' object.

This procedure relies on the Shared Resources CSI Driver feature, which you can use to declare CSI Volume mounts in {product-title} Builds. It also relies on the {product-title} Insights Operator.

:FeatureName: Builds using SharedSecret objects
=======
include::snippets/technology-preview.adoc[]

The Shared Resources CSI Driver feature also belongs to the `TechPreviewNoUpgrade` feature set, which is a subset of the current Technology Preview features. You can enable the `TechPreviewNoUpgrade` feature set on test clusters, where you can fully test them while leaving the features disabled on production clusters. Enabling this feature set cannot be undone and prevents minor version updates. This feature set is not recommended on production clusters. See "Enabling Technology Preview features using feature gates" in the following "Additional resources" section.

.Prerequisites

* You have enabled the `TechPreviewNoUpgrade` feature set by using the feature gates.
* You have a `SharedSecret` custom resource (CR) instance that references the `Secret` object where the Insights Operator stores the subscription credentials.
* You must have permission to perform the following actions:
** Create build configs and start builds.
** Discover which `SharedSecret` CR instances are available by entering the `oc get sharedsecrets` command and getting a non-empty list back.
** Determine if the `builder` service account available to you in your namespace is allowed to use the given `SharedSecret` CR instance. In other words, you can run `oc adm policy who-can use <identifier of specific SharedSecret>` to see if the `builder` service account in your namespace is listed.

[NOTE]
====
If neither of the last two prerequisites in this list are met, establish, or ask someone to establish, the necessary role-based access control (RBAC) so that you can discover `SharedSecret` CR instances and enable service accounts to use `SharedSecret` CR instances.
====

.Procedure

. Grant the `builder` service account RBAC permissions to use the `SharedSecret` CR instance by using `oc apply` with YAML content:
+
[NOTE]
====
Currently, `kubectl` and `oc` have hard-coded special case logic restricting the `use` verb to roles centered around pod security. Therefore, you cannot use `oc create role ...` to create the role needed for consuming `SharedSecret` CR instances.
====
+
.Example `oc apply -f` command with YAML `Role` object definition
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: shared-resource-my-share
  namespace: my-namespace
rules:
  - apiGroups:
      - sharedresource.openshift.io
    resources:
      - sharedsecrets
    resourceNames:
      - my-share
    verbs:
      - use
EOF
----
+
. Create the `RoleBinding` associated with the role by using the `oc` command:
+
.Example `oc create rolebinding` command
[source,terminal]
----
$ oc create rolebinding shared-resource-my-share --role=shared-resource-my-share --serviceaccount=my-namespace:builder
----
+
. Add a volume to mount the `rhsm.conf` file into the container. Specify the path to `rhsm.conf` as the source for this volume.
+
[NOTE]
==== 
Your cluster must be attached to an active Red Hat subscription. The entitlement secret is automatically created by the Insights Operator.

[TIP]
==== 
When you use Red Hat Enterprise Linux (RHEL) 7 or UBI8 as the base image of your build, you must have the following instructions in your Dockerfile before you run any `yum` or `dnf` commands:

[source,terminal]
----
RUN rm /etc/rhsm-host
----
====
+
.. Add the etc-pki-entitlement secret as a build volume in the build configurationâ€™s Docker strategy:
+
.Example YAML `BuildConfig` object definition
[source,yaml]
----
strategy:
  dockerStrategy:
    from:
      kind: ImageStreamTag
      name: ubi:latest
    volumes:
    - name: etc-pki-entitlement
      mounts:
      - destinationPath: /etc/pki/entitlement
      source:
        type: Secret
        secret:
          secretName: etc-pki-entitlement
----
+
. Create a `BuildConfig` object that accesses the RHEL entitlements.
+
.Example YAML `BuildConfig` object definition
[source,yaml]
----
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: entitled-build
  namespace: entitlement-test
spec:
  runPolicy: Serial
  source:
    dockerfile: |
      FROM registry.access.redhat.com/ubi8/ubi:latest
      RUN rm /etc/rhsm-host
      RUN yum --enablerepo=codeready-builder-for-rhel-8-x86_64-rpms \
          install \
          sudo \
          procps-ng \
          curl \
          cronie \
          crontabs \
          nss_wrapper \
          uid_wrapper -y && \
          yum clean all -y
  strategy:
    type: Docker
    dockerStrategy:
      from:
        kind: DockerImage
        name: registry.access.redhat.com/ubi8/ubi:lastest
      volumes:
        - mounts:
            - destinationPath: "/etc/pki/entitlement"
          name: etc-pki-entitlement
          source:
            secret:
              defaultMode: 420
              secretName: etc-pki-entitlement
            type: Secret
----
+
. Start a build from the `BuildConfig` object and follow the logs with the `oc` command.
+
.Example oc start-build command
[source,terminal]
----
$ oc start-build my-csi-bc -F
----
+
.Example output from the oc start-build command
[%collapsible]
====
[NOTE]
=====
Some sections of the following output have been replaced with `...`
=====
[source,terminal]
----
build.build.openshift.io/entitled-build-14 started
Replaced Dockerfile FROM image registry.access.redhat.com/ubi8/ubi:latest
time="..." level=info msg="Not using native diff for overlay Defaulting to storage driver "overlay" with options [mountopt=metacopy=on].
Caching blobs under "/var/cache/blobs"
[...]

Writing manifest to image destination
Storing signatures
Adding transient rw bind mount for /run/secrets/rhsm
STEP 1/5: FROM registry.access.redhat.com/ubi8/ubi:latest
STEP 2/5: RUN rm /etc/rhsm-host
--> cf2bd7bd3c6
STEP 3/5: RUN yum --enablerepo=codeready-builder-for-rhel-8-x86_64-rpms     install     sudo     procps-ng     curl     cronie     crontabs     nss_wrapper     uid_wrapper -y &&     yum clean all -y
Updating Subscription Management repositories.
Unable to read consumer identity

This system is not registered with an entitlement server. You can use subscription-manager to register.

Red Hat Enterprise Linux 8 for x86_64 - AppStre  43 MB/s |  58 MB     00:01    
Red Hat Enterprise Linux 8 for x86_64 - BaseOS   45 MB/s |  64 MB     00:01    
Red Hat CodeReady Linux Builder for RHEL 8 x86_  14 MB/s | 8.8 MB     00:00    
Red Hat Universal Base Image 8 (RPMs) - BaseOS  942 kB/s | 717 kB     00:00    
Red Hat Universal Base Image 8 (RPMs) - AppStre 2.9 MB/s | 3.0 MB     00:01    
Red Hat Universal Base Image 8 (RPMs) - CodeRea  89 kB/s | 103 kB     00:01    
Last metadata expiration check: 0:00:01 ago on Wed Nov 29 19:53:11 2023.
Package curl-7.61.1-25.el8_7.3.x86_64 is already installed.
Dependencies resolved.
=========================================================================================================================
 Package                  Arch    Version                                 Repository                                 Size
=========================================================================================================================
Installing:
 cronie                   x86_64  1.5.2-8.el8                             rhel-8-for-x86_64-baseos-rpms             119 k
 crontabs                 noarch  1.11-17.20190603git.el8                 rhel-8-for-x86_64-baseos-rpms              25 k
 nss_wrapper              x86_64  1.1.13-1.el8                            el8                            rhel-8-for-x86_64-baseos-rpms              88 k
 perl-Pod-Simple          noarch  1:3.35-395.el8                          rhel-8-for-x86_64-baseos-rpms             213 k
 perl-Pod-Usage           noarch  4:1.69-395.el8                          rhel-8-for-x86_64-baseos-rpms              34 k
 perl-Scalar-List-Utils   x86_64  3:1.49-2.el8                            rhel-8-for-x86_64-baseos-rpms              68 k
 perl-Socket              x86_64  4:2.027-3
 [...]
                                                                               

Transaction Summary
=========================================================================================================================
Install  64 Packages
Upgrade   2 Packages

Total download size: 31 M
Downloading Packages:
(1/66): perl-IO-Socket-IP-0.39-5.el8.noarch.rpm 270 kB/s |  47 kB     00:00    
[...]

Complete!
Updating Subscription Management repositories.
Unable to read consumer identity

This system is not registered with an entitlement server. You can use subscription-manager to register.

51 files removed
--> 87ad7bf9444
STEP 4/5: ENV "OPENSHIFT_BUILD_NAME"="entitled-build-14" "OPENSHIFT_BUILD_NAMESPACE"="entitlement-test"
--> 24d3580ea34
STEP 5/5: LABEL "io.openshift.build.name"="entitled-build-14" "io.openshift.build.namespace"="entitlement-test"
COMMIT temp.builder.openshift.io/entitlement-test/entitled-build-14:478df926
--> c7a1b01d71f
Successfully tagged temp.builder.openshift.io/entitlement-test/entitled-build-14:478df926
c7a1b01d71faa8a4502ee07f398189f8881963c1a8815b700b100c0c482b8149
Build complete, no image push requested
----
====
