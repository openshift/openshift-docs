:_mod-docs-content-type: PROCEDURE
[id="builds-running-entitled-builds-with-sharedsecret-objects_{context}"]
= Running builds using SharedSecret objects

Starting in {product-title} 4.10 and later, you can use a `SharedSecret` object to securely access the cluster's entitlement keys in builds.
`SharedSecret` objects allow `Secret` content to be shared across namespaces and kept synchronized.

This procedure relies on the Shared Resource CSI Driver feature.

:FeatureName: Shared Resource CSI Driver
include::snippets/technology-preview.adoc[]

See xref:../../nodes/clusters/nodes-cluster-enabling-features.adoc#nodes-cluster-enabling[Enabling features using feature gates] for more information on how to enable this feature.

.Prerequisites

* You have enabled the  `TechPreviewNoUpgrade` feature set enabled.
* Your cluster must be subscribed and have the Insights Operator import its xref:../../support/remote_health_monitoring/insights-operator-simple-access.adoc#insights-operator-simple-access[Simple Content Access certificates].


.Procedure

. Create a `SharedSecret` object instance referencing the cluster's entitlement secret.
+
[source,terminal]
----
$ oc apply -f - <<EOF
kind: SharedSecret
apiVersion: sharedresource.openshift.io/v1alpha1
metadata:
  name: etc-pki-entitlement
spec:
  secretRef:
    name: etc-pki-entitlement
    namespace: openshift-config-managed
EOF
----
+
[IMPORTANT]
====
Your user account must have cluster administrator permissions to create `SharedSecret` objects.
====

. Create a role that will be used to grant the `builder` service account permission to access the `SharedSecret`.
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: builder-etc-pki-entitlement
rules:
  - apiGroups:
      - sharedresource.openshift.io
    resources:
      - sharedsecrets
    resourceNames:
      - etc-pki-entitlement
    verbs:
      - use
EOF
----

. Create a `RoleBinding` that grants the `builder` service account permission to access the `SharedSecret` object.
+
[source,terminal]
----
$ oc create rolebinding builder-etc-pki-entitlement --role=builder-etc-pki-entitlement --serviceaccount=builder
----

. Add the entitlement secret to your `BuildConfig` using a `csi` volume mount.
+
[source,yaml]
----
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: uid-wrapper-rhel9
spec:
  runPolicy: Serial
  source:
    dockerfile: |
      FROM registry.redhat.io/ubi9/ubi:latest
      RUN rm -rf /etc/rhsm-host <1>
      RUN yum --enablerepo=codeready-builder-for-rhel-9-x86_64-rpms install \ <2>
          nss_wrapper \
          uid_wrapper -y && \
          yum clean all -y
      RUN ln -s /run/secrets/rhsm /etc/rhsm-host <3>
  strategy:
    type: Docker
    dockerStrategy:
      volumes:
        - mounts:
            - destinationPath: "/etc/pki/entitlement"
          name: etc-pki-entitlement
          source:
            csi:
              driver: csi.sharedresource.openshift.io
              readOnly: true <4>
              volumeAttributes:
                sharedSecret: etc-pki-entitlement <5>
            type: CSI
----
+
<1> You *must* include this instruction in your Dockerfile before executing any `yum` or `dnf` commands.
<2> Use the link:https://access.redhat.com/downloads/content/package-browser[Red Hat Package Browser] to find the correct repositories for your installed packages.
<3> You *must* restore the `/etc/rhsm-host` symbolic link to keep your image compatible with other Red Hat container images.
<4> You *must* set `readOnly` to `true` in order to mount the shared resource in your build.
<5> Reference the name of the `SharedSecret` object to include its contents in the build. 

. Start a build from the `BuildConfig` object and follow the logs with the `oc` command.
+
[source,terminal]
----
$ oc start-build uid-wrapper-rhel9 -F
----
