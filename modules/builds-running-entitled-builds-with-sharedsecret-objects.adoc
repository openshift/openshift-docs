:_mod-docs-content-type: PROCEDURE
[id="builds-running-entitled-builds-with-sharedsecret-objects_{context}"]
= Running builds using SharedSecret objects

You can use a `SharedSecret` object to securely access the entitlement keys of a cluster in builds.

The `SharedSecret` object allows you to share and synchronize secrets across namespaces.

[IMPORTANT]
====
* The Shared Resource CSI Driver feature is now generally available in link:https://docs.redhat.com/en/documentation/builds_for_red_hat_openshift/1.1 {product-title} Builds 1.1. To use this feature, ensure you are using {product-title} Builds 1.1 or a more recent version.
====

.Prerequisites

* You must have permission to perform the following actions:
** Create build configs and start builds.
** Discover which `SharedSecret` custom resource (CR) instances are available by entering the `oc get sharedsecrets` command and getting a non-empty list back.
** Determine if a service account is available in your namespace and is allowed to use the given `SharedSecret` CR instance. In other words, you can run `oc adm policy who-can use <identifier_of_specific_SharedSecret>` to see if the desired service account in your namespace is listed.

[NOTE]
====
If neither of the last two prerequisites in this list are met, establish, or ask your cluster administrator to establish, the necessary role-based access control (RBAC) so that you can discover `SharedSecret` instances and grant service accounts to use `SharedSecret` instances.
====

.Procedure

[IMPORTANT]
====
Currently, the `buildah` buildstrategy does not support CSI. You need to locally create a `buildah` buildStrategy.
====

. Create a `buildah-csi` buildStrategy locally by running the following command:
+
[source,terminal]
----
$ curl -s https://raw.githubusercontent.com/redhat-openshift-builds/operator/refs/heads/builds-1.2/config/shipwright/build/strategy/buildah.yaml | sed 's/name: buildah/name: buildah-csi/' | oc apply -f -
----

. Create a `SharedSecret` object instance with the cluster's entitlement secret by running the `oc apply` command:
+
[IMPORTANT]
====
You must have cluster administrator permissions to create `SharedSecret` objects.
====
+
[source,terminal]
----
$ oc apply -f -<<EOF
apiVersion: sharedresource.openshift.io/v1alpha1
kind: SharedSecret
metadata:
  name: share-rhel-entitlement
spec:
  secretRef:
    name: etc-pki-entitlement
    namespace: openshift-config-managed
EOF
----

. Create a `ClusterRole` to grant permission to access the `SharedSecret` object and a `RoleBinding` object that grants permission to access the `SharedSecret` object by running the following command:
+
[source,terminal]
----
$ oc new-project buildah-entitlement
$ oc apply -f -<<EOF
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: use-shared-secret
rules:
  - apiGroups:
      - sharedresource.openshift.io
    resources:
      - sharedsecrets
    resourceNames:
      - share-entitlement-secret
    verbs:
      - use
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: use-shared-secret
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: use-shared-secret
subjects:
  - kind: ServiceAccount
    name: pipeline
EOF
----

. Create a build with relevant mount details using `buildah` buildStrategy:
+
[source,terminal]
----
$ oc apply -f -<<EOF
apiVersion: shipwright.io/v1beta1
kind: Build
metadata:
  name: buildah-rhel-entitlement-build
spec:
  source:
    type: Git
    git:
      url: <LOCATION_OF_OPERATOR_ORGANIZATION>
      revision: quick-tests
    contextDir: rh-builds
  strategy:
    name: buildah-csi
    kind: ClusterBuildStrategy
  paramValues:
  - name: dockerfile <1>
    value: Dockerfile
  volumes:
  - csi:
      driver: csi.sharedresource.openshift.io
      readOnly: true <2>
      volumeAttributes:
        sharedSecret: share-entitlement-secret <3>
    name: rhel-entitlement
  output:
    image: image-registry.openshift-image-registry.svc:5000/buildah-entitlement/sample-go-app
EOF
----

====
NOTE
The output image is saved to the internal registry. The location of the image will change based on the namespace the build runs in.
====

. Create the buildRun referencing the rhel-entitlement-build:
+
[source,terminal]
----
$ oc apply -f -<<EOF
apiVersion: shipwright.io/v1beta1
kind: BuildRun
metadata:
  name: buildah-rhel-entitlement-buildrun
spec:
  build:
    name: buildah-rhel-entitlement-build
EOF
----

[IMPORTANT]
====
* You must include the command to remove the `/etc/rhsm-host` directory and all its contents in the Dockerfile before executing any `yum` or `dnf` commands.
* Use the link:https://access.redhat.com/downloads/content/package-browser[Red Hat Package Browser] to find the correct repositories for your installed packages.
* You must restore the `/etc/rhsm-host` symbolic link to keep your image compatible with other Red Hat container images.
* You must set `readOnly` to `true` to mount the shared resource in the build.
* Reference the name of the `SharedSecret` object to include it in the build. 
====

[NOTE]
====
You can also use the `shp` CLI to trigger a build for `buildah-rhel-entitlement-build`:
[source,terminal]
----
$ shp build run buildah-rhel-entitlement-build
----
====