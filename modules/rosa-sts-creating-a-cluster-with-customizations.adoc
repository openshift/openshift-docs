// Module included in the following assemblies:
//
// * rosa_getting_started_sts/rosa_creating_a_cluster_with_sts/rosa-sts-creating-a-cluster-with-customizations.adoc

[id="rosa-sts-creating-cluster-manual-mode_{context}"]
= Creating a ROSA cluster with STS using manual mode

When you create an OpenShift cluster that uses the AWS Security Token Service (STS), you can use the `manual` mode with the `rosa create` command. With this mode, you can generate the `aws` CLI commands needed to create the required AWS Identity and Access Management (IAM) roles and policies, and an OpenID Connect (OIDC) provider. The corresponding role and policy JSON files are also output to the current directory. This enables you to review the details and make customizations before running the `aws` commands manually.

[IMPORTANT]
====
Only public and AWS PrivateLink clusters are supported with STS. Regular private clusters (non-PrivateLink) are not available for use with STS.
====

.Prerequisites

* You have completed the AWS prerequisites for ROSA with STS.
* You have available AWS service quotas.
* You have enabled the ROSA service in the AWS Console.
* You have installed and configured the latest AWS, ROSA, and `oc` CLIs on your installation host.

[NOTE]
====
link:https://docs.aws.amazon.com/vpc/latest/userguide/vpc-sharing.html[AWS Shared VPCs] are not currently supported for ROSA installations.
====

.Procedure

. Create the required account-wide roles and policies, including the Operator policies:
+
[IMPORTANT]
====
The account-wide roles and policies are specific to an OpenShift version, for example OpenShift 4.8. If you are using multiple cluster versions in one account, you can use `--prefix` to specify a version-specific prefix. With the prefix, you can easily identify the roles for each cluster version.

If you do not specify a prefix, the `ManagedOpenShift` prefix is implied. If you specify a different prefix, you must reference it when declaring the Amazon Resource Names (ARNs) when you create the cluster.
====
+
.. Generate the IAM role and policy JSON files in the current working directory and output the `aws` CLI commands for review:
+
[source,terminal]
----
$ rosa create account-roles --mode manual --version 4.8 <1><2>
----
<1> `manual` mode generates the `aws` CLI commands and JSON files needed to create the account-wide roles and policies, without running the `aws` commands.
<2> You must specify an OpenShift release by using the `--version` option. The version that is installed when a ROSA cluster is created is determined by the roles and policies that are used.
+
.. After applying your customizations, run the `aws` commands manually to create the roles and policies.

. Create a cluster by using the interactive prompts, by specifying custom settings, or by using the default options. To view other options when creating a cluster, enter `rosa create cluster --help`.
+
[NOTE]
====
Multiple availability zones (Multi-AZ) are recommended for production workloads. The default is a single availability zone. Use `--help` for an example of how to set this option manually or use interactive mode to be prompted for this setting.
====
+
* To create a cluster with STS using the defaults:
+
[source,terminal]
----
$ rosa create cluster --cluster-name <cluster_name> --sts <1>
----
<1> Replace `<cluster_name>` with the name of your cluster.
+
.Example output
[source,terminal]
----
I: Using arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Installer-Role for the Installer role
I: Using arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-ControlPlane-Role for the ControlPlane role
I: Using arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Worker-Role for the Worker role
I: Using arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Support-Role for the Support role
I: Creating cluster '<cluster_name>'
I: To view a list of clusters and their status, run 'rosa list clusters'
I: Cluster '<cluster_name>' has been created.
I: Once the cluster is installed you will need to add an Identity Provider before you can login into the cluster. See 'rosa create idp --help' for more information.
I: To determine when your cluster is Ready, run 'rosa describe cluster -c <cluster_name>'.
I: To watch your cluster installation logs, run 'rosa logs install -c <cluster_name> --watch'.
...
----
+
[NOTE]
====
If more than one matching set of account-wide roles are available in your account for a cluster version, an interactive list of options is provided.
====
+
* To create a cluster with STS using interactive prompts:
+
[source,terminal]
----
$ rosa create cluster --interactive
----
+
.Example output
[source,terminal]
----
I: Interactive mode enabled.
Any optional fields can be left empty and a default will be selected.
? Cluster name: <cluster_name>
? Deploy cluster using AWS STS: Yes
? OpenShift version: 4.8.9
I: Using arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Installer-Role for the Installer role
I: Using arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-ControlPlane-Role for the ControlPlane role
I: Using arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Worker-Role for the Worker role
I: Using arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Support-Role for the Support role
? External ID (optional): 
? Operator roles prefix: <cluster_name>-z9y3
? Multiple availability zones (optional): No
? AWS region: us-east-1
? PrivateLink cluster (optional): No
? Install into an existing VPC (optional): No
? Enable Customer Managed key (optional): No
? Compute nodes instance type (optional): 
? Enable autoscaling (optional): No
? Compute nodes: 2
? Machine CIDR: 10.0.0.0/16
? Service CIDR: 172.30.0.0/16
? Pod CIDR: 10.128.0.0/14
? Host prefix: 23
I: Creating cluster '<cluster_name>'
I: To create this cluster again in the future, you can run:
   rosa create cluster --cluster-name <cluster_name> --role-arn arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Installer-Role --support-role-arn arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Support-Role --master-iam-role arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-ControlPlane-Role --worker-iam-role arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Worker-Role --operator-roles-prefix <cluster_name>-z9y3 --region us-east-1 --version 4.8.9 --compute-nodes 2 --machine-cidr 10.0.0.0/16 --service-cidr 172.30.0.0/16 --pod-cidr 10.128.0.0/14 --host-prefix 23
I: To view a list of clusters and their status, run 'rosa list clusters'
I: Cluster '<cluster_name>' has been created.
I: Once the cluster is installed you will need to add an Identity Provider before you can login into the cluster. See 'rosa create idp --help' for more information.
I: To determine when your cluster is Ready, run 'rosa describe cluster -c <cluster_name>'.
I: To watch your cluster installation logs, run 'rosa logs install -c <cluster_name> --watch'.
----
+
* To create a cluster with STS by specifying the installation options from the CLI:
+
[source,terminal]
----
$ rosa create cluster \
  --cluster-name <cluster_name> \ <1>
  --region <aws_region> \ <2>
  --version <openshift_version> \ <3>
  --role-arn arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Installer-Role \ <4><5>
  --support-role-arn arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Support-Role \
  --master-iam-role arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-ControlPlane-Role \
  --worker-iam-role arn:aws:iam::<aws_account_id>:role/ManagedOpenShift-Worker-Role \
  --operator-roles-prefix ManagedOpenShift <6>
----
<1> Replace `<cluster_name>` with the name of your cluster.
<2> Replace `<aws_region>` with the name of the AWS region, for example `us-east-1`.
<3> Replace `<openshift_version>` with the OpenShift version, for example `4.8.9`.
<4> Replace `<aws_account_id>` with your AWS account ID.
<5> If you specified a custom prefix in the preceding command, you must replace the `ManagedOpenShift` prefix with the custom one in each ARN declaration. You must specify ARNs for STS account-wide roles that are created using `rosa create account-roles`.
<6> Declares the prefix for the cluster-specific Operator roles that are defined in the following step.
+
.Example output
[source,terminal]
----
I: Creating cluster '<cluster_name>'
I: To view a list of clusters and their status, run 'rosa list clusters'
I: Cluster '<cluster_name>' has been created.
I: Once the cluster is installed you will need to add an Identity Provider before you can login into the cluster. See 'rosa create idp --help' for more information.
I: To determine when your cluster is Ready, run 'rosa describe cluster -c <cluster_name>'.
I: To watch your cluster installation logs, run 'rosa logs install -c <cluster_name> --watch'.
----
+
[NOTE]
====
You can configure the following default network IP ranges:

* Machine CIDR: 10.0.0.0/16
* Service CIDR: 172.30.0.0/16
* Pod CIDR: 10.128.0.0/14

For the CIDR-related `rosa` CLI arguments, see `rosa create cluster --help | grep cidr`. In the interactive mode, you are prompted for the settings.
====
+
[NOTE]
====
The cluster state is `Pending` until the following steps are complete.
====

. Create the cluster-specific Operator IAM roles:
.. Generate the Operator IAM role and policy JSON files in the current working directory and output the `aws` CLI commands for review:
+
[source,terminal]
----
$ rosa create operator-roles --mode manual --cluster <cluster_name|cluster_id> <1><2>
----
<1> `manual` mode generates the `aws` CLI commands and JSON files needed to create the Operator roles, without running the `aws` commands.
<2> Replace `<cluster_name|cluster_id>` with the cluster name or the ID of the cluster.
+
.. After applying your customizations, run the `aws` commands manually to create the Operator IAM roles and attach the managed Operator policies to them.

. Create the OpenID Connect (OIDC) provider that the cluster Operators will use to authenticate:
.. Generate the `aws` CLI command for review:
+
[source,terminal]
----
$ rosa create oidc-provider --mode manual --cluster <cluster_name|cluster_id> <1>
----
<1> `manual` mode generates the `aws` CLI command needed to create the OIDC provider, without running the command.
+
.. After applying your customizations, run the `aws` command manually to create the provider.

. Check the status of your cluster and retrieve your cluster ID. The `State` field changes from `pending` to `installing` to `ready`:
+
[source,terminal]
----
$ rosa describe cluster --cluster=<cluster_name|cluster_id>
----
+
.Example output
[source,terminal]
----
Name:                       <cluster_name>
ID:                         <cluster_id>
External ID:                <external_id>
OpenShift Version:          <version>
Channel Group:              stable
DNS:                        *.openshiftapps.com
AWS Account:                123456789012
API URL:                    https://api.<cluster_name>.openshiftapps.com:6443
Console URL:                https://console-openshift-console.apps.<cluster_name>.openshiftapps.com
Region:                     <region>
Multi-AZ:                   false
Nodes:
 - Master:                  3
 - Infra:                   2
 - Compute:                 2
Network:
 - Service CIDR:            172.30.0.0/16
 - Machine CIDR:            10.0.0.0/16
 - Pod CIDR:                10.128.0.0/14
 - Host Prefix:             /23
State:                      pending (Waiting for OIDC configuration)
Private:                    No
Created:                    Jun 10 2021 15:47:56 UTC
Details Page:               https://cloud.redhat.com/openshift/details/s/<subscription_id>
OIDC Endpoint URL:          https://rh-oidc.s3.us-east-1.amazonaws.com/<cluster_id>
----
+
[NOTE]
====
If installation fails or the `State` field does not change to `ready` after 40 minutes, check the installation troubleshooting documentation for more details.
====

. Track the progress of the cluster creation by watching the OpenShift installer logs:
+
[source,terminal]
----
$ rosa logs install --cluster=<cluster_name|cluster_id> --watch <1>
----
<1> Specify the `--watch` flag to watch for new log messages as the installation progresses. This argument is optional.
