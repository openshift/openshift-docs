// Module included in the following assemblies:
//
// *deployment/deployment.adoc

:_mod-docs-content-type: PROCEDURE
[id="proc-configure-onprem-dns_{context}"]
= Configure on-premise DNS with CoreDNS (Technology Preview)

//TODO break into concept and procedure modules
:FeatureName: CoreDNS
//include::snippets/technology-preview.adoc[leveloffset=+1]
//snippet not working TODO
[IMPORTANT]
====
[subs="attributes+"]
{FeatureName} is a Technology Preview feature only. Technology Preview features are not supported with Red{nbsp}Hat production service level agreements (SLAs) and might not be functionally complete. Red Hat does not recommend using them in production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.

For more information about the support scope of Red Hat Technology Preview features, see link:https://access.redhat.com/support/offerings/techpreview/[Technology Preview Features Support Scope].
====
:!FeatureName:

[role="_abstract"]
{product-title} uses a `DNSPolicy` to manage DNS records based on Gateway API resources. For on-premise DNS servers such as CoreDNS, direct integration might require custom controllers or elevated permissions, which can be complex and pose security risks.

To address this challenge, {prodname} supports DNS delegation. Instead of directly managing records on the authoritative on-premise DNS server, you configure that server to delegate a specific subdomain (for example, `kuadrant.example.local`) to CoreDNS instances managed by {prodname}.

The `DNSPolicy` can then interact with the CoreDNS provider within the {ocp} cluster. This CoreDNS instance becomes authoritative for the delegated subdomain and manages the necessary DNS records (A, CNAME, and so on) for gateways within that subdomain.

The `delegate` field within the `DNSPolicy` configuration specifies which DNS provider (in this case, CoreDNS) handles the records for the targeted gateways.

This guide describes how to set up CoreDNS as a DNS provider for {prodname} in a multi-cluster, on-premise environment. This integration allows {prodname} to manage DNS entries within your internal network infrastructure.

.Prerequisites

* {product-title} is installed on two separate {ocp} clusters (primary and secondary).
* The `kubectl` or oc command-line interface is installed and configured for access to both clusters.
* You have administrator privileges on both {ocp}clusters.
* Your {ocp} clusters have support for the `loadbalanced` service type that allows UDP traffic on port 53, such as MetalLB. For more information, see link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.20/html/ingress_and_load_balancing/load-balancing-with-metallb[Load balancing with MetalLB].
* You have access to configure your authoritative on-premise DNS server to delegate a subdomain.
* Kustomize is installed.

.Procedure

. Set up the primary cluster. Set the following environment variables for your primary cluster context:
+
[source,bash]
----
$ export CTX_PRIMARY=<primary_cluster_context_name> # e.g., kind-primary \
  export KUBECONFIG=~/.kube/config # Adjust path if necessary \
  export PRIMARY_CLUSTER_NAME=<primary_cluster_name> # e.g., primary \
  export ONPREM_DOMAIN=<your_onprem_domain> # e.g., example.local \
  export KUADRANT_SUBDOMAIN=kuadrant # Subdomain to delegate
----

. Install CoreDNS using the {prodname} kustomization, which includes the required `kuadrant` plugin. Apply the following configuration to the primary cluster, replacing <kuadrant_coredns_kustomize_url> with the actual URL for the Kuadrant CoreDNS kustomization.
+
[source,bash]
----
$ kustomize build --enable-helm github.com/kuadrant/dns-operator/config/coredns?ref=v0.15.0 | kubectl apply --context ${CTX_PRIMARY} -f -
----
+
[NOTE]
====
The default CoreDNS Helm chart does not include the `kuadrant` plugin. You must use the {prodname}-provided kustomization which bundles a customized CoreDNS build.
====

. Wait for the CoreDNS service to get an external IP address and store it:
+
[source,bash]
----
$ export COREDNS_IP_PRIMARY=$(kubectl --context $CTX_PRIMARY -n kuadrant-system get service <coredns-service-name> -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
echo "CoreDNS Primary IP: ${COREDNS_IP_PRIMARY}"
----
+
You need this IP address later to configure delegation on your authoritative on-premises DNS server.

. Create a `ConfigMap` to define the authoritative zone for CoreDNS on the primary cluster. This minimal configuration enables the `kuadrant` plugin and GeoIP features.
+
[source,yaml]
----
cat | kubectl --context $CTX_PRIMARY apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-kuadrant-config
  namespace: kuadrant-system
data:
  Corefile: |
    ${KUADRANT_SUBDOMAIN}.${ONPREM_DOMAIN}:53 {
        debug
        errors
        health {
            lameduck 5s
        }
        ready
        log
        geoip GeoLite2-City-demo.mmdb {
            edns-subnet
        }
        metadata
        kuadrant
    }
----
+
[NOTE]
====
The `geoip` plugin in this example uses the `GeoLite2-City-demo.mmdb` database included for demonstration purposes. For production or accurate GeoIP routing, mount your licensed MaxMind GeoIP database into the CoreDNS pod and update the filename in the `Corefile`.
====

. Update the CoreDNS deployment to use the new configuration:
+
[source,bash]
----
$ kubectl --context $CTX_PRIMARY -n kuadrant-system patch deployment <coredns-deployment-name> --patch '{"spec":{"template":{"spec":{"volumes":[{"name":"config-volume","configMap":{"name":"coredns-kuadrant-config","items":[{"key":"Corefile","path":"Corefile"}]}}]}}}}'
----

. Wait for the deployment rollout to complete:
+
[source,bash]
----
$ kubectl --context $CTX_PRIMARY -n kuadrant-system rollout status deployment/<coredns-deployment-name>
----

. Create the Kubernetes `Secret` that {prodname} uses to interact with CoreDNS. This secret specifies the zones this provider instance is authoritative for.
+
[source,bash]
----
$ kubectl create secret generic coredns-credentials \
  --namespace=kuadrant-system \
  --type=kuadrant.io/coredns \
  --from-literal=ZONES="${KUADRANT_SUBDOMAIN}.${ONPREM_DOMAIN}" \
  --context ${CTX_PRIMARY}
----

. On your authoritative on-premises DNS server, configure delegation for the `${KUADRANT_SUBDOMAIN}.${ONPREM_DOMAIN}` subdomain to the external IP addresses of the CoreDNS services running on your primary and secondary clusters (`$COREDNS_IP_PRIMARY` and `$COREDNS_IP_SECONDARY`). The specific steps depend on your DNS server software (for example, BIND, Windows DNS Server). You typically need to add NS (Name Server) records pointing the subdomain to the CoreDNS IP addresses. For example:
+
[source]
----
; Delegate kuadrant.example.local to CoreDNS instances
$ORIGIN ${KUADRANT_SUBDOMAIN}.${ONPREM_DOMAIN}.
@       IN      SOA     ns1.${ONPREM_DOMAIN}. hostmaster.${ONPREM_DOMAIN}. (
                        2023102601 ; serial
                        7200       ; refresh (2 hours)
                        3600       ; retry (1 hour)
                        1209600    ; expire (2 weeks)
                        3600       ; minimum (1 hour)
                        )
        IN      NS      coredns-primary.${KUADRANT_SUBDOMAIN}.${ONPREM_DOMAIN}.

coredns-primary   IN A ${COREDNS_IP_PRIMARY}
----

.Verification

After configuring delegation, you can test that DNS resolution for the delegated subdomain works correctly by querying your authoritative DNS server for a record within the `kuadrant` subdomain. The query should be referred to, and answered by, one of the CoreDNS instances.

.Next steps

Create `DNSPolicy` resources in your {ocp} clusters, referencing the `coredns-credentials` secret as the provider. {prodname} manages DNS records within the delegated `${KUADRANT_SUBDOMAIN}.${ONPREM_DOMAIN}` zone through the CoreDNS instances.
