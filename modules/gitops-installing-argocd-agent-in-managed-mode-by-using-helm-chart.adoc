// Module included in the following assembly:
//
// * argocd-agent-installation/gitops-installing-argocd-agent-in-managed-mode-by-using-helm-chart.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-installing-argocd-agent-in-managed-mode-by-using-helm-chart_{context}"]
= Installing the Argo CD Agent in managed mode by using a Helm chart

[role="_abstract"]
Use the Helm chart provided by the Argo CD Agent project to install the managed mode Agent component on the workload cluster. In *managed* mode, the Agent must communicate with the spoke Redis server. However, the default network policy created by the {gitops-title} Operator does not allow this communication.

.Procedure

. To enable communication, you must create a custom network policy by using the following YAML configuration.
+
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: custom-agent-redis-network-policy
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: <ArgoCD Instance Name>-redis
  ingress:
    - ports:
        - protocol: TCP
          port: 6379
      from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: argocd-agent-agent
  policyTypes:
    - Ingress
----
+
where:

`<podSelector>`:: Selects the pods this policy applies to, for example, the Redis pod labeled `app.kubernetes.io/name: <ArgoCD Instance Name>-redis`.
`<ingress>`:: Defines the allowed inbound traffic rules for the selected pods.
`<policyTypes>`:: Indicates that this policy is an Ingress policy, meaning it only checks incoming connections.

.. Apply the network policy by using the following command:
+
[source,terminal]
----
$ oc apply -f network-policy.yaml -n "<agent_namespace>" --context "<agent_context>"
----
+
where:

`agent_namespace`:: Specifies the namespace where the network policy is created.
`agent_context`:: Ensures that the command runs against the Agent cluster and not on the hub cluster.

. Add the {OCP} Helm chart repository by running the following command:
+
[source,terminal]
----
$ helm repo add openshift-helm-charts https://charts.openshift.io/
----

. Install the managed Agent using Helm by using the following command:
+
[source,terminal]
----
$ helm install redhat-argocd-agent openshift-helm-charts/redhat-argocd-agent \
--version <chart_version> \
--set namespaceOverride=<agent_namespace> \
--set agentMode="managed" \
--set server="<principal_route_dns>" \
--set argoCdRedisSecretName="<argocd_name>-redis-initial-password" \
--set argoCdRedisPasswordKey="admin.password" \
--set redisAddress="<argocd_name>-redis:6379" \
--kube-context "<agent_context>"
----
+
where:

`namespaceOverride`:: Overrides the default namespace in which the Agent is installed. Set this to the namespace created for the Agent on the managed (spoke) cluster. Ensure the namespace exists before installation unless using the Helm namespace creation flags.
`agentMode`:: Defines how the Agent operates.
* `managed`: The Principal manages the Agent configuration and lifecycle.
* `autonomous`: The Agent functions independently of the Principal.
`server`:: Specifies the hostname of the Principal service. Agents use this value to connect to the Principal's gRPC service.  
This should match either:  
* The `.spec.host` value of the Principal route (when using OpenShift Routes), or  
* The `.status.loadBalancer.ingress.hostname` of the Principal service (when using a LoadBalancer service type).  
This value must be reachable _from the Agent cluster_, and DNS resolution must work across clusters.
`argoCdRedisSecretName`:: The name of the Kubernetes Secret in the Agent namespace that contains the Redis password for the Argo CD instance running on the Agent cluster. This must match the secret created by the Argo CD installation.
`argoCdRedisPasswordKey`:: The key within the Secret specified in `argoCdRedisSecretName` that stores the Redis password. This is usually `admin.password` for {gitops-title} deployments.
`redisAddress`:: The host and port of the Redis instance associated with the Agent's Argo CD installation. Typically formatted as `<argocd_name>-redis:6379`. Ensure the Redis Service name and port match the installed Argo CD instance.
`kube-context`:: The kubeconfig context of the **Agent (managed)** cluster. The Helm install runs against this context, so it must point to the correct remote cluster configured for the Agent.
