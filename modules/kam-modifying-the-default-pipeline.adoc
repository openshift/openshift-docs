// Module included in the following assemblies:
//
// * cli_reference/kam_cli/getting-started-with-kam.adoc

[id=modifying-the-default-pipeline_{context}"]
= Modifying the default pipeline

.Procedure

. Configure a webhook configured for the GitOps repo:
+
[source, terminal]
----
$ kam webhook create \
    --git-host-access-token <github user access token> \
    --cicd
----
    
. Change the CI definition for your application code in `config/cicd/base/05-pipelines/app-ci-pipeline.yaml`.

.Modified pipelines configuration
[source,yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
spec:
  resources:
  - name: source-repo
    type: git
  tasks:
  - name: build-image
      inputs:
      - name: source
        resource: source-repo
    taskRef:
      kind: ClusterTask
      name: buildah
----
+
, it has a single task build-image, which executes the buildah task, which builds the source and generates an image and pushes it to your image-repo.
  
. Add dditional tasks for running the tests for your application code. The tests are defined in `config/cicd/base/04-tasks/go-test-task.yaml`
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: go-test
  namespace: default
spec:
  resources:
    inputs:
      - name: source
        type: git
  steps:
    - name: go-test
      image: golang:latest
      command: ["go", "test", "./..."]

      Append the newly added task to the existing kustomize file

          config/cicd/base/kustomization.yaml

      Update the pipeline in this file:

          config/cicd/base/05-pipelines/app-ci-pipeline.yaml
          apiVersion: tekton.dev/v1beta1
          kind: Pipeline
          metadata:
            creationTimestamp: null
            name: app-ci-pipeline
            namespace: cicd
          spec:
            params:
            - name: REPO
              type: string
            - name: COMMIT_SHA
              type: string
            resources:
            - name: source-repo
              type: git
            - name: runtime-image
              type: image
            tasks:
            - name: go-ci
              resources:
                inputs:
                - name: source
                  resource: source-repo
              taskRef:
                kind: Task
                name: go-test
            - name: build-image
              runAfter:
                - go-ci
              params:
              - name: TLSVERIFY
                value: "true"
              resources:
                inputs:
                - name: source
                  resource: source-repo
                outputs:
                - name: image
                  resource: runtime-image
              taskRef:
                kind: ClusterTask
                name: buildah

validates that the YAML can be applied, by executing oc apply -k --dry-run.

. Commit and push this code, and open a Pull Request, you should see a PipelineRun being executed.
