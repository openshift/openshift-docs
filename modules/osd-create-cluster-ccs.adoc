// Module included in the following assemblies:
//
// * osd_getting_started/osd-getting-started.adoc
// * osd_cluster_create/creating-an-aws-cluster.adoc
// * osd_cluster_create/creating-a-gcp-cluster.adoc

ifeval::["{context}" == "osd-creating-a-cluster-on-aws"]
:osd-on-aws:
endif::[]
ifeval::["{context}" == "osd-creating-a-cluster-on-gcp"]
:osd-on-gcp:
endif::[]

:_content-type: PROCEDURE
ifdef::osd-on-aws[]
[id="osd-create-aws-cluster-ccs_{context}"]
= Creating a cluster on AWS with CCS
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
[id="osd-create-gcp-cluster-ccs_{context}"]
= Creating a cluster on GCP with CCS
endif::osd-on-gcp[]

By using the Customer Cloud Subscription (CCS) billing model, you can create an {product-title} cluster in an existing
ifdef::osd-on-aws[]
{AWS}
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
{GCP}
endif::osd-on-gcp[]
account that you own.

You must meet several prerequisites if you use the CCS model to deploy and manage {product-title} into your
ifdef::osd-on-aws[]
AWS
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
GCP
endif::osd-on-gcp[]
account.

.Prerequisites

ifdef::osd-on-aws[]
* You have configured your AWS account for use with {product-title}.
* You have not deployed any services in your AWS account.
* You have configured the AWS account quotas and limits that are required to support the desired cluster size.
* You have an `osdCcsAdmin` AWS Identity and Access Management (IAM) user with the `AdministratorAccess` policy attached.
* You have set up a service control policy (SCP) in your AWS organization. For more information, see _Minimum required service control policy (SCP)_.
* Consider having *Business Support* or higher from AWS.
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
* You have configured your GCP account for use with {product-title}.
* You have configured the GCP account quotas and limits that are required to support the desired cluster size.
* You have created a GCP project.
+
[NOTE]
====
The project name must be 10 characters or less.
====
* You have enabled the Google Cloud Resource Manager API in your GCP project. For more information about enabling APIs for your project, see link:https://cloud.google.com/endpoints/docs/openapi/enable-api[the Google Cloud documentation].
* You have an IAM service account in GCP called `osd-ccs-admin` with the following roles attached:
  ** DNS Administrator
  ** Organization Policy Viewer
  ** Owner
  ** Project IAM Admin
  ** Service Management Administrator
  ** Service Usage Admin
  ** Storage Admin
* You have created a key for your `osd-ccs-admin` GCP service account and exported it to a file named `osServiceAccount.json`.
+
[NOTE]
====
For more information about creating a key for your GCP service account and exporting it to a JSON file,  see link:https://cloud.google.com/iam/docs/creating-managing-service-account-keys#creating_service_account_keys[Creating service account keys] in the Google Cloud documentation.
====
* Consider having *Production Support* or higher from GCP.
* To prevent potential conflicts, consider having no other resources provisioned in the project prior to installing {product-title}.
endif::osd-on-gcp[]

.Procedure

. Log in to {cluster-manager-url} and click *Create cluster*.

. In the *Cloud* tab, click *Create cluster* in the *Red Hat OpenShift Dedicated* row.

. Under *Billing model*, configure the subscription type and infrastructure type:
.. Select a subscription type. For information about {product-title} subscription options, see link:https://access.redhat.com/documentation/en-us/openshift_cluster_manager/2022/html-single/managing_clusters/index#subscribing-osd-cluster_assembly-cluster-subscriptions[Managing OpenShift Dedicated cluster subscriptions] in the {cluster-manager} documentation.
+
[NOTE]
====
The subscription types that are available to you depend on your {product-title} subscriptions and resource quotas. For more information, contact your sales representative or Red Hat support.
====
+
.. Select the *Customer Cloud Subscription* infrastructure type to deploy {product-title} in an existing cloud provider account that you own.
.. Click *Next*.

ifdef::osd-on-aws[]
. Select *Run on Amazon Web Services*.
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
. Select *Run on Google Cloud Platform*.
endif::osd-on-gcp[]

. Click *Prerequisites* to review the prerequisites for installing {product-title} on
ifdef::osd-on-aws[]
AWS
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
GCP
endif::osd-on-gcp[]
with CCS.

ifdef::osd-on-aws[]
. Provide your AWS account details:
.. Enter your *AWS account ID*.
.. Enter your *AWS access key ID* and *AWS secret access key* for your AWS IAM user account.
+
[NOTE]
====
Revoking these credentials in AWS results in a loss of access to any cluster created with these credentials.
====
.. Optional: You can select *Bypass AWS service control policy (SCP) checks* to disable the SCP checks.
+
[NOTE]
====
Some AWS SCPs can cause the installation to fail, even if you have the required permissions. Disabling the SCP checks allows an installation to proceed. The SCP is still enforced even if the checks are bypassed.
====
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
. Provide your GCP service account private key in JSON format. You can either click *Browse* to locate and attach a JSON file or add the details in the *Service account JSON* field.
endif::osd-on-gcp[]

. *Validate* your cloud provider account and then click *Next*.

. On the *Cluster details* page, provide a name for your cluster and specify the cluster details:
.. Add a *Cluster name*.
.. Select a cluster version from the *Version* drop-down menu.
.. Select a cloud provider region from the *Region* drop-down menu.
.. Select a *Single zone* or *Multi-zone* configuration.
.. Leave *Enable user workload monitoring* selected to monitor your own projects in isolation from Red Hat Site Reliability Engineer (SRE) platform metrics. This option is enabled by default.
.. Optional: Select *Enable additional etcd encryption* if you require etcd key value encryption. With this option, the etcd key values are encrypted, but not the keys. This option is in addition to the control plane storage encryption that encrypts the etcd volumes in {product-title} clusters by default.
+
[NOTE]
====
By enabling etcd encryption for the key values in etcd, you will incur a performance overhead of approximately 20%. The overhead is a result of introducing this second layer of encryption, in addition to the default control plane storage encryption that encrypts the etcd volumes. Consider enabling etcd encryption only if you specifically require it for your use case.
====
.. Optional: Select *Encrypt persistent volumes with customer keys* if you want to provide your own
ifdef::osd-on-aws[]
AWS Key Management Service (KMS) key Amazon Resource Name (ARN).
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
encryption keys through the Google Cloud Key Management Service.
endif::osd-on-gcp[]
These keys are used for encrypting all control plane, infrastructure, and worker node root volumes.

.. Click *Next*.

. On the *Default machine pool* page, select a *Compute node instance type* and a *Compute node count*. The number and types of nodes that are available depend on your {product-title} subscription. If you are using multiple availability zones, the compute node count is per zone.
+
[NOTE]
====
After your cluster is created, you can change the number of compute nodes in your cluster, but you cannot change the compute node instance type in a machine pool. The number and types of nodes available to you depend on your {product-title} subscription.
====

. Optional: Expand *Edit node labels* to add labels to your nodes. Click *Add label* to add more node labels and select *Next*.

. In the *Cluster privacy* section, select *Public* or *Private* to use either public or private API endpoints and application routes for your cluster.
+
[IMPORTANT]
====
If you are using private API endpoints, you cannot access your cluster until you update the network settings in your cloud provider account.
====

ifdef::osd-on-aws[]
. Optional: To install the cluster in an existing AWS Virtual Private Cloud (VPC):
.. Select *Install into an existing VPC*.
.. If you opted to use private API endpoints and are installing into an existing VPC, you can select *Use a PrivateLink* to enable connections to the cluster by Red Hat Site Reliability Engineering (SRE) using only AWS PrivateLink endpoints. This option cannot be changed after a cluster is created.
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
. Optional: Select *Install into an existing VPC* to install the cluster in an existing GCP Virtual Private Cloud (VPC).
endif::osd-on-gcp[]

. Click *Next*.

. If you opted to install the cluster in an existing
ifdef::osd-on-aws[]
AWS
endif::osd-on-aws[]
ifdef::osd-on-gcp[]
GCP
endif::osd-on-gcp[]
VPC, provide your *Virtual Private Cloud (VPC) subnet settings*.
ifdef::osd-on-aws[]
+
[NOTE]
====
You must ensure that your VPC is configured with a public and a private subnet for each availability zone that you want the cluster installed into. If you opted to use PrivateLink, only private subnets are required.
====
endif::osd-on-aws[]

. In the *CIDR ranges* dialog, configure custom classless inter-domain routing (CIDR) ranges or use the defaults that are provided.
+
[NOTE]
====
If you are installing into a VPC, the *Machine CIDR* range must match the VPC subnets.
====
+
[IMPORTANT]
====
CIDR configurations cannot be changed later. Confirm your selections with your network administrator before proceeding.
====

. On the *Cluster update strategy* page, configure your update preferences:
.. Choose a cluster update method:
** Select *Individual updates* if you want to schedule each update individually. This is the default option.
** Select *Recurring updates* to update your cluster on your preferred day and start time, when updates are available.
+
[NOTE]
====
You can review the end-of-life dates in the update life cycle documentation for {product-title}. For more information, see _{product-title} update life cycle_.
====
+
.. Provide administrator approval based on your cluster update method:
** Individual updates: If you select an update version that requires approval, provide an administrator’s acknowledgment and click *Approve and continue*.
** Recurring updates: If you selected recurring updates for your cluster, provide an administrator’s acknowledgment and click *Approve and continue*. {cluster-manager} does not start scheduled y-stream updates for minor versions without receiving an administrator’s acknowledgment.
+
For information about administrator acknowledgment, see xref:./../upgrading/osd-upgrading-cluster-prepare.adoc#upgrade-49-acknowledgement_osd-updating-cluster-prepare[Administrator acknowledgment when upgrading to OpenShift 4.9].
.. If you opted for recurring updates, select a preferred day of the week and upgrade start time in UTC from the drop-down menus.
.. Optional: You can set a grace period for *Node draining* during cluster upgrades. A *1 hour* grace period is set by default.
.. Click *Next*.
+
[NOTE]
====
In the event of critical security concerns that significantly impact the security or stability of a cluster, Red Hat Site Reliability Engineering (SRE) might schedule automatic updates to the latest z-stream version that is not impacted. The updates are applied within 48 hours after customer notifications are provided. For a description of the critical impact security rating, see link:https://access.redhat.com/security/updates/classification[Understanding Red Hat security ratings].
====

. Review the summary of your selections and click *Create cluster* to start the cluster installation. The installation takes approximately 30-40 minutes to complete.

.Verification

* You can monitor the progress of the installation in the *Overview* page for your cluster. You can view the installation logs on the same page. Your cluster is ready when the *Status* in the *Details* section of the page is listed as *Ready*.

ifeval::["{context}" == "osd-creating-a-cluster-on-aws"]
:!osd-on-aws:
endif::[]
ifeval::["{context}" == "osd-creating-a-cluster-on-gcp"]
:!osd-on-gcp:
endif::[]
