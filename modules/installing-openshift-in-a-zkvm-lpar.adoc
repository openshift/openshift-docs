// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// This module can be included from assemblies using the following include statement:
// include::<path>/proc_insalling-openshift-in-a-zkvm-lpar.adoc[leveloffset=+1]

// The file name and the ID are based on the module title. For example:
// * file name: proc_doing-procedure-a.adoc
// * ID: [id='proc_doing-procedure-a_{context}']
// * Title: = Doing procedure A
//
// The ID is used as an anchor for linking to the module. Avoid changing
// it after the module has been published to ensure existing links are not
// broken.
//
// The `context` attribute enables module reuse. Every module's ID includes
// {context}, which ensures that the module has a unique ID even if it is
// reused multiple times in a guide.
//
// Start the title with a verb, such as Creating or Create. See also
// _Wording of headings_ in _The IBM Style Guide_.
[id="installing-openshift-in-a-zkvm-lpar_{context}"]
= Installing OpenShift in a zKVM LPAR

Now that we have created VMs for all of our nodes, we can begin installing OpenShift 4 itself. By the end of this section, we should have a working installation that we can use to develop and test.

[discrete]
== Prerequisites

* zKVM LPAR with RHEL 8 installed
** At least 300 GB of storage available at /home/libvirt
** At least 64 GB of RAM
* Hypervisor setup is complete. See Hypervisor Setup instructions above.
* You will need a pull secret to download the OpenShift containers from quay.io.
** This can be obtained by from by emailing mailto:jpoulin@redhat.com[jpoulin@redhat.com], mailto:dbenoit@redhat.com[dbenoit@redhat.com], mailto:dgilmore@redhat.com[dgilmore@redhat.com], and mailto:bdonahue@redhat.com[bdonahue@redhat.com].
* *Optional*: Install virt-manager and connect remotely to the hypervisor to access and monitor individual VMs via serial console


[discrete]
== Procedure

This section describes the instructions for installing OpenShift on the VMs we deployed above. Many of the following steps expect to be run in a terminal. The host it that terminal should be running on is in *bold*.

. SSH into the hypervisor from your *localhost*.
....
$ ssh root@hypervisor_fqdn_or_ip
....

Download openshift-upi-playbooks from partners-ftp to the *hypervisor*.
....
$ curl -O ftp://partners.redhat.com/1c5d859a/IBM-917ca288c24859a81f35b894e0b77589/Openshift-ibm/OCP_4.2.z_for_Z/68131/openshift-upi-playbooks-20191023-s390x.tar.gz
....

. On the hypervisor, un-tar the deployment playbooks.
....
$ tar -xf openshift-upi-playbooks-20191023-s390x.tar.gz; mv openshift-upi-playbooks-20191023-s390x openshift-upi-playbooks
....

. On the hypervisor, change your working directory to the deployment playbooks directory.
....
$ cd openshift-upi-playbooks
....

. *Optional*: update the “cluster_name” variable in group_vars/all.yml with desired OpenShift cluster name, as shown in step 5a below.

.. `group_vars/all.yml`

....
---
# Configure the internal domain name of the cluster here.
# The default 'redhat.com' address will work because
# the automation runs its own DNS, but it may be changed
# to something else (eg. ibm.com).
cluster_base_domain: "redhat.com"
cluster_domain_name: "{{ cluster_name }}.{{ cluster_base_domain }}"
cluster_name: desired_openshift_cluster_name
....

. Store the pull secret you’ve obtained from the multi-arch team in ~/.ocp4_pull_secret on the *hypervisor*

. On the hypervisor, ensure you have connected to the bastion in order to accept the host key. This will ensure Ansible will not hang during the host key check operation.
....
$ ssh root@192.168.79.1 true
....

. If you are running selinux, you will want to run the following on the hypervisor to allow traffic on port 6443.
....
$ semanage port -a -t http_port_t  -p tcp 6443
....

. Run the main installation playbook on the hypervisor.
....
$ ansible-playbook -i inventory playbooks/main.yml
....

. *Manual step required*: Monitor cluster installation you see that the output of the installation playbook matches step 9a below.
.. Playbook output
....
TASK [create-cluster : wait for bootstrap node accessibility]
*************************
....

.. On the *hypervisor* but in a _new terminal_ (see step 1), launch the environment pxe boot script to ensure that the nodes come back up once the Red Hat CoreOS bootstrapping begins.
....
$ cd /home/libvirt && bash pxe-boot-br-ocp.sh
....

. Monitor the playbook to ensure that the cluster installs successfully. Congratulations, you should now have a working OpenShift 4 cluster!

.. To start accessing the environment on your localhost, follow the instructions above.
