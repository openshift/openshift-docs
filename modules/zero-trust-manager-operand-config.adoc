// Module included in the following assemblies:
//
// * security/zero_trust_workload_identity_manageer/zero-trust-manager-configuration.adoc

:_mod-docs-content-type: PROCEDURE
[id="zero-trust-manager-operand-config_{context}"]
== Deploying the {zero-trust-full} operands

You can deploy SPIRE Server, SPIRE Agent, SPIFFE CSI driver, and SPIRE OIDC discovery provider by respectively creating `SpireServerConfig`, `SpireAgentConfig`, `SpiffeCSIDriverConfigSpec`,`SpireOIDCDiscoveryProviderConfig` Custom Resource (CR).

.Prerequisites

* You have installed {zero-trust-full} in the cluster.
* You are a cluster administrator.

.Procedure

. Create the `SpireServerConfig` custom resource (CR) object:

.. Create a YAML file that defines the `SpireServerConfig` CR object, for example, `SpireServerConfig.yaml`:
+
.Example `SpireServerConfig.yaml`
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1alpha1
kind: SpireServerConfig
metadata:
  name: cluster
spec:
  trustDomain: <trust_domain> #<1>
  clusterName: <cluster_name> #<2>
  caSubject:
    commonName: "example.org"
    country: "US"
    organization: "RH"
  persistence:
    type: pvc
    size: "5Gi"
    accessMode: ReadWriteOnce
  datastore:
    databaseType: sqlite3
    connectionString: "/run/spire/data/datastore.sqlite3"
    maxOpenConns: 100
    maxIdleConns: 2
    connMaxLifetime: 3600
----
<1> The base domain of your cluster.
<2> The name of your cluster.

.. Apply the configuration by running the following command:
+
[source, terminal]
----
$ oc apply -f SpireServerConfig.yaml
----

. Create the `SpireAgentConfig` custom resource (CR) object:

.. Create a YAML file that defines the `SpireAgentConfig` CR object, for example, `SpireAgentConfig.yaml`:
+
.Example `SpireAgentConfig.yaml`
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1alpha1
kind: SpireAgentConfig
metadata:
  name: cluster
spec:
  trustDomain: <trust_domain> #<1>
  clusterName: <cluster_name> #<2>
  nodeAttestor:
    k8sPSATEnabled: "true"
  workloadAttestors:
    k8sEnabled: "true"
    workloadAttestorsVerification:
      type: "auto"
----
<1> The base domain of your cluster.
<2> The name of your cluster.

.. Apply the configuration by running the following command:
+
[source, terminal]
----
$ oc apply -f SpireAgentConfig.yaml
----

. Create the `SpiffeCSIDriverConfigSpec` custom resource (CR) object:

.. Create a YAML file that defines the `SpiffeCSIDriverConfigSpec` CR object, for example, `SpiffeCSIDriverConfigSpec.yaml`:
+
.Example `SpiffeCSIDriverConfigSpec.yaml`
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1alpha1
kind: SpiffeCSIDriverConfig
metadata:
  name: cluster
spec: {}
----

.. Apply the configuration by running the following command:
+
[source, terminal]
----
$ oc apply -f SpiffeCSIDriverConfigSpec.yaml
----

. Create the `SpireOIDCDiscoveryProviderConfig` custom resource (CR) object:

.. Create a YAML file that defines the `SpireOIDCDiscoveryProviderConfig` CR object, for example, `SpireOIDCDiscoveryProviderConfig.yaml`:
+
.Example `SpireOIDCDiscoveryProviderConfig.yaml`
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1alpha1
kind: SpireOIDCDiscoveryProviderConfig
metadata:
  name: cluster
spec:
  trustDomain: <trust_domain> #<1>
----

<1> The base domain of your cluster.

.. Apply the configuration by running the following command:
+
[source, terminal]
----
$ oc apply -f SpireOIDCDiscoveryProviderConfig.yaml
----


.Verification

. Verify that the deployment of SPIRE server is ready and available by running the following command:
+
[source,terminal]
----
$ oc get statefulset -l app.kubernetes.io/name=server -n zero-trust-workload-identity-manager
----
+
.Example output
[source,terminal]
----
NAME            READY   AGE
spire-server    1/1     65s
----

. Verify that the SPIRE server pod is running by running the following command:
+
[source,terminal]
----
$ oc get po -l app.kubernetes.io/name=server -n zero-trust-workload-identity-manager
----
+
.Example output
[source,terminal]
----
NAME               READY   STATUS    RESTARTS        AGE
spire-server-0     2/2     Running   1 (108s ago)    111s
----

. Verify that the PersistentVolumeClaim is bound by running the following command:
+
[source,terminal]
----
$ oc get pvc -l app.kubernetes.io/name=server -n zero-trust-workload-identity-manager
----
+
.Example output
[source,terminal]
----
NAME                        STATUS    VOLUME                                     CAPACITY   ACCESS MODES  STORAGECLASS  VOLUMEATTRIBUTECLASS  AGE
spire-data-spire-server-0   Bound     pvc-27a36535-18a1-4fde-ab6d-e7ee7d3c2744   1G1        RW0           gp3-csi       <unset>               22m
----

. Verify that the daemonset of the SPIRE agent is ready and available by running the following command
+
[source,terminal]
----
$ oc get daemonset -l app.kubernetes.io/name=agent -n zero-trust-workload-identity-manager
----
+
.Example output
[source,terminal]
----
NAME            DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE  NODE SELECTOR  AGE
spire-server    3        3        3      3           3          <none>         10m
----

. Verify that the SPIRE agent pods are running by running the following command:
+
[source,terminal]
----
$ oc get po -l app.kubernetes.io/name=agent -n zero-trust-workload-identity-manager
----
+
.Example output
[source,terminal]
----
NAME                READY   STATUS    RESTARTS   AGE
spire-agent-dp4jb   1/1     Running   0          12m
spire-agent-nvwjm   1/1     Running   0          12m
spire-agent-vtvlk   1/1     Running   0          12m
----

* Verify that the SPIFFE Container Storage Interface (CSI) Driver pods are running by running the following command:
+
[source,terminal]
----
$ oc get po -l app.kubernetes.io/name=spiffe-csi-driver -n zero-trust-workload-identity-manager
----
+
.Example output
[source,terminal]
----
NAME                            READY   STATUS    RESTARTS   AGE
spire-spiffe-csi-driver-gpwcp   2/2     Running   0          2m37s
spire-spiffe-csi-driver-rrbrd   2/2     Running   0          2m37s
spire-spiffe-csi-driver-w6s6q   2/2     Running   0          2m37s
----

. Verify that the deployment of OIDC Discovery Provider is ready and available by running the following command:
+
[source,terminal]
----
$ oc get deployment -l app.kubernetes.io/name=spiffe-oidc-discovery-provider -n zero-trust-workload-identity-manager
----
+
.Example output
[source,terminal]
----
NAME                                    READY  UP-TO-DATE  AVAILABLE  AGE
spire-spiffe-oidc-discovery-provider    1/1    1           1          2m58s
----

. Verify that the OIDC Discovery Provider pods are running by running the following command:
+
[source,terminal]
----
$ oc get po -l app.kubernetes.io/name=spiffe-oidc-discovery-provider -n zero-trust-workload-identity-manager
----
+
.Example output
[source,terminal]
----
NAME                                                    READY   STATUS    RESTARTS   AGE
spire-spiffe-oidc-discovery-provider-64586d599f-lcc94   2/2     Running   0          7m15s
----
