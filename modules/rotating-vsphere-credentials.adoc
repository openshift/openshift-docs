:_content-type: PROCEDURE
[id="rotating_vsphere_credentials_{context}"]
= Rotating vSphere credentials
.Procedure

. base64 encode the updated credentials.
+
[source,terminal]
----
ENCODED_USERNAME=$(echo -n <updated-username> | base64 -w0)
ENCODED_PASSWORD=$(echo -n <updated-password> | base64 -w0)
----
+
. Get the current secret content in `vsphere-creds`.  The keys in the secret are used to build the credential update commands. 
+
[source,terminal]
----
$ oc get secret -n kube-system vsphere-creds -o=jsonpath='{.data}' 
{
  "your.vcenter.server.password": "...",
  "your.vcenter.server.username": "..."
}
----
+
. Update the `vsphere-creds` secret with the updated credentials.
+
[source,terminal]
----
oc patch secret -n kube-system vsphere-creds -p='{"data": {"your.vcenter.server.username": "'"$ENCODED_USERNAME"'"}}' --type=merge
oc patch secret -n kube-system vsphere-creds -p='{"data": {"your.vcenter.server.password": "'"$ENCODED_PASSWORD"'"}}' --type=merge
----

. Force a rollout of the `kube-controller-manager` to apply the updated credentials.
+
[NOTE]
====
If the xref:../storage/container_storage_interface/persistent-storage-csi-vsphere.adoc[vSphere CSI Driver Operator] is enabled, this step is not required.
====
+
[source,terminal]
----
oc patch kubecontrollermanager cluster -p='{"spec": {"forceRedeploymentReason": "recovery-'"$( date )"'"}}' --type=merge
----
+
The status of the `kube-controller-manager` operator will report `Progressing=true` while the credentials are rolling out. The status can be verified by running:
+
[source,terminal]
----
oc get co kube-controller-manager
----


.Verification

. Verify the content of the `vsphere-creds` secret matches the expected username and password.
+
[source,terminal]
----
oc get secret -n kube-system vsphere-creds -o=jsonpath='{.data.your\.vcenter\.server\.username}' | base64 -d
oc get secret -n kube-system vsphere-creds -o=jsonpath='{.data.your\.vcenter\.server\.password}' | base64 -d
----

+
[NOTE]
====
The `.` in the secret key must be escaped with `\` to preserve an accurate jsonpath syntax.
====
