// Module included in the following assemblies:
// * service-mesh-docs-main/gateways/ossm-getting-traffic-into-a-mesh.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-exposing-a-service-by-using-the-kubernetes-gateway-api-in-ambient-mode_{context}"]
= Exposing a service by using the {k8s} Gateway API in ambient mode

[role="_abstract"]
You can use the {k8s} Gateway API to create `Gateway` and `HTTPRoute` resources and deploy a gateway in ambient mode. The resources configure the gateway to expose a service in the mesh to traffic outside the mesh.

.Prerequisites

* You are logged in to the {ocp-product-title} web console as a user with the `cluster-admin` role.

* You have installed the {SMProductName} Operator.

* You have deployed the `{istio}` resource.

* You use the {k8s}-native Gateway API resources.

* You are either using the {istio} ambient mode or planning on migrating to the ambient mode.

[NOTE]
====
When using ambient mode (`istio.io/dataplane-mode=ambient`), it is recommended to use the {k8s} Gateway API for ingress configuration, as {istio} `Gateway` and `VirtualService` resources are not fully compatible with ambient mode.
====

.Procedure 

. Create a namespace called `httpbin` by running the following command:
+
[source,terminal]
----
$ oc create namespace httpbin 
----

. Apply the label for ambient mode by running the following command:
+
[source,terminal]
----
$ oc label namespace httpbin istio.io/dataplane-mode=ambient
----

. Deploy a sample service named `httpbin` by running the following command:
+
[source,terminal]
----
$ oc apply -n httpbin -f https://raw.githubusercontent.com/openshift-service-mesh/istio/refs/heads/master/samples/httpbin/httpbin.yaml
----

. Deploy a waypoint proxy by creating a YAML file named `httpbin-waypoint.yaml`, similar to the following example:
+
[source,yaml]
----
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: httpbin-waypoint
  namespace: httpbin
  labels:
    istio.io/waypoint-for: service
spec:
  gatewayClassName: istio-waypoint
  listeners:
  - name: mesh
    port: 15008
    protocol: HBONE

----

. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f httpbin-waypoint.yaml
----

. Enable ingress waypoint routing on the `httpbin` service by running the following command:
+
[source,terminal]
----
$ oc label service httpbin -n httpbin istio.io/ingress-use-waypoint=true
----
+
The label ensures that traffic from the ingress gateway routes through the waypoint proxy and the L7 policies configured on the waypoint proxy are applied to the ingress traffic, before it reaches the `httpbin` service.

. Apply the waypoint label to the namespace so that all the services inside the namespace routes through the waypoint, by running the following command:
+
[source,terminal]
----
$ oc label ns httpbin istio.io/use-waypoint=httpbin-waypoint
----

. Create a YAML file named `httpbin-gw.yaml` that defines a {k8s} Gateway resource. This resource configures gateway proxies to expose port 80 (HTTP) for the host, `httpbin.example.com`.
+
[source,yaml]
----
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: httpbin-gateway
  namespace: httpbin
spec:
  gatewayClassName: istio
  listeners:
  - name: default
    hostname: "httpbin.example.com"
    port: 80
    protocol: HTTP
    allowedRoutes:
      namespaces:
        from: All
----
`"httpbin.example.com"`:: Specifies the virtual hostname that clients use when attempting to access a mesh service on the associated port.

. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f httpbin-gw.yaml
----

. Create a YAML file named `httpbin-ingress-hr.yaml` that defines an `HTTPRoute` resource for the ingress gateway, similar to the following example:
+
[source,yaml]
----
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: httpbin-ingress
  namespace: httpbin
spec:
  parentRefs:
  - name: httpbin-gateway
    namespace: httpbin
  hostnames:
  - "httpbin.example.com"
  rules:
  - backendRefs:
    - name: httpbin
      port: 8000
----
* `spec.parentRefs` binds the `HTTPROUTE` resource to the {k8s} Gateway resource that was created in the earlier step.

* `spec.rules.backendRefs` routes the matching traffic to the `httpbin` service by defining a `backendRefs` that includes the name and port of the `httpbin` service.

+
The `HTTPRoute` resource specifies the rules that route traffic from the gateway proxy to the `httpbin` service.

. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f httpbin-ingress-hr.yaml
----

. Create a YAML file named `httpbin-waypoint-hr.yaml` that defines an `HTTPRoute` resource for the waypoint proxy.
+
[source,yaml]
----
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: httpbin-waypoint-route
  namespace: httpbin
spec:
  parentRefs:
  - group: ""
    kind: service
    name: httpbin
    namespace: httpbin
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /status
    - path:
        type: PathPrefix
        value: /headers
    backendRefs:
    - name: httpbin
      port: 8000

----
* `spec.parentRefs` binds the `HTTPRoute` resource to the `httpbin` service. When combined with the `istio.io/ingress-use-waypoint=true` label on the Service, the HTTPRoute configures the L7 routing rules that the waypoint proxy will enforce for traffic destined to that Service.

* `spec.rules.backendRefs` routes the matching traffic to the `httpbin` service by defining a `backendRefs` that includes the name and port of the `httpbin` service.

. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f httpbin-waypoint-hr.yaml
----

[NOTE]
====
In this example use case, traffic from the ingress gateway flows through the waypoint proxy because of the `istio.io/ingress-use-waypoint=true` label. The `HTTPRoute` resource then applies path-based routing policies before the traffic reaches the httpbin service.
====

. Ensure that the waypoint proxy is ready by running the following command:
+
[source,terminal]
----
$ oc wait --for=condition=programmed gtw httpbin-waypoint -n httpbin
----

.Verification

. Create a namespace for a `curl` client by running the following command:
+
[source,terminal]
----
$ oc create namespace curl
----

. Deploy a `curl` client by running the following command:
+
[source,terminal]
----
$ oc apply -n curl -f https://raw.githubusercontent.com/openshift-service-mesh/istio/refs/heads/master/samples/curl/curl.yaml
----

. Apply the label for ambient mode to the `curl` namespace by running the following command:
+
[source,terminal]
----
$ oc label namespace curl istio.io/dataplane-mode=ambient
----

. Set a `CURL_POD` variable with the name of the `curl` pod by running the following command:
+
[source,terminal]
----
$ CURL_POD=$(oc get pods -n curl -l app=curl -o jsonpath='{.items[*].metadata.name}')
----

. Using the `curl` client, send a request to the `/headers` endpoint of the `httpbin` application through the ingress gateway `Service` resource. Set the Host header of the request to `httpbin.example.com` to match the host that the {k8s} Gateway and `HTTPROUTE` resources specify. Send the `curl` request by running the following command:
+
[source,terminal]
----
$ oc exec $CURL_POD -n curl -- \
  curl -s -I \
    -H Host:httpbin.example.com \
    httpbin-gateway-istio.httpbin.svc.cluster.local/headers
----
+
The response should return a `200 OK` HTTP status, which indicates that the request was successful, similar to the following example:
+
[source,terminal]
----
HTTP/1.1 200 OK
server: istio-envoy
...
----

. Send a `curl` request to an endpoint that does not have a corresponding Uniform Resource Identifier (URI) prefix match defined in the `httpbin` `HTTPROUTE` by running the following command:
+
[source,terminal]
----
$ oc exec $CURL_POD -n curl -- \
  curl -s -I \
    -H Host:httpbin.example.com \
    httpbin-gateway-istio.httpbin.svc.cluster.local/get
----
+
The response returns a `404 Not Found` status, as expected, because the `/get` endpoint does not have a matching URI prefix in the `httpbin` `HTTPROUTE` resource, similar to the following example:
+
[source,terminal]
----
HTTP/1.1 404 Not Found
server: istio-envoy
...
----

. Expose the gateway proxy to traffic outside the cluster by setting the `Service` type to `LoadBalancer`. Run the following command:
+
[source,terminal]
----
$ oc patch service httpbin-gateway-istio -n httpbin -p '{"spec": {"type": "LoadBalancer"}}'
----
+
[NOTE]
====
A gateway can also be exposed to traffic outside the cluster by using {ocp-short-name} Routes. For more information, see "Exposing a gateway to traffic outside the cluster using {ocp-short-name} Routes".
====

. Verify that the `httpbin` service can be accessed from outside the cluster when using the external hostname or IP address of the gateway Service resource. Ensure that you set the `INGRESS_HOST` variable appropriately for the environment in which your cluster is running.

.. Set the `INGRESS_HOST` variable by running the following command:
+
[source,terminal]
----
$ export INGRESS_HOST=$(oc get gtw httpbin-gateway -n httpbin -o jsonpath='{.status.addresses[0].value}')
----

.. Set the `INGRESS_PORT` variable by running the following command:
+
[source,terminal]
----
$ INGRESS_PORT=$(oc get gtw httpbin-gateway -n httpbin -o jsonpath='{.spec.listeners[?(@.name=="http")].port}')
----

.. Using the gateway host, send a `curl` request to the `httpbin` service by running the following command:
+
[source,terminal]
----
$ curl -s -I -H Host:httpbin.example.com http://$INGRESS_HOST:$INGRESS_PORT/headers
----

. Verify that the response has the `HTTP/1.1 200 OK` status, which indicates that the request was successful.
