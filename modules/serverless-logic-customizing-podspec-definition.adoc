// Module included in the following assemblies:
//
// * serverless/serverless-logic/serverless-logic-configuring-workflow-services.adoc

:_mod-docs-content-type: CONCEPT
[id="serverless-logic-custom-podspec_{context}"]
= Custom podSpec definition

You can use a custom pod specification definition in the `SonataFlow` custom resource (CR) to meet specific container and deployment requirements on Red Hat OpenShift. This capability is intended for advanced configurations, such as defining resource limits, adding sidecar containers, configuring volumes, or selecting an alternative deployment model for workflows.

The OpenShift Serverless Logic Operator enables these customizations through the `.spec.podTemplate` attribute within the `SonataFlow` CR.

For example, to define CPU and memory limits for the workflow container:

[source,yaml,subs="+quotes"]
----
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlow
metadata:
  name: <name>
spec:
  podTemplate:
    container:
      resources:
        limits:
          cpu: "250m"
          memory: "128Mi"
    # ...
----

The `.spec.podTemplate` attribute supports most fields defined in the standard link:https://kubernetes.io/docs/reference/generated/kubernetes-api/latest/#podspec-v1-core[Kubernetes PodSpec API], and Kubernetes API validation rules apply.

[NOTE]
====
The `.spec.podTemplate.container` attribute is a specialized field used to modify the primary container where the workflow application is deployed. This helps prevent accidental misconfiguration of the workflow container when adding or modifying other containers in the pod.
====

== Deployment model

By default, the OpenShift Serverless Logic Operator deploys each `SonataFlow` instance as a standard Kubernetes `Deployment` object. You can change this behavior by setting the `.spec.podTemplate.deploymentModel` attribute to `knative`, which deploys the workflow as a Knative Serving Service.

For example:

[source,yaml,subs="+quotes"]
----
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlow
metadata:
  name: <name>
spec:
  podTemplate:
    deploymentModel: knative
    # ...
----

[IMPORTANT]
====
* Do not use the Knative deployment model with the *dev* profile. If you specify this option, the Operator ignores it.
* Knative can terminate idle pods, which can disrupt long-running workflows or workflows that call slow external services.
* Configure persistence for workflows that use callback states when you deploy them with Knative. Persistence allows the workflow to resume execution after Knative terminates the pod.
* Enable `initContainers` explicitly in your Knative configuration if your workflow requires them. Knative disables `initContainers` by default.
====

== Customization exceptions

In addition to customizing the workflow container, you can add extra containers, `initContainers`, and volumes to the pod specification. However, the Operator manages certain elements and does not allow you to override them.

Container naming::
Do not define a container named `workflow` in the containers array. If you specify a container with this name, the Operator ignores it. To customize the workflow container, use `.spec.podTemplate.container`.

Operator-managed immutable volumes::
The Operator manages specific volumes and file system paths that it requires for workflow configuration and execution. The Operator ignores any attempt to override these volumes or to mount data at the paths listed below.

.Operator-managed immutable volumes
[cols="1,1,2,1", options="header"]
|===
| Volume | Type | Path | Profile

| `workflow-properties`
| config map
| `/deployments/config/application.properties`
| `preview`

| `workflow-properties`
| config map
| `${PROJECT_ROOT}/src/main/resources/application.properties`, `${PROJECT_ROOT}/src/main/resources/application-dev.properties`
| `dev`

| `resources`
| projected
| `${PROJECT_ROOT}/src/main/resources/`
| `dev`
|===

[WARNING]
====
In the *dev* profile, the Operator mounts all workflow resources defined in the `SonataFlow` CR into the `resources` projected volume. Do not mount additional volumes or data at this path to avoid configuration conflicts or data loss.
====

== Serverless Logic Operator profiles

Profiles control the runtime and deployment behavior of workflows. You can select a profile by setting an annotation on the SonataFlow CR.

For example:

[source,yaml,subs="+quotes"]
----
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlow
metadata:
  name: <name>
  annotations:
    sonataflow.org/profile: preview
spec:
  # ...
----

== Using custom images

Custom image in the default container::
When you set the `.spec.podTemplate.container.image` attribute, you indicate that the workflow image is already built. The Operator does not rebuild, upgrade, or reconcile the image.

Custom image in the dev profile::
In the *dev* profile, base custom images on the default development image at `registry.redhat.io/openshift-serverless-1/logic-swf-devmode-rhel8:<version>`.

Custom image in the preview profile::
When you specify a custom image in the preview profile, the Operator skips the internal build process and deploys the workflow by using the provided image. In this scenario, the Operator ignores the `.spec.resources` attribute because it applies only to the internal build process.

[NOTE]
====
Ensure that the workflow definition in `.spec.flow` matches the workflow packaged in the provided image. If these definitions differ, configuration, service discovery, and service binding might behave unexpectedly.
====
