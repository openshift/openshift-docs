//module included in the following assembly:
//
// * networking/multiple_networks/primary_networks/about-user-defined-networks.adoc

:_mod-docs-content-type: PROCEDURE
[id="opening-default-network-ports-udn_{context}"]
= Opening default network ports on user-defined network pods

By default, pods on a user-defined network (UDN) are isolated from the default network. This means that default network pods, such as those running monitoring services (Prometheus or Alertmanager) or the {product-title} image registry, cannot initiate connections to UDN pods.

To allow default network pods to connect to a user-defined network pod, you can use the `k8s.ovn.org/open-default-ports` annotation. For example:

[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  annotations:
    k8s.ovn.org/open-default-ports: |
      - protocol: tcp
        port: 80
      - protocol: udp
        port: 53
# ...
----

This annotation opens specific ports on the user-defined network pod for access from the default network. Note that open ports are accessible on the pod's default network IP, and not its user-defined network IP.

[IMPORTANT]
====
Applying the `k8s.ovn.org/open-default-ports` annotation reduces the isolation of your user-defined network pods. Only open the minimum necessary ports for specific, verified communication requirements.
====

The following procedure creates a pod with the `k8s.ovn.org/open-default-ports` annotation that allows incoming TCP connections on port `8080` from  the {product-title} image registry. Use this example when configuring connections with other default services.

.Prerequisites 

* You have created a `ClusterUserDefinedNetwork` or `UserDefinedNetwork` CR.

.Procedure

. Use the following YAML example to create a pod named `busybox-pod` that includes the `k8s.ovn.org/open-default-ports` annotation. Name the file `busybox-pod.yaml`.
+
[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  annotations:
    k8s.ovn.org/open-default-ports: |
      - protocol: tcp
        port: 8080
  labels:
    app: busybox
  name: busybox-pod
spec:
  containers:
  - name: busybox
    image: alpine:latest
    command: [ "sleep", "3600" ]
    ports:
    - containerPort: 8080
      name: http
    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - "ALL"
      seccompProfile:
        type: "RuntimeDefault"
----

. Deploy the pod in the user-defined network namespace by entering the following command:
+
[source,terminal]
----
$ oc apply -f busybox-pod.yaml -n <udn_project_name>
----
+
.Example output
+
[source,terminal]
----
pod/busybox-pod created
----

. Open a second terminal (*Terminal B*).

. In *Terminal A*:

.. Obtain and store the IP address of the `busybox-pod` resource by entering the following command:
+
[source,terminal]
----
$ oc get pod busybox-pod -o wide -n <udn_project_name>
----
+
.Example output
+
[source,terminal]
----
NAME          READY   STATUS    RESTARTS   AGE    IP            NODE                         NOMINATED NODE   READINESS GATES
busybox-pod   1/1     Running   0          108s   10.132.0.44   ip-10-0-135-6.ec2.internal   <none>           <none>
----

.. Access the shell of the `busybox-pod` resource by entering the following command:
+
[source,terminal]
----
$ oc exec -it -n <udn_project_name> busybox-pod -- /bin/sh
----

.. Start a web server inside of the `busybox-pod` resource that can serve an HTTP response on port `8080` by running the following command:
+
[source,terminal]
----
~ $ while true; do echo -e "HTTP/1.1 200 OK\n\nHello from UDN pod on port 8080!" | nc -l -p 8080; done
----

. In *Terminal B*:

.. Identify an existing `openshift-image-registry` pod by entering the following command:
+
[source,terminal]
----
$ oc get pods -n openshift-image-registry -o wide
----
+
.Example output
+
[source,terminal]
----
NAME                              READY   STATUS    RESTARTS       AGE    IP            NODE                         NOMINATED NODE   READINESS GATES
image-registry-869b57db87-7t8kg   1/1     Running   2 (113m ago)   115m   10.132.0.23   ip-10-0-135-6.ec2.internal   <none>           <none>
node-ca-xnk2g                     1/1     Running   0              118m   10.0.135.6    ip-10-0-135-6.ec2.internal   <none>           <none>
----

.. Access the shell of the `openshift-image-registry` pod by entering the following command:
+
[source,terminal]
----
$ oc exec -it -n openshift-image-registry <image-registry-pod-name> -- /bin/bash
----

.. In the shell of the `openshift-image-registry` pod, initiate a connection to the `busybox-pod` resource by entering the following command:
+
[source,terminal]
----
$ curl -v http://<busybox_pod_ip_address>:8080
----
+
.Successful output
+
[source,terminal]
----
*   Trying 10.132.0.43:8080...
* Connected to 10.132.0.43 (10.132.0.43) port 8080 (#0)
> GET / HTTP/1.1
> Host: 10.132.0.43:8080
> User-Agent: curl/7.76.1
> Accept: */*
> 
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
* no chunk, no close, no size. Assume close to signal end
< 
Hello from UDN pod on port 8080!
----