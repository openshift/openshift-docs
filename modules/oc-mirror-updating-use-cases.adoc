// Module included in the following assemblies:
//
// * updating/updating_a_cluster/updating_disconnected_cluster/mirroring-image-repository.adoc

:_mod-docs-content-type: REFERENCE
[id="oc-mirror-image-set-examples-add-images_{context}"]
= Mirror registry update examples

This section covers the use cases for updating the mirror registry by using the disk-to-mirror workflows.

.Example `ImageSetConfiguration` file that was previously used for mirroring
[source, yaml]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: /home/user/metadata
mirror:
  platform:
    channels:
      - name: stable-4.12 
        minVersion: 4.12.1
        maxVersion: 4.12.1
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.14
      packages:
        - name: rhacs-operator
          channels:
          - name: stable
            minVersion: 1.0.1
----

[id="mirror-latest-version-upgrading_{context}"]
== Upgrading to the latest {product-title} version

You can upgrade to the latest {product-title} version by running the mirroring workflow without changing the `ImageSetConfiguration` file.

.Updated `ImageSetConfiguration` file
[source,yaml]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: /home/user/metadata
mirror:
  platform:
    channels:
      - name: stable-4.12
        minVersion: 4.12.1
        maxVersion: 4.12.1
      - name: stable-4.14 
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.14
      packages:
        - name: rhacs-operator
          channels:
          - name: stable
            minVersion: 1.0.1
----

This image set configuration mirrors all the necessary {product-title} releases for upgrading the cluster from version 4.12.1 to the latest version in the `stable-4.14` channel.

When adding `stable-4.14` alongside 4.12.1 while you are still using 4.12.1, note that a cluster reboot may occur after a mirror refresh, but before an upgrade, due to routine operations. It is crucial to ensure that you have the images you are currently using.

[id="mirror-specific-version-prune-existing_{context}"]
== Mirroring a specific {product-title} version and pruning the existing images

You can mirror a specific {product-title} version while pruning images from an older version. In this scenario, you remove the images of {product-title} 4.12.1, as the cluster was previously upgraded to 4.14.25 during the prior mirroring process.

.Updated `ImageSetConfiguration` file
[source,yaml]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: /home/user/metadata
mirror:
  platform:
    channels:
      - name: stable-4.14 <1>
        minVersion: 4.14.25
      - name: stable-4.15
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.14
      packages:
        - name: rhacs-operator
          channels:
          - name: stable 
            minVersion: 1.0.1
----
<1> Replacing `stable-4.12` with `stable-4.14` prunes all the images of `stable-4.12`.

[id="mirror-latest-version-prune-existing_{context}"]
== Updating to the latest version of an Operator and pruning the existing images

You can update to the latest version of an Operator while pruning existing images using an updated `ImageSetConfiguration` file. By following this method, you ensure that only the necessary images for the specific upgrade path are retained.

If the initial `ImageSetConfiguration` file contains only a specified `minVersion`, oc-mirror plugin v1 includes these versions and valid upgrade paths in its processing. To ensure only the latest versions are mirrored, and oc-mirror plugin v1 retains only the images necessary for the specific upgrade path, avoid specifying any `minVersion`.

.Updated `ImageSetConfiguration` file
[source,yaml,subs=attributes+]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: /home/user/metadata
mirror:
  platform:
    channels:
      - name: stable-4.12 
        minVersion: 4.12.1
        maxVersion: 4.12.1
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.14
      packages:
        - name: rhacs-operator
          channels:
          - name: stable 
----

[id="oc-mirror-image-set-examples-operator-pruning-versions_{context}"]
== Mirroring a new Operator and pruning the existing Operator

You can mirror a new Operator and prune an existing one using an `ImageSetConfiguration` file.

.Updated `ImageSetConfiguration` file
[source,yaml,subs=attributes+]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: /home/user/metadata
mirror:
  platform:
    channels:
      - name: stable-4.12
        minVersion: 4.12.1
        maxVersion: 4.12.1
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.14
      packages:
        - name: <new_operator_name> #<1>
          channels:
          - name: stable
----
<1> Replacing `rhacs-operator` with `<new_operator_name>` prunes the Red Hat Advanced Cluster Security for Kubernetes Operator.


[id="mirror-non-ideal-practice-pruning_{context}"]
== Pruning All {product-title} Images

You can prune all {product-title} images by running the mirroring workflow without altering the `ImageSetConfiguration` file.

.Updated `ImageSetConfiguration` file
[source,yaml,subs=attributes+]
----
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: /home/user/metadata
mirror:
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.14
      packages:
----

If you remove the platform section from your `ImageSetConfiguration` file, the `oc-mirror` plugin v1 removes all {product-title} images from the mirror registry. This action may disrupt the cluster's functionality, especially during a cluster reboot due to a `MachineConfiguration` change or other routine tasks.

To avoid unintended disruptions, use the `--dry-run` flag with the mirror-to-mirror or disk-to-mirror workflows. Running `--dry-run` allows you to verify the intended actions and ensure they do not negatively impact any disconnected clusters, even if you choose to skip pruning during the actual workflow.