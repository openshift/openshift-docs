// Module included in the following assemblies:
//
// * installing/disconnected_install/installing-mirroring-disconnected-v2.adoc
// * updating/updating_a_cluster/updating_disconnected_cluster/mirroring-image-repository.adoc

:_mod-docs-content-type: PROCEDURE
[id="oc-mirror-updating-cluster-manifests-v2_{context}"]
= Configuring your cluster to use the resources generated by v2

After you have mirrored your image set to the mirror registry, you must apply the generated ImageDigestMirrorSet (IDMS), ImageTagMirrorSet (ITMS), CatalogSource, UpdateService into the cluster. 

The ImageDigestMirrorSet resource associates the mirror registry with the source registry and redirects image pull requests using digest specifications. Whereas, the ImagetagMirrorSet redirects the image pull requests using image tags. 

The CatalogSource resource is used by Operator Lifecycle Manager (OLM) to retrieve information about the available Operators in the mirror registry. 

[IMPORTANT]
====
Compared to ICSP generation of oc-mirror v1, IDMS and ITMS files generated span the full scope of the image set. 
This means that, in case of incremental mirroring, although only a subset of images (the new ones) will be mirrored, the IDMS and ITMS files will cover the whole image set. 
====
 
.Prerequisites

* You have access to the cluster as a user with the `cluster-admin` role.

.Procedure

. Log in to the OpenShift CLI as a user with the `cluster-admin` role.

. Run the following command to generate resources:
+
[source,terminal]
----
$ oc mirror -v2 -c imagessetconfig.yaml file://<path_to_output_directory>
----

. Apply the YAML files from the results directory to the cluster by running the following command:
+
[source,terminal]
----
$ oc apply -f <path_to_oc-mirror_workspace>/working-dir/cluster-resources
----

.Example Output for idms-oc-mirror.yaml
[source,yaml]
----
apiVersion: config.openshift.io/v1
kind: ImageDigestMirrorSet
metadata:
  creationTimestamp: null
  name: idms-generic-0
spec:
  imageDigestMirrors:
  - mirrors:
    - localhost:5000/clid10/noflag/openshift-community-operators
    source: quay.io/openshift-community-operators
status: {}
----

.Example Output for itms-oc-mirror.yaml
[source,yaml]
----
apiVersion: config.openshift.io/v1
kind: ImageTagMirrorSet
metadata:
  creationTimestamp: null
  name: itms-generic-0
spec:
  imageTagMirrors:
  - mirrors:
    - localhost:5000/clid10/noflag/kubebuilder
    source: gcr.io/kubebuilder
  - mirrors:
    - localhost:5000/clid10/noflag/cockroachdb
    source: quay.io/cockroachdb
  - mirrors:
    - localhost:5000/clid10/noflag/helmoperators
    source: quay.io/helmoperators
status: {}
----