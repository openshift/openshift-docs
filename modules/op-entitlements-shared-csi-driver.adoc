// This module is included in the following assembly:
//
// *openshift_pipelines/configuring-security-context-for-pods.adoc
:_mod-docs-content-type: PROCEDURE
[id="op-entitlements-shared-csi-driver_{context}"]
= Using Red Hat entitlements by sharing the secret using the Shared Resources CSI driver operator

You can set up sharing of the `etc-pki-entitlement` secret from the `openshift-config-managed` namespace to other namespaces using the Shared Resources Container Storage Interface (CSI) Driver Operator. You can then configure your pipeline to use this secret for the Buildah task.

.Prerequisites

* You are logged on to your {OCP} cluster using the `oc` command line utility as a user with cluster administrator permissions.
* You enabled the Shared Resources CSI Driver operator on your {OCP} cluster.

.Procedure

. Create a `SharedSecret` custom resource (CR) for sharing the `etc-pki-entitlement` secret by running the following command:
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: sharedresource.openshift.io/v1alpha1
kind: SharedSecret
metadata:
  name: shared-rhel-entitlement
spec:
  secretRef:
    name: etc-pki-entitlement
    namespace: openshift-config-managed
EOF
----

. Create an RBAC role that permits access to the shared secret by running the following command:
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: shared-resource-rhel-entitlement
  namespace: <pipeline_namespace> # <1>
rules:
  - apiGroups:
      - sharedresource.openshift.io
    resources:
      - sharedsecrets
    resourceNames:
      - shared-rhel-entitlement
    verbs:
      - use
EOF
----
<1> Replace `<pipeline_namespace>` with the namespace of your pipeline.

. Assign the role to the `pipeline` service account by running the following command:
+
[source,terminal]
----
$ oc create rolebinding shared-resource-rhel-entitlement --role=shared-shared-resource-rhel-entitlement \
  --serviceaccount=<pipeline-namespace>:pipeline # <1>
----
<1> Replace `<pipeline-namespace>` with the namespace of your pipeline.
+
[NOTE]
====
If you changed the default service account for {pipelines-shortname} or if you define a custom service account in the pipeline run or task run, assign the role to this account instead of the `pipeline` account.
====

. In your Buildah task definition, use the `buildah` task provided in the `openshift-pipelines` namespace or a copy of this task and define the `rhel-entitlement` workspace, as shown in the following example.

. In your task run or pipeline run that runs the Buildah task, assign the shared secret to the `rhel-entitlement` workspace, as in the following example.

.Example pipeline run definition, including the pipeline and task definitions, that uses Red Hat entitlements
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: buildah-pr-test-csi
spec:
  workspaces:
    - name: shared-workspace
      volumeClaimTemplate:
        spec:
          accessModes:
          - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
    - name: dockerconfig
      secret:
        secretName: regred
    - name: rhel-entitlement  # <1>
      csi:
        readOnly: true
        driver: csi.sharedresource.openshift.io
        volumeAttributes:
          sharedSecret: shared-rhel-entitlement
  pipelineSpec:
    workspaces:
    - name: shared-workspace
    - name: dockerconfig
    - name: rhel-entitlement  # <2>
    tasks:
# ...
    - name: buildah
      taskRef:
        resolver: cluster
        params:
        - name: kind
          value: task
        - name: name
          value: buildah
        - name: namespace
          value: openshift-pipelines
      workspaces:
      - name: source
        workspace: shared-workspace
      - name: dockerconfig
        workspace: dockerconfig
      - name: rhel-entitlement  # <3>
        workspace: rhel-entitlement
      params:
      - name: IMAGE
        value: <image_where_you_want_to_push>
----
<1> The definition of the `rhel-entitlement` workspace in the pipeline run, assigning the `shared-rhel-entitlement` CSI shared secret to the workspace
<2> The definition of the `rhel-entitlement` workspace in the pipeline definition
<3> The definition of the `rhel-entitlement` workspace in the task definition
