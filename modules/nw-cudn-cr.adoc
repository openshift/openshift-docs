//module included in the following assembly:
//
// *networking/multiple_networks/understanding-user-defined-networks.adoc

:_mod-docs-content-type: PROCEDURE
[id="nw-cudn-cr_{context}"]
= Creating a ClusterUserDefinedNetwork custom resource

The following procedure creates a cluster-wide user-defined network. Based upon your use case, create your request using either the `cluster-layer-two-udn.yaml` example for a `Layer2` topology type or the `cluster-layer-three-udn.yaml` example for a `Layer3` topology type.

//We won't have these pieces till GA in 4.18.
//[NOTE]
//====
//If any cluster default networked pods exist before the user-defined network is created, any further pods created in this namespace will return an error message: `What_is_this`.
//====

.Procedure

. Create a request for either a `Layer2` or `Layer3` topology type cluster-wide user-defined network:

.. Create a YAML file, such as `cluster-layer-two-udn.yaml`, to define your request for a `Layer2` topology as in the following example:
+
[source, yaml]
----
apiVersion: k8s.ovn.org/v1
kind: ClusterUserDefinedNetwork
metadata:
  name: <cudn_name> # <1>
spec:
  namespaceSelector: # <2>
    matchLabels: { "<example_namespace_one>": "<example_namespace_two>" }
  network:
    topology: Layer2 # <3>
    layer2: <4>
      role: Primary # <5>
      subnets:
        - "2001:db8::/64"
        - "10.100.0.0/16" # <6>
----
<1> Name of your `ClusterUserDefinedNetwork` resource. This should not be `default` or duplicate of any resource created by the Cluster Network Operator (CNO).
<2> A label query over the set of namespaces that the cluster UDN applies to.
<3> The `topology` field describes the network configuration; accepted values are `Layer2` and `Layer3`. Specifying a `Layer2` topology type creates one logical switch that is shared by all nodes.
<4> This field specifies the topology configuration. It can be `layer2` or `layer3`.
<5> Specifies `Primary` or `Secondary`. `Primary` is the only `role` specification supported in {product-version}.
<6> For `Layer2` topology types the following specifies config details for the `subnet` field:
+
* The subnets field is optional.
* The subnets field is of type `string` and accepts standard CIDR formats for both IPv4 and IPv6.
* The subnets field accepts one or two items. For two items, they must be of a different family. For example, subnets values of `10.100.0.0/16` and `2001:db8::/64`.
* `Layer2` subnets can be omitted. If omitted, users must configure IP addresses for the pods. As a consequence, port security only prevents MAC spoofing.
* The `Layer2` `subnets` field is mandatory when the `ipamLifecycle` field is specified.
+
.. Create a YAML file, such as `cluster-layer-three-udn.yaml`, to define your request for a `Layer3` topology as in the following example:
+
[source, yaml]
----
apiVersion: k8s.ovn.org/v1
kind: ClusterUserDefinedNetwork
metadata:
  name: <cudn_name> # <1>
spec:
  namespaceSelector:
    matchExpressions:
    - key: kubernetes.io/metadata.name <2>
      operator: In <3>
      values: ["<my_value>"] <4>
  network:
    topology: Layer3 # <5>
    layer3: # <6>
      role: Primary # <7>
      subnets: # <8>
        - cidr: 10.100.0.0/16
----
<1> Name of your `UserDefinedNetwork` resource. This should not be `default` or duplicate any global namespaces created by the Cluster Network Operator (CNO).
<2> Specifies the label key to match.
<3> Specifies the operator. Valid values include: `In`, `NotIn`, `Exists`, and `DoesNotExist`.
<4> Specifies an array of string values. If the `operator` value is either `Exists` or `DoesNotExist`, the value array must be empty.
<5> The `topology` field describes the network configuration; accepted values are `Layer2` and `Layer3`. Specifying a `Layer3` topology type creates a layer 2 segment per node, each with a different subnet. Layer 3 routing is used to interconnect node subnets.
<6> This field specifies the topology configuration. Valid values are `layer2` or `layer3`.
<7> Specifies a `Primary` or `Secondary` role. `Primary` is the only `role` specification supported in {product-version}.
<8> For `Layer3` topology types the following specifies config details for the `subnet` field:
+
* The `subnets` field is mandatory.
* The type for the `subnets` field is `cidr` and `hostSubnet`:
** `cidr` is the cluster subnet and accepts a string value.
** `hostSubnet` specifies the nodes subnet prefix that the cluster subnet is split to.
** For IPv6, only a `/64` length is supported for `hostSubnet`.
+
. Apply your request by running the following command:
+
[source,terminal]
----
$ oc apply -f <my_layer_two_udn.yaml>
----
+
Where `<my_layer_two_udn.yaml>` is the name of your `Layer2` or `Layer3` configuration file.

. Verify that your request is successful by running the following command:
+
[source, terminal]
----
$ oc get clusteruserdefinednetwork <cudn_name> -o yaml
----
+
Where `<cudn_name>` is the name you created of your cluster-wide user-defined network.
+
.Example output
[source,terminal]
----
apiVersion: k8s.ovn.org/v1
kind: ClusterUserDefinedNetwork
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"k8s.ovn.org/v1","kind":"ClusterUserDefinedNetwork","metadata":{"annotations":{},"name":"my-cudn"},"spec":{"namespaceSelector":{"matchExpressions":[{"key":"custom.network.selector","operator":"In","values":["example-namespace-1","example-namespace-2","example-namespace-3"]}]},"network":{"layer3":{"role":"Primary","subnets":[{"cidr":"10.100.0.0/16"}]},"topology":"Layer3"}}}
  creationTimestamp: "2024-11-19T16:46:34Z"
  finalizers:
  - k8s.ovn.org/user-defined-network-protection
  generation: 1
  name: my-cudn
  resourceVersion: "47985"
  uid: 16ee0fcf-74d1-4826-a6b7-25c737c1a634
spec:
  namespaceSelector:
    matchExpressions:
    - key: custom.network.selector
      operator: In
      values:
      - example-namespace-1
      - example-namespace-2
      - example-namespace-3
  network:
    layer3:
      role: Primary
      subnets:
      - cidr: 10.100.0.0/16
    topology: Layer3
status:
  conditions:
  - lastTransitionTime: "2024-11-19T16:46:34Z"
    message: 'NetworkAttachmentDefinition has been created in following namespaces:
      [example-namespace-1, example-namespace-2, example-namespace-3]'
    reason: NetworkAttachmentDefinitionReady
    status: "True"
    type: NetworkReady
----