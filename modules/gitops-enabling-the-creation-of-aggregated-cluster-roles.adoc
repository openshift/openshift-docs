// Module included in the following assembly:
//
// * declarative_clusterconfig/customizing-permissions-by-creating-aggregated-cluster-roles.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-enabling-the-creation-of-aggregated-cluster-roles_{context}"]
= Enabling the creation of aggregated cluster roles

[role="_abstract"]
To enable the creation of aggregated cluster roles for the Argo CD Application Controller component of a cluster-scoped Argo CD instance, you must configure the corresponding field by editing the YAML file of the Argo CD custom resource (CR).

.Procedure

. In the Argo CD CR, set the value of the `.spec.aggregatedClusterRoles` field to `true`:
+
.Example Argo CD CR
[source,yaml]
----
apiVersion: argoproj.io/v1beta1
kind: ArgoCD
metadata:
  name: example # <1>
  namespace: spring-petclinic # <2>
# ...
spec:
  aggregatedClusterRoles: true # <3>
# ...
----
<1> The name of the cluster-scoped instance.
<2> The namespace where you want to run the cluster-scoped instance.
<3> The value set to `true` enables the creation of aggregated cluster roles. If you do not want to enable the creation of aggregated cluster roles, either do not include this line or set the value to `false`.
+
.Example output
[source,terminal]
----
argocd.argoproj.io/example configured
----

. Verify that the `Status` field of the cluster-scoped Argo CD instance shows as `Phase: Available` by running the following command:
+
[source,terminal]
----
$ oc describe argocd.argoproj.io/example -n spring-petclinic
----
+
.Example output
[source,terminal]
----
Name:         example
Namespace:    spring-petclinic
Labels:       <none>
Annotations:  <none>
API Version:  argoproj.io/v1beta1
Kind:         ArgoCD
Metadata:
  Creation Timestamp:  2024-08-14T08:20:53Z
  Finalizers:
    argoproj.io/finalizer
  Generation:        3
  Resource Version:  60437
  UID:               57940e54-d60b-4c1a-bc4a-85c81c63ab69
Spec:
  Aggregated Cluster Roles:  true
...
Status:
  Application Controller:      Running
  Application Set Controller:  Unknown
  Phase:                       Available # <1>
  Redis:                       Running
  Repo:                        Running
  Server:                      Running
  Sso:                         Unknown
Events:                        <none>
----
<1> The `Available` status indicates that the cluster-scoped Argo CD instance is healthy and available.
+
[NOTE]
====
The {gitops-title} Operator creates the following default cluster roles and manages them:

* `<argocd_name>-<argocd_namespace>-argocd-application-controller` aggregated cluster role
* `<argocd_name>-<argocd_namespace>-argocd-application-controller-view`
* `<argocd_name>-<argocd_namespace>-argocd-application-controller-admin` 
====

. Verify that the Operator has created the default cluster roles and cluster role bindings for the Argo CD Application Controller and Argo CD server components by running the following commands:
+
[source,terminal]
----
$ oc get ClusterRoles -l app.kubernetes.io/part-of=argocd
----
+
.Example output
[source,terminal]
----
NAME                                                           CREATED AT
example-spring-petclinic-argocd-application-controller         2024-08-14T08:20:58Z
example-spring-petclinic-argocd-application-controller-admin   2024-08-14T09:08:38Z
example-spring-petclinic-argocd-application-controller-view    2024-08-14T09:08:38Z
example-spring-petclinic-argocd-server                         2024-08-14T08:20:59Z
----
+
[source,terminal]
----
$ oc get ClusterRoleBindings -l app.kubernetes.io/part-of=argocd
----
+
.Example output
[source,terminal]
----
NAME                                                     ROLE                                                                 AGE
example-spring-petclinic-argocd-application-controller   ClusterRole/example-spring-petclinic-argocd-application-controller   54m
example-spring-petclinic-argocd-server                   ClusterRole/example-spring-petclinic-argocd-server                   54m
----
+
The cluster role bindings for the `view` and `admin` cluster roles are not created. This is because the `view` and `admin` cluster roles only add permissions to the aggregated cluster role and do not directly configure permissions to the Argo CD Application Controller.
+
[TIP]
====
Alternatively, you can use the {OCP} web console to verify from the *Administrator* perspective. You can go to *User Management* -> *Roles* and *User Management* -> *RoleBindings*, respectively. You can search for the cluster roles and cluster role bindings that have the `app.kubernetes.io/part-of:argocd` label.
====

. Verify that the aggregated cluster role is created by checking the permissions of outputs of the roles created by running the following command:
+
[source,terminal]
----
$ oc get ClusterRole/<cluster_role_name> -o yaml # <1>
----
<1> Replace `<cluster_role_name>` with the name of the role created.
+
.Example output of the aggregated cluster role
[source,terminal]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    argocds.argoproj.io/name: example
    argocds.argoproj.io/namespace: spring-petclinic
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"argoproj.io/v1beta1","kind":"ArgoCD","metadata":{"annotations":{},"name":"example","namespace":"spring-petclinic"},"spec":{"aggregatedClusterRoles":true}}
    rbac.authorization.kubernetes.io/autoupdate: "true"
  creationTimestamp: "2024-08-14T08:20:58Z"
  labels:
    app.kubernetes.io/managed-by: spring-petclinic
    app.kubernetes.io/name: example
    app.kubernetes.io/part-of: argocd 
  name: example-spring-petclinic-argocd-application-controller # <1>
  resourceVersion: "78640"
  uid: aeeb2ef5-b531-4fe3-a61a-b5ad8dd8ca6e
aggregationRule: # <2>
  clusterRoleSelectors:
  - matchLabels:
      app.kubernetes.io/managed-by: spring-petclinic
      argocd/aggregate-to-controller: "true"
rules: [] # <3>
----
<1> The name of the aggregated cluster role.
<2> The predefined list of labels indicates that the aggregated cluster role can inherit permissions from the other user-defined cluster roles.
<3> No predefined permissions are set. However, when the Operator immediately creates a `<argocd_name>-<argocd_namespace>-argocd-application-controller-view` cluster role, the corresponding predefined `view` permissions are added into the aggregated cluster role.
+
.Example output of the `view` cluster role
[source,terminal]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    argocds.argoproj.io/name: example
    argocds.argoproj.io/namespace: spring-petclinic
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"argoproj.io/v1beta1","kind":"ArgoCD","metadata":{"annotations":{},"name":"example","namespace":"spring-petclinic"},"spec":{"aggregatedClusterRoles":true}}
  creationTimestamp: "2024-08-14T09:59:14Z"
  labels: # <1>
    app.kubernetes.io/managed-by: spring-petclinic
    app.kubernetes.io/name: example
    app.kubernetes.io/part-of: argocd
    argocd/aggregate-to-controller: "true"
  name: example-spring-petclinic-argocd-application-controller-view # <2>
  resourceVersion: "78639"
  uid: 068b8867-7a0c-4af3-a17a-0560a00eba41
rules: # <3>
- apiGroups:
  - '*'
  resources:
  - '*'
  verbs:
  - get
  - list
  - watch
- nonResourceURLs:
  - '*'
  verbs:
  - get
  - list
----
<1> The labels match the predefined list of an existing aggregated cluster role.
<2> The name of the `view` cluster role.
<3> The predefined `view` permissions. These permissions are added into the existing aggregated cluster role.
+
.Example output of the `admin` cluster role
[source,terminal]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    argocds.argoproj.io/name: example
    argocds.argoproj.io/namespace: spring-petclinic
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"argoproj.io/v1beta1","kind":"ArgoCD","metadata":{"annotations":{},"name":"example","namespace":"spring-petclinic"},"spec":{"aggregatedClusterRoles":true}}
    rbac.authorization.kubernetes.io/autoupdate: "true"
  creationTimestamp: "2024-08-14T09:59:15Z"
  labels: # <1>
    app.kubernetes.io/managed-by: spring-petclinic
    app.kubernetes.io/name: example
    app.kubernetes.io/part-of: argocd
    argocd/aggregate-to-controller: "true"
  name: example-spring-petclinic-argocd-application-controller-admin # <2>
  resourceVersion: "78642"
  uid: e2d35b6f-0832-4993-8b24-915a725454f9
aggregationRule: # <3>
  clusterRoleSelectors:
  - matchLabels:
      app.kubernetes.io/managed-by: spring-petclinic
      argocd/aggregate-to-admin: "true"
rules: null # <4>
----
<1> The labels match the predefined list of an existing aggregated cluster role.
<2> The name of the `admin` cluster role.
<3> The predefined list of labels indicates that the existing `<argocd_name>-<argocd_namespace>-argocd-application-controller-admin` cluster role can inherit permissions from the other user-defined cluster roles.
<4> Specifies that no permissions are defined yet in one or more user-defined cluster roles.
+
[TIP]
====
Alternatively, you can use the {OCP} web console to verify from the *Administrator* perspective. You can go to *User Management* -> *Roles*, use the *Filter* option, select *Cluster-wide Roles*, and search for the aggregated cluster role, `view`, and `admin` cluster roles. You must open the cluster role to check the details and configurations.
====
+
As a cluster administrator, you can now create one or more user-defined cluster roles and configure user-defined permissions for Argo CD Application Controller.