// Module included in the following assemblies:
//
// * machine_management/creating_machinesets/creating-machineset-aws.adoc
// * machine_management/creating_machinesets/creating-machineset-gcp.adoc
// * machine_management/creating_machinesets/creating-machineset-azure.adoc

ifeval::["{context}" == "creating-machineset-aws"]
:aws:
endif::[]
ifeval::["{context}" == "creating-machineset-azure"]
:azure:
endif::[]
ifeval::["{context}" == "creating-machineset-gcp"]
:gcp:
endif::[]
ifeval::["{context}" == "legacy-preempt"]
:gcp-legacy-preempt:
endif::[]

:_mod-docs-content-type: PROCEDURE
[id="machineset-creating-non-guaranteed-instance_{context}"]
ifdef::aws[= Creating Spot Instances by using compute machine sets]
ifdef::azure[= Creating Spot VMs by using compute machine sets]
ifdef::gcp[= Creating Spot VMs by using compute machine sets]
ifdef::gcp-legacy-preempt[= Creating preemptible VM instances by using compute machine sets]

[role="_abstract"]
You can save on costs by creating a compute machine set that deploys machines as non-guaranteed instances.
ifdef::aws[To launch a Spot Instance on {aws-short}, you add `spotMarketOptions` to your compute machine set YAML file.]
ifdef::azure[To launch a Spot VM on {azure-short}, you add `spotVMOptions` to your compute machine set YAML file.]
ifdef::gcp[To launch a Spot VM on {gcp-short}, you add `provisioningModel: "Spot"` to your compute machine set YAML file.]
ifdef::gcp-legacy-preempt[]
To launch a preemptible VM instance on {gcp-short}, you add `preemptible` to your compute machine set YAML file.

[NOTE]
====
{gcp-short} recommends using Spot VMs over preemptible VMs because Spot VMs include new features that preemptible VMs do not support.
====
endif::[]

.Procedure
* Add the following line under the `providerSpec` field:
+
ifdef::aws[]
[source,yaml]
----
providerSpec:
  value:
    spotMarketOptions: {}
----
+
You can optionally set the `spotMarketOptions.maxPrice` field to limit the cost of the Spot Instance. For example you can set `maxPrice: '2.50'`.
+
If the `maxPrice` is set, this value is used as the hourly maximum spot price. If it is not set, the maximum price defaults to charge up to the On-Demand Instance price.
+
[NOTE]
====
It is strongly recommended to use the default On-Demand price as the `maxPrice` value and to not set the maximum price for Spot Instances.
====
endif::aws[]
ifdef::azure[]
[source,yaml]
----
providerSpec:
  value:
    spotVMOptions: {}
----
+
You can optionally set the `spotVMOptions.maxPrice` field to limit the cost of the Spot VM. For example you can set `maxPrice: '0.98765'`. If the `maxPrice` is set, this value is used as the hourly maximum spot price. If it is not set, the maximum price defaults to `-1` and charges up to the standard VM price.
+
Azure caps Spot VM prices at the standard price. Azure will not evict an instance due to pricing if the instance is set with the default `maxPrice`. However, an instance can still be evicted due to capacity restrictions.

[NOTE]
====
It is strongly recommended to use the default standard VM price as the `maxPrice` value and to not set the maximum price for Spot VMs.
====
endif::azure[]
ifdef::gcp[]
[source,yaml]
----
providerSpec:
  value:
    provisioningModel: "Spot"
----
+
If you specify `provisioningModel: "Spot"`, the machine is labeled as an `interruptible-instance` after the instance is launched.
+
[NOTE]
====
This parameter is not compatible with setting the `providerSpec.value.preemptible` value to `true`.
====
endif::gcp[]
ifdef::gcp-legacy-preempt[]
[source,yaml]
----
providerSpec:
  value:
    preemptible: true
----
+
If `preemptible` is set to `true`, the machine is labeled as an `interruptible-instance` after the instance is launched.
+
[NOTE]
====
This parameter is not compatible with setting the `providerSpec.value.provisioningModel` value to `"Spot"`.
====
endif::gcp-legacy-preempt[]

ifeval::["{context}" == "creating-machineset-aws"]
:!aws:
endif::[]
ifeval::["{context}" == "creating-machineset-azure"]
:!azure:
endif::[]
ifeval::["{context}" == "creating-machineset-gcp"]
:!gcp:
endif::[]
ifeval::["{context}" == "legacy-preempt"]
:!gcp-legacy-preempt:
endif::[]
