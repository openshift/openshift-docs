// Module included in the following assemblies:
//
// scalability_and_performance/ztp-deploying-disconnected.adoc

:_module-type: CONCEPT
[id="ztp-using-pgt-to-update-source-crs_{context}"]
= Using PolicyGenTemplate CRs to create updated source CRs

`PolicyGenTemplate` CRs allow you to overlay additional configuration details on top of the base source CRs that you extract from the `ztp-site-generate` container. You can think of `PolicyGenTemplate` CRs as a logical merge or patch to the base CR. Use `PolicyGenTemplate` CRs to update a single field of the base CR, or overlay the entire contents of the base CR. You can update values and insert fields that are not in the base CR.

.Prerequisites

* Install the OpenShift CLI (`oc`).
* Log in to the hub cluster as a user with `cluster-admin` privileges.
* Create a Git repository where you manage your custom site configuration data. The repo must be accessible from the hub cluster and be defined as a source repository for ArgoCD.
* Extract the contents of the `/home/ztp` folder from the `ztp-site-generate` reference architecture container image.

.Procedure

. Update the relevant field in the `PolicyGenTemplate` that relates to the change you want to make. For example, in the `PerformanceProfile.spec` field of `argocd/example/policygentemplates/group-du-standard-ranGen.yaml`, modify the file with the following configuration that sets `globallyDisableIrqLoadBalancing` to false.
+
[source,yaml]
----
- fileName: PerformanceProfile.yaml
  policyName: "config-policy"
  metadata:
    name: openshift-node-performance-profile
  spec:
    cpu:
      # These must be tailored for the specific hardware platform
      isolated: "2-19,22-39"
      reserved: "0-1,20-21"
    hugepages:
      defaultHugepagesSize: 1G
      pages:
        - size: 1G
          count: 10
    globallyDisableIrqLoadBalancing: false
----
+
. Apply the pipeline configuration to your hub cluster:
+
[source,terminal]
----
$ oc apply -k ztp/argocd/deployment
----
+
The `policyGen` tool creates an updated `PerformanceProfile.yaml` file. An example generated `PerformanceProfile` CR based on the above `PolicyGenTemplate` CR snippet is below:
+
[source,yaml]
----
apiVersion: performance.openshift.io/v2
kind: PerformanceProfile
metadata:
  name: openshift-node-performance-profile
spec:
  additionalKernelArgs:
  - "idle=poll"
  - "rcupdate.rcu_normal_after_boot=0"
  cpu:
    isolated: "2-19,22-39"
    reserved: "0-1,20-21"
  hugepages:
    defaultHugepagesSize: 1G
    pages:
      - size: 1G
        count: 10
        node: 0
  globallyDisableIrqLoadBalancing: false
  machineConfigPoolSelector:
    pools.operator.machineconfiguration.openshift.io/master: ""
  net:
    userLevelNetworking: true
  nodeSelector:
    node-role.kubernetes.io/master: ''
  numa:
    topologyPolicy: "restricted"
  realTimeKernel:
    enabled: true
----

[NOTE]
====
In the `/source-crs` folder that you extract from the `ztp-site-generate` container,  the `$` syntax is not used for template substitution as implied by the syntax. Rather, if the `policyGen` tool sees the `$` prefix for a string and you do not specify a value for that field in the related `PolicyGenTemplate` CR, the field is omitted from the output CR entirely.

An exception to this is the `$mcp` variable in `/source-crs` YAML files that is substituted with the specified value for `mcp` from the `PolicyGenTemplate` CR. For example, in `example/policygentemplates/group-du-standard-ranGen.yaml`, the value for `mcp` is `worker`:

[source,yaml]
----
spec:
  bindingRules:
    group-du-standard: ""
  mcp: "worker"
----

The `policyGen` tool replace instances of `$mcp` with `worker` in the output CRs.
====
