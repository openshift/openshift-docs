// Module included in the following assemblies:
//
// * cloud_experts_tutorials/cloud-experts-aws-secret-manager.adoc

:_mod-docs-content-type: PROCEDURE
[id="cloud-experts-aws-secret-manager-create-iam-polices_{context}"]
= Creating a Secret and IAM Access Policies

[role="_abstract"]
Use the AWS CLI to create your AWS secret and IAM access policies.

.Procedure
. Create a secret in Secrets Manager by running the following command:
+
[source,terminal]
----
$ SECRET_ARN=$(aws --region "$REGION" secretsmanager create-secret \
    --name MySecret --secret-string \
    '{"username":"shadowman", "password":"hunter2"}' \
    --query ARN --output text); echo $SECRET_ARN
----

. Create an IAM Access Policy document by running the following command:
+
[source,terminal]
----
$ cat << EOF > policy.json
{
   "Version": "2012-10-17",
   "Statement": [{
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
      ],
      "Resource": ["$SECRET_ARN"]
      }]
}
EOF
----

. Create an IAM Access Policy by running the following command:
+
[source,terminal]
----
$ POLICY_ARN=$(aws --region "$REGION" --query Policy.Arn \
--output text iam create-policy \
--policy-name openshift-access-to-mysecret-policy \
--policy-document file://policy.json); echo $POLICY_ARN
----

. Create an IAM Role trust policy document by running the following command:
+
[NOTE]
====
The trust policy is locked down to the default service account of a namespace you create later in this process.
====
+
[source,terminal]
----
$ cat <<EOF > trust-policy.json
{
   "Version": "2012-10-17",
   "Statement": [
   {
   "Effect": "Allow",
   "Condition": {
     "StringEquals" : {
       "${OIDC_ENDPOINT}:sub": ["system:serviceaccount:my-application:default"]
      }
    },
    "Principal": {
       "Federated": "arn:aws:iam::$AWS_ACCOUNT_ID:oidc-provider/${OIDC_ENDPOINT}"
    },
    "Action": "sts:AssumeRoleWithWebIdentity"
    }
    ]
}
EOF
----

. Create an IAM role by running the following command:
+
[source,terminal]
----
$ ROLE_ARN=$(aws iam create-role --role-name openshift-access-to-mysecret \
--assume-role-policy-document file://trust-policy.json \
--query Role.Arn --output text); echo $ROLE_ARN
----

. Attach the role to the policy by running the following command:
+
[source,terminal]
----
$ aws iam attach-role-policy --role-name openshift-access-to-mysecret \
    --policy-arn $POLICY_ARN
----