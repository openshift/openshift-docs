// Module included in the following assemblies:
//
// * virt/install/virt-install-ibm-cloud-config-new-cluster.adoc

:_mod-docs-content-type: PROCEDURE
[id="virt-install-ibm-cloud-config-new-cluster_{context}"]

= Configuring {ibm-cloud-title} for the new cluster

[role="_abstract"]
Configure and provision the {ibm-cloud-title} environment to establish the operational framework and nodes for your {VirtProductName} cluster.

.Procedure

. Create a new virtual server instance in {ibm-cloud-title} at link:https://cloud.ibm.com/gen1/infrastructure/provision/vs[] to be the Bastion server. This instance is used to run the installation and provide environment services. This virtual server instance has the following properties:

* *Type of virtual server:* Public
* *Operating system:* CentOS
* Your public SSH RSA key
+
All other properties should retain their default values.

. Note the private VLAN and subnet the virtual server instance is assigned to at link:https://cloud.ibm.com/classic/network/vlans[].

. Provision 6 bare-metal nodes in {ibm-cloud-title} at link:https://cloud.ibm.com/gen1/infrastructure/provision/bm[]. Use the following values when provisioning the nodes:

* *Domain*: A subdomain you can add records to.
* *Quantity*: 6
* *Location*: The same location as the virtual server instance.
* *Storage disks*: RAID 1
* *Network Interface*: Private
* *Private VLAN*: The same as noted for the virtual server instance.

. Confirm all nodes are provisioned and ready at link:https://cloud.ibm.com/gen1/infrastructure/devices[].

. Rename all master nodes as `master0-<domain-name>`, `master1-<domain-name>`, and `master2-<domain-name>`. Replace `<domain-name>` with the domain used when provisioning the nodes.

. Rename all worker nodes as `worker0-<domain-name>`, `worker1-<domain-name>`, and `worker2-<domain-name>`. Replace `<domain-name>` with the domain used when provisioning the nodes.

. Configure the Bastion virtual server instance as a default network gateway.

. Edit `/etc/dhcp/dhcpd.conf` on the Bastion virtual server instance to configure DHCP. The following is an example of this configuration:
+
----
# Set DNS name and DNS server's IP address or hostname
option domain-name  "bm.ibm.cluster.example.com";
option domain-name-servers  8.8.8.8;

# Declare DHCP Server
authoritative;

# The default DHCP lease time
default-lease-time 600;

# Set the maximum lease time
max-lease-time 7200;

# Set Network address, subnet mask and gateway

subnet 10.60.128.0 netmask 255.255.255.192 {
  # Range of IP addresses to allocate
  range dynamic-bootp 10.60.128.10 10.60.128.35;
  # Provide broadcast address
  option broadcast-address 10.60.128.63;
  # Set default gateway
  option routers 10.60.128.38;
----
+
[NOTE]
====
Replace the example values with values applicable to your network configuration.
====

. Restart DHCP on the Bastion virtual server instance:
+
----
$ systemctl restart dhcpd
----

. Enable IP forwarding on the Bastion virtual server instance:
+
----
$ sysctl -w net.ipv4.ip_forward=1
----

. Verify IP forwarding is enabled on the Bastion virtual server instance:
+
----
$ sysctl -p /etc/sysctl.conf
----

. Restart the network service on the Bastion virtual server instance:
+
----
$ service network restart
----

. Verify if `firewalld` is enabled on the Bastion virtual server instance:
+
----
$ firewall-cmd --state
----

. If the `firewalld` service is not enabled on the Bastion virtual server instance, enable and start the service:
+
----
$ systemctl enable firewalld
$ systemctl start firewalld
----

. Add network address translation (NAT) rules to the `firewalld` service:
+
----
$ firewall-cmd --add-masquerade --permanent
$ firewall-cmd --reload
----
