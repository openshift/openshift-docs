// Module included in the following assemblies:
//
// * /serverless/functions/serverless-functions-on-cluster-builds.adoc

:_content-type: PROCEDURE
[id="serverless-functions-creating-on-cluster-builds_{context}"]
= Building and deploying a function on the cluster

You can use the Knative (`kn`) CLI to initiate a function project build and then deploy the function directly on the cluster. To build a function project in this way, the source code for your function project must exist in a Git repository branch that is accessible to your cluster.

.Prerequisites

* {pipelines-title} must be installed on your cluster.

* You have installed the OpenShift CLI (`oc`).

* You have installed the Knative (`kn`) CLI.

.Procedure

. Create the following resources:

.. Create the `s2i` Tekton task to be able to use Source-to-Image in the pipeline:
+
[source,terminal]
----
$ oc apply -f https://raw.githubusercontent.com/openshift-knative/kn-plugin-func/serverless-1.31/pkg/pipelines/resources/tekton/task/func-s2i/0.1/func-s2i.yaml
----

.. Create the `kn func` deploy Tekton task to be able to deploy the function in the pipeline:
+
[source,terminal]
----
$ oc apply -f https://raw.githubusercontent.com/openshift-knative/kn-plugin-func/serverless-1.31/pkg/pipelines/resources/tekton/task/func-deploy/0.1/func-deploy.yaml
----

. Create a function:
+
[source,terminal]
----
$ kn func create <function_name> -l <runtime>
----

. Implement the business logic of your function. Then, use Git to commit and push the changes.

. Deploy your function:
+
[source,terminal]
----
$ kn func deploy --remote
----
+
If you are not logged into the container registry referenced in your function configuration, you are prompted to provide credentials for the remote container registry that hosts the function image:
+
.Example output and prompts
[source,terminal]
----
ðŸ•• Creating Pipeline resources
Please provide credentials for image registry used by Pipeline.
? Server: https://index.docker.io/v1/
? Username: my-repo
? Password: ********
   Function deployed at URL: http://test-function.default.svc.cluster.local
----

. To update your function, commit and push new changes by using Git, then run the `kn func deploy --remote` command again.

. Optional. You can configure your function to be built on the cluster after every Git push by using pipelines-as-code:

.. Generate the Tekton `Pipelines` and `PipelineRuns` configuration for your function:
+
[source,terminal]
----
$ kn func config git set
----
+
Apart from generating configuration files, this command connects to the cluster and validates that the pipeline is installed. By using the token, it also creates, on behalf of the user, a webhook on the function repository. That webhook triggers the pipeline on the cluster every time changes are pushed to the repository.
+
You need to have a valid GitHub personal access token with the repository access to use this command.

.. Commit and push the generated `.tekton/pipeline.yaml` and `.tekton/pipeline-run.yaml` files:
+
[source,terminal]
----
$ git add .tekton/pipeline.yaml .tekton/pipeline-run.yaml
$ git commit -m 'Add the Pipelines and PipelineRuns configuration'
$ git push
----

.. After you make a change to your function, commit and push it. The function is rebuilt automatically by using the created pipeline.
