// Module included in the following assemblies:
//
// * virt/virtual_machines/advanced_vm_management/virt-working-with-resource-quotas-for-vms.adoc

:_mod-docs-content-type: PROCEDURE
[id="virt-about-resource-limits-for-vms_{context}"]
Kubernetes has the concept of [requests and limits](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits), for virtual machines requests and limits are also used, however, their semantics and the detals are critical to operate virtual machine in safe margins.

[IMPORTANT]
The product is generally taking care of setting appropriate requests and limits automatically.
Manually adjust resources.requests and resource.limits can lead to reduced stability.

We'll be focusing on the two primary resources of a VM: CPU and Memory.

.Resource requests on Virtual Machines
Requests are leveraged by the Kubernetes scheduler to place workloads on nodes.
The request is thus effectively reserving the amount of resources from a scheduler perspective.

Manually setting the CPU requests of a VM can lead to for example lower VM performance if the node is under CPU pressure, increased latency due to noisy neighbors.

Manually setting the Memory request of a VM can lead to for example to VM crashes if a node is getting under memory pressure, or VM slow downs.

.Resource limits on Virtual Machines
Limits are leveraged by the kubelet, and not the kubernetes decheduler.
The kubelet is using the limit in order to enforce hard resource constraints on the specific resource.

Manually setting the CPU limits of a VM can lead to for example a lower VM preformance, even without the node being under pressure.

Manually setting the Memory limits of a VM can lead to for example VM crashes, even if the node is not under memory pressure.

[id="virt-setting-resource-quota-limits-for-vms_{context}"]
= Setting resource quota limits for virtual machines

By default, {VirtProductName} automatically manages CPU and memory limits for virtual machines (VMs) if a namespace enforces resource quotas that require limits to be set. The memory limit is automatically set to twice the requested memory and the CPU limit is set to one per vCPU.

You can customize the memory limit ratio for a specific namespace by adding the `alpha.kubevirt.io/auto-memory-limits-ratio` label to the namespace. For example, the following command sets the memory limit ratio to 1.2:

[source,terminal]
----
$ oc label ns/my-virtualization-project  alpha.kubevirt.io/auto-memory-limits-ratio=1.2
----

[WARNING]
====
Avoid managing resource quota limits manually. To prevent misconfigurations or scheduling issues, rely on the automatic resource limit management provided by {VirtProductName} unless you have a specific need to override the defaults.
====


Resource quotas that only use requests automatically work with VMs. If your resource quota uses limits, you must manually set resource limits on VMs. Resource limits must be at least 100 MiB larger than resource requests.

.Procedure

. Set limits for a VM by editing the `VirtualMachine` manifest. For example:
+
[source,yaml]
----
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: with-limits
spec:
  runStrategy: Halted
  template:
    spec:
      domain:
# ...
        resources:
          requests:
            memory: 128Mi
          limits:
            memory: 256Mi  <1>
----
<1> This configuration is supported because the `limits.memory` value is at least `100Mi` larger than the `requests.memory` value.

. Save the `VirtualMachine` manifest.
