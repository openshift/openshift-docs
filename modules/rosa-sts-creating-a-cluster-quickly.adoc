// Module included in the following assemblies:
//
// * rosa_getting_started_sts/rosa_creating_a_cluster_with_sts/rosa-sts-creating-a-cluster-quickly.adoc

[id="rosa-sts-creating-cluster-auto-mode{context}"]
= Creating a ROSA cluster with STS using automatic mode

When you create an OpenShift cluster that uses the AWS Security Token Service (STS), you can use the `auto` mode with the `rosa create` command. With this mode, you can use the defaults to create the required AWS Identity and Access Management (IAM) roles and policies, and an OpenID Connect (OIDC) provider. The resources are created using the current AWS account.

[IMPORTANT]
====
Only public and AWS PrivateLink clusters are supported with STS. Regular private clusters (non-PrivateLink) are not available for use with STS.
====

.Prerequisites

* You have completed the AWS prerequisites for ROSA with STS.
* You have available AWS service quotas.
* You have enabled the ROSA service in the AWS Console.
* You have installed and configured the latest AWS, ROSA, and `oc` CLIs on your installation host.

[NOTE]
====
link:https://docs.aws.amazon.com/vpc/latest/userguide/vpc-sharing.html[AWS Shared VPCs] are not currently supported for ROSA installations.
====

.Procedure

. Create the required account-wide roles and policies, including the Operator policies:
+
[source,terminal]
----
$ rosa create account-roles --mode auto --version 4.8 <1>
----
<1> You must specify an OpenShift release by using the `--version` option. The version that is installed when a ROSA cluster is created is determined by the roles and policies that are used.
+
[NOTE]
====
When using `auto` mode, you can optionally specify the `-y` argument to bypass the interactive prompts and automatically confirm operations.
====

. Create a cluster with STS using the defaults:
+
[source,terminal]
----
$ rosa create cluster --cluster-name <cluster_name> --sts <1>
----
<1> Replace `<cluster_name>` with the name of your cluster.

. Create the cluster-specific Operator IAM roles:
+
[source,terminal]
----
$ rosa create operator-roles --mode auto --cluster <cluster_name|cluster_id> <1>
----
<1> Replace `<cluster_name|cluster_id>` with the name or ID of your cluster.

. Create the OpenID Connect (OIDC) provider that the cluster Operators will use to authenticate:
+
[source,terminal]
----
$ rosa create oidc-provider --mode auto --cluster <cluster_name|cluster_id>
----

. Check the status of your cluster and retrieve your cluster ID. The `State` field changes from `pending` to `installing` to `ready`:
+
[source,terminal]
----
$ rosa describe cluster --cluster=<cluster_name|cluster_id>
----
+
.Example output
[source,terminal]
----
Name:                       <cluster_name>
ID:                         <cluster_id>
External ID:                <external_id>
OpenShift Version:          <version>
Channel Group:              stable
DNS:                        *.openshiftapps.com
AWS Account:                123456789012
API URL:                    https://api.<cluster_name>.openshiftapps.com:6443
Console URL:                https://console-openshift-console.apps.<cluster_name>.openshiftapps.com
Region:                     <region>
Multi-AZ:                   false
Nodes:
 - Master:                  3
 - Infra:                   2
 - Compute:                 2
Network:
 - Service CIDR:            172.30.0.0/16
 - Machine CIDR:            10.0.0.0/16
 - Pod CIDR:                10.128.0.0/14
 - Host Prefix:             /23
State:                      pending (Waiting for OIDC configuration)
Private:                    No
Created:                    Jun 10 2021 15:47:56 UTC
Details Page:               https://cloud.redhat.com/openshift/details/s/<subscription_id>
OIDC Endpoint URL:          https://rh-oidc.s3.us-east-1.amazonaws.com/<cluster_id>
----
+
[NOTE]
====
If installation fails or the `State` field does not change to `ready` after 40 minutes, check the installation troubleshooting documentation for more details.
====

. Track the progress of the cluster creation by watching the OpenShift installer logs:
+
[source,terminal]
----
$ rosa logs install --cluster=<cluster_name|cluster_id> --watch <1>
----
<1> Specify the `--watch` flag to watch for new log messages as the installation progresses. This argument is optional.
