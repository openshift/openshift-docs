// Module included in the following assemblies:
//
// * logging/cluster-logging-external.adoc

[id="cluster-logging-collector-log-forward-es_{context}"]
= Forwarding logs to an external Elasticsearch instance

You can optionally forward logs to an external Elasticsearch v5.x or v6.x instance in addition to, or instead of, the internal {product-title} Elasticsearch instance. You are responsible for configuring the external log aggregator to receive the logs from {product-title}.

To configure log forwarding to an external Elasticsearch instance, create a `ClusterLogForwarder` Custom Resource (CR) with an output to that instance and a pipeline that uses the output. The external Elasticsearch output can use the HTTP (insecure) or HTTPS (secure HTTP) connection.

To forward logs to both an external and the internal Elasticsearch instance, create outputs and pipelines to the external instance and a pipeline that uses the `default` output to forward logs to the internal instance. You do not need to create a `default` output. If you do configure a `default` output, you receive an error message because the `default` output is reserved for the Cluster Logging Operator. 

[NOTE]
====
If you want to forward logs to *only* the internal {product-title} Elasticsearch instance, you do not need to create a `ClusterLogForwarder` CR.
====

.Procedure

. Create a `ClusterLogForwarder` CR YAML file similar to the following:
+
[source,yaml]
----
apiVersion: "logging.openshift.io/v1"
kind: "ClusterLogForwarder"
metadata:
  name: instance <1>
spec:
  outputs:
   - name: elasticsearch-insecure <2>
     type: "elasticsearch" <3>
     url: http://elasticsearch.insecure.com:9200 <4>
   - name: elasticsearch-secure <4>
     type: "elasticsearch"
     url: https://elasticsearch.secure.com:9200
     secret:
        name: es-secret <5>
  pipelines:
   - name: application-logs <6>
     inputRefs: <7>
     - application
     - audit
     outputRefs:
     - elasticsearch-secure <8>
     - default <9>
   - name: infrastructure-audit-logs <10>
     inputRefs:
     - infrastructure
     outputRefs:
     - elasticsearch-insecure
----
<1> The name of the `ClusterLogForwarder` CR must be `instance`.
<2> Specify a name for the output.
<3> Specify the `elasticsearch` type.
<4> Specify the URL and port of the external Elasticsearch instance as a valid absolute URL. You can use the `http` (insecure) or `https` (secure HTTP) protocol. If the cluster-wide proxy using the CIDR annotation is enabled, the output must be a server name or FQDN, not an IP Address.
<5> If using an `https` prefix, you must specify the name of the secret required by the endpoint for TLS communication. The secret must exist in the `openshift-logging` project and must have keys of: *tls.crt*, *tls.key*, and *ca-bundle.crt* that point to the respective certificates that they represent.
<6> Optional. Specify a name for the pipeline.
<7> Specify which log types should be forwarded using that pipeline: `application,` `infrastructure`, or `audit`.
<8> Specify the output to use with that pipeline for forwarding the logs.
<9> Optional. Specify the `default` output to send the logs to the internal Elasticsearch instance.
<10> Optional. Configure multiple outputs to forward logs to other external Elasticsearch instances.

. Create the CR object:
+
[source,terminal]
----
$ oc create -f <file-name>.yaml
----

The Cluster Logging Operator redeploys the Fluentd Pods. If the Pods do not redeploy, you can delete the Fluentd
Pods to force them to redeploy.

[source,terminal]
----
$ oc delete pod --selector logging-infra=fluentd
----

