// Module included in the following assemblies:
// * openshift_images/managing_images/using-image-pull-secrets.adoc
// * updating/updating_a_cluster/updating_disconnected_cluster/disconnected-update-osus.adoc
// * support/remote_health_monitoring/remote-health-reporting.adoc
//
// Not included, but linked to from:
// * operators/admin/olm-managing-custom-catalogs.adoc

ifeval::["{context}" == "using-image-pull-secrets"]
:image-pull-secrets:
endif::[]

:_mod-docs-content-type: PROCEDURE
[id="images-update-global-pull-secret_{context}"]
= Updating the global cluster pull secret

[role="_abstract"]
To add new registries or update authentication for your {product-title} cluster, you can update the global pull secret by appending new credentials to the _additional-pull-secret_. In order to do that, you can use the `oc set data secret/additional-pull-secret -n kube-system` command. Hypershift will take care of the new credential propagation among the HostedCluster nodes.

This feature provides a dedicated mechanism to separate your private credentials from the pull secret managed by the service, ensuring cluster functionality while restricting external visibility of your sensitive data. This separation allows you to independently rotate secrets and maintain exclusive ownership for compliance without impacting core managed service operations.

Managed services already have some immutable entries in the file, and you will not be able to modify those. If you are in this situation, you can follow this approach to use the same registry with different credentials.
This is a sample of authentication already in place:

[source,terminal]
----
"auths":
  "<quay.io: xxxxYYYzzzz>"
----
In the following case you can add a more specific entry such as:

[source,terminal]
----
"auths":
  "<quay.io/sampleNamespace": 111445656>"
----
This adds a new layer to the pull secret without affecting the original registry entry.

ifndef::image-pull-secrets[]
Use this procedure when you need a separate registry to store images than the registry used during installation.
endif::image-pull-secrets[]

ifdef::image-pull-secrets[]
[IMPORTANT]
====
ifndef::openshift-rosa,openshift-dedicated[]
The global pull secret is only available on {product-title} version 4.20.6 and later.
endif::openshift-rosa,openshift-dedicated[]

To transfer your cluster to another owner, you must initiate the transfer in {cluster-manager-url} and then update the pull secret on the cluster. Updating a cluster's pull secret without initiating the transfer in {cluster-manager} causes the cluster to stop reporting Telemetry metrics in {cluster-manager}.

For more information, see _Transferring cluster ownership_ under _Additional resources_ in the {cluster-manager-first} documentation.
====
endif::image-pull-secrets[]

.Prerequisites

* You have access to the cluster as a user with the `cluster-admin` role.

.Procedure

. Optional: To append a new pull secret to the existing pull secret:
+
.. Download the pull secret by entering the following command:
+
[source,terminal]
----
$ oc get secret/pull-secret -n openshift-config --template='{{index .data ".dockerconfigjson" | base64decode}}' > <pull_secret_location> <1>
----
+
--
where:

`<pull_secret_location>`:: Specifies the path to the pull secret file.
--

.. Add the new pull secret by entering the following command:
+
[source,terminal]
----
$ oc registry login --registry="<registry>" \
--auth-basic="<username>:<password>" \
--to=<pull_secret_location>
----
+
--
where:

`<registry>`:: Specifies the new registry. You can include many repositories within the same registry, for example: `--registry="<registry/my-namespace/my-repository>`.

`<username>:<password>`:: Specifies the credentials of the new registry.

`<pull_secret_location>`:: Specifies the path to the pull secret file.
--
. Update the global pull secret for your cluster by entering the following command. Note that this update rolls out to all nodes, which can take some time depending on the size of your cluster.
+
[source,terminal]
----
$ oc set data secret/pull-secret -n openshift-config \
  --from-file=.dockerconfigjson=<pull_secret_location>
----
+
--
where:

`<pull_secret_location>`:: Specifies the path to the new pull secret file.
--
+
This merges your additional pull secret with the original HostedCluster pull secret, making it available to all nodes in the cluster.

. Optional: Modify the additional pull secret added by entering the following command:
+
[source,terminal]
----
$ oc edit secret additional-pull-secret -n kube-system
----
+
The secret must contain a valid DockerConfigJSON format.
+
.Example pull secret
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: additional-pull-secret
  namespace: kube-system
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: <base64-encoded-docker-config-json>
----
+
This will result in the following states of the each pull secret:

* *Original*: immutable
* *Additional*: mutable
* *Global*: final state of both the original and additional pull secrets

. Optional: Delete the additional pull secret added by entering the following command:
+
[source,terminal]
----
$ oc delete secret additional-pull-secret -n kube-system
----
+
This will trigger the automatic cleanup process across your nodes.

ifeval::["{context}" == "using-image-pull-secrets"]
:!image-pull-secrets:
endif::[]
