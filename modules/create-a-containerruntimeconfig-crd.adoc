// Module included in the following assemblies:
//
// * post_installation_configuration/machine-configuration-tasks.adoc

[id="create-a-containerruntimeconfig_{context}"]
= Creating a `ContainerRuntimeConfig` CR to edit CRI-O parameters

You can change some CRI-O runtime settings for the nodes associated with a specific machine config pool (MCP) using a `ContainerRuntimeConfig` custom resource (CR). In the CR, you set the configuration values and add a label to match the MCP. The MCO then rebuilds the `crio.conf` and `storage.conf` configuration files on the associated nodes with the updated values.

You can modify the following settings by using a `ContainerRuntimeConfig` CR:

* **PIDs limit**: Sets the `pids_limit` parameter in the `crio.conf` file, which is the maximum number of processes allowed in a container. By default, the limit is 1024.
* **Log level**: Sets the `log_level` parameter in the `crio.conf` file, which is the level of verbosity for log messages. The options are `info`, `fatal`, `panic`, `error`, `warn`, `debug`, and `trace`.  The default is `info`.
* **Overlay size**: Sets the `overlay_size` parameter in the `storage.conf` file, which is the maximum size of a container image. The default is 10 GB.
* **Maximum log size**: Sets the `log_size_max` parameter in the `crio.conf` file, which is the maximum size allowed for the container log file. The default maximum log size is `-1`, which is unlimited. If set to a positive number, the value must be at least 8192 to not be smaller than the `conmon` read buffer. Conmon is a program that monitors communications between a container manager (such as Podman or CRI-O) and the OCI runtime (such as runc or crun) for a single container.

[NOTE]
====
To revert the changes implemented by using a `ContainerRuntimeConfig` CR, you must delete the CR. Removing the label from the machine config pool does not revert the changes.
==== 

The following example configures CRI-O to raise the `pids_limit` parameter to 2048, sets the `log_level` parameter to `debug`, and sets the `overlay_size` parameter to 8 GB on the worker nodes:

.Example `ContainerRuntimeConfig` CR
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: ContainerRuntimeConfig
metadata:
 name: overlay-size
spec:
 machineConfigPoolSelector:
   matchLabels:
     pools.operator.machineconfiguration.openshift.io/worker= ''
 containerRuntimeConfig:
   pidsLimit: 2048
   logLevel: debug
   logSizeMax: 8192
   overlaySize: 8G
EOF
----

.Procedure

To configure CRI-O by using a `ContainerRuntimeConfig` CR: 

. Get the labels in the machine config pool associated with the nodes you want to manage:
+
[source,terminal]
----
$ oc get mcp --show-labels
----
+
.Example output
[source,terminal]
----
NAME     CONFIG                                             UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE    LABELS
master   rendered-master-70bbdb350ba73e6751722d56721546fa   True      False      False      3              3                   3                     0                      145m   machineconfiguration.openshift.io/mco-built-in=,operator.machineconfiguration.openshift.io/required-for-upgrade=,pools.operator.machineconfiguration.openshift.io/master=
worker   rendered-worker-0a6973d53405ec6268ce9e505a82fd72   True      False      False      3              3                   3                     0                      145m   machineconfiguration.openshift.io/mco-built-in=,pools.operator.machineconfiguration.openshift.io/worker=
---- 

. Create a YAML file for the `ContainerRuntimeConfig` CR, similar to the following:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: ContainerRuntimeConfig
metadata:
 name: overlay-size
spec:
 machineConfigPoolSelector:
   matchLabels:
     pools.operator.machineconfiguration.openshift.io/worker= '' <1>
 containerRuntimeConfig:
   logLevel: debug <2>
   logSizeMax: 8192 <3>
   overlaySize: 8G <4>
   pidsLimit: 2048 <5>
----
<1> Specify the machine config pool label.
<2> Set the level of verbosity for log messages, as needed.
<3> Set the maximum size allowed for the container log file, as needed. If set to a positive number, it must be at least `8192`.
<4> Set the maximum size of a container image, as needed. 
<5> Set the maximum number of processes allowed in a container, as needed.

. Create the `ContainerRuntimeConfig` object:
+
[source,terminal]
----
$ oc create -f <file-name>.yaml
----

. Check that a new `containerruntime` machine config is created:
+
[source,terminal]
----
$ oc get machineconfigs | grep containerrun
99-worker-generated-containerruntime   2c9371fbb673b97a6fe8b1c52691999ed3a1bfc2  3.1.0  31s
----
. Monitor the machine config pool as the changes are rolled into the machines until all are shown as ready:
+
[source,terminal]
----
$ oc get mcp worker
----
+
.Example output
+
[source,terminal]
----
NAME    CONFIG               UPDATED  UPDATING  DEGRADED  MACHINECOUNT  READYMACHINECOUNT  UPDATEDMACHINECOUNT  DEGRADEDMACHINECOUNT  AGE
worker  rendered-worker-169  False    True      False     3             1                  1                    0                     9h
----

. Open an `oc debug` session to a worker node and run `chroot /host`.

. Verify the changes in the `crio.conf` file:
+
[source,terminal]
----
$ crio config | egrep 'log_level|pids_limit|log_size_max'
----
+
.Example output
+
[source,terminal]
----
pids_limit = 2048
log_size_max = 10485760
log_level = "debug"
----

. Verify the change in the `storage.conf`file:
+
[source,terminal]
----
$ head -n 7 /etc/containers/storage.conf
----
+
.Example output
+
[source,terminal]
----
[storage]
  driver = "overlay"
  runroot = "/var/run/containers/storage"
  graphroot = "/var/lib/containers/storage"
  [storage.options]
    additionalimagestores = []
    size = "8G"
----
