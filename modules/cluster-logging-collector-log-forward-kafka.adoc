// Module included in the following assemblies:
//
// * observability/logging/log_collection_forwarding/log-forwarding.adoc

:_mod-docs-content-type: PROCEDURE

[id="cluster-logging-collector-log-forward-kafka_{context}"]
= Forwarding logs to a Kafka broker

To configure log forwarding to an external Kafka instance, you must create a `ClusterLogForwarder` custom resource (CR) with an output to that instance, and a pipeline that uses the output. You can include a specific Kafka topic in the output or use the default. The Kafka output can use a TCP (insecure) or TLS (secure TCP) connection.

.Procedure

. Create or edit a YAML file that defines the `ClusterLogForwarder` CR object:
+
[source,yaml]
----
apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: <log_forwarder_name>
  namespace: <log_forwarder_namespace>
spec:
  serviceAccountName:
    name:  <service_account_name> <1>
  outputs:
   - name: app-logs <2>
     type: kafka <3>
     kafka:
       authentication:
         sasl:
           username:
             key: <key>
             secretName: kafka-secret <4>
       url: tls://kafka.example.devlab.com:9093/app-topic <5>
   - name: infra-logs
     type: kafka
     kafka:
       url: tcp://kafka.devlab2.example.com:9093/infra-topic <6>
   - name: audit-logs
     type: kafka
     kafka:
        authentication:
         sasl:
           username:
             key: <key>
             secretName: kafka-secret <6>
        url: tls://kafka.qelab.example.com:9093/audit-topic
  pipelines:
    - name: app-topic 
      inputRefs: <7>
        - application
      outputRefs: <8>
        - app-logs
    - name: infra-topic <9>
      inputRefs:
        - infrastructure
      outputRefs:
        - infra-logs
    - name: audit-topic
      inputRefs:
        - audit
      outputRefs:
        - audit-logs
----
<1> The name of your service account. The service account is only required in multi log forwarder implementations if the log forwarder is not deployed in the `openshift-logging` namespace.
<2> Specify a name for the output.
<3> Specify the `kafka` type.
<4> If you are using a `tls` prefix, you must specify the name of the secret required by the endpoint for TLS communication. The secret must contain a `ca-bundle.crt` key that points to the certificate it represents. In legacy implementations, the secret must exist in the `openshift-logging` project.
<5> Specify the URL and port of the Kafka broker as a valid absolute URL, optionally with a specific topic. You can use the `tcp` (insecure) or `tls` (secure TCP) protocol. If the cluster-wide proxy using the CIDR annotation is enabled, the output must be a server name or FQDN, not an IP address.
<6> Optional: To send an insecure output, use a `tcp` prefix in front of the URL. Also omit the `secret` key and its `name` from this output.
<7> Specify which log types to forward by using the pipeline: `application,` `infrastructure`, or `audit`.
<8> Specify the name of the output to use when forwarding logs with this pipeline.
<9> Optional: Configure multiple outputs to forward logs to other external log aggregators of any supported type:
** A name to describe the pipeline.
** The `inputRefs` is the log type to forward by using the pipeline: `application,` `infrastructure`, or `audit`.
** The `outputRefs` is the name of the output to use.

. Optional: To forward a single output to multiple Kafka brokers, specify an array of Kafka brokers as shown in the following example:
+
[source,yaml]
----
# ...
spec:
  outputs:
  - name: app-logs
    type: kafka
    kafka:  #<1>
    # ...
      brokers: #<2>
        - tls://kafka-broker1.example.com:9093/
        - tls://kafka-broker2.example.com:9093/
      topic: app-topic #<3>
# ...
----
<1> Specify a `kafka` key that has a `brokers` and `topic` key.
<2> Use the `brokers` key to specify an array of one or more brokers.
<3> Use the `topic` key to specify the target topic that receives the logs.

. Apply the `ClusterLogForwarder` CR by running the following command:
+
[source,terminal]
----
$ oc apply -f <filename>.yaml
----
