// Module included in the following assemblies:
//
// *deployment/deployment.adoc

:_mod-docs-content-type: PROCEDURE
[id="app-developer-workflow_{context}"]
= Overriding the low-limit RateLimitPolicy for specific users

[role="_abstract"]
The configured Gateway limits provide a good set of limits for the general case. However, as the developer of the Toystore API, you might want to only allow a certain number of requests for specific users, and a general limit for all other users.

[IMPORTANT]
====
Any new HTTPRoutes are affected by the existing Gateway-level policy. Because you want users to now access this API, you must override that Gateway policy. For simplicity, you can use API keys to authenticate the requests, but other options such as OpenID Connect are also available.
====

.Prerequisites

* Your {prodname} policies are configured as described in xref:platform-engineer-workflow_{context}[].
//TODO FIXME

.Procedure

. Create a new `RateLimitPolicy` in a different namespace to override the default `low-limit` policy created previously and set rate limits for specific users as follows:
+
[source,bash]
----
kubectl apply -f - <<EOF
apiVersion: kuadrant.io/v1
kind: RateLimitPolicy
metadata:
  name: toystore-rlp
  namespace: ${KUADRANT_DEVELOPER_NS}
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: toystore
  limits:
    "general-user":
      rates:

      - limit: 5
        window: 10s
      counters:
      - expression: auth.identity.userid
      when:
      - predicate: "auth.identity.userid != 'bob'"
    "bob-limit":
      rates:
      - limit: 2
        window: 10s
      when:
      - predicate: "auth.identity.userid == 'bob'"
EOF
----
+
It might take a few minutes for the `RateLimitPolicy` to be applied, depending on your cluster.
+
. Check that the `RateLimitPolicy` has a status of `Accepted` and `Enforced` as follows:
+
[source,bash]
----
$ kubectl get ratelimitpolicy -n ${KUADRANT_DEVELOPER_NS} toystore-rlp -o=jsonpath='{.status.conditions[?(@.type=="Accepted")].message}{"\n"}{.status.conditions[?(@.type=="Enforced")].message}'
----

. Check that the status of the `HTTPRoute` is now affected by the `RateLimitPolicy` in the same namespace:
+
[source,bash]
----
$ kubectl get httproute toystore -n ${KUADRANT_DEVELOPER_NS} -o=jsonpath='{.status.parents[0].conditions[?(@.type=="kuadrant.io/RateLimitPolicyAffected")].message}'
----

.Verification

. Send requests as user *alice* as follows:
+
[source,bash]
----
$ while :; do curl -k --write-out '%{http_code}\n' --silent --output /dev/null -H 'Authorization: APIKEY IAMALICE' "https://api.$KUADRANT_ZONE_ROOT_DOMAIN/cars" | grep -E --color "\b(429)\b|$"; sleep 1; done
----
+
You should see HTTP status `200` every second for 5 seconds, followed by HTTP status `429` every second for 5 seconds.

. Send requests as user *bob* as follows:
+
[source,bash]
----
$ while :; do curl -k --write-out '%{http_code}\n' --silent --output /dev/null -H 'Authorization: APIKEY IAMBOB' "https://api.$KUADRANT_ZONE_ROOT_DOMAIN/cars" | grep -E --color "\b(429)\b|$"; sleep 1; done
----
+
You should see HTTP status `200` every second for 2 seconds, followed by HTTP status `429` every second for 8 seconds.

