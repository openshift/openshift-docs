// Module included in the following assemblies:
//
// scalability_and_performance/ztp-deploying-disconnected.adoc

:_module-type: PROCEDURE
[id="ztp-configuring-uefi-secure-boot_{context}"]
= Configuring UEFI secure boot for clusters using PolicyGenTemplate CRs

You can configure UEFI secure boot for vRAN clusters that are deployed using the GitOps ZTP pipeline.

.Prerequisites

* Create a Git repository where you manage your custom site configuration data.

.Procedure

. Create the following `MachineConfig` resource and save it in the `uefi-secure-boot.yaml` file:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: uefi-secure-boot
spec:
  config:
    ignition:
      version: 3.1.0
  kernelArguments:
    - efi=runtime
----

. In your custom `/siteconfig` directory, create a `/sno-extra-manifest` folder and add the `uefi-secure-boot.yaml` file, for example:
+
[source,text]
----
siteconfig
├── site1-sno-du.yaml
├── site2-standard-du.yaml
└── sno-extra-manifest
    └── uefi-secure-boot.yaml
----

. In your `SiteConfig` CR, enter the directory name in the `extraManifestPath` field and set the value for `bootMode` to `UEFISecureBoot`, for example:
+
[source,yaml]
----
apiVersion: ran.openshift.io/v1
kind: SiteConfig
metadata:
  name: "example-cluster"
  namespace: "example-cluster"
spec:
  baseDomain: "ran.base-domain.lab"
  pullSecretRef:
    name: "pull-secret"
  clusterImageSetNameRef: "img4.9.9-x86-64-appsub"
  sshPublicKey: "<ssh_public_key>"
  clusters:
    - clusterName: "example-cluster"
      extraManifestPath: siteconfig/sno-extra-manifest/
      networkType: "OVNKubernetes"
      clusterType: sno
      clusterProfile: du
      clusterLabels:
        group-du-sno: ""
        group-example-cluster: ""
        common-example-cluster: true
        siteName : "example-cluster"
      clusterNetwork:
        - cidr: 10.128.0.0/14
          hostPrefix: 23
      machineNetwork:
        - cidr: 192.168.203.0/24
      serviceNetwork:
        - 172.30.0.0/16
      additionalNTPSources:
        - "2.pool.ntp.org"
      nodes:
        - hostName: "ran.example.lab"
          bmcAddress: "idrac-virtualmedia+https://192.168.200.15/redfish/v1/Systems/System.Embedded.1"
          bmcCredentialsName:
            name: "bmh-secret"
          bootMACAddress: "0c:42:a1:bc:68:c4"
          bootMode: "UEFISecureBoot"
          cpuset: "0-1,52-53"
          nodeNetwork:
            interfaces:
              - name: eno1
                macAddress: "0c:42:a1:bc:68:c4"
            config:
              interfaces:
                - ipv6:
                    enabled: false
                  ipv4:
                    address:
                      - ip: 192.168.203.10
                        prefix-length: 24
                      - ip: 192.168.203.11
                        prefix-length: 24
                      - ip: 192.168.203.12
                        prefix-length: 24
                    enabled: true
                  macAddress: "0c:42:a1:bc:68:c4"
                  name: eno1
                  state: up
                  type: ethernet
              routes:
                config:
                  - destination: 0.0.0.0/0
                    next-hop-address: 192.168.203.9
                    next-hop-interface: eno1
                    table-id: 254
              dns-resolver:
                config:
                  search:
                    - example.com
                  server:
                    - 192.168.203.9
----

. Deploy the cluster.

.Verification

. Open a remote shell to the deployed cluster, for example:
+
[source,terminal]
----
$ oc debug node/node-1.example.com
----

. Verify that the SecureBoot feature is enabled:
+
[source,terminal]
----
sh-4.4# mokutil --sb-state
----
+
.Example output
[source,terminal]
----
SecureBoot enabled
----
