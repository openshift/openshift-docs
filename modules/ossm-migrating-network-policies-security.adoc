// Module included in the following assemblies:
//
// * service-mesh-docs-main/migrating/checklists/ossm-migrating-network-policies.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-migrating-network-policies-security_{context}"]
= Migrating network policies for security reasons

This procedure applies only if you must recreate your network policies first for security reasons.

[IMPORTANT]
====
During the recreation of network policies from {SMProduct} 2 to {SMProduct} 3, both control planes must have access to all workloads and vice versa.
====

.Prerequisites

* You have deployed {ocp-product-title} 4.14 or later.
* You are logged in to the {ocp-product-title} web console as a user with the cluster-admin role.

[IMPORTANT]
====
The `maistra.io/member-of:` label will be removed from the namespaces during migration.
====

.Procedure

. Label namespaces by running the following command:
+
[source,terminal]
----
$ oc label namespace <app-namespace> service-mesh=enabled
----
+
[NOTE]
====
Use a label scoped specifically to your mesh that can be reused for discovery selectors.
====

. Create your network policies:
+
.Example of an Istiod network policy in a mesh namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istiod-basic
  namespace: istio-system
spec:
  ingress:
    - {}
  podSelector:
    matchLabels:
      app: istiod
      istio.io/rev: basic
  policyTypes:
    - Ingress
--
+
.Example of an expose route policy in a mesh namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: expose-route-basic
  namespace: istio-system
spec:
  podSelector:
    matchLabels:
      maistra.io/expose-route: "true"
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              network.openshift.io/policy-group: ingress
  policyTypes:
    - Ingress
--
+
.Example of a default mesh network policy in a mesh namespace
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-mesh
  namespace: istio-system
spec:
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              service-mesh: enabled
  podSelector: {}
  policyTypes:
    - Ingress
----
+
.Example expose route network policy in a httpbin-2 namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-expose-route
  namespace: httpbin-2
spec:
  podSelector:
    matchLabels:
      maistra.io/expose-route: "true"
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              network.openshift.io/policy-group: ingress
  policyTypes:
    - Ingress
--
+
.Example mesh network policy in a httpbin-2 namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-mesh
  namespace: httpbin-2
spec:
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              service-mesh: enabled
  podSelector: {}
  policyTypes:
    - Ingress
--
+
.Example expose route network policy iin a httpbin-3 namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-expose-route
  namespace: httpbin-3
spec:
  podSelector:
    matchLabels:
      maistra.io/expose-route: "true"
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              network.openshift.io/policy-group: ingress
  policyTypes:

--
+
.Example mesh network policy in a httpbin-3 namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-mesh
  namespace: httpbin-3
spec:
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              service-mesh: enabled
  podSelector: {}
  policyTypes:
    - Ingress
--

. Disable network policies in {SMProduct} 2 by setting `spec.security.manageNetworkPolicy` to `false` in your `ServiceMeshConrolPlane` resource.

. Create a second Istiod network policy for {SMProduct} 3:
+
.Example of a second Istiod network policy for {SMProduct} 3
+
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-istiod-v3
  namespace: istio-system
spec:
  ingress:
    - {}
  podSelector:
    matchLabels:
      app: istiod
      istio.io/rev: v3 <1>
  policyTypes:
    - Ingress
----
<1> Must be your current active revision. You can find it by running the following command:
+
[source,terminal]
----
$ oc get istios <istio-name>
----

