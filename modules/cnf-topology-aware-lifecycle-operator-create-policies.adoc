// Module included in the following assemblies:
// Epic CNF-2600 (CNF-2133) (4.10), Story TELCODOCS-285
// * scalability_and_performance/cnf-topology-aware-lifecycle-operator.adoc

:_content-type: PROCEDURE
[id="talo-create-platform-policies_{context}"]
= Creating platform update policies for managed clusters with PolicyGenTemplate

You can create a `PolicyGenTemplate` CR with an {rh-rhacm} policy that updates the targeted clusters from the `ClusterVersion` object to the desired version, which then starts an update.

.Prerequisites

* Install the Topology Aware Lifecycle Operator.
* Provision one or more managed clusters using ZTP.
* Log in as a user with `cluster-admin` privileges.

.Procedure

. Create the `PolicyGenTemplate` CR in `inform` mode, then save the YAML in the `du-upgrade.yaml` file.
+
[source,yaml]
----
apiVersion: ran.openshift.io/v1
kind: PolicyGenTemplate
metadata:
 name: "du-upgrade"
 namespace: "ztp-group-du-sno"
spec:
 bindingRules:
   group-du-sno: "" <1>
 mcp: "master"
 remediationAction: inform
 sourceFiles:
   - fileName: ClusterVersion.yaml <2>
     policyName: "platform-upgrade" <3>
     metadata:
       name: version
     spec:
       channel: "stable-4.9"
       desiredUpdate:
         version: "4.9.15" <4>
----
<1> The policy is targeting all the clusters with the `group-du-sno` label.
<2> A policy is created in the `ClusterVersion` manifest in the `managedClusters`, which then triggers a platform update.
<3> The name of the policy displayed in {rh-rhacm}.
<4> The targeted version of the platform update.

. Create the `PolicyGenTemplate` CR by running the following command:
+
[source,terminal]
----
$ oc create -f du-upgrade.yaml
----

.Verification

. Check if the policies were created by running the following command:
+
[source,terminal]
----
$ oc get policies -A | grep platform-upgrade
----
+
.Example output
+
[source,terminal]
----
cnfdb1                ztp-group-du-sno.du-upgrade-platform-upgrade        inform               NonCompliant       3d18h
cnfdb2                ztp-group-du-sno.du-upgrade-platform-upgrade        inform               NonCompliant       3d18h
ztp-group-du-sno      du-upgrade-platform-upgrade                         inform               NonCompliant       3d18h
----

. Check if the cluster contains the correct version by running the following command:
+
[source,terminal]
----
$ oc get policy ztp-group-du-sno.du-upgrade-platform-upgrade -n cnfdb1 -o jsonpath='{.spec}' | jq
----
+
.Example output
+
[source,terminal]
----
{
  "disabled": false,
  "policy-templates": [
    {
      "objectDefinition": {
        "apiVersion": "policy.open-cluster-management.io/v1",
        "kind": "ConfigurationPolicy",
        "metadata": {
          "name": "du-upgrade-platform-upgrade-config"
        },
        "spec": {
          "namespaceselector": {
            "exclude": [
              "kube-*"
            ],
            "include": [
              "*"
            ]
          },
          "object-templates": [
            {
              "complianceType": "musthave",
              "objectDefinition": {
                "apiVersion": "config.openshift.io/v1",
                "kind": "ClusterVersion",
                "metadata": {
                  "annotations": {
                    "ran.openshift.io/ztp-deploy-wave": "100"
                  },
                  "name": "version" <1>
                },
                "spec": {
                  "channel": "fast-4.9",
                  "desiredUpdate": {
                    "force": false,
                    "version": "4.9.15"
                  }
                }
              }
            }
          ],
          "remediationAction": "inform",
          "severity": "low"
        }
      }
    }
  ],
  "remediationAction": "inform"
----
<1> The desired version information.