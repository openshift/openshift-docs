// Module included in the following assemblies:
//
// * hosted_control_planes/hcp-deploy/hcp-deploy-bm.adoc

:_mod-docs-content-type: PROCEDURE
[id="hcp-bm-svc-pub-strategy_{context}"]
= Configuring the service publishing strategy for bare metal 

Before you create a hosted cluster, it's important to know which service publishing strategy you will use. By default, hosted clusters use the NodePort service publishing strategy because NodePorts are always available without additional infrastructure. However, you can configure the service publishing strategy to use a load balancer.

.Prerequisites

//ADD PREREQS


.Procedure 

. Configure the service publishing strategy:

** If you are using the default NodePort strategy, configure the DNS to point to the hosted cluster compute nodes, not the management cluster nodes.

** For production environments, a LoadBalancer strategy is recommended because it provides certificate handling and automatic DNS resolution. To change the service publishing strategy `LoadBalancer`, create a YAML file that contains the following configuration for the load balancer:
+
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  creationTimestamp: null
  name: <hosted_cluster_namespace>
spec: {}
status: {}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  creationTimestamp: null
  name: capi-provider-role
  namespace: pm-cluster-nodes
rules:
- apiGroups:
  - agent-install.openshift.io
  resources:
  - agents
  verbs:
  - '*'
---
apiVersion: hypershift.openshift.io/v1beta1
kind: HostedCluster
metadata:
  creationTimestamp: null
  name: <hosted_cluster_namespace>
  namespace: <hosted_cluster_namespace>
spec:
  ...
  pullSecret:
    name: <pull_secret>
  release:
    image: quay.io/openshift-release-dev/ocp-release:<ocp_version>-multi
  secretEncryption:
    aescbc:
      activeKey:
        name: <etcd_encryption_key>
    type: aescbc
  services:
  - service: APIServer
    servicePublishingStrategy:
      type: LoadBalancer
  - service: Ignition
    servicePublishingStrategy:
      type: Route
  - service: Konnectivity
    servicePublishingStrategy:
      type: Route
  - service: OAuthServer
    servicePublishingStrategy:
      type: Route
  - service: OIDC
    servicePublishingStrategy:
      type: Route
  sshKey:
    name: <ssh_key>
...
---
apiVersion: hypershift.openshift.io/v1beta1
kind: NodePool
metadata:
  creationTimestamp: null
  name: <hosted_cluster_namespace>
  namespace: <hosted_cluster_namespace>
spec:
  arch: amd64
  clusterName: <hosted_cluster_namespace>
  management:
    autoRepair: false
    upgradeType: InPlace
  nodeDrainTimeout: 0s
  nodeVolumeDetachTimeout: 0s
  platform:
    agent:
      agentLabelSelector: null
    type: Agent
  release:
    image: quay.io/openshift-release-dev/ocp-release:4.18.19-multi
  replicas: 2
status:
  replicas: 0
----

. Apply the load balancer file by entering the following command:
+
[source,terminal]
----
$ oc apply -f <load_balancer_config>.yaml
----

. Monitor cluster creation

. Install MetalLB in the hosted cluster

. Configure the load balancer for ingress

. Update the DNS configuration

. Verification

//Create separate troubleshooting procedure?


