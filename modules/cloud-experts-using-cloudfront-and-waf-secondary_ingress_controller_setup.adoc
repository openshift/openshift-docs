// Module included in the following assemblies:
//
// * cloud_experts_osd_tutorials/cloud-experts-using-cloudfront-and-waf.adoc

:_mod-docs-content-type: PROCEDURE
[id="cloud-experts-using-cloudfront-and-waf-secondary_ingress_controller_setup_{context}"]
= Setting up the secondary ingress controller

[role="_abstract"]
It is necessary to configure a secondary ingress controller to segment your external WAF-protected traffic from your standard (and default) cluster ingress controller. 

.Prerequisites
* A publicly trusted SAN or wildcard certificate for your custom domain, such as `CN=*.apps.example.com`
+
[IMPORTANT]
====
Amazon CloudFront uses HTTPS to communicate with your cluster's secondary ingress controller. As explained in the link:https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-https-cloudfront-to-custom-origin.html[Amazon CloudFront documentation], you cannot use a self-signed certificate for HTTPS communication between CloudFront and your cluster. Amazon CloudFront verifies that the certificate was issued by a trusted certificate authority.
====

.Procedure
. Create a new TLS secret from a private key and a public certificate, where `fullchain.pem` is your full wildcard certificate chain (including any intermediaries) and `privkey.pem` is your wildcard certificate's private key.
+
**For example**:
+
[source,terminal]
----
$ oc -n openshift-ingress create secret tls waf-tls --cert=fullchain.pem --key=privkey.pem
----

. Create a new `IngressController` resource:
+
**For example** `waf-ingress-controller.yaml`:
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1
kind: IngressController
metadata:
  name: cloudfront-waf
  namespace: openshift-ingress-operator
spec:
  domain: apps.example.com
  defaultCertificate:
    name: waf-tls
  endpointPublishingStrategy:
    loadBalancer:
      dnsManagementPolicy: Unmanaged
      providerParameters:
        aws:
          type: NLB
        type: AWS
      scope: External
    type: LoadBalancerService
  routeSelector:
    matchLabels:
     route: waf
----
+
--
where:

* `domain: apps.example.com`:: Replace with the custom domain you want to use for the `IngressController`.
* `routeSelector`:: Filters the set of routes serviced by the Ingress Controller. In this tutorial, we will use the `waf` route selector, but if no value was to be provided, no filtering would occur.
--
. Apply the `IngressController`:
+
**For example**:
+
[source,terminal]
----
$ oc apply -f waf-ingress-controller.yaml
----

. Verify that your IngressController has successfully created an external load balancer:
+
[source,terminal]
----
$ oc -n openshift-ingress get service/router-cloudfront-waf
----
+
**Example output**:
+
[source,terminal]
----
NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP                                                                     PORT(S)                      AGE
router-cloudfront-waf   LoadBalancer   172.30.16.141   a68a838a7f26440bf8647809b61c4bc8-4225395f488830bd.elb.us-east-1.amazonaws.com   80:30606/TCP,443:31065/TCP   2m19s
----