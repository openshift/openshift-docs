// Module included in the following assemblies:
//
// * cicd/pipelines/running-workloads-and-buildah-as-user-namespaces-on-openshift-pipelines.adoc
:_content-type: PROCEDURE

[id="op-running-as-root-user-namespace_{context}"]
= Running buildah as root in a user namespace

If you are using {pipelines-shortname} to run pods in the user namespace, you must pass the annotations that the CRI-O container engine expects. You can add these annotations for all users, or for a specific namespace.

Use {pipelines-shortname} to run pods in the user namespace.

.Procedure

. Edit the `buildah` cluster task:
+
[source,terminal]
----
$ oc edit clustertask buildah
----

. Add the annotations for all users.

. Export the cluster task as a task to the namepsace.

.. Create a new project:
+
[source,terminal]
----
$ oc new-project <project_name>
----

.. Use the `tkn task create` command to automate the creation of a cluster task:
+
[source,terminal]
----
$ tkn task create --from=buildah
----

. Edit the `buildah` cluster task:
+
[source,terminal]
----
$ oc edit task buildah
----

. Add annotations to the task:
+
[source,terminal]
----
...
annotations:
    io.kubernetes.cri-o.userns-mode: "auto"
    io.openshift.builder: "true"
...
----

.Verification

. Get the name of the node where the buidah container is running:
+
[source,terminal]
----
$ oc get pod -o wide
----

. Run a debugging pod on the node where the `buildah` pod is running:
+
[source,terminal]
----
$ oc debug <node-name>
----

. Create a separate virtualized copy of your host environment:
+
[source,terminal]
----
$ chroot /host
----

. List the user namespaces:
+
[source,terminal]
----
$ lsns -t user
----

[NOTE]
====
Although {pipelines-shortname} runs your `buildah` container as a root user, CRI-O runs the container as a user in the host namespace.
====

[IMPORTANT]
====
When you run a command in a user namespace, your container runs as root (user id 0) but has user privileges on the host. {product-title} uses CRI-O as its container runtime interface. CRI-O has a workload feature to run a pod in the user namespace.
====
