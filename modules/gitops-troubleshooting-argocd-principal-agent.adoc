// Module included in the following assembly:
//
// * argocd-agent-installation/gitops-deploying-argocd-applications.adoc

:_mod-docs-content-type: REFERENCE
[id="gitops-troubleshooting-argocd-principal-agent_{context}"]
= Troubleshooting Principal-Agent communication and deployment issues

[role="_abstract"]
Use the following troubleshooting steps if you encounter issues during Principal-Agent communication or application deployment.

Agent cannot connect to the Principal:::

This issue can occur for one or more of the following reasons:

* The Principal or Agent pods are not healthy.
* The hostname of the principal, exposed via Route in the Agent Helm chart (`server` parameter in the `values.yaml` file or the `--set server` flag) is incorrect.
* Required certificates or secrets were not created correctly.

To resolve this issue:
--
* Verify that the Principal and Agent pods are running and healthy.
* Confirm that the `server` parameter in the Agent Helm chart matches the hostname of the principal, exposed via Route.
* Check that the certificates and secrets required for Principal-Agent communication exist in the correct namespaces.
--
Agent cannot connect to Redis:::

You see the following connection error messages in agent pod logs:

[source,terminal]
----
redis: connection pool: failed to dial after 2 attempts: dial tcp xxx.xx.xx.xxx:6379: i/o timeout
level=error msg="Failed to get cluster info from cache" error="dial tcp 172.30.60.217:6379: i/o timeout" event=addClusterCacheInfoUpdateToQueue module=Agent
level=error msg="Failed to get cluster info from cache" error="NOAUTH Authentication required." event=addClusterCacheInfoUpdateToQueue module=Agent
----

This issue can occur if one or more of the following conditions are true:

* The Redis pod is not healthy.
* The Redis address specified in the Agent Helm chart (`redisAddress` in `values.yaml` or the `--set redisAddress` flag) is incorrect.
* The Redis secret name (`argoCdRedisSecretName`) is incorrect or the secret does not exist in the Agent's namespace.
* The key name containing the Redis password (`argoCdRedisPasswordKey`) is incorrect or missing from the secret.
* The Redis service is not accessible due to namespace or networking restrictions.
* A `NetworkPolicy` is blocking API calls from the Agent to Redis.

To resolve this issue:
--
* Verify that the Redis pod is running and healthy.
* Check that the Redis service and secret configuration in the Helm chart match the expected values.
* Ensure that no `NetworkPolicy` objects are preventing communication between the Agent and Redis.
--
Agent handshake with Principal fails:::

You might see the following warning in the Agent pod logs:

[source,terminal]
----
level=warning msg="Auth failure: rpc error: code = Unavailable desc = connection error: desc = \"transport: authentication handshake failed: tls: failed to verify certificate: x509: certificate is valid for openshift-gitops-agent-principal--generated, not openshift-gitops-agent-principal-argocd.apps.dcrs-h.ocp-dhte-citc.com\" (retrying in 1.44s)"
----

This failure usually occurs when:

* The Principal component automatically generates insecure TLS certificates (`.spec.argoCDAgent.principal.tls.insecureGenerate: true`).
* The Agent is configured to validate certificates (`tlsClientInSecure` is set to `false` in the Helm install command).

To resolve this issue, perform one of the following actions:
--
* Disable certificate validation at the Agent by setting `tlsClientInSecure=true`.
+
[WARNING]
====
The `tlsClientInSecure=true` setting disables TLS verification and is insecure. Do not use it in production environments.
====
* Disable automatic certificate generation at the Principal component by setting `insecureGenerate: false`.
--
Agent cannot view Workload Cluster resources:::

You might view the following error in the Argo CD Web UI:
+
[source,terminal]
----
Resource not found in cluster: apps/v1/Deployment:(resource-name)
Please update your resource specification to use the latest Kubernetes API resources supported by the target cluster. The recommended syntax is apps/v1/Deployment:guestbook-ui
----
+
In addition, you might view the following error in the Managed or Autonomous Agent pod logs:
+
[source,terminal]
----
time="(...)" level=error msg="could not request resource: pods \"(...)\" is forbidden: User \"system:serviceaccount:argocd:argocd-agent-agent\" cannot get resource \"pods\" in API group \"\" in the namespace \"guestbook\"" method=processIncomingResourceRequest
----
+
These errors occurs when the Argo CD Agent does not have the necessary permissions to view resources outside the namespace in which it is installed. To resolve this issue, ensure that the Agent has appropriate access to the required namespace.