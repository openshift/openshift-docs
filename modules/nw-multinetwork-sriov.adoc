// Module name: nw_multinetwork-sriov.adoc
// Module included in the following assemblies:
//
// * networking/managing_multinetworking.adoc

:image-prefix: ose

ifdef::openshift-origin[]
:image-prefix: origin
endif::openshift-origin[]

[id="nw-multinetwork-sriov_{context}"]
= Configuring SR-IOV

{product-title} includes the capability to use SR-IOV hardware on
{product-title} nodes, which enables you to attach SR-IOV virtual function (VF)
interfaces to Pods in addition to other network interfaces.

Two components are required to provide this capability: the SR-IOV network
device plug-in and the SR-IOV CNI plug-in.

* The SR-IOV network device plug-in is a Kubernetes device plug-in for
discovering, advertising, and allocating SR-IOV network virtual function (VF)
resources. Device plug-ins are used in Kubernetes to enable the use of limited
resources, typically in physical devices. Device plug-ins give the Kubernetes
scheduler awareness of which resources are exhausted, allowing Pods to be
scheduled to worker nodes that have sufficient resources available.

* The SR-IOV CNI plug-in plumbs VF interfaces allocated from the SR-IOV device
plug-in directly into a Pod.

You can use the {product-title} console to install SR-IOV, by deploying,
the SR-IOV Network Operator.  The SR-IOV Network Operator
creates and manages the components of the SR-IOV stack end-to-end. The operator
provides following features:

* Discover the SR-IOV network device in cluster.
* Initialize the supported SR-IOV NIC models on nodes.
* Provision the SR-IOV network device plugin on nodes.
* Provision the SR-IOV CNI plugin executable on nodes.
* Provision the SR-IOV admission controller in cluster.
* Manage configuration of SR-IOV network device plugin.
* Generate NetworkAttachmentDefinition custom resources for the SR-IOV CNI
plugin.

[NOTE]
====
The SR-IOV admission controller is enabled by default, and cannot be disabled by
user.
====

== Supported Devices

The following Network Interface Card (NIC) models are supported in
{product-title}:

* Intel XXV710-DA2 25G card with vendor ID 0x8086 and device ID 0x158b
* Mellanox MT27710 Family [ConnectX-4 Lx] 25G card with vendor ID 0x15b3
and device ID 0x1015
* Mellanox MT27800 Family [ConnectX-5] 100G card with vendor ID 0x15b3
and device ID 0x1017

== Install SR-IOV Network Operator

[NOTE]
====
User can choose to install the SR-IOV Network Operator by the CLI or 
by the web console. Only one instance of the SR-IOV Network Operator is allowed
to be deployed in a cluster
Following the directions below to install by the CLI.
====

.Procedure

. Create Namespaces for the SR-IOV Network Operator
+
[NOTE]
====
You can also create the Namespaces in the web console using the *Administration*
 -> *Namespaces* page.
====

.. Create Namespace `openshift-sriov-network-operator` for the SR-IOV Network
Operator (for example, `sriov-namespace.yaml`):
+
----
apiVersion: v1
kind: Namespace
metadata:
  name: openshift-sriov-network-operator
  labels:
    openshift.io/run-level: "1"
----

.. Run the following command to create the namespace:
+
----
$ oc create -f <file-name>.yaml
----
+
For example:
+
----
$ oc create -f sriov-namespace.yaml
----

. Install the SR-IOV Network Operator in the namespace by creating the following
objects:
.. Create a OperatorGroup for the SR-IOV Network Operator (for example,
`sriov-operatorgroup.yaml`)
+
----
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: sriov-network-operators
  namespace: openshift-sriov-network-operator
spec:
  targetNamespaces:
  - openshift-sriov-network-operator
----

.. Run the following command to create the OperatorGroup:
+
----
$ oc create -f <file-name>.yaml
----
+
For example:
+
----
$ oc create -f sriov-og.yaml
----

.. Use the following command to get the `channel` value required for the next
step.
+
----
$ oc get packagemanifest sriov-network-operator -n openshift-marketplace -o jsonpath='{.status.channels[].name}'

preview
----

.. Create a Subscription object YAML file (for example, `sriov-sub.yaml`) to
subscribe a Namespace to an Operator.
+
.Example Subscription
[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: sriov-network-operator-subsription
  namespace: openshift-sriov-network-operator
spec:
  channel: preview <2>
  name: sriov-network-operator
  source: redhat-operators <1>
  sourceNamespace: openshift-marketplace
----
<1> You must specify the `redhat-operators` for the `source`.
<2> Specify the `.status.channels[].name` value from the previous step.

.. Create the Subscription object:
+
----
$ oc create -f <file-name>.yaml
----
+
For example:
+
----
$ oc create -f sriov-sub.yaml
----

.. Change to the `sriov-network-operator` project:
+
----
$ oc project sriov-network-operator

Now using project "sriov-network-operator"
----

[NOTE]
====
The SR-IOV Network Operator can also be install through the web console 
following the directions below.

Before that, you have to create the `Namespace` and `OperatorGroup` as mentioned
in above section.
====

.Procedure

. Install the SR-IOV Network Operator using the {product-title} web console:

.. In the {product-title} web console, click *Catalog* -> *OperatorHub*.

.. Choose  *SR-IOV Network Operator* from the list of available Operators, and
click *Install*.

.. On the *Create Operator Subscription* page, under *A specific namespace on
the cluster* select *sriov-network-operator*. Then, click *Subscribe*.

. Verify the operator installations:

.. Switch to the *Catalog* → *Installed Operators* page.

.. Ensure that *SR-IOV Network Operator* is listed in the
*riov-network-operator* project with a *Status* of *InstallSucceeded*.

+
[NOTE]
====
During installation an operator might display a *Failed* status. If the operator
then installs with an *InstallSucceeded* message, you can safely ignore
the *Failed* message.
====

+
If the operator does not appear as installed, to troubleshoot further:

+
* Switch to the *Catalog* → *Operator Management* page and inspect
the *Operator Subscriptions* and *Install Plans* tabs for any failure or errors
under *Status*.
* Switch to the *Workloads* → *Pods* page and check the logs in any Pods in the
`sriov-network-operator` projects that are reporting issues.

== Discover SR-IOV network devices

After the SR-IOV network Operator has been install successfully. The operator
will try to discover all the SR-IOV capable network devices on worker nodes.
User can find those information from the `SriovNetworkNodeState` Custom 
Resources, which are generated and updated by the operator automatically. 

One CR is created for each worker node, and shares the same name as the node. In
the interface list, you can find the information of the network devices.  

You should never have to modify this CRD, nor the CRs. 

The following is an example of a typical Custom Resource for
`SriovNetworkNodeState`.

[source,yaml]
----
apiVersion: sriovnetwork.openshift.io/v1
kind: SriovNetworkNodeState
metadata:
  creationTimestamp: "2019-08-27T06:01:36Z"
  generation: 1
  name: node-25
  namespace: openshift-sriov-network-operator
  ownerReferences:
  - apiVersion: sriovnetwork.openshift.io/v1
    blockOwnerDeletion: true
    controller: true
    kind: SriovNetworkNodePolicy
    name: default
    uid: 20c3c0f9-c890-11e9-91f7-0028ccd628ee
  resourceVersion: "2639363"
  uid: 2103a9fe-c890-11e9-91f7-0028ccd628ee
spec:
  dpConfigVersion: d41d8cd98f00b204e9800998ecf8427e
status:
  interfaces:
  - deviceID: "1017"
    driver: mlx5_core
    mtu: 1500
    name: ens785f0
    pciAddress: "0000:18:00.0"
    totalvfs: 8
    vendor: 15b3
  - deviceID: "1017"
    driver: mlx5_core
    mtu: 1500
    name: ens785f1
    pciAddress: "0000:18:00.1"
    totalvfs: 8
    vendor: 15b3
  - deviceID: 158b
    driver: i40e
    mtu: 1500
    name: ens817f0
    pciAddress: 0000:81:00.0
    totalvfs: 64
    vendor: "8086"
  - deviceID: 158b
    driver: i40e
    mtu: 1500
    name: ens817f1
    pciAddress: 0000:81:00.1
    totalvfs: 64
    vendor: "8086"
  - deviceID: 158b
    driver: i40e
    mtu: 1500
    name: ens803f0
    pciAddress: 0000:86:00.0
    totalvfs: 64
    vendor: "8086"
  syncStatus: Succeeded
----

== Configuring SR-IOV network devices

The SR-IOV Network Operator introduces `SriovNetworkNodePolicy` Custom Resource
Definition (CRD) to define the SR-IOV network device and the configuration of
SR-IOV device plugin

You should never have to modify this CRD. To make changes to your deployment,
create and modify a specific Custom Resource (CR). Instructions for creating or 
modifying a CR are provided in this documentation as appropriate.

[NOTE]
=====
To make the configuration change take effect, creating or modifying the Custom
Resource of `SriovNetworkNodePolicy` may trigger operator to drain the nodes,
and in some cases reboot the nodes.

The whole process may take several minutes. All configuration changes shall
have been applied until all the pods in `openshift-sriov-network-operator`
namespace are in `Running` status.
=====

The following is an example of a typical Custom Resource for
`SriovNetworkNodePolicy`.

[source,yaml]
----
apiVersion: sriovnetwork.openshift.io/v1
kind: SriovNetworkNodePolicy
metadata:
  name: policy-example <1>
  namespace: openshift-sriov-network-operator <2>
spec:
  resourceName: sriov <3>
  nodeSelector:
    feature.node.kubernetes.io/network-sriov.capable: "true" <4>
  priority: 99 <5>
  mtu: 9000 <6>
  numVfs: 16 <7>
  nicSelector: <8>
    vendor: "15b3" <8>
    deviceID: "" <9>
    pfName: ["eno3", "eno4"] <10>
    rootDevices: ["0000:02:00.0", "0000:02:00.1"] <11>
  deviceType: netdevice <12>
  isRdma: false <13>
----
<1> The name of the CR.
<2> The namespace of the CR, this must be in the same namespace of operator.
<3> The resource name of SR-IOV device plugin. Prefix `openshift.io/` will be
added when it's referred in Pod spec. It's allowed to create multiple CRs
of `SriovNetworkNodePolicy` for one resource name.
<4> The node selector to select which node to be configured. User can choose to
label the nodes manually or with tools like Kubernetes Node Feature Discovery.
Only SR-IOV network devices on selected nodes will be configured. And the SR-IOV
CNI plugin and device plugin will be only deployed on selected nodes.
<5> The priority of the policy,  the larger number gets lower priority.
Range from 0 to 99.
<6> The MTU of the virtual functions. Range from 1 to 9000. Leave it blank if
you don't need to change the MTU.
<7> The number of the virtual functions is to be created for each SR-IOV
physical network device.
<8> The NIC selector selects the NIC to be configured. You don't have to specify
all the fields. However it is recommended to select the NICs as specifically as
possible, in order to minimize the possibility of overlapping cross policies.
And if you specify both `pfName` and `rootDevices` at the same time, which is
recommended, please make sure they point to the identical devices.
<9> The vendor hex code of SR-IoV device. Allowed value "8086", "15b3".
<10> The device hex code of SR-IoV device. Allowed value "158b", "1015", "1017".
<11> The names of SR-IoV physical function.
<12> The PCI addresses of SR-IoV physical function. 
<13> The driver type of the virtual functions. Allowed value "netdevice",
"vfio-pci". Defaults to "netdevice".
<14> The RDMA mode. Defaults to false. In this release, only RoCE mode are
supported, and only for Mellanox NICs. 

== Configuring SR-IOV networks

The SR-IOV Network Operator also introduces a CRD `SriovNetwork` for creating
the Custom Resource of `NetworkAttachmentDefinition` of SR-IOV CNI plugin. When
you create a CR of `SriovNetwork`, the operator will created a CR of
`NetworkAttachmentDefinition` accordingly.

You should never have to modify this CRD. Instructions for creating or 
modifying a CR are provided in this documentation as appropriate.

[NOTE]
=====
You shall not modify or delete a Custom Resource of `SriovNetwork`, when it has
been used by any running Pods.
=====

The following is an example of a typical Custom Resource for
`SriovNetwork`.

[source,yaml]
----
apiVersion: sriovnetwork.openshift.io/v1
kind: SriovNetwork
metadata:
  name: sriov-conf <1>
  namespace: openshift-sriov-network-operator <2>
spec:
  networkNamespace: default <3>
  ipam: | <4>
    {
      "type": "dhcp"
    }
  vlan: 0 <5>
  resourceName: sriov <6>
----
<1> The name of the CR. The generated `NetworkAttachmentDefinition` CR will use
the same name.
<2> The namespace of the CR, this must be in the same namespace of operator.
<3> The namespace where the `NetworkAttachmentDefinition` CR will be created.
<4> The IPAM configuration for SR-IOV CNI plugin.
<5> The VLAN ID for SR-IOV CNI plugin. Range from 0 to 4095, default to 0.
<6> The SRIOV Network device plugin endpoint resource name. It shall matches
the `resourceName` defined in the `SriovNetworkNodePolicy` CR.

== Configuring additional interfaces using SR-IOV

. Create a YAML file for a Pod which references the name of the
`NetworkAttachmentDefinition` and requests one `openshift.io/sriov` resource:
+
[NOTE]
=====
The SR-IoV admission controller will inject the `resource` field automatically
if a NetworkAttachmentDefinition CR of SRIOV CNI plugin is referred in the Pod
annotation.
=====
+
[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: sriovsamplepod
  annotations:
    k8s.v1.cni.cncf.io/networks: sriov-conf
spec:
  containers:
  - name: sriovsamplepod
    command: ["/bin/bash", "-c", "sleep 2000000000000"]
    image: centos/tools
----

. Run the following command to create the `sriovsamplepod` Pod:
+
----
$ oc create -f sriovsamplepod.yaml
----

. View the additional interface by executing the `ip` command:
+
----
$ oc exec sriovsamplepod -- ip a
----
