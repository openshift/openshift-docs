// Module included in the following assemblies:
//
// * networking/aws-load-balancer-operator.adoc

:_mod-docs-content-type: PROCEDURE
[id="aws-installing-an-aws-load-balancer-operator_{context}"]
= Installing an AWS Load Balancer Operator
You can install an AWS Load Balancer Operator (ALBO) if you meet certain requirements.

.Prerequisites
ifndef::openshift-rosa[]
* You have an existing {product-title} cluster with bring-your-own-VPC (BYO-VPC) configuration across multiple availability zones (AZ) installed in {hcp-title-first} mode.
* You have access to the cluster as a user with the `dedicated-admin` role.
* You have access to modify the VPC and subnets of the created {product-title} cluster.
* You have installed the {product-title} * You have installed the ROSA CLI (`rosa`).
* You have installed the {AWS} CLI.
* You have installed the OpenShift CLI (oc).
* You are using {product-title} 4.13 or later.
endif::openshift-rosa[]

ifdef::openshift-rosa[]
You have an existing {product-title} (ROSA) cluster with bring-your-own-VPC (BYO-VPC) configuration across multiple availability zones (AZ) installed in {hcp-title-first} mode.

* You have access to the cluster as a user with the `dedicated-admin` role.
* You have access to modify the VPC and subnets of the created ROSA cluster.
* You have installed the ROSA CLI (`rosa`).
* You have installed the {AWS} CLI.
* You have installed the OpenShift CLI (oc).
* You are using {product-title} 4.13 or later.
endif::openshift-rosa[]

[IMPORTANT]
====
When installing an ALBO for use with
ifndef::openshift-rosa[]
a {product-title}
endif::openshift-rosa[]
ifdef::openshift-rosa[]
a ROSA
endif::openshift-rosa[]
cluster in an AWS Local Zone (LZ), you must enable the AWS LZ for the account, and AWS Elastic Load Balancing v2 (ELBv2) services must be available in the AWS LZ.
====

.Procedure

. Identify the cluster infrastructure ID and the cluster OpenID Connect (OIDC) DNS by running the following commands:
+
.. Identify the
ifndef::openshift-rosa[]
{product-title}
endif::openshift-rosa[]
ifdef::openshift-rosa[]
ROSA
endif::openshift-rosa[]
cluster INFRA ID:
+
[source,terminal]
----
$ rosa describe cluster --cluster=<cluster_name> | grep -i 'Infra ID' <1>
----
<1> Use this command on an ROSA {sts-first} cluster.
//ifdef needed for "ROSA"?
+
[source,terminal]
----
$ rosa describe cluster --cluster=<cluster_name> | grep  -i  '^ID' <1>
----
<1> Use this command on an {hcp-title-first} cluster.
+
or
+
[source,terminal]
----
$ oc get infrastructure cluster -o json | jq -r '.status.infrastructureName'
----
+
ifndef::openshift-rosa[]
.. Identify the{product-title} cluster OIDC DNS by entering the following CLI command:
+
[source, terminal]
----
$ oc get authentication.config cluster -o=jsonpath="{.spec.serviceAccountIssuer}"
<url_oidc_dns> <1>
----
<1> An example of `<url_oidc_dns>` is `https://oidc.op1.openshiftapps.com/28q7fsn54m2jjts3kd556aij4mu9omah`.
endif::openshift-rosa[]
ifdef::openshift-rosa[]
.. Identify the{product-title} cluster OIDC DNS by entering the following CLI command:
+
[source, terminal]
----
$ rosa describe cluster --cluster=<cluster_name> | grep -i 'OIDC'
----
endif::openshift-rosa[]
.. Locate the OIDC Amazon Resource Name (ARN) information for yoru cluster by Logging in to the {aws-short} Web Console and then navigate to *IAM* -> *Access management* -> *Identity providers*. An OIDC ARN example is `arn:aws:iam::<aws_account_number>:oidc-provider/<oidc_dns_url>`.
+
Save the output from the commands. You will use this information in future steps within this procedure.

. Create the AWS IAM policy required for the AWS Load Balancer Operator (ALBO) by using the AWS CLI:
+
.. Log in to the
ifndef::openshift-rosa[]
{product-title}
endif::openshift-rosa[]
ifdef::openshift-rosa[]
ROSA
endif::openshift-rosa[]
cluster as a user with the `dedicated-admin` role and create a new project using the following command:
+
[source, terminal]
----
$ oc new-project aws-load-balancer-operator
----
+
.. Assign the following trust policy to the created AWS IAM role:
+
[source,terminal]
----
$ IDP='{Cluster_OIDC_Endpoint}'
$ IDP_ARN="arn:aws:iam::{AWS_AccountNo}:oidc-provider/${IDP}" <1>
$ cat <<EOF > albo-operator-trusted-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "${IDP_ARN}"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "${IDP}:sub": "system:serviceaccount:aws-load-balancer-operator:aws-load-balancer-operator-controller-manager"
                }
            }
        }
    ]
}
EOF
----
<1> Replace '{AWS_AccountNo}' with your AWS account number and '{Cluster_OIDC_Endpoint}' with the OIDC DNS identified earlier in this procedure.
+
[IMPORTANT]
====
Do not include the `https` portion of the OIDC DNS URL when replacing `{Cluster_OIDC_Endpoint}` with the OIDC DNS you identified earlier. Only the alphanumeric information that follows the `/` within the URL is needed.
====
+
For more information on assigning trust policies to AWS IAM roles, see link:https://aws.amazon.com/blogs/security/how-to-use-trust-policies-with-iam-roles/[How to use trust policies with IAM roles].
+
.. Create a role by using the trust policy:
+
[source, terminal]
----
$ aws iam create-role --role-name albo-operator --assume-role-policy-document file://albo-operator-trusted-policy.json
----
+
.Example output
[source, terminal]
----
ROLE arn:aws:iam::<aws_account_number>:role/albo-operator	2023-08-02T12:13:22Z <1>
ASSUMEROLEPOLICYDOCUMENT	2012-10-17
STATEMENT	sts:AssumeRoleWithWebIdentity	Allow
STRINGEQUALS	system:serviceaccount:aws-load-balancer-operator:aws-load-balancer-controller-manager
PRINCIPAL	arn:aws:iam:<aws_account_number>:oidc-provider/<oidc_provider_id>
----
<1> Note the ARN of the AWS IAM role that was created for the AWS Load Balancer Operator, such as `arn:aws:iam::777777777777:role/albo-operator`.
+
.. Verify that the role was created by the trust policy:
+
[source, terminal]
----
$ OPERATOR_ROLE_ARN=$(aws iam get-role --role-name albo-operator --output json | jq -r '.Role.Arn')
----
+
.. Output information for the role:
[source, terminal]
----
$ echo $OPERATOR_ROLE_ARN
----
+
.Output example
[source, terminal]
----
ROLE arn:aws:iam::<aws_account_number>:role/aws-load-balancer-operator	2023-08-02T12:13:22Z <1>
ASSUMEROLEPOLICYDOCUMENT	2012-10-17
STATEMENT	sts:AssumeRoleWithWebIdentity	Allow
STRINGEQUALS	system:serviceaccount:aws-load-balancer-operator:aws-load-balancer-controller-manager
PRINCIPAL	arn:aws:iam:<aws_account_number>:oidc-provider/<oidc_provider_id> <2>
----
<1> Where `<aws_account_number>` is the AWS account ID. Note the Amazon Resource Name (ARN) of an AWS IAM role that was created for the AWS Load Balancer Operator, such as `arn:aws:iam::777777777777:role/albo-operator`.
<2> Where `<oidc_provider_id>` is your OIDC identity provider’s publicly available URL. TAKEN FROM https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html
+
For more information on creating AWS IAM roles, see link:https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create.html[Creating IAM roles].
+
.. Attach the operator's permission policy to the role:
+
[source, terminal]
----
$ curl -o albo-operator-permission-policy.json https://raw.githubusercontent.com/openshift/aws-load-balancer-operator/release-1.1/hack/operator-permission-policy.json
$ aws iam put-role-policy --role-name albo-operator --policy-name perms-policy-albo-operator --policy-document file://albo-operator-permission-policy.json
----
+
For more information on adding AWS IAM permissions to AWS IAM roles, see link:https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_manage-attach-detach.html[Adding and removing IAM identity permissions].
+
.. Generate the operator's AWS credentials:
+
[source,terminal]
----
$ cat <<EOF> albo-operator-aws-credentials.cfg
[default]
sts_regional_endpoints = regional
role_arn = ${OPERATOR_ROLE_ARN}
web_identity_token_file = /var/run/secrets/openshift/serviceaccount/token
EOF
----
+
For more information about formatting credentials files, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html/authentication_and_authorization/managing-cloud-provider-credentials#cco-mode-sts[Using manual mode with Amazon Web Services Security Token Service].
+
.. Create the operator's credentials secret with the generated AWS credentials:
+
[source, terminal]
----
$ oc -n aws-load-balancer-operator create secret generic aws-load-balancer-operator --from-file=credentials=albo-operator-aws-credentials.cfg
----

. Create the AWS IAM policy required for the AWS Load Balancer Controller (ALBC) by using the AWS CLI:
+
.. Generate a trust policy file for your identity provider. The following example uses OpenID Connect:
+
[source,terminal]
----
$ IDP='{Cluster_OIDC_Endpoint}'
$ IDP_ARN="arn:aws:iam::{AWS_AccountNo}:oidc-provider/${IDP}"
$ cat <<EOF > albo-controller-trusted-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "${IDP_ARN}"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "${IDP}:sub": "system:serviceaccount:aws-load-balancer-operator:aws-load-balancer-controller-cluster"
                }
            }
        }
    ]
}
EOF
----
+
.. Create a role by using the trust policy:
+
[source, terminal]
----
$ aws iam create-role --role-name albo-controller --assume-role-policy-document file://albo-controller-trusted-policy.json
----
+
.Example output
+
[source,terminal]
----
ROLE	arn:aws:iam::777777777777:role/albo-controller	2023-08-02T12:13:22Z 
ASSUMEROLEPOLICYDOCUMENT	2012-10-17
STATEMENT	sts:AssumeRoleWithWebIdentity	Allow
STRINGEQUALS	system:serviceaccount:aws-load-balancer-operator:aws-load-balancer-controller-cluster
PRINCIPAL	arn:aws:iam:777777777777:oidc-provider/<oidc-provider-id>
----
+
.. Verify that the role was created by the trust policy:
+
[source, terminal]
----
$ CONTROLLER_ROLE_ARN=$(aws iam get-role --role-name albo-controller --output json | jq -r '.Role.Arn')
----
+
.. Output information for the role:
[source, terminal]
----
$ echo $CONTROLLER_ROLE_ARN
----
+
Output example
[source, terminal]
----
ROLE arn:aws:iam::<aws_account_number>:role/albo-controller	2023-08-02T12:13:22Z <1>
ASSUMEROLEPOLICYDOCUMENT	2012-10-17
STATEMENT	sts:AssumeRoleWithWebIdentity	Allow
STRINGEQUALS	system:serviceaccount:aws-load-balancer-operator:aws-load-balancer-controller-cluster
PRINCIPAL	arn:aws:iam:<aws_account_number>:oidc-provider/<oidc_provider_id> <2>
----
<1> Where `<aws_account_number>` is the AWS account ID. Note the Amazon Resource Name (ARN) of an AWS IAM role that was created for the AWS Load Balancer Operator, such as `arn:aws:iam::777777777777:role/albo-controller`.
<2> Where `<oidc_provider_id>` is your OIDC identity provider’s publicly available URL. TAKEN FROM https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html
+
.. Attach the controller's permission policy to the role:
+
[source,terminal]
----
$ curl -o albo-controller-permission-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json
$ aws iam put-role-policy --role-name albo-controller --policy-name perms-policy-albo-controller --policy-document file://albo-controller-permission-policy.json
----
+
.. Generate the controller's AWS credentials:
+
[source,terminal]
----
$ cat <<EOF > albo-controller-aws-credentials.cfg
[default]
sts_regional_endpoints = regional
role_arn = ${CONTROLLER_ROLE_ARN}
web_identity_token_file = /var/run/secrets/openshift/serviceaccount/token
EOF
----
+
.. Create the controller's credentials secret by using the generated AWS credentials:
+
[source,terminal]
----
$ oc -n aws-load-balancer-operator create secret generic aws-load-balancer-controller-cluster --from-file=credentials=albo-controller-aws-credentials.cfg
----
+
. Add the tags necessary for subnet discovery to the ROSA HCP cluster (ifdef needed for ROSA)?:
.. Add the following `{Key: Value}` tag to the VPC hosting the
ifndef::openshift-rosa[]
{product-title}
endif::openshift-rosa[]
ifdef::openshift-rosa[]
ROSA
endif::openshift-rosa[]
cluster and to all its subnets. Replace `{Cluster Infra ID}` with the Infra ID specified previously:
+
[source, terminal]
----
kubernetes.io/cluster/${Cluster Infra ID}:owned
----
+
.. Add the following ELBv2 `{Key: Value}` tags to the private subnets and, optionally, to the public subnets:

* Private subnets: `kubernetes.io/role/internal-elb:1`
* Public subnets: `kubernetes.io/role/elb:1`
+
[NOTE]
====
Internet-facing and internal load balancers will be created within the AZ to which these subnets belong.
====
+
For more information on adding tags to AWS resources, including VPCs and subnets, see link:https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html[Tag your Amazon EC2 resources].
+
[IMPORTANT]
====
ELBv2 resources (such as ALBs and NLBs) created by ALBO do not inherit custom tags set for
ifndef::openshift-rosa[]
{product-title}
endif::openshift-rosa[]
ifdef::openshift-rosa[]
ROSA
endif::openshift-rosa[]
clusters. You must set tags separately for these resources.
====

. Create an `OperatorGroup` resource for the AWS Load Balancer Operator:
+
[source,yaml]
----
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: aws-load-balancer-operator
  namespace: aws-load-balancer-operator
spec:
  targetNamespaces: []
# ...
----

. Create a `Subscription` resource for the AWS Load Balancer Operator:
+
[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: aws-load-balancer-operator
  namespace: aws-load-balancer-operator
spec:
  channel: stable-v1
  name: aws-load-balancer-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  config:
    env:
    - name: ROLEARN
      value: "<role_arn>" <1>
# ...
----
<1> Specifies the ARN role to be used in the CredentialsRequest to provision the AWS credentials for the AWS Load Balancer Operator. An example for <albo_role_arn> is arn:aws:iam::777777777777:role/albo-operator.

. Create an `AWSLoadBalancerController` resource for the AWS Load Balancer Controller:
+
[source,yaml]
----
apiVersion: networking.olm.openshift.io/v1
kind: AWSLoadBalancerController <1>
metadata:
  name: cluster <2>
spec:
  credentialsRequestConfig:
    stsIAMRoleARN: <role_arn> <3>
# ...
----
<1> Defines the `AWSLoadBalancerController` object.
<2> Defines the AWS Load Balancer Controller name. All related resources use this instance name as a suffix.
<3> Specifies the ARN role of ALBC. The CredentialsRequest object uses this ARN role to provision the AWS credentials. for example, it could be: "arn:aws:iam::777777777777:role/albo-controller".
+
[IMPORTANT]
====
Because AWS ALBCs do not support creating ALBs associated with both AZs and AWS LZs,
ifndef::openshift-rosa[]
{product-title}
endif::openshift-rosa[]
ifdef::openshift-rosa[]
ROSA
endif::openshift-rosa[]
clusters can have ALBs associated exclusively with either AWS LZs or AZs but not both simultaneously.
====
+
For more information regarding AWS ALBC configurations, see the following topics:

* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html/networking/aws-load-balancer-operator-1#nw-multiple-ingress-through-single-alb[Creating multiple ingresses]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html/networking/aws-load-balancer-operator-1#nw-adding-tls-termination_adding-tls-termination[Adding TLS termination]

.Verification

* Confirm successful installation by running the following commands:

. Gather information about pods within the project:
+
[source, terminal]
----
$ oc get pods -n aws-load-balancer-operator
----
. View the logs within the project:
+
[source, terminal]
----
$ oc logs -n aws-load-balancer-operator deployment/aws-load-balancer-operator-controller-manager -c manager
----
For detailed instructions on verifying that the ELBv2 was created for the application running in the
ifndef::openshift-rosa[]
{product-title}
endif::openshift-rosa[]
ifdef::openshift-rosa[]
ROSA
endif::openshift-rosa[]
cluster, see link:https://docs.openshift.com/container-platform/4.13/networking/aws_load_balancer_operator/create-instance-aws-load-balancer-controller.html[Creating an instance of AWS Load Balancer Controller].
