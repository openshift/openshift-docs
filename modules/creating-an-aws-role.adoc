:_newdoc-version: 2.18.4
:_template-generated: 2025-06-24
:_mod-docs-content-type: PROCEDURE

[id="creating-an-aws-role_{context}"]
= Creating an {aws-short} IAM role

Create an {aws-first} IAM role that your service account can assume to securely access AWS resources.

The following procedure demonstrates creating an {aws-short} IAM role by using the {aws-short} CLI. You can alternatively use the Cloud Credential Operator (CCO) utility `ccoctl`. Using the `ccoctl` utility creates many fields in the IAM role policy that are not required by the `ClusterLogForwarder` custom resource (CR). These extra fields are ignored by the CR. However, the `ccoctl` utility provides a convenient way for configuring IAM roles. For more information see link:https://docs.redhat.com/en/documentation/openshift_container_platform/latest/html/authentication_and_authorization/managing-cloud-provider-credentials#cco-short-term-creds[Manual mode with short-term credentials for components].

.Prerequisites

* You have access to an {product-title} cluster with {sts-first} enabled and configured for {aws-short}.
* You have administrator access to the {aws-short} account.
* {aws-short} CLI installed. 

.Procedure

. Create an IAM policy that grants permissions to write logs to CloudWatch.

.. Create a file, for example `cw-iam-role-policy.json`, with the following content:
+
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:PutLogEvents",
                "logs:CreateLogGroup",
                "logs:PutRetentionPolicy",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams"
            ],
            "Resource": "arn:aws:logs:*:*:*"
        }
    ]
}
----

.. Create the IAM policy based on the previous policy definition by running the following command:
+
[source,terminal]
----
$ aws iam create-policy \
  --policy-name cluster-logging-allow \
  --policy-document file://cw-iam-role-policy.json
----
+
Note the `Arn` value of the created policy.

. Create a trust policy to allow the logging service account to assume an IAM role:

.. Create a file, for example `cw-trust-policy.json`, with the following content:  
+
[source,json]
----
{
"Version": "2012-10-17",
"Statement": [
    {
        "Effect": "Allow",
        "Principal": {
            "Federated": "arn:aws:iam::123456789012:oidc-provider/<OPENSHIFT_OIDC_PROVIDER_URL>" //<1>
        },
        "Action": "sts:AssumeRoleWithWebIdentity",
        "Condition": {
            "StringEquals": {
                "<OPENSHIFT_OIDC_PROVIDER_URL>:sub": "system:serviceaccount:openshift-logging:logcollector" //<2>
            }
        }
    }
]
}
----
<1> Replace `<OPENSHIFT_OIDC_PROVIDER_URL>` with the URL of your {product-title} OIDC URL.
<2> The namespace and service account must match the namespace and service account that the log forwarder uses.

. Create an IAM role based on the previously defined trust policy by running the following command:
+
[source,terminal]
----
$ aws iam create-role --role-name openshift-logger --assume-role-policy-document file://cw-trust-policy.json
----
+
Note the `Arn` value of the created role.

. Attach the policy to the role by running the following command:
+
[source,terminal]
----
$ aws iam put-role-policy \ 
  --role-name openshift-logger --policy-name cluster-logging-allow \
  --policy-document file://cw-iam-role-policy.json
----

.Verification
* Verify the role and the permissions policy by running the following command:
+
[source,terminal]
----
$ aws iam get-role --role-name openshift-logger
----
+
.Example output
[source,options="nowrap"]
----
ROLE	arn:aws:iam::123456789012:role/openshift-logger
ASSUMEROLEPOLICYDOCUMENT	2012-10-17
STATEMENT	sts:AssumeRoleWithWebIdentity	Allow
STRINGEQUALS	system:serviceaccount:openshift-logging:openshift-logger
PRINCIPAL	arn:aws:iam::123456789012:oidc-provider/<OPENSHIFT_OIDC_PROVIDER_URL>
----
