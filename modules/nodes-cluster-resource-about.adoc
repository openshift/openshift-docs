// Module included in the following assemblies:
//
// * logging/nodes-cluster-resource-override.adoc

[id="nodes-cluster-resource-about_{context}"]
= Understanding the Cluster Resource Override Operator

Scheduling is based on resources requested, while quota and hard limits refer to
resource limits, which can be set higher than requested resources. The difference
between request and limit determines the level of overcommit; for instance, if a
container is given a memory request of 1Gi and a memory limit of 2Gi, it is
scheduled based on the 1Gi request being available on the node, but could use
up to 2Gi; so it is 200% overcommitted.

If {product-title} administrators would like to control the level of overcommit and manage
container density on nodes, the ClusterResourceOverride Admission Webhook can be configured 
to override the ratio between requests and limits set on developer containers. 
In conjunction with a per-project LimitRange specifying limits and defaults, this adjusts 
the container limit and request to achieve the desired level of overcommit.

This requires creating a custom resource of `ClusterResourceOverride` type as in the following example:

----
- apiVersion: operator.autoscaling.openshift.io/v1
- kind: ClusterResourceOverride
- metadata:
  -   name: cluster
- spec:
     memoryRequestToLimitPercent: 25 <1>
     cpuRequestToLimitPercent: 25 <2>
     limitCPUToMemoryPercent: 200 <3>
----

<1> Optional. If a container memory limit has been specified or defaulted, the memory request is overridden to this percentage of the limit, between 1-100.
<2> Pptional. If a container CPU limit has been specified or defaulted, the CPU request is overridden to this percentage of the limit, between 1-100.
<3> Optional. If a container memory limit has been specified or defaulted, the CPU limit is overridden to a percentage of the memory limit, with a 100 percentage scaling 1Gi of RAM to equal 1 CPU core. This is processed prior to overriding CPU request (if configured).

Note that these overrides have no effect if no limits have
been set on containers. Create a LimitRange
object with default limits, per individual project or in the
project template, in order to ensure that the overrides apply.

When configured, overrides can be enabled per-project by applying the following
label: 

----
clusterresourceoverrides.admission.autoscaling.openshift.io/enabled
----

The operator watches for the custom resource(s) of ClusterResourceOverride type and will ensure that the ClusterResourceOverride admission webhook server is installed into the same namespace as the operator. You can check the current state of the admission webhook by checking the status of the cluster custom resource

----
$ oc get clusterresourceoverride cluster -o yaml

apiVersion: operator.autoscaling.openshift.io/v1
kind: ClusterResourceOverride
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"operator.autoscaling.openshift.io/v1","kind":"ClusterResourceOverride","metadata":{"annotations":{},"name":"cluster"},"spec":{"podResourceOverride":{"spec":{"cpuRequestToLimitPercent":25,"limitCPUToMemoryPercent":200,"memoryRequestToLimitPercent":50}}}}
  creationTimestamp: "2019-12-18T22:35:02Z"
  generation: 1
  name: cluster
  resourceVersion: "127622"
  selfLink: /apis/operator.autoscaling.openshift.io/v1/clusterresourceoverrides/cluster
  uid: 978fc959-1717-4bd1-97d0-ae00ee111e8d
spec:
  podResourceOverride:
    spec:
      cpuRequestToLimitPercent: 25
      limitCPUToMemoryPercent: 200
      memoryRequestToLimitPercent: 50
status:
  certsRotateAt: "2020-12-15T22:52:46Z"
  conditions:
  - lastTransitionTime: "2019-12-18T23:27:03Z"
    status: "True"
    type: Available
  - lastTransitionTime: "2019-12-18T23:27:03Z"
    status: "False"
    type: InstallReadinessFailure
  hash:
    configuration: 577fe3d2b05619ac326571a3504857e3e7e70a275c941e3397aa9db5c1a1d3a4
    servingCert: bae6f72e906e9b054d0f4eb4b1540755f284373ad2febdec8454521ebfac5765
  image: docker.io/tohinkashem/clusterresourceoverride@sha256:f99ed0d7ecf197596bb34eed342ddc8a9169f68b68a457ee5a15070bc68e848a
  resources:
    configurationRef:
      apiVersion: v1
      kind: ConfigMap
      name: clusterresourceoverride-configuration
      namespace: cro
      resourceVersion: "78476"
      uid: e8a7f90e-90b1-4f2b-9b03-0064ffd33d4b
    deploymentRef:
      apiVersion: apps/v1
      kind: DaemonSet
      name: clusterresourceoverride
      namespace: cro
      resourceVersion: "78676"
      uid: 947ebfc5-c244-4621-acc3-c3117a10a97b
    mutatingWebhookConfigurationRef:
      apiVersion: admissionregistration.k8s.io/v1beta1
      kind: MutatingWebhookConfiguration
      name: clusterresourceoverrides.admission.autoscaling.openshift.io
      resourceVersion: "127621"
      uid: 98b3b8ae-d5ce-462b-8ab5-a729ea8f38f3
    serviceCAConfigMapRef:
      apiVersion: v1
      kind: ConfigMap
      name: clusterresourceoverride-service-serving
      namespace: cro
      resourceVersion: "78479"
      uid: faf27927-0fb0-453b-8656-1b05ea9a3d74
    serviceCertSecretRef:
      apiVersion: v1
      kind: Secret
      name: server-serving-cert-clusterresourceoverride
      namespace: cro
      resourceVersion: "78478"
      uid: cc6efc0e-0fce-4148-a943-6045dadaa72c
  version: 1.0.0
----

