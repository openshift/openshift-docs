:_mod-docs-content-type: Procedure
[id="ossm-installing-multi-primary-single-network-mesh_{context}"]
= Installing a multi-primary single-network mesh 
:context: ossm-installing-multi-primary-single-network-mesh

Install {istio} in the multi-primary single-network topology on two {ocp-product-title} clusters. 

[NOTE]
====
In this procedure, `CLUSTER1` is the East cluster and `CLUSTER2` is the West cluster. 
====

You can adapt these instructions for a mesh spanning more than two clusters.

.Prerequisites

* You have installed the {SMProduct} Operator on all of the clusters that comprise the mesh.

* You have completed "Creating certificates for a multi-cluster mesh". 

* You have completed "Applying certificates to a multi-cluster topology".

* You have created an {istio} Container Network Interface (CNI) resource.

* You have `istioctl` installed on the laptop you will use to run these instructions.

.Procedure

. Create an `ISTIO_VERSION` environment variable that defines the {istio} version to install by running the following command:
+
[source,terminal]
----
$ export ISTIO_VERSION=1.24.0 
----

. Install {istio} on the East cluster:

.. Create a YAML file named `istio-east.yaml` that defines an `Istio` resource on the East cluster.
+
.Example resource file
[source,yaml,subs="attributes,verbatim"]
----
apiVersion: sailoperator.io/v1alpha1
kind: Istio
metadata:
  name: default
spec:
  version: v${ISTIO_VERSION}
  namespace: istio-system
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster1
      network: network1
----

.. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f istio-east.yaml
----

.. Wait for the control plane to return the "Ready" status condition by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER1}" wait --for condition=Ready istio/default --timeout=3m
----

. Install {istio} on the West cluster:

.. Create a YAML file named `istio-west.yaml` that defines an `Istio` resource on the West cluster.
+
.Example resource file
[source,yaml,subs="attributes,verbatim"]
----
apiVersion: sailoperator.io/v1alpha1
kind: Istio
metadata:
  name: default
spec:
  version: v${ISTIO_VERSION}
  namespace: istio-system
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster2
      network: network1
----

.. Apply the YAML file by running the following command:
+
[source,terminal]
----
oc --context "${CTX_CLUSTER2}" apply -f istio-west.yaml
----

.. Wait for the control plane to return the "Ready" status condition by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER2}" wait --for condition=Ready istio/default --timeout=3m
----

. Install a remote secret on the East cluster that provides access to the API server on the West cluster by running the following command:
+
[source,terminal]
----
$ istioctl create-remote-secret \
  --context="${CTX_CLUSTER2}" \
  --name=cluster2 | \
  oc --context="${CTX_CLUSTER1}" apply -f -
----

. Install a remote secret on the West cluster that provides access to the API server on the East cluster by running the following command:
+
[source,terminal]
----
$ istioctl create-remote-secret \
  --context="${CTX_CLUSTER1}" \
  --name=cluster1 | \
  oc --context="${CTX_CLUSTER2}" apply -f -
----





CREATE VERIFICATION PROCEDURE UED FOR ALL TOPOLOGY

. Deploy sample applications on the East cluster:

.. Create a sample application namespace on the East cluster by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER1}" get project sample || oc --context="${CTX_CLUSTER1}" new-project sample
----

.. Label the application namespace to support sidecar injection by running the following command:
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER1}" label namespace sample istio-injection=enabled
----

.. Deploy the `helloworld` application:

... Create the `helloworld` service by running the following command:
+
[source,terminal]
----
oc --context="${CTX_CLUSTER1}" apply \
  -f https://raw.githubusercontent.com/istio/istio/${ISTIO_VERSION}/samples/helloworld/helloworld.yaml \
  -l service=helloworld -n sample
----

... Create the `helloworld-v1` deployment by running the following command:
+
[source,terminal]
----
oc --context="${CTX_CLUSTER1}" apply \
  -f https://raw.githubusercontent.com/istio/istio/${ISTIO_VERSION}/samples/helloworld/helloworld.yaml \
  -l version=v1 -n sample
----

.. Deploy the `sleep` application by running the following command:
+
[source,terminal]
----
oc --context="${CTX_CLUSTER1}" apply \
  -f https://raw.githubusercontent.com/istio/istio/${ISTIO_VERSION}/samples/sleep/sleep.yaml -n sample
----

. Wait for the sample applications on the East cluster to return the "Ready" status condition by running the following command:
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER1}" wait --for condition=available -n sample deployment/helloworld-v1
$ oc --context="${CTX_CLUSTER1}" wait --for condition=available -n sample deployment/sleep
----

. Deploy the sample applications on the West cluster:

.. Create a sample application namespace on the West cluster by running the following command:
+
[source,terminal]
----
$ oc --context "${CTX_CLUSTER2}" get project sample || oc --context="${CTX_CLUSTER2}" new-project sample
----

.. Label the application namespace to support sidecar injection by running the following command:
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER2}" label namespace sample istio-injection=enabled
----

.. Deploy the `helloworld` application:

... Create the `helloworld` service by running the following command:
+
[source,terminal]
----
oc --context="${CTX_CLUSTER2}" apply \
  -f https://raw.githubusercontent.com/istio/istio/${ISTIO_VERSION}/samples/helloworld/helloworld.yaml \
  -l service=helloworld -n sample
----

... Create the `helloworld-v2` deployment by running the following command:
+
[source,terminal]
----
oc --context="${CTX_CLUSTER2}" apply \
  -f https://raw.githubusercontent.com/istio/istio/${ISTIO_VERSION}/samples/helloworld/helloworld.yaml \
  -l version=v2 -n sample
----

.. Deploy the `sleep` application by running the following command:
+
[source,terminal]
----
oc --context="${CTX_CLUSTER2}" apply \
  -f https://raw.githubusercontent.com/istio/istio/${ISTIO_VERSION}/samples/sleep/sleep.yaml -n sample
----

. Wait for the sample applications on the West cluster to return the "Ready" status condition by running the following command:
+
[source,terminal]
----
$ oc --context="${CTX_CLUSTER2}" wait --for condition=available -n sample deployment/helloworld-v2
$ oc --context="${CTX_CLUSTER2}" wait --for condition=available -n sample deployment/sleep
----

.Verifying traffic flows between clusters

. For the East cluster, send 10 requests to the `helloworld` service by running the following command:
+
[source,terminal]
----
for i in {0..9}; do
  oc --context="${CTX_CLUSTER1}" exec -n sample deploy/sleep -c sleep -- curl -sS helloworld.sample:5000/hello;
done
----
+
Verify that you see responses from both clusters. This means you will see version 1 and version 2 of the service in the responses. 

. For the West cluster, send 10 requests to the `helloworld` service:
+
[source,terminal]
----
for i in {0..9}; do
  oc --context="${CTX_CLUSTER2}" exec -n sample deploy/sleep -c sleep -- curl -sS helloworld.sample:5000/hello;
done
----
+
Verify that you see responses from both clusters. This means you will see version 1 and version 2 of the service in the responses. 


====== END ======

.Cleanup

. Optional: Remove the cluster1 from a development environment by running the following command:
+
[source,terminal]
----
oc --context="${CTX_CLUSTER1}" delete istio/default ns/istio-system ns/sample ns/istio-cni
----

. 
. Optional: Remove the cluster2 from a development environment by running the following command:
+
[source,terminal]
----
oc --context="${CTX_CLUSTER2}" delete istio/default ns/istio-system ns/sample ns/istio-cni
----
