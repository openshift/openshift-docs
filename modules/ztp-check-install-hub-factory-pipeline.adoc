// Module included in the following assemblies:
//
// * scalability_and_performance/ztp-factory-install-clusters.adoc
:_content-type: PROCEDURE
[id="check-the-hub-cluster_factory_install_pipeline_{context}"]
= Run the hub cluster factory install pipeline

The factory install pipeline needs to be cloned to the hub.

.Prerequisites

* An {product-title} hub cluster
* Log in as a user with `cluster-admin` privileges.

.Procedure

. Create a file `spoke.yaml` with sample details as shown. A sample configuration file is present in ``examples/config.yaml``. 
+
[NOTE]
====
At this stage you only need to build out the config section.
====
+
[source,yaml]
----
config:
  clusterimageset: openshift-v4.9.0 <1>
  OC_OCP_VERSION: "4.9" <2>
  OC_OCP_TAG: "4.9.0-x86_64" <3>
  OC_RHCOS_RELEASE: "49.84.202110081407-0" # TODO automate it to get it automated using binary <4>
  OC_ACM_VERSION: "2.4" <5>
  OC_OCS_VERSION: "4.8" <6>
----

<1> {product-version} of the hub cluster
<2> {product-version} of the spoke cluster
<3> The image tag associated with {product-version} of the spoke cluster
<4> Red Hat Enterprise lInix CoreOS (RHCOS) version
<5> Red Hat Advanced Cluster Management (RHACM) version
<6> {product-version} Data Foundation (ODF) Version

. Set the following envoronment variable:
+
[source,terminal]
----
$ export KUBECONFIG=<path_to_kubeconfig>/kubeconfig-file
----

. Run the following bash script `bootstrap.sh` with the kube config as a parameter to configure the pipeline. 
+
[source,terminal]
----
$ curl -sLK https://raw.githubusercontent.com/rh-ecosystem-edge/ztp-pipeline-relocatable/main/pipelines/bootstrap.sh | bash -s -- ${KUBECONFIG}
----

This script:
* Installs the `tkn` CLI. This tool manages {product-version} Pipelines from a terminal. 
* Clones the link:https://github.com/rh-ecosystem-edge/ztp-pipeline-relocatable[ztp-pipeline-relocatable] pipeline repo. 
* Checks that the correct permissions are set on the hub cluster. 
* Deploys the {product-version} Pipelines Operator from the Operator Lifecycle Manager (OLM) catalog
* Deploy the ZTP pipeline and associated tasks

. Start the hub cluster pipeline from the command line: 
+
[source,terminal]
----
$ tkn pipeline start -n spoke-deployer -p spokes-config="$(cat /path-to-spoke.yaml/spoke.yaml)" -p kubeconfig=${KUBECONFIG} -w=ztp,claimName=ztp-pvc --timeout 5h --use-param-defaults deploy-ztp-hub
----
+
[NOTE]
====
This command starts the pipeline in the namespace `spoke-deployer` with the defined spokes configuration and the kube configuration in the workspace ztp with the previously configured persistent storage claim ztp-pvc. A timeout of 5 hours is set for the execution of the `deploy-ztp-hub` with all other parameters set to the default.
====

.Expected output
+
[source,terminal]
----
PipelineRun started: deploy-ztp-hub-run-2h44k

In order to track the PipelineRun progress run: 
tkn pipeline logs deploy-ztp-hub-run-2h44k -f -n spoke-deployer
----

.Monitoring the deployment

You can monitor the progress of the pipelines using the {product-version} web console and using the deployment log file.  

. Check the logs to monitor the progress of the `deploy-ztp-hub`. 
+
[source,terminal]
----
tkn pipeline logs deploy-ztp-hub-run-2h44k -f -n spoke-deployer
----
. Log in to the {product-title} web console.
. Navigate to *Pipelines* -> *Pipleines* and select the Project *spoke-deployer*. 
[NOTE]
====
The spoke-deployer pipeline stores all the artefacts for {product-version} Pipelines. 
====
. Select **PipelineRuns** to drill down into detail on the pipeline runs. 

. The stages of the pipeline are clearly shown and you can select each in turn to view the logs associated with that stage of the deployment. 