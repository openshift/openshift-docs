// Module included in the following assemblies:
//
// * hosted_control_planes/hcp-machine-config.adoc

:_mod-docs-content-type: PROCEDURE
[id="priority-expander-autoscaler-hcp_{context}"]
= Setting the priority expander in a hosted cluster

Cluster autoscaler scales up based on workloads. By setting the priority expander, higher priority machines are created before lower priority machines.

.Prerequisites

* You have created the `HostedCluster` and `NodePool` resources.

.Procedure

. Create the `cluster-autoscaler-priority-expander` config map in the hosted cluster by using the following example configuration:
+
[source,json]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler-priority-expander
  namespace: kube-system
data:
  priorities: |-
    10:
      - ".*<node_pool_name1>.*"
    100:
      - ".*<node_pool_name2>.*"
----

. Generate the `kubeconfig` file by running the following command:
[source,terminal]
----
$ hcp create kubeconfig --name <hosted_cluster_name> --namespace <hosted_cluster_namespace> > nested.config
----

. Create the config map object,`cluster-autoscaler-priority-expander `, by running the following command:
+
[source,terminal]
----
$ oc --kubeconfig nested.config create -f configmap.yaml
----

. Enable cluster autoscaling with the priority expander in your hosted cluster by running the following command:
+
[source,terminal]
----
$ oc patch -n <hosted_cluster_namespace> \
  hostedcluster <hosted_cluster_name> \
  --type=merge \
  --patch='{"spec": {"autoscaling": {"scaling": "ScaleUpOnly", "maxPodGracePeriod": 60, "expanders": ["Priority"]}}}'
----

. Enable cluster autoscaling on both of your node pools by running the following command:
+
[source,terminal]
----
$ oc patch -n <hosted_cluster_namespace> \
  nodepool <node_pool_name1> \
  --type=json
  --patch='[{"op": "remove", "path": "/spec/replicas"}]'
----

. Check if the status of the compute node is `Ready` by running the following command:
+
[source,terminal]
----
$ oc --kubeconfig nested.config get nodes -l 'hypershift.openshift.io/nodePool=<node_pool_name>'
----

. Check that the `"--expander=priority"` argument is set in the `cluster-autoscaler` pod by running the following command:
+
[source,terminal]
----
$ oc get pod <podname> -n <hosted_control_plane_namespace> -o jsonpath='{.spec.containers[0].args}'|jq
----
