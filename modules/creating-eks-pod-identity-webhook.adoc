// Module included in the following assemblies:
//
// * nodes/pods/nodes-pods-authenticating-with-cloud-provider.adoc

[id="creating-eks-pod-identity-webhook_{context}"]
= Creating an Amazon Elastic Kubernetes Service pod identity webhook

For pods that require AWS IAM access, you must create an Amazon Elastic Kubernetes Service (EKS) pod identity webhook. This topic includes setup instructions for self-hosted Kubernetes clusters.

.Procedure

. link:https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html[Create an OIDC provider] in IAM for your cluster. You can find the OIDC discovery endpoint by describing your EKS cluster with the following command:

[source,terminal]
----
$ aws eks describe-cluster --name $CLUSTER_NAME --query cluster.identity.oidc
----
+
Enter `sts.amazonaws.com` as the `client-id`.

. Create an IAM role for your pods and link:https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-idp_oidc.html[modify the trust policy] to allow your pod's service account to use the role. For example:
+
[source,json]
----
{
 "Version": "2012-10-17",
 "Statement": [
  {
   "Effect": "Allow",
   "Principal": {
    "Federated": "arn:aws:iam::111122223333:oidc-provider/oidc.us-west-2.eks.amazonaws.com/624a142e-43fc-4a4e-9a65-0adbfe9d6a85"
   },
   "Action": "sts:AssumeRoleWithWebIdentity",
   "Condition": {
    "__doc_comment": "Scope the role to the service account (optional)",
    "StringEquals": {
     "oidc.us-west-2.eks.amazonaws.com/624a142e-43fc-4a4e-9a65-0adbfe9d6a85:sub": "system:serviceaccount:default:my-serviceaccount"
    },
    "__doc_comment": "Scope the role to a namespace (optional)",
    "StringLike": {
     "oidc.us-west-2.eks.amazonaws.com/624a142e-43fc-4a4e-9a65-0adbfe9d6a85:sub": "system:serviceaccount:default:*"
    }
   }
  }
 ]
}
----

. Modify your pod's service account to be annotated with the Amazon Resource Name (ARN) of the role you want the pod to use.
+
[source,yaml]
----
apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-serviceaccount
  namespace: default
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::111122223333:role/s3-reader" <1>
----
<1> The ARN of the role your pod must use.
+
All of the new pods launched using this service account are modified to use IAM for pods. The following example is a pod specification with the environment variables and volume fields added by the webhook.
+
[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
  namespace: default
spec:
  serviceAccountName: my-serviceaccount
  containers:
  - name: container-name
    image: container-image:version
### Everything below is added by the webhook ###
    env:
    - name: AWS_DEFAULT_REGION
      value: us-west-2
    - name: AWS_REGION
      value: us-west-2
    - name: AWS_ROLE_ARN
      value: "arn:aws:iam::111122223333:role/s3-reader"
    - name: AWS_WEB_IDENTITY_TOKEN_FILE
      value: "/var/run/secrets/eks.amazonaws.com/serviceaccount/token"
    volumeMounts:
    - mountPath: "/var/run/secrets/eks.amazonaws.com/serviceaccount/"
      name: aws-token
  volumes:
  - name: aws-token
    projected:
      sources:
      - serviceAccountToken:
          audience: "sts.amazonaws.com"
          expirationSeconds: 86400
          path: token
----
