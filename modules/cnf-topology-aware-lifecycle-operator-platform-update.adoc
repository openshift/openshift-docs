// Module included in the following assemblies:
// Epic CNF-2600 (CNF-2133) (4.10), Story TELCODOCS-285
// * scalability_and_performance/cnf-topology-aware-lifecycle-operator.adoc

:_content-type: PROCEDURE
[id="talo-platform-update_{context}"]
= Performing a platform update

.Prerequisites

* Install the Topology Aware Lifecycle Operator.
* Update ZTP to the latest version. 
* Provision one or more managed clusters using ZTP.
* Log in as a user with `cluster-admin` privileges.
* Create {rh-rhacm} policies in the Hub cluster.

For more information about how to update ZTP, see link:https://github.com/openshift-kni/cnf-features-deploy/blob/master/ztp/gitops-subscriptions/argocd/Upgrade.md[Upgrading GitOps ZTP].
// This link^ has to be updated for OCP docs when ready.

.Procedure

. List the nodes and their cluster versions by running the following command:
+
[source,terminal]
----
$ oc get clusterversion,nodes
----
+
.Example output

[source,terminal]
----
NAME                                         VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
clusterversion.config.openshift.io/version   4.9.15    True        False         4d16h   Cluster version is 4.9.15

NAME                                           STATUS   ROLES           AGE    VERSION
node/eko5.cnf20.example.redhat.com   Ready    master,worker   123d   v1.22.3+e790d7f
node/eko6.cnf20.example.redhat.com   Ready    master,worker   123d   v1.22.3+e790d7f
node/eko7.cnf20.example.redhat.com   Ready    master,worker   123d   v1.22.3+e790d7f
----

. Save the contents of your `PolicyGenTemplate` in the `du-upgrade.yaml` file.
//This step has to be updated. Disconnected vs connected env 
+
.Example of `PolicyGenTemplate` for platform update
+
[source,yaml]
----
apiVersion: ran.openshift.io/v1
kind: PolicyGenTemplate
metadata:
 name: "du-upgrade"
 namespace: "ztp-group-du-sno"
spec:
 bindingRules:
   group-du-sno: "" <1>
 mcp: "master"
 remediationAction: inform
 sourceFiles:
   - fileName: ClusterVersion.yaml
     policyName: "platform-upgrade"
     metadata:
       name: version
     spec:
       channel: "stable-4.10"
       desiredUpdate:
         version: "4.10.1"
----
<1> The update is targeting all clusters with the `group-du-sno` label.

. Add the new CR to the `kustomization.yaml` file. 
.. ArgoCD pulls and applies the changes to the Hub cluster.
.. New policies are created in `inform` mode and any clusters not compliant to the policies changes to `NonCompliant`.

. Check the created policies by running the following command:
+
[source,terminal]
----
$ oc get policies -A | grep platform-upgrade
----
+
.Example output
[source,terminal]
----
cnfdb1                ztp-group-du-sno.du-upgrade-platform-upgrade        inform               NonCompliant       3d18h
cnfdb2                ztp-group-du-sno.du-upgrade-platform-upgrade        inform               NonCompliant       3d18h
ztp-group-du-sno      du-upgrade-platform-upgrade                         inform               NonCompliant       3d18h
----

. Check if the policy has the desired cluster version by running the following command:
+
[source,terminal]
----
$ oc get policy ztp-group-du-sno.du-upgrade-platform-upgrade -n cnfdb1 -o jsonpath='{.spec}' | jq
----
+
.Example output
+
[source,terminal]
----
{
  "disabled": false,
  "policy-templates": [
    {
      "objectDefinition": {
        "apiVersion": "policy.open-cluster-management.io/v1",
        "kind": "ConfigurationPolicy",
        "metadata": {
          "name": "du-upgrade-platform-upgrade-config"
        },
        "spec": {
          "namespaceselector": {
            "exclude": [
              "kube-*"
            ],
            "include": [
              "*"
            ]
          },
          "object-templates": [
            {
              "complianceType": "musthave",
              "objectDefinition": {
                "apiVersion": "config.openshift.io/v1",
                "kind": "ClusterVersion",
                "metadata": {
                  "annotations": {
                    "ran.openshift.io/ztp-deploy-wave": "100"
                  },
                  "name": "version"
                },
                "spec": {
                  "channel": "stable-4.10",
                  "desiredUpdate": {
                    "force": false,
                    "version": "4.10.1"
                  }
                }
              }
            }
          ],
          "remediationAction": "inform",
          "severity": "low"
        }
      }
    }
  ],
  "remediationAction": "inform"
----

. Apply the policy with TALO
.. Save the `ClusterGroupUpgrade` CR to the `du-upgrade-4101.yaml` file.
+
[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: du-upgrade-4101
  namespace: ztp-group-du-sno
spec:
  deleteObjectsOnCompletion: true
  clusters: <1>
  - cnfdb1
  - cnfdb2
  enable: true
  managedPolicies:
  - du-upgrade-platform-upgrade <2>
  remediationStrategy:
    maxConcurrency: 2
    timeout: 240
----
<1> The update targets the listed clusters.
<2> Specify the policy that you want to enforce.

.. Apply the policies by running the following command:
+
[source,terminal]
----
$ oc apply -f du-upgrade-4101.yaml
----
+
.Example output
+
[source,terminal]
----
clustergroupupgrade.ran.openshift.io/du-upgrade-4101 created
----

. Check that the `ClusterUpgradeGroup` manifest is created by running the following command:
+
[source,terminal]
----
$ oc get cgu -A -w
----
+
.Example output
+
[source,terminal]
----
NAMESPACE          NAME              AGE
ztp-group-du-sno   du-upgrade-4101   5s
ztp-install        cnfdb1            4d5h
ztp-install        cnfdb2            4d5h
----

. Check the mode of the copies of the policies by running the following command:
+
[source,terminal]
----
$ oc get policies -A | grep upgrade
----
+
.Example output
+
[source,terminal]
----
cnfdb1                ztp-group-du-sno.du-upgrade-platform-upgrade                   inform               Compliant          3d19h
cnfdb2                ztp-group-du-sno.du-upgrade-4101-du-upgrade-platform-upgrade   enforce              Compliant          23s <1>
cnfdb2                ztp-group-du-sno.du-upgrade-platform-upgrade                   inform               NonCompliant       3d19h
ztp-group-du-sno      du-upgrade-4101-du-upgrade-platform-upgrade                    enforce              Compliant          24s <1>
ztp-group-du-sno      du-upgrade-platform-upgrade                                    inform               NonCompliant       3d19h
----
<1> Two copies of the same platform update policy are created in `enforce` mode.

[NOTE]
====
At this point in the procedure, the update just started. The policy only checks the content of the `ClusterVersion` manifest
====

. Verify the status of the platform update by running the following command:
+
[source,terminal]
----
$ oc get clusterversion,node
----
+
.Example output
+
[source,terminal]
----
NAME                                         VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
clusterversion.config.openshift.io/version   4.9.13    True        True          104s    Working towards 4.10.1: 115 of 737 done (15% complete)

NAME                                         STATUS   ROLES           AGE     VERSION
node/snonode.cnfdb1.example.redhat.com       Ready    master,worker   4d11h   v1.22.3+e790d7f
----
