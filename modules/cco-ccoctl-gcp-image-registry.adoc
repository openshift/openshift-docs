// Module included in the following assemblies:
//
// * authentication/managing_cloud_provider_credentials/cco-mode-gcp-workload-identity.adoc

:_content-type: PROCEDURE
[id="cco-ccoctl-gcp-image-registry_{context}"]
= Configuring the image registry to use long-lived credentials

In {product-title} 4.10.8, image registry support for using GCP Workload Identity was removed due to the discovery of link:https://bugzilla.redhat.com/show_bug.cgi?id=2069807[an adverse impact to the image registry]. To use the image registry on an {product-title} 4.10.8 cluster that uses Workload Identity, you must configure the image registry to use long-lived credentials instead. This mitigation is planned to last until Workload Identity support for the image registry is restored in a later release.

.Prerequisites

* You have created GCP resources with the Cloud Credential Operator utility (`ccoctl`).

* You have obtained and initialized the link:https://cloud.google.com/sdk/docs/initializing[gcloud CLI].

.Procedure

. Obtain the email address of the IAM service account that the `ccoctl` created for the {product-title} image registry by running the following command:
+
[source,terminal]
----
$ gcloud iam service-accounts list --filter="displayName=<name>-openshift-image-registry-gcs"
----
+
where `<name>` is the user-defined name for all `ccoctl`-created GCP resources used for tracking.

. Create a long-lived credentials key file for the {product-title} image registry by running the following command:
+
[source,terminal]
----
$ gcloud iam service-accounts keys create <path_to_image_registry_service_account_keyfile> --iam-account=<image_registry_service_account_email>
----
+
where:
+
* `<path_to_image_registry_service_account_keyfile>` is the path to a location you choose in which to store the key file for the image registry's IAM service account.
* `<image_registry_service_account_email>` is the email address of the IAM service account that the `ccoctl` created for the {product-title} image registry.

. Generate a Base64-encoded string for the image registry key file by running the following command:
+
[source,terminal]
----
$ cat <path_to_image_registry_service_account_keyfile> | base64 -w 0
----

. In the `<path_to_ccoctl_output_dir>/manifests` directory, locate the {product-title} image registry secret manifest YAML file, `openshift-image-registry-installer-cloud-credentials-credentials.yaml`. In this file, replace the contents of the `data.service_account.json` field with the Base64-encoded key file.
