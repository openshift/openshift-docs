// Module included in the following assemblies:
//
// serverless/eventing/serverless-event-transformation.adoc

:_mod-docs-content-type: CONCEPT
[id="serverless-event-common-transformation-patterns_{context}"]
= Common transformation patterns

To effectively shape your event data, you can leverage common JSONata transformation patterns for preserving, extracting, restructuring, or conditionally modifying events.

[id="serverless-event-preserving-original-event-structure_{context}"]
== Preserving the original event structure

You can add or adjust attributes while keeping the rest of the event unchanged, so that downstream consumers receive the original data with minimal modifications.

.Example of adding a static attribute while preserving the original event structure
[source,terminal]
----
{
  "specversion": "1.0",
  "id": id,
  "type": type,
  "source": source,
  "time": time,
  "data": data,
  "newattribute": "static value"
}
----

[id="serverless-event-extracting-fields-as-attributes_{context}"]
== Extracting fields as attributes

You can promote values from the payload to top-level `CloudEvent` attributes to make filtering and routing easier.

.Example of extracting user ID and region from the payload and expose them as attributes
[source,terminal]
----
{
  "specversion": "1.0",
  "id": id,
  "type": "user.event",
  "source": source,
  "time": time,
  "userid": data.user.id,
  "region": data.region,
  "data": $
}
----

In JSONata, the `$` symbol represents the entire input object. Using `data: $` preserves the original event payload while promoting selected fields.

[id="serverless-event-restructuring-event-data_{context}"]
== Restructuring an event data

Use JSONata to transform events into the schema required by another system by restructuring payloads, renaming fields, nesting objects, and performing calculations.

.Example of restructuring an order event and calculate the total value of items
[source,terminal]
----
{
  "specversion": "1.0",
  "id": order.id,
  "type": "order.transformed",
  "source": "transform.order-processor",
  "time": order.time,
  "orderid": order.id,
  "data": {
    "customer": {
      "id": order.user.id,
      "name": order.user.name
    },
    "items": order.items.{ "sku": sku, "quantity": qty, "price": price },
    "total": $sum(order.items.(price * qty))
  }
}
----

Given the transformation above, and this JSON object as input:

[source,terminal]
----
{
  "order": {
    "time": "2024-04-05T17:31:05Z",
    "id": "8a76992e-cbe2-4dbe-96c0-7a951077089d",
    "user": {
      "id": "bd9779ef-cba5-4ad0-b89b-e23913f0a7a7",
      "name": "John Doe"
    },
    "items": [
      {"sku": "KNATIVE-1", "price": 99.99, "qty": 1},
      {"sku": "KNATIVE-2", "price": 129.99, "qty": 2}
    ]
  }
}
}
----

The transformation produces the following output:

[source,terminal]
----
{
  "specversion": "1.0",
  "id": "8a76992e-cbe2-4dbe-96c0-7a951077089d",
  "type": "order.transformed",
  "source": "transform.order-processor",
  "time": "2024-04-05T17:31:05Z",
  "orderid": "8a76992e-cbe2-4dbe-96c0-7a951077089d",
  "data": {
    "customer": {
      "id": "bd9779ef-cba5-4ad0-b89b-e23913f0a7a7",
      "name": "John Doe"
    },
    "items": [
      {
        "sku": "KNATIVE-1",
        "quantity": 1,
        "price": 99.99
      },
      {
        "sku": "KNATIVE-2",
        "quantity": 2,
        "price": 129.99
      }
    ],
    "total": 359.97
  }
}
----

Use this pattern to integrate with APIs that require specific structures or calculated fields.

[id="serverless-event-conditional-transformations_{context}"]
== Conditional transformations

With JSONata, you can embed conditional logic directly into your transformation, enabling dynamic event shaping based on attributes or payload values.

.Example of applying different types and priorities based on conditions
[source,terminal]
----
{
  "specversion": "1.0",
  "id": id,
  "type": type = "order.created" ? "new.order" : "updated.order",
  "source": source,
  "time": time,
  "priority": data.total > 1000 ? "high" : "normal",
  "data": $
}
----

In the given example:

* If the event type is `order.created`, the new type becomes `new.order`; otherwise, it is set to `updated.order`.

* If the total field in the payload is greater than 1000, a `priority` attribute is added with the value `high`; otherwise, it is set to `normal`.