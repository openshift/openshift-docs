// This module is included in the following assemblies:
// * release_notes/op-release-notes-1-20.adoc

:_mod-docs-content-type: REFERENCE
[id="op-release-notes-1-20-0_{context}"]
= Release notes for {pipelines-title} 1.20

With this update, {pipelines-title} General Availability (GA) 1.20 is available on {OCP} 4.15 and later versions.

[id="new-features-1-20-0_{context}"]
== New features

In addition to fixes and stability improvements, the following sections highlight what is new in {pipelines-title} 1.20:

Support for running in FIPS-enabled environments::
* {pipelines-title} is designed for environments running in Federal Information Processing Standards (FIPS) mode. For more information about enabling {OCP} FIPS support, see the link:https://docs.redhat.com/en/documentation/openshift_container_platform/latest/html/installation_overview/installing-fips[{OCP} Support for FIPS cryptography].

Pod anti-affinity rule added to controller replicas::
* {pipelines-shortname} adds and applies the `preferredDuringSchedulingIgnoredDuringExecution` pod anti-affinity rule to controller replicas, except for the {tekton-chains} controllers. In High Availability (HA) setups, this rule distributes replicas across different nodes instead of scheduling them on the same node, improving resiliency, load balancing, and availability. No additional configuration is required.

New buildah-ns task for improved container build security::
* {pipelines-shortname} adds the `buildah-ns` task. It improves container build security with user namespace isolation and remains compatible with the existing `buildah` task. For more information, see "Additional resources".

readOnlyRootFilesystem enabled for default deployments::
* Containers in the {pipelines-shortname}, {tekton-results}, {tekton-chains}, and Manual Approval Gate deployments have `readOnlyRootFilesystem` setting enabled by default, improving security and compliance.

Tasks display friendly names in the web console::
* Tasks in the {OCP} web console now use the `displayName` property instead of technical task names, improving readability and making tasks easier to search within the {pipelines-title} user interface.

{pipelines-shortname} on single-node OpenShift::
* Tech preview support for running {pipelines-shortname} on Single-Node OpenShift (SNO) is now available. This support is not intended for production deployments. {pipelines-shortname} on SNO has no additional limitations beyond the inherent constraints of a single-node cluster: limited scalability, no redundancy, and constrained concurrency.
For a cluster on libvirt API, the minimum hardware requirements are:

** 12 vCPUs
** 64 GB RAM
** 240 GB disk space

:FeatureName: {pipelines-shortname} on Single-Node OpenShift (SNO)
include::snippets/technology-preview.adoc[]

.Operator

Independent control of RBAC and CA bundle config map creation::
* With this update, you can independently control whether the {pipelines-shortname} Operator creates Role-Based Access Control (RBAC) resources and Trusted Certificate Authority (CA) bundle config maps in your cluster. This enhancement gives you more flexibility to fit your environment and helps avoid resource duplication. By default, both options are enabled to maintain the existing behavior. For more information, see "Additional resources".

.Pruner

Event-based pruner configurable in TektonConfig CR::
* You can enable and configure the event-based `tektonpruner` directly in the `TektonConfig` custom resource (CR). This update also adds observability enhancements with new pruner-specific metrics. 

:FeatureName: The event-based pruner
include::snippets/technology-preview.adoc[]

.{tekton-triggers}

Optional installation of {tekton-triggers} through the Operator::
* When deploying {pipelines-shortname} through the Operator, you can choose not to install {tekton-triggers}. This update provides finer control over component installation and supports environments where triggers are managed independently. The default value is `false`. The following is an example of `TektonCofig` CR with the installation disabled:
+
[source, yaml]
----
apiVersion: operator.tekton.dev/v1alpha1
kind: TektonConfig
metadata:
  name: config
spec:
  trigger:
    disabled: true
#...
----

.{tekton-results}

New flag to disable live collection in tekton-results-watcher::
* {tekton-results} supports a new flag for the `tekton-results-watcher` controller to disable live collection of runs by setting the `--disable_storing_incomplete_runs=true` flag in the `TektonConfig` CRD:
+
[source, yaml]
----
#...
options:
    deployments:
      tekton-results-watcher:
        spec:
          template:
            spec:
              containers:
              - args:
                - "--disable_storing_incomplete_runs=true"
                name: watcher
                resources: {}
#...
----
+
If set to `true`, runs are not stored until they are complete, improving system performance. If set to `false`, runs are stored upon creation and continuously upserted whenever a change occurs. This is the current default behavior. The `true` setting is planned to become the default in a future release.

Optimization to skip processing of already stored PipelineRuns::
* {tekton-results} skips processing of already stored `PipelineRuns`, improving performance and reducing API server calls. This optimization enhances overall efficiency and responsiveness, aiming to reduce server load and conserve resources.

.{pac}

Support for JSON body in incoming webhooks::
* {pac} supports passing incoming webhook parameters in the JSON POST body, while maintaining compatibility with URL query parameters:
+
[source, terminal]
----
$ curl -H "Content-Type: application/json" -X POST \
"https://control.pac.url/incoming" -d '{"repository":"repo","branch":"main", \
"pipelinerun":"target-pipelinerun","secret":"very-secure-shared-secret"}'
----
+
Using the request body for sensitive information reduces exposure in logs and improves security. For more information, see link:https://pipelinesascode.com/docs/guide/incoming_webhook/#recommended-post-json-body-method[Recommended (POST JSON body) method].

Detailed logging for GitHub API calls::
* {pac} supports detailed logging for GitHub API calls, providing insights into API interactions, durations, and rate-limiting. By setting the controller log level to 'debug', you can troubleshoot complex issues more efficiently. This enhancement refactors code to instrument GitHub calls and affects all types of GitHub API calls within the provider. For more information, see link:https://pipelinesascode.com/docs/install/logging/#debugging-api-interactions[Debugging API interactions].

New auto-configure-repo-repository-template option::
* {pac} adds the `auto-configure-repo-repository-template` setting, a new option in `auto-configure-new-github-repo` feature setting to consolidate repository creation within a single namespace, streamlining management for those with multiple repositories. For more information, see "Additional resources".

Support for relative task references in remote Pipeline definitions::
* You can use relative paths to reference tasks from within a remote `Pipeline` definition. The {pac} resolver automatically builds the full URL for the task based on the location of the remote `PipelineSpec` definition. This enhancement improves pipeline organization and portability, particularly when working with tagged releases or branches. For more information, see link:https://pipelinesascode.com/docs/guide/resolver/#overriding-tasks-from-a-remote-pipeline-on-a-pipelinerun[Overriding tasks from a remote pipeline on a PipelineRun].

:FeatureName: Overriding tasks from a remote pipeline
include::snippets/technology-preview.adoc[]

New dynamic pull_request_number variable for push events::
* Pull requests that trigger a push event automatically populate a new {pac} dynamic `pull_request_number` variable, allowing for a clear reference to the specific pull request associated with the push event and improving traceability. For more information, see "Additional resources".


[id="pipelines-breaking-changes-1-20-0_{context}"]
== Breaking changes

* The public instance of Tekton Hub (`hub.tekton.dev`) is deprecated and will be removed in a future release. For more information, see "Additional resources".

* Git resolver no longer sets `TEKTON_HUB_API` to the public hub. You must set the environment variable when pointing to a self-hosted hub. For more information, see link:https://tekton.dev/docs/operator/tektonconfig/#resolvers[Resolvers].

* {pipelines-shortname} no longer emits deprecated metrics, such as `pipelinerun_count` or `running_taskruns_count`. You must update your dashboards and alerts with the new metrics, such as `pipelinerun_total` or `running_pipelineruns`.
+
[options="header"]
|===
| Deprecated | New

| `pipelinerun_count`
| `pipelinerun_total`

| `running_pipelineruns_count`
| `running_pipelineruns`

| `running_pipelineruns_waiting_on_pipeline_resolution_count`
| `running_pipelineruns_waiting_on_pipeline_resolution`

| `running_pipelineruns_waiting_on_task_resolution_count`
| `running_pipelineruns_waiting_on_task_resolution`

| `taskrun_count`
| `taskrun_total`

| `running_taskruns_count`
| `running_taskruns`

| `running_taskruns_throttled_by_quota_count`
| `running_taskruns_throttled_by_quota`

| `running_taskruns_throttled_by_node_count`
| `running_taskruns_throttled_by_node`
|===

.{pac}

* {pac} automatically moves from using the deprecated {tekton-hub} to {artifact-hub} for pipeline and task resolution. After the upgrade some task references using short version pins, such as `0.2`, will not resolve correctly. You must update these pins to the full semantic version format, such as `0.2.0`, to ensure correct task resolution.

* The `hub_catalog_name` variable value remains set to `tekton` after upgrading to 1.20. As a result, the system does not fetch the `git-clone` task from the correct catalog on {artifact-hub}. After upgrading to 1.20, you must remove the variable from the {pac} config map by running the following command:
+
[source, terminal]
----
$ oc patch configmap pipelines-as-code -n openshift-pipelines --type=json -p='[{"op": "remove", "path": "/data/hub-catalog-name"}]'
----

[id="pipelines-kn-issues-1-20-0_{context}"]
== Known issues

.Pruner
* After upgrading from {pipelines-title} 1.19 to 1.20, the `tekton-pruner-default-spec`  config map values are overridden with default values. As a mitigation, maintain a copy of the `tekton-pruner-default-spec`  config map before upgrade and apply the same to the `TektonConfig` fields post upgrade. This issue affects only upgrade path and does not occur on fresh installations.

.CLI
* Using `opc pr logs` in the OpenShift namespace may fail with repeated `Failed to list objects from openshift namespace` errors for both admin and non-admin users. 

.{tekton-cache}
* On IBM P environments, the `cache-fetch` step may fail with the error `failed to change ownership: operation not permitted`. This typically occurs because of filesystem permission restrictions on the underlying storage.

.{tekton-chains}
* Pod anti-affinity rules are not applied to `tekton-chains-controller` replicas.

.{tekton-hub}
* The `git-clone` task downloaded from {tekton-hub} displays version `0.9` instead of `0.10`. This occurs because the system sorts version strings lexicographically rather than using semantic versioning.

[id="pipelines-fixed-issues-1-20-0"]
== Fixed issues

.Pipelines
* Before this update, the {pipelines-shortname} controller did not apply the `managed-by: tekton-pipelines` label when deploying `PipelineRuns` and `TaskRuns` with Helm. In addition, pods created by the controller could have the `app.kubernetes.io/managed-by` label overridden by values set by a `TaskRun` or `PipelineRun`. With this update, the controller consistently applies the correct labels, and pods use the default `app.kubernetes.io/managed-by` value.

* Before this update, the {OCP} Console stated a 'Cancelling' state for `PipelineRun` objects with failed `finally` tasks, even when the actual status of the `PipelineRun` was `Canceled`, causing confusion. With this update, the issue is fixed.

* Before this update, the `PipelineRun` Events tab did not show events, due to an issue with the Pipeline Console plugin. As a consequence, you could not monitor the events in real-time. With this update, the issue is fixed.

* Before this update, the pipeline builder fetched only a limited number of tasks from {artifact-hub}, resulting in some tasks not being available. This resulted in an incomplete pipeline creation. With this update, the interface fetches the complete list of tasks from {artifact-hub} on search, showing all available tasks in the pipeline builder.

* Before this update, running the Konflux-specific `fbc-fips-check-oci-ta` tasks during git cloning caused temporary resource unavailability, stalling the git resolver and preventing the resolution of `ResolutionRequests`. This resulted in a build failure with the following error message: `cannot fork() for remote-https: Resource temporarily unavailable`. With this update, the issue is fixed.

* Before this update, `TaskRun` and `CustomRun` creation could fail immediately on transient mutating-webhook timeouts, causing flakiness on busy clusters. With this update, the system  applies exponential backoff, configurable via the `wait-exponential-backoff`  config map and controlled by the `enable-wait-exponential-backoff` setting:
+
[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: feature-flags
  namespace: tekton-pipelines
data:
  enable-wait-exponential-backoff: "true"
#...
----

* Before this update, the controllers used a fixed thread count, limiting concurrency. With this update, you can override `threads-per-controller` by setting the `THREADS_PER_CONTROLLER` environment variable, allowing finer control over controller concurrency.

* Before this update, `podTemplate` fields in `TaskRunSpec` CR did not support parameter substitution, limiting matrix and multi-arch patterns. With this update, the controller substitutes parameters in `podTemplate` fields for all `TaskRuns` and `TaskRunSpecs`.

* Before this update, the `onError` block in `pipeline` v1beta1 did not support variables. With this update, the controller  resolves the `onError` variables, improving error handling flexibility.

* Before this update, git resolver shell-outs sometimes failed to inherit environment variables, breaking environment-driven authentication or configuration. With this update, the resolver passes the pod environment correctly to all git subprocesses.

* Before this update, git resolver deployments could leave zombie git processes running, consuming resources. With this update, resolvers  use a `tini`-based image and entrypoint to actively clean up subprocesses.

* Before this update, upgrading {pipelines-shortname} could cause errors when updating metadata, such as finalizers, on completed `PipelineRuns` or `TaskRuns` due to specification drift. With this update, the issue is fixed.

* Before this update, the OpenShift git resolver did not mount the trusted CA  config map into the component system CA store, potentially causing certificate verification issues. With this update, the  config map is mounted correctly, ensuring secure git operations.

* Before this update, the `git-clone` task failed with a `No such remote 'origin'` error messgae if the `origin` remote was missing from the repository. With this update, the task automatically adds the `origin` remote to the repository configuration, ensuring correct setup and successful cloning.

* Before this update, {pac} failed immediately when resource quotas were exceeded, canceling the run and interrupting user workflows. With this update, the controllers retry and automatically rerun if resources become available, reducing unnecessary cancellations and improving pipeline reliability.

* Before this update, the pipeline builder UI failed to save a pipeline when the `buildah` task `BUILD_ARGS` parameter had the default value `[""]`. The validation incorrectly rejected empty strings in arrays, even though the task could run successfully.
With this update, the issue is fixed, allowing pipelines with default `BUILD_ARGS` parameter to be saved correctly.

.{pac}
* Before this update, structured logs for {pac} lacked detailed source repository information from the initiating webhook request. With this update, logs for {pac} include complete source repository details, making it easier for operators to identify user-reported issues.

* Before this update, invalid Common Expression Language (CEL) expressions in {pac} `PipelineRun` failed silently. With this update, {pac} posts error comments on pull requests, making troubleshooting easier.  

* Before this update, {pac} `PipelineRun` posted status comments on every pull request in GitHub webhook integration, creating unnecessary noise. With this update, you can disable status comments in the `Repository` CR by setting the following:
+
[source,yaml]
----
kind: Repository
spec:
  settings:
    github:
      comment_strategy: "disable_all"
#...
----

* Before this update, the `PipelineRun starting` comment did not include a link to the {OCP} Console, making access less convenient. With this update, the comment includes a direct link to the `PipelineRun`.

* Before this update, empty commits in Bitbucket push events were processed by {pac}, causing the controller to crash. With this update, the controller ignores empty commits in the payload, preventing crashes.

* Before this update, {pac} incorrectly annotated `PipelineRun` objects modified by external controllers and marked as `started`. With this update, `PipelineRun` receives proper annotations on status change, helping ensure accurate tracking.

* Before this update, auto-merge was blocked if an unauthorized user opened a pull request (PR) and the target branch did not contain a `.tekton` directory. {pac} created a pending check that remained indefinitely, even after a repository admin approved the CI run with the `/ok-to-test` GitOps comment. With this update, the check is updated correctly after approval, allowing auto-merge to proceed as expected.

.CLI
* Before this update, `opc` CLI reading pod logs from already deleted pods could cause a panic, leading to application crashes. With this update, deleted pod scenarios are handled properly, preventing crashes when reading logs.

* Before this update, the `opc` CLI `PipelineRunPending` status was displayed with incorrect coloring, making it harder to distinguish from other statuses. With this update, the Pending status color is correct for improved visual clarity.

* Before this update, `opc` CLI following logs could trigger a deadlock, causing the application to hang. With this update, the deadlock scenario in the log following functionality is fixed, ensuring reliable log streaming.

* Before this update, `opc` CLI log lines from different tasks and steps were not easily distinguishable, complicating debugging. With this update, log lines  include a prefix showing the log source, task, and step name by default, improving readability and the debugging experience.

* Before this update, querying logs for a running `PipelineRun` or `TaskRun` in OPC Results resulted in an unclear error message. With this update, the message clearly indicates that logs cannot be retrieved while the run is still in progress.

.{tekton-triggers}
* Before this update, using a `TriggerGroup` with multiple triggers and extensions caused a data race and controller panic. With this update, the controller handles multiple triggers without errors.


[id="pipelines-deprecated-features-1-20-0"]
== Deprecated features

* The `maxRetention` parameter in {tekton-results} retention agent is deprecated. Use `defaultRetention`.

* The `chain` command is deprecated and will be removed in a future release.
