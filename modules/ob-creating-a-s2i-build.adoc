// This module is included in the following assembly:
//
// * work-with-builds/using-builds.adoc

:_mod-docs-content-type: PROCEDURE
[id="ob-creating-a-s2i-build_{context}"]
= Creating a source-to-image build

You can create a `source-to-image` build and push the created image to a custom Quay repository.

.Prerequisites

* You have installed the {builds-operator} on the {ocp-product-title} cluster.
* You have installed the `oc` CLI.
* Optional: You have installed the link:https://developers.redhat.com/content-gateway/rest/browse/pub/openshift-v4/clients/openshift-builds/1.0.1-222/[`shp` CLI].

.Procedure

. Create a `Build` resource and apply it to the {ocp-product-title} cluster by using one of the CLIs:
+
.Example: Using `oc` CLI
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: Build
metadata:
  name: s2i-nodejs-build
spec:
  source: <1>
    type: Git
    git:
      url: https://github.com/redhat-openshift-builds/samples
    contextDir: s2i-build/nodejs
  strategy: <2>
    name: source-to-image
    kind: ClusterBuildStrategy
  paramValues: <3>
  - name: builder-image
    value: quay.io/centos7/nodejs-12-centos7:master
  output:
    image: quay.io/<repo>/s2i-nodejs-example <4>
    pushSecret: registry-credential <5>
EOF
----
<1> The location where the source code is placed.
<2> The build strategy that you use to build the container.
<3> The parameter defined in the build strategy. To set the value of the `builder-image` strategy parameter, specify the builder image location required to build the output image.
<4> The location where the built image is pushed. You can push the built image to a custom Quay.io repository. Replace `repo` with a valid Quay.io organization or your Quay user name.
<5> The secret name that stores the credentials for pushing container images. To generate a secret of the type `docker-registry` for authentication, see "Authentication to container registries".

+
.Example: Using `shp` CLI
[source,terminal]
----
$ shp build create s2i-nodejs-build \
--source-url="https://github.com/redhat-openshift-builds/samples" --source-context-dir="s2i-build/nodejs" \// <1>
--strategy-name="source-to-image" \// <2>
--builder-image="quay.io/centos7/nodejs-12-centos7" \// <3>
--output-image="quay.io/<repo>/s2i-nodejs-example" \// <4>
--output-credentials-secret="registry-credential" <5>
----
<1> The location where the source code is placed.
<2> The build strategy that you use to build the container.
<3> The parameter defined in the build strategy. To set the value of the `builder-image` strategy parameter, specify the builder image location required to build the output image.
<4> The location where the built image is pushed. You can push the built image to a custom Quay.io repository. Replace `repo` with a valid Quay.io organization or your Quay user name.
<5> The secret name that stores the credentials for pushing container images. To generate a secret of the type `docker-registry` for authentication, see "Authentication to container registries".

. Check if the `Build` resource is created by using one of the CLIs:
+
.Example: Using `oc` CLI
[source,terminal]
----
$ oc get builds.shipwright.io s2i-nodejs-build
----
+
.Example: Using `shp` CLI
[source,terminal]
----
$ shp build list
----

. Create a `BuildRun` resource and apply it to the {ocp-product-title} cluster by using one of the CLIs:
+
.Example: Using `oc` CLI
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: BuildRun
metadata:
  name: s2i-nodejs-buildrun
spec:
  build:
    name: s2i-nodejs-build <1>
EOF
----
<1> The `spec.build.name` field denotes the respective build to run, which is expected to be available in the same namespace.
+
.Example: Using `shp` CLI
[source,terminal]
----
$ shp build run s2i-nodejs-build --follow <1>
----
<1> Optional: By using the `--follow` flag, you can view the build logs in the output result.

. Check if the `BuildRun` resource is created by running one of the following commands:
+
.Example: Using `oc` CLI
[source,terminal]
----
$ oc get buildrun s2i-nodejs-buildrun
----
+
.Example: Using `shp` CLI
[source,terminal]
----
$ shp buildrun list
----
+
The `BuildRun` resource creates a `TaskRun` resource, which then creates the pods to execute build strategy steps.

.Verification

. After all the containers complete their tasks, verify the following:
+
* Check whether the pod shows the `STATUS` field as `Completed`:
+
[source,terminal]
----
$ oc get pods -w
----
+
.Example output
[source,terminal]
----
NAME                                READY   STATUS     RESTARTS   AGE
s2i-nodejs-buildrun-phxxm-pod       2/2     Running    0          10s
s2i-nodejs-buildrun-phxxm-pod       1/2     NotReady   0          14s
s2i-nodejs-buildrun-phxxm-pod       0/2     Completed  0          2m
----
+
* Check whether the respective `TaskRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get tr
----
+
.Example output
[source,terminal]
----
NAME                           SUCCEEDED  REASON     STARTTIME   COMPLETIONTIME
s2i-nodejs-buildrun-phxxm      True       Succeeded  2m39s        13s
----
+
* Check whether the respective `BuildRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get br
----
+
.Example output
[source,terminal]
----
NAME                     SUCCEEDED   REASON       STARTTIME     COMPLETIONTIME
s2i-nodejs-buildrun      True        Succeeded    2m41s           15s
----
+
During verification, if a build run fails, you can check the `status.failureDetails` field in your `BuildRun` resource to identify the exact point where the failure happened in the pod or container.
+
[NOTE]
====
The pod might switch to a `NotReady` state because one of the containers has completed its task. This is an expected behavior.
====

. Validate whether the image has been pushed to the registry that is specified in the `build.spec.output.image` field. You can try to pull the image by running the following command after logging in to the registry:
+
[source,terminal]
----
$ podman pull quay.io/<repo>/<image> <1>
----
<1> The repository name and image name used when creating the `Build` resource. For example, you can use `s2i-nodejs-example` as the image name.

[role="_additional-resources"]
.Additional resources

* xref:../authenticating/understanding-authentication-at-runtime.adoc#ob-authentication-to-container-registries_understanding-authentication-at-runtime[Authentication to container registries]