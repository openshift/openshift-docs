// This module is included in the following assembly:
//
// * work-with-builds/using-builds.adoc

:_mod-docs-content-type: PROCEDURE
[id="ob-creating-a-s2i-build_{context}"]
= Creating a source-to-image build

[role="_abstract"]
Use a `source-to-image`(S2I) build strategy to turn application source code into a container image using a base image. 

.Prerequisites

* You have installed the {builds-operator} on the {ocp-product-title} cluster.
* You have installed the `oc` CLI.
* Optional: You have installed the link:https://console.redhat.com/openshift/downloads[`shp` CLI].

.Procedure

. Create a `Build` resource and apply it to the {ocp-product-title} cluster. You can do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: Build
metadata:
  name: s2i-nodejs-build
spec:
  source:
    type: Git
    git:
      url: https://github.com/redhat-openshift-builds/samples
    contextDir: s2i-build/nodejs
  strategy:
    name: source-to-image
    kind: ClusterBuildStrategy
  paramValues: 
  - name: builder-image
    value: quay.io/centos7/nodejs-12-centos7:master
  output:
    image: quay.io/<repo>/s2i-nodejs-example
    pushSecret: registry-credential
EOF
----
+
--
where:

`source`:: Defines the location where the source code is placed.
`strategy`:: Defines the build strategy that you use to build the container.
`paramValues`:: Defines the parameter defined in the build strategy. To set the value of the `dockerfile` strategy parameter, specify the Dockerfile location required to build the output image.
`output`:: Defines the location where the built image is pushed. In this procedural example, the built image is pushed to the {ocp-product-title} cluster internal registry. `buildah-example` is the name of the current project. Ensure that the specified project exists to allow the image push.
`pushSecret`:: Defines the secret name that stores the credentials for pushing container images. To generate a secret of the type `docker-registry` for authentication, see "Authentication to container registries".
--

+
[source,terminal]
----
$ shp build create s2i-nodejs-build \
--source-url="https://github.com/redhat-openshift-builds/samples" --source-context-dir="s2i-build/nodejs" \
--strategy-name="source-to-image" \
--builder-image="quay.io/centos7/nodejs-12-centos7" \
--output-image="quay.io/<repo>/s2i-nodejs-example" \
--output-credentials-secret="registry-credential"
----
+
where:

`source-context-dir`:: Defines the location where the source code is placed.
`strategy-name`:: The build strategy that you use to build the container.
`dockerfile`:: The parameter defined in the build strategy. To set the value of the `dockerfile` strategy parameter, specify the Dockerfile location required to build the output image.
`output-image`:: The location where the built image is pushed. In this procedural example, the built image is pushed to the {ocp-product-title} cluster internal registry. `buildah-example` is the name of the current project. Ensure that the specified project exists to allow the image push.
`output-credentials-secret`:: The secret name that stores the credentials for pushing container images. To generate a secret of the type `docker-registry` for authentication, see "Authentication to container registries".

. Check if the `Build` resource is created. You can do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc get builds.shipwright.io s2i-nodejs-build
----

+
[source,terminal]
----
$ shp build list
----

. Create a `BuildRun` resource and apply it to the {ocp-product-title} cluster. You can do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc apply -f - <<EOF
apiVersion: shipwright.io/v1beta1
kind: BuildRun
metadata:
  name: s2i-nodejs-buildrun
spec:
  build:
    name: s2i-nodejs-build
EOF
----
+
where:

`spec.build.name`:: Specifies the respective build to run, which is expected to be available in the same namespace.

+
[source,terminal]
----
$ shp build run s2i-nodejs-build --follow
----
+
where:

`--follow`:: (Optional) Use the `--follow` flag to view the build logs in the output result.

. Check if the `BuildRun` resource is created. You can do so by using the `oc` command or the `shp` command:
+
[source,terminal]
----
$ oc get buildrun s2i-nodejs-buildrun
----

+
[source,terminal]
----
$ shp buildrun list
----
+
The `BuildRun` resource creates a `TaskRun` resource, which then creates the pods to execute build strategy steps.

.Verification

After all the containers complete their tasks, verify the statuses of the following resources:

. Check whether the pod shows the `STATUS` field as `Completed`:
+
[source,terminal]
----
$ oc get pods -w
----
+
Example output:
+
[source,terminal]
----
NAME                                READY   STATUS     RESTARTS   AGE
s2i-nodejs-buildrun-phxxm-pod       2/2     Running    0          10s
s2i-nodejs-buildrun-phxxm-pod       1/2     NotReady   0          14s
s2i-nodejs-buildrun-phxxm-pod       0/2     Completed  0          2m
----

. Check whether the respective `TaskRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get tr
----
+
Example output:
+
[source,terminal]
----
NAME                           SUCCEEDED  REASON     STARTTIME   COMPLETIONTIME
s2i-nodejs-buildrun-phxxm      True       Succeeded  2m39s        13s
----

. Check whether the respective `BuildRun` resource shows the `SUCCEEDED` field as `True`:
+
[source,terminal]
----
$ oc get br
----
+
Example output:
+
[source,terminal]
----
NAME                     SUCCEEDED   REASON       STARTTIME     COMPLETIONTIME
s2i-nodejs-buildrun      True        Succeeded    2m41s           15s
----

. During verification, if a build run fails, you can check the `status.failureDetails` field in your `BuildRun` resource to identify the exact point where the failure happened in the pod or container.
+
[NOTE]
====
The pod might switch to a `NotReady` state because one of the containers has completed its task. This is an expected behavior.
====

. Validate whether the image has been pushed to the registry that is specified in the `build.spec.output.image` field. Log in to the registry and run the following command to pull the image:
+
[source,terminal]
----
$ podman manifest inspect image-registry.openshift-image-registry.svc:5000/s2i-example/taxi-app
----
In the previous example, the project name is `s2i-example`, and the image name is `taxi-app`.
+
Example output:
+
[source,terminal]
----
   "schemaVersion": 2,
    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
    "manifests": [
        {
            "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
            "size": 594,
            "digest": "sha256:6a05100e302c86c03fec6277f4b3107f1fdde6c69d3ca9a4207e4735a5213e32",
            "platform": {
                "architecture": "amd64",
                "os": "linux"
            }
     ]
----
