// Module included in the following assembly:
//
// * argocd-agent-installation/gitops-setting-up-a-spoke-cluster-environment.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-setting-up-a-spoke-cluster-environment_{context}"]
= Setting up a spoke cluster environment

[role="_abstract"]
After you set up the Principal component, you can connect it with one or more Agents. This connection allows the principal to securely manage Argo CD Applications on each Agent cluster.

.Prerequisites

* The Principal setup is complete and running.
* You have access to both the Principal and Agent clusters.
* The `argocd-agentctl` CLI tool is installed and accessible from your environment.
* The `helm` CLI is installed and configured. Ensure that the `helm` CLI version is later than v3.8.0.

.Procedure

. Create the Agent secret on the Principal cluster by running the following command:
+
[source,terminal]
----
$ argocd-agentctl agent create "<agent_name>" \
  --principal-context "<principal_context>" \
  --principal-namespace "<principal_namespace>" \
  --resource-proxy-server "<principal_resource_proxy_url>"
----
+
where:
+
`agent_name`:: A unique name used to identify each Agent managed by the Principal. The Agent CLI uses this value to create the Argo CD cluster secret (`cluster-<agent-name>`) and to construct the server URL.
`principal-namespace`:: Specifies the namespace where the Principal component is installed.
`principal-context`:: Specifies the cluster context of the Principal component.
`principal_resource_proxy_url`:: Specifies the URL of the Principal resource-proxy, for example, `<ArgoCD Instance Name>-agent-principal-resource-proxy:9090`, which Argo CD uses to access live resources in the Agent's cluster. In this model, Argo CD does not connect directly to the Agent cluster's API server; rather, it sends requests to the Principal's `resource-proxy`, which then forwards them to the appropriate Agent via gRPC.
`label, l` (optional):: Adds optional metadata labels for the Agent.
+
This command generates a client certificate signed by the Principal CA, creates an Argo CD cluster secret with the certificate data and sets up credentials for resource proxy access.

. Copy the CA certificate to the Agent cluster by running the following command:
+
[source,terminal]
----
$ argocd-agentctl pki propagate \
    --agent-context "<agent_context>" \
    --principal-context "<principal_context>" \
    --principal-namespace "<principal_namespace>" \
    --agent-namespace "<agent_namespace>"
----
+
where:
+
`principal-namespace`:: Specifies the namespace where the Principal component is installed.
`agent-namespace`:: Specifies the namespace where the Agent component is installed.
`principal-context`:: Specifies the kubeconfig context of the Principal (hub) cluster.
`agent-context`:: Specifies the kubeconfig context of the Agent (workload) cluster.
`force, f` (optional):: Forces regeneration of the PKI if it already exists on the target cluster.
+
This command copies the CA certificate from the Principal cluster and creates the `argocd-agent-ca` secret in the Agent cluster.

. Generate a client certificate for the Agent by running the following command:
+
[source,terminal]
----
$ argocd-agentctl pki issue agent "<agent_name>" \
    --principal-context "<principal_context>" \
    --agent-context "<agent_context>" \
    --agent-namespace "<agent_namespace>" \
    --principal-namespace "<principal_namespace>"
----
+
where:
+
`principal-context`:: Specifies the kubeconfig context of the Principal (hub) cluster.
`agent-context`:: Specifies the kubeconfig context of the Agent (workload) cluster.
`agent-namespace`:: Specifies the namespace where the Agent component is installed.
`principal-namespace`:: Specifies the namespace where the Principal component is installed.
`upsert, u` (optional):: Updates the existing JWT key if one already exists in the Agent namespace.
+
This command creates the `argocd-agent-client-tls` secret, generates the Agent's client certificate and private key, and signs the certificate using the Principal CA.

. Verify that all required secrets are created in the Agent namespace by running the following command:
+
[source,terminal]
----
$ oc get secrets -n "<agent_namespace>" --context "<agent_context>" | grep agent
----
+
Example output:
+
[source,terminal]
----
NAME                              TYPE
argocd-agent-ca                   kubernetes.io/tls
argocd-agent-principal-tls        kubernetes.io/tls
argocd-agent-resource-proxy-tls   kubernetes.io/tls
argocd-agent-jwt                  Opaque
----

. Deploy an Argo CD instance on the Agent cluster by creating an Argo CD CR similar to the following example:
+
[source,yaml]
----
apiVersion: argoproj.io/v1beta1
kind: ArgoCD
metadata:
  name: openshift-gitops
spec:
  server:
    enabled: false
----

. Apply the configuration by running the following command:
+
[source,terminal]
----
$ oc apply -f argocd.yaml -n "<agent_namespace>" --context "<agent_context>"
----

.Verification

. To verify that the Argo CD instance is created, run the following command:
+
[source,terminal]
----
$ oc get pod -n "<AGENT_NAMESPACE>" --context "<AGENT_CONTEXT>"
----
+
Example output:
+
[source,terminal]
----
NAME                                           READY   STATUS
openshift-gitops-application-controller-0      1/1     Running
openshift-gitops-redis-5b6668544-sxtth         1/1     Running
openshift-gitops-repo-server-8cb87b698-cnfgl   1/1     Running
----