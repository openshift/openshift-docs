// This module is included in the following assemblies:
// * pac/creating-pipeline-runs-pac.adoc

:_mod-docs-content-type: REFERENCE
[id="filtering-pipeline-run-using-pipelines-as-code_{context}"]
= Annotations for filtering events matched to a pipeline run

You can add one or more annotations to a pipeline run to filter the events that are matched to this pipeline run. In this case, when the defined matching event (such as a pull request, a push event. or a comment) happens, {pac} checks if these annotations are also matched. The pipeline run starts only if all the annotations that you added to it are matched.

[id="path-matching-pipeline-run-using-pipelines-as-code_{context}"]
== Matching changes in paths to a pipeline run

You can match a pipeline run to changes in a set of paths. {pac} starts the pipeline run only if the pull request or push event includes changes in any of the paths that you list.

The `pass:[*]` wildcard denotes any file in the directory. The `pass:[**]` wildcard denotes any file in the directory or any subdirectories on any level under the directory.

You can use the following example to match the `pipeline-pkg-or-cli` pipeline run when a pull request changes any files in the `pkg` directory, the `cli` directory, or any subdirectories under the `cli` directory.

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-pkg-or-cli
annotations:
  pipelinesascode.tekton.dev/on-path-changed: "["pkg/*", "cli/**"]"
# ...
----

[id="exclude-path-matching-pipeline-run-using-pipelines-as-code_{context}"]
== Excluding changes in paths from matching a pipeline run

You can configure a pipeline run to exclude matching if a pull request makes changes only to files in a specified set of paths. If the pipeline run matches an event but the pull request includes changes only to files in the paths that you list, {pac} does not start the pipeline run.

You can use the following example to match the `pipeline-docs-not-generated` pipeline run when a pull request changes any files under the `docs` directory or its subdirectories, except when the changes apply only to the `docs/generated` directory or its subdirectories.

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-docs-not-generated
annotations:
  pipelinesascode.tekton.dev/on-path-changed: "["docs/**"]"
  pipelinesascode.tekton.dev/on-path-changed-ignore: "["docs/generated/**"]"
# ...
----

You can use the following example to match the `pipeline-main-not-docs` pipeline run when a pull request targets the `main` branch, except when the changes apply only to the `docs` directory or its subdirectories.

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-main-not-docs
annotations:
  pipelinesascode.tekton.dev/on-target-branch: "[main]"
  pipelinesascode.tekton.dev/on-event: "[pull_request]"
  pipelinesascode.tekton.dev/on-path-changed-ignore: "["docs/**"]"
# ...
----

[id="label-matching-pipeline-run-using-pipelines-as-code_{context}"]
== Matching a pull request label to a pipeline run

:FeatureName: Matching pull request labels to a pipeline run
include::snippets/technology-preview.adoc[]


// Note for reviewers: passive voice unfortunately seems to be necessary in the following paragraph. A label can be added to a pull request by an automated system as well as a user, so there is no subject to mention. The same applies to updating the PR with a new commit

You can match a pipeline run to one or several pull request labels. {pac} starts the pipeline run only when the pull request has any of these labels. When the pull request is updated with a new commit, if the pull request still has the label, {pac} starts the pipeline run again.

You can use the following example to match the `pipeline-bug-or-defect` pipeline run when either the `bug` label or the `defect` label is added to a pull request, and also when a pull request with this label is updated with a new commit:

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-bug-or-defect
annotations:
  pipelinesascode.tekton.dev/on-label: "[bug, defect]"
# ...
----

[NOTE]
====
The current version of {pac} supports matching events to pull request labels only for the GitHub, Gitea, and GitLab repository hosting service providers.
====

[id="advanced-matching-pipeline-run-using-pipelines-as-code_{context}"]
== Advanced event matching

{pac} supports using Common Expression Language (CEL) based filtering for advanced event matching. If you have the `pipelinesascode.tekton.dev/on-cel-expression` annotation in your pipeline run, {pac} uses the CEL expression and skips the `on-target-branch` annotation. Compared to the simple `on-target-branch` annotation matching, the CEL expressions allow complex filtering and negation.

To use CEL-based filtering with {pac}, consider the following examples of annotations:

* To match a `pull_request` event targeting the `main` branch and coming from the `wip` branch:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request" && target_branch == "main" && source_branch == "wip"
...
----

* To run a pipeline only if a path has changed, you can use the `.pathChanged` suffix function with a glob pattern:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr-pathchanged
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request" && "docs/\*.md".pathChanged() # <1>
# ...
----
<1> Matches all markdown files in the `docs` directory.

* To match all pull requests starting with the title `[DOWNSTREAM]`:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr-downstream
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request && event_title.startsWith("[DOWNSTREAM]")
# ...
----

* To run a pipeline on a `pull_request` event, but skip the `experimental` branch:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr-not-experimental
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request" && target_branch != experimental"
# ...
----

For advanced CEL-based filtering while using {pac}, you can use the following fields and suffix functions:

* `event`: A `push` or `pull_request` event.
* `target_branch`: The target branch.
* `source_branch`: The branch of origin of a `pull_request` event. For `push` events, it is same as the `target_branch`.
* `event_title`: Matches the title of the event, such as the commit title for a `push` event, and the title of a pull or merge request for a `pull_request` event. Currently, only GitHub, Gitlab, and Bitbucket Cloud are the supported providers.
* `.pathChanged`: A suffix function to a string. The string can be a glob of a path to check if the path has changed. Currently, only GitHub and Gitlab are supported as providers.

In addition, you can access the full payload as passed by the Git repository provider. Use the `headers` field to access the headers of the payload, for example, `headers['x-github-event']`. Use the `body` field to access the body of the payload, for example, `body.pull_request.state`.

:FeatureName: Using the header and body of the payload for CEL-based filtering with {pac}
include::snippets/technology-preview.adoc[]

In the following example, the pipeline run starts only if all of the following conditions are true:

* The pull request is targeting the `main` branch.
* The author of the pull request is `superuser`.
* The action is `synchronize`; this action triggers when an update occurs on a pull request.

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  annotations:
    pipelinesascode.tekton.dev/on-cel-expression: |
      body.pull_request.base.ref == "main" &&
        body.pull_request.user.login == "superuser" &&
        body.action == "synchronize"
# ...
----

[NOTE]
====
If you use the `header` or `body` field for event matching, you might be unable to trigger the pipeline run using Git commands such as `retest`. If you use a Git command, the payload body is the comment that contains this command, and not the original payload.

If you want to trigger the pipeline run again when using the `body` field for event matching, you can close and reopen the pull request or merge request, or alternatively add a new SHA commit. You can add a new SHA commit by using the following command:

[source,terminal]
----
git commit --amend --no-edit && git push --force-with-lease
----
====
