// Module included in the following assemblies:
//
// * security/zero_trust_workload_identity_manager/zero-trust-manager.adoc

:_mod-docs-content-type: PROCEDURE
[id="zero-trust-manager-configure-cert-vault_{context}"]
= Configuring the Vault plugin

This procedure outlines the steps required to configure a SPIRE Server to obtain its intermediate signing certificates from HashiCorp Vault. The plugin supports the following methods for authenticating to Vault:

* Client Certificate Authentication

* Token Authentication

* `AppRole` Authentication

* Kubernetes Authentication

.Prerequisites

* A running and accessible HashiCorp Vault Server is available.

* A PKI secret engine is enabled and configured in Vault at the specified `pki_mount_point`.

* A role within the Vault PKI engine must be configured to allow issuing of intermediate CA certificates.

* The Vault token or authentication method used by the plugin must have the necessary permissions.

* The `ca_ttl` property configured in your SPIRE Server configuration must be less than or equal to the configured `max_lease_ttl` of the Vault PKI secret engine role that the plugin uses.

.Procedure

. Create a YAML file containing the configuration for the `SpireServer` resource, for example `SpireServer.yaml`. The file includes the `spec` block and the `upstreamAuthority` block configured to use the `vault` plugin.
+
.Example `SpireServer.yaml`
+
[source,yaml]
----
apiVersion: spire.spiffe.io/v1alpha1
kind: SpireServer
metadata:
  name: spire-server
  namespace: spire
spec:
  replicas: 1
  upstreamAuthority:
    vault:#
      address: "https://vault.example.com" <1>
      tokenPath: "/var/run/secrets/kubernetes.io/serviceaccount/token" <2>
      mtls:
        spireTrustDomain: "spiffe://example.org" <3>
        serverName: "vault.example.com" <4>
      pkcs11:
      jwt:
----
+
<1> The URL of your Vault server.
<2> The path to the Kubernetes service account token used for authentication with Vault.
<3> The trust domain of your Spire Server.
<4> The name used for Mutual Transport Layer Security (mTLS) authentication with the Vault server.

. Configure one of the authentication methods:
.. Configure the `certAuth` authentication in the `upstreamAuthority` section of the `SpireServer.yaml` file. This method uses a client certificate and private key for authentication.
+
.Example `certAuth`
+
[source,yaml]
----
# ...
upstreamAuthority:
  vault:
    certAuth:
      certAuthMountPoint: "cert" <1>
      clientCertSecret: "vault-client-cert-secret" <2>
      clientKeySecret: "vault-client-key-secret" <3>
      certAuthRoleName: "spire-server-role" <4>
----
+
<1> The mount point where the TLS certificate auth method is enabled.
<2> Name of the Kubernetes secret containing the client certificate in Privacy Enhanced Mail (PEM) format.
<3> Name of the Kubernetes secret containing the client private key in PEM format.
<4> The name of the Vault role to authenticate against.

.. Configure the `tokenAuth` authentication in the `spstreamAuthority` section of the `SpireServer.yaml` file. This method uses a static Vault token.
+
.Example `tokenAuth`
+
[source,yaml]
----
# ...
upstreamAuthority:
  vault:
    tokenAuth:
      token: "hvs.YOUR_VAULT_TOKEN_HERE"
----

.. Configure the `appRoleAuth` authentication in the `upstreamAuthority` section of the `SpireServer.yaml` file. This method uses the `AppRole` for Vault.
+
.Example `tokenAuth`
+
[source,yaml]
----
# ...
upstreamAuthority:
  vault:
    appRoleAuth:
      appRoleMountPoint: "approle" <1>
      appRoleID: "your-approle-id" <2>
      appRoleSecretID: "your-approle-secret-id" <3>
----
+
<1> The mount point where the `AppRole` auth method is enabled.
<2> The `appRoleID` used for authentication.
<3> the `appRoleSecretID` used for authentication.

. Configure the `k8sAuth` authentication in the `upstreamAuthority` section of the `SpireServer.yaml` file. This method uses a Kubernetes `ServiceAccount` token for authentication.
+
.Example `tokenAuth`
+
[source,yaml]
----
# ...
upstreamAuthority:
  vault:
    k8sAuth:
      k8sAuthMountPoint: "kubernetes" <1>
      k8sAuthRoleName: "spire-server-k8s-role" <2>
      tokenPath: "/var/run/secrets/kubernetes.io/serviceaccount/token" <3>
----
+
<1> The mount point where the Kubernetes auth method is enabled.
<2> The name of the Vault role the plugin authenticates against.
<3> The path to the Kubernetes `ServiceAccount` token file.

. Apply the configuration by running the following command:
+
[source, terminal]
----
$ oc apply -f spireserver.yaml
----
