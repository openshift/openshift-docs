// Module included in the following assemblies:
//
// * installing/installing_aws/installing-aws-account.adoc

[id="installation-aws-permissions-iam-roles_{context}"]
= IAM Policies and AWS Authentication

This section presents how authentication works for AWS resources and how to set IAM policies that grants the minimal required privileges for the cluster instances. However, be aware that the stricly minimal set of permissions is dependent on each cluster configuration and operations. You can start with the policies below, and adapt if needed, or use the https://docs.aws.amazon.com/IAM/latest/UserGuide/what-is-access-analyzer.html[IAM Access Analyzer] to generate the IAM Policies based on CloudTrail logs. 

= Required permissions for IAM Instance Profiles

By default, the installer creates IAM instance profiles for the bootstrap, control plane and worker instances with the necessary permissions. The control plane and bootstrap instances use this instance profile to make AWS API calls.

You have the option of defining your own IAM roles that are applied to the instance profiles of your machines created by the installation program. This may be necessary when roles can't be created by the installer, or when more restrictive permissions are desired.

To specify existing IAM roles, define the `controlPlane.platform.aws.iamRole` and `compute.platform.aws.iamRole` fields in the `install-config.yaml` file. You can use these fields to match naming schemes and include predefined permissions boundaries for your IAM roles.

The control plane and compute machines require the following IAM role permissions:

.Default IAM role permissions for control plane instance profiles
[%collapsible]
====
* `ec2:AttachVolume`
* `ec2:AuthorizeSecurityGroupIngress`
* `ec2:CreateSecurityGroup`
* `ec2:CreateTags`
* `ec2:CreateVolume`
* `ec2:DeleteSecurityGroup`
* `ec2:DeleteVolume`
* `ec2:Describe*`
* `ec2:DetachVolume`
* `ec2:ModifyInstanceAttribute`
* `ec2:ModifyVolume`
* `ec2:RevokeSecurityGroupIngress`
* `elasticloadbalancing:AddTags`
* `elasticloadbalancing:AttachLoadBalancerToSubnets`
* `elasticloadbalancing:ApplySecurityGroupsToLoadBalancer`
* `elasticloadbalancing:CreateListener`
* `elasticloadbalancing:CreateLoadBalancer`
* `elasticloadbalancing:CreateLoadBalancerPolicy`
* `elasticloadbalancing:CreateLoadBalancerListeners`
* `elasticloadbalancing:CreateTargetGroup`
* `elasticloadbalancing:ConfigureHealthCheck`
* `elasticloadbalancing:DeleteListener`
* `elasticloadbalancing:DeleteLoadBalancer`
* `elasticloadbalancing:DeleteLoadBalancerListeners`
* `elasticloadbalancing:DeleteTargetGroup`
* `elasticloadbalancing:DeregisterInstancesFromLoadBalancer`
* `elasticloadbalancing:DeregisterTargets`
* `elasticloadbalancing:Describe*`
* `elasticloadbalancing:DetachLoadBalancerFromSubnets`
* `elasticloadbalancing:ModifyListener`
* `elasticloadbalancing:ModifyLoadBalancerAttributes`
* `elasticloadbalancing:ModifyTargetGroup`
* `elasticloadbalancing:ModifyTargetGroupAttributes`
* `elasticloadbalancing:RegisterInstancesWithLoadBalancer`
* `elasticloadbalancing:RegisterTargets`
* `elasticloadbalancing:SetLoadBalancerPoliciesForBackendServer`
* `elasticloadbalancing:SetLoadBalancerPoliciesOfListener`
* `kms:DescribeKey`
====

.Default IAM role permissions for worker instance profiles
[%collapsible]
====
* `ec2:DescribeInstances`
* `ec2:DescribeRegions`
====

= Custom permissions for IAM Instance Profiles

Depending on your cluster set of operators and their configuration, it may be necessary to grant aditional permissions to the instance profiles. Instead of manually adding each permission, it might be more convenient to https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_generate-policy.html?icmpid=docs_iam_console[Generate policies based on access activity].

The overall process would be:

. https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-getting-started.html[Enable CLoudTrail], so that the API calls are logged.
. https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html[Create the instance profile roles] with a permissive policy, such as   https://us-east-1.console.aws.amazon.com/iam/home?region=us-east-1&skipRegion=true#policies/arn:aws:iam::aws:policy/PowerUserAccess[PowerUserAccess].
. Install the cluster, in a development environment, and test it. It's important to test thoroughly so that all required API calls are logged.
. https://docs.aws.amazon.com/IAM/latest/UserGuide/access-analyzer-policy-generation.html[Generate the policies based on the CloudTrail logs]
. Add the generated policies to the instance profile roles.
. Remove the permissive policy from the instance profile roles.

Also, you may add https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_condition.html[IAM Conditions] to your policy to make it more restrictive and compliant with your organization security requirements.
