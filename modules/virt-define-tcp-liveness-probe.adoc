// Module included in the following assemblies:
//
// * virt/logging_events_monitoring/virt-monitoring-vm-health.adoc

[id="virt-define-tcp-liveness-probe_{context}"]

= Define a TCP liveness probe

This procedure provides an example configuration file for defining
TCP liveness probes.

.Procedure

. Customize a YAML configuration file to create an TCP liveness probe, using
this code block as an example. In this example:
+
--
* You configure a probe using `spec.livenessProbe.tcpSocket`, which queries port `1500` of the virtual machine instance, after an initial delay of `120` seconds.
* The virtual machine instance installs and runs a minimal HTTP server
on port `1500` using `cloud-init`.
--
+
[NOTE]
====
The `timeoutSeconds` value must be lower than the `periodSeconds` value. The `timeoutSeconds` default value is `1`. The `periodSeconds` default value is `10`.
====
+
[source,yaml]
----
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  labels:
    special: vmi-fedora
  name: vmi-fedora
spec:
  domain:
    devices:
      disks:
      - disk:
          bus: virtio
        name: containerdisk
      - disk:
          bus: virtio
        name: cloudinitdisk
    resources:
      requests:
        memory: 1024M
  livenessProbe:
    initialDelaySeconds: 120
    periodSeconds: 20
    tcpSocket:
      port: 1500
    timeoutSeconds: 10
  terminationGracePeriodSeconds: 0
  volumes:
  - name: containerdisk
    registryDisk:
      image: kubevirt/fedora-cloud-registry-disk-demo
  - cloudInitNoCloud:
      userData: |-
        #cloud-config
        password: fedora
        chpasswd: { expire: False }
        bootcmd:
          - setenforce 0
          - dnf install -y nmap-ncat
          - systemd-run --unit=httpserver nc -klp 1500 -e '/usr/bin/echo -e HTTP/1.1 200 OK\\n\\nHello World!'
    name: cloudinitdisk
----
+
. Create the virtual machine instance by running the following command:
+
[source,terminal]
----
$ oc create -f <file name>.yaml
----
