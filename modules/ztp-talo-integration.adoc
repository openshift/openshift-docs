// Module included in the following assemblies:
//
// * scalability_and_performance/ztp-deploying-disconnected.adoc

:_module-type: CONCEPT
[id="ztp-talo-integration_{context}"]
= GitOps ZTP and Topology Aware Lifecycle Operator

GitOps ZTP generates installation and configuration CRs from manifests stored in Git. These artifacts are applied to a centralized hub cluster where {rh-rhacm-first}, assisted installer service, and the Topology Aware Lifecycle Operator (TALO) use the CRs to install and configure the spoke cluster. The configuration phase of the ZTP pipeline uses TALO to orchestrate the application of the configuration CRs to the cluster. There are several key integration points between GitOps ZTP and TALO.

Inform policies::
By default, GitOps ZTP creates all policies with a remediation action of `inform`. {rh-rhacm} does not apply the desired configuration. During the install, TALO steps through the created policies changes the remediation action to `enforce`. This pushes the configuration to the spoke cluster. Changes can be made without the risk of rolling out changes to all spoke clusters in the network simultaneously.

Automatic creation of ClusterGroupUpgrade CRs::
TALO monitors the state of all `ManagedCluster` CRs on the hub cluster. Any `ManagedCluster` CR which does not have a `ztp-done` label applied, including newly created `ManagedCluster` CRs, causes TALO to automatically create a `ClusterGroupUpgrade` CR with the following characteristics:

* The `ClusterGroupUpgrade` CR is created and enabled in the `ztp-install` namespace.
* `ClusterGroupUpgrade` CR has the same name as the `ManagedCluster` CR.
* The cluster selector includes only the cluster associated with that `ManagedCluster` CR.
* The set of managed policies includes all policies that {rh-rhacm} has bound to the cluster at the time the `ClusterGroupUpgrade` is created.
* Pre-caching is disabled.
* Timeout set to 4 hours (240 minutes).
The automatic creation for any `ManagedCluster` without the `ztp-done` label allows a failed ZTP installation to be restarted by simply deleting the `ClusterGroupUpgrade` CR for the cluster. The CR is re-created and ZTP rollout of the configuration will pick up CR reconciliation to the cluster at the next non-compliant policy.

Waves::
Each policy generated from a `PolicyGenTemplate` includes a `ztp-deploy-wave` annotation. This annotation is based on the same annotation from each CR which is included in that policy.

[NOTE]
====
All CRs in the same policy must have the same setting for the `ztp-deploy-wave` annotation. The default value of this annotation for each CR can be overridden in the `PolicyGenTemplate`.
====

TALO applies the configuration policies in the order specified by the wave annotations. TALO waits for each policy to be compliant before moving to the next policy. It is important to ensure that the wave annotation for each CR takes into account any prerequisites for those CRs to be applied to the cluster. For example, an Operator must be installed before, or concurrently with, the configuration for the Operator.

Multiple CRs and policies can share the same wave number. Having fewer policies can result in faster deployments and lower CPU usage. It is best practice to group many CRs into relatively few waves.

Phase labels::
The `ClusterGroupUpgrade` CR is automatically created and includes directives to annotate the `ManagedCluster` CR with labels at the start and end of the ZTP process.


When ZTP configuration post-installation commences, the `ManagedCluster` has the `ztp-running` label applied. When all policies are remediated to the cluster and are fully compliant, these directives cause TALO to remove the ztp-`running` label and apply the `ztp-done` label.

For deployments which make use of the `Done` policy, the `ztp-done` label is applied when the cluster is fully ready for deployment of applications, including all reconciliation and resulting effects of the ZTP applied configuration CRs.

Linked CRs::
The automatically created `ClusterGroupUpgrade` CR has the owner reference set as the `ManagedCluster` from which it was derived. This reference ensures that deleting the `ManagedCluster` CR causes the instance of the `ClusterGroupUpgrade` to be deleted along with any supporting resources.
