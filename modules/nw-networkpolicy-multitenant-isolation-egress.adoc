// Module included in the following assemblies:
//
// * networking/network_security/network_policy/multitenant-network-policy.adoc

:_mod-docs-content-type: PROCEDURE
[id="nw-networkpolicy-multitenant-isolation-egress_{context}"]
= Configuring multitenant isolation for egress by using network policy


.Procedure

. Create a new project by entering the following command:
+
[source,terminal]
----
$ oc new-project <project_name>
----

. Apply the `default-deny-all-egress` NetworkPolicy by entering the following command:
+
[source,terminal]
----
$ cat << EOF | oc apply -f -
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all-egress
  namespace: <project_name>
spec:
  podSelector: {}
  policyTypes:
  - Egress
EOF
----

. Apply the `allow-internet-egress` NetworkPolicy to labeled pods by entering the following command:
+
[source,terminal]
----
$ cat << EOF | oc apply -f -
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internet-egress
  namespace: <project_name>
spec:
  podSelector:
    matchLabels:
      networking/allow-internet-egress: "true"
  egress:
  - {}  # allow all egress
  policyTypes:
  - Egress
EOF
----

. Create and deploy and Egress test pod with the `networking/allow-internet-egress: "true"` label by entering the following command:
+
[source,terminal]
----
$ cat << EOF | oc apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: <test_pod_a>
  namespace: <project_name>
  labels:
    networking/allow-internet-egress: "true"
spec:
  securityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
  containers:
  - name: curl
    image: curlimages/curl:latest
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      runAsNonRoot: true
    command: ["/bin/sh", "-c"]
    args:
      - |
        while true; do
          echo "Attempting to reach internet..."
          curl -s ifconfig.me || echo "Failed to reach internet"
          sleep 10
        done
  restartPolicy: Never
EOF
----

. Check the logs from the Egress test pod to ensure that it can reach the internet by entering the following command:
+
[source,terminal]
----
$ oc logs -f <egress_pod_name> -n <project_name>
----
+
.Example output
+
[source,terminal]
----
34.172.64.248 Attempting to reach internet...
----

. Optional: Create and deploy a second test pod without the `networking/allow-internet-egress: "true"` label by entering the following command:
+
[source,terminal]
----
$ cat << EOF | oc apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: <test_pod_b>
  namespace: <project_name>
spec:
  containers:
  - name: curl
    image: curlimages/curl:latest
    command: ["/bin/sh", "-c"]
    args:
      - |
        while true; do
          echo "Attempting to reach internet..."
          curl -s ifconfig.me || echo "Failed to reach internet"
          sleep 10
        done
  restartPolicy: Never
EOF
----

. Optional: Check the logs from the second test pod without the `networking/allow-internet-egress: "true"` label by entering the following command:
+
[source,terminal]
----
$ oc logs -f <test_pod_b> -n <project_name>
----