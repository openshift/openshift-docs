// Module included in the following assemblies:
//
// serverless/eventing/serverless-event-transformation.adoc

:_mod-docs-content-type: CONCEPT
[id="serverless-event-transformation-deployment-patterns_{context}"]
= Deployment patterns for event transformation

You can use `EventTransform` at different points in your event flow depending on your architecture needs. The following patterns are supported:

[id="serverless-event-transformation-source-to-broker_{context}"]
== Source to Broker event transformation

You can route events from a Source to an `EventTransform` resource, apply transformation logic, and then forward them to a Broker so that only normalised or enriched events are routed for consumption. 

You can configure an `ApiServerSource` resource to send events to an `EventTransform` resource, which then transforms and routes them to the default Broker, as shown in the following example: 

[source,yaml]
----
apiVersion: sources.knative.dev/v1
kind: ApiServerSource
metadata:
  name: k8s-events
spec:
  serviceAccountName: event-watcher
  resources:
    - apiVersion: v1
      kind: Event
  sink:
    ref:
      apiVersion: eventing.knative.dev/v1alpha1
      kind: EventTransform
      name: event-transformer
---
apiVersion: eventing.knative.dev/v1alpha1
kind: EventTransform
metadata:
  name: event-transformer
spec:
  sink:
    ref:
      apiVersion: eventing.knative.dev/v1
      kind: Broker
      name: default
  jsonata:
    expression: |
      # transformation expression
----

[id="serverless-event-transformation-trigger-to-service_{context}"]
== Trigger to Service event transformation

You can route events through Broker → Trigger → EventTransform → Service or Sink. The Broker receives all events, the Trigger filters them by attributes, the `EventTransform` resource reshapes or enriches the filtered events, and the Service or Sink processes the results. 

You can tailor events for specific consumers without changing the original producer or affecting other subscribers. Because transformations apply only after filtering, only relevant events are reshaped, which improves efficiency and reduces unnecessary processing.

You can filter events of type `original.event.type`, route them to an `EventTransform`, and deliver the transformed events to a Service with this configuration.

[source,yaml]
----
apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: transform-trigger
spec:
  broker: default
  filter:
    attributes:
      type: original.event.type
  subscriber:
    ref:
      apiVersion: eventing.knative.dev/v1alpha1
      kind: EventTransform
      name: event-transformer
---
apiVersion: eventing.knative.dev/v1alpha1
kind: EventTransform
metadata:
  name: event-transformer
spec:
  sink:
    ref:
      apiVersion: serving.knative.dev/v1
      kind: Service
      name: destination-service
  jsonata:
    expression: |
      # transformation expression
----

[id="serverless-event-transformation-broker-reply_{context}"]
== Broker reply event transformation

You can configure `EventTransform` without a sink to republish transformed events back to the Broker, where they can be routed to additional Triggers or consumers.

[NOTE]
====
When using the Broker reply feature, ensure the transformed events do not match the same Trigger that invoked the `EventTransform`. Otherwise, you risk creating an infinite event loop.
====

You can filter events of type `original.event.type` with a Trigger, transform them with `EventTransform`, and republish them to the Broker as `transformed.event.type` type. Updating the type or another attribute routes the event to different Triggers without reprocessing by the same Trigger.

[source,yaml]
----
apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: transform-trigger
spec:
  broker: default
  filter:
    attributes:
      type: original.event.type
  subscriber:
    ref:
      apiVersion: eventing.knative.dev/v1alpha1
      kind: EventTransform
      name: event-transformer
---
apiVersion: eventing.knative.dev/v1alpha1
kind: EventTransform
metadata:
  name: event-transformer
spec:
  # No sink specified - reply to Broker
  jsonata:
    expression: |
      {
        "specversion": "1.0",
        "id": id,
        "time": time,
        "type": "transformed.event.type",
        "source": "transform.event-transformer",
        "data": $
      }
----