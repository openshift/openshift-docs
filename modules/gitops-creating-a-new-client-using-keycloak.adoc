// Module included in the following assemblies:
//
// * accesscontrol_usermanagement/configuring-sso-for-argo-cd-using-keycloak.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-creating-a-new-client-in-keycloak_{context}"]
= Configuring a new client in Keycloak

[role="_abstract"]
Dex is installed by default for all the Argo CD instances created by the Operator. However, you can delete the Dex configuration and add Keycloak instead to log in to Argo CD using your OpenShift credentials. Keycloak acts as an identity broker between Argo CD and OpenShift.

.Procedure

To configure Keycloak, follow these steps:

. Delete the Dex configuration by removing the `.spec.sso.dex` parameter from the Argo CD custom resource (CR), and save the CR: 
+
[source,yaml]
----
dex:
    openShiftOAuth: true
    resources:
      limits:
        cpu: 
        memory: 
      requests:
        cpu: 
        memory: 
----

. Set the value of the `provider` parameter to `keycloak` in the Argo CD CR.

. Configure Keycloak by performing one of the following steps:

* For a secure connection, set the value of the `rootCA` parameter as shown in the following example:
+
[source,yaml]
----
apiVersion: argoproj.io/v1beta1
kind: ArgoCD
metadata:
  name: example-argocd
  labels:
    example: basic
spec:
  sso:
    provider: keycloak
    keycloak:
      rootCA: "<PEM-encoded-root-certificate>" <1>
  server:
    route:
      enabled: true
----
<1> A custom certificate used to verify the Keycloak's TLS certificate.
+ 
The Operator reconciles changes in the `.spec.sso.keycloak.rootCA` parameter and updates the `oidc.config` parameter with the PEM encoded root certificate in the `argocd-cm` configuration map.

* For an insecure connection, leave the value of the `rootCA` parameter empty and use the `oidc.tls.insecure.skip.verify` parameter as shown below:
+
[source,yaml]
----
apiVersion: argoproj.io/v1beta1
kind: ArgoCD
metadata:
  name: example-argocd
  labels:
    example: basic
spec:
  extraConfig:
    oidc.tls.insecure.skip.verify: "true"
  sso:
    provider: keycloak
    keycloak:
      rootCA: ""
----

* Optional: Customize the `spec.sso.keycloak` field to add the route name for the `keycloak` provider in the `ArgoCD` CR. Use this feature to support advanced routing use cases, such as balancing incoming traffic load among multiple link:https://docs.openshift.com/container-platform/latest/networking/configuring_ingress_cluster_traffic/configuring-ingress-cluster-traffic-ingress-controller.html#nw-ingress-sharding_configuring-ingress-cluster-traffic-ingress-controller[Ingress Controller sharding].
+
** Add a `host` parameter in the `ArgoCD` CR by using the following example YAML:
+
.Example `ArgoCD` CR
[source,yaml]
----
apiVersion: argoproj.io/v1alpha1
kind: ArgoCD
metadata:
  name: <resource_name> #<1>
  labels:
    example: route
spec:
  sso:
    provider: keycloak
    keycloak:
     host: <hostname> #<2>
  server:
    ingress:
      enabled: true
    insecure: true
----
<1> Replace `<resource_name>` with the name of the `ArgoCD` CR.
<2> Replace `<hostname>` with the name of the host key, for example, `sso.test.example.com`.
+
** To create the `ArgoCD CR`, run the following command:
+
[source,terminal]
----
$ oc create -f <argocd_filename>.yaml -n <your-namespace>
----
+
** To edit the `ArgoCD CR`, run the following command:
+
[source,terminal]
----
$ oc edit -f <argocd_filename>.yaml -n <your_namespace>
----
+
** Save the file to apply the changes.
+
** To apply the `ArgoCD` CR, run the following command:
+
[source,terminal]
----
$ oc apply -f <argocd_filename>.yaml -n <your_namespace>
----
+
** Verify that the `host` attribute is added by running the following command:
+
[source,terminal]
----
$ oc get route keycloak -n <your_namespace> -o yaml
----
+
.Example output
+
[source,yaml]
----
kind: Route
metadata:
  name: keycloak #<1>
  labels:
    application: keycloak
spec:
  host: sso.test.example.com
status:
  ingress:
    - host: sso.test.example.com #<2>
----
<1> Specifies the name of the route.
<2> Specifies the name of the host key.
+
[NOTE]
====
The Keycloak instance takes 2-3 minutes to install and run.
====

