// Module included in the following assemblies:
// serverless-metering.adoc

[id="datasources-metering-serverless_{context}"]
= Data source reports for Knative Serving metering

The following data source reports are examples of how Knative Serving can be used with {product-title} metering.

[id="knative-service-cpu-usage-ds_{context}"]
== Data source report for CPU usage in Knative Serving

This data source report provides the accumulated CPU seconds used per Knative service over the report time period.

.Example YAML file
[source,yaml]
----
apiVersion: metering.openshift.io/v1
kind: ReportDataSource
metadata:
  name: knative-service-cpu-usage
spec:
  prometheusMetricsImporter:
    query: >
      sum
          by(namespace,
             label_serving_knative_dev_service,
             label_serving_knative_dev_revision)
          (
            label_replace(rate(container_cpu_usage_seconds_total{container!="POD",container!="",pod!=""}[1m]), "pod", "$1", "pod", "(.*)")
            *
            on(pod, namespace)
            group_left(label_serving_knative_dev_service, label_serving_knative_dev_revision)
            kube_pod_labels{label_serving_knative_dev_service!=""}
          )
----

[id="knative-service-memory-usage-ds_{context}"]
== Data source report for memory usage in Knative Serving

This data source report provides the average memory consumption per Knative service over the report time period.

.Example YAML file
[source,yaml]
----
apiVersion: metering.openshift.io/v1
kind: ReportDataSource
metadata:
  name: knative-service-memory-usage
spec:
  prometheusMetricsImporter:
    query: >
      sum
          by(namespace,
             label_serving_knative_dev_service,
             label_serving_knative_dev_revision)
          (
            label_replace(container_memory_usage_bytes{container!="POD", container!="",pod!=""}, "pod", "$1", "pod", "(.*)")
            *
            on(pod, namespace)
            group_left(label_serving_knative_dev_service, label_serving_knative_dev_revision)
            kube_pod_labels{label_serving_knative_dev_service!=""}
          )
----

[id="applying-ds-knative_{context}"]
== Applying data source reports for Knative Serving metering

You can apply data source reports by using the following command:

[source,terminal]
----
$ oc apply -f <data_source_report_name>.yaml
----

.Example command
[source,terminal]
----
$ oc apply -f knative-service-memory-usage.yaml
----
