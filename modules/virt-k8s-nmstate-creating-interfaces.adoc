// This is included in the following assemblies:
//
// virt-k8s-nmstate-configuration.adoc

[id="creating-interfaces_{context}"]

= Creating interfaces

The `kubernetes-nmstate` operator requires the `nmstate.io` API version and the kind of policy, which is `NodeNetworkConfigurationPolicy`. Additionally, each policy has a name as defined by `metadata.name` and a desired state as defined by `spec.desiredState`. The policy's desired state contains a declarative specification of the node's network configuration.

The `spec.desiredState.interfaces` section begins the `nmstate` policy. Creating the policy is identical to creating a policy with `nmstate`. Refer to link:nmstate.io[NMState] documentation for additional details on creating `nmstate` policies.

.Procedure

. Create a policy manifest.
+
[source,bash]
----
 ---
 apiVersion: nmstate.io/v1beta1
 kind: NodeNetworkConfigurationPolicy
 metadata:
   name: bond0-eth1-eth2
 spec:
   desiredState:
     interfaces:
     - name: bond0
       type: bond
       state: up
       ipv4:
         dhcp: true
         enabled: true
       link-aggregation:
         mode: balance-rr
         slaves:
         - eth1
         - eth2
----
+
The foregoing exemplary YAML content is a policy manifest for bonding NICs `eth1` and `eth2` on the {product-title} cluster's nodes in a YAML file named `bond0-eth1-eth2_up.yaml`.

. Apply the policy manifest.
+
[source,bash]
----
[kni@node ~]$ oc apply -f bond0-eth1-eth2_up.yaml
----


. Wait for `kubernetes-nmstate` to successfully apply the policy.
+
[source,bash]
----
[kni@node ~]$ oc wait nncp bond0-eth1-eth2 --for condition=Available --timeout 2m
----

. Get the cluster's policies.
+
[source,bash]
----
[kni@node ~]$ oc get nodenetworkconfigurationpolicies
----
+
Alternatively, you can use the `nncp` short name.
+
[source,bash]
----
[kni@node ~]$ oc get nncp
----
+
[source,bash]
----
NAME              STATUS
bond0-eth1-eth2   SuccessfullyConfigured
----

. Get the current state of a policy by specifying the policy name and `-o yaml`.
+
[source,bash]
----
[kni@node ~]$ oc get nncp bond0-eth1-eth2 -o yaml
----
+
[source,yaml]
----
# output truncated
status:
  conditions:
  - lastHearbeatTime: "2020-02-07T10:27:09Z"
    lastTransitionTime: "2020-02-07T10:27:09Z"
    message: 2/2 nodes successfully configured
    reason: SuccessfullyConfigured
    status: "True"
    type: Available
----
+
[NOTE]
.Status Conditions
====
The `status.conditions` section describes the condition of the applied policy. In the foregoing example, the `reason` attribute of the status reports is **SuccessfullyConfigured**, indicating that the nodes received and applied the policy. The condition's `type` attribute is **Available** indicating the configuration is working properly. The `type` attribute can also report **Degraded** indicating a failed state.
====

. Get the cluster's enactments.
+
[source,bash]
----
[kni@node ~]$ oc get nodenetworkconfigurationenactments
----
+
Alternatively, you can use the `nncp` short name.
+
[source,bash]
----
[kni@node ~]$ oc get nnce
----
+
[source,bash]
----
NAME                     STATUS
node01.bond0-eth1-eth2   SuccessfullyConfigured
node02.bond0-eth1-eth2   SuccessfullyConfigured
----
+
[NOTE]
.About enactments
====
Enactments are read-only objects reflecting the per-node status.
====

. To get the full status of a particular enactment, specify the enactment name and `-o yaml`.
+
[source,bash]
----
[kni@node ~]$ oc get nnce node01.bond0-eth1-eth2 -o yaml
----
+
[source,bash]
----
# output truncated
status:
  conditions:
  - lastHearbeatTime: "2020-02-07T10:27:09Z"
    lastTransitionTime: "2020-02-07T10:27:09Z"
    reason: SuccessfullyConfigured
    status: "False"
    type: Failing
  - lastHearbeatTime: "2020-02-07T10:27:09Z"
    lastTransitionTime: "2020-02-07T10:27:09Z"
    message: successfully reconciled
    reason: SuccessfullyConfigured
    status: "True"
    type: Available
  - lastHearbeatTime: "2020-02-07T10:27:09Z"
    lastTransitionTime: "2020-02-07T10:27:09Z"
    reason: SuccessfullyConfigured
    status: "False"
    type: Progressing
  - lastHearbeatTime: "2020-02-07T10:27:04Z"
    lastTransitionTime: "2020-02-07T10:27:04Z"
    message: All policy selectors are matching the node
    reason: AllSelectorsMatching
    status: "True"
    type: Matching
  desiredState:
    interfaces:
    - ipv4:
        dhcp: true
        enabled: true
      link-aggregation:
        mode: balance-rr
        slaves:
        - eth1
        - eth2
      name: bond0
      state: up
      type: bond
----
+
The output contains the policy's `desiredState` for the given node. The output also contains a list of conditions:
+
- `AllSelectorsMatching` indicates the policy matched the node.
- `Progressing` indicates that `kubernetes-nmstate` is applying the policy.
- `Failing` indicates the application of the poilcy is failing or has failed.
- `Available` indicates the application of the policy was successful.


. Verify the `NodeNetworkState`.
+
[source,bash]
----
[kni@node ~]$ oc get nns node01 -o yaml
----
+
[source,bash]
----
# Output truncated
status:
  currentState:
    interfaces:
    - ipv4:
        address:
        - ip: 192.168.66.127
          prefix-length: 24
        auto-dns: true
        auto-gateway: true
        auto-routes: true
        dhcp: true
        enabled: true
      ipv6:
        autoconf: false
        dhcp: false
        enabled: false
      link-aggregation:
        mode: balance-rr
        options: {}
        slaves:
        - eth2
        - eth1
      mac-address: 52:55:00:D1:56:01
      mtu: 1500
      name: bond0
      state: up
      type: bond
    - ipv4:
        dhcp: false
        enabled: false
      ipv6:
        autoconf: false
        dhcp: false
        enabled: false
      mac-address: 52:55:00:D1:56:01
      mtu: 1500
      name: eth1
      state: up
      type: ethernet
    - ipv4:
        dhcp: false
        enabled: false
      ipv6:
        autoconf: false
        dhcp: false
        enabled: false
      mac-address: 52:55:00:D1:56:01
      mtu: 1500
      name: eth2
      state: up
      type: ethernet
----
+
The output indicates that `kubernetes-nmstate` successfully applied the policy and two NICs are now bonded and available.
