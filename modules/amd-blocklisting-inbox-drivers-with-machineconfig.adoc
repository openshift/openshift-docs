// Module included in the following assemblies:
//
// * hardware_accelerators/amd-gpu-operator.adoc

:_content-type: PROCEDURE
[id="amd-blocklisting-inbox-drivers-with-machineconfig_{context}"]
= Blocklisting the inbox drivers with a MachineConfig

.Procedure

. Verify that the inbox AMD drivers are loaded:
+
[source,terminal]
----
$ oc debug node/worker0.example.com 
----
+
.Example output
[source,terminal]
----
sh-4.4# chroot /host

sh-5.1# lsmod | grep amd
amdgpu               9494528  0
iommu_v2               24576  1 amdgpu
gpu_sched              49152  1 amdgpu
drm_buddy              20480  1 amdgpu
drm_display_helper    172032  1 amdgpu
drm_ttm_helper         16384  1 amdgpu
i2c_algo_bit           16384  2 mgag200,amdgpu
ttm                    90112  2 amdgpu,drm_ttm_helper
drm_kms_helper        192512  5 drm_display_helper,mgag200,amdgpu
drm                   581632  10 gpu_sched,drm_kms_helper,drm_shmem_helper,drm_display_helper,mgag200,drm_buddy,amdgpu,drm_ttm_helper,ttm
----

. Verify that there is no existing `/etc/modprobe.d/amdgpu-blocklist.conf` file:
+
[source,terminal]
----
sh-5.1# ls /etc/modprobe.d/amdgpu-blocklist.conf
ls: cannot access '/etc/modprobe.d/amdgpu-blocklist.conf': No such file or directory

sh-5.1# exit
exit

sh-4.4# exit
exit

Removing debug pod ...
----

. Create the `1-blocklist.yml` file. You should set `master` for the label `machineconfiguration.openshift.io/role` if you run Single Node OpenShift or `worker` in other scenarios with dedicated controllers.
+
[source,terminal]
----
$ cat <<EOF > 1-blocklist.yml  
----
+
.Example output
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: amdgpu-module-blocklist
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
        - path: "/etc/modprobe.d/amdgpu-blocklist.conf"
          mode: 420
          overwrite: true
          contents:
            source: "data:text/plain;base64,YmxhY2tsaXN0IGFtZGdwdQo="
EOF
----

. Apply the blocklist MachineConfig for the inbox AMD GPU driver:
+
[source,terminal]
----
$ oc apply -f 1-blocklist.yml
----
+
.Example output
[source,terminal]
----
machineconfig.machineconfiguration.openshift.io/amdgpu-module-blocklist created
----

. Verify the MachineConfig is running:
+
[source,terminal]
----
$ oc get machineconfigs | grep amdgpu-module-blocklist
----
+
.Example output
[source,terminal]
----
amdgpu-module-blocklist                                                                       3.2.0             12s
----

. The MachineConfig triggers a reboot. You can ping your host machine to follow the reboot. After the reboot, you can connect to the node and see that the blocklist file is created:
+
[source,terminal]
----
$ oc debug node/worker0.example.com
----
+
.Example output
[source,terminal]
----
sh-4.4# chroot /host

sh-5.1# ls /etc/modprobe.d/amdgpu-blocklist.conf
/etc/modprobe.d/amdgpu-blocklist.conf
----

. Verify that no AMD modules are loaded after the reboot:
+
[source,terminal]
----
sh-5.1# lsmod | grep amd

sh-5.1# exit
exit

sh-4.4# exit
exit

Removing debug pod ...
----

