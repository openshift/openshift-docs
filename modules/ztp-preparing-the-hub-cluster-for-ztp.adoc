// Module included in the following assemblies:
//
// *scalability_and_performance/ztp-deploying-disconnected.adoc

:_content-type: PROCEDURE
[id="ztp-preparing-the-hub-cluster-for-ztp_{context}"]
= Preparing the hub cluster for ZTP

You can configure your hub cluster with a set of ArgoCD applications that generate the required installation and policy custom resources (CR) for each site based on a zero touch provisioning (ZTP) GitOps flow.

.Prerequisites

* Install the OpenShift CLI (`oc`).
* Log in as a user with `cluster-admin` privileges.
* Install the Red Hat OpenShift GitOps Operator in your hub cluster.

.Procedure

. Extract the administrator password for ArgoCD:
+
[source,terminal]
----
$ oc get secret openshift-gitops-cluster -n openshift-gitops -o jsonpath='{.data.admin\.password}' | base64 -d
----

. Extract the ArgoCD deployment CRs from the ZTP site generator container:

.. Make an output directory:
+
[source,terminal]
----
$ mkdir -p ./ztp
----

.. Pull the `ztp-site-generate` {product-version} container image and extract the contents of the `/home/ztp` folder:
+
[source,terminal]
----
$ podman run --rm registry.redhat.io/openshift4/ztp-site-generate-rhel8:v4.10 extract /home/ztp --tar | tar x -C ./ztp
----

.. Modify the source values of the two ArgoCD applications, `clusters-app.yaml` and `policies-app.yaml` with appropriate URL, `targetRevision` branch, and path values. The path values must match those used in your Git repository.
+
Modify `./ztp/argocd/deployment/clusters-app.yaml`:
+
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  name: clusters-sub
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: clusters
  namespace: openshift-gitops
spec:
  destination:
    server: https://kubernetes.default.svc
    namespace: clusters-sub
  project: ztp-app-project
  source:
    path: ztp/gitops-subscriptions/argocd/example/siteconfig
    repoURL: <site_config_repo_url> <1>
    targetRevision: master <2>
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
----
<1> The URL of your site configuration Git repo.
<2> The branch on the Git repository that contains the relevant site configuration data.

.. Modify `./ztp/argocd/deployment/policies-app.yaml`:
+
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
    name: policies-sub
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: policies
  namespace: openshift-gitops
spec:
  destination:
    server: https://kubernetes.default.svc
    namespace: policies-sub
  project: policy-app-project
  source:
    path: ztp/gitops-subscriptions/argocd/example/policygentemplates
    repoURL: <site_config_repo_url> <1>
    targetRevision: master <2>
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
----
<1> The URL of your site configuration Git repo.
<2> The branch on the Git repository that contains the relevant site configuration data.

. Apply the pipeline configuration to your hub cluster:
+
[source,terminal]
----
$ oc apply -k ztp/argocd/deployment
----
+
.Example output
[source,terminal]
----
namespace/clusters-sub created
namespace/policies-sub created
clusterrolebinding.rbac.authorization.k8s.io/gitops-cluster created
clusterrolebinding.rbac.authorization.k8s.io/gitops-policy created
appproject.argoproj.io/policy-app-project created
appproject.argoproj.io/ztp-app-project created
application.argoproj.io/clusters created
application.argoproj.io/policies created
----
