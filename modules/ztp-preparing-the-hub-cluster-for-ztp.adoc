// Module included in the following assemblies:
//
// *scalability_and_performance/ztp-support-for-deployment-of-multi-node-clusters.adoc

:_content-type: PROCEDURE
[id="ztp-preparing-the-hub-cluster-for-ztp_{context}"]
= Preparing the hub cluster for ZTP

Configure your hub cluster with a set of ArgoCD applications that generate the required installation and
policy custom resources (CRs) for each site based on a zero touch provisioning (ZTP) GitOps flow.

.Prerequisites

* Openshift Cluster 4.8 or 4.9 as the hub cluster.
* {rh-rhacm} operator 2.3 or 2.4 installed on the hub cluster.
* Red Hat OpenShift GitOps operator 1.3 on the hub cluster.

.Procedure

. Install the Topology Aware Lifecycle Operator, which coordinates with any new sites
added by ZTP and manages application of the PGT-generated policies.

. Patch the ArgoCD instance in the hub cluster using the patch files previously extracted into
the `out/argocd/deployment/` directory:
+
[source,terminal]
----
$ oc patch argocd openshift-gitops -n openshift-gitops  --patch-file out/argocd/deployment/argocd-openshift-gitops-patch.json --type=merge
----
+
[source,terminal]
----
$ oc patch deployment openshift-gitops-repo-server -n openshift-gitops --patch-file out/argocd/deployment/deployment-openshift-repo-server-patch.json
----

. Prepare the ArgoCD pipeline configuration:
.. Create a git repository with the directory structure similar to the example directory.
.. Configure access to the repository using the ArgoCD UI. Under `Settings`, configure the following:
... *Repositories* - Add the connection information, the URL must end in `.git`, for example,
`https://repo.example.com/repo.git` and credentials.
... *Certificates* - Add the public certificate for the repository, if needed.
.. Modify the two ArgoCD Applications, `out/argocd/deployment/clusters-app.yaml` and
`out/argocd/deployment/policies-app.yaml`, based on your GIT repository:
... Update the URL to point to the Git repository. The URL must end with .git,must end in `.git`, for example, `https://repo.example.com/repo.git`.
... `targetRevision` should indicate which branch to monitor.
... The path should specify the path to the SiteConfig or PolicyGenTemplate CRs, respectively.
. Apply the pipeline configuration to your hub cluster using the following command
+
[source,terminal]
----
$ oc apply -k out/argocd/deployment
----
