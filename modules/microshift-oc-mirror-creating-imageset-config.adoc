// Module included in the following assemblies:
//
//* microshift_running_apps/microshift_operators/microshift-operators-olm.adoc

:_mod-docs-content-type: PROCEDURE
[id="microshift-oc-mirror-creating-imageset-config_{context}"]
= Creating an image set configuration file

You must create an image set configuration file to mirror catalog contents with the oc-mirror plugin. The image set configuration file defines which Operators to mirror along with other configuration settings for the oc-mirror plugin. After generating a default image set file, you must edit the contents so that remaining entries are compatible with both {microshift-short} and the Operator you plan to use.

You must specify a storage backend in the image set configuration file. This storage backend can be a local directory or a registry that supports link:https://docs.docker.com/registry/spec/manifest-v2-2[Docker v2-2]. The oc-mirror plugin stores metadata in this storage backend during image set creation.

[IMPORTANT]
====
Do not delete or modify the metadata that is generated by the oc-mirror plugin. You must use the same storage backend every time you run the oc-mirror plugin for the same mirror registry.
====

.Prerequisites

* You have created a container image registry credentials file. See link:https://docs.openshift.com/container-platform/{ocp-version}/installing/disconnected_install/installing-mirroring-disconnected.html#installation-adding-registry-pull-secret_installing-mirroring-disconnected[Configuring credentials that allow images to be mirrored].

.Procedure

. Use the `oc mirror init` command to create a template for the image set configuration and save it to a file called `imageset-config.yaml`:
+
[source,terminal]
----
$ oc mirror init <--registry <storage_backend> > imageset-config.yaml <1>
----
<1> Specifies the location of your storage backend, such as `example.com/mirror/oc-mirror-metadata`.
+
.Example default image set configuration file
[source,yaml]
----
kind: ImageSetConfiguration
apiVersion: mirror.openshift.io/v1alpha2
storageConfig:
  registry:
    imageURL: registry.example.com/oc-mirror
    skipTLS: false
mirror:
  platform: # <1>
    channels:
    - name: stable-4.15
      type: ocp
  operators:
  - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.15
    packages:
    - name: serverless-operator
      channels:
      - name: stable
  additionalImages: # <2>
  - name: registry.redhat.io/ubi8/ubi:latest
  helm: {} # <3>
----
<1> The `platform` field and related fields are not supported by {microshift-short} and must be deleted.
<2> Specify any additional images to include in the image set. If you do not need to specify additional images, delete this field.
<3> Helm is not supported by {microshift-short}, and must be deleted.

. Edit the values of your image set configuration file to meet the requirements of both {microshift-short} and the Operator you want to mirror, like the following example:
+
.Example edited {microshift-short} image set configuration file
[source,yaml,subs="attributes+"]
----
kind: ImageSetConfiguration
apiVersion: mirror.openshift.io/v1alpha2
storageConfig: <1>
  registry:
    imageURL: <storage_backend> <2>
    skipTLS: false
mirror:
  operators:
  - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.15 <3>
    packages:
    - name: amq-broker-rhel8 <4>
      channels:
      - name: 7.11.x <5>
----
<1> Set the backend location where the image set metadata is saved. This location can be a registry or local directory. It is required to specify `storageConfig` values.
<2> Set the registry URL for the storage backend, such as `<example.com/mirror/oc-mirror-metadata`.
<3> Set the Operator catalog to retrieve images from.
<4> Specify the Operator packages to include in the image set. Remove this field to retrieve all packages in the catalog.
<5> Specify only certain channels of the Operator packages to include in the image set. You must always include the default channel for the Operator package even if you do not use the bundles in that channel. You can find the default channel by running the following command: `oc mirror list operators --catalog=<catalog_name> --package=<package_name>`.

. Save the updated file.

.Next steps
* Use the oc-mirror plugin to mirror an image set directly to a target mirror registry.
* Configure CRI-O.
* Apply the catalog sources to your clusters.