// Module included in the following assemblies:
//
// * argo_rollouts/enable-support-for-namespace-scoped-argo-rollouts-installation.adoc

:_mod-docs-content-type: PROCEDURE
[id="configuring-namespace-scoped-argo-rollouts-installation_{context}"]
= Configuring a namespace-scoped Argo Rollouts installation

[role="_abstract"]
To configure a namespace-scoped instance of Argo Rollouts installation, complete the following steps.

.Prerequisites

* You are logged in to the {product-title} cluster as an administrator.
* You have installed {gitops-title} on your {product-title} cluster.

.Procedure 

. In the *Administrator* perspective of the web console, go to *Administration* -> *CustomResourceDefinitions*.
. Search for `Subscription` and click the *Subscription* CRD.
. Click the *Instances* tab and then click the *openshift-gitops-operator* subscription.
. Click the *YAML* tab and edit the YAML file. 
+
.. Specify the `NAMESPACE_SCOPED_ARGO_ROLLOUTS` environment variable, with the value set to `true` in the `.spec.config.env` property.
+
.Example of configuring the namespace-scoped Argo Rollouts installation
[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: openshift-gitops-operator
spec:
  # (...)
  config:
    env:
      - name: NAMESPACE_SCOPED_ARGO_ROLLOUTS
        value: 'true' #<1>
----
<1> The value set to `'true'` enables namespace-scoped installation. If the value is set to `'false'` or not specified the installation defaults to cluster-scoped mode.

.. Click *Save*.
+
The {gitops-title} Operator facilitates the reconciliation of the Argo Rollouts custom resource within a namespace-scoped installation.

. Verify that the {gitops-title} Operator has enabled the namespace-scoped Argo Rollouts installation by viewing the logs of the {gitops-shortname} container:
.. In the *Administrator* perspective of the web console, go to *Workloads* -> *Pods*.
.. Click the *openshift-gitops-operator-controller-manager* pod, and then click the *Logs* tab.
.. Look for the following log statement: `Running in namespaced-scoped mode`. This statement indicates that the {gitops-title} Operator has enabled the namespace-scoped Argo Rollouts installation.

. Create a `RolloutManager` resource to complete the namespace-scoped Argo Rollouts installation:
.. Go to *Operators* -> *Installed Operators* -> *Red Hat OpenShift GitOps*, and click the *RolloutManager* tab.
.. Click *Create RolloutManager*.
.. Select *YAML view* and enter the following snippet:
+
.Example `RolloutManager` CR for a namespace-scoped Argo Rollouts installation
[source,yaml]
----
apiVersion: argoproj.io/v1alpha1
kind: RolloutManager
metadata:
  name: rollout-manager
  namespace: my-application #<1> 
spec:
  namespaceScoped: true
----
<1> Specify the name of the project where you want to install the namespace-scoped Argo Rollouts instance.
+
.. Click *Create*. 
+
After the `RolloutManager` CR is created, {gitops-title} begins to install the namespace-scoped Argo Rollouts instance into the selected namespace.

. Verify that the namespace-scoped installation is successful.
.. In the *RolloutManager* tab, under the *RolloutManagers* section, ensure that the *Status* field of the `RolloutManager` instance is `Phase: Available`.
.. Examine the following output in the *YAML* tab under the *RolloutManagers* section to ensure that the installation is successful:
+
.Example of namespace-scoped Argo Rollouts installation YAML file
[source,yaml]
----
spec:
  namespaceScoped: true
status:
  conditions:
    lastTransitionTime: '2024-07-10T14:20:5z`
    message: ''
    reason: Success
    status: 'True' #<1>
    type: 'Reconciled'
  phase: Available
  rolloutController: Available
----
<1> This status indicates that the namespace-scoped Argo Rollouts installation is enabled successfully.
+
If you try to install a namespace-specific Argo Rollouts instance while a cluster-scoped installation already exists on the cluster, an error message is displayed:
+
.Example of an incorrect installation with an error message
[source,yaml]
----
spec:
  namespaceScoped: true
status:
  conditions:
   lastTransitionTime: '2024-07-10T14:10:7z`
   message: 'when Subscription has environment variable NAMESPACE_SCOPED_ARGO_ROLLOUTS set to False, there may not exist any namespace-scoped RolloutManagers: only a single cluster-scoped RolloutManager is supported'
   reason: InvalidRolloutManagerScope
   status: 'False' #<1>
   type: 'Reconciled'
  phase: Failure
  rolloutController: Failure
----
<1> This status indicates that the namespace-scoped Argo Rollouts installation is not enabled successfully. The installation defaults to cluster-scoped mode.