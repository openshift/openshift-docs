// Module included in the following assemblies:
//
// * upgrade/upgrade-roxctl.adoc
:_mod-docs-content-type: PROCEDURE
[id="troubleshooting-upgrader_{context}"]
= Troubleshooting the cluster upgrader

[role="_abstract"]
If you encounter problems when using the legacy installation method for the secured cluster and enabling the automated updates, you can try troubleshooting the problem.
The following errors can be found in the clusters view when the upgrader fails.

[id="upgrader-missing-permissions_{context}"]
== Upgrader is missing permissions

.Symptom

The following error is displayed in the cluster page:

[source,text]
----
Upgrader failed to execute PreflightStage of the roll-forward workflow: executing stage "Run preflight checks": preflight check "Kubernetes authorization" reported errors. This usually means that access is denied. Have you configured this Secured Cluster for automatically receiving upgrades?"
----

.Procedure

. Ensure that the bundle for the secured cluster was generated with future upgrades enabled before clicking *Download YAML file and keys*.
. If possible, remove that secured cluster and generate a new bundle making sure that future upgrades are enabled.
. If you cannot re-create the cluster, you can take these actions:
.. Ensure that the service account `sensor-upgrader` exists in the same namespace as Sensor.
.. Ensure that a ClusterRoleBinding exists (default name: `<namespace>:upgrade-sensors`) that grants the `cluster-admin` ClusterRole to the `sensor-upgrader` service account.

[id="upgrader-cannot-start-missing-image_{context}"]
== Upgrader cannot start due to missing image

.Symptom

The following error is displayed in the cluster page:

[source,text]
----
"Upgrade initialization error: The upgrader pods have trouble pulling the new image: Error pulling image: (...) (<image_reference:tag>: not found)"
----

.Procedure

. Ensure that the Secured Cluster can access the registry and pull the image `<image_reference:tag>`.
. Ensure that the image pull secrets are configured correctly in the secured cluster.

[id="upgrader-cannot-start-unknown-reason_{context}"]
== Upgrader cannot start due to an unknown reason

.Symptom

The following error is displayed in the cluster page:

[source,text]
----
"Upgrade initialization error: Pod terminated: (Error)"
----

.Procedure

. Ensure that the upgrader has enough permissions for accessing the cluster objects. For more information, see "Upgrader is missing permissions".
. Check the upgrader logs for more insights.

[id="obtainig-upgrader-logs_{context}"]
=== Obtaining upgrader logs

The logs can be accessed by running the following command:
[source,terminal,subs="+quotes"]
----
$ kubectl -n <namespace> logs deploy/sensor-upgrader <1>
----
<1> For `_<namespace>_`, specify the namespace in which Sensor is running.

Usually, the upgrader deployment is only running in the cluster for a short time while doing the upgrades. It is removed later, so accessing its logs using the orchestrator CLI can require proper timing.
