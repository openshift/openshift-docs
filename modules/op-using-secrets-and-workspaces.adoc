// This module is included in the following assemblies:
// * secure/authenticating-pipelines-and-tasks-using-secrets.adoc

[id="op-using-secrets-and-workspaces_{context}"]
= Using secrets and workspaces

Using Secrets and Workspaces in the Tekton Pipeline provides a flexible approach to managing credentials in Tekton Pipelines. You can bind a Secret to a Workspace, and then use that Secret content in your Task. 

The following examples illustrate how to use Secrets and Workspaces.

== git-clone Task

This approach involves creating a task called `git-clone`, which clones a git repository using SSH authentication. The following are the steps to use Secrets and Workspace in Tekton Pipelines:

. Create a Task called `git-clone` that clones a git repository using SSH authentication. 

. Define workspace, add the description for creating a secret, and bind it to the workspace.
+
.Example
+
[source,yaml,subs="attributes+"]
----
apiVersion: v1
kind: Secret
metadata:
  name: my-github-ssh-credentials
type: Opaque
data:
  id_ed25519: # […]
  known_hosts: # […]
  # config: # […] # optional
----

. Create the secret by running the following command:
+
[source, terminal]
----
$ oc create secret generic my-github-ssh-credentials\
  --from-file=id_ed25519=/path/to/.ssh/id_ed25519 \
  --from-file=known_hosts=/path/to/.ssh/known_hosts
----

. Define task parameters for the repository URL, revision, and the git-init image that the Task uses.

. Define results that the Task produces, for example, the commit SHA and the repository URL. 

. Define the steps that the Task executes, for example, copying the content of the ssh secret to the user’s home directory and running the git-init binary to clone the repository. 

. Start the Task with the required parameters and workspace bindings by running the following command:
+
[source, terminal]
----
$ tkn task start git-clone 
      --param url=git@github.com:<username>/buildkit-tekton 
      --workspace name=output,emptyDir="" 
      --workspace name=ssh-directory,secret=my-github-ssh-credentials 
      --use-param-defaults --showlog
----

.Example: Tekton Task for cloning a Git repository using an SSH key for authentication
[source,yaml,subs="attributes+"]
----
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: git-clone
spec:
  workspaces:
    - name: output
      description: The git repo will be cloned onto the volume backing this Workspace.
    - name: ssh-directory <1>
      description: | <2>
        A .ssh directory with private key, known_hosts, config, etc. Copied to
        the user's home before git commands are executed. Used to authenticate
        with the git remote when performing the clone. Binding a Secret to this
        Workspace is strongly recommended over other volume types
  params:
    - name: url
      description: Repository URL to clone from.
      type: string
    - name: revision
      description: Revision to checkout. (branch, tag, sha, ref, etc...)
      type: string
      default: ""
    - name: gitInitImage
      description: The image providing the git-init binary that this Task runs.
      type: string
      default: "gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.37.0"
  results:
    - name: commit
      description: The precise commit SHA that was fetched by this Task.
    - name: url
      description: The precise URL that was fetched by this Task.
  steps:
    - name: clone
      image: "$(params.gitInitImage)"
      script: |
        #!/usr/bin/env sh
        set -eu
        # This is necessary for recent version of git
        git config --global --add safe.directory '*' <3>
        cp -R "$(workspaces.ssh-directory.path)" "${HOME}"/.ssh
        chmod 700 "${HOME}"/.ssh
        chmod -R 400 "${HOME}"/.ssh/*
        CHECKOUT_DIR="$(workspaces.output.path)/"
        /ko-app/git-init \
          -url="$(params.url)" \
          -revision="$(params.revision)" \
          -path="${CHECKOUT_DIR}"
        cd "${CHECKOUT_DIR}"
        RESULT_SHA="$(git rev-parse HEAD)"
        EXIT_CODE="$?"
        if [ "${EXIT_CODE}" != 0 ] ; then
          exit "${EXIT_CODE}"
        fi
        printf "%s" "${RESULT_SHA}" > "$(results.commit.path)"
        printf "%s" "$(params.url)" > "$(results.url.path)"
----
<1> The workspaces that the Task needs to run, for example, ssh-directory.
<2> The description that outlines the process for creating the secret. 
<3> The script copies the content of the secret (in the form of a folder) to ${HOME}/.ssh, which is the standard folder where `ssh` searches for credentials.
+
[NOTE]
====
For flexibility, the `git clone` task can be adapted to include optional workspaces by setting the `spec.workspaces.optional` parameter to  `true`.
====

== Using an existing docker configuration file

This approach uses an existing docker configuration file inside a Task. The Task definition is the same as that of “A git-clone task” approach, but Skopeo is used to replicate an image to a personal repository. This approach can be adapted to other tools such as Podman, or Buildah, as long as they can interprete a docker client configuration file.

Following are the steps for using an existing Docker configuration file inside a Tekton Pipeline task:

. Define a Tekton Task in your {product-title} cluster with a reference to Skopeo image that copies a docker image to a specified repository.

. In the Task definition, create a workspace called `dockerconfig` that holds a `config.json` file.

. Define a secret in {product-title} containing the `config.json` file, which contains the Docker authentication information.

. Create the secret by using the `oc create secret`, specifying the path to the `config.json` file on your local machine.

. Start the TeKton Task by running the `tkn task start` command, specifying the name of the Task, the workspace name (`dockerconfig`),  and the secret name (`regcred`).

.Example: Using an existing docker configuration file inside a Task
[source,yaml,subs="attributes+"]
----
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: skopeo-copy
spec:
  workspaces:
    - name: dockerconfig <1>
      description: Includes a docker `config.json`
  steps:
    - name: clone
      image: quay.io/skopeo/stable:v1.8.0
      env:
      - name: DOCKER_CONFIG
        value: $(workspaces.dockerconfig.path) <2>
      script: |
        #!/usr/bin/env sh
        set -eu
        skopeo copy docker://docker.io/library/ubuntu:latest docker://docker.io/vdemeester/ubuntu-copy:latest
----
<1>  The name of the workspace that contains the config.json file. For a secret, this represents a key named config.json.
<2> The DOCKER_CONFIG environment variable points to the `dockerconfig` workspace path `skopeo` to get the authentication information.

