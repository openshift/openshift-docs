// Module included in the following assemblies:
//
// * service_mesh/v2x/ossm-security.adoc
//

//Original location for the include was at the end of the v2 security Assembly.
//include::modules/ossm-config-external-ca.adoc[leveloffset=+1]
//Could not leave a comment there because asciidoc does not like hidden text at the end of a file.

:_content-type: PROCEDURE
[id="ossm-config-external-ca_{context}"]
= Configuring {SMProductShortName} for an external certificate authority

#DRAFT TOPIC#
#Not part of any assembly#

//This module was created as a draft for OSSMDOC-633, but could not be completed before the original author changed jobs.  Checked in to make it easier for the next writer to complete the work for OSSMDOC-633.

Issuers are Kubernetes resources that represent certificate authorities (CAs) that are able to generate signed certificates by honoring certificate signing requests. All cert-manager certificates require a referenced issuer that is in a ready condition to attempt to honor the request.

By default, {SMProductName} generates a self-signed root certificate and key and uses them to sign the workload certificates.  You can also use your own certificate provider to generate certificates.

.Prerequisites

//Depending on when the engineering work is completed, the Operator version might change to 2.3.1?
* Configuring {SPShortName} with an external certificate authority was introduced in {SMProductName} 2.3. You must have the {SMProductName} 2.3 Operator installed.
//* If you are using cert-manager as your external certificate authority, it must be installed before you install {SMProductName} by deploying a `ServiceMeshControlPlane`.
* You must have a version 2.3 `ServiceMeshControlPlane` deployed.

The `ServiceMeshControlPlane` resource lets you configure an external certificate authority using the `security.certificateAuthority.custom.address` parameter. This enables {SMProductShortName} to integrate with external certificate authorities (CAs).

Note that when using this method, the pilot server must have its tls context included in a secret that is generated by the external certificate authority.  The configuration for this secret is specified in the `security.certificateAuthority.pilotSecretName` parameter in the SMCP.

[NOTE]
====
Red Hat does not support third-party certificate authorities.  Contact your CA vendor for support for your certificate provider.
====

.Procedure

. Create a self-signed root certificate named `selfsigned`.
+
.Sample self-signed certificate
[source,yaml]
----
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned
spec:
  selfSigned: {}
----
+
. Using your certificate authority, create a certificate named named `istio-ca` that references the self-signed certificate that you created in the previous step.  This provides the `secretName` needed by {SMProductShortName}.
+
.Example certificate
[source,yaml]
----
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: istio-ca
spec:
  isCA: true
  duration: 2160h # 90d
  secretName: istio-ca  #required for tls context
  commonName: istio-ca
  subject:
    organizations:
      - cluster.local
      - cert-manager
  issuerRef:
    name: selfsigned
    kind: Issuer
    group: cert-manager.io
----
+
. Create an Issuer object named `istio-ca` that uses the key/cert that you just generated.
+
.Example istio-ca certificate
[source,yaml]
----
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: istio-ca
spec:
  ca:
    secretName: istio-ca  #required for tls context
----
+
. Configure the `ServiceMeshControlPlane` to allow integration with your certificate authority.
+
.Example configuration for external certificate authority
[source,yaml]
----
apiVersion: maistra.io/v2
kind: ServiceMeshControlPlane
metadata:
  name: basic
  namespace: istio-system
spec:
  security:
    certificateAuthority:
      cert-manager:
        address: cert-manager-istio-csr.cert-manager.svc:443
        pilotSecretName: istiod-tls  #Should this be "istio-ca" to match the other examples?
        rootCAConfigMapName: "istio-ca-root-cert"
      type: cert-manager
----
