// Module included in the following assemblies:
//
// * upgrading/upgrade-roxctl.adoc
// * cloud_service/upgrading-cloud/upgrade-cloudsvc-roxctl.adoc
:_mod-docs-content-type: PROCEDURE
[id="migrating-sccs-during-the-manual-upgrade_{context}"]
= Migrating SCCs during the manual upgrade

ifeval::["{context}" == "upgrade-cloudsvc-roxctl"]
:cloud-svc:
endif::[]

By migrating the security context constraints (SCCs) during the manual upgrade by using `roxctl` CLI, you can seamlessly transition the {rh-rhacs-first} services to use the {osp} SCCs, ensuring compatibility and optimal security configurations across Central and all secured clusters.

.Procedure

ifndef::cloud-svc[]
. List all of the {product-title-short} services that are deployed on Central and all secured clusters:
endif::cloud-svc[]
ifdef::cloud-svc[]
. List all of the {product-title-short} services that are deployed on all secured clusters:
endif::cloud-svc[]
+
[source,terminal]
----
$ oc -n stackrox describe pods | grep 'openshift.io/scc\|^Name:'
----
+
.Example output
+
[source,text,subs="+quotes"]
----
Name:      admission-control-6f4dcc6b4c-2phwd
           *openshift.io/scc: stackrox-admission-control*
#...
Name:      central-575487bfcb-sjdx8
           *openshift.io/scc: stackrox-central*
Name:      central-db-7c7885bb-6bgbd
           *openshift.io/scc: stackrox-central-db*
Name:      collector-56nkr
           *openshift.io/scc: stackrox-collector*
#...
Name:      scanner-68fc55b599-f2wm6
           *openshift.io/scc: stackrox-scanner*
Name:      scanner-68fc55b599-fztlh
#...
Name:      sensor-84545f86b7-xgdwf
           *openshift.io/scc: stackrox-sensor*
#...
----
+
In this example, you can see that each pod has its own custom SCC, which is specified through the `openshift.io/scc` field.

. Add the required roles and role bindings to use the {osp} SCCs instead of the {product-title-short} custom SCCs.
ifndef::cloud-svc[]
+
To add the required roles and role bindings to use the {osp} SCCs for the Central cluster, complete the following steps:

.. Create a file named `update-central.yaml` that defines the role and role binding resources by using the following content:
+
.Example YAML file
[%collapsible]
====
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role # <1>
metadata:
  annotations:
     email: support@stackrox.com
     owner: stackrox
  labels:
     app.kubernetes.io/component: central
     app.kubernetes.io/instance: stackrox-central-services
     app.kubernetes.io/name: stackrox
     app.kubernetes.io/part-of: stackrox-central-services
     app.kubernetes.io/version: 4.4.0
  name: use-central-db-scc # <2>
  namespace: stackrox # <3>
Rules: # <4>
- apiGroups:
  - security.openshift.io
  resourceNames:
  - nonroot-v2
  resources:
  - securitycontextconstraints
  verbs:
  - use
- - -
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  annotations:
     email: support@stackrox.com
     owner: stackrox
  labels:
     app.kubernetes.io/component: central
     app.kubernetes.io/instance: stackrox-central-services
     app.kubernetes.io/managed-by: Helm
     app.kubernetes.io/name: stackrox
     app.kubernetes.io/part-of: stackrox-central-services
     app.kubernetes.io/version: 4.4.0
  name: use-central-scc
  namespace: stackrox
rules:
- apiGroups:
  - security.openshift.io
  resourceNames:
  - nonroot-v2
  resources:
  - securitycontextconstraints
  verbs:
  - use
- - -
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  annotations:
     email: support@stackrox.com
     owner: stackrox
  labels:
     app.kubernetes.io/component: scanner
     app.kubernetes.io/instance: stackrox-central-services
     app.kubernetes.io/name: stackrox
     app.kubernetes.io/part-of: stackrox-central-services
     app.kubernetes.io/version: 4.4.0
  name: use-scanner-scc
  namespace: stackrox
rules:
- apiGroups:
  - security.openshift.io
  resourceNames:
  - nonroot-v2
  resources:
  - securitycontextconstraints
  verbs:
  - use
- - -
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding # <5>
metadata:
  annotations:
     email: support@stackrox.com
     owner: stackrox
  labels:
     app.kubernetes.io/component: central
     app.kubernetes.io/instance: stackrox-central-services
     app.kubernetes.io/name: stackrox
     app.k ubernetes.io/part-of: stackrox-central-services
     app.kubernetes.io/version: 4.4.0
  name: central-db-use-scc # <6>
  namespace: stackrox
roleRef: # <7>
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: use-central-db-scc
subjects: # <8>
- kind: ServiceAccount
  name: central-db
  namespace: stackrox
- - -
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  annotations:
     email: support@stackrox.com
     owner: stackrox
  labels:
     app.kubernetes.io/component: central
     app.kubernetes.io/instance: stackrox-central-services
     app.kubernetes.io/name: stackrox
     app.kubernetes.io/part-of: stackrox-central-services
     app.kubernetes.io/version: 4.4.0
  name: central-use-scc
  namespace: stackrox
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: use-central-scc
subjects:
- kind: ServiceAccount
  name: central
  namespace: stackrox
- - -
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  annotations:
     email: support@stackrox.com
     owner: stackrox
  labels:
     app.kubernetes.io/component: scanner
     app.kubernetes.io/instance: stackrox-central-services
     app.kubernetes.io/name: stackrox
     app.kubernetes.io/part-of: stackrox-central-services
     app.kubernetes.io/version: 4.4.0
  name: scanner-use-scc
  namespace: stackrox
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: use-scanner-scc
subjects:
- kind: ServiceAccount
  name: scanner
  namespace: stackrox
- - -
----
<1> The type of Kubernetes resource, in this example, `Role`.
<2> The name of the role resource.
<3> The namespace in which the role is created.
<4> Describes the permissions granted by the role resource.
<5> The type of Kubernetes resource, in this example, `RoleBinding`.
<6> The name of the role binding resource.
<7> Specifies the role to bind in the same namespace.
<8> Specifies the subjects that are bound to the role.
====

.. Create the role and role binding resources specified in the `update-central.yaml` file by running the following command:
+
[source,terminal]
----
$ oc -n stackrox create -f ./update-central.yaml
----
endif::cloud-svc[]
. To add the required roles and role bindings to use the {osp} SCCs for all secured clusters, complete the following steps:

.. Create a file named `upgrade-scs.yaml` that defines the role and role binding resources by using the following content:
+
.Example YAML file
[%collapsible]
====
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role  # <1>
metadata:
  annotations:
     email: support@stackrox.com
     owner: stackrox
  labels:
     app.kubernetes.io/component: collector
     app.kubernetes.io/instance: stackrox-secured-cluster-services
     app.kubernetes.io/name: stackrox
     app.kubernetes.io/part-of: stackrox-secured-cluster-services
     app.kubernetes.io/version: 4.4.0
     auto-upgrade.stackrox.io/component: sensor
  name: use-privileged-scc  # <2>
  namespace: stackrox # <3>
rules:  # <4>
- apiGroups:
  - security.openshift.io
  resourceNames:
  - privileged
  resources:
  - securitycontextconstraints
  verbs:
  - use
- - -
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding # <5>
metadata:
  annotations:
     email: support@stackrox.com
     owner: stackrox
  labels:
     app.kubernetes.io/component: collector
     app.kubernetes.io/instance: stackrox-secured-cluster-services
     app.kubernetes.io/name: stackrox
     app.kubernetes.io/part-of: stackrox-secured-cluster-services
     app.kubernetes.io/version: 4.4.0
     auto-upgrade.stackrox.io/component: sensor
  name: collector-use-scc # <6>
  namespace: stackrox
roleRef: # <7>
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: use-privileged-scc
subjects: # <8>
- kind: ServiceAccount
  name: collector
  namespace: stackrox
- - -
----
<1> The type of Kubernetes resource, in this example, `Role`.
<2> The name of the role resource.
<3> The namespace in which the role is created.
<4> Describes the permissions granted by the role resource.
<5> The type of Kubernetes resource, in this example, `RoleBinding`.
<6> The name of the role binding resource.
<7> Specifies the role to bind in the same namespace.
<8> Specifies the subjects that are bound to the role.
====

.. Create the role and role binding resources specified in the `upgrade-scs.yaml` file by running the following command:
+
[source,terminal]
----
$ oc -n stackrox create -f ./update-scs.yaml
----
+
[IMPORTANT]
====
You must run this command on each secured cluster to create the role and role bindings specified in the `upgrade-scs.yaml` file.
====

. Delete the SCCs that are specific to {product-title-short}:
ifndef::cloud-svc[]
.. To delete the SCCs that are specific to the Central cluster, run the following command:
+
[source,terminal]
----
$ oc delete scc/stackrox-central scc/stackrox-central-db scc/stackrox-scanner
----
endif::cloud-svc[]
.. To delete the SCCs that are specific to all secured clusters, run the following command:
+
[source,terminal]
----
$ oc delete scc/stackrox-admission-control scc/stackrox-collector scc/stackrox-sensor
----
+
[IMPORTANT]
====
You must run this command on each secured cluster to delete the SCCs that are specific to each secured cluster.
====

.Verification

* Ensure that all the pods are using the correct SCCs by running the following command:
+
[source,terminal]
----
$ oc -n stackrox describe pods | grep 'openshift.io/scc\|^Name:'
----
+
Compare the output with the following table:
+
[cols="2,2,2",options="header"]
|===
|Component |Previous custom SCC |New {osp} 4 SCC

|Central
|`stackrox-central`
|`nonroot-v2`

|Central-db
|`stackrox-central-db`
|`nonroot-v2`

|Scanner
|`stackrox-scanner`
|`nonroot-v2`

|Scanner-db
|`stackrox-scanner`
|`nonroot-v2`

|Admission Controller
|`stackrox-admission-control`
|`restricted-v2`

|Collector
|`stackrox-collector`
|`privileged`

|Sensor
|`stackrox-sensor`
|`restricted-v2`
|===

ifeval::["{context}" == "upgrade-cloudsvc-roxctl"]
:!cloud-svc:
endif::[]