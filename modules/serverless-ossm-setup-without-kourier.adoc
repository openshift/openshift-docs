// Module included in the following assemblies:
//
// * serverless/service_mesh/serverless-enabling-ossm.adoc

[id="serverless-ossm-setup-without-kourier_{context}"]
= Using {ProductShortName} without Kourier enabled

If the default Kourier ingress is disabled for your {ServerlessProductName} deployment, you can follow this procedure to enable additional {ProductShortName} functionality on the cluster.

.Procedure

. Create a `ServiceMeshControlPlane` object in the `istio-system` namespace. For more information, see the _Deploying the Red Hat OpenShift Service Mesh control plane_ documentation for {ProductShortName}.
. Add the namespaces that you want to integrate with {ProductShortName} to the `ServiceMeshMemberRoll` object as members. You must ensure that that `knative-serving` is one of these namespaces. All namespaces that are running Knative services must also be part of this `ServiceMeshMemberRoll`.
+
.Example `ServiceMeshMemberRoll` object
[source,yaml]
----
apiVersion: maistra.io/v1
kind: ServiceMeshMemberRoll
metadata:
  name: default
  namespace: istio-system
spec:
  members:
  - knative-serving
  - default
----
. Create the necessary gateways so that {ProductShortName} accepts traffic:
+
.Example gateways
[source,yaml]
----
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: knative-ingress-gateway
  namespace: knative-serving
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 443
        name: https
        protocol: HTTPS
      hosts:
        - "*"
      tls:
        mode: SIMPLE
        credentialName: wildcard-certs <1>
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
 name: knative-local-gateway
 namespace: knative-serving
spec:
 selector:
   istio: ingressgateway
 servers:
   - port:
       number: 8081
       name: http
       protocol: HTTP <2>
     hosts:
       - "*"
---
apiVersion: v1
kind: Service
metadata:
 name: knative-local-gateway
 namespace: istio-system
 labels:
   experimental.istio.io/disable-gateway-port-translation: "true"
spec:
 type: ClusterIP
 selector:
   istio: ingressgateway
 ports:
   - name: http2
     port: 80
     targetPort: 8081
----
<1> These gateways reference the `wildcard-certs` secret that was created in the previous step.
<2> The `knative-local-gateway` gateway serves HTTP traffic. That means that traffic coming from outside of {ProductShortName} that uses an internal hostname, such as `example.default.svc.cluster.local`, is not encrypted. However, certificates for this path can be set up manually for the `knative-ingress-gateway` gateway.
. Install Knative Serving and enable the Istio integration:
+
[source,yaml]
----
apiVersion: operator.knative.dev/v1alpha1
kind: KnativeServing
metadata:
  name: knative-serving
  namespace: knative-serving
spec:
  ingress:
    istio:
      enabled: true <1>
  deployments: <2>
  - name: activator
    annotations:
      "sidecar.istio.io/inject": "true"
      "sidecar.istio.io/rewriteAppHTTPProbers": "true"
  - name: autoscaler
    annotations:
      "sidecar.istio.io/inject": "true"
      "sidecar.istio.io/rewriteAppHTTPProbers": "true"
----
<1> Enable the Knative and Istio integration.
<2> Enable sidecar injection for the Knative Serving `data-plane` pods.
+
[IMPORTANT]
====
Adding sidecar injection to pods in system namespaces such as `knative-serving` and `knative-serving-ingress` is not supported.
====
. Create a Knative service that has sidecar injection enabled and uses a pass-through route:
+
[source,yaml]
----
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: hello
  namespace: default
  annotations:
    serving.knative.openshift.io/enablePassthrough: "true" <1>
spec:
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "true" <2>
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      containers:
      - image: docker.io/openshift/hello-openshift
----
<1> Instruct Knative Serving to generate an Openshift route by using pass-through functionality, so that the certificates generated by the previous steps are served through the ingress gateway directly.
<2> You must ensure that the {ProductShortName} sidecar is injected into the service pods.

.Verification

* Access your serverless application by a secure connection that is now trusted by the CA:
+
[source,terminal]
----
$ curl --cacert wildcard.crt https://hello-default.example.com
----
+
.Example output
[source,terminal]
----
Hello Openshift!
----
