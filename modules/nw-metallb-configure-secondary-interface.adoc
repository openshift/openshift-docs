:_mod-docs-content-type: PROCEDURE
[id="nw-metallb-configure-secondary-interface_{context}"]
= Configuring MetalLB with secondary networks

[role="_abstract"]
To enable traffic forwarding for MetalLB on a secondary network interface, add a machine configuration that allows IP packet forwarding between interfaces. Implementing this configuration ensures that application services remain reachable when they use nondefault network paths.

[NOTE]
====
From {product-title} 4.14 the default network behavior does not allow forwarding of IP packets between network interfaces.

{product-title} clusters upgraded from 4.13 are not affected because a global parameter is set during an upgrade to enable global IP forwarding. 
====

To enable IP forwarding for the secondary interface, you have two options:

* Enable IP forwarding for a specific interface.
* Enable IP forwarding for all interfaces.

[NOTE]
====
Enabling IP forwarding for a specific interface provides more granular control, while enabling it for all interfaces applies a global setting.
====

.Procedure

. Patch the Cluster Network Operator, setting the parameter `routingViaHost` to `true` by running the following command: 
+
[source,terminal]
----
$ oc patch network.operator cluster -p '{"spec":{"defaultNetwork":{"ovnKubernetesConfig":{"gatewayConfig": {"routingViaHost": true} }}}}' --type=merge
----

. Enable forwarding for a specific secondary interface, such as `bridge-net`, by creating and applying a `MachineConfig` CR:
+
..  Base64-encode the string that is used to configure network kernel parameters by running the following command on your local machine:
+
[source,terminal]
----
$ echo -e "net.ipv4.conf.bridge-net.forwarding = 1" | base64 -w0
----
+
.Example output
[source,terminal]
----
bmV0LmlwdjQuY29uZi5icmlkZ2UtbmV0LmZvcndhcmRpbmcgPSAxCg==
----
+
.. Create the `MachineConfig` CR to enable IP forwarding for the specified secondary interface named `bridge-net`.
+
.. Save the following YAML in the `enable-ip-forward.yaml` file:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: <node_role>
  name: 81-enable-global-forwarding
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,bmV0LmlwdjQuY29uZi5icmlkZ2UtbmV0LmZvcndhcmRpbmcgPSAxCg==
          verification: {}
        filesystem: root
        mode: 420
        path: /etc/sysctl.d/enable-global-forwarding.conf
  osImageURL: ""
# ...
----
+
where:
+
`<node_role>`:: Node role where you want to enable IP forwarding, for example, `worker`.
`contents.source`:: Populate with the generated Base64 string.
+
.. Apply the configuration by running the following command:
+
[source,terminal]
----
$ oc apply -f enable-ip-forward.yaml
----

. Optional: Enable IP forwarding globally by running the following command:
+
[source,terminal]
----
$ oc patch network.operator cluster -p '{"spec":{"defaultNetwork":{"ovnKubernetesConfig":{"gatewayConfig":{"ipForwarding": "Global"}}}}}' --type=merge
----

.Verification

.  After you apply the machine config, verify the changes by completing the following steps: 
+
.. Enter into a debug session on the target node by running the following command. This command instantiates a debug pod called `<node-name>-debug`.
+
[source,terminal]
----
$ oc debug node/<node-name>
----
+
.. Set `/host` as the root directory within the debug shell by running the following command. The debug pod mounts root file system of the host in `/host` within the pod. By changing the root directory to `/host`, you can run binaries contained in the executable paths of the host.
+
[source,terminal]
----
$ chroot /host
----
+
.. Verify that IP forwarding is enabled by running the following command: 
+
[source,terminal]
----
$ cat /etc/sysctl.d/enable-global-forwarding.conf
----
+
.Example output
[source,terminal]
----
net.ipv4.conf.bridge-net.forwarding = 1 
----
+
The output indicates that IPv4 forwarding is enabled on the `bridge-net` interface.
