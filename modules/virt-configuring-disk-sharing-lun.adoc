// Module included in the following assemblies:
//
// *  virt/virtual_machines/virtual_disks/virt-configuring-shared-volumes-for-vms.adoc

:_content-type: PROCEDURE
[id="virt-configuring-disk-sharing-lun_{context}"]
= Configuring disk sharing by using LUN

You can configure a LUN-backed virtual machine (VM) disk to be shared among multiple virtual machines by enabling SCSI persistent reservation. Enabling the shared option allows you to use advanced SCSI commands, such as those required for a Windows failover clustering implementation, against the underlying storage. Any disk to be shared must be in block mode.

A disk of type `LUN` exposes the volume as a LUN device to the VM. This allows the VM to execute arbitrary iSCSI command passthrough on the disk.

You reserve a LUN through the SCSI persistent reserve options to protect data on the VM from outside access. To enable the reservation, you configure the feature gate option. You then activate the option on the LUN disk to issue SCSI device-specific input and output controls (IOCTLs) that the VM requires.

You can set an error policy for each LUN disk. The error policy controls how the hypervisor behaves when an input/output error occurs on a disk Read or Write. The default behavior stops the guest and generates a Kubernetes event.

For a LUN disk with an iSCSi connection and a persistent reservation, as required for Windows Failover Clustering for shared volumes, you set the error policy to `report`.

.Prerequisites

* You must have cluster administrator privileges to configure the feature gate option.

* The volume access mode must be `ReadWriteMany` (RWX) if the VMs that are sharing disks are running on different nodes.
+
If the VMs that are sharing disks are running on the same node, `ReadWriteOnce` (RWO) volume access mode is sufficient.
* The storage provider must support a Container Storage Interface (CSI) driver that uses the SCSI protocol.
* If you are a cluster administrator and intend to configure disk sharing by using LUN, you must enable the cluster's feature gate on the `HyperConverged` custom resource (CR).

.Procedure

. Edit or create the `VirtualMachine` manifest for your VM to set the required values, as shown in the following example:
+
[source,yaml]
----
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: vm-0
spec:
  template:
    spec:
      domain:
        devices:
          disks:
          - disk:
              bus: sata
            name: rootdisk
          - errorPolicy: report <1>
            lun: <2>
              bus: scsi
              reservation: true <3>
            name: na-shared
            serial: shared1234
      volumes:
      - dataVolume:
          name: vm-0
        name: rootdisk
      - name: na-shared
        persistentVolumeClaim:
          claimName: pvc-na-share
----
<1> Identifies the error policy.
<2> Identifies a LUN disk.
<3> Identifies that the persistent reservation is enabled.

. Save the `VirtualMachine` manifest file to apply your changes.