// Module is included in the following assemblies:
//
// * securing_openshift_gitops/managing-secrets-securely-using-sscsid-with-gitops.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-configuring-sscsi-driver-to-mount-secrets-from-aws-secrets-manager_{context}"]
= Configuring SSCSI driver to mount secrets from AWS Secrets Manager

To store and manage your secrets securely, use {gitops-shortname} workflows and configure the Secrets Store Container Storage Interface (SSCSI) Driver Operator to mount secrets from AWS Secrets Manager to a CSI volume in {OCP}. For example, consider that you want to mount a secret to a deployment pod under the `dev` namespace which is in the `/environments/dev/` directory.

.Prerequisites

* You have the AWS Secrets Manager resources stored in your {gitops-shortname} repository.

.Procedure

. Grant privileged access to the `csi-secrets-store-provider-aws` service account by running the following command:
+
[source,terminal]
----
$ oc adm policy add-scc-to-user privileged -z csi-secrets-store-provider-aws -n openshift-cluster-csi-drivers
----
+
.Example output
[source,terminal]
----
clusterrole.rbac.authorization.k8s.io/system:openshift:scc:privileged added: "csi-secrets-store-provider-aws"
----

. Grant permission to allow the service account to read the AWS secret object:

.. Create a `credentialsrequest-dir-aws` folder under a namespace-scoped directory in your {gitops-shortname} repository because the credentials request is namespace-scoped. For example, create a `credentialsrequest-dir-aws` folder under the `dev` namespace which is in the `/environments/dev/` directory by running the following command:
+
[source,terminal]
----
$ mkdir credentialsrequest-dir-aws
----

.. Create a YAML file with the following configuration for the credentials request in the `/environments/dev/credentialsrequest-dir-aws/` path to mount a secret to the deployment pod in the `dev` namespace:
+
.Example `credentialsrequest.yaml` file
[source,yaml]
----
apiVersion: cloudcredential.openshift.io/v1
kind: CredentialsRequest
metadata:
  name: aws-provider-test
  namespace: openshift-cloud-credential-operator
spec:
  providerSpec:
    apiVersion: cloudcredential.openshift.io/v1
    kind: AWSProviderSpec
    statementEntries:
    - action:
      - "secretsmanager:GetSecretValue"
      - "secretsmanager:DescribeSecret"
      effect: Allow
      resource: "<aws_secret_arn>" # <2>
secretRef:
  name: aws-creds
  namespace: dev # <1>
serviceAccountNames:
  - default
----
<1> The namespace for the secret reference. Update the value of this `namespace` field according to your project deployment setup.
<2> The ARN of your secret in the region where your cluster is on. The `<aws_region>` of `<aws_secret_arn>` has to match the cluster region. If it does not match, create a replication of your secret in the region where your cluster is on. 
+
[TIP]
====
To find your cluster region, run the command:

[source,terminal]
----
$ oc get infrastructure cluster -o jsonpath='{.status.platformStatus.aws.region}'
----

.Example output
[source,terminal]
----
us-west-2
----
====

.. Retrieve the OIDC provider by running the following command:
+
[source,terminal]
----
$ oc get --raw=/.well-known/openid-configuration | jq -r '.issuer'
----
+
.Example output
[source,terminal]
----
https://<oidc_provider_name>
----
Copy the OIDC provider name `<oidc_provider_name>` from the output to use in the next step.

.. Use the `ccoctl` tool to process the credentials request by running the following command:
+
[source,terminal]
----
$ ccoctl aws create-iam-roles \
    --name my-role --region=<aws_region> \
    --credentials-requests-dir=credentialsrequest-dir-aws \
    --identity-provider-arn arn:aws:iam::<aws_account>:oidc-provider/<oidc_provider_name> --output-dir=credrequests-ccoctl-output
----
+
.Example output
[source,terminal]
----
2023/05/15 18:10:34 Role arn:aws:iam::<aws_account_id>:role/my-role-my-namespace-aws-creds created
2023/05/15 18:10:34 Saved credentials configuration to: credrequests-ccoctl-output/manifests/my-namespace-aws-creds-credentials.yaml
2023/05/15 18:10:35 Updated Role policy for Role my-role-my-namespace-aws-creds
----
+
Copy the `<aws_role_arn>` from the output to use in the next step. For example, `arn:aws:iam::<aws_account_id>:role/my-role-my-namespace-aws-creds`.

.. Check the role policy on AWS to confirm the `<aws_region>` of `"Resource"` in the role policy matches the cluster region:
+
.Example role policy
[source,json]
----
{
	"Version": "2012-10-17",
	"Statement": [
		{
			"Effect": "Allow",
			"Action": [
				"secretsmanager:GetSecretValue",
				"secretsmanager:DescribeSecret"
			],
			"Resource": "arn:aws:secretsmanager:<aws_region>:<aws_account_id>:secret:my-secret-xxxxxx"
		}
	]
}
----

.. Bind the service account with the role ARN by running the following command:
+
[source,terminal]
----
$ oc annotate -n <namespace> sa/<app_service_account> eks.amazonaws.com/role-arn="<aws_role_arn>"
----
+
.Example command
[source,terminal]
----
$ oc annotate -n dev sa/default eks.amazonaws.com/role-arn="<aws_role_arn>"
----
+
.Example output
[source,terminal]
----
serviceaccount/default annotated
----

. Create a namespace-scoped `SecretProviderClass` resource to define your secrets store provider. For example, you create a `SecretProviderClass` resource in `/environments/dev/apps/app-taxi/services/taxi/base/config` directory of your {gitops-shortname} repository.

.. Create a `secret-provider-class-aws.yaml` file in the same directory where the target deployment is located in your {gitops-shortname} repository: 
+
.Example `secret-provider-class-aws.yaml`
[source,yaml]
----
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: my-aws-provider # <1>
  namespace: dev # <2>
spec:
  provider: aws # <3>
  parameters: # <4>
    objects: |
      - objectName: "testSecret" # <5>
        objectType: "secretsmanager"
----
<1> Name of the secret provider class.
<2> Namespace for the secret provider class. The namespace must match the namespace of the resource which will use the secret.
<3> Name of the secret store provider.
<4> Specifies the provider-specific configuration parameters.
<5> The secret name you created in AWS. 

.. Verify that after pushing this YAML file to your {gitops-shortname} repository, the namespace-scoped `SecretProviderClass` resource is populated in the target application page in the Argo CD UI.  
+
[NOTE]
====
If the Sync Policy of your application is not set to `Auto`, you can manually sync the `SecretProviderClass` resource by clicking *Sync* in the Argo CD UI.
====