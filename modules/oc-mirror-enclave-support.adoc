// Module included in the following assemblies:
//
// * installing/disconnected_install/installing-mirroring-disconnected-v2.adoc

:_mod-docs-content-type: Procedure
[id="oc-mirror-enclave-support_{context}"]
== How to mirror to an enclave

The following diagram will be used to illustrate the workflow for mirroring to enclaves, with an intermediate disconnected network stage, called airgap environment in the diagram.

[Diagram for enclave support should be inserted here]

.Phase 1-Mirroring to the airgap environment (on-premise registry)

The goal of this phase is to transfer the images needed by one or several enclaves into the enterprise's central registry.

The central registry (`enterprise-registry.in` in the diagram) is usually in a secure network (air-gap environment in the diagram), not directly connected to the public internet.

.Procedure

. Generating a mirror archive
+
The end-user will execute oc-mirror in an environment with access to the public internet. This is illustrated as arrow 1 in the diagram.

.. The following action collects all the {product-title} content into an archive and generates an archive on disk (under `<file path>/enterprise-content`).
+
[source,terminal]
----
oc-mirror --v2 -c isc.yaml file://<file path>/enterprise-content
----
+
.Example of isc.yaml:
[source,yaml]
----
apiVersion: mirror.openshift.io/v2alpha1
kind: ImageSetConfiguration
mirror:
  platform:
    architectures:
      - "amd64"
    channels:
      - name: stable-4.15
        minVersion: 4.15.0
        maxVersion: 4.15.3
----

. Archive transfer to the air gap environment
+
Once the archive is generated, it will be transferred to the air gap environment. The transport mechanism is not part of oc-mirror, and depends on the strategies set up by the enterprise's network administrators.
+
In some cases, the transfer is done manually: the disk is physically unplugged from one location, and plugged to another computer in the air -ap environment. In other cases, SFTP or other protocols may be used.

. Mirroring contents into the (on-premise) air-gap environment registry
+
Once the transfer of the archive generated in Step1 is done, you can execute oc-mirror again in order to mirror the relevant archive contents to the registry (`entrerpise-registry.in` in the example). 
+
[source,terminal]
----
oc-mirror --v2 -c isc.yaml --from file://<air gap env file path>/enterprise-content docker://<enterprise-registry.in>/
----
+
In the above command:
* `--from` points to the folder containing the archive as generated by Phase 1a. It starts with the `file://`.
* The destination of the mirroring is the final argument. Being a docker registry, it is prefixed by `docker://`.
* `-c` or `--config` is still a mandatory argument, it allows oc-mirror to eventually mirror only sub-parts of the archive to the registry. This is specifically interesting for enclaves, where one archive may contain several OCP releases, while the air gap environment (or an enclave) is only interested in mirroring a few.

.Phase 2 - Mirroring to the enclave

Once all mirroring content has been transferred to the enterprise's central registry (enterprise-registry.in in the example), the users might be interested in mirroring OCP content from that internal registry to one or more enclaves.

In order to do so, the same or a new imagesetConfig, describing the content that needs to be mirrored to the enclave is prepared.

.Example isc-enclave.yaml
[source,yaml]
----
apiVersion: mirror.openshift.io/v2alpha1
kind: ImageSetConfiguration
mirror:
  platform:
    architectures:
      - "amd64"
    channels:
      - name: stable-4.15
        minVersion: 4.15.2
        maxVersion: 4.15.2
----

oc-mirror needs to be run on a machine with access to the disconnected registry (ie. with ref. to our example: in the air gap environment, where enterprise-registry.in is accessible).

. Updating the registries.conf
+
Prior to running oc-mirror in the air gap environment, the user needs to set up the registries.conf file. This is illustrated by arrow 4 in the diagram.
+
The link:https://github.com/containers/image/blob/main/docs/containers-registries.conf.5.md#example[file specification] suggests to store the file under `$HOME/.config/containers/registries.conf`, otherwise `/etc/containers/registries.conf`.
+
The TOML format of the file is also described in the above specification.
+
.Example registries.conf
[source,toml]
----
[[registry]]
location="registry.redhat.io"
[[registry.mirror]]
location="<enterprise-registry.in>"

[[registry]]
location="quay.io"
[[registry.mirror]]
location="<enterprise-registry.in>"
----

.. Update Graph URL
+
If you are using `graph:true`, oc-mirror will attempt to reach the cincinnati API endpoint. Since this environment is air gapped, make sure you export environment variable `UPDATE_URL_OVERRIDE` to reference the URL for the OSUS (OpenShift UpdateService), like so:
+
[source,terminal]
----
export UPDATE_URL_OVERRIDE=https://<osus.enterprise.in>/graph
----
+
For more information on how to setup OSUS on an OpenShift cluster, please refer to the link:https://docs.openshift.com/container-platform/4.14/updating/updating_a_cluster/updating_disconnected_cluster/disconnected-update-osus.html[documentation].

. Generating a mirror archive from the enterprise registry for the enclave
+
In order to prepare an archive for the enclave1, as illustrated as arrow 5 in the diagram, the user executes oc-mirror in the enterprise airgap env, using the imageSetConfig specific for that enclave. This ensures that only images needed by that enclave are mirrored:
+
[source,terminal]
----
oc-mirror --v2 -c isc-enclave.yaml
file:///disk-enc1/
----
+
This action collects all the OCP content into an archive and generates an archive on disk (under `/disk-enc1/` in the diagram).

. Archive transfer to enclave
+
Once the archive is generated, it will be transferred to the `enclave1` network. The transport mechanism is not the responsibility of oc-mirror. 

. Mirroring contents to the enclave registry
+
Once the transfer of the archive generated in Step5 is done (to `/local-disk` in the diagram), the user can execute oc-mirror again in order to mirror the relevant archive contents to the registry (`registry.enc1.in` in the diagram). This is illustrated by arrow 7 in the diagram.
+
[source,terminal]
----
oc-mirror --v2 -c isc-enclave.yaml
--from /local-disk docker://registry.enc1.in
----
+
The administrators of the {product-title} cluster in Enclave1 are now ready to install or upgrade that cluster.
