:_mod-docs-content-type: CONCEPT
[id="customize-installation-operator-overlays_{context}"]

= Customizing the installation using the Operator with overlays

[role="_abstract"]
Learn how to tailor the installation of {product-title-short} using the Operator method with overlays.

[id="overlays_{context}"]
== Overlays

When `Central` or `SecuredCluster` custom resources don't expose certain low-level configuration options as parameters,
you can use the `.spec.overlays` field for adjustments. Use this field to amend the Kubernetes resources
generated by these custom resources.

The `.spec.overlays` field comprises a sequence of patches, applied in their listed order. These patches are processed
by the Operator on the Kubernetes resources before deployment to the cluster.

[WARNING]
====
The `.spec.overlays` field in both `Central` and `SecuredCluster` allows users to modify
low-level Kubernetes resources in arbitrary ways. Use this feature only when the desired customization
is not available through the `SecuredCluster` or `Central` custom resources.

Support for the `.spec.overlays` feature is limited primarily because it grants the ability to
make intricate and highly specific modifications to Kubernetes resources, which can vary significantly
from one implementation to another. This level of customization introduces a complexity that goes beyond
standard usage scenarios, making it challenging to provide broad support. Each modification can
be unique, potentially interacting with the Kubernetes system in unpredictable ways across
different versions and configurations of the product. This variability means that troubleshooting and
guaranteeing the stability of these customizations require a level of expertise and understanding specific
to each individual's setup. Consequently, while this feature empowers tailoring Kubernetes resources
to meet precise needs, greater responsibility must also assumed to ensure the compatibility and stability
of configurations, especially during upgrades or changes to the underlying product.

====

The following example shows the structure of an overlay:
[source,yaml]
----
overlays:
- apiVersion: v1         # <1>
  kind: ExampleKind      # <2>
  name: my-resource      # <3>
  patches:
    - path: .some.field  # <4>
      value: |           # <5>
        key1: data2
        key2: data2
----

<1> Targeted Kubernetes resource ApiVersion, for example `apps/v1`, `v1`, `networking.k8s.io/v1`
<2> Resource type (e.g., Deployment, ConfigMap, NetworkPolicy)
<3> Name of the resource, for example `my-resource`
<4> JSONPath expression to the field, for example `spec.template.spec.containers[name:central].env[-1]`
<5> YAML string for the new field value. If you do not want to use YAML parsing, you can use the `verbatim` key as shown in the following ConfigMap example.

[id="adding-an-overlay_{context}"]
=== Adding an overlay

For customizations, you can add overlays to `Central` or `SecuredCluster` custom resources. Use the OpenShift CLI (`oc`)
or the OpenShift Container Platform web console for modifications.

If overlays do not take effect as expected, check the {product-title-short} Operator logs for any syntax errors or
issues logged.

[id="examples_{context}"]
== Overlay examples

[id="adding-eks-role-arn-annotation_{context}"]
=== Specifying an EKS pod role ARN for the Central ServiceAccount

Add an Amazon Elastic Kubernetes Service (EKS) pod role Amazon Resource Name (ARN) annotation to the `central` 
ServiceAccount as shown in the following example:

[source,yaml]
----
apiVersion: platform.stackrox.io
kind: Central
metadata:
  name: central
spec:
  # ...
  overlays:
  - apiVersion: v1
    kind: ServiceAccount
    name: central
    patches:
      - path: metadata.annotations.eks\.amazonaws\.com/role-arn
        value: "\"arn:aws:iam:1234:role\""
----

[id="adding-an-environment-variable-to-a-deployment_{context}"]
=== Injecting an environment variable into the Central deployment

Inject an environment variable into the `central` deployment as shown in the following example:

[source,yaml]
----
apiVersion: platform.stackrox.io
kind: Central
metadata:
  name: central
spec:
  # ...
  overlays:
  - apiVersion: apps/v1
    kind: Deployment
    name: central
    patches:
    - path: spec.template.spec.containers[name:central].env[-1]
      value: |
        name: MY_ENV_VAR
        value: value
----

[id="adding-an-ingress-to-a-network-policy_{context}"]
=== Extending network policy with an ingress rule

Add an ingress rule to the `allow-ext-to-central` network policy for port 999 traffic as shown in the following example:

[source,yaml]
----
apiVersion: platform.stackrox.io
kind: Central
metadata:
  name: central
spec:
    # ...
    overlays:
    - apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      name: allow-ext-to-central
      patches:
        - path: spec.ingress[-1]
          value: |
            ports:
            - port: 999
              protocol: TCP
----

[id="changing-configmap-data_{context}"]
=== Modifying ConfigMap data

Modify the `central-endpoints` ConfigMap data as shown in the following example:

[source,yaml]
----
apiVersion: platform.stackrox.io
kind: Central
metadata:
  name: central
spec:
    # ...
    overlays:
    - apiVersion: v1
      kind: ConfigMap
      name: central-endpoints
      patches:
      - path: data.endpoints\.yaml
        verbatim: |
          disableDefault: false
          # another line
----

This example shows how to override only a single item (file) under `data`.

Follow this example by taking these steps:

* Use the `verbatim` key, rather than `value`.
This helps pass through characters such as newlines or quotes so that they are unaffected.
* You must escape the dot in the filename in the `path` key as shown, or
 you can write the path as `data["endpoints.yaml"]`.

[id="adding-a-container-to-a-deployment_{context}"]
=== Adding a container to the `Central` deployment

Add a new container to the `central` deployment as shown in the following example:.

[source,yaml]
----
apiVersion: platform.stackrox.io
kind: Central
metadata:
  name: central
spec:
    # ...
    overlays:
    - apiVersion: apps/v1
      kind: Deployment
      name: central
      patches:
        - path: spec.template.spec.containers[-1]
      value: |
        name: nginx
        image: nginx
        ports:
          - containerPort: 8000
            name: http
            protocol: TCP
----
