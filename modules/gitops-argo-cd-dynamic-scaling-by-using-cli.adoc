// Module included in the following assemblies:
//
// * declarative_clusterconfig/sharding-clusters-across-argo-cd-application-controller-replicas.adoc

:_mod-docs-content-type: PROCEDURE

:oc-first: pass:quotes[OpenShift CLI (`oc`)]

[id="gitops-argo-cd-dynamic-scaling-by-using-cli_{context}"]
= Enabling dynamic scaling of shards by using the CLI

You can enable dynamic scaling of shards by using the {oc-first}.

.Prerequisites
* You have installed the {gitops-title} Operator on your {OCP} cluster.
* You have access to the cluster with `cluster-admin` privileges.

.Procedure

. Log in to the cluster by using the `oc` tool as a user with `cluster-admin` privileges.

. Enable dynamic scaling by running the following command:
+
[source,terminal]
----
$ oc patch argocd <argocd_instance> -n <namespace> --type=merge --patch='{"spec":{"controller":{"sharding":{"dynamicScalingEnabled":true,"minShards":<value>,"maxShards":<value>,"clustersPerShard":<value>}}}}'
----
+
.Example command
[source,terminal]
----
$ oc patch argocd openshift-gitops -n openshift-gitops --type=merge --patch='{"spec":{"controller":{"sharding":{"dynamicScalingEnabled":true,"minShards":1,"maxShards":3,"clustersPerShard":1}}}}' <1>
----
+
<1> The example command enables dynamic scaling for the `openshift-gitops` Argo CD instance in the `openshift-gitops` namespace, and sets the minimum number of shards to `1`, the maximum number of shards to `3`, and the number of clusters per shard to `1`. The values of `minShard` and `clustersPerShard` must be set to `1` or greater. The value of `maxShard` must be equal to or greater than the value of `minShard`.
+
.Example output
[source,terminal]
----
argocd.argoproj.io/openshift-gitops patched
----

.Verification

. Check the `spec.controller.sharding` properties of the Argo CD instance:
+
[source,terminal]
----
$ oc get argocd <argocd_instance> -n <namespace> -o jsonpath='{.spec.controller.sharding}'
----
+
.Example command 
[source,terminal]
----
$ oc get argocd openshift-gitops -n openshift-gitops -o jsonpath='{.spec.controller.sharding}'
----
+
.Example output when dynamic scaling of shards is enabled
[source,terminal]
----
{"dynamicScalingEnabled":true,"minShards":1,"maxShards":3,"clustersPerShard":1}
----

. Optional: Verify that dynamic scaling is enabled by checking the configured `spec.controller.sharding` properties in the configuration `YAML` file of the Argo CD instance in the {OCP} web console.

. Check the number of Argo CD Application Controller pods:
+
[source,terminal]
----
$ oc get pods -n <namespace> -l app.kubernetes.io/name=<argocd_instance>-application-controller
----
+
.Example command
[source,terminal]
----
$ oc get pods -n openshift-gitops -l app.kubernetes.io/name=openshift-gitops-application-controller
----
+
.Example output
[source,terminal]
----
NAME                                           READY   STATUS    RESTARTS   AGE
openshift-gitops-application-controller-0      1/1     Running   0          2m  <1>
----
+
<1> The number of Argo CD Application Controller pods must be equal to or greater than the value of `minShard`.

[role="_additional-resources"]
[id="additional-resources_argocd-cr-properties"]
= Additional resources
* link:https://docs.openshift.com/gitops/1.11/argocd_instance/argo-cd-cr-component-properties.html#argo-cd-properties_argo-cd-cr-component-properties[Argo CD custom resource properties]

* link:https://docs.openshift.com/container-platform/4.14/nodes/pods/nodes-pods-autoscaling.html[Automatically scaling pods with the horizontal pod autoscaler]