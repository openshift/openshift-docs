// Module included in the following assemblies:
//
// * knative-serving/config-applications/configuring-revision-timeouts.adoc

:_mod-docs-content-type: PROCEDURE
[id="configuring-default-route-timeouts-globally_{context}"]
= Configuring the default route timeouts globally

By configuring the route timeouts globally, you can ensure consistent timeout settings across all services, simplifying management for workloads that have similar timeout needs and reducing the need for individual adjustments.

You can configure the route timeouts globally by updating the `ROUTE_HAPROXY_TIMEOUT` environment value in your `serverless-operator` subscription and updating the `max-revision-timeout-seconds` field in your `KnativeServing` custom resource (CR). This applies the timeout changes across all Knative services, and you can deploy services with specific timeouts up to the maximum value set.

`ROUTE_HAPROXY_TIMEOUT` is an environment variable managed by the Serverless Operator and by default is set to `600`.

.Procedure

. Set the value of `ROUTE_HAPROXY_TIMEOUT` in your subscription to your required timeout in seconds by running the following command. Note that this causes pods in the `openshift-serverless` namespace  to be redeployed.
+
.Setting the `ROUTE_HAPROXY_TIMEOUT` value to 900 seconds
[source,terminal]
----
$ oc patch subscription.operators.coreos.com serverless-operator -n openshift-serverless --type='merge' -p '{"spec": {"config": {"env": [{"name": "ROUTE_HAPROXY_TIMEOUT", "value": "900"}]}}}'
----
+
Alternatively, you can set the value of `ROUTE_HAPROXY_TIMEOUT` in your subscription directly:
+
.A subscription definition with `ROUTE_HAPROXY_TIMEOUT` set to 900 seconds
[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
#...
spec:
  channel: stable
  config:
    env:
      - name: ROUTE_HAPROXY_TIMEOUT
        value: '900'
#...
----
+
[NOTE]
====
If you created your routes manually and disabled auto-generation with the `serving.knative.openshift.io/disableRoute` annotation, you can configure the timeouts directly in the route definitions.
====

. Set the maximum revision timeout in your `KnativeServing` CR:
+
.`KnativeServing` CR with `max-revision-timeout-seconds` set to 900 seconds
[source,yaml]
----
apiVersion: operator.knative.dev/v1beta1
kind: KnativeServing
metadata:
  name: knative-serving
spec:
  config:
    defaults:
      max-revision-timeout-seconds: "900"
#...
----
+
The Serverless Operator automatically adjusts the `terminationGracePeriod` value of the activator to the set maximum revision timeout value to avoid request termination in cases where activator pods are being terminated themselves.
+
. Optional: Verify that the timeout has been set by running the following command: 
+
[source,terminal]
----
$ oc get deployment activator -n knative-serving -o jsonpath="{.spec.template.spec.terminationGracePeriodSeconds}"
----

. If necessary for your cloud provider, adjust the load balancer timeout by running the following command:
+
.Load balancer timeout adjustment for AWS Classic LB 
[source,terminal]
----
$ oc -n openshift-ingress-operator patch ingresscontroller/default --type=merge --patch=' \
  {"spec":{"endpointPublishingStrategy":  \
  {"type":"LoadBalancerService", "loadBalancer":  \
  {"scope":"External", "providerParameters":{"type":"AWS", "aws":  \
  {"type":"Classic", "classicLoadBalancer":  \
  {"connectionIdleTimeout":"20m"}}}}}}}'
----

. Deploy a Knative service with the desired timeouts less or equal to the `max-revision-timeout-seconds` variable:
+
.A Service definition with timeouts set to 800 seconds
[source,yaml]
----
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: example-service-name
spec:
  template:
    spec:
      timeoutSeconds: 800
      responseStartTimeoutSeconds: 800
----
+
[IMPORTANT]
====
When using {SMProductShortName}, if the activator pod is stopped while a long-running request is in-flight, the request is interrupted.
To avoid request interruptions, you must adjust the value of the `terminationDrainDuration` field in the `ServiceMeshControlPlane` CR: 
[source,yaml]
----
apiVersion: maistra.io/v2
kind: ServiceMeshControlPlane
#...
spec: 
  techPreview:
      meshConfig:
        defaultConfig:
          terminationDrainDuration: 1000s <1>
#... 
----
<1> Ensure that the value exceeds the request duration to avoid the Istio proxy shutdown, which would interrupt the request.
====

.Verification

* If you are using Kourier, you can verify the current value of the timeout at the {ocp-product-title} route by running the following command:
+
[source,terminal]
----
$ oc get route <route_name> -n knative-serving-ingress ess -o jsonpath="{.metadata.annotations.haproxy\.router\.openshift\.io/timeout}"
800s
----
