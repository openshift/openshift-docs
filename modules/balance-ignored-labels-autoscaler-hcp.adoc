/ Module included in the following assemblies:
//
// * hosted_control_planes/hcp-machine-config.adoc

:_mod-docs-content-type: PROCEDURE
[id="balance-ignored-labels-autoscaler-hcp_{context}"]
= Balancing ignored labels in a hosted cluster

You can use the `node.group.balancing.ignored` label to evenly distribute the machines provisioned by different node pools with the same balancing ignored labels.

.Prerequisites

* You have created the `HostedCluster` and `NodePool` resources.

.Procedure

. Add the `nodeLabels` field to each of your node pool by using the following command:
+
[source,terminal]
----
$ oc patch -n <hosted_cluster_namespace> \
  nodepool <node_pool_name> \
  --type=merge \
  --patch='{"spec": {"nodeLabels": {"node.group.balancing.ignored": "<label_name>"}}}'
----

. Enable cluster autoscaling for the hosted cluster by running the following command:
+
[source,terminal]
----
$ oc patch -n <hosted_cluster_namespace> \
  hostedcluster<hosted_cluster_name> \
  --type=merge \
  --patch='{"spec": {"autoscaling": {"scaling": "ScaleUpAndScaleDown", "maxPodGracePeriod": 60, "maxFreeDifferenceRatioPercent": 50, "scaleDown": {"delayAfterAddSeconds": 60, "delayAfterDeleteSeconds": 60, "delayAfterFailureSeconds": 60, "unneededDurationSeconds": 60, "utilizationThresholdPercent": 50}, "expanders": ["Random"]}}}'
----

. Enable autoscaling for each of your node pool by running the following command:
+
[source,terminal]
----
$ oc patch -n <hosted_cluster_namespace> \
  nodepool <node_pool_name> \
  --type=json \
  --patch='[{"op": "remove", "path": "/spec/replicas"}]'
----

. Generate the `kubeconfig` file by running the following command:
+
[source,terminal]
----
$ hcp create kubeconfig --name <hosted_cluster_name> --namespace <hosted_cluster_namespace> > nested.config
----

. Check that all worker nodes are in the `Ready` status by running the following command:
+
[source,terminal]
----
$ oc --kubeconfig nested.config get nodes -l 'hypershift.openshift.io/nodePool=<node_pool_name>'
----

. Check that the newly provisioned nodes contain the `node.group.balancing.ignored` label by running the following command:
+
[source,terminal]
----
$ oc --kubeconfig nested.config get nodes -l 'hypershift.openshift.io/nodePool=<node_pool_name>' -o jsonpath='{.items[].metadata.labels}'|jq|grep "node.group.balancing.ignored"
----

. Ensure that the `cluster-autoscaler` pod does not contain the `--balancing-ignore-label=node.group.balancing.ignored` argument by running the following command:
+
[source,terminal]
----
$ oc get pod `<cluster_autoscaler_pod_name>` -n <hosted_control_plane_namespace> -o jsonpath='{.spec.containers[0].args}'|jq
----

. Enable cluster autoscaling for your hosted cluster by running the following command:
+
[source,terminal]
----
$ oc patch -n <hosted_cluster_namespace> hostedcluster <hosted_cluster_name> --type=merge --patch='{"spec": {"autoscaling": {"balancingIgnoredLabels": ["node.group.balancing.ignored"]}}}'
----

.Verification

. Verify that the new nodes contain the `node.group.balancing.ignored` label by running the following command:
+
[source,terminal]
----
$ oc --kubeconfig nested.config get nodes -l 'hypershift.openshift.io/nodePool=<node_pool_name>' -o jsonpath='{.items[].metadata.labels}'|jq|grep "node.group.balancing.ignored"
----

. Verify that the `cluster-autoscaler` pod contains the `--balancing-ignore-label=node.group.balancing.ignored` argument by running the following command:
+
[source,terminal]
----
$ oc get pod `<cluster_autoscaler_pod_name>` -n <hosted_control_plane_namespace> -o jsonpath='{.spec.containers[0].args}'|jq
----

. Verify that the number of nodes provisioned by each node pool are evenly distributed. For example, if you created three node pools, the even distribution of nodes on node pool would be 3,2, and 3. Run the following command:
+
[source,terminal]
----
$ oc --kubeconfig nested.config get nodes -l 'hypershift.openshift.io/nodePool=<node_pool_name>'
----
