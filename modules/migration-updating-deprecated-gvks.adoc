// Module included in the following assemblies:
// migration/migrating_3_4/troubleshooting.adoc
// for CAM 1.2/4.4 only
[id='migration-gvk-incompatibility_{context}']
= Updating deprecated API `GroupVersionKinds`

In {product-title} {product-version}, some API `GroupVersionKinds` (GVKs) that are used by {product-title} 3.x are link:https://kubernetes.io/blog/2019/07/18/api-deprecations-in-1-16/[deprecated].

If your source cluster uses deprecated GVKs, the following warning is displayed when you create a migration plan: `Some namespaces contain GVKs incompatible with destination cluster`. You can click *See details* to view the namespace and the incompatible GVKs.

[NOTE]
====
This warning does not block the migration.
====

During migration, the deprecated GVKs are saved in the Velero Backup Custom Resource (CR) #1 for Kubernetes objects. You can download the Backup CR, extract the deprecated GVK `yaml` files, and update them with the `oc convert` command. Then you create the updated GVKs on the target cluster.

.Procedure

. Run the migration plan.

. View the MigPlan CR:
+
----
$ oc describe migplan <migplan_name> -n openshift-migration <1>
----
<1> Specify the name of the migration plan.
+
The output is similar to the following:
+
----
metadata:
  [...]
  uid: 79509e05-61d6-11e9-bc55-02ce4781844a <1>
status:
  [...]
  conditions:
  - category: Warn
    lastTransitionTime: 2020-04-30T17:16:23Z
    message: 'Some namespaces contain GVKs incompatible with destination cluster.
      See: `incompatibleNamespaces` for details'
    status: "True"
    type: GVKsIncompatible
  incompatibleNamespaces:
  - gvks:
    - group: batch
      kind: cronjobs <2>
      version: v2alpha1
    - group: batch
      kind: scheduledjobs <2>
      version: v2alpha1
----
<1> Record the MigPlan UID.
<2> Record the deprecated GVKs.

. Get the MigMigration name associated with the MigPlan UID:
+
----
$ oc get migmigration -o json | jq -r '.items[] | select(.metadata.ownerReferences[].uid=="<migplan_uid>") | .metadata.name' <1>
----
<1> Specify the MigPlan UID.

. Get the MigMigration UID associated with the MigMigration name:
+
----
$ oc get migmigration <migmigration_name> -o jsonpath='{.metadata.uid}' <1>
----
<1> Specify the MigMigration name.

. Get the Velero Backup name associated with the MigMigration UID:
+
----
$ oc get backup.velero.io --selector migration-initial-backup="<migmigration_uid>" -o jsonpath={.items[*].metadata.name} <1>
----
<1> Specify the MigMigration UID.

. Download the contents of the Velero Backup to your local machine:

* For AWS S3:
+
----
$ aws s3 cp s3://<bucket_name>/velero/backups/<backup_name> <backup_local_dir> --recursive <1>
----
<1> Specify the bucket, backup name, and your local backup directory name.

* For GCP:
+
----
$ gsutil cp gs://<bucket_name>/velero/backups/<backup_name> <backup_local_dir> --recursive <1>
----
<1> Specify the bucket, backup name, and your local backup directory name.

* For Azure:
+
----
$ azcopy copy 'https://velerobackups.blob.core.windows.net/velero/backups/<backup_name>' '<backup_local_dir>' --recursive <1>
----
<1> Specify the backup name and your local backup directory name.

. Extract the Velero Backup archive file:
+
----
$ tar -xfv <backup_local_dir>/<backup_name>.tar.gz -C <backup_local_dir>
----

. Run `oc convert` in offline mode on each deprecated GVK:
+
----
$ oc convert <backup_local_dir>/resources/<gvk>.yaml <1>
----
<1> Specify the deprecated GVK.

. Create the converted GVK on the target cluster:
+
----
$ oc create -f <gvk>.yaml <1>
----
<1> Specify the converted GVK.
