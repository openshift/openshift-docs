// Module included in the following assemblies:
//
// * service-mesh-docs-main/migrating/checklists/ossm-migrating-cluster-wide.adoc

ifeval::["{context}" == "cw-revision"]
:ossm-cluster-wide-istio-revision:
endif::[]
ifeval::["{context}" == "cw-revision-cm"]
:ossm-cert-manager-istio-revision:
endif::[]

:_mod-docs-content-type: PROCEDURE
[id="ossm-migrating-workloads-using-the-istio-revision-label_{context}"]
ifdef::ossm-cluster-wide-istio-revision[= Migrating workloads by using the Istio revision label]
ifdef::ossm-cert-manager-istio-revision[= Migrating workloads by using the Istio revision label with cert-manager]

Now you can migrate your workloads from the {SMProduct} 2.6 control plane to the {SMproduct} 3.0 control plane.

Revision tags are not used in this example for simplicity. When migrating large meshes, you can use revision tags to avoid re-labeling all namespaces during future version 3 updates.

[NOTE]
====
You can migrate workloads and gateways separately, and in any order. For more information, see "Migrating gateways".
====

.Procedure

. Find the current `IstioRevision` for your {SMProduct} 3.0 control plane by running the following command:
+
[source,terminal]
----
$ oc get istios
----
+
.Example output
+
[source,terminal]
----
NAME             REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
ossm-3           1           1       0        ossm-3-v1-24-3    Healthy   v1.24.3   30s
----

. Copy the value in the `ACTIVE REVISION` column to use as your `istio.io/rev` label in the next step.
+
[NOTE]
====
The naming format of your revisions depends on which upgrade strategy you choose for your `Istio` instance.
====

. Update the injection labels on the `dataplane` namespace by running the following command:
+
[source,terminal]
----
$ oc label ns bookinfo istio.io/rev=ossm-3-v1-24-3 maistra.io/ignore-namespace="true" istio-injection- --overwrite=true
----
+
Running the command performs the following actions:

.. Removes the `istio-injection` label: This label prevents the 3.0 control plane from injecting the proxy. The `istio-injection` label takes precedence over `istio.io/rev` label.

.. Adds the `istio.io/rev=ossm-3-v1-24-3` label: This label ensures that any newly created or restarted pods in the namespace connect to the {SMProduct} 3.0 proxy.

.. Adds the `maistra.io/ignore-namespace: "true"` label: This label disables sidecar injection for {SMProduct} 2.6 proxies in the namespace. With the label applied, {SMProduct} 2.6 stops injecting proxies in this namespace, and any new proxies are injected by {SMProduct} 3.0. Without this label, the {SMProduct} 2.6 injection webhook tries to inject the pod and the injected sidecar proxy refuses to start since it will have both the {SMProduct} 2.6 and the {SMProduct} 3.0 Container Network Interface(CNI) annotations.
+
[NOTE]
====
Once you apply the `maistra.io/ignore-namespace` label, any new pod that gets created in the namespace connects to the {SMProduct} 3.0 proxy. Workloads can still communicate with each other regardless of which control plane they are connected to.
====

. Restart the workloads by using one of the following options:
+
.. To restart all the workloads at once so that the new pods are injected with the {SMProduct} 3.0 proxy, run the following command:
+
.Example command for `bookinfo` application
[source,terminal]
----
$ oc rollout restart deployments -n bookinfo
----

.. To restart each workload individually, run the following command for each workload:
+
.Example command with `bookinfo` application
[source,terminal]
----
$ oc rollout restart deployments productpage-v1 -n bookinfo
----

. Wait for the `productpage` application to restart by running the following command:
+
[source,terminal]
----
$ oc rollout status deployment productpage-v1 -n bookinfo
----

.Verification

. Ensure that expected workloads are managed by the new control plane by running the following command:
+
[source,terminal]
----
$ istioctl ps -n bookinfo
----
+
.Example output
[source,terminal]
----
$ istioctl ps -n bookinfo
NAME                                          CLUSTER        CDS             LDS             EDS             RDS             ECDS         ISTIOD                                           VERSION
details-v1-7f46897b-d497c.bookinfo            Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
productpage-v1-74bfbd4d65-vsxqm.bookinfo      Kubernetes     SYNCED (4s)     SYNCED (4s)     SYNCED (3s)     SYNCED (4s)     IGNORED      istiod-ossm-3-v1-24-3-797bb4d78f-xpchx           1.24.3
ratings-v1-559b64556-c5ppg.bookinfo           Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
reviews-v1-847fb7c54d-qxt5d.bookinfo          Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
reviews-v2-5c7ff5b77b-8jbhd.bookinfo          Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
reviews-v3-5c5d764c9b-rrx8w.bookinfo          Kubernetes     SYNCED          SYNCED          SYNCED          SYNCED          NOT SENT     istiod-install-istio-system-866b57d668-6lpcr     1.20.8
----
+
The previous output shows that the `productpage-v1` deployment is the only deployment that restarted and was injected with the 3.0 proxy. Even if there are different versions of the proxies, communication between services still works.

. If the 2.6 installation contains additional data plane namespaces, migrate the next namespace now.
+
[NOTE]
====
Do not remove the `maistra.io/ignore-namespace="true"` label until the 2.6 control plane is uninstalled.
====

ifeval::["{context}" == "cw-revision"] 
:!ossm-cluster-wide-istio-revision:
endif::[]
ifeval::["{context}" == "cw-revision-cm"]
:!ossm-cert-manager-istio-revision:
endif::[]