// This module is included in the following assemblies:
// * pac/creating-pipeline-runs-pac.adoc

:_mod-docs-content-type: PROCEDURE
[id="creating-pipeline-run-pac_{context}"]
= Creating a pipeline run in {pac}

Complete the following general steps to create a pipeline run definition for {pac} in your repository. Refer to subsequent sections for detailed reference information.

.Prerequisites

* You configured {pac} to integrate with your Git repository  hosting service provider.

* You created a `Repository` custom resource (CR) to define the connection to your repository in {pac}.

.Procedure

. If a `.tekton` directory does not exist in the root of your repository, create this directory.

. Create a file with a `.yaml` or `.yml` extension in the `.tekton` directory. In this file, create a YAML specification for a `PipelineRun` CR. This specification can use all features of {pipelines-shortname}.

. Optional: Use parameters in your pipeline run specification. The {pac} resolver replaces these parameters with values that represent the current context. For example, `{{ repo_url }}` is the current URL for the repository and `{{ revision }}` is the branch on which the pipeline run was started. See the "Parameters in a pipeline run specification" section for a full list of the parameters.
+
.Example of using parameters
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: build-plr
spec:
  pipelineSpec:
    tasks:
      - name: fetch-repo
        taskRef:
          - name: git-clone
        params:
        - name: url
          value: {{ repo_url }}
        - name: revision
          value: {{ revision }}
        workspaces:
        - name: output
          workspace: shared-workspace
# ...
----


. Optional: Create other files with a `.yaml` or `.yml` extension in the `.tekton` directory and provide definitions of resources that your pipeline run definition references, such as `Pipeline`, `Task`, or `StepAction` CRs. The {pac} resolver automatically includes these resources when creating a `PipelineRun` CR based on your definition.

. Optional: Add one or more {pac} resolver annotations to the pipeline run definition file. A {pac} resolver annotation references a pipeline or task in {tekton-hub}, an HTTP location, or a location in your repository outside the `.tekton` directory. If you create a {pac} resolver annotation to reference a resource, you can use this resource by name in your pipeline run definition. The {pac} resolver automatically includes the referenced resources when creating a `PipelineRun` CR based on your definition.
+
See the "{pac} resolver annotations" section for detailed information about these annotations.
+
.Example of using a {pac} resolver annotation to reference a task in {tekton-hub}
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: build-plr
annotations:
  pipelinesascode.tekton.dev/task: "[git-clone]"
spec:
  pipelineSpec:
    workspaces:
    - name: shared-workspace
      emptyDir: {}
    tasks:
      - name: fetch-repo
        taskRef:
          - name: git-clone
        params:
        - name: url
          value: {{ repo_url }}
        - name: revision
          value: {{ revision }}
        workspaces:
        - name: output
          workspace: shared-workspace
# ...
----

. Define the event that triggers this pipeline run by adding one of the following sets of annotations. See the "Annotations for matching events to a pipeline run" section for detailed information about these annotations.

** A combination of the `pipelinesascode.tekton.dev/on-event` annotation, which defines a `pull request` or `push` event, and a `pipelinesascode.tekton.dev/on-target-branch` annotation, which defines the branch that the pull request or push event must target. If you match your pipeline run to a pull request or push event, the pipeline run also starts each time the source branch of the pull request or push event is updated.
+
[NOTE]
====
If your Git repository provider uses merge requests and not pull request, a `pull_request` event definition matches a merge request.
====
+
.Example of matching a pipeline run to a pull request event
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-pr-main
annotations:
  pipelinesascode.tekton.dev/on-target-branch: "[main]"
  pipelinesascode.tekton.dev/on-event: "[pull_request]"
# ...
----

** A `pipelinesascode.tekton.dev/on-comment` annotation, which matches the pipeline run to a comment on a pull request by regular expression. If you match your pipeline run to a comment, it starts when the comment is added to a pull request. To start the pipeline run again. add the comment again.
+
.Example of matching a pipeline run to a comment
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-comment
annotations:
  pipelinesascode.tekton.dev/on-comment: "^/merge-pr"
# ...
----

. Optional: Add one or more annotations that filter the matching events. With these annotations, when the defined matching event (such as a pull request, a push event. or a comment) happens, {pac} checks if these annotations are also matched. The pipeline run starts only if all the annotations that you added to it are matched. See the "Annotations for filtering events" section for detailed information about these annotations.

** A `pipelinesascode.tekton.dev/on-path-changed` annotation is matched if the pull request or push event affect files in the specified paths.

** A `pipelinesascode.tekton.dev/on-path-changed-ignore` annotation excludes matching the event if it affects _only_ files in the specified paths.

** A `pipelinesascode.tekton.dev/on-label` annotation is matched if the pull request or push event has one of the specified labels.

** A `pipelinesascode.tekton.dev/on-cel-expression` annotation is matched if the pull request or push event matches a Common Expression Language (CEL) expression.
+
.Example of using annotations to filter matching events in a pipeline run
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-pr-filtered
annotations:
  pipelinesascode.tekton.dev/on-target-branch: "[main]"
  pipelinesascode.tekton.dev/on-event: "[pull_request]"
  pipelinesascode.tekton.dev/on-label: "[bug, defect]"
  pipelinesascode.tekton.dev/on-path-changed: "["src/*", "cli/**"]"
# ...
----

. Optional: Add the `pipelinesascode.tekton.dev/cancel-in-progress: "true"` annotation to enable automatic cancellation of the pipeline run in certain cases. For example, if a pull request triggers a pipeline run and then the user pushes new commits into the pull request source branch, each push triggers a new copy of the pipeline run. if you enable automatic cancellation-in-progress, after a new copy of the pipeline run starts, {pac} cancels the older run ti avoid running many copies of the pipeline run at the same time. See the "Annotations for specifying automatic cancellation-in-progress for a pipeline run" for detailed information about this annotation.

.Example of using the annotation to enable cancellation-in-progress
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: sample-pipeline
annotations:
  pipelinesascode.tekton.dev/cancel-in-progress: "true"
# ...
