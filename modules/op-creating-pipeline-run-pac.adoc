// This module is included in the following assemblies:
// * pac/creating-pipeline-runs-pac.adoc

:_mod-docs-content-type: PROCEDURE
[id="creating-pipeline-run-pac_{context}"]
= Creating a pipeline run in {pac}

You can create a pipeline run definition for {pac} in your repository and match it to an event, such as a pull request. When the event happens, {pac} creates a `PipelineRun` custom resource (CR) from this definition, and then {pipelines-shortname} executes the pipeline run.

.Prerequisites

* You configured {pac} to integrate with your Git repository hosting service provider.

* You created a `Repository` custom resource (CR) to define the connection to your repository in {pac}.

* You have a `.tekton` directory in the root of your repository.

.Procedure

. Create a file with a `.yaml` or `.yml` extension in the `.tekton` directory.

. In the file that you created, create a YAML specification for a `PipelineRun` CR. This specification can use all features of {pipelines-shortname}.

. Depending on the requirements of your pipeline run definition, complete any of the following optional steps:

** Create other files with a `.yaml` or `.yml` extension in the `.tekton` directory. In these files, provide definitions of resources that your pipeline run definition references, such as `Pipeline`, `Task`, or `StepAction` CRs. The {pac} resolver automatically resolves these resources and includes them in the  `PipelineRun` CR that is based on your definition.

** Use _dynamic variables_ in your pipeline run specification. {pac} replaces these variables with values that represent the current context. For example, `{{ repo_url }}` is the current URL for the repository and `{{ revision }}` is the commit SHA on which the pipeline run was started.
+
For more information about dynamic variables, see the "Dynamic variables in a pipeline run specification" section.

** Add one or more {pac} resolver annotations to your pipeline run definition. A {pac} resolver annotation references a pipeline or task in {tekton-hub}, an HTTP location, or a location in your repository outside the `.tekton` directory. If you create a {pac} resolver annotation to reference a resource, you can use this resource by name in your pipeline run definition. The {pac} resolver automatically resolves these resources and includes them in the  `PipelineRun` CR that is based on your definition.
+
For more information about these annotations, see the "{pac} resolver annotations" section.

. Match the pipeline run to events by adding any of the following annotations to the pipeline run definition. When the defined event happens, {pac} starts the pipeline run. For more information about matching the pipeline run to events, see the "Annotations for matching events to a pipeline run" section.

** A combination of the `pipelinesascode.tekton.dev/on-event` annotation, which defines a `pull request` or `push` event, and a `pipelinesascode.tekton.dev/on-target-branch` annotation, which defines the branch that the pull request or push event must target. If you match your pipeline run to a pull request or push event, the pipeline run starts when the event is created. For pull requests, it starts again each time the source branch event is updated.
+
[NOTE]
====
If your Git repository provider uses merge requests and not pull requests, a `pull_request` event definition matches a merge request.
====

** A `pipelinesascode.tekton.dev/on-comment` annotation, which matches the pipeline run to a comment on a pull request by regular expression. If you match your pipeline run to a comment, it starts when the comment is added to a pull request. To start the pipeline run again, add the comment again.

** A `pipelinesascode.tekton.dev/on-cel-expression` annotation, which matches the pipeline run if the specified Common Expression Language (CEL) expression evaluates to `true` on a pull request or push event.

. Optional: Add one or more annotations that filter the matching events. With these annotations, when the defined matching event (such as a pull request, a push event, or a comment) happens, {pac} checks if these annotations are also matched. The pipeline run starts only if all the annotations that you added to it are matched. For more information about filtering matching events, see the "Annotations for filtering events" section.

** A `pipelinesascode.tekton.dev/on-path-changed` annotation is matched if the pull request or push event affect files in the specified paths.

** A `pipelinesascode.tekton.dev/on-path-changed-ignore` annotation excludes matching the event if the event changes _only_ files in the specified paths and does not change any other files in the repository.

** A `pipelinesascode.tekton.dev/on-label` annotation is matched if the pull request or push event has one of the specified labels.

. Optional: Add the `pipelinesascode.tekton.dev/cancel-in-progress: "true"` annotation to enable automatic cancellation of the pipeline run in certain cases. For example, if a pull request triggers a pipeline run and then the user pushes new commits into the pull request source branch, each push triggers a new copy of the pipeline run. if you enable automatic cancellation-in-progress, after a new copy of the pipeline run starts, {pac} cancels the older run to avoid running many copies of the pipeline run at the same time. For more information about this annotation, see the "Annotations for specifying automatic cancellation-in-progress for a pipeline run" section.

.Example {pac} pipeline run definition
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: maven-build
annotations:
  pipelinesascode.tekton.dev/task: "[git-clone]" # <1>
  pipelinesascode.tekton.dev/on-event: "[pull_request]" # <2>
  pipelinesascode.tekton.dev/on-target-branch: "[main, release]" # <3>
  pipelinesascode.tekton.dev/on-path-changed: "[src/**]" # <4>
  pipelinesascode.tekton.dev/cancel-in-progress: "true" # <5>
spec:
  pipelineSpec:
    workspaces:
    - name: shared-workspace
    tasks:
      - name: fetch-repo
        taskRef:
          - name: git-clone # <6>
        params:
        - name: url
          value: {{ repo_url }} # <7>
        - name: revision
          value: {{ revision }} # <8>
        workspaces:
        - name: output
          workspace: shared-workspace
      - name: build-from-source
        taskRef:
          resolver: cluster
          params:
          - name: kind
            value: task
          - name: name
            value: maven
          - name: namespace
            value: openshift-pipelines
        workspaces:
        - name: source
          workspace: shared-workspace
----
<1> The `pipelinesascode.tekton.dev/task` annotation references the `git-clone` task from {tekton-hub}.
<2> The `pipelinesascode.tekton.dev/on-event` annotation matches the pipeline run to a pull request or merge request event.
<3> The `pipelinesascode.tekton.dev/on-target-branch` annotation specifies that a pull request into either the `main` branch or `release` branch triggers this pipeline run.
<4> The `pipelinesascode.tekton.dev/on-path-changed` annotation specifies that the pipeline run triggers only if the pull request contains changes to files under the `src` directory.
<5> The `pipelinesascode.tekton.dev/cancel-in-progress` annotation specifies that, if the pipeline run is started again for the same pull request, {pac} cancels the previous run.
<6> The pipeline run specification references the `git-clone` task by name. Because of the `pipelinesascode.tekton.dev/task` annotation, the {pac} resolver resolves this reference to the `git-clone` task from {tekton-hub}.
<7> {pac} replaces the `{{ repo_url }}` dynamic variable with the URL for the Git repository.
<8> {pac} replaces the `{{ revision }}` dynamic variable with the revision of the branch for which the pipeline run was started.
