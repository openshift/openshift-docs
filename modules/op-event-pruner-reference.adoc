// This module is included in the following assemblies:
// * install_config/customizing-configurations-in-the-tektonconfig-cr.adoc

:_mod-docs-content-type: REFERENCE
[id="event-pruner-reference_{context}"]
= Configuration of the event-driven pruner

You can configure the pruning behavior of the event-driven pruner by modifying your `TektonConfig` custom resource (CR) for global and namespace-level policies, and config maps for resource-level pruning rules.

You can use the following parameters in your `tektonpruner` configuration:

[cols="1,3",options="header"]
|===
|Parameter |Description

|`ttlSecondsAfterFinished`
|Delete resources a fixed number of seconds after they complete.

|`successfulHistoryLimit`
|Retain the specified number of the most recent successful runs. Delete older successful runs.

|`failedHistoryLimit`
|Retain the specified number of the most recent failed runs. Delete older failed runs.

|`historyLimit`
|Apply a generic history limit when `failedHistoryLimit` and `successfulHistoryLimit` are not defined.

|`enforcedConfigLevel`
|Specify the level at which pruner applies the configuration. Accepted values: `global` or `namespace`.

|`namespaces`
|Define per-namespace pruning policies.
|===

[NOTE]
====
You can use TTL-based pruning to prune resources exceeding set expiration times.
Use history-based pruning to prune resources exceeding the configured `historyLimit`.
TTL and history limits operate independently.
====

Global configuration of the event-driven pruner::

The following example shows the default `TektonConfig` CR configuration, which applies global pruning rules:
+
[source,yaml]
----
apiVersion: operator.tekton.dev/v1alpha1
kind: TektonConfig
metadata:
 name: config
spec:
  # ...
  tektonpruner:
    disabled: false
    global-config:
      enforcedConfigLevel: global
      failedHistoryLimit: 5
      historyLimit: 10
      successfulHistoryLimit: 5
      ttlSecondsAfterFinished: 3600
    options: {}
  # ...
----
* `failedHistoryLimit`: The amount of retained failed runs.
* `historyLimit`: The amount of runs to retain. Pruner uses this setting if status-specific limits are not defined.
* `successfulHistoryLimit`: The amount of retained successful runs.
* `ttlSecondsAfterFinished`: Time in seconds after completion, after which the pruner deletes resources.

Namespace-level configuration of the event-driven pruner::

You can define pruning rules for individual namespaces by setting `enforcedConfigLevel` to `namespace` and configuring policies under the `namespaces` section. In the following example, a 60 second time to live (TTL) is applied to resources in the `dev-project` and `staging` namespaces:
+
[source,yaml]
----
apiVersion: operator.tekton.dev/v1alpha1
kind: TektonConfig
metadata:
 name: config
spec:
  # ...
  tektonpruner:
    disabled: false
    global-config:
      enforcedConfigLevel: namespace
      ttlSecondsAfterFinished: 300
      namespaces:
        dev-project:
          ttlSecondsAfterFinished: 60
        staging:
          ttlSecondsAfterFinished: 60
  # ...
----

Resource-level configuration of the event-driven pruner::

If you have configured the namespace-level configuration of the event-driven pruner, you can further configure resource-level pruning rules by creating a `tekton-pruner-namespace-spec` config map in your namespace. Resource-level rules take precedence over global and namespace-level pruning configuration when defined for a specific resource type.
+
When multiple config maps apply to the same resource, the event-driven pruner applies the most specific rule.
+
The following example defines a TTL and a history limit for both `PipelineRun` and `TaskRun` resources:
+
[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: tekton-pruner-namespace-spec
  namespace: user-specified-namespace
  labels:
    app.kubernetes.io/part-of: tekton-pruner
    pruner.tekton.dev/config-type: namespace
data:
  ns-config: |
    ttlSecondsAfterFinished: 300
    historyLimit: 5
----
+
The `tekton-pruner-namespace-spec` name and the `app.kubernetes.io/part-of: tekton-pruner` and `pruner.tekton.dev/config-type: namespace` labels are required on all resource-level pruning config maps for the pruner controller to process them correctly. Config maps missing these labels or using an incorrect name are ignored.

Resource-level configuration of the event-driven pruner with selectors::

In the following example, the pruning rule applies only if the resource has both the `priority: high` label and the `compliance: required` annotation. Resources that do not match this selector fall back to the namespace default or other selectors with lower specificity:
+
[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: tekton-pruner-namespace-spec
  namespace: user-specified-namespace
  labels:
    app.kubernetes.io/part-of: tekton-pruner
    pruner.tekton.dev/config-type: namespace
data:
  ns-config: |
    ttlSecondsAfterFinished: 3600

    pipelineRuns:
      - selector:
        - matchLabels:
            priority: high
          matchAnnotations:
            compliance: required
        ttlSecondsAfterFinished: 7776000
        successfulHistoryLimit: 100
        failedHistoryLimit: 100
----

Common values::

The following tables provide recommended values for TTL and history limits for `PipelineRuns` and `TaskRuns`. Use these values to help configure pruning policies that balance cluster performance, resource retention, and operational requirements.
+
[cols="1,1,2", options="header"]
|===
| Time period | Seconds | Use case

| 5 minutes | 300 | Development and testing with rapid iteration
| 30 minutes | 1800 | Short-lived experiments
| 1 hour | 3600 | CI pipelines
| 6 hours | 21600 | Daily builds
| 1 day | 86400 | Staging environments
| 7 days | 604800 | Production, short retention
| 30 days | 2592000 | Compliance, auditing
| 90 days | 7776000 | Regulated industries
|===
+
[cols="1,1,1,2", options="header"]
|===
| Environment | `successfulHistoryLimit` | `failedHistoryLimit` | Reason

| Development | 3-5 | 5-10 | Increase feedback turnaround and reduce storage requirements
| Staging | 5-10 | 10-20 | Balance retention and resources
| Production | 10-50 | 20-100 | Audit trial and debugging
| CI/CD | 3-5 | 10-20 | Provide recent context for failure analysis
|===
