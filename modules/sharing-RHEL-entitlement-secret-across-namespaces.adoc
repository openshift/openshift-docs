// Module included in the following assemblies:
//
// * work_with_shared_resources/using-shared-resource-csi-driver.adoc

:_mod-docs-content-type: PROCEDURE
[id="sharing-RHEL-entitlement-across-namespace_{context}"]
= Sharing RHEL entitlement across namespaces

[role="_abstract"]
You can use a `SharedSecret` object to securely share and synchronize the RHEL entitlement keys of a cluster in {builds-shortname} across namespaces.

.Prerequisites

* You must have permissions to perform the following actions:
** Create `SharedSecret` object.
** Create build configs and start builds.
** Run the `oc get sharedsecrets` command to discover which `SharedSecret` custom resource (CR) instances are available. 
** Run the `oc adm policy who-can use <sharedsecret_identifier>` command to check if a service account is allowed to use the `SharedSecret` CR and the service account is listed in your namespace.

[NOTE]
====
If you are unable to complete the last two prerequisites, the cluster administrator can establish the necessary RBAC permission so that you can grant service accounts to use the `SharedSecret` CR.
====

.Procedure

. Create a `SharedSecret` object instance with the entitlement secret of a cluster by running the following command:
+
[source,terminal]
----
$ oc apply -f -<<EOF
apiVersion: sharedresource.openshift.io/v1alpha1
kind: SharedSecret
metadata:
  name: etc-pki-entitlement
spec:
  secretRef:
    name: etc-pki-entitlement
    namespace: openshift-config-managed
EOF
----

. Create a `ClusterRole` object to grant permission to access the `SharedSecret` object by using the following example configuration:
+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: use-share-etc-pki-entitlement # <1>
rules:
  - apiGroups:
      - sharedresource.openshift.io
    resources:
      - sharedsecrets
    resourceNames:
      - etc-pki-entitlement
    verbs:
      - use
----
<1> Name of the `ClusterRole` CR.

. Create the `Role` and `RoleBinding` object that grants the Shared Resource CSI driver the permission to access the `SharedSecret` object:
+
.Example `Role` object
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: share-etc-pki-entitlement # <1>
  namespace: openshift-config-managed
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
    resourceNames:
      - etc-pki-entitlement
    verbs:
      - get
      - list
      - watch
----
<1> Name of the `Role` CR.

.Example `RoleBinding` object
+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: share-etc-pki-entitlement # <1>
  namespace: openshift-config-managed
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: share-etc-pki-entitlement
subjects:
  - kind: ServiceAccount
    name: csi-driver-shared-resource
    namespace: openshift-builds # <2>
----
+
<1> Name of the `RoleBinding` CR.
<2> Name of the namespace where `openshift-builds` is installed.

. Create a `RoleBinding` object for the `builder` and `pipeline` service accounts in the namespace where builds run:
+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: use-share-etc-pki-entitlement # <1>
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: use-share-etc-pki-entitlement
subjects:
  - kind: ServiceAccount
    name: pipeline
  - kind: ServiceAccount
    name: builder
----
+
<1> Name of the `RoleBinding` CR for the `builder` and `pipeline` service accounts.
+
[NOTE]
====
The service account that consumes the `SharedSecret` object is created and managed by the OpenShift controllers.
====

. Mount the `SharedSecret` object by using the `buildah` build strategy. See the following example:
+
[source,terminal]
----
$ oc apply -f -<<EOF
apiVersion: shipwright.io/v1beta1
kind: Build
metadata:
  name: buildah-rhel
spec:
  source:
    type: Git
      git:
      url: https://github.com/redhat-openshift-builds/samples
    contextDir: buildah-build
  strategy:
    name: buildah
    kind: ClusterBuildStrategy
  paramValues:
  - name: dockerfile
    value: DockerFile
  volumes:
  - csi:
      driver: csi.sharedresource.openshift.io
      readOnly: true # <1>
      volumeAttributes:
        sharedSecret: <sharedsecret_object_name> # <2>
    name: etc-pki-entitlement 
  output:
    image: <output_image_location> # <3>
EOF
----
<1> You must set `readOnly` to `true` to mount the shared resource in the build.
<2> Replace `<sharedsecret_object_name>` with the name of the `SharedSecret` object to include it in the build.
<3> Replace `<output_image_location>` with the location where you want to push the built image.