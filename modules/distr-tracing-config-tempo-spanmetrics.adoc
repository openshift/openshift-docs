////
This module included in the following assemblies:
- distr_tracing_install/distr-tracing-deploying-jaeger.adoc
////
:_content-type: REFERENCE
[id="distr-tracing-config-storage_{context}"]
= Configure span RED metrics

Trace data contains rich information and most importantly the data is normalized across instrumented languages and frameworks.
Therefore, additional metrics can be deriven from trace data. These metrics are request count, duration and error count (RED).
These metrics can be visualized in Jaeger console in the Monitor tab.

The metrics are derived from span data in the OpenTelemetry collector, scraped from the collector via Prometheus deployed in user-workload monitoring stack.
Jaeger UI then queries the Prometheus endpoint and visualizes the metrics in the monitor tab.

== OpenTelemetry collector configuration

The OpenTelemetry collector needs to configure spanmetrics connector which derives metrics from traces and exports the metrics in the Prometheus format.

.OpenTelemetry collector CR for span RED
[source,yaml]
----
kind: OpenTelemetryCollector
metadata:
  name: otel
spec:
  mode: deployment
  ports:
    - name: promexporter
      port: 8889
      protocol: TCP
  config: |
    connectors:
      spanmetrics: <1>
        histogram:
          explicit:
            buckets: [100us, 1ms, 2ms, 6ms, 10ms, 100ms, 250ms]
        dimensions:
        - name: http.method
          default: GET
        - name: http.status_code
        dimensions_cache_size: 1000
        aggregation_temporality: "AGGREGATION_TEMPORALITY_CUMULATIVE"
        metrics_flush_interval: 15s

    receivers:
      otlp: <2>
        protocols:
          grpc:
          http:

    exporters:
      prometheus: <3>
        endpoint: 0.0.0.0:8889
        resource_to_telemetry_conversion:
          enabled: true # by default resource attributes are dropped

    service:
      pipelines:
        traces:
          receivers: [otlp]
          exporters: [otlp, spanmetrics] <4>
        metrics:
          receivers: [spanmetrics] <5>
          exporters: [prometheus]
----
<1> Spanmetrics connector receives traces and exports spans.
<2> OTLP receiver to receive spans in OpenTelemetry protocol.
<3> Prometheus exporter is used to export metrics in the Prometheus format.
<4> Spanmetrics connector is configured as exporter in traces pipeline.
<5> Spanmetrics connector is configured as receiver in metrics pipeline.

The setup as well requires to configure the user-workload monitoring stack to scrape the Prometheus endpoint of the collector - https://github.com/openshift/openshift-docs/pull/60953/files#diff-bd0dc510dd646c60e63a7daf0b9d22eb7525adc8467753a6bdb37948345992ddR7

== Tempo configuration

The `TempoStack` CR needs to enable the monitor tab and set the Prometheus endpoint to Thanos querier service to query the data from the user-defined monitoring stack.

.TempoStack CR with enabled monitor tab
[source,yaml]
----
apiVersion: tempo.grafana.com/v1alpha1
kind:  TempoStack
metadata:
  name: simplest
spec:
  template:
    gateway:
      enabled: false <1>
    queryFrontend:
      jaegerQuery:
        enabled: true
        monitorTab:
          enabled: true <2>
          prometheusEndpoint: https://thanos-querier.openshift-monitoring.svc.cluster.local:9091 <3>
        ingress:
          type: route
----
<1> Gateway is enabled because the monitor tab is not supported thorough the gateway deployment.
<2> Enables monitoring tab in Jaeger console.
<3> The Thanos querier service name from user-workload monitoring.

To allow users accessing the span RED metrics stored in Thanos create the following `ClusterRoleBinding`
which enables metrics query for all authenticated users:

.ClusterRoleBinding to allow users accessing span RED metrics
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jaeger-cluster-monitoring-view
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-monitoring-view
subjects:
  - kind: Group
    apiGroup: rbac.authorization.k8s.io
    name: system:authenticated
----

