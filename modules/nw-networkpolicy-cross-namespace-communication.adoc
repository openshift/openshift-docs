// Module included in the following assemblies:
//
// * networking/network_security/network_policy/nw-networkpolicy-full-multitenant-isolation.adoc

:_mod-docs-content-type: REFERENCE
[id="nw-networkpolicy-cross-namespace-communication_{context}"]
= Creating a network policy for cross-namespace communication

To allow pod-to-pod communication across namespaces, you must create a label for the primary namespace and add a `namespaceSelector` query and a `podSelector` query. 

.Prerequisites

* You have created the `deny-by-default` network policy and applied it to all necessary namespaces.

.Procedure

. Create the following `allow-n1-a-to-n2-b` network policy to allow pods across namespaces to communicate with each other. With this YAML, pods in the `project-a` that are labeled with `send-data` can communicate with pods in the `project-b` namespace that are labeled with `receive-data`. The namespaces must also be labeled to allow for communication. Save the YAML in the `allow-n1-a-to-n2-b` file:
+
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-n1-a-to-n2-b
spec:
  podSelector:
    matchLabels:
      app: receive-data <1>
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          networking/namespace: n1 <2>
      podSelector:
        matchLabels:
          app: send-data  <3>
----
<1> Apply the `app: receive-data` label to pods in the `project-b` namespace.
<2> Apply the `n1` label to the `project-a` namespace.
<3> Apply the `app: send-data` label to pods in the `project-a` namespace.

. Apply the `allow-n1-a-to-n2-b` network policy to the `project-b` namespace by running the following command:
+
[source,terminal]
----
$ oc apply -f allow-n1-a-to-n2-b.yaml -n project-b
----

. Label the `project-a` namespace with the `networking/namespace=n1` label by entering the following command:
+
[source,terminal]
----
$ oc label namespace project-a networking/namespace=n1
----

. Label the `project-b` namespace with the `networking/namespace=n2` label by entering the following command:
+
[source,terminal]
----
$ oc label namespace project-b networking/namespace=n2
----

. If it is not already labeled, label the `busybox-pod` in `project-a` with the `send-data` label by entering the following command:
+
[source,terminal]
----
$ oc label pod busybox-pod-a app=send-data -n project-a --overwrite
----

. If it is not already labeled, label the `test-pod` in `project-b` with the `receive-data` label by entering the following command:
+
[source,terminal]
----
$ oc label pod test-pod-b app=receive-data -n project-b --overwrite
----

.Verification

. Obtain the IP addresses of pods in `project-b` by running the following command:
+
[source,terminal]
----
$ oc get pod -n project-b -o wide
----
+
.Example output
+
[source,terminal]
----
NAME            READY   STATUS    RESTARTS   AGE   IP            NODE                           NOMINATED NODE   READINESS GATES
busybox-pod-b   1/1     Running   0          51m   10.132.0.39   ip-10-0-132-187.ec2.internal   <none>           <none>
test-pod-b      1/1     Running   0          51m   10.132.0.41   ip-10-0-132-187.ec2.internal   <none>           <none>
----

. Ensure that the `busybox-pod-a` pod in the  `project-a` namespace can send data to the `test-pod-b` pod in the `project-b` namespace by entering the following command:
+
[source,terminal]
----
$ oc exec -it busybox-pod-a -n project-a -- ping 10.132.0.41
----
+
.Example output
+
[source,terminal]
----
PING 10.132.0.41 (10.132.0.41): 56 data bytes
64 bytes from 10.132.0.41: seq=0 ttl=42 time=1.201 ms
64 bytes from 10.132.0.41: seq=1 ttl=42 time=0.640 ms
----

. Ensure that unlabeled pods cannot send and receive data by entering the following command. In this example, because the `test-pod-a` pod is not labeled with `send-data`, it cannot send data to the `test-pod-b` pod, even though that pod has the `receive-data` label.
+
[source,terminal]
----
$ oc exec -it test-pod-a -n project-a -- ping 10.132.0.41
----
+
.Example output
+
[source,terminal]
----
PING 10.132.0.41 (10.132.0.41): 56 data bytes
--- 10.132.0.41 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss
----
