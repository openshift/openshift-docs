// This module is included in the following assemblies:
// * pac/creating-pipeline-runs-pac.adoc

:_mod-docs-content-type: REFERENCE
[id="matching-pipeline-run-using-pipelines-as-code_{context}"]
= Annotations for matching events to a pipeline run

You can match different Git provider events with each pipeline run by using annotations on the pipeline run. If there are multiple pipeline runs matching an event, {pac} runs them in parallel and posts the results to the Git provider as soon as a pipeline run finishes.

[id="pull-matching-pipeline-run-using-pipelines-as-code_{context}"]
== Matching a pull request event to a pipeline run

You can use the following example to match the `pipeline-pr-main` pipeline run with a `pull_request` event that targets the `main` branch:

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-pr-main
annotations:
  pipelinesascode.tekton.dev/on-target-branch: "[main]" <1>
  pipelinesascode.tekton.dev/on-event: "[pull_request]"
# ...
----
<1> You can specify multiple branches by adding comma-separated entries. For example, `"[main, release-nightly]"`. In addition, you can specify the following items:
* Full references to branches such as `"refs/heads/main"`
* Globs with pattern matching such as `"refs/heads/\*"`
* Tags such as `"refs/tags/1.\*"`

[id="push-matching-pipeline-run-using-pipelines-as-code_{context}"]
== Matching a push event to a pipeline run

You can use the following example to match the `pipeline-push-on-main` pipeline run with a `push` event targeting the `refs/heads/main` branch:

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-push-on-main
annotations:
  pipelinesascode.tekton.dev/on-target-branch: "[refs/heads/main]" <1>
  pipelinesascode.tekton.dev/on-event: "[push]"
# ...
----
<1> You can specify multiple branches by adding comma-separated entries. For example, `"[main, release-nightly]"`. In addition, you can specify the following items:
* Full references to branches such as `"refs/heads/main"`
* Globs with pattern matching such as `"refs/heads/\*"`
* Tags such as `"refs/tags/1.\*"`


[id="comment-matching-pipeline-run-using-pipelines-as-code_{context}"]
== Matching a comment event to a pipeline run

:FeatureName: Matching a comment event to a pipeline run
include::snippets/technology-preview.adoc[]

You can use the following example to match the `pipeline-comment` pipeline run with a comment on a pull request, when the text of the comment matches the `^/merge-pr` regular expression:

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-comment
annotations:
  pipelinesascode.tekton.dev/on-comment: "^/merge-pr"
# ...
----

The pipeline run starts only if the comment author meets one of the following requirements:

* The author is the owner of the repository.
* The author is a collaborator on the repository.
* The author is a public member on the organization of the repository.
* The comment author is listed in the `approvers` or `reviewers` section of the `OWNERS` file in the root of the repository, as defined in the https://www.kubernetes.dev/docs/guide/owners/[Kubernetes documentation]. {pac} supports the specification for the `OWNERS` and `OWNERS_ALIASES` files. If the `OWNERS` file includes a https://github.com/kubernetes/community/blob/master/contributors/guide/owners.md#filters[filters] section, {pac} matches approvers and reviewers only against the `.*` filter.

[id="advanced-matching-pipeline-run-using-pipelines-as-code_{context}"]
== Advanced event matching

{pac} supports using Common Expression Language (CEL) based filtering for advanced event matching. If you have the `pipelinesascode.tekton.dev/on-cel-expression` annotation in your pipeline run, {pac} uses the CEL expression and skips the `on-target-branch` annotation. Compared to the simple `on-target-branch` annotation matching, the CEL expressions allow complex filtering and negation.

[IMPORTANT]
====
If you use the `on-cel-expression` annotation in the same pipeline run as an `on-event`, `on-target-branch`, `on-label`, `on-path-change`, or `on-path-change-ignore` annotation, the `on-cel-expression` annotation takes priority and {pac} ignores the other annotations.
====

To use CEL-based filtering with {pac}, consider the following examples of annotations:

* To match a `pull_request` event targeting the `main` branch and coming from the `wip` branch:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request" && target_branch == "main" && source_branch == "wip"
...
----

* To run a pipeline only if a path has changed, you can use the `.pathChanged` suffix function with a glob pattern:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr-pathchanged
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request" && "docs/\*.md".pathChanged() # <1>
# ...
----
<1> Matches all markdown files in the `docs` directory.

* To match all pull requests starting with the title `[DOWNSTREAM]`:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr-downstream
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request && event_title.startsWith("[DOWNSTREAM]")
# ...
----

* To run a pipeline on a `pull_request` event, but skip the `experimental` branch:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr-not-experimental
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request" && target_branch != experimental"
# ...
----

For advanced CEL-based filtering while using {pac}, you can use the following fields and suffix functions:

* `event`: A `push` or `pull_request` event.
* `target_branch`: The target branch.
* `source_branch`: The branch of origin of a `pull_request` event. For `push` events, it is same as the `target_branch`.
* `event_title`: Matches the title of the event, such as the commit title for a `push` event, and the title of a pull or merge request for a `pull_request` event. Currently, only GitHub, Gitlab, and Bitbucket Cloud are the supported providers.
* `.pathChanged`: A suffix function to a string. The string can be a glob of a path to check if the path has changed. Currently, only GitHub and Gitlab are supported as providers.

In addition, you can access the full payload as passed by the Git repository provider. Use the `headers` field to access the headers of the payload, for example, `headers['x-github-event']`. Use the `body` field to access the body of the payload, for example, `body.pull_request.state`.

:FeatureName: Using the header and body of the payload for CEL-based filtering with {pac}
include::snippets/technology-preview.adoc[]

In the following example, the pipeline run starts only if all of the following conditions are true:

* The pull request is targeting the `main` branch.
* The author of the pull request is `superuser`.
* The action is `synchronize`; this action triggers when an update occurs on a pull request.

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  annotations:
    pipelinesascode.tekton.dev/on-cel-expression: |
      body.pull_request.base.ref == "main" &&
        body.pull_request.user.login == "superuser" &&
        body.action == "synchronize"
# ...
----

[NOTE]
====
If you use the `header` or `body` field for event matching, you might be unable to trigger the pipeline run using Git commands such as `retest`. If you use a Git command, the payload body is the comment that contains this command, and not the original payload.

If you want to trigger the pipeline run again when using the `body` field for event matching, you can close and reopen the pull request or merge request, or alternatively add a new SHA commit. You can add a new SHA commit by using the following command:

[source,terminal]
----
git commit --amend --no-edit && git push --force-with-lease
----
====
