// Module included in the following assembly:
//
// * argocd-agent-installation/gitops-deploy-argocd-application-in-autonomous-mode.adoc

:_mod-docs-content-type: PROCEDURE
[id="gitops-deploy-argocd-application-in-autonomous-mode_{context}"]
= Deploying an Argo CD application in autonomous mode

[role="_abstract"]
In autonomous agent mode, the *spoke* acts as the source of truth. The Argo CD applications must be created directly in the spoke cluster, and the agent reports the application state back to the Principal component in the hub.

.Prerequisites

* You have deployed and configured the Principal and Agent component.
* You have the `oc` CLI installed and are logged in with sufficient permissions.
* You know the context names for both the hub (control plane) and spoke (workload) clusters.

.Procedure

. Create the Argo CD application manifest file, `application.yaml`, with the following configuration:
+
[source,yaml]
----
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-demo-app
  namespace: openshift-gitops
spec:
  project: default
  source:
    repoURL: https://github.com/redhat-developer/openshift-gitops-getting-started
    targetRevision: HEAD
    path: app
  destination:
    server: https://kubernetes.default.svc
    namespace: my-app
  syncPolicy:
    automated: 
      prune: true
      selfHeal: true
    managedNamespaceMetadata:
      labels:
        argocd.argoproj.io/managed-by: openshift-gitops
    syncOptions:
    - CreateNamespace=true
----
+
where:

`namespace: openshift-gitops`:: Specifies the namespace where the Argo CD instance (Agent) is running on the spoke cluster. This controller manages the Application resource.
`source.repoURL`:: Specifies the Git repository that stores the application manifests.
`source.targetRevision`:: Specifies the Git revision Argo CD should track.
`source.path`:: Specifies the directory inside the repository containing the application manifests.
`destination.server`:: Specifies the Kubernetes API server where the application will be deployed.
`destination.namespace: my-app`:: Specifies the target namespace for the deployed application. If the namespace does not exist, it can be automatically created.
`syncPolicy.automated.prune`:: Enables automated pruning. Argo CD deletes resources that were previously applied but no longer appear in Git.
`syncPolicy.automated.selfHeal`::  Enables automatic self-healing. Argo CD corrects any drift between live resources and the Git source.
`managedNamespaceMetadata.labels`:: Labels that Argo CD applies to the destination namespace when it creates or manages it. The label in this example indicates the namespace is managed by the `openshift-gitops` instance.

. Apply the configuration in the spoke cluster by running the following command:
+
[source,terminal]
----
$ oc apply -f application.yaml -n openshift-gitops --context "<agent_context>"
----
+
where:

`agent_context`:: Specifies the context name for the agent cluster in an Agent-Principal setup.

.Verification

. To verify that the application is created in the hub cluster, run the following command:
+
[source,terminal]
----
$ oc get application.argoproj.io/my-demo-app -n agent-autonomous --context "<principal_context>"
----
+
where:

`principal_context`:: Specifies the context name for the principal cluster in an Agent-Principal setup.

. To verify that the application is synced and healthy from the spoke, run the following command:
+
[source,terminal]
----
$ oc get application.argoproj.io/my-demo-app -n openshift-gitops --context "<AGENT_CONTEXT>"
----

. If the configuration is correct, the agent creates all application resources in the spoke cluster. As the spoke cluster is the source of truth, direct changes in the hub cluster are not allowed.