// CNF-1498 Validate and Document Intel SRO and SRIOV FEC Operator
// Module included in the following assemblies:
//
// *cnf-optimize-data-performance-n3000.adoc

:_content-type: PROCEDURE
[id="cnf-programming-the-n3000-operator_{context}"]
= Programming the OpenNESS Operator for Intel FPGA PAC N3000

When the Intel FPGA PAC N3000 is programmed with a vRAN 5G bitstream, the hardware exposes the Intel FPGA PAC N3000 with a vRAN 5G bitstream. This bitstream exposes the Single Root I/O Virtualization (SR-IOV) virtual function (VF) devices used to accelerate the FEC in the vRAN workload.

As a cluster administrator, you can install the OpenNESS Operator for Intel FPGA PAC N3000 by using the {product-title} CLI or the web console.

[id="programmimg-n3000-with-a-vran-bitstream_{context}"]
== Programming the N3000 with a vRAN bitstream

As a cluster administrator, you can program the Intel FPGA PAC N3000 with a vRAN 5G bitstream. This bitstream exposes the Single Root I/O Virtualization (SR-IOV) virtual function (VF) devices that are used to accelerate the forward error correction (FEC) in the vRAN workload.

The role of forward error correction (FEC) is to correct transmission errors, where certain bits in a message can be lost or garbled. Messages can be lost or garbled due to noise in the transmission media, interference, or low signal strength.
Without FEC, a garbled message would have to be resent, adding to the network load and impacting both throughput and latency.

.Prerequisites

* Intel FPGA PAC N3000 card
* Performance Addon Operator with RT kernel configuration
* Node or nodes installed with the OpenNESS Operator for Intel FPGA PAC N3000
* Log in as a user with `cluster-admin` privileges
+
[NOTE]
====
All the commands run in the `vran-acceleration-operators` namespace.
====

.Procedure

. Change to the `vran-acceleration-operators` project:
+
[source,terminal]
----
$ oc project vran-acceleration-operators
----

. Verify that the pods are running:
+
[source,terminal]
----
$ oc get pods
----
+
.Example output
[source,terminal]
----
NAME                                        READY       STATUS          RESTARTS    AGE
fpga-driver-daemonset-8xz4c                 1/1         Running         0           15d
fpgainfo-exporter-vhvdq                     1/1         Running         1           15d
N3000-controller-manager-b68475c76-gcc6v    2/2         Running         1           15d
N3000-daemonset-5k55l                       1/1         Running         1           15d
N3000-discovery-blmjl                       1/1         Running         1           15d
N3000-discovery-lblh7                       1/1         Running         1           15d
----
The following section provides information on the installed pods:
* `fpga-driver-daemonset` provides and loads the required Open Programmable Accelerator Engine (OPAE) drivers
* `fpgainfo-exporter` provides N3000 telemetry data for Prometheus
* `N3000-controller-manager` applies N3000Node CRs to the cluster and manages all the operand containers
* `N3000-daemonset` is the main worker application. It monitors the changes in each node's CR and acts on the changes. The logic implemented into this Daemon takes care of updating the cards' FPGA user image and NIC firmware. It is also responsible for draining the nodes and taking them out of commission when required by the update.
* `N3000-discovery` discovers N3000 Accelerator devices installed and labels worker nodes if devices are present

. Get all the nodes containing the Intel FPGA PAC N3000 card:
+
[source,terminal]
----
$ oc get n3000node
----
+
.Example output
[source,terminal]
----
NAME                       FLASH
node1                      NotRequested
----

. Get information about the card on each node:
+
[source,terminal]
----
$ oc get n3000node node1 -o yaml
----
+
.Example output
[source,yaml]
----
status:
  conditions:
  - lastTransitionTime: "2020-12-15T17:09:26Z"
    message: Inventory up to date
    observedGeneration: 1
    reason: NotRequested
    status: "False"
    type: Flashed
  fortville:
  - N3000PCI: 0000:1b:00.0
    NICs:
    - MAC: 64:4c:36:11:1b:a8
      NVMVersion: 7.00 0x800052b0 0.0.0
      PCIAddr: 0000:1a:00.0
      name: Ethernet Controller XXV710 Intel(R) FPGA Programmable Acceleration Card N3000 for Networking
    - MAC: 64:4c:36:11:1b:a9
      NVMVersion: 7.00 0x800052b0 0.0.0
      PCIAddr: 0000:1a:00.1
      name: Ethernet Controller XXV710 Intel(R) FPGA Programmable Acceleration Card N3000 for Networking
    - MAC: 64:4c:36:11:1b:ac
      NVMVersion: 7.00 0x800052b0 0.0.0
      PCIAddr: 0000:1c:00.0
      name: Ethernet Controller XXV710 Intel(R) FPGA Programmable Acceleration Card N3000 for Networking
    - MAC: 64:4c:36:11:1b:ad
      NVMVersion: 7.00 0x800052b0 0.0.0
      PCIAddr: 0000:1c:00.1
      name: Ethernet Controller XXV710 Intel(R) FPGA Programmable Acceleration Card N3000 for Networking
  fpga:
  - PCIAddr: 0000:1b:00.0 <1>
    bitstreamId: "0x23000410010310" <2>
    bitstreamVersion: 0.2.3
    deviceId: "0x0b30"
----
<1> The `PCIAddr` field indicates the PCI address of the card.
<2> The `bitstreamId` field indicates the bitstream that is currently stored in flash.

. Save the current `bitstreamId`, `PCIAddr`, the name, and the `deviceId` without "0x" padding.
+
[source,terminal]
----
$ oc get n3000node -o json
----

. Update the user bitstream of the Intel FPGA PAC N3000 card:

.. Define the N3000 cluster resource to program by creating a file named `n3000-cluster.yaml` as shown in the following example:
+
[source,yaml]
----
apiVersion: fpga.intel.com/v1
kind: N3000Cluster
metadata:
    name: n3000 <1>
    namespace: vran-acceleration-operators
spec:
    nodes:
      - nodeName: "node1" <2>
        fpga:
          - userImageURL: "http://10.10.10.122:8000/pkg/20ww27.5-2x2x25G-5GLDPC-v1.6.1-3.0.0_unsigned.bin" <3>
            PCIAddr: "0000:1b:00.0" <4>
            checksum: "0b0a87b974d35ea16023ceb57f7d5d9c" <5>
----
<1> Specify the name. The name must be `n3000`.
<2> Specify the node to program.
<3> Specify the URL for the user bitstream. This bitstream file must be accessible on an HTTP or HTTPS server.
<4> Specify the PCI address of the card to program.
<5> Specify the MD5 checksum of the bitstream that is specified in the `userImageURL` field.
+
The N3000 daemon updates the FPGA user bitstream using the Open Programmable Acceleration Engine (OPAE) tools and resets the PCI device.
The update of the FPGA user bitstream can require up to 40 minutes per card. For programming cards on multiple nodes, the programming happens one node at a time.

.. Apply the update to begin programming the card with the bitstream:
+
[source,terminal]
----
$ oc apply -f n3000-cluster.yaml
----
+
The N3000 daemon starts programming the bitstream after the appropriate 5G FEC user bitstream has been provisioned, such as `20ww27.5-2x2x25G-5GLDPC-v1.6.1-3.0.0_unsigned.bin` in this example, and after the CR has been created.

.. Check the status:
+
[source,terminal]
----
oc get n3000node
----
+
.Example output
[source,terminal]
----
NAME             FLASH
node1            InProgress
----

. Check the logs:
.. Determine the pod name of the N3000 daemon:
+
[source,terminal]
----
$ oc get pod -o wide | grep n3000-daemonset | grep node1
----
+
.Example output
[source,terminal]
----
n3000-daemonset-5k55l              1/1     Running   0          15d
----

.. View the logs:
+
[source,terminal]
----
$ oc logs n3000-daemonset-5k55l
----
+
.Example output
[source,terminal]
----
...
{"level":"info","ts":1608054338.8866854,"logger":"daemon.drainhelper.cordonAndDrain()","msg":"node drained"}
{"level":"info","ts":1608054338.8867319,"logger":"daemon.drainhelper.Run()","msg":"worker function - start"}
{"level":"info","ts":1608054338.9003832,"logger":"daemon.fpgaManager.ProgramFPGAs","msg":"Start program","PCIAddr":"0000:1b:00.0"}
{"level":"info","ts":1608054338.9004142,"logger":"daemon.fpgaManager.ProgramFPGA","msg":"Starting","pci":"0000:1b:00.0"}
{"level":"info","ts":1608056309.9367146,"logger":"daemon.fpgaManager.ProgramFPGA","msg":"Program FPGA completed, start new power cycle N3000 ...","pci":"0000:1b:00.0"}
{"level":"info","ts":1608056333.3528838,"logger":"daemon.drainhelper.Run()","msg":"worker function - end","performUncordon":true}
...
----
+
The log file indicates the following flow of events:

* The bitstream is downloaded and validated.
* The node is drained and no workload is able to run during this time.
* Flashing is started:
** The bitstream is flashed into the card.
** The bitstream is applied.
* After flashing is complete the PCI device or devices on the node or nodes are reloaded. The OpenNESS SR-IOV Operator for Wireless FEC Accelerators is now able to find the new flashed device or devices.

.Verification
. Verify the status after the FPGA user bitstream update is complete:
+
[source,terminal]
----
oc get n3000node
----
+
.Example output
[source,terminal]
----
NAME             FLASH
node1            Succeeded
----

. Verify that the bitstream ID of the card has changed:
+
[source,terminal]
----
oc get n3000node node1 -o yaml
----
+
.Example output
[source,yaml]
----
status:
      conditions:
          - lastTransitionTime: "2020-12-15T18:18:53Z"
            message: Flashed successfully <1>
            observedGeneration: 2
            reason: Succeeded
            status: "True"
            type: Flashed
      fortville:
      - N3000PCI: 0000:1b:00.0
        NICs:
        - MAC: 64:4c:36:11:1b:a8
          NVMVersion: 7.00 0x800052b0 0.0.0
          PCIAddr: 0000:1a:00.0
          name: Ethernet Controller XXV710 Intel(R) FPGA Programmable Acceleration Card N3000 for Networking
        - MAC: 64:4c:36:11:1b:a9
          NVMVersion: 7.00 0x800052b0 0.0.0
          PCIAddr: 0000:1a:00.1
          name: Ethernet Controller XXV710 Intel(R) FPGA Programmable Acceleration Card N3000 for Networking
        - MAC: 64:4c:36:11:1b:ac
          NVMVersion: 7.00 0x800052b0 0.0.0
          PCIAddr: 0000:1c:00.0
          name: Ethernet Controller XXV710 Intel(R) FPGA Programmable Acceleration Card N3000 for Networking
        - MAC: 64:4c:36:11:1b:ad
          NVMVersion: 7.00 0x800052b0 0.0.0
          PCIAddr: 0000:1c:00.1
          name: Ethernet Controller XXV710 Intel(R) FPGA Programmable Acceleration Card N3000 for Networking
      fpga:
      - PCIAddr: 0000:1b:00.0 <2>
        bitstreamId: "0x2315842A010601" <3>
        bitstreamVersion: 0.2.3
        deviceId: "0x0b30" <4>
----
+
<1> The `message` field indicates the device is successfully flashed.
<2> The `PCIAddr` field indicates the PCI address of the card.
<3> The `bitstreamId` field indicates the updated bitstream ID.
<4> The `deviceID` field indicates that device ID of the bitstream inside the card exposed to the system.

. Check the FEC PCI devices on the node:

.. Verify the node configuration is applied correctly:
+
[source,terminal]
----
$ oc debug node/node1
----
+
.Expected output
[source,terminal]
----
Starting pod/<node-name>-debug ...
To use host binaries, run `chroot /host`

Pod IP: <ip-address>
If you don't see a command prompt, try pressing enter.

sh-4.4#
----

.. Verify that you can use the node file system:
+
[source,terminal]
----
sh-4.4# chroot /host
----
+
.Expected output
[source,terminal]
----
sh-4.4#
----

.. List the PCI devices associated with the accelerator on your system:
+
[source,terminal]
----
$ lspci | grep accelerators
----
+
.Expected output
[source,terminal]
----
1b:00.0 Processing accelerators: Intel Corporation Device 0b30
1d:00.0 Processing accelerators: Intel Corporation Device 0d8f (rev 01)
----
+
Devices belonging to the FPGA are reported in the output. Device ID `0b30` is the RSU interface used to program the card, and the `0d8f` is a physical function of the newly programmed 5G device.
