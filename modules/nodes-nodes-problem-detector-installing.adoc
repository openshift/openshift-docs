// Module included in the following assemblies:
//
// * nodes/nodes-nodes-problem-detector.adoc

[id='nodes-nodes-problem-detector-installing-{context}']
= Installing the {product-title} Node Problem Detector

You can use the {product-title} console to install the Node Problem Detector Operator.

.Prerequisites

. Create a Project for the NPD:
+
----
$ oc adm new-project openshift-node-problem-detector --node-selector ""
----

. Create an Operator Group:

.. Add the followng code to a YAML file:
+
----
apiVersion: operators.coreos.com/v1alpha2
kind: OperatorGroup
metadata:
  name: npd-operators
  namespace: openshift-node-problem-detector
spec:
  targetNamespaces:
  - openshift-node-problem-detector
----

.. Create the Operator Group:
+
----
$ oc create -f -<file-name>.yaml
----

.Procedure

The process to install the Node Problem Detector involves installing the Node Problem Detector Operator and creating a Node Problem Detector instance.

. In the {product-title} console, click *Catalog* -> *OperatorHub*.

. On the *Create Operator Subscription* page:

.. Select the `openshift-node-problem-detector` project from the *A specific namespace on the cluster* drop-down list.

.. Click *Subscribe*.

.. Click *Subscribe*.

. On the *Catalog* → *Installed Operators* page, verify that the NodeProblemDetector (CSV) eventually shows up and its *Status* ultimately resolves to *InstallSucceeded*.
+
If it does not, switch to the *Catalog* → *Operator Management* page and inspect the *Operator Subscriptions* and *Install Plans* tabs for any failure or errors under *Status*. Then, check the logs in any Pods in the openshift-operators project (on the *Workloads* → *Pods* page) that are reporting issues to troubleshoot further.

. Click *Administration* -> *CRD*.

. On the *Custom Resource Definitions* page, click *NodeProblemDetector*.

. On the *Node Problem Detector* page, click *Create Node Problem Detector*.

. Specify a name and enter the *openshift-node-problem-detector* namespace.
+
[source,yaml]
----
apiVersion: node-problem-detector.operator.k8s.io/v1alpha1
kind: NodeProblemDetector
metadata:
  name: nodeproblemdetectors.node-problem-detector.operator.k8s.io <1>
  namespace: openshift-node-problem-detector <2>
spec: {}
----
<1> Specify a name for the Node Problem Detector.
<2> Specify `openshift-node-problem-detector` as the namespace.

//Beta steps https://bugzilla.redhat.com/show_bug.cgi?id=1679467

. Create a Node Problem Detector RBAC (RBAC):
+
[source,yaml]
----
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: node-problem-detector-operator
  namespace: openshift-node-problem-detector
rules:
- apiGroups:
  - node-problem-detector.operator.k8s.io
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - ""
  resources:
  - pods
  - events
  - configmaps
  - secrets
  - services
  - endpoints
  - serviceaccounts
  verbs:
  - "*"
- apiGroups:
  - apps
  resources:
  - daemonsets
  verbs:
  - "*"

--

kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: node-problem-detector-operator
  namespace: openshift-node-problem-detector
subjects:
- kind: ServiceAccount
  name: node-problem-detector-operator
roleRef:
  kind: Role
  name: node-problem-detector-operator
  apiGroup: rbac.authorization.k8s.io

---

kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openshift-node-problem-detector-operator
rules:
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  # the operator needs to be able to bind the cluster role
  # system:node-problem-detector to the node-problem-detector service account
  - clusterrolebindings
  verbs:
  - "*"
- apiGroups:
  - security.openshift.io
  resources:
  # the operator needs to be able to add the node-problem-detector service account
  # to the list of accounts that can use the privileged SCC
  - securitycontextconstraints
  verbs:
  - "*"

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openshift-node-problem-detector-operator-1
subjects:
- kind: ServiceAccount
  name: node-problem-detector-operator
  namespace: openshift-node-problem-detector
roleRef:
  kind: ClusterRole
  name: openshift-node-problem-detector-operator
  apiGroup: rbac.authorization.k8s.io

----

oc create -f deploy/rbac.yaml
oc create -f deploy/operator.yaml
oc create -f deploy/cr.yaml


. Create a Node Problem Detector custom resource (CR):
+
[source,yaml]
----
apiVersion: node-problem-detector.operator.k8s.io/v1alpha1
kind: NodeProblemDetector
metadata:
  name: node-problem-detector
namespace: openshift-node-problem-detector
----

. Configure the Node Problem Detector policy as needed and click *Create*.
