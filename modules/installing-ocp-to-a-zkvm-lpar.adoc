// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// This module can be included from assemblies using the following include statement:
// include::<path>/proc_installing-ocp-to-a-zkvm-lpar.adoc[leveloffset=+1]

// The file name and the ID are based on the module title. For example:
// * file name: proc_doing-procedure-a.adoc
// * ID: [id='proc_doing-procedure-a_{context}']
// * Title: = Doing procedure A
//
// The ID is used as an anchor for linking to the module. Avoid changing
// it after the module has been published to ensure existing links are not
// broken.
//
// The `context` attribute enables module reuse. Every module's ID includes
// {context}, which ensures that the module has a unique ID even if it is
// reused multiple times in a guide.
//
// Start the title with a verb, such as Creating or Create. See also
// _Wording of headings_ in _The IBM Style Guide_.
[id="installing-ocp-to-a-zkvm-lpar_{context}"]
= Installing OCP to a zKVM LPAR

For some folks testing OpenShift, it is important to install a cluster directly to their own hardware - whether it is in the Poughkeepsie lab or not. The quickest and easiest way to do this is on a zKVM hypervisor. These instructions walk you through how you can deploy your own OpenShift cluster on such an environment using the automation provided by the Red Hat Multi-Arch team.

[discrete]
== Hypervisor Setup
The first step to installing OpenShift 4 in a KVM environment is to provision the nodes that you will use to deploy OpenShift. By the end of this section, you should have created a group of VMs via libvirt that we will use later for our deployment.

[discrete]
== Prerequisites
* zKVM LPAR with RHEL 8 installed
** At least 300 GB of storage available at /home/libvirt
** At least 64 GB of RAM
* Install these packages via yum
** curl
** python3
** ansible (from ansible-2.8 repo)
*** Add respective ansible 2.8 repo via subscription manager
** python3-netaddr
** gcc,gcc-c++

[discrete]
== Procedure

This section describes the instructions for setting up the VMs that the cluster will be installed upon. Many of the following steps expect to be run in a terminal. The host it that terminal should be running on is in *bold*.

. SSH into the hypervisor from your *localhost*.
....
$ ssh root@hypervisor_fqdn_or_ip
....
+
. Download tony-hypervisor-setup from partners-ftp to the *hypervisor*.
....
$ curl -O ftp://partners.redhat.com/1c5d859a/IBM-917ca288c24859a81f35b894e0b77589/Openshift-ibm/OCP_4.2.z_for_Z/68131/tony-hypervisor-setup-20191023-s390x.tar.gz
....
+
On the *hypervisor*, un-tar the setup playbooks.
....
$ tar -xf tony-hypervisor-setup-20191023-s390x.tar.gz; mv tony-hypervisor-setup-20191023-s390x tony-hypervisor-setup
....
+
. On the *hypervisor*, change your working directory to the setup directory.
....
$ cd tony-hypervisor-setup
....
+
. Configure `inventory/lab/hosts.yaml` by changing the hostname under hosts to point to your hypervisor, as shown in step 3a below. *Watch out* for the colons after the hostnames - they are required for this file to be valid and should not be removed.
+
.. `inventory/lab/hosts.yaml`
....
all:
  hosts:
    hypervisor_fqdn_or_ip:
      private_nic: dummy0
      host_bits: 254
      is_virtual_gateway: true
  children:
    hypervisors:
      hosts:
        hypervisor_fqdn_or_ip:
....
+
. Generate an SSH key on the *hypervisor* and copy the public key to authorized_keys for the ansible access to work.
....
$ pushd ~/.ssh
$ ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
....
+
.. Accept the prompts to complete your key creation.

.. Copy the public key to authorized keys so that Ansible can SSH to the host.
....
$ cat id_rsa.pub | tee --append authorized_keys
$ popd
....
+
. Run the hypervisor_setup.yaml playbook on the *hypervisor*.
....
$ ansible-playbook -i inventory/lab hypervisor_setup.yaml
....
+
. Run the virs_director_setup.yml playbook on the *hypervisor*.
....
$ ansible-playbook -i inventory/lab virs_director_setup.yaml
....
+
. On the *hypervisor*, run the bastion installation shell script to start a VM that will serve as the gateway and dns provider for your cluster.
....
$ /home/libvirt/bastion.sh
....

[discrete]
== Additional resources

* A bulleted list of links to other material closely related to the contents of the procedure module.
* For more details on writing procedure modules, see the link:https://github.com/redhat-documentation/modular-docs#modular-documentation-reference-guide[Modular Documentation Reference Guide].
* Use a consistent system for file names, IDs, and titles. For tips, see _Anchor Names and File Names_ in link:https://github.com/redhat-documentation/modular-docs#modular-documentation-reference-guide[Modular Documentation Reference Guide].
