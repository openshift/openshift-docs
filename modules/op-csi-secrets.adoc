// This module is included in the following assembly:
//
// * secure/using-csi-secrets.adoc

:_mod-docs-content-type: PROCEDURE
[id="consuming-secrets-csi_{context}"]
= Consuming secrets from an external store such as Hashicorp Vault using the Secrets Store CSI Driver

If you want to use secrets from an external store that has a Container Storage Interface (CSI) provider, for example, Hashicorp Vault, you can configure {pipelines-shortname} to consume these secrets using the Secrets Store CSI Driver.

.Prerequisites

* You installed the Secrets Store CSI Driver. For information about installing the CSI Driver, see the link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/storage/using-container-storage-interface-csi#persistent-storage-csi-secrets-store[Secrets Store CSI Driver] in the {OCP} documentation.

* You installed the CSI provider for your external secret store. For information about installing Hashicorp Vault, including its CSI provider, on {OCP}, see link:https://developer.hashicorp.com/vault/docs/deploy/kubernetes/csi/installation[Install the Vault CSI provider] in the Hashicorp documentation.
+
[NOTE]
====
If you want to use an instance of Hashicorp Vault running outside your {OCP} cluster, you must provide the address to that instance in the Helm configuration when installing the CSI Provider. For information about providing an external Vault address, see link:https://developer.hashicorp.com/vault/docs/deploy/kubernetes/helm/configuration#externalvaultaddr[Configuration] in the Hashicorp documentation.
====

* You configured authentication with the secret store for an {OCP} service account, for example, `pipeline-sa`. For information about configuring Kubernetes authentication with Hashicorp Vault, see link:https://developer.hashicorp.com/vault/docs/auth/kubernetes[Kubernetes auth method] in the Hashicorp documentation.
+
[NOTE]
====
You must create the service account in the namespace in which you create pipelines and other Custom Resources (CRs) for {pipelines-shortname}.
====

* Ensure that the Secrets Store CSI Driver service account has the required cluster-wide permissions to create service account tokens in all relevant namespaces. Without these permissions, pods will fail to start and you may encounter the following error:
+
[source,terminal]
----
User "system:serviceaccount:csi-driver:secrets-store-csi-driver" cannot create resource "serviceaccounts/token" in API group "" in the namespace "tekton-vault"
----

.Procedure

. To configure the namespace to allow privileged pod security for CSI volumes, run the following command:
+                                                                                                     
[source,terminal]
----
$ oc label namespace tekton-vault pod-security.kubernetes.io/enforce=privileged
----

. In the namespace in which you create pipelines, for example, `tekton-vault`, create a `Role` resource that allows `get`, `list`, and `watch` operations for the `secrets` resource.
+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pipeline-role
  namespace: tekton-vault
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch"]
----

. Create a `RoleBinding` resource that binds the `pipeline-role` role to the service account which you configured for authentication with the secret store, for example, `pipeline-sa`.
+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pipeline-role-binding
  namespace: tekton-vault
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pipeline-role
subjects:
- kind: ServiceAccount
  name: pipeline-sa
  namespace: tekton-vault
----

. Create a `SecretProviderClass` CR that defines the secrets that your pipeline or task consumes and the mount path and filename (key) for each of these secrets.
+
[source,yaml]
----
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: vault-secret
  namespace: tekton-vault
spec:
  provider: vault
  parameters:
    vaultAddress: "http://vault.vault:8200"
    vaultSkipTLSVerify: "true"
    roleName: "my-role"
    objects: |
      - objectName: "demo-secret"
        secretPath: "secret/data/my-secret"
        secretKey: "username"
      - objectName: "demo-secret-pass"
        secretPath: "secret/data/my-secret"
        secretKey: "password"
----
+
[WARNING]
====
The `vaultAddress` parameter used in this example uses `http` and `vaultSkipTLSVerify`: `"true"` only for demonstration purposes. For production use, configure Vault with a secure `https` endpoint and do not skip TLS verification.
====

. In the definition of the task that consumes the secrets, define and mount a volume that uses the CSI secrets store driver and specifies the name of the `SecretProviderClass` CR. To minimise security exposure of secrets, mount them in the definition of a task and not of an entire pipeline.
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: secret-task
  namespace: tekton-vault
spec:
  steps:
    - name: use-secret
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      script: |
        #!/bin/sh
        echo "Reading secrets from mounted volume..."
        echo "Username: $(cat /mnt/secrets-store/demo-secret)"
        echo "Password: $(cat /mnt/secrets-store/demo-secret-pass)"
      volumeMounts:
        - name: secrets-store-inline
          mountPath: "/mnt/secrets-store"
          readOnly: true
  volumes:
    - name: secrets-store-inline
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: "vault-secret"
----
+
[NOTE]
====
* The mount path that you specify in the pipeline or task definition overrides the path that you specify in the `SecretProviderClass` CR.

* This example provides secrets for demonstration purposes only. In production environment, avoid logging secrets as they are visible in pod logs.
====

. In the `PipelineRun` or `TaskRun` CR, assign the service account that is authenticated with the secret store to the task:

** If you create a `PipelineRun` CR, use the `taskRunSpecs` section to assign the service account to the particular task. Do not assign the service account to the entire pipeline.
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: vault-secret-pipeline
  namespace: tekton-vault
spec:
  tasks:
    - name: read-secret
      taskRef:
        name: secret-task
---
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: vault-secret-pipeline-run
  namespace: tekton-vault
spec:
  pipelineRef:
    name: vault-secret-pipeline
  taskRunSpecs:
    - pipelineTaskName: read-secret
      serviceAccountName: pipeline-sa
----

** If you create a `TaskRun` CR, use the `serviceAccountName` setting to assign the service account.
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: TaskRun
metadata:
  name: vault-secret-task-run
  namespace: tekton-vault
spec:
  taskRef:
    name: secret-task
  serviceAccountName: pipeline-sa
----
