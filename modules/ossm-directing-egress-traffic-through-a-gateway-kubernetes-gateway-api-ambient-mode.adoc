// This procedure is used in the following assembly:
// * service-mesh-docs-main/gateways/ossm-directing-outbound-traffic-through-a-gateway

:_mod-docs-content-type: PROCEDURE
[id="ossm-directing-egress-traffic-through-gateway-kubernetes-gateway-api-ambient-mode_{context}"]
= Directing egress traffic through a gateway using the {k8s} Gateway API in ambient mode

[role="_abstract"]
Use the {k8s} Gateway API and waypoint proxy to direct outbound HTTP traffic through an egress gateway.

.Prerequisites

* You have installed the {SMProduct} Operator version 3.2 or later.

* You configured the `Istio` and `IstioCNI` resources with ambient profile.

* You have created a `Ztunnel` resource.

.Procedure

. Optional: Enable the {k8} Gateway API custom resource definitions (CRDs). 
+
[NOTE]
====
As of {k8s} 1.28 and {ocp-product-title} 4.18 or earlier version of {product-title}, the {k8s} Gateway API CRDs are not available by default and you must install the CRDs before you can use them. {ocp-product-title} 4.19 and later versions install the CRDs by default.
====

. Create a namespace called `egress-gateway` by running the following command:
+
[source,terminal]
----
$ oc create namespace egress-gateway
----

. Apply the ambient mode label to the namespace by running the following command:
+
[source,terminal]
----
$ oc label namespace egress-gateway istio.io/dataplane-mode=ambient
----

. Create a YAML file named `egress-se.yaml` that defines the `ServiceEntry`.
+
[source,yaml]
----
apiVersion: networking.istio.io/v1
kind: ServiceEntry
metadata:
  name: httpbin-ext
  namespace: egress-gateway
  labels:
    istio.io/use-waypoint: waypoint
spec:
  hosts:
  - httpbin.org
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: DNS
----

.. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f egress-se.yaml
----

.. Create a YAML file named `waypoint.yaml` that creates a waypoint proxy in `egress-gateway` namespace similar to the following example:
+
[source,yaml]
----
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: waypoint
  namespace: egress-gateway
  labels:
    istio.io/gateway-for: service
spec:
  gatewayClassName: istio-waypoint
  listeners:
  - name: mesh
    port: 15008
    protocol: HBONE
----

.. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f waypoint.yaml
----

[NOTE]
====
As an alternate to creating the `waypoint.yaml` YAML file, you can also set up waypoint proxy by running the following command:
[source,terminal]
----
$ istioctl waypoint apply --enroll-namespace --name waypoint --namespace egress-gateway
----
When you use the `--enroll-namespace` option, all services in the `egress-gateway` namespace (including `ServiceEntries`), will route their traffic through the waypoint.
====

.Verification

. Verify the status of the gateway configuration by running the following command:
+
[source,terminal]
----
$ oc get gateways.gateway.networking.k8s.io waypoint -n egress-gateway
----
+
The `PROGRAMMED` column shows `True` when the configuration succeeds, similar to the following example:
+
[source,terminal]
----
NAME       CLASS            ADDRESS          PROGRAMMED   AGE
waypoint   istio-waypoint   172.30.227.148   True         9s
----

. Create a `curl` pod in the `egress-gateway` namespace by running the following command:
+
[source,terminal]
----
$ oc run test-pod --image=curlimages/curl:latest -n egress-gateway --rm -it --restart=Never -- sh
----

. By using the `curl` client, verify that you can access `httpbin.org` through the egress gateway by running the following command:
+
[source,terminal]
----
$ curl -v http://httpbin.org/get
----
+
The output shows a response from `httpbin.org` service that indicates egress traffic routes through the configured gateway. The ztunnel logs should show traffic routed through the waypoint. The terminal should display information similar to the following output:
+
[source,terminal]
----
2025-10-24T08:08:35.242159Z info access connection complete src.addr=[fd01:0:0:5::b0]:56288 src.workload="test-pod" src.namespace="egress-gateway" src.identity="spiffe://cluster.local/ns/egress-gateway/sa/default" dst.addr=[fd01:0:0:5::af]:15008 dst.hbone_addr=[2001:2::2]:80 dst.service="httpbin.org" dst.workload="waypoint-5b668759d5-vrnx8" dst.namespace="egress-gateway" dst.identity="spiffe://cluster.local/ns/egress-gateway/sa/waypoint" direction="outbound" bytes_sent=78 bytes_recv=540 duration="957ms"
----
