// This procedure is used in the following assembly:
// * service-mesh-docs-main/gateways/ossm-directing-outbound-traffic-through-a-gateway

:_mod-docs-content-type: PROCEDURE
[id="ossm-directing-egress-traffic-through-gateway-kubernetes-gateway-api-ambient-mode_{context}"]
= Directing egress traffic through a gateway using the {k8s} Gateway API in ambient mode

Use the {k8s} Gateway API and waypoint proxy to direct outbound HTTP traffic through an egress gateway.

.Prerequisites

* You have installed the {SMProduct} Operator version 3.2 or later.

* You configured the `Istio` and `IstioCNI` resources with ambient profile.

* You have created a `Ztunnel` resource.

.Procedure

. Optional: Enable the {k8} Gateway API custom resource definitions (CRDs). 
+
[NOTE]
====
As of {k8s} 1.28 and {ocp-product-title} 4.18 or earlier version of {product-title}, the {k8s} Gateway API CRDs are not available by default and you must enable the CRDs before you can use them. {ocp-product-title} 4.19 and later versions enable the CRDs by default.
====

. Create a namespace called `egress-gateway` by running the following command:
+
[source,terminal]
----
$ oc create namespace egress-gateway
----

. Apply the ambient mode label to the namespace by running the following command:
+
[source,terminal]
----
$ oc label namespace egress-gateway istio.io/dataplane-mode=ambient
----

. Create a YAML file named `egress-gateway-cr.yaml` that defines the egress gateway.
+
[source,yaml]
----
apiVersion: networking.istio.io/v1
kind: ServiceEntry
metadata:
  name: httpbin-ext
  namespace: egress-gateway
spec:
  hosts:
  - httpbin.org
  ports:
  - number: 80
    name: http
    protocol: HTTP
  location: MESH_EXTERNAL
  resolution: DNS
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: httpbin-egress-route
  namespace: egress-gateway
spec:
  parentRefs:
  - name: httpbin-egress-gateway
  hostnames:
  - httpbin.org
  rules:
  - backendRefs:
    - name: httpbin.org
      port: 80
----

.. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f egress-gateway-cr.yaml
----

.. Create a YAML file named `waypoint.yaml` that creates a waypoint proxy in `istio-egress` namespace similar to the following example:
+
[source,yaml]
----
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: waypoint
  namespace: egress-gateway
  labels:
    istio.io/gateway-for: service
spec:
  gatewayClassName: istio-waypoint
  listeners:
  - name: http
    port: 15008
    protocol: HBONE
    allowedRoutes:
      namespaces:
        from: Same
----
+
The traffic for egress in ambient mode is not automatically encrypted with ztunnel. Enabling a waypoint proxy allows encrypted traffic.

.. Apply the YAML file by running the following command:
+
[source,terminal]
----
$ oc apply -f waypoint.yaml
----

[NOTE]
====
As an alternate to creating the `waypoint.yaml` YAML file, you can also set up waypoint proxy by running the following command:
+
[source,terminal]
----
$ istioctl waypoint apply --enroll-namespace --name waypoint --namespace egress-gateway common-infrastructure
----
====

.Verification

. Verify the status of the gateway configuration by running the following command:
+
[source,terminal]
----
$ oc describe gateway -n egress-gateway
----
+
The `Status` column shows `Programmed` when the configuration succeeds.

. Create a `curl` pod in the `egress-gateway` namespace by running the following command:
+
[source,terminal]
----
$ oc run test-pod --image=curlimages/curl:latest -n egress-gateway --rm -it --restart=Never -- sh
----

. By using the `curl` client, verify that you can access `httpbin.org` through the egress gateway by running the following command:
+
[source,terminal]
----
$ curl -v http://httpbin.org/get
----
+
The desired output shows a response from `httpbin.org` that indicates egress traffic routes through the configured gateway. The ztunnel logs should show traffic routed through the egress gateway and waypoint. The terminal should display information similar to the following output:
+
[source,terminal]
----
2025-10-21T12:46:35.545230Z info access connection complete src.addr=#SRC_IP:36544 src.workload="test-pod" src.namespace="egress-gateway" src.identity="spiffe://cluster.local/ns/egress-gateway/sa/default" dst.addr=#DST_IP:15008 dst.hbone_addr=#HBONE_IP:80 dst.service="httpbin.org" dst.workload="waypoint-78d5849c46-pb9wh" dst.namespace="egress-gateway" dst.identity="spiffe://cluster.local/ns/egress-gateway/sa/waypoint" direction="outbound" bytes_sent=78 bytes_recv=542 duration="13791ms"
----