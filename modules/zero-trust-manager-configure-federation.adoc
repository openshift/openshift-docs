// Module included in the following assemblies:
//
// * security/zero_trust_workload_identity_manager/zero-trust-manager-spire-federation.adoc

:_mod-docs-content-type: PROCEDURE
[id="zero-trust-manager-configure-federation_{context}"]
= Configuring federation

[role="_abstract"]
Manually exchange trust bundles between clusters to establish a mutual trust relationship. This exchange is necessary because `https_spiffe` uses self-signed certificates, which prevents clusters from automatically trusting one another.

.Prerequisites

* Ensure that a SPIRE stack is up and running.

* Ensure that you have access to a machine that can reach both clusters.

.Procedure

. From a machine that has access to both clusters, fetch the trust bundels.

.. To fetch the trust bundle from cluster 1, run the following command:
+
[source,terminal]
----
$ curl -sk https://federation.<CLUSTER1_APPS_DOMAIN> > /tmp/cluster1-bundle.json
----

.. To fetch the trust bundle from cluster 2, run the following command:
+
[source,terminal]
----
$ curl -sk https://federation.<CLUSTER2_APPS_DOMAIN> > /tmp/cluster2-bundle.json
----

.. To verify that the bundles on each cluster are valid JSON keys, run the following commands:
+
[source,terminal]
----
$ cat /tmp/cluster1-bundle.json | jq '.keys | length'
----
+
[source,terminal]
----
$ cat /tmp/cluster2-bundle.json | jq '.keys | length'
----
+
Both results should return `2`.

. Create a `ClusterFederatedTrustDomain` `.yaml` file on cluster 1 by running the following command:
+
[source,yaml]
----
$ cat <<'EOF' > /tmp/cfdt-cluster1.yaml
apiVersion: spire.spiffe.io/v1alpha1
kind: ClusterFederatedTrustDomain
metadata:
  name: federation-to-cluster2
spec:
  trustDomain: <CLUSTER2_APPS_DOMAIN>
  bundleEndpointURL: https://federation.<CLUSTER2_APPS_DOMAIN>
  bundleEndpointProfile:
    type: https_spiffe
    endpointSPIFFEID: spiffe://<CLUSTER2_APPS_DOMAIN>/spire/server
  className: zero-trust-workload-identity-manager-spire
  trustDomainBundle: |
EOF
----

.. Append the cluster 1 `.yaml` file to cluster 2's bundle by running the following command:
+
[source,terminal]
----
$ cat /tmp/cluster2-bundle.json | sed 's/^/    /' >> /tmp/cfdt-cluster1.yaml
----

.. Apply the `.yaml` file to cluster 1 by running the following command:
+
[source,terminal]
----
$ oc apply -f /tmp/cfdt-cluster1.yaml
----

.. To verify that the `ClusterFederatedTrustDomain` has been created on cluster 1, run the following command:
+
[source,terminal]
----
$ oc get clusterfederatedtrustdomain
----

. Create a `ClusterFederatedTrustDomain` `.yaml` file on cluster 2 by running the following command:
+
[source,yaml]
----
$ cat <<'EOF' > /tmp/cfdt-cluster2.yaml
apiVersion: spire.spiffe.io/v1alpha1
kind: ClusterFederatedTrustDomain
metadata:
  name: federation-to-cluster1
spec:
  trustDomain: <CLUSTER1_APPS_DOMAIN>
  bundleEndpointURL: https://federation.<CLUSTER1_APPS_DOMAIN>
  bundleEndpointProfile:
    type: https_spiffe
    endpointSPIFFEID: spiffe://<CLUSTER1_APPS_DOMAIN>/spire/server
  className: zero-trust-workload-identity-manager-spire
  trustDomainBundle: |
EOF
----

.. Append the cluster 2 `.yaml` file to cluster 1's bundle by running the following command:
+
[source,terminal]
----
$ cat /tmp/cluster1-bundle.json | sed 's/^/    /' >> /tmp/cfdt-cluster2.yaml
----

.. Apply the `.yaml` file to cluster 2 by running the following command:
+
[source,terminal]
----
$ oc apply -f /tmp/cfdt-cluster2.yaml
----

.. To verify that the `ClusterFederatedTrustDomain` has been created on cluster 1, run the following command:
+
[source,terminal]
----
$ oc get clusterfederatedtrustdomain
----



