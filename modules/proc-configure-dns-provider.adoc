



[id="configure-dns-provider_{context}"]
= Configuring DNS provider credentials
:prodname: Connectivity Link

If you want to configure DNS policies in {prodname}, you must configure credentials for at least one of the following supported cloud-based DNS providers:

* Amazon Route 53
* Google Cloud DNS
* Microsoft Azure DNS
+
[NOTE]
====
* You must perform the steps for your chosen DNS provider on each {ocp} cluster that you want to use {prodname} on.
* You must configure the secret for the DNS provider in the same namespace that includes your Gateway.
* You must configure a DNS hosted zone. The credentials for your DNS provider must have permissions to update DNS records within this zone.
====

.Prerequisites

* See xref:install-prerequisites_{context}[].
* You have access to the namespace in which your Gateway will be created, for example, `api-gateway`.
+
NOTE: This guide uses environment variables for convenience only. If you know the environment variable values, you can set up the required `.yaml` files in a way that suits your needs.

== Configuring Amazon DNS provider credentials

.Procedure

. Set up your environment variables as follows:
+
[source,bash]
----
export AWS_ACCESS_KEY_ID=xxxxxxx
export AWS_SECRET_ACCESS_KEY=xxxxxxx
export AWS_REGION=your-aws-region
----
+
These variable values are described as follows:

* `AWS_ACCESS_KEY_ID`: Key ID from AWS with Route 53 access.
* `AWS_SECRET_ACCESS_KEY`: Key from AWS with Route 53 access.
* `AWS_REGION`: Your AWS region, for example, `us-east-2` or `eu-west-1`.

. Create a `Secret` resource for your credentials as follows:
+
[source,bash]
----
kubectl create secret generic aws-credentials \
  --namespace=api-gateway \
  --type=kuadrant.io/aws \
  --from-literal=AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
  --from-literal=AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
  --from-literal=AWS_REGION=$AWS_REGION
----
+
In this case, you must set the secret `type` to `aws`.

.Additional resources

* https://docs.aws.amazon.com/route53/?icmpid=docs_homepage_networking[Amazon Route 53 documentation].
* https://docs.kuadrant.io/1.2.x/dns-operator/docs/provider/#aws-iam-permissions-required[Configuring a DNS Provider - AWS IAM Permissions Required].


== Configuring Google DNS provider credentials

.Procedure

. Set up your environment variables as follows:
+
[source,bash]
----
export GOOGLE=xxxxxxx
export PROJECT_ID=xxxxxxx
----
+
These variable values are described as follows:

* `GOOGLE`:  Google credentials JSON file.
* `PROJECT_ID`: Google project ID.
+
The `GOOGLE` variable specifies the JSON credentials generated by the `gcloud` CLI or by the service account.
For example, `$HOME/.config/gcloud/application_default_credentials.json`, which contains the following:
+
[source,json]
----
{"client_id": "***","client_secret": "***","refresh_token": "***","type": "authorized_user"}
----

. Create a `Secret` resource for your credentials as follows:
+
[source,bash]
----
kubectl create secret generic test-gcp-credentials \
  --namespace=api-gateway \
  --type=kuadrant.io/gcp \
  --from-literal=PROJECT_ID=$PROJECT_ID \
  --from-file=GOOGLE=$GOOGLE
----
+
In this case, you must set the secret `type` to `gcp`.

.Additional resources

* https://cloud.google.com/dns/docs[Google Cloud DNS documentation].


== Configuring Azure DNS provider credentials

.Procedure

. Create a new Azure service principal for managing DNS as follows:
+
[source,bash]
----
DNS_NEW_SP_NAME=kuadrantDnsPrincipal
DNS_SP=$(az ad sp create-for-rbac --name $DNS_NEW_SP_NAME)
DNS_SP_APP_ID=$(echo $DNS_SP | jq -r '.appId')
DNS_SP_PASSWORD=$(echo $DNS_SP | jq -r '.password')
----
+
For more details on service principals, see the https://learn.microsoft.com/en-us/entra/identity-platform/app-objects-and-service-principals?tabs=browser#service-principal-object[Microsoft Azure documentation].

. To grant read and contributor access to the zones that you want managed for the service principal you are using, perform the following steps:
.. Fetch the DNS ID used to grant access to the service principal as follows:
+
[source,bash]
----
DNS_ID=$(az network dns zone show --name example.com \
 --resource-group ExampleDNSResourceGroup --query "id" --output tsv)

# Get your resource group ID
RESOURCE_GROUP_ID=az group show --resource-group ExampleDNSResourceGroup | jq ".id" -r
----

.. Provide reader access to the resource group as follows:
+
[source,bash]
----
az role assignment create --role "Reader" --assignee $DNS_SP_APP_ID --scope $DNS_ID
----

.. Provide contributor access to the DNS zone as follows:
+
[source,bash]
----
az role assignment create --role "Contributor" --assignee $DNS_SP_APP_ID --scope $DNS_ID
----

. Because you are setting up advanced traffic rules for geographic and weighted responses, you must also grant traffic manager and DNS zone access as follows:
+
[source,bash]
----
az role assignment create --role "Traffic Manager Contributor" --assignee $DNS_SP_APP_ID --scope $RESOURCE_GROUP_ID

az role assignment create --role "DNS Zone Contributor" --assignee $DNS_SP_APP_ID --scope $RESOURCE_GROUP_ID

cat <<-EOF > /local/path/to/azure.json
{
  "tenantId": "$(az account show --query tenantId -o tsv)",
  "subscriptionId": "$(az account show --query id -o tsv)",
  "resourceGroup": "ExampleDNSResourceGroup",
  "aadClientId": "$DNS_SP_APP_ID",
  "aadClientSecret": "$DNS_SP_PASSWORD"
}
EOF
----

. Create a `Secret` resource for your credentials as follows:
+
[source,bash]
----
kubectl create secret generic test-azure-credentials \
  --namespace=api-gateway \
  --type=kuadrant.io/azure \
  --from-file=azure.json=/local/path/to/azure.json
----
+
In this case, you must set the secret `type` to `azure`.

.Additional resources

* https://learn.microsoft.com/en-us/azure/dns/[Microsoft Azure DNS documentation].





