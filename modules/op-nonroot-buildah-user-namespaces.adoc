// This module is included in the following assemblies:
// * secure/unprivileged-building-of-container-images-using-buildah.adoc

:_mod-docs-content-type: PROCEDURE

[id="nonroot-buildah-user-namespaces_{context}"]
= Running Buildah as a non-root user by configuring user namespaces

[role="_abstract"]
Configuring user namespaces is the simplest way to run Buildah in a task as a non-root user. However, some images might not build using this option.

.Prerequisites

* You have installed the `oc` command-line utility.

.Procedure

. To create a copy of the `buildah` task, which is available in the `openshift-pipelines` namespace, and to change the name of the copy to `buildah-as-user`, enter the following command:
+
[source,terminal]
----
$ oc get task buildah -n openshift-pipelines -o yaml | yq '. |= (del .metadata |= with_entries(select(.key == "name" )))' | yq '.kind="Task"' | yq '.metadata.name="buildah-as-user"' | oc create -f -
----

. Edit the copied `buildah` task by entering the following command:
+
[source,terminal]
----
$ oc edit task buildah-as-user
----
+
In the new task, create `annotations` and `stepTemplate` sections, as shown in the following example:
+
.Example additions to the `buildah-as-user` task
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: Task
metadata:
  annotations:
    io.kubernetes.cri-o.userns-mode: 'auto:size=65536;map-to-root=true'
    io.openshift.builder: 'true'
  name: assemble-containerimage
  namespace: pipeline-namespace
spec:
  description: This task builds an image.
#  ...
  stepTemplate:
    env:
      - name: HOME
        value: /tekton/home
    image: $(params.builder-image)
    imagePullPolicy: IfNotPresent
    name: ''
    resources:
      limits:
        cpu: '1'
        memory: 4Gi
      requests:
        cpu: 100m
        memory: 2Gi
    securityContext:
      capabilities:
        add:
          - SETFCAP
      runAsNonRoot: true
      runAsUser: 1000
    workingDir: $(workspaces.working-directory.path)
#  ...
----
+
[NOTE]
====
The `runAsUser:` setting is not strictly necessary, because it uses `podTemplate`.
====

. Use the new `buildah-as-user` task to build the image in your pipeline.
