// CNF-43 Associate Secondary Interfaces Metrics to Network Attachments
// Module included in the following assemblies:
//
// *.adoc

[id="cnf-associate-secondary-interfaces-metrics-to-network-attachments_{context}"]
= Associate secondary interfaces metrics to network attachments

Secondary devices (interfaces) are used for different purposes. It's important to have a way to classify them in
order to be able to aggregate the metrics for secondary devices with the same classification.

Exposed metrics contain the interface but do not specify where the interface originates.
This is workable when there are no additional interfaces, but if a secondary interface is added,
it’s difficult to make use of the metrics since it’s hard to identify the interfaces using only the
interface name as an identifier.

When adding secondary interfaces, their names depend on the order in which they are added,
and different secondary interfaces may belong to different networks and can be used for different purposes.

With pod_network_name_info it is possible to extend the current metrics with the additional
information that identify the interface type. In this way, it is possible to aggregate the metrics and to add
specific alarms to specific interface types.

The network type is generated using the name of the related NetworkAttachementDefinition,
that in turn is used to differentiate different classes of secondary networks.
For example, different interfaces belonging to different networks or using different CNIs use different
network attachment definition names.

== Network Metrics Daemon

The Network Metrics Daemon is a daemon component that collects and publishes network related metrics.

The kubelet is already publishing network related metrics you can observe. These metrics are:

* `container_network_receive_bytes_total`
* `container_network_receive_errors_total`
* `container_network_receive_packets_total`
* `container_network_receive_packets_dropped_total`
* `container_network_transmit_bytes_total`
* `container_network_transmit_errors_total`
* `container_network_transmit_packets_total`
* `container_network_transmit_packets_dropped_total`

The labels in these metrics contain (among others):

* Pod name
* Pod namespace
* Interface name (such as `eth0`)

These metrics work fine until new interfaces are added to the pod, for example via https://github.com/intel/multus-cni[Multus],
as it isn’t clear what the interface names refer to.

The interface label refers to the interface name, but it's not clear what that interface is meant for.
In case of many different interfaces, it would be impossible to understand what network the metrics we are
monitoring refer to.

This is addressed by introducing the new `pod_network_name_info` described in the following section.

== Metrics with network name

This daemonset publishes a `pod_network_name_info` gauge metric, with a fixed value of `0`:

----
pod_network_name_info{interface="net0",namespace="namespacename",network_name="nadnamespace/firstNAD",pod="podname"} 0
----

The network name label is produced using the annotation added by Multus.
It's the concatenation of the namespace the network attachment definition belongs to, plus the name of the
network attachment definition.

The new metric alone does not provide much value, but combined with the network related `container_network_*` metrics,
it offers better support for monitoring secondary networks.

Using a `promql` query like the following ones, it is possible to get a new metric containing the value and the
network name retrieved from the k8s.v1.cni.cncf.io/networks-status annotation:

----
(container_network_receive_bytes_total) + on(namespace,pod,interface) group_left(network_name) ( pod_network_name_info )
(container_network_receive_errors_total) + on(namespace,pod,interface) group_left(network_name) ( pod_network_name_info )
(container_network_receive_packets_total) + on(namespace,pod,interface) group_left(network_name) ( pod_network_name_info )
(container_network_receive_packets_dropped_total) + on(namespace,pod,interface) group_left(network_name) ( pod_network_name_info )
(container_network_transmit_bytes_total) + on(namespace,pod,interface) group_left(network_name) ( pod_network_name_info )
(container_network_transmit_errors_total) + on(namespace,pod,interface) group_left(network_name) ( pod_network_name_info )
(container_network_transmit_packets_total) + on(namespace,pod,interface) group_left(network_name) ( pod_network_name_info )
(container_network_transmit_packets_dropped_total) + on(namespace,pod,interface) group_left(network_name)
----
