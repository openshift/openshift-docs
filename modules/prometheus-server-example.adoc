//module included in the following assemblies:
// * configuration/monitor-acs.adoc

:_mod-docs-content-type: PROCEDURE
[id="prometheus-server-example_{context}"]
= Setting up a Perses dashboard in {ocp} to monitor {product-title-short}

[role="_abstract"]
You can configure Prometheus server to work with {product-title-short} and a tool such as Perses in {ocp} or another application to monitor {product-title-short}.

.Procedure

. Use the Prometheus Operator or another installation method to install Prometheus in the `stackrox` namespace. 
. Verify that the Prometheus custom resource (CR) contains the following information:
+
[source,yaml]
----
  serviceAccountName: prometheus-server
  volumes:
  - name: prometheus-token
    projected:
      sources:
      - serviceAccountToken:
          path: token
          expirationSeconds: 3600
  volumeMounts:
  - name: prometheus-token
    mountPath: /var/run/secrets/tokens
    readOnly: true
  additionalScrapeConfigs:
    name: prometheus-additional-scrape-configs
    key: prometheus-additional.yaml
----
. Create the additional scrape configuration secret as shown in the following example:
+
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: prometheus-additional-scrape-configs
  namespace: stackrox
stringData:
  prometheus-additional.yaml: |
    - job_name: 'central-metrics'
      scheme: https
      metrics_path: /metrics
      bearer_token_file: /var/run/secrets/tokens/token
      tls_config:
        insecure_skip_verify: true
      static_configs:
      - targets: ['central.stackrox.svc.cluster.local:443']
----
. Perform role mapping to ensure that the Prometheus server can access the Central API with a service account token:
.. Add a role mapping to the machine access configuration of type `KUBE_SERVICE_ACCOUNT` for key sub and value `system:serviceaccount:stackrox:prometheus-server`. 
.. Create and assign a role with the appropriate permission set and scope.
//is this what we are listing in the prerequisite or something else?
. Create the Perses data source as shown in the following example:
+
[source,yaml]
----
apiVersion: perses.dev/v1alpha1
kind: PersesDatasource
metadata:
  name: rhacs-datasource
  namespace: stackrox
spec:
  client:
    tls:
      caCert:
        certPath: /ca/service-ca.crt
        type: file
      enable: true
  config:
    default: true
    display:
      name: RHACS Prometheus Datasource
    plugin:
      kind: PrometheusDatasource
      spec:
        proxy:
          kind: HTTPProxy
          spec:
            url: 'http://prometheus-operated.stackrox.svc.cluster.local:9090'
----

