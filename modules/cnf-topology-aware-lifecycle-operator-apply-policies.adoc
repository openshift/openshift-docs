// Module included in the following assemblies:
// Epic CNF-2600 (CNF-2133) (4.10), Story TELCODOCS-285
// * scalability_and_performance/cnf-topology-aware-lifecycle-operator.adoc

:_content-type: PROCEDURE
[id="talo-apply-policies_{context}"]
= Applying update policies to managed clusters

The Topology Aware Lifecycle Operator remediates a set of `inform` policies in a set of clusters. Then, TALO makes enforced copies of the managed {rh-rhacm} policies. Each copied policy has its own corresponding {rh-rhacm} placement rule and {rh-rhacm} placement binding. One by one, the Operator adds each cluster in the current batch to the placement rule that corresponds with the applicable managed policy. After a batch is updated, all clusters are removed from the placement rules associated with the copied policies. Then, the update of the next batch starts.

.Prerequisites

* Install the Topology Aware Lifecycle Operator.
* Provision one or more managed clusters using ZTP.
* Log in as a user with `cluster-admin` privileges.
* Create an {rh-rhacm} policy in the Hub cluster.

.Procedure

. Create the `ClusterGroupUpgrade` CR, and then save the YAML in the `cgu-cr.yaml` file:
+
[source,yaml]
----
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: du-upgrade-4915
  namespace: ztp-group-du-sno
spec:
  deleteObjects: true
  clusters: <1>
  - cnfdb1
  - cnfdb2
  enable: true
  managedPolicies:
  - du-upgrade-platform-upgrade <2>
  remediationStrategy:
    maxConcurrency: 2 <3>
    timeout: 240 <4>
----
<1> The list of clusters to update.
<2> The name of the policy to apply.
<3> The `maxConcurrency` field signifies the number of clusters updated at the same time.
<4> The update timeout in minutes.

. Create the `ClusterGroupUpgrade` CR by running the following command:
+
[source,terminal]
----
$ oc create -f cgu-cr.yaml
----

.Verification

. Check if the `ClusterGroupUpgrade` CR was created in the Hub cluster by running the following command:
+
[source,terminal]
----
$ oc get cgu-cr -A -w
----
+
.Example output
+
[source,terminal]
----
NAMESPACE          NAME              AGE
ztp-group-du-sno   du-upgrade-4915   5s
ztp-install        cnfdb1            4d5h
ztp-install        cnfdb2            4d5h
----

. Check the status of the policies by running the following command:
+
[source,terminal]
----
$ oc get policies -A | grep upgrade
----
+
.Example output
[source,terminal]
----
cnfdb1                ztp-group-du-sno.du-upgrade-platform-upgrade                   inform               Compliant          3d19h
cnfdb2                ztp-group-du-sno.du-upgrade-4915-du-upgrade-platform-upgrade   enforce              Compliant          23s <1>
cnfdb2                ztp-group-du-sno.du-upgrade-platform-upgrade                   inform               NonCompliant       3d19h
ztp-group-du-sno      du-upgrade-4915-du-upgrade-platform-upgrade                    enforce              Compliant          24s <1>
ztp-group-du-sno      du-upgrade-platform-upgrade                                    inform               NonCompliant       3d19h

----
<1> The status of the targeted clusters is changed to `enforce``.

. Check the status of the update by running the following command:
+
[source,terminal]
----
$ oc get clusterversion,node
----
+
.Example output
+
[source,terminal]
----
NAME                                         VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
clusterversion.config.openshift.io/version   4.9.13    True        True          104s    Working towards 4.9.15: 115 of 737 done (15% complete) <1>

NAME                                         STATUS   ROLES           AGE     VERSION
node/snonode.cnfdb1.example.com   Ready    master,worker   4d11h   v1.22.3+e790d7f
----
<1> The update is in progress.