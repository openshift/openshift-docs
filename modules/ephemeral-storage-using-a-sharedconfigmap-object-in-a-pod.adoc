// Module included in the following assemblies:
//
// * work_with_shared_resources/using-shared-resource-csi-driver.adoc

:_mod-docs-content-type: PROCEDURE
[id="ephemeral-storage-using-a-sharedconfigmap-custom-resource-in-a-pod_{context}"]
= Using a SharedConfigMap custom resource in a pod

[role="_abstract"]
To access a `SharedConfigMap` custom resource (CR) from a pod, you must grant the associated service account the necessary role-based access control (RBAC) permissions to use that `SharedConfigMap` CR.

.Prerequisites

* You are logged in to the {ocp-product-title} cluster  as one of the following users:
** A cluster administrator who has created the `SharedConfigMap` CR instance for the `ConfigMap` object.
** A user with permissions to access the target namespaces and to create or manage the `SharedConfigMap` CR for the `ConfigMap` to be shared.
* You must have permissions to perform the following actions:
** Run the `oc get sharedconfigmaps` command to get the list of the `SharedConfigMap` CR instances.
** Run the `oc adm policy who-can use <sharedsecret_identifier>` command to check if a service account is allowed to use the `SharedSecret` CR and the service account is listed in your namespace.
** Run the `oc describe clusterrole <roleName>` command to confirm that the service account of your pod is allowed to use `csi` volumes. If you created the pod as a user, confirm that you are allowed to use `csi` volumes.

[NOTE]
====
If you are unable to complete the last two prerequisites, the cluster administrator can grant you the RBAC permission to enable the service accounts to use the `SharedConfigMap` CR.
====

.Procedure

. Create the `RoleBinding` object associated with the role and grant the permission to your service account to use the shared resource. 
+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: use-shared-config
  namespace: <app_namespace>
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: use-shared-config
subjects:
  - kind: ServiceAccount
    name: <service_account_name>
----
+
where:

`<app_namespace>`:: Specifies the name of the namespace of your application.
`<service_account_name>`:: Specifies the service account name of your application.

. Mount the Shared Resource Container Storage Interface (CSI) Driver into a pod or any other resource that accepts `csi` volumes. 
+
[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: example-shared-config
  namespace: <app_namespace>
spec:
  ...
  serviceAccountName: default
  volumes:
    - name: shared-config
      csi:
        readOnly: true 
        driver: csi.sharedresource.openshift.io
        volumeAttributes:
          sharedConfigMap: share-test-config
----
+
where:

`<app_namespace>`:: Specifies the name of the namespace of your application.

`volumes.volumeAttributes.sharedConfigMap`:: Specifies the name of the `sharedConfigMap` object. 

+
[IMPORTANT]
====
The pod fails to start in the following cases:

* The value of the `SharedConfigMap` attribute does not match the name of the `SharedConfigMap` instance.
* A volume is defined but not mounted, the pod stays in the `ContainerCreating` state and eventually fails.
====

.Verification

. Run the following command to verify the permission granted to your service account:
+
[source,terminal]
----
$ oc describe rolebinding share-etc-pki-entitlement -n openshift-config-managed
----
+
.Example output
+
[source,terminal]
----
Name:         share-etc-pki-entitlement
Labels:       <none>
Annotations:  <none>
Role:
  Kind:  Role
  Name:  share-etc-pki-entitlement
Subjects:
  Kind            Name                        Namespace
  ----            ----                        ---------
  ServiceAccount  csi-driver-shared-resource  openshift-builds
----
