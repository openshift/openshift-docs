:_content-type: ASSEMBLY
[id="rosa-mobb-sts-cluster-logging-addon"]
= Tutorial: Workaround to fix the issue with the logging-addon on ROSA STS Clusters
include::_attributes/attributes-openshift-dedicated.adoc[]
:context: rosa-mobb-sts-cluster-logging-addon

toc::[]

// ---
// date: '2021-11-02'
// title: Work Around to fix the issue with the logging-addon on ROSA STS Clusters
// tags: ["AWS", "ROSA", "STS"]
// authors:
//   - Connor Wooley
// ---

include::snippets/mobb-support-statement.adoc[leveloffset=+1]

Currently, the logging-addon is not working on ROSA STS clusters.
This is due to permissions missing from the Operator itself.

The following procedure is a workaround to provide credentials to the addon.

[NOTE]
====
Please see the official link:https://access.redhat.com/solutions/6485391[Red Hat KCS] for more information.
====

.Prerequisites

* An STS-based ROSA Cluster

.Procedure

. Uninstall the logging-addon from the cluster:
+
[source,terminal]
----
$ rosa uninstall addon -c <mycluster> cluster-logging-operator -y
----

. Create an IAM Trust Policy document:
+
[source,terminal]
----
$ cat << EOF > /tmp/trust-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:PutLogEvents",
                "logs:GetLogEvents",
                "logs:PutRetentionPolicy",
                "logs:GetLogRecord"
            ],
            "Resource": "arn:aws:logs:*:*:*"
        }
    ]
}
EOF
----

. Create the IAM Policy:
+
[source,terminal]
----
$ POLICY_ARN=$(aws iam create-policy --policy-name "RosaCloudWatchAddon" --policy-document file:///tmp/trust-policy.json --query Policy.Arn --output text)
$ echo $POLICY_ARN
----

. Create a service account:
+
[source,terminal]
----
$ aws iam create-user --user-name RosaCloudWatchAddon  \
  --query User.Arn --output text
----

. Attach the policy to the user:
+
[source,terminal]
----
$ aws iam attach-user-policy --user-name RosaCloudWatchAddon \
  --policy-arn ${POLICY_ARN}
----

. Create an access key and save the output (Paste the `AccessKeyId` and `SecretAccessKey` into `values.yaml`):
+
[source,terminal]
----
$ aws iam create-access-key --user-name RosaCloudWatchAddon
----
+
[source,terminal]
----
$ export AWS_ID=<from above>
$ export AWS_KEY=<from above>
----

. Create a secret for the addon to use:
+
[source,terminal]
----
$ cat << EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
 name: instance
 namespace: openshift-logging
stringData:
  aws_access_key_id: ${AWS_ID}
  aws_secret_access_key: ${AWS_KEY}
EOF
----

. Install the logging-addon from the cluster:
+
[source,terminal]
----
$ rosa install addon -c <mycluster> cluster-logging-operator -y
----

. Accept the defaults (or change them as appropriate):
+
[source,terminal]
----
? Use AWS CloudWatch: Yes
? Collect Applications logs: Yes
? Collect Infrastructure logs: Yes
? Collect Audit logs (optional): No
? CloudWatch region (optional):
I: Add-on 'cluster-logging-operator' is now installing. To check the status run 'rosa list addons -c mycluster'
----