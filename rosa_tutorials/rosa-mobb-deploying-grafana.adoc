:_content-type: ASSEMBLY
[id="rosa-mobb-deploying-grafana"]
= Tutorial: Deploying Grafana on Openshift 4
include::_attributes/attributes-openshift-dedicated.adoc[]
:context: rosa-mobb-deploying-grafana

toc::[]

//
// no metadata from raw file
// Last Editor: Paul Czarkowski
//

OpenShift users might want access to a Grafana interface in order to build custom dashboards for their cluster and application workloads.
The Grafana that shipped with OpenShift was read-only and has been link:https://issues.redhat.com/browse/MON-1591?focusedCommentId=19239654&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-19239654[deprecated in OpenShift 4.11 and removed in OpenShift 4.12].

Since OpenShift uses Prometheus for both Cluster and User Workload metrics, it is fairly straightforward to deploy a Grafana instance using the Grafana Operator, and then view those cluster metrics and create custom Dashboards.

== Deploying the Grafana Operator

. Create a namespace for the Grafana Operator to be installed in:
+
[source,terminal]
----
$ oc new-project grafana-operator
----

. Deploy the Grafana Operator:
+
[source,terminal]
----
$ cat << EOF | oc create -f -
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  generateName: grafana-operator-
  namespace: grafana-operator
spec:
  targetNamespaces:
  - grafana-operator
---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  generateName: grafana-operator-
  namespace: grafana-operator
spec:
  channel: v4
  name: grafana-operator
  installPlanApproval: Automatic
  source: community-operators
  sourceNamespace: openshift-marketplace
EOF
----

. Wait for the Operator to be ready:
+
[source,terminal]
----
$ oc -n grafana-operator rollout status \
  deployment grafana-operator-controller-manager
----

== Deploying Grafana

. Add the Managed OpenShift Black Belt helm repo:
+
[source,terminal]
----
$ helm repo add mobb https://mobb.github.io/helm-charts
----

. Deploy Grafana:
+
[source,terminal]
----
$ helm upgrade --install -n grafana-operator \
  grafana mobb/grafana-cr --set "basicAuthPassword=myPassword"
----

=== Creating a Prometheus DataSource

. Give the Grafana service account the `cluster-monitoring-view` role:
+
[source,terminal]
----
$ oc adm policy add-cluster-role-to-user \
  cluster-monitoring-view -z grafana-serviceaccount
----

. Get a bearer token for the grafana service account:
+
[source,terminal]
----
$ BEARER_TOKEN=$(oc create token grafana-serviceaccount)
----

. Deploy the prometheus data source:
+
[source,terminal]
----
$ cat << EOF | oc apply -f -
apiVersion: integreatly.org/v1alpha1
kind: GrafanaDataSource
metadata:
  name: prometheus-grafanadatasource
spec:
  datasources:
    - access: proxy
      editable: true
      isDefault: true
      jsonData:
        httpHeaderName1: 'Authorization'
        timeInterval: 5s
        tlsSkipVerify: true
      name: Prometheus
      secureJsonData:
        httpHeaderValue1: 'Bearer ${BEARER_TOKEN}'
      type: prometheus
      url: 'https://thanos-querier.openshift-monitoring.svc.cluster.local:9091'
  name: prometheus-grafanadatasource.yaml
EOF
----

. Deploy a Dashboard:
+
[source,terminal]
----
$ oc apply -f https://raw.githubusercontent.com/kevchu3/openshift4-grafana/master/dashboards/crds/cluster_metrics.ocp412.grafanadashboard.yaml
----

. Get the URL for Grafana:
+
[source,terminal]
----
$ oc get route grafana-route -o jsonpath='{"https://"}{.spec.host}{"\n"}'
----

. Browse to the URL from above and log in through your OCP credentials.

. Click *Dashboards* -> *Manage* -> *grafana-operator* -> *Cluster Metrics*.
+
image::grafana-dashboard.png[The Grafana dashboard]