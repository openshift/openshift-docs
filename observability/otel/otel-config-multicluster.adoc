:_mod-docs-content-type: ASSEMBLY
[id="otel-gathering-observability-data-from-multiple-clusters"]
= Gathering the observability data from multiple clusters
include::_attributes/common-attributes.adoc[]
:context: otel-gathering-observability-data-from-multiple-clusters

For a multicluster configuration, you can create one OpenTelemetry Collector instance in each one of the remote clusters and then forward all the telemetry data to one OpenTelemetry Collector instance.

.Prerequisites

* The {OTELOperator} is installed.
* The {TempoOperator} is installed.
* A TempoStack instance is deployed on the cluster.
* The following mounted certificates: Issuer, self-signed certificate, CA issuer, client and server certificates. To create any of these certificates, see step 1.

.Procedure

.Generate Certificates

. Skipping if certificates are already mounted on the clusters, certificates will be generated  using the {cert-manager-operator}. The following steps assume you already have it installed on central cluster.

..An Issuer to generate the certificates by using the {cert-manager-operator}.
+
[source,yaml]
----
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned-issuer
spec:
  selfSigned: {}
----

.. A self-signed certificate.
+
[source,yaml]
----
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: ca
spec:
  isCA: true
  commonName: ca
  subject:
    organizations:
      - <your_organization_name>
    organizationalUnits:
      - Widgets
  secretName: ca-secret
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: selfsigned-issuer
    kind: Issuer
    group: cert-manager.io
----

.. Create a CA issuer.
+
[source,yaml]
----
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: test-ca-issuer
spec:
  ca:
    secretName: ca-secret
----

.. The server certificates user in Central cluster.
+
[source,yaml]
----
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: server
spec:
  secretName: server-tls #<1>
  isCA: false
  usages:
    - server auth
    - client auth
  dnsNames:
  - "central.observability-cluster.com" # <2>
  issuerRef:
    name: ca-issuer
----
<1> Secret will contain certificate
<2> List of exact DNS names to be mapped to a solver in the server OpenTelemetry Collector instance.

.. The client certificates, this certificate will be used in the Edge cluster
+
[source,yaml]
----
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: client
spec:
  secretName: client-tls #<1>
  isCA: false
  usages:
    - server auth
    - client auth
  dnsNames:
  - "edge.observability-cluster.com" # <2>
  issuerRef:
    name: ca-issuer
----
<1> Secret will contain certificate
<2> List of exact DNS names to be mapped to a solver in the client OpenTelemetry Collector instance.


.Central Cluster

. Create the YAML file to define the `OpenTelemetryCollector` custom resource (CR) in the central cluster.
+
.Example `OpenTelemetryCollector` custom resource for the central cluster
[source,yaml]
----
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: otlp-receiver
  namespace: chainsaw-multi-cluster-receive
spec:
  config: |
    receivers:
      otlp:
        protocols:
          http:
            tls: # <1>
              cert_file: /certs/server.crt
              key_file: /certs/server.key
              client_ca_file: /certs/ca.crt
          grpc:
            tls:
              cert_file: /certs/server.crt
              key_file: /certs/server.key
              client_ca_file: /certs/ca.crt
    exporters:
      otlp:
        endpoint: "tempo-<simplest>-distributor:4317" #<2>
        tls:
          insecure: true
    service:
      pipelines:
        traces:
          receivers: [otlp]
          exporters: [otlp]
  ingress:
    route:
      termination: passthrough  #<3>
    type: route
  mode: deployment
  volumeMounts:  
  - mountPath: /certs
    name: otel-certs
  volumes:
    - name: otel-certs #<4>
      secret:
        name: server-tls
----
<1> The Collector receiver requires the certificates listed in the Generate Certificates step.
<2> The Collector exporter is configured to export OTLP and points to the Tempo distributor endpoint, which in this example is `"tempo-simplest-distributor:4317"` and already created.
<3> The ingress type should be configure to route and termination will be passthrough, in order to not terminate TLS and forward certificates to the collector.
<4> The volume with the secrets generated by cert manager following the Generate Certificates section should be mounted

.For Edge cluster
. Create ServiceAccount , ClusterRole and ClusterRoleBinding for the OpenTelemetry collector, this is neeede to use resourceatributesdetector processor.
+
[source,yaml]
----
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-edge-multi-cluster
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-edge-multi-cluster
rules:
- apiGroups:
  - config.openshift.io
  resources:
  - infrastructures
  - infrastructures/status
  verbs:
  - get
  - watch
  - list
- apiGroups:
  - apps
  resources:
  - replicasets
  verbs:
  - get
  - watch
  - list
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - watch
  - list
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - get
  - watch
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-edge-multi-cluster
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otel-edge-multi-cluster
subjects:
- kind: ServiceAccount
  name: otel-edge-multi-cluster
----
+
. Create the YAML file to define the `OpenTelemetryCollector` custom resource (CR) in the edge clusters.
+
.Example `OpenTelemetryCollector` custom resource for the edge clusters
[source,yaml]
----
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: otel
  namespace: otel-collector-<example>
spec:
  mode: daemonset
  serviceAccount: otel-edge-multi-cluster
  config: |
    receivers:
      jaeger:
        protocols:
          grpc: {}
          thrift_binary: {}
          thrift_compact: {}
          thrift_http: {}
      opencensus:
      otlp:
        protocols:
          grpc: {}
          http: {}
      zipkin: {}
    processors:
      batch: {}
      k8sattributes: {}
      memory_limiter:
        check_interval: 1s
        limit_percentage: 50
        spike_limit_percentage: 30
      resourcedetection:
        detectors: [openshift]
    exporters:
      otlphttp:
        endpoint: https://central.observability-cluster.com:443 # <1>
        tls:
          insecure: false
          cert_file: /certs/server.crt
          key_file: /certs/server.key
          ca_file: /certs/ca.crt
    service:
      pipelines:
        traces:
          receivers: [jaeger, opencensus, otlp, zipkin]
          processors: [memory_limiter, k8sattributes, resourcedetection, batch]
          exporters: [otlp]
  volumes:
    - name: otel-certs
      secret:
        name: client-tls
  volumeMounts:  #<2>
    - name: otel-certs
      mountPath: /certs
----
<1> The Collector exporter is configured to export OTLP HTTP and points to the OpenTelemetry Collector from the central cluster.
<2> The volume with the secrets generated by cert manager for the client certificated following the Generate Certificates section should be mounted,
