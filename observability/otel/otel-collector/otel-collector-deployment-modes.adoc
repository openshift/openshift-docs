:_mod-docs-content-type: ASSEMBLY
[id="otel-collector-deployment-modes"]
= Deployment Modes
include::_attributes/common-attributes.adoc[]
:context: otel-collector-deployment-modes

toc::[]

The OpenTelemetry Collector supports the following deployment modes: Deployment (default mode), StatefulSet, DaemonSet, and Sidecar.

The StatefulSet deployment mode is recommended for stateful workloads, for example when using the xref:./otel-collector-extensions.adoc#filestorage-extension_otel-collector-extensions[File Storage Extension] or xref:./otel-collector-processors.adoc#tail-sampling-processor_otel-collector-processors[Tail Sampling Processor].

When scraping telemetry data from every node (e.g. reading container logs with the xref:./otel-collector-receivers.adoc#filelog-receiver_otel-collector-receivers[Filelog Receiver]), the DaemonSet deployment mode is recommended.

Injecting the collector as a sidecar allows accessing logfiles from inside a container, using a shared volume (for example an `emptyDir` volume) and the xref:./otel-collector-receivers.adoc#filelog-receiver_otel-collector-receivers[Filelog Receiver].
Another use case for the sidecar mode is to configure the application to send telemetry data to the sidecar over localhost (the sidecar runs in the same pod as the application), and the collector forwards the telemetry data to an external service via an encrypted and authenticated connection.

== Configuring the Deployment Mode

Deployment, DaemonSet and StatefulSet deploy the collector using the respective Kubernetes workload resource.
The sidecar mode deploys the collector as a sidecar container to an existing pod.

.OpenTelemetry Collector with DaemonSet deployment mode
[source,yaml]
----
apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: otel
spec:
  mode: daemonset <1>
----
<1> The deployment mode. Supported values: `deployment` (default), `daemonset`, `statefulset` and `sidecar`

== Sidecar Injection

The collector can be injected into existing pod-based workloads by configuring the pod annotation `sidecar.opentelemetry.io/inject`.
Example:

.OpenTelemetry Collector with sidecar deployment mode
[source,yaml]
----
apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: my-otel-sidecar
spec:
  mode: sidecar <1>
----
<1> Configure sidecar deployment mode.

.Annotate an existing pod to inject the collector sidecar
[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: my-app
  annotations:
    sidecar.opentelemetry.io/inject: "true" <1>
spec:
  containers:
  - ...
----
<1> Enable sidecar injection. Supported values: `true`, `false`, `otelcol-instance-name`, `namespace/otelcol-instance-name`

The `sidecar.opentelemetry.io/inject` annotation supports the following values:

*true*:: Inject the collector with the configuration of the OpenTelemetryCollector resource in the same namespace
*my-otel-sidecar*:: Inject the collector with the configuration of the `my-otel-sidecar` OpenTelemetryCollector resource in the same namespace.
*my-namespace/my-otel-sidecar*:: Inject the collector with the configuration of the `my-otel-sidecar` OpenTelemetryCollector resource in the `my-namespace` namespace.
*false*:: Do not inject the collector (default if the annotation is missing)

Additionally, the `sidecar.opentelemetry.io/inject` annotation can be set on the namespace.
If the annotation is set on both the namespace and the pod, the pod annotation takes precedence if it is set to an OpenTelemetryCollector instance name or to `false`.
