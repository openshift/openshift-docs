[[registry-quickstart-administrators-system-configuration]]
= Getting Started with System Configuration for Administrators
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Explore the Environment

{product-title} deploys as a Kubernetes-based cluster. The **origin** container
is the primary service that deploys the docker registry and registry console
services.

We can explore these services by entering the base **origin** container and
running some commands.

====
----
$ sudo docker exec -it origin bash
# oc whoami
system:admin
# oc projects
Using project "default" on server "https://172.16.98.26:8443".
# oc get services
NAME               CLUSTER-IP       EXTERNAL-IP   PORT(S)                 AGE
docker-registry    172.30.83.71     nodes         5000/TCP                25m
kubernetes         172.30.0.1       <none>        443/TCP,53/UDP,53/TCP   25m
registry-console   172.30.244.124   nodes         9000/TCP                25m
# oc get pods
NAME                       READY     STATUS    RESTARTS   AGE
docker-registry-1-rm3fc    1/1       Running   0          5m
registry-console-2-5utej   1/1       Running   0          5m
----
====

We can get logs from any pod.

====
----
# oc logs registry-console-2-5utej
INFO: cockpit-ws: Using certificate: /etc/cockpit/ws-certs.d/0-self-signed.cert
----
====


== Global Configuration Settings

The xref:index.adoc#service-components[three services] may be restarted
independently.

=== Configuration File

{product-title} global system settings are defined in a configuration file
mounted on the host at **/etc/origin/master/master-config.yaml**. Whenever this
file is updated changes are read when restarting the **origin** container.

----
$ sudo docker restart origin
----

Global configuration items managed by this configuration file include:

* xref:../../install_config/configuring_authentication.adoc#install-config-configuring-authentication[Configure authentication]
  by integrating with an identity provider
* Manage xref:../../admin_guide/managing_projects.adoc#admin-guide-managing-projects[project namespace self-provisioning]

Master log level is determined using the service unit configuration file mounted
on the host at *_/etc/sysconfig/atomic-registry-master_*.

=== Registry Console Configuration

The registry console is a stateless service that has limited configuration using
environment variables defined in a file mounted on the host at
*_/etc/sysconfig/atomic-registry-console_*.

Configuration changes require a service restart.

----
$ sudo systemctl restart atomic-registry-console.service
----

=== Registry Configuration

The docker distribution registry configuration is managed by a file mounted on
the host at *_/etc/atomic-registry/registry/config.yml_*. See
xref:registry-configuration-reference-sysconfig[registry configuration reference] for complete settings.

=== CLI Configuration

Some system administration topics are configured using the CLI. See
link:cli.html[CLI getting started] for more details.

=== API Certificates

[[registry-configuration-reference-sysconfig]]

include::install_config/install/docker_registry.adoc[tags=registry-configuration-reference]

== Registry Service Configuration Settings

The Docker registry service has its own configuration file. This file is where
storage drivers are configured. Storage drivers provide administrators to
connect the registry to object storage.

By default this file is within the registry pod container. See
link:../../install_config/install/docker_registry.html[Registry Storage Configuration]
for more details.

The installer generates self-signed certificates during installation. See
xref:../../install_config/certificate_customization.adoc#install-config-certificate-customization[certificate customization]
for customizing the API master certificates.

=== Registry

Here we create a self-signed certificate so docker clients can connect using
TLS. While other tools like openssl may be used to create certificates, the
master API provides a tool that may also be used.

. Exec into the atomic-registry-master container to access the CLI and change directory
+
----
$ sudo docker exec -it atomic-registry-master bash
$ cd /etc/atomic-registry/master
----
+
. Use the administrator CLI to generate self-signed certificates and exit the
container.
+
====
Be careful when re-deploying the registry. The quickstart method maps the registry
service to host ports. This mapping must be updated when the registry is
re-deployed.

----
$ oc patch service docker-registry -p \
     '{ "spec": { "type": "NodePort", "selector": {"docker-registry": "default"},
        "ports": [ {"nodePort": 5000, "port": 5000, "targetPort": 5000}] }}'
----
====

You may also want to learn how to
link:../../install_config/install/docker_registry.html#securing-the-registry[secure the registry]
for TLS.

====
----
$ curl --insecure -O https://<registry_hostname>:8443/console/extensions/certs/ca.crt
$ sudo cp ca.crt /etc/docker/certs.d/<registry_hostname>:5000/.
$ sudo systemctl restart docker.service
----
====

== Other Configuration Topics

=== Changing the Session Token length

By default the session token used for `docker login` is 24 hours. This
requires users to run `docker login` every day. This value may be extended in
the master configuration file *_/etc/atomic-registry/master/master-config.yaml_*.
See xref:using-service-account-tokens-for-authentication[below] for using
long-lived service account tokens.

By default the session token used for **docker login** is 24 hours. This value
may be extended in the master configuration file **/etc/origin/master/master-config.yaml**.
In this example the session token expiration is extended to 30 days.

====
----
tokenConfig:
  accessTokenMaxAgeSeconds: 2592000
----
====

Restart the origin service to update the running configuration.

----
$ sudo docker restart origin
----

[[using-service-account-tokens-for-authentication]]
=== Using Service Account Tokens for Authentication

Typically long-lived, token-based authentication is desired. As an alternative
to using user session tokens that expire, users may use
xref:../../admin_guide/service_accounts.adoc#admin-guide-service-accounts[service account tokens] to
authenticate with docker. This is particularly useful when integrating automation.
See the
xref:../developers.adoc#using-service-account-tokens-for-docker-login[quickstart developer guide]
for instructions.

== Data Persistence and Backup

The data that should be persisted is the configuration, image data and the
master database. The required directories are mounted from the container onto
the host. See xref:index.adoc#service-components[Service Components table] for
specific paths.

These templates are created in the **default** project. The shared project
template is **default/registry-newproject-template-shared**. The non-shared
project template is **default/registry-newproject-template-unshared**.

To change sharing behavior update the configuration file to point to the
appropriate new project template.

. Edit **/etc/origin/master/master-config.yaml**
. Change value for **projectRequestTemplate**
+
====
----
...
projectConfig:
  projectRequestTemplate: "default/registry-newproject-template-unshared"
  ...
----
====

See xref:../../cli_reference/index.adoc#cli-reference-index[CLI reference] for how to download the
remote CLI client and using the CLI.
