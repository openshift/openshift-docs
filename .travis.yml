language: python
cache: pip
env:
- PR_AUTHOR=${TRAVIS_PULL_REQUEST_SLUG::-15}
jobs:
  include:
  - stage: build
    before_install:
    - gem install asciidoctor asciidoctor-diagram
    install:
    - pip3 install pyyaml aura.tar.gz
    script:
    - python3 build.py --distro openshift-enterprise --product "OpenShift Container Platform" --version 4.10 --no-upstream-fetch && python3 makeBuild.py
  - if: branch IN (main, enterprise-4.9, enterprise-4.10)
    before_install:
    - gem install asciidoctor asciidoctor-diagram
    install:
    - pip3 install pyyaml aura.tar.gz
    script:
    - python3 build.py --distro openshift-dedicated --product "OpenShift Dedicated" --version 4 --no-upstream-fetch && python3 makeBuild.py
  - if: branch IN (main, enterprise-4.9, enterprise-4.10)
    before_install:
    - gem install asciidoctor asciidoctor-diagram
    install:
    - pip3 install pyyaml aura.tar.gz
    script:
    - python3 build.py --distro openshift-rosa --product "Red Hat OpenShift Service on AWS" --version 4 --no-upstream-fetch && python3 makeBuild.py
  - stage: automerge
    if: env(PR_AUTHOR)=openshift-cherrypick-robot
    script: bash ./automerge.sh
stages:
- build
- automerge
notifications:
  slack:
    if: branch IN (main, enterprise-4.9, enterprise-4.10) AND type=push
    template:
      - "Build %{result} for PR <%{pull_request_url}|#%{pull_request_number}>"
      - "%{message}"
      - "Branch: %{branch}"
      - "Author: %{author}"
    rooms:
      secure: n88qC8e3CyVy0d4UFvpX9t8HWv5ViyL1MyO76LyBGPN1wraYQgxztwZ1A8oLs+a/29Iqe7ImLY1Y225u8n4VoSttwdraYeliOS7LPDPqHttaFjrLDaKS7wcGjk8unoo7JxWpuK54uCvT10wE2x3KUhlYrphG7kKBnNPBpF2XizI=
    on_success: change
    on_failure: always
