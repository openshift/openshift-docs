language: minimal
cache:
  pip: true
services:
  - docker
git:
  depth: 10
jobs:
  include:
    name: Preview, validate, and build
    before_install:
      - chmod +x ./scripts/configure-docker.sh
      - ./scripts/configure-docker.sh
      - docker pull quay.io/ganelson/asciidoctor:latest
      - docker images
    script:
      - docker run -v $(pwd):/openshift-docs quay.io/ganelson/asciidoctor /bin/sh -c 'cd /openshift-docs; chmod +x ./scripts/check-asciidoctor-build.sh; ./scripts/check-asciidoctor-build.sh' || travis_terminate 1
      - |
          ./scripts/get-updated-distros.sh |
            while read -r filename; do
              if [ "$filename" == "_topic_maps/_topic_map.yml" ]; then python3 build.py --distro openshift-enterprise --product "OpenShift Container Platform" --version 4.14 --no-upstream-fetch
              elif [ "$filename" == "_topic_maps/_topic_map_osd.yml" ]; then python3 build.py --distro openshift-dedicated --product "OpenShift Dedicated" --version 4 --no-upstream-fetch
              elif [ "$filename" == "_topic_maps/_topic_map_ms.yml" ]; then python3 build.py --distro microshift --product "Microshift" --version 4 --no-upstream-fetch
              elif [ "$filename" == "_topic_maps/_topic_map_rosa.yml" ]; then python3 build.py --distro openshift-rosa --product "Red Hat OpenShift Service on AWS" --version 4 --no-upstream-fetch
              elif [ "$filename" == "_distro_map.yml" ]; then python3 build.py --distro openshift-enterprise --product "OpenShift Container Platform" --version 4.14 --no-upstream-fetch
              fi
            done
          if [ -d "drupal-build" ]; then python3 makeBuild.py; fi
