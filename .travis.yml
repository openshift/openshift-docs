# Travis configuration file. See https://docs.travis-ci.com

# Using base image optimized to be faster and use less disk space. See https://docs.travis-ci.com/user/languages/minimal-and-generic/
language: minimal

env:
  global:
    - NETLIFY_AUTH=$NETLIFY_AUTH_TOKEN
    - NETLIFY_SITE=$NETLIFY_SITE_ID
#   - PR_AUTHOR=${TRAVIS_PULL_REQUEST_SLUG::-15}

# Using Docker in builds. See https://docs.travis-ci.com/user/docker/
services:
  - docker

jobs:
  include:
    # Optimizing build time by running all steps in one single spage
    - stage: asciibinder
      if: branch IN (main, enterprise-4.10, enterprise-4.11)
      before_install:
        # Using container image from source: https://github.com/openshift-cs/docs-builder
        - docker pull quay.io/openshift-cs/asciibinder:latest
        # Using container image from source: https://github.com/williamjacksn/docker-netlify-cli
        - docker pull ghcr.io/williamjacksn/netlify-cli:latest
      script:
        # Creating a branch to avoiding to build "(head detached at fetch_head)".
        - git checkout -b latest
        # Building only required distros, only current branch.
        - docker run --rm -it -u `id -u` -v `pwd`:/docs:Z quay.io/openshift-cs/asciibinder asciibinder build --distro "openshift-enterprise" --all-branches
        - docker run --rm -it -u `id -u` -v `pwd`:/docs:Z quay.io/openshift-cs/asciibinder asciibinder build --distro "openshift-dedicated" --all-branches
        - docker run --rm -it -u `id -u` -v `pwd`:/docs:Z quay.io/openshift-cs/asciibinder asciibinder build --distro "openshift-rosa" --all-branches
        - docker run --rm -it -u `id -u` -v `pwd`:/docs:Z quay.io/openshift-cs/asciibinder asciibinder build --distro "openshift-acs" --all-branches
        # Listing generated files
        - ls -R1 _preview
        # Handling preview index page
        - BRANCH=`git branch --show-current`
        - sed -e "s/latest/$BRANCH/g" scripts/ocpdocs/_previewpage  > _preview/index.html
        - cp -v scripts/ocpdocs/robots_preview.txt _preview/robots.txt
        # Publishing preview in Netlify here as pull request builds skip the deployment step: https://docs.travis-ci.com/user/deployment-v2
        - docker run --rm -it -e NETLIFY_AUTH_TOKEN=$NETLIFY_AUTH -e NETLIFY_SITE_ID=$NETLIFY_SITE -v `pwd`:/project:Z ghcr.io/williamjacksn/netlify-cli deploy --dir _preview/ | tee netlify.log
    # Commenting out to disable auto-merging of PRs
    # - stage: automerge
    #   if: env(PR_AUTHOR)=openshift-cherrypick-robot
    #   script: bash ./automerge.sh

stages:
  - asciibinder
  # - automerge
# Deploy is skipped in pull requests builds
# Commented out as we must build all branches and modify the index for a meaningfull deploy
# Prerequisites: provide environment variables in Travis configuration: NETLIFY_AUTH and NETLIFY_SITE
# deploy:
#   edge: true        # Use https://docs.travis-ci.com/user/deployment-v2
#   cleanup: false    # Don't delete the files we just built
#   provider: netlify # See https://docs.travis-ci.com/user/deployment-v2/providers/netlify/
#   dir: "_preview/"  # Directory to deploy
#   prod: true        # Deploy to production
