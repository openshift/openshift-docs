language: python
cache:
  pip: true

git:
  depth: 10
jobs:
  include:
    - name: "Preview, validate, and build"
      before_install:
        - chmod +x autopreview.sh
        - ./autopreview.sh
      install:
        - gem install --local _gemfiles/asciidoctor-2.0.20.gem _gemfiles/asciidoctor-diagram-plantuml-1.2023.10.gem _gemfiles/asciidoctor-diagram-ditaamini-1.0.3.gem _gemfiles/rexml-3.2.6.gem _gemfiles/asciidoctor-diagram-2.2.14.gem _gemfiles/rouge-4.1.3.gem
        - pip3 install pyyaml aura.tar.gz
      script:
        # Fail if Asciidoctor encounters errors. Pass otherwise. Then, build updated distros
        - chmod +x ./scripts/check-asciidoctor-build.sh
        - chmod +x ./scripts/get-updated-distros.sh
        - ./scripts/check-asciidoctor-build.sh || travis_terminate 1
        - |
          ./scripts/get-updated-distros.sh |
            while read -r filename; do
              case "$filename" in
                "_topic_map.yml")
                  distro="openshift-acs"
                  product="Red Hat Advanced Cluster Security for Kubernetes"
                  version="4.3"
                  ;;
                "_distro_map.yml")
                  distro="openshift-acs"
                  product="Red Hat Advanced Cluster Security for Kubernetes"
                  version="4.3"
                  ;;
                *)
                  echo "Output from get-updated-distros.sh: $filename"
                  echo -e "\033[1;33m No topic maps or distro_map modified!\033[0m"
                  ;;
              esac
              python3 build.py --distro "$distro" --product "$product" --version "$version" --no-upstream-fetch
              if [ $? -ne 0 ]; then travis_terminate 1; fi
            done
        - if [ -d "drupal-build" ]; then python3 makeBuild.py || travis_terminate 1; fi
