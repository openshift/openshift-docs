[[metrics-guidelines]]
= OpenShift Container Platform (OCP) Metrics Guidlines
{product-author}
{product-version}
:data-uri:
:icons: font
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Overview

OpenShift Container Platform Metrics enable OCP users and administrators to monitor
pods in OCP installation and quickly get information about specific pod resource utilization
and based on that decide is it necessary to give additional resources to specific application pods in order to
assist with capacity planning and performance analysis efforts.

== Metrics Guidelines
This document gives guidlines for OCP metrics deployment. For specific OCP metrics configuration
aspets refer to OCP documentation ( Link to OCP v3.4 Administation guide )

=== OpenShift Container Platform Metrics Node Capacity Planning

Running OCP metrics nodes is recommended on separate OCP nodes than application ones.
For best performance, either ensure OCP metrics pods run on `infra` nodes, or OCP metrics pods ran on
dedicated OCP nodes
In our tests, metrics pods were collocated with other  `infra` pods and OCP node capacity was 8 CPUs / 32 GB of memory
This recommendation is based on experiences gathered during testing of OpenShift Container Platform metrics installation

=== Storage recommendations for OpenShift Metrics Deployment

It is necessary prior to metrics deployment to plan storage space for Cassandra
pod within OpenShift Container Platform metrics. All metric data is written to the Cassandra database and it will grow over time.
The growth rate and size of the database is directly proportional to number of pods and nodes in OCP
cluster monitored by OCP Metrics

It is strongly recommended to run OCP metrics with persistent storage enabled with
```
USE_PERSISTANT_STORAGE=true
```
Running OCP metrics with `USE_PERSISTANT_STORAGE=true` will ensure data persistance
across metrics pods lifetime. In case OCP metrics is started with `USE_PERSISTANT_STORAGE=false`
metrics data will be lost when metrics pods are deleted.


In tests performed with with 210 and 990 OCP nodes where 10500 pods and 11000 pods were
 monitored respectively,it was noticed that cassandra database will grow aproximatelly
 at speed rate as showed in Table 1. below

.Cassandra Database storage requirements depending on number of nodes / pods in cluster
[options="header,footer"]
|====================================================================================
|Number of Nodes| Number of Pods | Cassandra Storage grow speed |  Cassandra storage grow / day | Cassandra storage size / week
| 210           | 10500          | 500MB / hour   |   15 GB                       |   75 GB
| 990           | 11000          | 1 GB / hour    |   30 GB                       |   210 GB
|====================================================================================

In above calculation approximately 20% of expected size was addedd as overhead and buffer to ensure that
storage requirements will not exceed calculated value.

If preserved default for `METRICS_DURATION=7(days)` and `METRICS_RESOLUTION=15(seconds)` it is
safe to plan Cassandra storage size requrements for week per above table.

OpenShift Container Platform metrics uses Cassandra database as datastore for metrics data and if used  `USE_PERSISTANT_STORAGE=true` as part of OCP metrics setup then if `PV` is on top of
network storage like NFS it will be used.
However this is not best practice and it is recomended not to use NFS storage as
base for Persistent Volume used by OCP Metrics. Using network storage in combination with cassandra is
marked as architecture antipattern per Cassandra documentation
http://docs.datastax.com/en/archived/cassandra/1.2/cassandra/architecture/architecturePlanningAntiPatterns_c.html[Cassandra documentation]
and not recommended to be used as storage for Cassandara database.

== Known issues and limitations
In tests when scaling number of pods above 12000 in OCP cluster, it is noticed that
data in metrics graphs are not visible, working closer with Red Hat Engineering, the issue was
isolated and it was discovered as related to `heapster` metrics component where it is not able to handle load
related to mentioned pods numbers in OCP cluster.

This issue is tracked in https://bugzilla.redhat.com/show_bug.cgi?id=1388815[Red Hat Bugzilla] and it is
expected to have solution for this problem in future OCP releases
