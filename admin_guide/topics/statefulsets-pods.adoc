////
Pods in a StatefulSet

Module included in the following assemblies:

* admin_guide/statefulsets.adoc
////

[id='pods-stateful-sets_{context}']
= Pods in a StatefulSet

Each pod in a StatefulSet has a unique identity based on a unique ordinal index assigned to each pod by the StatefulSet controller. 

The pod name take the form <statefulset name>-<ordinal index>. For example, `web-0` and `web-1`.

Each Pod has a stable hostname based on its ordinal index. Use oc exec to execute the hostname command in each Pod.

[source,bash]
----
for i in 0 1; do kubectl exec web-$i -- sh -c 'hostname'; done
web-0
web-1
----

Use oc run to execute a container that provides the nslookup command from the dnsutils package. Using nslookup on the Pods’ hostnames, you can examine their in-cluster DNS addresses.

[source,bash]
----
oc run -i --tty --image busybox dns-test --restart=Never --rm /bin/sh 
nslookup web-0.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-0.nginx
Address 1: 10.244.1.6

nslookup web-1.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-1.nginx
Address 1: 10.244.2.6
----

The CNAME of the headless service points to SRV records (one for each Pod that is Running and Ready). The SRV records point to A record entries that contain the Pods’ IP addresses.

In one terminal, watch the StatefulSet’s Pods.

[source,bash]
----
oc get pod -w -l app=nginx
----

In a second terminal, use oc delete to delete all the Pods in the StatefulSet.

[source,bash]
----
oc delete pod -l app=nginx
pod "web-0" deleted
pod "web-1" deleted
----

Wait for the StatefulSet to restart them, and for both Pods to transition to Running and Ready.

[source,bash]
----
oc get pod -w -l app=nginx
NAME      READY     STATUS              RESTARTS   AGE
web-0     0/1       ContainerCreating   0          0s
NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          2s
web-1     0/1       Pending   0         0s
web-1     0/1       Pending   0         0s
web-1     0/1       ContainerCreating   0         0s
web-1     1/1       Running   0         34s
----

Use oc exec and oc run to view the Pods hostnames and in-cluster DNS entries.

[source,bash]
----
for i in 0 1; do kubectl exec web-$i -- sh -c 'hostname'; done
web-0
web-1

oc run -i --tty --image busybox dns-test --restart=Never --rm /bin/sh 
nslookup web-0.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-0.nginx
Address 1: 10.244.1.7

nslookup web-1.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-1.nginx
Address 1: 10.244.2.8
----

The Pods’ ordinals, hostnames, SRV records, and A record names have not changed, but the IP addresses associated with the Pods may have changed. In the cluster used for this tutorial, they have. This is why it is important not to configure other applications to connect to Pods in a StatefulSet by IP address.

If you need to find and connect to the active members of a StatefulSet, you should query the CNAME of the Headless Service (nginx.default.svc.cluster.local). The SRV records associated with the CNAME will contain only the Pods in the StatefulSet that are Running and Ready.

If your application already implements connection logic that tests for liveness and readiness, you can use the SRV records of the Pods ( web-0.nginx.default.svc.cluster.local, web-1.nginx.default.svc.cluster.local), as they are stable, and your application will be able to discover the Pods’ addresses when they transition to Running and Ready.
Writing to Stable Storage

Get the PersistentVolumeClaims for web-0 and web-1.

[source,bash]
----
oc get pvc -l app=nginx
NAME        STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE
www-web-0   Bound     pvc-15c268c7-b507-11e6-932f-42010a800002   1Gi        RWO           48s
www-web-1   Bound     pvc-15c79307-b507-11e6-932f-42010a800002   1Gi        RWO           48s
----

The StatefulSet controller created two PersistentVolumeClaims that are bound to two PersistentVolumes. As the cluster used in this tutorial is configured to dynamically provision PersistentVolumes, the PersistentVolumes were created and bound automatically.

The NGINX webservers, by default, will serve an index file at /usr/share/nginx/html/index.html. The volumeMounts field in the StatefulSets spec ensures that the /usr/share/nginx/html directory is backed by a PersistentVolume.

Write the Pods’ hostnames to their index.html files and verify that the NGINX webservers serve the hostnames.

[source,bash]
----
for i in 0 1; do kubectl exec web-$i -- sh -c 'echo $(hostname) > /usr/share/nginx/html/index.html'; done

for i in 0 1; do kubectl exec -it web-$i -- curl localhost; done
web-0
web-1
----

[NOTE]
====
If you instead see 403 Forbidden responses for the above curl command, you will need to fix the permissions of the directory mounted by the volumeMounts (due to a bug when using hostPath volumes) with:

[source,bash]
----
for i in 0 1; do kubectl exec web-$i -- chmod 755 /usr/share/nginx/html; done
----
    
before retrying the curl command above.
====

In one terminal, watch the StatefulSet’s Pods.

[source,bash]
----
oc get pod -w -l app=nginx
----

In a second terminal, delete all of the StatefulSet’s Pods.

[source,bash]
----
oc delete pod -l app=nginx
pod "web-0" deleted
pod "web-1" deleted
----

Examine the output of the oc get command in the first terminal, and wait for all of the Pods to transition to Running and Ready.

[source,bash]
----
oc get pod -w -l app=nginx
NAME      READY     STATUS              RESTARTS   AGE
web-0     0/1       ContainerCreating   0          0s
NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          2s
web-1     0/1       Pending   0         0s
web-1     0/1       Pending   0         0s
web-1     0/1       ContainerCreating   0         0s
web-1     1/1       Running   0         34s
----

Verify the web servers continue to serve their hostnames.

[source,bash]
----
for i in 0 1; do kubectl exec -it web-$i -- curl localhost; done
web-0
web-1
----

Even though web-0 and web-1 were rescheduled, they continue to serve their hostnames because the PersistentVolumes associated with their PersistentVolumeClaims are remounted to their volumeMounts. No matter what node web-0and web-1 are scheduled on, their PersistentVolumes will be mounted to the appropriate mount points.
