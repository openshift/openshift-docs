// Module included in the following assemblies:
//
// * admin_guide/cluster-autoscaler.adoc

[id='installing-new-AWS-cluster-auto-scaler_{context}']
= Installing a cluster on AWS with the auto-scaler or adding an auto-scaler to a cluster by using an Ansible playbook

If you can set up a new cluster, you can run Ansible playbooks that automate
both the installation of {product-title} and the deployment of the cluster to 
Amazon Web Services (AWS), the auto-scaler, and all the required Auto Scaling 
groups (ASGs) and launch configurations (LCs).

If you run the Ansible playbooks, you must specify more variables in the
inventory file and pass extra variables when you run the playbooks.

If you used the AWS to install a cluster to the cloud, you can follow this
process again to add the auto-scaler to your cluster. Ensure that you change
the value of the `openshift_cluster_autoscaler_install` parameter in your 
Ansible inventory file to *true*.

.Procedure

. Ensure that the following sections are in your Ansible inventory file, which
is located at *_/etc/ansible/hosts_* by default:
+
----
[OSEv3:children]
masters
nodes
etcd

[OSEv3:vars]
openshift_deployment_type=openshift-enterprise
ansible_ssh_user=root
openshift_clusterid=mycluster

[masters]
[etcd]
[nodes]
----

. Add the following parameters to your Ansible inventory file:
+
[source,yaml]
----
openshift_cloudprovider_kind: aws
openshift_cloudprovider_aws_access_key: "{{ lookup('env','AWS_ACCESS_KEY_ID') }}"
openshift_cloudprovider_aws_secret_key: "{{ lookup('env','AWS_SECRET_ACCESS_KEY') }}"

openshift_aws_ami: ami-12345678	<1>
openshift_release: "3.11"

openshift_aws_clusterid: "{{ openshift_clusterid }}" <2>

openshift_aws_create_iam_cert: True
openshift_aws_create_iam_role: True

openshift_aws_create_s3: False

openshift_aws_iam_cert_path: /path/to/wildcard.<clusterid>.example.com.crt <3>
openshift_aws_iam_cert_key_path: /path/to/wildcard.<clusterid>.example.com.key <3>
openshift_aws_iam_cert_chain_path: /path/to/cert.ca.crt <3>

openshift_aws_master_group_max_size: 1 <4>
openshift_aws_master_group_min_size: 1
openshift_aws_master_group_desired_size: 1

openshift_aws_infra_group_max_size: 1 <5>
openshift_aws_infra_group_min_size: 1
openshift_aws_infra_group_desired_size: 1

openshift_aws_compute_group_max_size: 10 <6>
openshift_aws_compute_group_min_size: 1
openshift_aws_compute_group_desired_size: 1

openshift_aws_instance_type: m4.large <7>

openshift_aws_region: us-east-1 <8>
openshift_aws_ssh_key_name: keyname <9>

openshift_cluster_autoscaler_install: True <10>
openshift_deployment_type: openshift-enterprise <11>

openshift_cluster_autoscaler_node_groups:
- name: "{{ openshift_aws_clusterid ~ ' compute group 1' }}" <12>
  min: "{{ openshift_aws_compute_group_min_size }}"
  max: "{{ openshift_aws_compute_group_max_size }}"

openshift_master_bootstrap_auto_approve: True <13>

openshift_aws_autoname_scale_group_instances: True <14>
----
<1> Provide the AMI of a {product-title} primed image. If we use a "golden image"
here, too, then we need to figure out how a user would get one.
<2> What is this?
<3> Where should a user store these files?
<4> You need one master node.
<5> You need one infrastructure node.
<6> Set to the maximum number of nodes to provision.
<7> Specify a valid AWS instance size.
<8> Specify a valid AWS region to deploy the cluster to.
<9> Where is this key?
<10> Is this a Boolean, and is there any valid use case for setting it to *False*?
<11> What values are available for this parameter?
<12> What is this?
<13> New nodes created by the ASG will be automatically approved. When would a
user want to set this value to *False*?
<14> Tag new nodes with a name. When would a user want to set this value to *False*?

. Run the prerequisites playbook to create the AWS objects that the cluster
needs, such as VPCs, security groups, and subnets: 
+
----
# ansible-playbook -i <inventory_file> \
ifdef::openshift-enterprise[]
    /usr/openshift-ansible/playbooks/aws/openshift-cluster/prerequisites.yml
endif::[]
ifdef::openshift-origin[]
    ~/openshift-ansible/playbooks/aws/openshift-cluster/prerequisites.yml
endif::[]
    -e @vars.yaml
----

. Run the *_provision_install.yml_* playbook to create the master, infrastructure,
and compute nodes; create the required ASG and LC; and deploy a {product-title}
cluster on the nodes:
+
----
# ansible-playbook -i <inventory_file> \
ifdef::openshift-enterprise[]
    /usr/openshift-ansible/playbooks/aws/openshift-cluster/provision_install.yml \
endif::[]
ifdef::openshift-origin[]
    ~/openshift-ansible/playbooks/aws/openshift-cluster/provision_install.yml \
endif::[]
    -e @vars.yaml
----

. After the playbook runs, confirm that the master, compute, and infrastructure
nodes exist:
+
[source,bash]
----
$ oc get nodes
NAME                            STATUS    ROLES     AGE       VERSION
ip-infra.ec2.internal           Ready     infra     1h        v1.11.0+d4cacc0
ip-compute.ec2.internal         Ready     compute   8h        v1.11.0+d4cacc0
ip-master.internal              Ready     master    1h        v1.11.0+d4cacc0
----

. After the playbook runs, confirm that the `cluster-autoscaler` deployment is
running:
+
[source,bash]
----
$ oc get deployment -n openshift-autoscaler
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
cluster-autoscaler   1         1         1            1           1d
----
