////
Deleting statefulsets

Module included in the following assemblies:

* admin_guide/statefulsets.adoc
////

[id='deleting-statefulsets_{context}']
= Deleting StatefulSets

StatefulSet supports both Non-Cascading and Cascading deletion. In a Non-Cascading Delete, the StatefulSet’s Pods are not deleted when the StatefulSet is deleted. In a Cascading Delete, both the StatefulSet and its Pods are deleted.
Non-Cascading Delete

In one terminal window, watch the Pods in the StatefulSet.

[source,bash]
----
oc get pods -w -l app=nginx
----

Use oc delete to delete the StatefulSet. Make sure to supply the --cascade=false parameter to the command. This parameter tells Kubernetes to only delete the StatefulSet, and to not delete any of its Pods.

[source,bash]
----
oc delete statefulset web --cascade=false
statefulset "web" deleted
----

Get the Pods to examine their status.

[source,bash]
----
oc get pods -l app=nginx
NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          6m
web-1     1/1       Running   0          7m
web-2     1/1       Running   0          5m
----

Even though web has been deleted, all of the Pods are still Running and Ready. Delete web-0.

[source,bash]
----
oc delete pod web-0
pod "web-0" deleted
----

Get the StatefulSet’s Pods.

[source,bash]
----
oc get pods -l app=nginx
NAME      READY     STATUS    RESTARTS   AGE
web-1     1/1       Running   0          10m
web-2     1/1       Running   0          7m
----

As the web StatefulSet has been deleted, web-0 has not been relaunched.

In one terminal, watch the StatefulSet’s Pods.

[source,bash]
----
oc get pods -w -l app=nginx
----

In a second terminal, recreate the StatefulSet. Note that, unless you deleted the nginx Service ( which you should not have ), you will see an error indicating that the Service already exists.

[source,bash]
----
oc create -f web.yaml 
statefulset "web" created
Error from server (AlreadyExists): error when creating "web.yaml": services "nginx" already exists
----

Ignore the error. It only indicates that an attempt was made to create the nginx Headless Service even though that Service already exists.

Examine the output of the oc get command running in the first terminal.

[source,bash]
----
oc get pods -w -l app=nginx
NAME      READY     STATUS    RESTARTS   AGE
web-1     1/1       Running   0          16m
web-2     1/1       Running   0          2m
NAME      READY     STATUS    RESTARTS   AGE
web-0     0/1       Pending   0          0s
web-0     0/1       Pending   0         0s
web-0     0/1       ContainerCreating   0         0s
web-0     1/1       Running   0         18s
web-2     1/1       Terminating   0         3m
web-2     0/1       Terminating   0         3m
web-2     0/1       Terminating   0         3m
web-2     0/1       Terminating   0         3m
----

When the web StatefulSet was recreated, it first relaunched web-0. Since web-1 was already Running and Ready, when web-0 transitioned to Running and Ready, it simply adopted this Pod. Since you recreated the StatefulSet with replicas equal to 2, once web-0 had been recreated, and once web-1 had been determined to already be Running and Ready, web-2 was terminated.

Let’s take another look at the contents of the index.html file served by the Pods’ webservers.

[source,bash]
----
for i in 0 1; do kubectl exec -it web-$i -- curl localhost; done
web-0
web-1
----

Even though you deleted both the StatefulSet and the web-0 Pod, it still serves the hostname originally entered into its index.html file. This is because the StatefulSet never deletes the PersistentVolumes associated with a Pod. When you recreated the StatefulSet and it relaunched web-0, its original PersistentVolume was remounted.

Cascading Delete

In one terminal window, watch the Pods in the StatefulSet.

[source,bash]
----
oc get pods -w -l app=nginx
----

In another terminal, delete the StatefulSet again. This time, omit the --cascade=false parameter.

[source,bash]
----
oc delete statefulset web
statefulset "web" deleted
----

Examine the output of the oc get command running in the first terminal, and wait for all of the Pods to transition to Terminating.

[source,bash]
----
oc get pods -w -l app=nginx
NAME      READY     STATUS    RESTARTS   AGE
web-0     1/1       Running   0          11m
web-1     1/1       Running   0          27m
NAME      READY     STATUS        RESTARTS   AGE
web-0     1/1       Terminating   0          12m
web-1     1/1       Terminating   0         29m
web-0     0/1       Terminating   0         12m
web-0     0/1       Terminating   0         12m
web-0     0/1       Terminating   0         12m
web-1     0/1       Terminating   0         29m
web-1     0/1       Terminating   0         29m
web-1     0/1       Terminating   0         29m
----

As you saw in the Scaling Down section, the Pods are terminated one at a time, with respect to the reverse order of their ordinal indices. Before terminating a Pod, the StatefulSet controller waits for the Pod’s successor to be completely terminated.

Note that, while a cascading delete will delete the StatefulSet and its Pods, it will not delete the Headless Service associated with the StatefulSet. You must delete the nginx Service manually.

[source,bash]
----
oc delete service nginx
service "nginx" deleted
----

Recreate the StatefulSet and Headless Service one more time.

[source,bash]
----
oc create -f web.yaml 
service "nginx" created
statefulset "web" created
----

When all of the StatefulSet’s Pods transition to Running and Ready, retrieve the contents of their index.html files.

[source,bash]
----
for i in 0 1; do kubectl exec -it web-$i -- curl localhost; done
web-0
web-1
----

Even though you completely deleted the StatefulSet, and all of its Pods, the Pods are recreated with their PersistentVolumes mounted, and web-0 and web-1 will still serve their hostnames.

Finally delete the web StatefulSet and the nginx service.

[source,bash]
----
oc delete service nginx
service "nginx" deleted

oc delete statefulset web
statefulset "web" deleted
----

