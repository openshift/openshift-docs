// Module included in the following assemblies:
//
// * admin_guide/cluster-autoscaler.adoc

[id='creating-golden-image-cluster-auto-scaler-{context}']
= Creating prime image (aka golden images)

You can use Ansible playbooks to automatically create and seal a
primed image that is suitable for use by a LC and its ASG. All the
attibutes in the following steps are from your existing AWS cluster.

[NOTE]
====
If you already have a pre-existing primed image you can skip this
procedure.
====

.Procedure

. Create an Ansible *_inventory_* file
+
----
[OSEv3:children]
masters
nodes
etcd

[OSEv3:vars]
ifdef::openshift-enterprise[]
openshift_deployment_type: openshift-enterprise
endif::[]
ifdef::openshift-origin[]
openshift_deployment_type: origin
endif::[]
ansible_ssh_user=ec2-user
openshift_clusterid=mycluster
ansible_become=yes

[masters]
[etcd]
[nodes]
----

. Create provisioning file *_build-ami-provisioning-vars.yaml_*
+
[source,yaml]
----
ifdef::openshift-enterprise[]
openshift_deployment_type: openshift-enterprise
endif::[]
ifdef::openshift-origin[]
openshift_deployment_type: origin
endif::[]

openshift_aws_clusterid: mycluster <1>

openshift_aws_region: us-east-1 <2>

openshift_aws_create_vpc: false <3>

openshift_aws_vpc_name: production <4>

openshift_aws_subnet_az: us-east-1d <5>

openshift_aws_create_security_groups: false <6>

openshift_aws_ssh_key_name: production-ssh-key <7>

openshift_aws_base_ami: ami-12345678 <8>

openshift_aws_create_s3: False <9>

openshift_aws_build_ami_group: default <10>

openshift_aws_vpc: <11>
  name: "{{ openshift_aws_vpc_name }}"
  cidr: 172.18.0.0/16
  subnets:
    us-east-1:
    - cidr: 172.18.0.0/20
      az: "us-east-1d"

container_runtime_docker_storage_type: overlay2 <12>
container_runtime_docker_storage_setup_device: /dev/xvdb <13>

ifdef::openshift-enterprise[]
# atomic-openshift-node service requires gquota to be set on the
# filesystem that hosts /var/lib/origin/openshift.local.volumes (OCP
# emptydir). Often is it not ideal or cost effective to deploy a vol
# for emptydir. This pushes emptydir up to the / filesystem. Base ami
# often does not ship with gquota enabled for /. Set this bool true to
# enable gquota on / filesystem when using Red Hat Cloud Access RHEL7
# AMI or Amazon Market RHEL7 AMI.
openshift_aws_ami_build_set_gquota_on_slashfs: true <14>

rhsub_user: user@example.com <15>
rhsub_pass: password <16>
rhsub_pool: pool-id <17>
endif::[]
----
<1> The name of the existing cluster
<2> The region the existing cluster is currently running in
<3> Disable the creation of a VPC
<4> The existing VPC name that the cluster is running in
<5> The name of one subnet the existing cluster is running in
<6> Disable the creation of security groups
<7> The key name to use for SSH access
<8> The base AMI image (https://www.redhat.com/en/technologies/cloud-computing/cloud-access)
<9> Disable the creation of an S3 bucket
<10> The security group name
<11> The VPC subnets the existing cluster is running in
ifdef::openshift-enterprise[]
<12> Use overlay2 storage type for docker
<13> Mountpoint for LVM and /var/lib/docker; block device created by build_ami playbook
<14> Enable gquota on / filesystem when using Red Hat Cloud
<15> Red Hat subscription-manager email address
<16> Red Hat subscription-manager password
<17> Red Hat subscription-manager Pool ID
endif::[]

. Run the AWS-specific playbook to generate a primed image
+
----
# ansible-playbook -i inventory \
ifdef::openshift-enterprise[]
    /usr/openshift-ansible/playbooks/aws/openshift-cluster/build_ami.yml
endif::[]
ifdef::openshift-origin[]
    ~/openshift-ansible/playbooks/aws/openshift-cluster/build_ami.yml
endif::[]
    -e @build-ami-provisioning-vars.yaml
----

Once this completes the image ID (AMI) that is generated can be
specified when creating the LC. On completion, the output of the
playbook identifies the new AMI by id.