[[admin-guide-router]]
= Monitoring Routers
{product-author}
{product-version]
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Overview
Depending on the underlying implementation, you can monitor a running
xref:../architecture/core_concepts/routes.adoc#architecture-core-concepts-routes[router] in multiple ways. This
topic discusses the HAProxy template router and the components to check to
ensure its health.

== Viewing Statistics
The HAProxy router exposes a web listener for the HAProxy statistics. Enter the
router's public IP address and the correctly configured port (*1936* by default)
to view the statistics page, and enter the administrator password when prompted.
This password and port are configured during the router installation, but they
can be found by viewing the *_haproxy.config_* file on the container.

== Disabling Statistics View
By default the HAProxy statistics are exposed on port *1936* (with a
password protected account). To disable exposing the HAProxy statistics,
specify *0* as the stats port number.

ifdef::openshift-enterprise[]
====
----
$ oadm router hap --service-account=router --stats-port=0  \
    --credentials='/etc/origin/master/openshift-router.kubeconfig'
----
====
endif::[]
ifdef::openshift-origin[]
====
----
$ oadm router hap --service-account=router --stats-port=0  \
    --credentials="$KUBECONFIG"
----
====
endif::[]


Note: HAProxy will still collect and store statistics, it would just _not_
      expose them via a web listener. You can still get access to the
      statistics by sending a request to the HAProxy AF_UNIX socket inside
      the HAProxy Router container.

====
----
$ cmd="echo 'show stat' | socat - UNIX-CONNECT:/var/lib/haproxy/run/haproxy.sock"
$ routerPod=$(oc get pods --selector="router=router"  \
    --template="{{with index .items 0}}{{.metadata.name}}{{end}}")
$ oc exec $routerPod -- bash -c "$cmd"
----
====

[IMPORTANT]
====
link:https://access.redhat.com/errata/RHSA-2015:1650[For security purposes], the
`oc exec` command does not work when accessing privileged containers. Instead,
you can SSH into a node host, then use the `docker exec` command on the desired
container.
====

== Viewing Logs
To view a router log, run the `oc logs` command on the pod. Since the router is
running as a plug-in process that manages the underlying implementation, the log
is for the plug-in, not the actual HAProxy log.

To view the logs generated by HAProxy you need to start a syslog server and pass
the location to a router pod using two environment variables.

.Router Syslog Variables [[syslog-vars]]
[cols="3a,8a",options="header"]
|===

|Environment Variable | Description

|`*ROUTER_SYSLOG_ADDRESS*`
|The IP address of the SYSLOG server. Port *514* is the
default if no port is specified.

|`*ROUTER_LOG_LEVEL*`
|Optional, set to change the log level of HAProxy. If  not set  the default log
level is `warning`; this can be changed to any of the 8 log levels that
HAProxy supports.
|===

To set a running router pod to send messages to a syslog server:
====
----
$ oc env dc/router ROUTER_SYSLOG_ADDRESS=<dest_ip:dest_port>  ROUTER_LOG_LEVEL=<level>
----
====

For example:

----
$ oc env dc/router ROUTER_SYSLOG_ADDRESS=127.0.0.1 ROUTER_LOG_LEVEL=debug
----

sets HAProxy to log send logs to 127.0.0.1 with default port *514* and changes
the log level to debug.

== Viewing the Router Internals
*routes.json*

Routes are processed by the HAProxy router, and are stored both in memory, on
disk, and in the HAProxy configuration file. The internal route representation,
which is passed to the template to generate the HAProxy configuration file, is
found in the *_/var/lib/containers/router/routes.json_* file. When
troubleshooting a routing issue, view this file to see the data being used to
drive configuration.

*HAProxy configuration*

You can find the HAProxy configuration and the backends that have been created
for specific routes in the *_/var/lib/haproxy/conf/haproxy.config_* file. The
mapping files are found in the same directory. The helper frontend and
backends use mapping files when mapping incoming requests to a backend.

*Certificates*

Certificates are stored in two places:

- Certificates for edge terminated and re-encrypt terminated routes are stored
in the *_/var/lib/containers/router/certs_* directory.
- Certificates that are used for connecting to backends for re-encrypt
terminated routes are stored in the *_/var/lib/containers/router/cacerts_*
directory.

The files are keyed by the namespace and name of the route. The key,
certificate, and CA certificate are concatenated into a single file. You can use
link:https://www.openssl.org/[OpenSSL] to view the contents of these files.
