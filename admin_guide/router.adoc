[[admin-guide-router]]
= Monitoring Routers
{product-author}
{product-version]
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Overview
Depending on the underlying implementation, you can monitor a running
xref:../architecture/core_concepts/routes.adoc#architecture-core-concepts-routes[router] in multiple ways. This
topic discusses the HAProxy template router and the components to check to
ensure its health.

== Viewing Statistics
The HAProxy router exposes a web listener for the HAProxy statistics. Enter the
router's public IP address and the correctly configured port (*1936* by default)
to view the statistics page, and enter the administrator password when prompted.
This password and port are configured during the router installation, but they
can be found by viewing the *_haproxy.config_* file on the container.

== Disabling Statistics View
By default the HAProxy statistics are exposed on port *1936* (with a
password protected account). To disable exposing the HAProxy statistics,
specify *0* as the stats port number.

ifdef::openshift-enterprise[]
====
----
$ oadm router hap --service-account=router --stats-port=0
----
====
endif::[]
ifdef::openshift-origin[]
====
----
$ oadm router hap --service-account=router --stats-port=0
----
====
endif::[]


Note: HAProxy will still collect and store statistics, it would just _not_
      expose them via a web listener. You can still get access to the
      statistics by sending a request to the HAProxy AF_UNIX socket inside
      the HAProxy Router container.

====
----
$ cmd="echo 'show stat' | socat - UNIX-CONNECT:/var/lib/haproxy/run/haproxy.sock"
$ routerPod=$(oc get pods --selector="router=router"  \
    --template="{{with index .items 0}}{{.metadata.name}}{{end}}")
$ oc exec $routerPod -- bash -c "$cmd"
----
====

[IMPORTANT]
====
link:https://access.redhat.com/errata/RHSA-2015:1650[For security purposes], the
`oc exec` command does not work when accessing privileged containers. Instead,
you can SSH into a node host, then use the `docker exec` command on the desired
container.
====

== Viewing Logs
To view a router log, run the `oc logs` command on the pod. Since the router is
running as a plug-in process that manages the underlying implementation, the log
is for the plug-in, not the actual HAProxy log.

To view the logs generated by HAProxy, start a syslog server and pass the
location to a router pod using the following environment variables.

.Router Syslog Variables [[syslog-vars]]
[cols="3a,8a",options="header"]
|===

|Environment Variable | Description

|`*ROUTER_SYSLOG_ADDRESS*`
|The IP address of the syslog server. Port *514* is the default if no port is
specified.

|`*ROUTER_LOG_LEVEL*`
|Optional. Set to change the HAProxy log level. If not set, the default log
level is *warning*. This can be changed to any log level that HAProxy supports.
|===

To set a running router pod to send messages to a syslog server:
====
----
$ oc set env dc/router ROUTER_SYSLOG_ADDRESS=<dest_ip:dest_port>  ROUTER_LOG_LEVEL=<level>
----
====

For example, the following sets HAProxy to send logs to 127.0.0.1 with the
default port *514* and changes the log level to *debug*.

----
$ oc set env dc/router ROUTER_SYSLOG_ADDRESS=127.0.0.1 ROUTER_LOG_LEVEL=debug
----

== Liveness & Readiness Probes
The router now exposes liveness & readiness probes through its own HTTP listener (port
*1935* for default) rather than relying on HAProxy's statistics frontend. The following
table lists currently supported endpoints for probes:

.Endpoints for Router Liveness & Readiness Probes [[probe-endpoints]]
[cols="3a,8a",options="header"]
|===

|Endpoint | Description

|`*/alive*`
|This is the endpoint for *liveness* probe. It generates HTTP status code 200 if the 
underlying router implementation is running and HTTP status code 5xx otherwise. The
response body of this endpoint relys on the underlying router implementation.

|`*/ready*`
|This is the endpoint for *readiness* probe. It generates HTTP status code 200 if the 
underlying router implementation is ready for incoming requests and HTTP status code
5xx otherwise. The response body of this endpoint relys on the underlying router
implementation.
|===

== Viewing the Router Internals
*routes.json*

Routes are processed by the HAProxy router, and are stored both in memory, on
disk, and in the HAProxy configuration file. The internal route representation,
which is passed to the template to generate the HAProxy configuration file, is
found in the *_/var/lib/haproxy/router/routes.json_* file. When
troubleshooting a routing issue, view this file to see the data being used to
drive configuration.

*HAProxy configuration*

You can find the HAProxy configuration and the backends that have been created
for specific routes in the *_/var/lib/haproxy/conf/haproxy.config_* file. The
mapping files are found in the same directory. The helper frontend and
backends use mapping files when mapping incoming requests to a backend.

*Certificates*

Certificates are stored in two places:

- Certificates for edge terminated and re-encrypt terminated routes are stored
in the *_/var/lib/haproxy/router/certs_* directory.
- Certificates that are used for connecting to backends for re-encrypt
terminated routes are stored in the *_/var/lib/haproxy/router/cacerts_*
directory.

The files are keyed by the namespace and name of the route. The key,
certificate, and CA certificate are concatenated into a single file. You can use
link:https://www.openssl.org/[OpenSSL] to view the contents of these files.
