= Securing Docker Registry
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]

== Overview
As an administrator, you can optionally create a docker v2 registry.
This docs provides the steps to make v2 registry to serve traffic via TLS.

== Procedure
1. Create and deploy docker v2 registry.

`osadm registry --credentials=<registry_kubeconfig>`

2. Fetch service IP and port of the registry.

`osc get services docker-registry`

3. Create server certificates for the registry.

`osadm create-server-cert --signer-cert=<ca.crt> --signer-key=<ca.key> --signer-serial=<ca.serial.txt> --hostnames='docker-registry.default.local,<service_ip from (2)>' --cert=<registry.cert> --key=<registry.key>`

4. Bundle and create a secret for registry certificates

`openshift ex bundle-secret <registry-secret> <registry.cert from (3)> <registry.key from (3)> > <secret.json>`

`osc create -f <secret.json>`

5. Add secret volume to the registry deployment configuration.

`osc edit dc docker-registry`

----
volumes:
  ...
  - name: <secret-volume>
    secret:
      secretName: <registry-secret from (4)>
...
volumeMounts:
  ...
  - name: <secret-volume>
    mountPath: </etc/secrets/>
    readOnly: true
----

6. Add these environment variables to the registy deployment configuration.

`osc env dc/docker-registry REGISTRY_HTTP_TLS_CERTIFICATE=</etc/secrets/registry.cert> REGISTRY_HTTP_TLS_KEY=</etc/secrets/registry.key>`

More details on why we need these variables: https://github.com/docker/distribution/blob/master/docs/configuration.md#override-configuration-options

7. Copy CA certificate to the docker certs dir.

`sudo mkdir -p /etc/docker/certs.d/<service_ip:service_port>`

`sudo cp <ca.crt> /etc/docker/certs.d/<service_ip:service_port>`

`sudo mkdir -p /etc/docker/certs.d/<docker-registry.default.local:service_port>`

`sudo cp <ca.crt> /etc/docker/certs.d/<docker-registry.default.local:service_port>`

8. Remove `--insecure-registry` option from docker unit file (/etc/sysconfig/docker).

9. Reload daemon and restart docker service.

`sudo systemctl daemon-reload`

`sudo systemctl restart docker`
