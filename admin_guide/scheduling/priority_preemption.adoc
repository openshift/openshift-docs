[[admin-guide-priority-preemption]]
= Pod Priority and Preemption
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]

== Overview

Pod priority indicates the importance of a pod relative to other pods. If a pod cannot be scheduled, the scheduler preempts (evicts) lower-priority pods to make scheduling of the pending pod possible.  

Pod priority also affects scheduling order of pods and out-of-resource eviction ordering on the node. 

== About Pod Priority

When the pod priority and preemtion feature is enabled, scheduler orders pending pods by their priority and a pending pod is placed ahead of other pending pods with lower priority in the scheduling queue. As a result, the higher priority pod may by scheduled sooner that pods with lower priority if its scheduling requirements are met. If such pod cannot be scheduled, scheduler will continue and tries to schedule other lower priority pods.

To use priority and preemption:

. Add one or more xref:admin-guide-priority-preemption-priority-class[`PriorityClasses`].

. Create pods with priorityClassName set to one of the added PriorityClasses. Of course you do not need to create the pods directly; normally you would add priorityClassName to the pod template of a collection object like a Deployment.

Preemption is controlled by a scheduler flag disablePreemption, which is set to false by default.


[[admin-guide-priority-preemption-priority-class]]
=== About Pod Priority Classes

Pods can be configured with a priority class, which is a non-namespaced object that defines a mapping from a name to the integer value of the priority. The higher the value, the higher the priority.

A priority class object can take any 32-bit integer value smaller than or equal to 1000000000 (one billion). Numbers larger than one billion should be reserved for critical pods that should not be preempted or evicted. By default, {product-title} has two reserved priority classes for critical system pods to have guaranteed scheduling.

. `System-cluster-critical` - This priority class has a value of 2000000000 (two billion) and is used with pods that are important for the cluster. Pods with this priority class can be evicted from a node in certain circumstances, for example, pods with system-node-critical priorityClass can take priority. However, this priority class does ensure guaranteed scheduling. Examples of pods that can have this priority class are fluentd, add-on components like descheduler, and so forth.

. `System-node-critical` - This priority class has a value of 2000001000 and is used for all pods that should never be evicted from a node. Examples of pods that have this priority class are sdn-ovs, sdn, and so forth.

.Example PriorityClass
[source, yaml]
----
apiVersion: scheduling.k8s.io/v1beta1
kind: PriorityClass
metadata:
  name: high-priority <1>
value: 1000000 <2>
globalDefault: false <3>
description: "This priority class should be used for XYZ service pods only." <4>
----

<1> The name of the PriorityClass object. 
<2> The priority value of the object.
<3> Optional field that indicates whether this priority class should be used for pods without a priority class name specified. 
<4> Optional arbitrary text string that described which pods should use this PriorityClass.

The optional `globalDefault` field can be set in a priority class that applies a priority to pods that do not have a priority class name specified. This field is `false` by default. 
Only one priority class with `globalDefault` set to `true` can exist in the cluster. If there is no priority class with `globalDefault:true`, the priority of pods with no priority class name is zero. Adding a priority class with `globalDefault:true` affects only pods created after the priority class is added and does not change the priorities of existing pods.


[NOTES]
====
* If you upgrade your existing cluster, the priority of your existing pods is effectively zero.
====

[[admin-guide-priority-preemption-pod]]
=== About Pod Priority Names

After you have one or more priority classes, you can create pods that specify a priority class names in the pod specifications. The priority admission controller uses the priority class name field and populates the integer value of the priority. If the named priority class is not found, the pod is rejected.

The following YAML is an example of a pod configuration that uses the PriorityClass created in the preceding example. The priority admission controller checks the specification and resolves the priority of the pod to 1000000.

.Example pod with PriorityClass
[source, yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: test
spec:
  containers:
  - name: nginx
    image: nginx
    imagePullPolicy: IfNotPresent
  priorityClassName: high-priority <1>
----

<1> Specify the priority class to use with this pod. 

[[admin-guide-priority-preemption-pre]]
== About Pod Preemption

When pods are created, they go to a queue and wait to be scheduled. The scheduler picks a pod from the queue and tries to schedule it on a node. If the scheduler cannot find space on an appropriate node that satisfies all the specified requirements of the pod, preemption logic is triggered for the pending pod. 

When the scheduler preempts one or more pods on a node, the `nominatedNodeName` field of higher-priority pod specification is set to the name of the node. The scheduler uses this field to keep track of the resources reserved for pods and also provides user information about preemptions in their clusters.

After the scheduler preempts a lower-priority pod, the scheduler honors the graceful termination period of the pod. If another node becomes available while scheduler is waiting for the lower-priority pod to terminate, the scheduler can schedule the higher-priority pod on the node. As a result, the `nominatedNodeName` field and `nodeName` field of the pod specification might be different. 

Also, if the scheduler preempts pods on a node and is waiting for termination, if a pod with a higher-priority pod than the waiting pod needs to be scheduled, the scheduler can schedule the higher-priority pod instead. In such a case, the scheduler clears the `nominatedNodeName` of the waiting pod making the pod eligible for another node.

Preemption does not necessarily remove all lower-priority pods. The scheduler can schedule a pending pod by removing a portion of the lower-priority. 

The scheduler consider a node for pod premption only if the pending pod can be scheduled on the node.

==== Graceful termination of preempted pods

When the scheduler preempts pods, the scheduler waits for the pods xref:../../dev_guide/deployments/advanced_deployment_strategies.adoc#graceful-termination[graceful termination period]. They have that much time to finish their work and exit. If the pods do not exit, the scheduler kills the pods. This graceful termination period creates a time gap between the point that the scheduler preempts pods and the time when the pending pod can be scheduled on the node. 

The scheduler continues to schedule other pending pods. As preempted pods exit or get terminated, the scheduler tries to schedule pods in the pending queue. As a result, there is usually a time gap between the point that scheduler preempts a pod and the time that a pending pod is scheduled. To minimize this gap, configure a small graceful termination period for lower-priority pods.


[[admin-guide-priority-preemption-info]]
=== Pod Priority Examples and special cases

For example, Pod P is pending. The scheduler locates Node N, where the removal of one or more pods would enable Pod P to be scheduled on that node. The scheduler deletes the lower-priority pods from the Node N and schedules Pod P on the node. The `nominatedNodeName` field of Pod P is set to the name of Node N.

[NOTE]
====
Pod P is not necessarily scheduled to the nominated node.
==== 

As the scheduler waits for the lower-priority pod to terminated, Node M becomes available. The scheduler then schedules Pod P on Node M. 

=== Pod priority and pod disruption budget

A xref:../../admin_guide/managing_pods.adoc#managing-pods-poddisruptionbudget[pod disruption budget] specifies the minimum number or percentage of replicas that must be up at a time. {product-title} supports pod dusruption budgets when preempting pods at a best effort level. The scheduler attempts to preempt pods without violating the pod dusruption budget. If no such pods are found, lower-priority pods might be removed despite their pod disruption budget requirements.

==== Pod priority and inter-pod affinity

Pod affinity requires a new pod to be scheduled on the same node as other pods with the same label. 

If a pending pod has inter-pod affinity with one or more of the lower-priority pods on a node, the schedulder cannot preempt the lower-priority pods with out viilating the affinity requirements.  In this case, the scheduler looks for another node to schedule the pending pod. However, there is no guarantee that the scheduler can find an appropriate node and pending pod might not be scheduled.

To prevent this situation, carefully configure inter-pod affinity with equal-priority pods.

==== Pod priority and cross-node preemption

If the scheduler is considering preempting pods on a node so that a pending pod can be scheduled, the scheduler can preempts a pod on different node in order to schedule the pending pod. 

For example:

. Pod P is being considered for Node N.
. Pod Q is running on another node in the same zone as Node N.
. Pod P has zone-wide anti-affinity with pod Q, meaning Pod P cannot be scheduled in the same zone as Pod Q.
. There are no other cases of anti-affinity between Pod P and other pods in the zone.
. In order to schedule Pod P on Node N, the scheduler must preempt Pod Q to remove the pod anti-affinity violation, allowing the scheduler to schedule Pod P on Node N.

Pod Q can be preempted, but scheduler does not perform cross-node preemption. So, Pod P will be deemed unschedulable on Node N. 

== Disabling Priority and Preemption

To disable the preemption for the cluster:

. Modify the master-config.yaml to set the `disablePreemption` parameter in the `schedulerArgs` section to `false`.
+
----
disablePreemption=false 
----

. . Restart the {product-title} master service and scheduler to apply the changes.
+
----
# master-restart controllers
# master-restart api
----
