[[admin-guide-managing-projects]]
= Managing Projects
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]

ifdef::openshift-dedicated[]
include::admin_guide/osd_request.adoc[]
endif::[]

== Overview

In {product-title}, projects are used to group and isolate related objects. As an administrator, you can give developers access to certain projects, allow them to create their own, and give them administrative rights within individual projects.

[[selfprovisioning-projects]]
== Self-provisioning Projects

You can allow developers to create their own projects. There is an endpoint
that will provision a project according to a
xref:../dev_guide/templates.adoc#dev-guide-templates[template]. The web console and `oc new-project`
command use this endpoint when a developer xref:../dev_guide/projects.adoc#dev-guide-projects[creates a new project].

[[modifying-the-template-for-new-projects]]
=== Modifying the Template for New Projects
The API server automatically provisions projects based on the template that is
identified by the `projectRequestTemplate` parameter of the *_master-config.yaml_*
file. If the parameter is not defined, the API server creates a default template
that creates a project with the requested name, and assigns the requesting user
to the "admin" role for that project.

To create your own custom project template:

. Start with the current default project template:
+
----
$ oadm create-bootstrap-project-template -o yaml > template.yaml
----

. Use a text editor to modify the *_template.yaml_* file by adding objects or modifying existing objects.

. Load the template:
+
----
$ oc create -f template.yaml -n default
----

. Modify the *_master-config.yaml_* file to reference the loaded template:
+
====
----
...
projectConfig:
  projectRequestTemplate: "default/project-request"
  ...
----
====

When a project request is submitted, the API substitutes the following parameters into the template:

[cols="4,8",options="header"]
|===
|Parameter |Description

|*PROJECT_NAME*
|The name of the project. Required.

|*PROJECT_DISPLAYNAME*
|The display name of the project. May be empty.

|*PROJECT_DESCRIPTION*
|The description of the project. May be empty.

|*PROJECT_ADMIN_USER*
|The username of the administrating user.

|*PROJECT_REQUESTING_USER*
|The username of the requesting user.
|===

Access to the API is granted to developers with the
xref:../architecture/additional_concepts/authorization.adoc#roles[`self-provisioner`
role] and the `self-provisioners` cluster role binding. This role is available
to all authenticated developers by default.

[[disabling-self-provisioning]]
=== Disabling Self-provisioning
Removing the `self-provisioners`
xref:../architecture/additional_concepts/authorization.adoc#roles[cluster role]
from authenticated user groups will deny permissions for self-provisioning any new projects.

----
$ oadm policy remove-cluster-role-from-group self-provisioner system:authenticated system:authenticated:oauth
----

When disabling self-provisioning, set the `projectRequestMessage` parameter in the
*_master-config.yaml_* file to instruct developers on how to request a new
project. This parameter is a string that will be presented to the developer in
the web console and command line when they attempt to self-provision a project.
For example:

----
Contact your system administrator at projectname@example.com to request a project.
----

or:

----
To request a new project, fill out the project request form located at
https://internal.example.com/openshift-project-request.
----

ifdef::openshift-origin,openshift-enterprise,openshift-dedicated[]

[[using-node-selectors]]
== Using Node Selectors

Node selectors are used in conjunction with labeled nodes to control pod
placement.

ifdef::openshift-origin,openshift-enterprise[]
[NOTE]
====
Labels can be assigned
xref:../install_config/install/advanced_install.adoc#configuring-node-host-labels[during
an advanced installation], or
xref:../admin_guide/manage_nodes.adoc#updating-labels-on-nodes[added to a node
after installation].
====
endif::openshift-origin,openshift-enterprise[]

=== Setting the Cluster-wide Default Node Selector

As a cluster administrator, you can set the cluster-wide default node selector
to restrict pod placement to specific nodes.

Edit the master configuration file at *_/etc/origin/master/master-config.yaml_*
and add a value for a default node selector. This is applied to the pods created
in all projects without a specified `*nodeSelector*` value:

====
----
...
projectConfig:
  defaultNodeSelector: "type=user-node,region=east"
...
----
====

Restart the OpenShift service for the changes to take effect:

====
----
# systemctl restart atomic-openshift-master
----
====

=== Setting the Project-wide Node Selector

To create an individual project with a node selector, use the `--node-selector`
option when creating a project. For example, if you have an {product-title}
topology with multiple regions, you can use a node selector to restrict specific
{product-title} projects to only deploy pods onto nodes in a specific region.

The following creates a new project named `myproject` and dictates that pods be
deployed onto nodes labeled `user-node` and `east`:

====
----
$ oadm new-project myproject \
    --node-selector='type=user-node,region=east'
----
====

Once this command is run, this becomes the adminstrator-set node selector for
all pods contained in the specified project.

[NOTE]
====
While the `new-project` subcommand is available for both `oadm` and `oc`, the
cluster administrator and developer commands respectively, creating a new
project with a node selector is only available with the `oadm` command. The
`new-project` subcommand is not available to project developers when
self-provisioning projects.
====

Using the `oadm new-project` command adds an `annotation` section to the
project. You can edit a project, and change the `openshift.io/node-selector`
value to override the default:

====
----
...
metadata:
  annotations:
    openshift.io/node-selector: type=user-node,region=east
...
----
====

If `openshift.io/node-selector` is set to an empty string (`oadm new-project
--node-selector=""`), the project will not have an adminstrator-set node
selector, even if the cluster-wide default has been set. This means that, as a
cluster administrator, you can set a default to restrict developer projects to a
subset of nodes and still enable infrastructure or other projects to schedule
the entire cluster.

[[using-node-selectors-namespace]]
=== Limiting Which Node Selectors are in a Project

To set a limit on what labels and label selectors can be used at project level, 
use an annotation in the master configuration file. 

This _whitelist_ of labels in a particular project, 
lets developers know what node selectors are acceptable to use 
and gives administrators greater control over labelling in a cluster. 

To create a whitelist, specify an admission controller plug-in 
within the master configuration file (/etc/origin/master/master-config.yaml) with the 
list of allowed labels. 

----
podNodeSelectorPluginConfig:
 clusterDefaultNodeSelector: region=west
 <project-name>: <label>=<value>,<label2>-<value2> <1>
----

<1> Creates a list of allowed labels for the `ns1` project.

Then, create a project object that includes the 
`scheduler.alpha.kubernetes.io/node-selector` annotation using allowed labels. When creating pods for this project, 
invoke the project using the `--namespace` parameter. 	 

----
{
    "kind": "Namespace",
    "apiVersion": "v1",
    "metadata": {
        "name": "ns1",
        "annotations": {
            "scheduler.alpha.kubernetes.io/node-selector": "<label>=<value>,<label2>-<value2>" <1>
        }
    },
    "spec": {},
    "status": {}
}
----

<1> Annotation to create the whitelist and the labels to allow.

For example: 

. Configure PodNodeSelector admission like below
+
----
podNodeSelectorPluginConfig:
 clusterDefaultNodeSelector: region=west
 ns1: region=west,env=test,infra=fedora,role=vm,os=fedora
-----

. Create a project object that allows the labels `env=test` and `infra=fedora`.
+
----
{
    "kind": "Namespace",
    "apiVersion": "v1",
    "metadata": {
        "name": "ns1",
        "annotations": {
            "scheduler.alpha.kubernetes.io/node-selector": "env=test,infra=fedora"
        }
    },
    "spec": {},
    "status": {}
}
----

. Create the project:
+
----
oc create -f my-project.yaml 
----

. Create a pod specification with the permitted labels as node selectors:
+
----
apiVersion: v1
kind: Pod
metadata:
  labels:
    name: pod1
  name: pod1
spec:
  containers:
    - image: "docker.io/ocpqe/hello-pod:latest"
      imagePullPolicy: IfNotPresent
      name: hello-pod
      ports:
        - containerPort: 8080
          protocol: TCP
      resources: {}
      securityContext:
        capabilities: {}
        privileged: false
      terminationMessagePath: /dev/termination-log
  dnsPolicy: ClusterFirst
  restartPolicy: Always
  nodeSelector: <1>
    env: test 
    os: fedora 
  serviceAccount: ""
status: {}
----
+
<1> Permitted labels as node selectors.

. Create a pod in the namespace:
+
----
oc create -f pod.yaml --namespace=ns1
----

. Check that the node selector labels were added to the pod configuration:
+
----
get pod pod1 --namespace=ns1 -o json

NodeSelector in pod should merge with namespace nodeSelector

"nodeSelector": {
  "env": "test",
  "infra": "fedora",
  "os": "fedora"
}
----
+
The node selectors are merged.
+
If you create a pod with a label that is not specified in the project specification, here `region=east`, the pod is not scheduled on the node:
+
----
nodeSelector:
    env: test
    infra: centos
    os: fedora
    region: east
----


[[developer-specified-node-selectors]]
=== Developer-specified Node Selectors

{product-title} developers
xref:../dev_guide/deployments/basic_deployment_operations.adoc#assigning-pods-to-specific-nodes[can set a node selector on their pod configuration] if they wish to restrict nodes even
further. This will be in addition to the project node selector, meaning that you
can still dictate node selector values for all projects that have a node
selector value.

For example, if a project has been created with the above annotation
(`openshift.io/node-selector: type=user-node,region=east`) and a developer sets
another node selector on a pod in that project, for example
`clearance=classified`, the pod will only ever be scheduled on nodes that have
all three labels (`type=user-node`, `region=east`, and `clearance=classified`).
If they set `region=west` on a pod, their pods would be demanding nodes with
labels `region=east` and `region=west`, which cannot work. The pods will never
be scheduled, because labels can only be set to one value.

endif::openshift-origin,openshift-enterprise,openshift-dedicated[]

[[limit-projects-per-user]]
== Limiting Number of Self-Provisioned Projects Per User

The number of self-provisioned projects requested by a given user can be limited
with the `*ProjectRequestLimit*`
xref:../architecture/additional_concepts/admission_controllers.adoc#architecture-additional-concepts-admission-controllers[admission
control plug-in].

[IMPORTANT]
====
If your project request template was created in {product-title} 3.1 or earlier
using the process described in
xref:modifying-the-template-for-new-projects[Modifying the Template for New
Projects], then the generated template does not include the annotation
`*openshift.io/requester: ${PROJECT_REQUESTING_USER}*`, which is used for the
`*ProjectRequestLimitConfig*`. You must add the annotation.
====

In order to specify limits for users, a configuration must be specified for the
plug-in within the master configuration file
(*_/etc/origin/master/master-config.yaml_*). The plug-in configuration takes a
list of user label selectors and the associated maximum project requests.

Selectors are evaluated in order. The first one matching the current user will
be used to determine the maximum number of projects. If a selector is not
specified, a limit applies to all users. If a maximum number of projects is not
specified, then an unlimited number of projects are allowed for a specific
selector.

The following configuration sets a global limit of 2 projects per user while allowing 10
projects for users with a label of `level=advanced` and unlimited projects for
users with a label of `level=admin`.

====

[source, yaml]
----
admissionConfig:
  pluginConfig:
    ProjectRequestLimit:
      configuration:
        apiVersion: v1
        kind: ProjectRequestLimitConfig
        limits:
        - selector:
            level: admin <1>
        - selector:
            level: advanced <2>
          maxProjects: 10
        - maxProjects: 2 <3>
----

<1> For selector `level=admin`, no `*maxProjects*` is specified. This means that users
with this label will not have a maximum of project requests.

<2> For selector `level=advanced`, a maximum number of 10 projects will be allowed.

<3> For the third entry, no selector is specified. This means that it will be applied
to any user that doesn't satisfy the previous two rules. Because rules are evaluated
in order, this rule should be specified last.

====

[NOTE]
====
xref:../admin_guide/manage_users.adoc#managing-users-managing-user-and-group-labels[Managing
User and Group Labels] provides further guidance on how to add, remove, or show
labels for users and groups.
====

Once your changes are made, restart {product-title} for the changes to take
effect.
ifdef::openshift-origin[]
----
# systemctl restart origin-master
----
endif::[]
ifdef::openshift-enterprise[]
----
# systemctl restart atomic-openshift-master
----
endif::[]
