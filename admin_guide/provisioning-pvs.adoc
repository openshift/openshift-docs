= Dynamically Provisioning Persistent Volumes
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Overview
You can provision your OpenShift cluster with storage dynamically when running in a cloud environment.  Some familiarity with running
and configuring OpenShift is assumed.

The Kubernetes link:../dev_guide/persistent_volumes.html[persistent volume]
framework allows administrators to provision a cluster with persistent storage
and gives users a way to request those resources without having any knowledge of
the underlying infrastructure.

Many kinds of storage exist for OpenShift.  All of them can be statically provisioned by an administrator.  Some types of
storage can be created dynamically via an API. These types of storage can be provisioned in an OpenShift cluster using
the new and experimental dynamic storage feature.

[IMPORTANT]
====
Dynamic provisioning is an experimental feature and is expected to change in the future as it matures and feedback is received
from users.  New ways to provision the cluster are planned and the means by which one accesses this feature is going to change.
Backwards compatibility is not guaranteed.
====

[[provisioning]]

== Storage Classes
Admins configure their clusters with Provisioners tied to classes of storage (various quality of service levels).  Provisioners are
configured via OpenShift's master-config file.  "Storage Classes" are added to the cluster configuration and each class is tied to
one provisioner.

A storage class is a composite of the classname and the name of the provisioner plugin separated by a slash.

For example, map storage class 'foo' to an EBS volume:

`foo/kubernetes.io/aws-ebs`

Provisioners are configured in OpenShift's master-config:

.Master Config Example
====
[source,yaml]
----
kubernetesMasterConfig:
  apiLevels:
  - v1beta3
  - v1
  apiServerArguments: null
  controllerArguments:
    "storage-class":
      - "foo/kubernetes.io/aws-ebs"
      - "bar/another-plugin"
      - "baz/many-provisioner-plugins"
----
====


[[Provisioners]]

=== Current Provisioners
Several OpenShift plugins have generic implementations for dynamic provisioning that use a provider's API to create new storage resources.

The plugin names are:

1. OpenStack Cinder - "kubernetes.io/cinder"
2. AWS EBS - "kubernetes.io/aws-ebs"
3. GCEPD - "kubernetes.io/gce-pd"

Future provisioners will include the many types of storage a single provider offers.  AWS, for example, has several types of EBS volumes to offer,
each with its own performance characteristics.  They also have an NFS-like storage option.  More provisioners will be implemented for our storage providers.

[[Requesting storage]]

=== User Requests
Users request dynamically provisioned storage by including a storage class annotation in their *PersistentVolumeClaim*.

The value of the annotation should be one of the classes configured by the administrator.

.Provisioning Request
====
[source,json]
----
{
  "kind": "PersistentVolumeClaim",
  "apiVersion": "v1",
  "metadata": {
    "name": "claim1",
    "annotations": {
      "volume.experimental.kubernetes.io/quality-of-service": "foo"
    }
  },
  "spec": {
    "accessModes": [
      "ReadWriteOnce"
    ],
    "resources": {
      "requests": {
        "storage": "3Gi"
      }
    }
  }
}
----
====

[[Reclaiming Resources]]

=== Volume Recycling

Volumes created dynamically by a provisioner have their `persistentVolumeReclaimPolicy` set to `Delete`.
When a *PersistentVolumeClaim* is deleted, its backing *PersistentVolume* is considered released of its claim and that resource can be reclaimed by the cluster.
Dynamic provisioning utilizes the provider's API to delete the volume from the provider and then removes the *PersistentVolume* from the cluster.
