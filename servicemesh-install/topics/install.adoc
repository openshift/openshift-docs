[[installing-service-mesh]]
= Installing the {ProductName}

Installing the {ProductShortName} involves installing the Operator, and then creating and managing a custom resource definition file to deploy the control plane.

[NOTE]
====
Starting with {ProductName} 0.9.TechPreview, Mixer’s policy enforcement is disabled by default. You must enable it to run policy tasks. See https://docs.openshift.com/container-platform/3.11/servicemesh-install/servicemesh-install.html#update-mixer-policy-enforcement[Update Mixer policy enforcement] for instructions on enabling Mixer policy enforcement.
====

[NOTE]
====
Single-tenant control plane installations are known to cause issues with OpenShift Container Platform restarts and upgrades. Multi-tenant control plane installations are the default configuration starting with {ProductName} {ProductVersion}.
====

[[installing-operators]]
== Installing the Operators
The {ProductShortName} installation process introduces an Operator to manage the installation of the control plane within the `istio-operator` namespace. This Operator defines and monitors a custom resource related to the deployment, update, and deletion of the control plane.

Starting with {ProductName} {ProductVersion}, you must install the Jaeger Operator and the Kiali Operator before the {ProductName} Operator can install the control plane.


[[installing-jaeger-operator]]
=== Installing the Jaeger Operator
You must install the Jaeger Operator for the {ProductName} Operator to install the control plane.

. Log in to the {product-title} as a cluster administrator.

. Run the following commands to install the Jaeger Operator:
+
----
$ oc new-project observability # create the project for the jaeger operator
$ oc create -n observability -f https://raw.githubusercontent.com/jaegertracing/jaeger-operator/v1.13.1/deploy/crds/jaegertracing_v1_jaeger_crd.yaml
$ oc create -n observability -f https://raw.githubusercontent.com/jaegertracing/jaeger-operator/v1.13.1/deploy/service_account.yaml
$ oc create -n observability -f https://raw.githubusercontent.com/jaegertracing/jaeger-operator/v1.13.1/deploy/role.yaml
$ oc create -n observability -f https://raw.githubusercontent.com/jaegertracing/jaeger-operator/v1.13.1/deploy/role_binding.yaml
$ oc create -n observability -f https://raw.githubusercontent.com/jaegertracing/jaeger-operator/v1.13.1/deploy/operator.yaml
----

[[installing-kiali-operator]]
=== Installing the Kiali Operator
You must install the Kiali Operator for the {ProductName} Operator to install the control plane.

. Log in to the {product-title} as a cluster administrator.

. Run the following command to install the Kiali Operator:
+
----
$ bash <(curl -L https://git.io/getLatestKialiOperator) --operator-image-version v1.0.0 --operator-watch-namespace '**' --accessible-namespaces '**' --operator-install-kiali false
----

[[installing-ossm-operator]]
=== Installing the {ProductName} Operator

[NOTE]
====
You must install the Jaeger Operator and the Kiali Operator before you install the {ProductName} Operator.
====

. Log in to the {product-title} as a cluster administrator.

. If the `istio-operator` and `istio-system` namespaces do not exist, run these commands to create the namespaces:
+
----
$ oc new-project istio-operator
$ oc new-project istio-system
----

. Run this command to install the {ProductName} Operator. You can run it from any host with access to the cluster.
+
----
$ oc apply -n istio-operator -f https://raw.githubusercontent.com/Maistra/istio-operator/maistra-0.12/deploy/servicemesh-operator.yaml
----



[[verifying-operator-installation]]
== Verifying the Operator installation

. Log in to the {product-title} as a cluster administrator.

. Run this command to verify that the Operator is installed correctly.
+
----
$ oc get pods -n istio-operator
----

. When the Operator reaches a running state, it is installed correctly.
+
----
NAME                              READY     STATUS    RESTARTS   AGE
istio-operator-5cd6bcf645-fvb57   1/1       Running   0          1h
----

[[creating-custom-resource]]
== Creating a custom resource file

[NOTE]
====
The `istio-system` namespace is used as an example throughout the {ProductShortName} documentation, but you can use other namespaces as necessary.
====

To deploy the {ProductShortName} control plane, you must deploy a custom resource. A _custom resource_ you to introduce your own API into a Kubernetes project or cluster. You create a custom resource yaml file that defines the project parameters and creates the object. This example custom resource yaml file contains all of the supported parameters and deploys {ProductName} {ProductVersion} images based on Red Hat Enterprise Linux (RHEL).

[IMPORTANT]
====
The 3scale Istio Adapter is deployed and configured in the custom resource file. It also requires a working 3scale account (https://www.3scale.net/signup/[SaaS] or https://access.redhat.com/documentation/en-us/red_hat_3scale_api_management/2.4/html/infrastructure/onpremises-installation[On-Premises]).
====

.Full example istio-installation.yaml

[source,yaml]
----
  apiVersion: maistra.io/v1
  kind: ServiceMeshControlPlane
  metadata:
    name: basic-install
  spec:

    threeScale:
      enabled: false

    istio:
      global:
        proxy:
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 128Mi
        multitenant: true

      gateways:
        istio-egressgateway:
          autoscaleEnabled: false
        istio-ingressgateway:
          autoscaleEnabled: false
          ior_enabled: false

      mixer:
        policy:
          autoscaleEnabled: false

        telemetry:
          autoscaleEnabled: false
          resources:
            requests:
              cpu: 100m
              memory: 1G
            limits:
              cpu: 500m
              memory: 4G

      pilot:
        autoscaleEnabled: false
        traceSampling: 100.0

      kiali:
       dashboard:
          user: admin
          passphrase: admin
      tracing:
        enabled: true
----

[[custom-resource-parameters]]
== Custom resource parameters

The following examples illustrate use of the supported custom resource parameters for {ProductName} and the tables provide additional information about supported parameters.

[IMPORTANT]
====
The resources you configure for {ProductName} with these custom resource parameters, including CPUs, memory, and the number of pods, are based on the configuration of your OpenShift cluster. Configure these parameters based on the available resources in your current cluster configuration.
====

[[cr-istio-global]]
=== Istio global example

[NOTE]
====
In order for the 3scale Istio Adapter to work, `disablePolicyChecks` must be `false`.
====

[source,yaml]
----
  istio:
    global:
      hub: `maistra/` or `registry.redhat.io/openshift-istio-tech-preview/`
      tag: 0.12.0
      proxy:
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 128Mi
      mtls:
        enabled: false
      disablePolicyChecks: true
      policyCheckFailOpen: false
      imagePullSecrets:
        - MyPullSecret
----

[NOTE]
====
See the OpenShift documentation on https://docs.openshift.com/container-platform/3.11/dev_guide/compute_resources.html#dev-compute-resources[Compute Resources] for additional details on specifying CPU and memory resources for the containers in your pod.
====

.Global parameters
|===
|Parameter |Description |Values |Default value

|`disablePolicyChecks`
|This boolean indicates whether to enable policy checks
|`true`/`false`
|`true`

|`policyCheckFailOpen`
|This boolean indicates whether traffic is allowed to pass through to the Envoy sidecar when the Mixer policy service cannot be reached
|`true`/`false`
|`false`

|`tag`
|The tag that the Operator uses to pull the Istio images
|A valid container image tag
|`0.12.0`

|`hub`
|The hub that the Operator uses to pull Istio images
|A valid image repo
|`maistra/` or `registry.redhat.io/openshift-istio-tech-preview/`

|`mTLS`
|This controls whether to enable Mutual Transport Layer Security (mTLS) between services by default
|`true`/`false`
|`false`

|`imagePullSecret`
|If access to the registry providing the Istio images is secure, list an https://kubernetes.io/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod[imagePullSecret] here
|redhat-registry-pullsecret OR quay-pullsecret
|None

|===


.Proxy parameters
|===
|Type |Parameter |Description |Values |Default value

|Resources
|`cpu`
|The percentage of CPU resources requested for Envoy proxy
|CPU resources in millicores based on your environment's configuration
|`100m`

|
|`memory`
|The amount of memory requested for Envoy proxy
|Available memory in bytes based on your environment's configuration
|`128Mi`

|Limits
|`cpu`
|The maximum percentage of CPU resources requested for Envoy proxy
|CPU resources in millicores based on your environment's configuration
|`2000m`

|
|`memory`
|The maximum amount of memory Envoy proxy is permitted to use
|Available memory in bytes based on your environment's configuration
|`128Mi`
|===


[[cr-cni]]
=== Container Network Interface (CNI) example

[WARNING]
====
If Container Network Interface (CNI) is enabled, manual sidecar injection will work, but pods will not be able to communicate with the control plane unless they are a part of the `ServiceMeshMemberRoll` resource.
====

[source,yaml]
----
  apiVersion: maistra.io/v1
  kind: ServiceMeshControlPlane
  metadata:
   name: basic-install
  spec:

    istio:
      istio_cni:
        enabled: true
----

.CNI parameter

|===
|Type |Parameter |Description |Values |Default value

|`istio_cni`
|`enabled`
|This parameter enables the Container Network Interface (CNI)
|`false`
|===

[[cr-istio-gateway]]
=== Istio gateway example

[WARNING]
====
Automatic route creation does not currently work with multi-tenancy. Set `ior_enabled` to `false` for multi-tenant installations.
====


[source,yaml]
----
  gateways:
       istio-egressgateway:
         autoscaleEnabled: false
         autoscaleMin: 1
         autoscaleMax: 5
       istio-ingressgateway:
         autoscaleEnabled: false
         autoscaleMin: 1
         autoscaleMax: 5
         ior_enabled: false
----


.Istio Gateway parameters
|===
|Type |Parameter |Description |Values |Default value

|`istio-egressgateway`
|`autoscaleEnabled`
|This parameter enables autoscaling.
|`true`/`false`
|`true`

|
|`autoscaleMin`
|The minimum number of pods to deploy for the egress gateway based on the autoscaleEnabled setting
|A valid number of allocatable pods based on your environment's configuration
|`1`

|
|`autoscaleMax`
|The maximum number of pods to deploy for the egress gateway based on the autoscaleEnabled setting
|A valid number of allocatable pods based on your environment's configuration
|`5`

|`istio-ingressgateway`
|`autoscaleEnabled`
|This parameter enables autoscaling.
|`true`/`false`
|`true`

|
|`autoscaleMin`
|The minimum number of pods to deploy for the ingress gateway based on the autoscaleEnabled setting
|A valid number of allocatable pods based on your environment's configuration
|`1`

|
|`autoscaleMax`
|The maximum number of pods to deploy for the ingress gateway based on the autoscaleEnabled setting
|A valid number of allocatable pods based on your environment's configuration
|`5`

|
|`ior_enabled`
|This parameter controls whether Istio routes are automatically configured in OpenShift
|`true`/`false`
|`true`
|===

[[cr-istio-mixer]]
=== Istio Mixer example

[source,yaml]
----
  mixer:
    enabled: true
       policy:
         autoscaleEnabled: false

       telemetry:
         autoscaleEnabled: false
         resources:
           requests:
             cpu: 100m
             memory: 1G
           limits:
             cpu: 500m
             memory: 4G
----


.Istio Mixer policy parameters
|===
|Parameter |Description |Values |Default value

|`enabled`
|This enables Mixer
|`true`/`false`
|`true`

|`autoscaleEnabled`
|This controls whether to enable autoscaling. Disable this for small environments.
|`true`/`false`
|`true`

|`autoscaleMin`
|The minimum number of pods to deploy based on the autoscaleEnabled setting
|A valid number of allocatable pods based on your environment's configuration
|`1`

|`autoscaleMax`
|The maximum number of pods to deploy based on the autoscaleEnabled setting
|A valid number of allocatable pods based on your environment's configuration
|`5`
|===


.Istio Mixer telemetry parameters
|===
|Type |Parameter |Description |Values |Default value

|Resources
|`cpu`
|The percentage of CPU resources requested for Mixer telemetry
|CPU resources in millicores based on your environment's configuration
|`1000m`

|
|`memory`
|The amount of memory requested for Mixer telemetry
|Available memory in bytes based on your environment's configuration
|`1G`

|Limits
|`cpu`
|The maximum percentage of CPU resources Mixer telemetry is permitted to use
|CPU resources in millicores based on your environment's configuration
|`4800m`

|
|`memory`
|The maximum amount of memory Mixer telemetry is permitted to use
|Available memory in bytes based on your environment's configuration
|`4G`
|===

[[cr-istio-pilot]]
=== Istio Pilot example

[source,yaml]
----
  pilot:
    resources:
      requests:
        cpu: 100m
     autoscaleEnabled: false
     traceSampling: 100.0
----

.Istio Pilot parameters
|===
|Parameter |Description |Values |Default value

|`cpu`
|The percentage of CPU resources requested for Pilot
|CPU resources in millicores based on your environment's configuration
|`500m`

|`memory`
|The amount of memory requested for Pilot
|Available memory in bytes based on your environment's configuration
|`2048Mi`

|`traceSampling`
|This value controls how often random sampling occurs. Note: increase for development or testing.
|A valid number
|`1.0`
|===

[[cr-tracing-jaeger]]
=== Tracing and Jaeger example

[source,yaml]
----
  tracing:
      enabled: false
      jaeger:
        tag: 1.13.1
        template: all-in-one
        agentStrategy: DaemonSet
----

.Tracing and Jaeger parameters
|===
|Parameter |Description |Value |Default value

|`enabled`
|This enables tracing in the environment
|`true`/`false`
|`true`

|`hub`
|The hub that the Operator uses to pull Jaeger images
|A valid image repo
|`jaegertracing/` or `registry.redhat.io/openshift-istio-tech-preview/`

|`tag`
|The tag that the Operator uses to pull the Jaeger images
|A valid container image tag.
|`1.13.1`

|`template`
|The deployment template to use for Jaeger
|The name of a template type
|`all-in-one` / `production-elasticsearch`

|`agentStrategy`
|Deploy the Jaeger Agent to each compute node
|`DaemonSet` if required
|None

|===


[[cr-kiali]]
=== Kiali example

[NOTE]
====
Kiali supports Oath authentication and dashboard users. By default, Kiali uses OpenShift Oauth, but you can enable a dashboard user by adding a dashboard user and passphrase.
====

[source,yaml]
----
  kiali:
     enabled: true
     hub: kiali/
     tag: v1.0.0
     dashboard:
       user: admin
       passphrase: admin
----

.Kiali parameters
|===
|Parameter |Description |Values |Default value

|`enabled`
|This enables or disables Kiali in {ProductShortName}. Kiali is installed by default. If you do not want to install Kiali, change the `enabled` value to `false`.
|`true`/`false`
|`true`

|`hub`
|The hub that the Operator uses to pull Kiali images
|A valid image repo
|`kiali/` or `registry.redhat.io/openshift-istio-tech-preview/`

|`tag`
|The tag that the Operator uses to pull the Istio images
|A valid container image tag
|`1.0.0`

|`user`
|The username to access the Kiali console. Note: This is not related to any OpenShift account.
|A valid Kiali dashboard username
|None

|`passphrase`
|The password used to access the Kiali console. Note: This is not related to any OpenShift account.
|A valid Kiali dashboard passphrase
|None
|===

[[cr-threescale]]
=== 3scale example

[source,yaml]
----
  threeScale:
      enabled: false
      PARAM_THREESCALE_LISTEN_ADDR: 3333
      PARAM_THREESCALE_LOG_LEVEL: info
      PARAM_THREESCALE_LOG_JSON: true
      PARAM_THREESCALE_LOG_GRPC: false
      PARAM_THREESCALE_REPORT_METRICS: true
      PARAM_THREESCALE_METRICS_PORT: 8080
      PARAM_THREESCALE_CACHE_TTL_SECONDS: 300
      PARAM_THREESCALE_CACHE_REFRESH_SECONDS: 180
      PARAM_THREESCALE_CACHE_ENTRIES_MAX: 1000
      PARAM_THREESCALE_CACHE_REFRESH_RETRIES: 1
      PARAM_THREESCALE_ALLOW_INSECURE_CONN: false
      PARAM_THREESCALE_CLIENT_TIMEOUT_SECONDS: 10
      PARAM_THREESCALE_GRPC_CONN_MAX_SECONDS: 60
----

.3scale parameters
|===
|Parameter |Description |Values |Default

|`enabled`
|Whether to use the 3scale adapter
|`true`/`false`
|`false`

|`PARAM_THREESCALE_LISTEN_ADDR`
|Sets the listen address for the gRPC server
|Valid port number
|`3333`

|`PARAM_THREESCALE_LOG_LEVEL`
|Sets the minimum log output level.
|`debug`, `info`, `warn`, `error`, or `none`
|`info`

|`PARAM_THREESCALE_LOG_JSON`
|Controls whether the log is formatted as JSON
|`true`/`false`
|`true`

|`PARAM_THREESCALE_LOG_GRPC`
|Controls whether the log contains gRPC info
|`true`/`false`
|`false`

|`PARAM_THREESCALE_REPORT_METRICS`
|Controls whether 3scale system and backend metrics are collected and reported to Prometheus
|`true`/`false`
|`true`

|`PARAM_THREESCALE_METRICS_PORT`
|Sets the port that the 3scale `/metrics` endpoint can be scrapped from
|Valid port number
|`8080`

|`PARAM_THREESCALE_CACHE_TTL_SECONDS`
|Time period, in seconds, to wait before purging expired items from the cache
|Time period in seconds
|`300`

|`PARAM_THREESCALE_CACHE_REFRESH_SECONDS`
|Time period before expiry when cache elements are attempted to be refreshed
|Time period in seconds
|`180`

|`PARAM_THREESCALE_CACHE_ENTRIES_MAX`
|Max number of items that can be stored in the cache at any time. Set to `0` to disable caching
|Valid number
|`1000`

|`PARAM_THREESCALE_CACHE_REFRESH_RETRIES`
|The number of times unreachable hosts are retried during a cache update loop
|Valid number
|`1`

|`PARAM_THREESCALE_ALLOW_INSECURE_CONN`
|Allow to skip certificate verification when calling `3scale` APIs. Enabling this is not recommended.
|`true`/`false`
|`false`

|`PARAM_THREESCALE_CLIENT_TIMEOUT_SECONDS`
|Sets the number of seconds to wait before terminating requests to 3scale System and Backend
|Time period in seconds
|`10`

|`PARAM_THREESCALE_GRPC_CONN_MAX_SECONDS`
|Sets the maximum amount of seconds (+/-10% jitter) a connection may exist before it is closed
|Time period in seconds
|`60`
|===


[[configure-multi-tenant-installations]]
== Configuring multi-tenant installations
See the https://docs.openshift.com/container-platform/3.11/servicemesh-install/servicemesh-install.html#multi-tenant-install[Multi-tenant {ProductName} install] chapter for instructions on installing and configuring a {ProductShortName} instance.


[[update-mixer-policy-enforcement]]
== Update Mixer policy enforcement
In previous versions of {ProductName}, Mixer’s policy enforcement was enabled by default. Mixer policy enforcement is now disabled by default. You must enable it before running policy tasks.

. Run this command to check the current Mixer policy enforcement status:
+
----
$ oc get cm -n istio-system istio -o jsonpath='{.data.mesh}' | grep disablePolicyChecks
----

. If `disablePolicyChecks: true`, edit the {ProductShortName} ConfigMap:
+
----
$ oc edit cm -n istio-system istio
----

. Locate `disablePolicyChecks: true` within the ConfigMap and change the value to `false`.

. Save the configuration and exit the editor.

. Re-check the Mixer policy enforcement status to ensure it is set to `false`.


[[deploying-control-plane]]
== Deploying the control plane

With the introduction of {product-title} 4.1, the network capabilities of the host are now based on nftables rather than iptables. This change impacts the initialization of the {ProductShortName} application components. {ProductShortName} needs to know what host operating system OpenShift is running on to correctly initialize {ProductShortName} networking components.

[NOTE]
====
You do not need to make these changes to your custom resource if you are using {product-title} 4.1.
====

If the OpenShift installation is deployed on a Red Hat Enterprise Linux (RHEL) 7 host, then the custom resource must explicitly request the RHEL 7 `proxy-init` container image by including the following:

.Enabling the proxy-init container for RHEL 7 hosts

[subs=+macros]
----
  apiVersion: maistra.io/v1
   kind: ServiceMeshControlPlane
   spec:
     istio:
       global:
        pass:quotes[*proxy_init:*]
           pass:quotes[*image: proxy-init*]
----



Use the custom resource definition file you created to deploy the {ProductShortName} control plane.

. Create a custom resource definition file named istio-`installation.yaml`.

. Run this command to deploy the control plane:
+
----
$ oc create -n istio-system -f istio-installation.yaml
----

. Run this command to watch the progress of the pods during the installation process:
+
----
$ oc get pods -n istio-system -w
----


