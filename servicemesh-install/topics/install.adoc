[[installing-service-mesh]]
= Installing the {ProductName}

Installing the {ProductShortName} involves creating a custom resource definition file, then installing the operator to create and manage the custom resource.

[[creating-custom-resource]]
== Creating a custom resource file

To deploy the {ProductShortName} control plane, you must deploy a custom resource.  A _custom resource_ is an object that extends the Kubernetes API, or allows you to introduce your own API into a project or a cluster.  You define a custom resource as a yaml file that defines the object. Then you use the yaml file to create the object. The following example contains all of the supported parameters and deploys {ProductName} {ProductVersion} images based on Red Hat Enterprise Linux (RHEL).

[TIP]
====
Deploying an *_istio-installation.yaml_* file that includes all of the parameters ensures that you have installed all of the Istio components that are required to complete the tutorials included in this document.
====

.Full example istio-installation.yaml
[source,yaml]
----
apiVersion: "istio.openshift.com/v1alpha1"
kind: "Installation"
metadata:
  name: "istio-installation"
spec:
  deployment_type: openshift
  istio:
    authentication: false
    community: false
    prefix: openshift-istio-tech-preview/
    version: 0.2.0
  jaeger:
    prefix: distributed-tracing-tech-preview/
    version: 1.7.0
    elasticsearch_memory: 1Gi
  kiali:
    username: username
    password: password
    prefix: openshift-istio-tech-preview/
    version: v0.7.2
  launcher:
    openshift:
      user: user
      password: password
    github:
      username: username
      token: token
    catalog:
      filter: booster.mission.metadata.istio
      branch: v62
      repo: https://github.com/fabric8-launcher/launcher-booster-catalog.git
----

The following example illustrates the minimum required to install the control plane.  This minimal example custom resource deploys the CentOS-based community Istio images.

.Minimum example istio-installation.yaml

[source,yaml]
----
apiVersion: "istio.openshift.com/v1alpha1"
kind: "Installation"
metadata:
  name: "istio-installation"
----


[[custom-resource-parameters]]
== Custom resource parameters

The following tables list the supported custom resource parameters for {ProductName}.

.General parameters
|===
|Parameter |Values |Description | Default

|`deployment_type`
|`origin`, `openshift`
|Specifies whether to use Origin (community) or OpenShift (product) default values for undefined parameter values.
|`origin`
|===

.Istio parameters
|===
|Parameter |Values |Description | Default

|`authentication`
|`true`/`false`
|Whether to enable mutual authentication.
|`false`

|`community`
|`true`/`false`
|Whether to modify image names to match community images.
|`false`

|`prefix`
|Any valid image repo
|Which prefix to apply to Istio image names that are used in `docker pull` commands.
|If `deployment_type=origin` the default value is `maistra/`.

If `deployment_type=openshift` the default value is `openshift-istio-tech-preview/`.

|`version`
|Any valid Docker tag
|Docker tag to use with Istio images.
|`0.2.0`
|===

.Jaeger parameters
|===
|Parameter |Values |Description  |Default

|`prefix`
|Any valid image repo.
|Which prefix to apply to Jaeger image names used in docker pull.
|If `deployment_type=origin` the default value is `jaegertracing/`.

If `deployment_type=openshift` the default value is `distributed-tracing-tech-preview/`.

|`version`
|Any valid Docker tag.
|Which Docker tag to use with Jaeger images.
|The default value is `1.7` if `deployment_type=origin`.

 The default value is `1.7.0` if `deployment_type=openshift`.

|`elasticsearch_memory`
|Memory size in megabytes or gigabytes.
|The amount of memory to allocate to the Elasticsearch installation, for example, `1000MB` or `1 GB`.
|`1Gi`
|===

.Kiali parameters
|===
|Parameter |Values |Description  |Default

|username
|valid user
|The user name to use to access the Kiali console. Note that this is not related to any account on OpenShift.
|N/A

|password
|valid password
|The password to use to access the Kiali console. Note that this is not related to any account on OpenShift.
|N/A

|prefix
|valid image repository
|Which prefix to apply to the Kiali image names used in `docker pull` commands.
|If `deployment_type=origin` the default value is `kiali/`.

 If `deployment_type=openshift` the default value is `openshift-istio-tech-preview/`.

|version
|valid Kiali tag
|Which Docker tag to use with Kiali images.
|The default value is `v0.7.2` if `deployment_type=origin`.

 The default value is `0.7.2` if `deployment_type=openshift`.
|===

.Launcher parameters
|===
|Component |Parameter |Description |Default

|openshift
|`user`
|The OpenShift user that you want to run the Fabric8 launcher.
|`developer`

|
|`password`
|The OpenShift user password to run the Fabric8 launcher.
|`developer`

|github
|`username`
|Should be modified to reflect the  https://help.github.com/articles/signing-up-for-a-new-github-account/[GitHub account] you want to use to run the Fabric8 launcher.
|N/A

|
|`token`
|GitHub https://github.com/settings/tokens[personal access token] you want to use to run the Fabric8 launcher.
|N/A

|catalog
|`filter`
|Filter to apply to the Red Hat booster catalog.
|`booster.mission.metadata.istio`

|
|`branch`
|Version of the Red Hat booster catalog that should be used with Fabric8.
|`v62`

|
|`repo`
|GitHub repository to use for Red Hat booster catalog.
|`https://github.com/fabric8-launcher/launcher-booster-catalog.git`
|===


[[installing-operator]]
== Installing the operator
////
TODO
Add an overview of Operators
////
The {ProductShortName} installation process introduces a Kubernetes _operator_ to manage the installation of the control plane within the `istio-system` namespace.  This operator defines and monitors a custom resource related to the deployment, update, and deletion of the control plane.

You can find the https://github.com/Maistra/openshift-ansible/tree/maistra-0.2.0-ocp-3.1.0-istio-1.0.2/istio[operator templates on GitHub].

[NOTE]
====
You *must* name the custom resource `istio-installation`, that is, the metadata value for `name` must be `istio-installation` and you *must* install it into the `istio-operator` namespace that is created by the operator.
====

The following commands install the {ProductShortName} operator into an existing {product-title} 3.10 installation; you can run them from any host with access to the cluster.  Ensure that you are logged in as a cluster admin before executing these commands.

```
$ oc new-project istio-operator
$ oc new-app -f istio_product_operator_template.yaml --param=OPENSHIFT_ISTIO_MASTER_PUBLIC_URL=<master public url>
```
[NOTE]
====
The OpenShift Master Public URL must be configured to match the public URL of your OpenShift Console, this parameter is required by the Fabric8 Launcher.
====


[[verifying-operator-installation]]
== Verifying operator installation

The previous commands create a new deployment within the `istio-operator` project and run the operator responsible for managing the state of the {ProductName} control plane through the custom resource.

. To verify that the operator is installed correctly, execute the following command:
+
```
$ oc get pods -n istio-operator
```
+
. You can access the logs from the `istio-operator` pod with the following command, replacing `<pod name>` with the name of the pod you discovered.
+
```
$ oc logs -n istio-operator <pod name>
```
+
While your exact environment may be different from the example, you should see output that looks similar to the following example:
+
```
time="2018-08-31T17:42:39Z" level=info msg="Go Version: go1.9.4"
time="2018-08-31T17:42:39Z" level=info msg="Go OS/Arch: linux/amd64"
time="2018-08-31T17:42:39Z" level=info msg="operator-sdk Version: 0.0.5+git"
time="2018-08-31T17:42:39Z" level=info msg="Metrics service istio-operator created"
time="2018-08-31T17:42:39Z" level=info msg="Watching resource istio.openshift.com/v1alpha1, kind Installation, namespace istio-operator, resyncPeriod 0"
time="2018-08-31T17:42:39Z" level=info msg="Installing istio for Installation istio-installation"
```

[[deploying-control-plane]]
== Deploying the control plane

You use the custom resource definition file that you created to deploy the {ProductShortName} control plane.  To deploy the control plane, run the following command:
```
$ oc create -f cr.yaml -n istio-operator
```

The operator creates the `istio-system` namespace and runs the installer job; this job installs and configures the control plane using Ansible playbooks.  You can follow the progress of the installation by either watching the pods or the log output from the `openshift-ansible-istio-installer-job` pod.

To watch the progress of the pods, run the following command:
```
$ oc get pods -n istio-system -w
```
