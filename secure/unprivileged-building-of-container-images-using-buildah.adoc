:_mod-docs-content-type: ASSEMBLY
include::_attributes/common-attributes.adoc[]
[id="unprivileged-building-of-container-images-using-buildah"]
= Building of container images using Buildah as a non-root user
:context: unprivileged-building-of-container-images-using-buildah

toc::[]

Running {pipelines-shortname} as the root user on a container can expose the container processes and the host to other potentially malicious resources. You can reduce this type of exposure by running the workload as a specific non-root user in the container.

In most cases, you can run Buildah without root privileges by creating a custom task for building the image and configuring user namespaces in this task.

If your image does not build successfully using this configuration, you can use custom service account (SA) and security context constraint (SCC) definitions; however, if you use this option, you must enable the Buildah step to raise its privileges (`allowPrivilegeEscalation: true`).

include::modules/op-nonroot-buildah-user-namespaces.adoc[leveloffset=+1]

[id="buildah-nonroot-sa-scc"]
== Running Buildah as a non-root user by defining a custom SA and SCC

To run builds of container images using Buildah as a non-root user, you can perform the following steps:

* Define custom service account (SA) and security context constraint (SCC).
* Configure Buildah to use the `build` user with id `1000`.
* Start a task run with a custom config map, or integrate it with a pipeline run.

include::modules/op-configuring-custom-sa-and-scc.adoc[leveloffset=+2]
include::modules/op-configuring-buildah-to-use-build-user.adoc[leveloffset=+2]
include::modules/op-starting-a-task-run-pipeline-run-build-user.adoc[leveloffset=+2]

include::modules/op-limitations-of-unprivileged-builds.adoc[leveloffset=+1]


.Additional resources

* link:https://docs.openshift.com/container-platform/latest/authentication/managing-security-context-constraints.html[Managing security context constraints (SCCs)]
