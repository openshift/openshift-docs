= Authentication
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Overview

You can configure many sources of authentication, as defined in
link:../install_config/configuring_authentication.html[Configuring Authentication].
For now, this topic focuses on GitHub as a source of authentication, but more
providers will be added in a future release.

[[github-auth]]
== GitHub Authentication

GitHub uses OAuth, and you can integrate your OpenShift cluster to use that
OAuth authentication. OAuth basically facilitates a token exchange flow.

Configuring GitHub authentication allows users to log in to OpenShift with their
GitHub credentials. To prevent anyone with a GitHub user ID to log in to your
OpenShift cluster, you can restrict users to require their membership in GitHub
organizations.

[[register-app-on-github]]
=== Registering the Application on GitHub

Before you do an integration like this, you must be a registered client on the
remote service:

. On GitHub, click https://github.com/settings/profile[Settings] ->
https://github.com/settings/applications[OAuth applications] ->
https://github.com/settings/developers[Developer applications] ->
https://github.com/settings/applications/new[Register an application]
to navigate to the page for a
https://github.com/settings/applications/new[new OAuth application].
. Type an application name. For example: `My OpenShift Install`
. Type a homepage URL. For example: `https://myapiserver.com:8443`
. Optionally, type an application description.
. Type the authorization callback URL, where the end of the URL contains the
identity provider *name* (defined in the `*identityProviders*` stanza of the link:../install_config/master_node_configuration.html[*_master configuration file_*], which you configure in the next section of this topic):
+
<apiserver>/oauth2callback/<identityProviderName>
+
For example:
+
https://myapiserver.com:8443/oauth2callback/github/
. Click *Register application*. GitHub provides a Client ID and a Client Secret.
Keep this window open so you can copy these value and paste them into the
master configuration file.

[[configuring-auth-on-master]]
=== Configuring Authentication on the Master

. If you have:
.. Already completed installation of Openshift, then copy the
*_master-config.yaml_* file into a new directory; for example:
+
----
$ mkdir githubconfig; cp master-config.yaml githubconfig
----
.. Not yet installed OpenShift, then start the OpenShift API server, specifying
the hostname of the (future) OpenShift master and a directory to store the
configuration file created by the start command:
+
----
$ openshift start master --public-master=<apiserver> --write-config=<directory>
----
+
For example:
+
----
$ openshift start master --public-master=https://myapiserver.com:8443 --write-config=githubconfig
----
+
[NOTE]
====
If you are installing by Ansible, then you must provide Ansible with the
identityProvider configuration. When installing by Ansible, you probably do not
want to be manually modifying your configuration, because you would lose the
modifications when you re-ran your install, or upgraded. This topic shows you
how to manually handle your configuration, but Ansible users should see ????.

NeedInfo: there is a place you can plug in the identity provider config and
Ansible will drop it into your config for you (see Jason or Scott for details).
====
+
[NOTE]
====
Using `openshift start master` on its own would auto-detect hostnames, but
GitHub must be able to redirect to the exact host name that you specified when
registering the application. For this reason, you cannot auto-detect the ID
because it might redirect to the wrong address. Instead, you must specify the
hostname that web browsers use to interact with your OpenShift cluster.
====
. Edit the new *_master-config.yaml_* file's `*identityProviders*` stanza.
. Copy
link:../install_config/configuring_authentication.html#GitHub[the example `*GitHubIdentityProvider*` configuration]
and paste it to replace the existing stanza.
. Make the following modifications to the `*identityProviders*` stanza:
.. Change the provider `*name*` to match the callback URL you configured on
GitHub.
+
For example, if you defined the callback URL as
`https://myapiserver.com:8443/oauth2callback/github/` then the `*name*` must be
`github`.
.. Change the `*clientID*` to the Client ID from GitHub that you
link:../admin_solutions/authentication.html#register-app-on-github[registered previously].
.. Change the `*clientSecret*` to the Client Secret from GitHub that you
link:../admin_solutions/authentication.html#register-app-on-github[registered previously].
.. Change the `*organizations*` to include a list of one or more GitHub
organizations to which a user must have membership in order to authenticate. If
specified, only GitHub users that are members of at least one of the listed
organizations will be allowed to log in. If this is not specified, then any
person with a valid GitHub account can log in.
. Save your changes and close the file.
. Start the OpenShift API server, specifying the configuration file you just
modified:
+
----
$ openshift start master --config=<path/to/modified/config>/master-config.yaml
----

Once configured, any user logging in to the OpenShift web console will be
prompted to log in using their GitHub credentials. On their first login, the
user must click *authorize application* to permit GitHub to use their username,
password, and organization membership with OpenShift. The user is the redirected
back to the web console.

=== Creating Users

A common question with people who are new to OpenShift is "How can I create
users?"

In this case, you are integrating with an external authentication provider
(GitHub), so OpenShift is not the system of record for users. GitHub is the
external provider of a system of record. You do not create users in OpenShift
when you integrate with an external authenticator. Users are defined by GitHub,
and any GitHub user belonging to a specified organization can log in.

To add a user to OpenShift, you must add that user to an approved organization
on GitHub. If required, create a new GitHub account for the user.

=== Viewing Users

Once one or more users have logged in, you can run `oc get users` to see a list of users:

.Output of `oc get users` command
====

----
$ oc get users
NAME         UID                                    FULL NAME   IDENTITIES
bobsmith     433b5641-066f-11e6-a6d8-acfc32c1ca87   Bob Smith   github:873654 <1>
----
<1> Identities in OpenShift are comprised of the identity provider name and GitHub's internal numeric user ID. It is defined this way, instead of relying on the e-mail address or username attached to the GitHub account, so that if an OpenShift user changes their GitHub username or e-mail then they will still be able to log in to OpenShift. The numeric user ID does not change. This creates a stable login.
====

From here, you might want to learn how to
link:../admin_solutions/user_role_mgmt#control-user-roles[control user roles].
