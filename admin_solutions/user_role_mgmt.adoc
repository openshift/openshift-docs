= User and Role Management
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]

== Overview

As an OpenShift cluster administrator, you are able to manage users, roles, projects, templates, and all available resources. For now, this topic focuses on common operations a cluster administrator needs to perform. You can:

* link:../admin_solutions/user_role_mgmt.html#setting-limits-users-projects[Place quotas and limits on projects],
enabling you to control pod and container limits, object counts, and compute
resources.
* link:../admin_solutions/user_role_mgmt.html#limit-number-projects[Limit the number of projects a user can have]
* link:../admin_solutions/user_role_mgmt.html#control-user-roles[Apply roles to users and service accounts],
enabling you to control what they are able to do in OpenShift projects and in
the cluster.
* link:../admin_solutions/user_role_mgmt.html#control-monitor-resources[Monitor resource usage], enabling you to check the amount of used resources, such as CPU
usage.
* link:../admin_solutions/user_role_mgmt.html#determine-default-user-roles[Determine which roles users get by default]
* link:../admin_solutions/user_role_mgmt.html#share-templates-cluster[Share templates with all projects in the cluster]
* link:../admin_solutions/user_role_mgmt.html#create-cluster-admin[Create other cluster administrators]

== Limiting and Monitoring Users and Projects

[[setting-limits-users-projects]]
=== Setting Limits for Users and Projects

*How can I create limits for users and projects?*

You can place limits within your OpenShift cluster using link:../dev_guide/quota.html[ResourceQuotas] and
link:../dev_guide/limits.html[LimitRanges],
These quotas and limits allow you to control pod and container limits, object
counts, and compute resources. Currently, these limits and quotas only apply to
projects and not to users. However, you can make a quota-like
link:../admin_solutions/user_role_mgmt.html#limit-number-projects[limit on how many project requests a user can make].

*Use Case: I want to create a quota in my "awesomeproject", so that there is a maximum of only 10 pods that can be created in the project.*

. Create a *_resource-quota.json_* file with the following contents:
+
----
apiVersion: v1
kind: ResourceQuota
metadata:
  name: resource-quota
spec:
  hard:
    pods: "10"
----
+
. Create the quota using the file you just wrote to apply it to the "awesomeproject":
+
----
$ oc create -f resource-quota.json -n awesomeproject
----
+
. After creating the limit range object, restart the master service to apply the restriction.
+
----
$ systemctl restart atomic-openshift-master
----
+
. After the quota has been in effect for a little while, you can view the usage statistics for the hard limit set on pods. If required, list the quotas defined in the project to see the names of all defined quotas:
+
====
----
$ oc get quota -n demoproject
NAME                AGE
resource-quota      39m
----
====
+
. Describe the resource quota for which you want statistics:
+
====
----
$ oc describe quota resource-quota -n awesomeproject
Name:			resource-quota
Namespace:		awesomeproject
Resource		Used	Hard
--------		----	----
pods     		3	10
----
====
+
. Optionally, you can
link:../admin_guide/quota.html#configuring-quota-sync-period[configure the quota synchronization period], which controls how long to wait before restoring quota usage after resources are deleted.
. If you want to remove an active quota to no longer enforce the limits of a project:
+
----
$ oc delete quota <quota_name>
----

*Now let's walk through that process and examine all the available options:*

. To create project limits or quotas, you must first write a .yaml file (limits) or .json (quotas) file that describes the resource that you want to restrict:

* This *_LimitRange.yaml_* example explains all the
link:../dev_guide/limits.html#container-limits[container limits] and
link:../dev_guide/limits.html#pod-limits[pod limits] that you can place within
your project:
+
include::dev_guide/limits.adoc[tag=limitrangedef]
+
* These *_ResourceQuota.json_* examples explain all the
link:../admin_guide/quota.html#sample-resource-quota-definitions[Object Counts]
and
link:../admin_guide/quota.html#sample-resource-quota-definitions[Compute Resources] that you can place within your project:
+
include::admin_guide/quota.adoc[tag=resourcequotadefoc]
+
include::admin_guide/quota.adoc[tag=resourcequotadefcr]
+
. Once you have defined your limit range object file, you can create a limit range:
+
----
$ oc create -f <limit_range_file>
----
+
The limit range object is created using the `oc create` primitive, so the rules for which project it exists in follow all of the common OpenShift rules: The command you issue happens in the project that you switched to using `oc project`. Alternatively, you can pass the `-n` flag to specify another project:
+
----
$ oc create -f <limit_range_file> -n <project_name>
----
+
. After creating the limit range object, restart the master service to apply the restriction.
+
----
$ systemctl restart atomic-openshift-master
----

[[limit-number-projects]]
=== Limiting the Number of Projects a User Can Have

You can
link:../admin_guide/managing_projects.html#limit-projects-per-user[limit the number of projects] that a user may request by categorizing users with label selectors with the `oc label` command. A label selector consists of the label name and the label value:

----
label=value
----

Once users are labeled, you must
link:../admin_guide/managing_projects.html#modifying-the-template-for-new-projects[modify the default project template] in the *_master-config.yaml_* file
link:../install_config/configuring_admission_control.html[using an admission control plug-in]. This allows some users to create more projects than others, and you can define different values (or levels) for each label.

*Use Case: You want to define 3 different levels for your users which define how many projects they can request.* The label is named `level`, and the possible values are  `bronze`, `silver`, `gold`, and `platinum`. Platinum users do not have a maximum number of project requests, gold users can request up to 10 projects, silver users up to 7 projects, bronze users up to 5 projects, and any users without a label are by default only allowed 2 projects.

. Apply label selectors to users. For example, to apply the `level` label selector with a value of `bronze`:
+
----
$ oc label user <user_name> level=bronze
----
+
Repeat this step for the other levels.
+
[NOTE]
====
Each user can only have one value per label. For example, a user cannot be both `gold` and `silver` for the level label. However, when configuring the *_master-config.yaml_* file, you could select users that have any value for a label with a wildcard; for example, `level=*`.
====
+
. Optionally, verify the previous step by viewing the list of labeled users for each value:
+
----
$ oc get users -l level=bronze
$ oc get users -l level=silver
$ oc get users -l level=gold
$ oc get users -l level=platinum
----
+
If you need to remove a label from a user to make a correction:
+
----
$ oc label user <user_name> level-
----
. Modify the *_master-config.yaml_* file to define project limits for this label with the numbers stated in this use case. Find the `admissionConfig` line and create the configuration below it:
+
[source,yaml]
----
admissionConfig:
  pluginConfig:
    ProjectRequestLimit:
      configuration:
        apiVersion: v1
        kind: ProjectRequestLimitConfig
        limits:
        - selector:
            level: platinum
        - selector:
            level: gold
          maxProjects: 10
        - selector:
            level: silver
          maxProjects: 7
        - selector:
            level: bronze
          maxProjects: 5
        - maxProjects: 2
----
+
. After modifying the *_master-config.yaml* file, you must restart the master for changes to take effect.
+
----
$ systemctl restart atomic-openshift-master
----

[NOTE]
====
If you customize the default project template, you must ensure that you keep the
modifications by
link:../install_config/configuring_admission_control.html[configuring the rules].
====

[[control-monitor-resources]]
=== Controlling and Monitoring Resource Usage

If you configure a project to have ResourceQuota restrictions, then the amount
of the defined quota currently being used is stored on the ResourceQuota object
itself. In that case, you could check the amount of used resources, such as CPU
usage:

----
$ oc get quota
----

However, this would not tell you what is actually being consumed.
To determine what is actually being consumed, use the `oc describe` command:

----
$ oc describe quota <quota-name>
----

Alternatively, you can set up
link:../install_config/cluster_metrics.html[cluster metrics] for more detailed statistics.

[[determine-default-user-roles]]
== Determining Which Roles Users Get by Default

When a user first logs in, there is a default set of permissions that is
applied to that user. The scope of permissions that a user can have is
controlled by the
link:../architecture/additional_concepts/authorization.html[various types] of
link:../admin_guide/manage_authorization_policy.html[roles within OpenShift]:

- `ClusterRoles`
- `ClusterRoleBindings`
- `Roles` (project-scoped)
- `RoleBindings` (project-scoped)

You may want to modify the default set of permissions. In order to do this, it's important to understand the default groups and roles assigned, and to be aware of the roles and users bound to
link:../admin_solutions/user_role_mgmt.html#view-roles-users-project[each project] or
link:../admin_solutions/user_role_mgmt.html#view-roles-users-cluster[the entire cluster].

=== Leveraging Default Groups

There are special groups that are assigned to users. You can target users with these groups, but you cannot modify them. These special groups are as follows:

[options="header"]
|===

|Group |Description

|`system:authenticated`
|This is assigned to all users who are identifiable to the API. Everyone who is not `system:anonymous` (the user) is in this group.

|`system:authenticated:oauth`
|This is assigned to all users who have identified using an oauth token issued by the embedded oauth server. This is not applied to service accounts (they use service account tokens), or certificate users.

|`system:unauthenticated`
|This is assigned to users who have not presented credentials. Invalid credentials are rejected with a 401 error, so this is specifically users who did not try to authenticate at all.
|===

You may find it helpful to target users with the special groups listed above. For example, you could share a pod with all users by granting `system:authenticated` access to the pod.

The "default" permissions of users are defined by which roles are bound to the
`system:authenticated` and `sytem:authenticated:oauth` groups. As mentioned
above, you are not able to modify membership to these groups, but you can
link:../admin_guide/manage_authorization_policy.html#managing-role-bindings[change the roles bound to these groups]. For example, to bind a role to the `system:authenticated` group for all projects in the cluster:

----
$ oadm policy add-cluster-role-to-group <role> system:authenticated
----

Currently, by default the `system:authenticated` and `sytem:authenticated:oauth`
groups receive the following roles:

[options="header"]
|===

|Role |Description

|`shared-resource-viewer`
|For the `openshift` project: allows users to see templates and pull images.

|`basic-user`
|For the the entire cluster: allows users to see their own account, check for information about requesting projects, see which projects they can view, and check their own permissions.

|`self-provisioner`
|Allows users to request projects.

|`system:oauth-token-deleter`
|Allows users to delete any oauth token for which they know the details.

|`cluster-status`
|Allows users to see which APIs are enabled, and basic API server information such as versions.

|`system:webhook`
|Allows users to hit the webhooks for a build if they have enough additional information.
|===

[[view-roles-users-project]]
=== Viewing Roles and Users for a Project
You can view a list of all the users that are bound to the project, and the
roles to which they are bound. To view permissions per-project:

====
----
$ oc get rolebindings
NAME                    ROLE                    USERS     GROUPS                                 SERVICE ACCOUNTS   SUBJECTS
system:image-pullers    /system:image-puller              system:serviceaccounts:asdfasdf4asdf
admin                   /admin                  jsmith
system:deployers        /system:deployer                                                         deployer
system:image-builders   /system:image-builder                                                    builder
----
====

[[view-roles-users-cluster]]
=== Viewing Roles and Users for the Cluster
You can view which users have access to which things across the entire
cluster. To view cluster-wide permissions:

====
----
$ oc get clusterrolebindings
NAME                                            ROLE                                       USERS           GROUPS                                         SERVICE ACCOUNTS                                   SUBJECTS
system:job-controller                           /system:job-controller                                                                                    openshift-infra/job-controller
system:build-controller                         /system:build-controller                                                                                  openshift-infra/build-controller
system:node-admins                              /system:node-admin                         system:master   system:node-admins
registry-registry-role                          /system:registry                                                                                          default/registry
system:pv-provisioner-controller                /system:pv-provisioner-controller                                                                         openshift-infra/pv-provisioner-controller
basic-users                                     /basic-user                                                system:authenticated
system:namespace-controller                     /system:namespace-controller                                                                              openshift-infra/namespace-controller
system:discovery-binding                        /system:discovery                                          system:authenticated, system:unauthenticated
system:build-strategy-custom-binding            /system:build-strategy-custom                              system:authenticated
cluster-status-binding                          /cluster-status                                            system:authenticated, system:unauthenticated
system:webhooks                                 /system:webhook                                            system:authenticated, system:unauthenticated
system:gc-controller                            /system:gc-controller                                                                                     openshift-infra/gc-controller
cluster-readers                                 /cluster-reader                                            system:cluster-readers
system:pv-recycler-controller                   /system:pv-recycler-controller                                                                            openshift-infra/pv-recycler-controller
system:daemonset-controller                     /system:daemonset-controller                                                                              openshift-infra/daemonset-controller
cluster-admins                                  /cluster-admin                             system:admin    system:cluster-admins
system:hpa-controller                           /system:hpa-controller                                                                                    openshift-infra/hpa-controller
system:build-strategy-source-binding            /system:build-strategy-source                              system:authenticated
system:replication-controller                   /system:replication-controller                                                                            openshift-infra/replication-controller
system:sdn-readers                              /system:sdn-reader                                         system:nodes
system:build-strategy-docker-binding            /system:build-strategy-docker                              system:authenticated
system:routers                                  /system:router                                             system:routers
system:oauth-token-deleters                     /system:oauth-token-deleter                                system:authenticated, system:unauthenticated
system:node-proxiers                            /system:node-proxier                                       system:nodes
system:nodes                                    /system:node                                               system:nodes
self-provisioners                               /self-provisioner                                          system:authenticated:oauth
system:service-serving-cert-controller          /system:service-serving-cert-controller                                                                   openshift-infra/service-serving-cert-controller
system:registrys                                /system:registry                                           system:registries
system:pv-binder-controller                     /system:pv-binder-controller                                                                              openshift-infra/pv-binder-controller
system:build-strategy-jenkinspipeline-binding   /system:build-strategy-jenkinspipeline                     system:authenticated
system:deployment-controller                    /system:deployment-controller                                                                             openshift-infra/deployment-controller
system:masters                                  /system:master                                             system:masters
system:service-load-balancer-controller         /system:service-load-balancer-controller                                                                  openshift-infra/service-load-balancer-controller
----
====

These commands can generate huge lists, so you may want to pipe the output into a text file that you can search through more easily.

[[control-user-roles]]
== Controlling User Permissions with Roles

You may want to define
link:../admin_guide/manage_authorization_policy.html[roles] (or permissions) for a user, even before they ever logged in. That way when they first log in, their roles are already configured and they can start working immediately. You can assign many different types of roles to users such as admin, basic-user, self-provisioner, and cluster-reader.

For a complete list of all available roles:

----
$ oadm policy
----

The following section includes examples of some common operations related to
adding (binding) and removing roles from users and groups. For a complete list
of available local policy operations, see
link:../admin_guide/manage_authorization_policy.html#managing-role-bindings[Managing Role Bindings].

=== Adding a Role to a User

To bind a role to a user for the current project:

----
$ oadm policy add-role-to-user <role> <user_name>
----

You can specify a project with the `-n` flag.

=== Removing a Role from a User

To remove a role from a user for the current project:

----
$ oadm policy remove-role-from-user <role> <user_name>
----

You can specify a project with the `-n` flag.

=== Adding a Role to a User for All Projects

To bind a role to a user for all projects in the cluster:

----
$ oadm policy add-cluster-role-to-user <role> <user_name>
----

=== Removing a Role from a User for All Projects

To remove a role from a user for all projects in the cluster:

----
$ oadm policy remove-cluster-role-from-user <role> <user_name>
----

=== Adding a Role to a Group

To bind a role to a specified group in the current project:

----
$ oadm policy add-role-to-group <role> <groupname>
----

You can specify a project with the `-n` flag.

=== Removing a Role from a Group

To remove a role from a specified group in the current project:

----
$ oadm policy remove-role-from-group <role> <groupname>
----

You can specify a project with the `-n` flag.

=== Adding a Role to a Group for All Projects

To bind a role to a specified group for all projects in the cluster:

----
$ oadm policy add-cluster-role-to-group <role> <groupname>
----

=== Removing a Role from a Group for All Projects

To remove a role from a specified group for all projects in the cluster:

----
$ oadm policy remove-cluster-role-from-group <role> <groupname>
----

[[share-templates-cluster]]
== Sharing Templates for Use in Projects Across the Cluster

Templates are project-scoped resources, so you cannot create them to be readily
available at a cluster level. The easiest way to share templates across the entire
cluster is with the `openshift` project, which by default is already set up to
share templates. The templates can be annotated, and are displayed in the web
console where users can access them. Users have "get" access only to the
templates and images in this project, via the `shared-resource-viewer` role.

The `shared-resource-viewer` role exists to allow templates to be shared across
project boundaries. Granting a user this role for a project gives them the ability to see all existing templates and pull images from that project.
However, the user still needs to know which project to look in, because they will not be able to view the project in their `oc get projects` list.

If you would prefer to share templates across the cluster using your own project instead of the default `openshift` project, you can grant users the `shared-resource-viewer` role to that project:

----
$ oadm policy add-role-to-user shared-resource-viewer <user_name> -n <project_name>
----

The users you grant the `shared-resource-viewer` role to can see what's in the project, but they cannot destroy anything, so this is a safe way to share your templates.

By default, this role is granted to the `system:authenticated` group in the
`openshift` project. This allows users to perform actions such as:

----
$ oc process openshift//<template-name> | oc create -f -
----

The above command processes the specified template from the `openshift` project and creates the items in the current project (which is not necessarily the "openshift" project).

You can also add the registry viewer role to a user, allowing them to view and pull images from a project:

----
$ oc policy add-role-to-user registry-viewer <user-name>
----

[[create-cluster-admin]]
== How to Create a Cluster Admin User

Cluster Administrator is a very powerful role, which has ultimate control within the cluster, including the power to destroy that cluster. You can grant this role to other users if they absolutely need to have ultimate control. However, you may first want to examine the other available roles if you do not want to create such a powerful user. For example, `Admin` is a constrained role that has the power to do many things inside of their project, but cannot affect (or destroy!) the entire cluster.

=== Create an Administrator Within a Project

To create a basic administrator role within a project:

----
$ oadm policy add-role-to-user admin <user_name> -n <project_name>
----

=== Creating a Cluster Administrator

To create a cluster administrator with ultimate control over the cluster:

[WARNING]
====
Be very careful when granting cluster administrator role to a user. Ensure that
the user truly needs that level of power within the cluster. When OpenShift is
first installed, a certificate based user is created and the credentials are
saved in *_admin.kubeconfig_*. This cluster administrator user can do absolutely
anything to any resource on the entire cluster, which can result in destruction
if not used carefully.
====

----
$ oadm policy add-cluster-role-to-user cluster-admin <user_name>
----
