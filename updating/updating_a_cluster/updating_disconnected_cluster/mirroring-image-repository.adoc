:_mod-docs-content-type: ASSEMBLY
[id="mirroring-ocp-image-repository"]
= Mirroring {product-title} images
include::_attributes/common-attributes.adoc[]
:context: mirroring-ocp-image-repository

toc::[]

////
WARNING: This assembly has been moved into a subdirectory for 4.14+. Changes to this assembly for earlier versions should be done in separate PRs based off of their respective version branches. Otherwise, your cherry picks may fail.

To do: Remove this comment once 4.13 docs are EOL.
////

You must mirror container images onto a mirror registry before you can update a cluster in a disconnected environment. You can also use this procedure in connected environments to ensure your clusters run only approved container images that have satisfied your organizational controls for external content.

[NOTE]
====
Your mirror registry must be running at all times while the cluster is running.
====

The following steps outline the high-level workflow on how to mirror images to a mirror registry:

. Install the OpenShift CLI (`oc`) on all devices being used to retrieve and push release images.

. Download the registry pull secret and add it to your cluster.

. If you use the xref:../../../updating/updating_a_cluster/updating_disconnected_cluster/mirroring-image-repository.adoc#mirroring-ocp-resources-ocmirror[oc-mirror OpenShift CLI (`oc`) plugin]:

.. Install the oc-mirror plugin on all devices being used to retrieve and push release images.

.. Create an image set configuration file for the plugin to use when determining which release images to mirror. You can edit this configuration file later to change which release images that the plugin mirrors.

.. Mirror your targeted release images directly to a mirror registry, or to removable media and then to a mirror registry.

.. Configure your cluster to use the resources generated by the oc-mirror plugin.

.. Repeat these steps as needed to update your mirror registry.

. If you use the xref:../../../updating/updating_a_cluster/updating_disconnected_cluster/mirroring-image-repository.adoc#update-mirror-repository-adm-release-mirror_mirroring-ocp-image-repository[`oc adm release mirror` command]:

.. Set environment variables that correspond to your environment and the release images you want to mirror.

.. Mirror your targeted release images directly to a mirror registry, or to removable media and then to a mirror registry.

.. Repeat these steps as needed to update your mirror registry.

Compared to using the `oc adm release mirror` command, the oc-mirror plugin has the following advantages:

* It can mirror content other than container images.

* After mirroring images for the first time, it is easier to update images in the registry.

* The oc-mirror plugin provides an automated way to mirror the release payload from Quay, and also builds the latest graph data image for the OpenShift Update Service running in the disconnected environment.

[id=mirroring-ocp-resources-ocmirror]
== Mirroring resources using the oc-mirror plugin

You can use the oc-mirror OpenShift CLI (`oc`) plugin to mirror images to a mirror registry in your fully or partially disconnected environments. You must run oc-mirror from a system with internet connectivity to download the required images from the official Red{nbsp}Hat registries.

See xref:../../../installing/disconnected_install/installing-mirroring-disconnected.adoc#installing-mirroring-disconnected[Mirroring images for a disconnected installation using the oc-mirror plugin] for additional details.

[id="update-mirror-repository-adm-release-mirror_{context}"]
== Mirroring images using the oc adm release mirror command

You can use the `oc adm release mirror` command to mirror images to your mirror registry.

[id="prerequisites_updating-mirroring-disconnected"]
=== Prerequisites

* You must have a container image registry that supports link:https://docs.docker.com/registry/spec/manifest-v2-2[Docker v2-2] in the location that will host the {product-title} cluster, such as Red Hat Quay.
+
[NOTE]
====
If you use Red Hat Quay, you must use version 3.6 or later with the oc-mirror plugin. If you have an entitlement to Red Hat Quay, see the documentation on deploying Red Hat Quay link:https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploy_red_hat_quay_for_proof-of-concept_non-production_purposes/[for proof-of-concept purposes] or link:https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploying_the_red_hat_quay_operator_on_openshift_container_platform/index[by using the Quay Operator]. If you need additional assistance selecting and installing a registry, contact your sales representative or Red Hat Support.
====
+
If you do not have an existing solution for a container image registry, the xref:../../../installing/disconnected_install/installing-mirroring-creating-registry.adoc#installing-mirroring-creating-registry[mirror registry for Red Hat OpenShift] is included in {product-title} subscriptions. The _mirror registry for Red Hat OpenShift_ is a small-scale container registry that you can use to mirror {product-title} container images in disconnected installations and updates.

[id="updating-restricted-network-mirror-host"]
=== Preparing your mirror host

Before you perform the mirror procedure, you must prepare the host to retrieve content and push it to the remote location.

// Installing the OpenShift CLI by downloading the binary
include::modules/cli-installing-cli.adoc[leveloffset=+3]

[role="_additional-resources"]
.Additional resources

* xref:../../../cli_reference/openshift_cli/extending-cli-plugins.adoc#cli-installing-plugins_cli-extend-plugins[Installing and using CLI plugins]

// Configuring credentials that allow images to be mirrored
include::modules/installation-adding-registry-pull-secret.adoc[leveloffset=+3]

// Mirroring images using the oc adm release mirror command
include::modules/update-mirror-repository.adoc[leveloffset=+2]