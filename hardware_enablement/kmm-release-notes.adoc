:_mod-docs-content-type: ASSEMBLY
[id="kmm-release-notes"]
= Kernel Module Management Operator release notes
include::_attributes/common-attributes.adoc[]
:context: kmm-release-notes

toc::[]

[id="kmm-2-2-RN"]
== Release notes for Kernel Module Management Operator 2.2
=== New features
// TELCODOCS-2022
* KMM is now using the CRI-O container engine to pull container images in the worker pod instead of using HTTP calls directly from the worker container. For more information, see xref:../hardware_enablement/kmm-kernel-module-management.adoc#kmm-example-cr_kernel-module-management-operator[Example Module CR].

// TELCODOCS-2028
* The Kernel Module Management (KMM) Operator images are now based on `rhel-els-minimal` container images instead of the `rhel-els` images. This change results in a greatly reduced image footprint, while still maintaining FIPS compliance.

// TELCODOCS-1994
* In this release, the firmware search path has been updated to copy the contents of the specified path into the path specified in worker.setFirmwareClassPath (default: /var/lib/firmware). For more information, see xref:../hardware_enablement/kmm-kernel-module-management.adoc#kmm-example-cr_kernel-module-management-operator[Example Module CR].

// TELCODOCS-1977
* For each node running a kernel matching the regular expression, KMM now checks if you have included a tag or a digest. If you have not specified a tag or digest in the container image, then the validation webhook returns an error and does not apply the module. For more information, see xref:../hardware_enablement/kmm-kernel-module-management.adoc#kmm-example-cr_kernel-module-management-operator[Example Module CR].

[id="kmm-2-3-RN"]
== Release notes for Kernel Module Management Operator 2.3
=== New features
// TELCODOCS-2221
* In this release, KMM uses version 1.23 of the Golang programming language to ensure test continuity for partners.

// TELCODOCS-2197
* You can now schedule KMM pods by defining taints and tolerations. For more information, see xref:../hardware_enablement/kmm-kernel-module-management.adoc#kmm-using-tolerations-for-kernel-module-scheduling_kernel-module-management-operator[Using tolerations for kernel module scheduling].

[id="kmm-2-4-RN"]
== Release notes for Kernel Module Management Operator 2.4
=== New features
// TELCODOCS-2343
* A new feature in this release is the addition of a preflight validation resource in the cluster that you can use to verify kernel modules to be installed on the nodes after cluster upgrades and possible kernel upgrades. Preflight validation also reports on the status and progress of each module in the cluster that it attempts or has attempted to validate. For more information, see xref:../updating/preparing_for_updates/kmm-preflight-validation.adoc#kmm-validation-kickoff_kmm-preflight-validation[Preflight validation for Kernel Module Management (KMM) Modules].

// TELCODOCS-2344
* In this release, a new requirement when creating a kmod image is that both the `.ko` kernel module files and the `cp` binary must be included, which is required for copying files during the image loading process.
For more information, see xref:../hardware_enablement/kmm-kernel-module-management.adoc#kmm-creating-kmod-image_kernel-module-management-operator[Creating a kmod image].

// TELCODOCS-2311
* In this release, you now have the option to configure KMM Module to not load an out-of-tree kernel driver and use the in-tree driver instead and run only the device plugin. For more information see xref:../hardware_enablement/kmm-kernel-module-management.adoc#kmm-using-intree-modules_kernel-module-management-operator[Using in-tree modules].

// TELCODOCS-2304
* In this release, KMM configurations are now persistent following cluster and KMM Operator upgrades and redeployments of KMM. 
+
In earlier releases, a cluster or KMM upgrade, or any other intentional or unintentional action, such as upgrading a non-default configuration like the firmware path that redeploys KMM, could create the need to reconfigure KMM. In this release, KMM configurations now remain persistent regardless of any of these actions.
+
For more information see xref:../hardware_enablement/kmm-kernel-module-management.adoc#kmm-configuring-kmmo_kernel-module-management-operator[Configuring the Kernel Module Management Operator].

=== Bug fixes
// MGMT-16797
* Creating or deleting the image / Creating an MCM module does not load the module on the spoke. 

** *Cause*: On a Hub/Spoke setup, when creating or deleting the image in registry, or when creating a `ManagedClusterModule` (MCM),Â the module on the spoke cluster is not loaded.

** *Consequence*: The module on the spoke is not created.

** *Fix*: Remove the cache package and image translation from the Hub/Spoke setup.

** *Result:* The module on the spoke is created for the second time the MCM object is created.

// MGMT-19859
* KMM cannot pull images from the private registry while doing in-cluster builds.

** *Cause*: The Kernel Module Management (KMM) Operator cannot pull images from private registry while doing in-cluster builds.

** *Consequence*: Images in private registries that are used in the build process can not be pulled.

** *Fix*: The `imageRepoSecret` configuration is now also used in the build process. The `imageRepoSecret` specified has to include ALL registries being used.

** *Result:* Private registries can now be used when doing in-cluster builds.

// MGMT-19897
* KMM worker pod is orphaned when deleting a module with a container image that can not be pulled. 

** *Cause*: A Kernel Module Management (KMM) Operator worker pod is orphaned when deleting a module with a container image that can not be pulled.

** *Consequence*: Failing worker pods are left on the cluster and at no point being collected for garbage.

** *Fix*: KMM will now garbage collect orphaned failing pods upon the modules deletion.

** *Result:* The module is successfully deleted, and all associated orphaned failing pods are also deleted.

// MGMT-19898
* The KMM Operator tries to create a MIC even when the node selector does not match.

** *Cause*: The Kernel Module Management (KMM) Operator tries to create a 'ModuleImagesConfig' (MIC) resource even when the node selector does not match with any actual nodes and fails.

** *Consequence*: The KMM Operator is getting and error when reconciling a module that does not target any node.

** *Fix*: The 'Images' field in the MIC resource is now optional.

** *Result:* The KMM Operator can successfully create the MIC resource even when there are no images in it.

// MGMT-20247
* KMM does not reload the kernel module in case the node reboot sequence is too quick.

** *Cause*: The Kernel Module Management (KMM) Operator does not reload the kernel module in case the node reboot sequence is too quick. The reboot is determined based on the timestamp of the status condition being later than the timestamp in the Node Machine Configuration (NMC) status.

** *Consequence*: When the reboot happens quickly, in less time than the grace period, the node state will not change. After the node reboots, KMM will not load the kernel module again.

** *Fix*: Instead of relying on the condition state, NMC can rely on the `Status.NodeInfo.BootID` field. This field is set by kubelet based on the /proc/sys/kernel/random/boot_id file of the server node, so it is updated after each reboot.

** *Result:* The more accurate timestamps enable the Kernel Module Management (KMM) Operator to reload the kernel module after the node reboot sequence.

// MGMT-20248
* Filtering out node heartbeats events for the NMC controller.

** *Cause*: The Node Machine Configuration (NMC) controller gets spammed with events from node heartbeats. The node heartbeats are there to let the Kubernetes API server know that the node is still connected and functional.

** *Consequence*: The spamming causes a constant reconciliation even when no Module, and therefore no NMC, are applied to the cluster.

** *Fix*: The NMC controller will now filter the node's heartbeat from its reconciliation loop.

** *Result:* The NMC controller only gets real events and filters out node heartbeats.

// MGMT-20286
* NMC status contains toleration values, even though there are no tolerations in the NMC.spec or in the Module. 

** *Cause*: The Node Machine Configuration (NMC) status contains toleration values, even though there are no tolerations in the NMC.spec or in the Module.

** *Consequence*: Tolerations other than Kernel Module Management-specific tolerations can appear in the status.

** *Fix*: The NMC status now gets its toleration from a dedicated annotation rather than from the worker pod.

** *Result:* The NMC status only contains the Module's tolerations.

// MGMT-20725
* The KMM Operator version 2.4 fails to start properly and cannot list the resource `\modulebuildsignconfigs\`. 

** *Cause*: On the Kernel Module Management (KMM) Operator, when the Operator is installed using Red Hat Konflux it does not start properly as the log files contain errors.

** *Consequence*: The KMM Operator does not work as expected.

** *Fix*: The Cluster Service Version (CSV) file was updated to list the resources `\modulebuildsignconfigs\` and `moduleimagesconfig`.

** *Result:* The KMM Operator works as expected.

// MGMT-20752
* Konflux build does not include version and git commit in the operator logs.

** *Cause*: On the Kernel Module Management (KMM) Operator, when the Operator was built using Communications Platform as a Service (CPaas), the build included the Operator version and git commit in the log  files. However, with Red Hat Konflux these details are not included in the log files.

** *Consequence*: Important information is missing from the log files.

** *Fix*: Some adjustments were made in Konflux.

** *Result:* The KMM Operator build now includes the Operator version and git commit in the log files.

// MGMT-20754
* The KMM Operator does not load the module after node with taint is rebooted.

** *Cause*: The Kernel Module Management (KMM) Operator does not reload the kernel module in case the node reboot sequence is too quick. The reboot is determined based on the timestamp of the status condition being later than the timestamp in the Node Machine Configuration (NMC) status.

** *Consequence*: When the reboot happens quickly, in less time than the grace period, the node state will not change. After the node reboots, KMM will not load the kernel module again.

** *Fix*: Instead of relying on the condition state, NMC can rely on the `Status.NodeInfo.BootID` field. This field is set by kubelet based on the /proc/sys/kernel/random/boot_id file of the server node, so it is updated after each reboot.

** *Result:* The more accurate timestamps enable the Kernel Module Management (KMM) Operator to reload the kernel module after the node reboot sequence.

// MGMT-20775
* Redeploying a module that uses in-cluster builds fails with the `ImagePullBackOff` policy.

** *Cause*: On the Kernel Module Management (KMM) Operator, the `pullPolicy` for the puller pod and the worker pod is different.

** *Consequence*: An image can be considered as existing while it fact it is not.

** *Fix*: Make the pull policy of the pull pod the same as the pull policy defined in the KMM Module, as this is what is used by the worker pod.

** *Result:* The MIC will represent the state of the image in the same way the worker pod will be able to access it.

// MGMT-20785
* The MIC controller creates two pull-pods when it should create just one.

** *Cause*: On the Kernel Module Management (KMM) Operator, the `ModuleImagesConfig` (MIC) controller may create multiple pull-pods for the same image.

** *Consequence*: Resources are wasted and confusion is caused.

** *Fix*: The `CreateOrPatch` MIC API receives a slice of `ImageSpecs`, as the input is created by going over the the target nodes and adding their images to the slice, so any duplicate `ImageSpecs`, are now filtered out.

** *Result:* The KMM Operator works as expected.

// MGMT-20827
* The `job.dcDelay` example in the documentation should specify `0s` instead of 0.

** *Cause*: The Kernel Module Management (KMM) Operator default `job.gcDelay` duration field is 0s but the documentation says it is `0`.

** *Consequence*: This can lead a customer in the wrong direction setting a custom value of 60 instead of 60s or 1m that will resolve in an error due to the wrong input type.

** *Fix*: The `job.gcDelay` in the documentation is updated to have a default value of 0s.

** *Result:* Users are less likely to get confused.

// MGMT-20835
* The KMM Operator Hub environment does not work because of missing MIC and MBSC CRDs.

** *Cause*: The Kernel Module Management (KMM) Operator Hub environment only generates Custom Resource Definitions (CRD) files based on the 'api-hub/' directory. As a result, this does not contain some CRDs required for the KMM Operator Hub environment, such as, 'ModuleImagesConfig' (MIC) resource and Managed Kubernetes Service (MBSC).

** *Consequence*: The KMM Operator Hub environment can not work because it tries to start controllers reconciling CRDs that do not exist in the cluster.

** *Fix*: The fix generates all CRD files into the 'config/crd-hub/bases' directory, but only applies the resources to the cluster that it actually needs.

** *Result:* The KMM Operator Hub environment works as expected.

// MGMT-20852
* The KMM Operator Hub environment cannot build when finalisers can not be set on a resource.

** *Cause*: The Kernel Module Management (KMM) Operator displays an error with the 'ManagedClusterModule' controller failing to build. This is due to the missing 'ModuleImagesConfig' (MIC) resource finalizers and Role-based Action Control (RBAC) permissions for the KMM Operator Hub environment.

** *Consequence*: The KMM Operator Hub environment cannot build images.

** *Fix*: The RBAC permissions are updated to allow updating finalizers on the MIC resource, and then the appropriate rules created.

** *Result:* The KMM Operator Hub environment builds images without errors with the 'ManagedClusterModule' controller.

// MGMT-20861
* The 'PreflightValidation' custom resource, with a `kernelVersion: tesdt` causes the KMM Operator to panic.

** *Cause*: Creating a `PreflightValidation` custom resource (CR), with a 'kernelVersion' flag that is set to 'tesdt', causes the Kernel Module Management (KMM) Operator to generate a panic runtime error.

** *Consequence*: Entering invalid kernel versions causes the KMM Operator to panic.

** *Fix*: A webhook - a method for one application to automatically send real-time data to another application when a specific event occurs - has been added to the `PreflightValidation` CR.

** *Result:* The `PreflightValidationOCP` CR with invalid kernel versions can no longer be applied to the cluster, therefore, preventing the operator from generating a panic runtime error.

// MGMT-20866
* The `PreFflightValidation` custom resource, with a `kernelVersion` flag that is different that the one of the cluster, does not work.

** *Cause*: Creating a `PreflightValidation` custom resource (CR), with a 'kernelVersion' flag that is different from the one of the cluster, does not work.

** *Consequence*: The Kernel Module Management (KMM) Operator is unable to find the Driver Toolkit (DTK) input image for the new kernel version.

** *Fix*: Users should use the `PreflightValidationOCP` CR and explicitly set the 'dtkImage' field in the CR.

** *Result:* Using the fields `kernelVersion` and `dtkImage` the feature can build installed modules for target {product-title} versions.

// MGMT-20888
* The KMM Operator version 2.4 documentation is updated with `PreflightValidationOCP` information.

** *Cause*: Previously, when creating an `PreflightValidationOCP` CR, you were required to supply the release-image. This has now changed and you need to set the `kernelVersion` the `dtkImage` fields.

** *Consequence*: The documentation was outdated and required an update.

** *Fix*: The documentation is updated with the new support details.

** *Result:* The KMM preflight feature is documented as expected.

// MGMT-20892
* Using imageRepoSecret in conjunction with DTK as imagestream gets authorization required error.

** *Cause*: On the Kernel Module Management (KMM) Operator, when you set the `imageRepoSecret` in the KMM module, and the build's resulting container image is defined to be stored in the cluster's internal registry, the build will fail to push the final image and generate an `authorization required` error.

** *Consequence*: The KMM Operator does not work as expected.

** *Fix*: When the `imageRepoSecret` is user-defined, it is used as both a pull and push secret by the build process. In order to support using the cluster's internal regsitry, the auth token for that registry needs to be added to the `imageRepoSecret`. The token can be obtained from the "build" service account of the KMM module's namespace.

** *Result:* The KMM Operator works as expected.

// test

=== Known issues
// MGMT-20453 changed security settings in jira
* The `ModuleUnloaded` event does not appear when a module is Unloaded.

** *Cause*: When a module is Loaded (using the create a 'ModuleLoad' event) or Unloaded (using the create a 'ModuleUnloaded' event) the events may not appear. This happens when you load and unload the kernel module in a quick succession.

** *Consequence*: The 'ModuleLoad' and 'ModuleUnloaded' events may not appear in {product-title}.

** *Fix*: Alerting the user of this potential behavior and for awareness when working with modules.

** *Result:* Not yet available. 


