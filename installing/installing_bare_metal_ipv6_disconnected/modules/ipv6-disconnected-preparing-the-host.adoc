// Module included in the following assemblies:
//
// * list of assemblies where this module is included
// ipv6-disconnected-server-setup.adoc

[id="ipv6-disconnected-preparing-the-host_{context}"]

= Preparing the host

For more information, see https://github.com/openshift-kni/baremetal-deploy/blob/master/install-steps.md#preparing-the-provision-node-for-openshift-install[Preparing the Provision node for OpenShift Install].

.Procedure

. Create a user (`kni`) to deploy as non-root and provide that user with sudo privileges.
+
----
# useradd kni
# echo "kni ALL=(root) NOPASSWD:ALL" | tee -a /etc/sudoers.d/kni
# chmod 0440 /etc/sudoers.d/kni
# su - kni -c "ssh-keygen -t rsa -f /home/kni/.ssh/id_rsa -N ''"
# dnf install -y libvirt qemu-kvm mkisofs python3-devel jq ipmitool
# usermod --append --groups libvirt kni
# systemctl start firewalld
# firewall-cmd --zone=public --add-service=http --permanent
# firewall-cmd --zone=public --add-port=123/udp
# firewall-cmd --add-port=5000/tcp --zone=libvirt  --permanent
# firewall-cmd --add-port=5000/tcp --zone=public   --permanent
# firewall-cmd --reload
# systemctl start libvirtd
# systemctl enable libvirtd --now
# virsh pool-define-as --name default --type dir --target /var/lib/libvirt/images
# virsh pool-start default
# virsh pool-autostart default

# export PUB_CONN=<baremetal_nic_name>     #here eno3
# export PROV_CONN=<prov_nic_name>           #here eno1
# nohup bash -c '
    nmcli con down "$PROV_CONN"
    nmcli con down "$PUB_CONN"
    nmcli con delete "$PROV_CONN"
    nmcli con delete "$PUB_CONN"
    # RHEL 8.1 appends the word "System" in front of the connection, delete in case it exists
    nmcli con down "System $PUB_CONN"
    nmcli con delete "System $PUB_CONN"
    nmcli connection add ifname provisioning type bridge con-name provisioning
    nmcli con add type bridge-slave ifname "$PROV_CONN" master provisioning
    nmcli connection add ifname baremetal type bridge con-name baremetal
    nmcli con add type bridge-slave ifname "$PUB_CONN" master baremetal
    nmcli con down "$PUB_CONN";pkill dhclient;dhclient baremetal
    nmcli connection modify provisioning ipv4.addresses 172.22.0.1/24 ipv4.method manual
    nmcli con down provisioning
    nmcli con up provisioning
'
----

. Verify the connection bridges and nodes have been properly created.
+
----
NAME               UUID                                  TYPE      DEVICE
baremetal          726bc45e-0566-41ac-9be4-b23d40d8dbb0  bridge    baremetal
provisioning       9a1a457c-fb09-4630-9fed-2f76246dc7cf  bridge    provisioning
virbr0             9826f90d-5b62-4558-a1af-474626f03ad6  bridge    virbr0
bridge-slave-eno1  dfada68d-de45-4c31-9602-123116a1c694  ethernet  eno1
bridge-slave-eno3  904a6e37-229d-44b6-b672-6e15684166e5  ethernet  eno3
eno2               523fbcf4-f88d-42e2-b210-1375c80c9ee3  ethernet  --
eno4               2a415a3c-8702-4d27-98d2-59801a34d889  ethernet  --
enp3s0f0           e92835a2-fbfc-4323-b8c9-2a6b39db0a14  ethernet  --
enp3s0f1           ae8e0900-11af-4d1f-ae40-5fa66f8a2cfc  ethernet  --
enp3s0f2           c8e228c0-f706-451e-aaad-0d2889632ca6  ethernet  --
enp3s0f3           e6d034f4-900f-44ff-a90a-15a4d7aa4b9c  ethernet  --

# ip addr show provisioning
11: provisioning: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 14:9e:cf:c5:30:a3 brd ff:ff:ff:ff:ff:ff
    inet 172.22.0.1/24 brd 172.22.0.255 scope global noprefixroute provisioning
       valid_lft forever preferred_lft forever
    inet6 fe80::99de:813c:2744:e1/64 scope link noprefixroute
       valid_lft forever preferred_lft forever

# ip addr show baremetal
10: baremetal: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 14:9e:cf:c5:38:19 brd ff:ff:ff:ff:ff:ff
    inet6 fd35:919d:4042:2:c7ed:9a9f:a9ec:13/128 scope global dynamic noprefixroute
       valid_lft 2068sec preferred_lft 2068sec
    inet6 fe80::58bd:46f2:6adc:24b0/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
----

. Verify the hostname resolution and reachability to OCP components.
+
----
# host ns1.kni7.cloud.lab.eng.bos.redhat.com
ns1.kni7.cloud.lab.eng.bos.redhat.com has IPv6 address fd35:919d:4042:2:c7ed:9a9f:a9ec:7

# host api.kni7.cloud.lab.eng.bos.redhat.com
api.kni7.cloud.lab.eng.bos.redhat.com has IPv6 address fd35:919d:4042:2:c7ed:9a9f:a9ec:8

# host *.apps.kni7.cloud.lab.eng.bos.redhat.com
*.apps.kni7.cloud.lab.eng.bos.redhat.com has IPv6 address fd35:919d:4042:2:c7ed:9a9f:a9ec:9

# host jump-reg-kni7.cloud.lab.eng.bos.redhat.com
jump-reg-kni7.cloud.lab.eng.bos.redhat.com has address 10.19.139.19

# host registry.kni7.cloud.lab.eng.bos.redhat.com
registry.kni7.cloud.lab.eng.bos.redhat.com has IPv6 address fd35:919d:4042:2::1000

# dig jump-reg-kni7.cloud.lab.eng.bos.redhat.com +short
10.19.139.19

# ping6 registry.kni7.cloud.lab.eng.bos.redhat.com -c2
PING registry.kni7.cloud.lab.eng.bos.redhat.com(fd35:919d:4042:2::1000 (fd35:919d:4042:2::1000)) 56 data bytes
64 bytes from fd35:919d:4042:2::1000 (fd35:919d:4042:2::1000): icmp_seq=1 ttl=64 time=0.089 ms
64 bytes from fd35:919d:4042:2::1000 (fd35:919d:4042:2::1000): icmp_seq=2 ttl=64 time=0.135 ms

--- registry.kni7.cloud.lab.eng.bos.redhat.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 48ms
rtt min/avg/max/mdev = 0.089/0.112/0.135/0.023 ms
# curl -k -6 -u kni:kni https://registry.kni7.cloud.lab.eng.bos.redhat.com:5000/v2/_catalog
{"repositories":["ocp4"]}
----
