// Module included in the following assemblies:
//
// * list of assemblies where this module is included
// ipv6-disconnected-server-setup.adoc

[id="ipv6-disconnected-configuring-the-docker-registry_{context}"]

= Configuring the Docker registry

.Procedure

. Create the directories.
+
----
# mkdir -p /opt/registry/{auth,certs,data}
----

. Create openssl x509 certificates.
+
----
# openssl req -newkey rsa:4096 -nodes -sha256 -keyout
/opt/registry/certs/domain.key -x509 -days 3650 -out
/opt/registry/certs/domain.crt -subj "/C=US/ST=NorthCarolina/L=Raleigh/O=RedHat/OU=Engineering/CN=registry.kni7.cl
oud.lab.eng.bos.redhat.com"

# cp /opt/registry/certs/domain.crt /etc/pki/ca-trust/source/anchors/
# update-ca-trust extract
----

. Create the `htpasswd auth` file.
+
----
# htpasswd -bBc /opt/registry/auth/htpasswd kni kni
----

. Adjust the rules in the firewall.
+
----
# firewall-cmd --add-port=5000/tcp --zone=libvirt  --permanent
# firewall-cmd --add-port=5000/tcp --zone=public   --permanent
# firewall-cmd --reload
----

. Create the `systemd` unit.
+
----
# cat > /etc/systemd/system/podman-registry.service << EOF
[Unit]
Description=Podman container - Docker Registry
After=network.target

[Service]
Type=simple
WorkingDirectory=/root
TimeoutStartSec=300
ExecStartPre=-/usr/bin/podman rm -f registry
ExecStart=/usr/bin/podman run --name registry --hostname registry --net host
-e REGISTRY_AUTH=htpasswd -e REGISTRY_AUTH_HTPASSWD_REALM=basic-realm -e
REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd -e
REGISTRY_HTTP_SECRET=redhat -e
REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt -e
REGISTRY_HTTP_TLS_KEY=/certs/domain.key -e
REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/registry -v
/opt/registry/auth:/auth:Z -v /opt/registry/certs:/certs:z -v
/opt/registry/data:/registry:z registry:latest
ExecStop=-/usr/bin/podman rm -f image-registry
Restart=always
RestartSec=30s
StartLimitInterval=60s
StartLimitBurst=99

[Install]
WantedBy=multi-user.target
EOF
----

. Start the service.
+
----
# systemctl enable --now podman-registry
----

. Verify the registry.
+
----
# curl -k -6 -u kni:kni
https://registry.kni7.cloud.lab.eng.bos.redhat.com:5000/v2/_catalog
{"repositories":[""]}
----
