// Module included in the following assemblies:
//
// * list of assemblies where this module is included
// ipv6-disconnected-server-setup.adoc

[id="ipv6-disconnected-configuring-dnsmasq_{context}"]

= Configuring dnsmasq

.Procedure

. Configure `etc/dnsmasq.d/kni7.conf` as shown.
+
----
domain-needed
bogus-priv
strict-order
#expand-hosts
bind-dynamic
dhcp-sequential-ip
dhcp-authoritative
dhcp-fqdn
log-queries
domain=kni7.cloud.lab.eng.bos.redhat.com
resolv-file=/etc/resolv.conf.upstream
interface=eno1,eno3
enable-ra
server=10.19.143.247

dhcp-range=fd35:919d:4042:2:c7ed:9a9f:a9ec:0010,fd35:919d:4042:2:c7ed:9a9f:a9ec:0020,64
dhcp-option=option6:dns-server,[fd35:919d:4042:2::1000]
dhcp-option=option6:ntp-server,[::]

local=/kni7.cloud.lab.eng.bos.redhat.com/

#static addresses
address=/jump-reg-kni7.kni7.cloud.lab.eng.bos.redhat.com/10.19.139.19
address=/.apps.kni7.cloud.lab.eng.bos.redhat.com/fd35:919d:4042:2:c7ed:9a9f:a9ec:9
address=/api.kni7.cloud.lab.eng.bos.redhat.com/fd35:919d:4042:2:c7ed:9a9f:a9ec:8
address=/ns1.kni7.cloud.lab.eng.bos.redhat.com/fd35:919d:4042:2:c7ed:9a9f:a9ec:7
address=/registry.kni7.cloud.lab.eng.bos.redhat.com/fd35:919d:4042:2::1000

#reserved dynamic addresses
dhcp-host=24:6e:96:1b:96:94,master-0.kni7.cloud.lab.eng.bos.redhat.com,[fd35:919d:4042:2:c7ed:9a9f:a9ec:10]
dhcp-host=14:9e:cf:c5:35:f4,master-1.kni7.cloud.lab.eng.bos.redhat.com,[fd35:919d:4042:2:c7ed:9a9f:a9ec:11]
dhcp-host=14:9e:cf:c5:36:ab,master-2.kni7.cloud.lab.eng.bos.redhat.com,[fd35:919d:4042:2:c7ed:9a9f:a9ec:12]
dhcp-host=14:9e:cf:c5:38:19,provisioner,[fd35:919d:4042:2:c7ed:9a9f:a9ec:13]
#New Entry for worker nodes
dhcp-host=14:9E:CF:C5:30:F3,worker-0.kni7.cloud.lab.eng.bos.redhat.com,[fd35:919d:4042:2:c7ed:9a9f:a9ec:17]
dhcp-host=14:9E:CF:C5:31:AA,worker-1.kni7.cloud.lab.eng.bos.redhat.com,[fd35:919d:4042:2:c7ed:9a9f:a9ec:18]
dhcp-host=14:9E:CF:C5:32:61,worker-2.kni7.cloud.lab.eng.bos.redhat.com,[fd35:919d:4042:2:c7ed:9a9f:a9ec:19]
----
+
[WARNING]
====
Do not place any additional files within sourced directories (`/etc/dnsmasq.d`).
====

. Configure the `/etc/resolv.conf.upstream` file.
+
----
# cat /etc/resolv.conf.upstream
# Generated by NetworkManager
search kni7.cloud.lab.eng.bos.redhat.com
nameserver fd35:919d:4042:2::1000
----

. Set the local resolver.
+
----
nmcli con modify eno3 ipv6.dns fd35:919d:4042:2::1000 ipv6.dns-options 'rotate timeout:1 attempts:3'

# nmcli con down eno3; nmcli con up eno3

# cat /etc/resolv.conf
# Generated by NetworkManager
search cloud.lab.eng.bos.redhat.com
nameserver 10.19.143.247
nameserver fd35:919d:4042:2::1000
options rotate timeout:1 attempts:3
----
+
[WARNING]
====
Do not add any additional entries to `/etc/hosts`).
====

. Start the service.
+
----
# dnsmasq --test
# systemctl enable --now dnsmasq
----
