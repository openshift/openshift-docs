:_mod-docs-content-type: ASSEMBLY
[id="installing-mirroring-disconnected_{context}"]
= Mirroring images for a disconnected installation by using the oc-mirror plugin V1
include::_attributes/common-attributes.adoc[]
:context: installing-mirroring-disconnected

toc::[]

You can run your cluster in a restricted network without direct internet connectivity if you install the cluster from a mirrored set of {product-title} container images in a private registry. This registry must be running whenever your cluster is running.

// About the oc-mirror plugin v1
include::modules/oc-mirror-about.adoc[leveloffset=+1]

// oc-mirror compatibility and support
include::modules/oc-mirror-support.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* For information on updating oc-mirror, see xref:../../installing/validating-an-installation.adoc#viewing-the-image-pull-source_validating-an-installation[Viewing the image pull source].

// About the mirror registry
include::modules/installation-about-mirror-registry.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* For information about viewing the CRI-O logs to view the image source, see xref:../../installing/validating-an-installation.adoc#viewing-the-image-pull-source_validating-an-installation[Viewing the image pull source].

[id="prerequisites_installing-mirroring-disconnected"]
== Prerequisites

* You must have a container image registry that supports link:https://docs.docker.com/registry/spec/manifest-v2-2[Docker v2-2] in the location that will host the {product-title} cluster, such as {quay}. The container image registry is also called the mirror registry.
+
[NOTE]
====
If you use {quay}, you must use version 3.6 or later with the oc-mirror plugin v1. If you have an entitlement to {quay}, see the documentation on deploying {quay} link:https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploying_the_red_hat_quay_operator_on_openshift_container_platform/index[by using the Red Hat Quay Operator]. If you need additional assistance selecting and installing a registry, contact your sales representative or Red Hat Support.
====
+
* If you do not already have an existing solution for a mirror registry, receive a mirror registry for . This mirror registry is included with your subscription and serves as a small-scale container registry. You can use this registry to mirror the necessary container images of {product-title} for disconnected installations.

* Every machine in the provisioned clusters must have access to the mirror registry. If the registry is unreachable, installation, updating, or normal operations such as workload relocation might fail. For this reason, you must  run mirror registries in a highly available manner. The mirror registries must meet or exceed the production availability of your {product-title} clusters.

* You have set the `umask` parameter to `0022` on the operating system that uses oc-mirror plugin v1.


[id="mirroring-preparing-your-hosts"]
== Preparing your mirror hosts

Before you can use the oc-mirror plugin v1 to mirror images, you must install the plugin. You must also create a container image registry credentials file to allow the mirroring from Red Hat to your mirror.

// Installing the oc-mirror OpenShift CLI plugin
include::modules/oc-mirror-installing-plugin.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../../cli_reference/openshift_cli/extending-cli-plugins.adoc#cli-installing-plugins_cli-extend-plugins[Installing and using CLI plugins]

// Configuring credentials that allow images to be mirrored
include::modules/installation-adding-registry-pull-secret.adoc[leveloffset=+2]

//About the Image set Configuration
include::modules/oc-mirror-image-set-config-about.adoc[leveloffset=+1]

// Creating the image set configuration
include::modules/oc-mirror-creating-image-set-config.adoc[leveloffset=+2]

// Image set configuration parameters
include::modules/oc-mirror-imageset-config-params.adoc[leveloffset=+2]

// Image set configuration examples
include::modules/oc-mirror-image-set-config-examples.adoc[leveloffset=+2]

// Setting up for incremental mirroring
include::modules/oc-mirror-setting-incremental-mirroring.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* xref:../../installing/disconnected_install/installing-mirroring-disconnected.adoc#oc-mirror-imageset-config-params_installing-mirroring-disconnected[Image set configuration parameters]
* xref:../../installing/disconnected_install/installing-mirroring-disconnected.adoc#oc-mirror-image-set-examples_installing-mirroring-disconnected[Image set configuration examples]
* xref:../../updating/updating_a_cluster/updating_disconnected_cluster/disconnected-update-osus.adoc#update-service-overview_updating-restricted-network-cluster-osus[Using the OpenShift Update Service in a disconnected environment]

[id="mirroring-image-set"]
== Mirroring an image set to a mirror registry

To populate your mirror registry with {product-title} images, you can use one of the following scenarios:

* Partially disconnected environment: The host can access both the internet and your mirror registry, but not your cluster nodes. With this setup, you can mirror content directly from the host machine.

* Fully disconnected environment: The host cannot access the internet, your mirror registry, or the cluster nodes. In this setup, you must mirror the images to a file system and then bring that host or removable media into your restricted environment.

[id="mirroring-image-set-partial"]
=== Mirroring an image set in a partially disconnected environment

You can use the oc-mirror plugin v1 to mirror an image set directly to a target mirror registry that is accessible during image set creation.

// Mirroring from mirror to mirror
include::modules/oc-mirror-mirror-to-mirror.adoc[leveloffset=+3]

[id="mirroring-image-set-full"]
=== Mirroring an image set in a fully disconnected environment

To mirror an image set in a fully disconnected environment, you must first xref:../../installing/disconnected_install/installing-mirroring-disconnected.adoc#oc-mirror-mirror-to-disk_installing-mirroring-disconnected[mirror the image set to disk], then xref:../../installing/disconnected_install/installing-mirroring-disconnected.adoc#oc-mirror-disk-to-mirror_installing-mirroring-disconnected[mirror the image set file on disk to a mirror].

// Mirroring from mirror to disk
include::modules/oc-mirror-mirror-to-disk.adoc[leveloffset=+3]

// Mirroring from disk to mirror in a disconnected environment
include::modules/oc-mirror-disk-to-mirror.adoc[leveloffset=+3]

// Configuring your cluster to use the resources generated by oc-mirror
include::modules/oc-mirror-updating-cluster-manifests.adoc[leveloffset=+1]

// About updating your mirror registry content
include::modules/oc-mirror-updating-registry-about.adoc[leveloffset=+1]

include::modules/oc-mirror-updating-use-cases.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../../installing/disconnected_install/installing-mirroring-disconnected.adoc#oc-mirror-image-set-examples_installing-mirroring-disconnected[Image set configuration examples]
* xref:../../installing/disconnected_install/installing-mirroring-disconnected.adoc#mirroring-image-set-partial[Mirroring an image set in a partially disconnected environment]
* xref:../../installing/disconnected_install/installing-mirroring-disconnected.adoc#mirroring-image-set-full[Mirroring an image set in a fully disconnected environment]
* xref:../../installing/disconnected_install/installing-mirroring-disconnected.adoc#oc-mirror-updating-cluster-manifests_installing-mirroring-disconnected[Configuring your cluster to use the resources generated by oc-mirror]

// Performing a dry run
include::modules/oc-mirror-dry-run.adoc[leveloffset=+1]

// Including local OCI Operator catalogs
include::modules/oc-mirror-oci-format.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

// TODO: This title might need to update per sebastian's PR
* xref:../../installing/disconnected_install/installing-mirroring-disconnected.adoc#oc-mirror-updating-cluster-manifests_installing-mirroring-disconnected[Configuring your cluster to use the resources generated by oc-mirror]


// Command reference for oc-mirror
include::modules/oc-mirror-command-reference.adoc[leveloffset=+1]

[role="_additional-resources"]
[id="additional-resources_installing-mirroring-disconnected"]
== Additional resources

* xref:../../updating/updating_a_cluster/updating_disconnected_cluster/index.adoc#about-restricted-network-updates[About cluster updates in a disconnected environment]
