:_mod-docs-content-type: ASSEMBLY
[id="installing-mirroring-disconnected-v2"]
= Mirroring images for a disconnected installation using the V2
include::_attributes/common-attributes.adoc[]
:context: installing-mirroring-disconnected

toc::[]

Running your cluster in a restricted network without direct internet connectivity is possible by installing the cluster from a mirrored set of {product-title} container images in a private registry. This registry must be running at all times provided that the cluster is running. See the link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.15/html/installing/disconnected-installation-mirroring#prerequisites_installing-mirroring-disconnected[Prerequisites] section for more information.

You can use the oc-mirror OpenShift CLI (`oc`) plugin to mirror images to a mirror registry in your fully or partially disconnected environments. You must run oc-mirror from a system with internet connectivity in order to download the required images from the official Red Hat registries.

.High level workflow

The following steps outline the high-level workflow on how to use the oc-mirror plugin to mirror images to a mirror registry:

* Create an image set configuration file.

* Mirror the image set to the target mirror registry by using one of the following methods:

** Mirror an image set directly to the target mirror registry.

** Mirror an image set to disk, transfer the image set to the target environment, then upload the image set to the target mirror registry.

* Configure your cluster to use the resources generated by the oc-mirror plugin.

* Repeat these steps to update your target mirror registry as necessary.

// About V2
include::modules/oc-mirror-v2-about.adoc[leveloffset=+1]

// oc-mirror compatibility and support
include::modules/oc-mirror-comp-support.adoc[leveloffset=+2]


[id="prerequisites_installing-mirroring-disconnected"]
[id="prerequisites_oc-mirror-v2"]
== Prerequisites

* You must have a container image registry that supports link:https://docs.docker.com/registry/spec/manifest-v2-2[Docker v2-2] in the location that will host the {product-title} cluster, such as Red Hat Quay.
+
[NOTE]
====
If you use Red Hat Quay, you must use version 3.6 or later with the oc-mirror plugin. If you have an entitlement to Red Hat Quay, see the documentation on deploying Red Hat Quay link:https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploy_red_hat_quay_for_proof-of-concept_non-production_purposes/[for proof-of-concept purposes] or link:https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploying_the_red_hat_quay_operator_on_openshift_container_platform/index[by using the Red Hat Quay Operator]. If you need additional assistance selecting and installing a registry, contact your sales representative or Red Hat Support.
====

[id="using-oc-mirror"]
== Mirroring an image set to a mirror registry

You can use this workflow when the target disconnected registry is fully disconnected. In other words, the environment on which you are executing oc-mirror has access to the internet but doesn't have access to the target disconnected registry.

.Environment Preparation

* To set up the credentials for pulling/pushing container images, download the pull secret and place it in the correct path.

** The default podman credentials location `$XDG_RUNTIME_DIR/containers/auth` is used for authenticating to the registries.
** The docker location `~/.docker/config.json` for credentials is also supported.
** Save the file as `$XDG_RUNTIME_DIR/containers/auth.json`.

[id="building-image-set-configuration"]
=== Building the image set configuration

The Image Set Configuration is the input file used by oc-mirror to discover which images are necessary to be mirrored.

Below is an example for the `ImageSetConfiguration` input file:

[source,yaml]
----
kind: ImageSetConfiguration
apiVersion: mirror.openshift.io/v2alpha1
mirror:
  platform:
    channels:
    - name: stable-4.13
      minVersion: 4.13.10
      maxVersion: 4.13.10
    graph: true
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.15
      packages:
       - name: aws-load-balancer-operator
       - name: 3scale-operator
       - name: node-observability-operator
  additionalImages: 
   - name: registry.redhat.io/ubi8/ubi:latest
   - name: registry.redhat.io/ubi9/ubi@sha256:20f695d2a91352d4eaa25107535126727b5945bff38ed36a3e59590f495046f0
----

[id="oc-mirror-workflows-partially-disconnected"]
=== Mirroring an image set in a partially disconnected environment

.Mirror To Mirror

You can use this workflow for partially disconnected mirroring.
You can use this workflow when the environment from which you are executing oc-mirror has both:

- Access to the internet
- Access to the target disconnected registry

You are required to specify a storage backend in the image set configuration file. This storage backend can be a local directory or a Docker v2 registry. The oc-mirror plugin stores metadata in this storage backend during image set creation.

.Prerequisites

* You have access to the internet to get the necessary container images.
* You have installed the OpenShift CLI (`oc`).
* You have installed the `oc-mirror` CLI plugin.
* You have created the image set configuration file.

.Procedure

Copy the container images from the source specified in the image set configuration to the destination (container registry).

[source,terminal]
----
$ oc mirror -c isc.yaml --workspace file://oc-mirror/mirror1 docker://localhost:6000 --v2
----

.Verification

. Navigate into the `oc-mirror-workspace/` directory that was generated.
. Navigate into the results directory, for example, `results-1639608409/`.
. Verify that YAML files are present for the `ImageDigestMirrorSet`, `ImageTagMirrorSet` and `CatalogSource` resources.

.Next steps

* Configure your cluster to use the resources generated by oc-mirror.


[id="oc-mirror-workflows-fully-disconnected"]
=== Mirroring an image set in a fully disconnected environment

In a fully disconnected environment, the workflow is composed of following 3 steps:

* Mirror to disk: preparing an archive containing the image set that needs to be mirrored
* A manual step, where the user transfers the archive to the network of the disconnected registry
* Disk to mirror: from an environment that has access to the disconnected registry, execute oc-mirror to mirror the image set from the archive to the target disconnected registry.

.Mirroring from mirror to disk

You can use the oc-mirror plugin to generate an image set and save the contents to disk. The generated image set can then be transferred to the disconnected environment and mirrored to the target registry.

Pulls the container images from the source specified in the image set configuration and pack them into a tar archive on disk (local directory).

.Prerequisites

* You have access to the internet to get the necessary container images.
* You have installed the OpenShift CLI (`oc`).
* You have installed the `oc-mirror` CLI plugin.
* You have created the image set configuration file.

.Procedure

[source,terminal]
----
$ oc mirror -c isc.yaml 
<file path> <1>
--v2
----
<1> Add the desired file path 

.Mirroring from disk to mirror

Copies the container images from the tar archive to a container registry.

[source,terminal]
----
$ oc mirror -c isc.yaml --from file://oc-mirror/mirror1 docker://localhost:6000 --v2
----

[id="oc-mirror-delete"]
== Deleting the images from disconnected environment

In v1, image pruning or deletion occurs automatically at the end of the mirroring process. To delete a specific release, catalog, or `additionalImage`, use the same `StorageConfig` settings. Update the `imagesetconfig` to exclude the content you wish to prune. The pruning logic will identify the differences and remove the images accordingly. Since this method has both advantages and disadvantages, it was modified in v2.

In v2, a new input type called `DeleteImageSetConfiguration` has been introduced. This is used to configure image deletion, preventing the accidental deletion of required or deployed images by avoiding the use of an `ImageSetConfig`.

The new sub command allows the users to execute the delete workflow with the `DeleteImageSetConfiguration`.

This functionality works in a fully disconnected environment, provided the images have been previously mirrored. This means that both the local cache and the remote registry are aware of the images being deleted.

[NOTE]
====
In v2, automatic pruning is no longer performed. In v1, when an item (such as an operator) was removed from the image set configuration, it would be automatically pruned from the container registry. To prevent unintended deletions, v2 introduces a specific file named DeleteImageSetConfiguration. 

This file allows specifying only the images to be deleted from the registry. Users must run the delete command using this file, avoiding accidental deletions from their container registries.
====

Using the DeleteImageSetConfiguration, oc-mirror will remove:
- All images of {product-title} release 4.13.3
- The catalog image `redhat-operator-index` v4.12
- The latest `aws-load-balancer-operator` bundle and all its related images
- The additional images `ubi` and `ubi-minimal` referenced by their corresponding digests.

Here is an example of the `DeleteImageSetConfig`:

[source,yaml]
----
apiVersion: mirror.openshift.io/v2alpha1
kind: DeleteImageSetConfiguration
delete:
  platform:
    channels:
      - name: stable-4.13 
        minVersion: 4.13.3
        maxVersion: 4.13.3
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.12
      packages:
      - name: aws-load-balancer-operator
         minVersion: 0.0.1
         maxVersion: 0.0.1
  additionalImages: 
    - name: registry.redhat.io/ubi8/ubi@sha256:bce7e9f69fb7d4533447232478fd825811c760288f87a35699f9c8f030f2c1a6
    - name: registry.redhat.io/ubi8/ubi-minimal@sha256:8bedbe742f140108897fb3532068e8316900d9814f399d676ac78b46e740e34e
----

The delete functionality is divided into two stages:

.Stage 1: Generation

Creates a delete YAML file using the `--generate` flag. This file is used to validate the images/blobs that will be deleted. 

** Use the following command to create `delete` yaml file for delete phase:

[source,terminal]
----
$ oc mirror delete --config delete-image-set-config.yaml --workspace file://<previously-mirrored-work-folder> --v2 --generate docker://<remote-registry> 
----

** Use the following command to compare versions:

[source,terminal]
----
$ oc mirror delete --config delete-image-set-config.yaml --workspace file://<previously-mirrored-work-folder> --v2 --generate --delete-id v4.11 docker://<remote-registry>
----

.Stage 2: Execution

Use the validated delete yaml file to perform the deletion from the local cache and remote registry.

** Once the generate stage is completed, use the following command to delete the images from the remote registry. 

[source,terminal]
----
$ oc mirror delete --v2 --delete-yaml-file <previously-mirrored-work-folder>/delete/delete-images-v4.11.yaml docker://<remote-registry>  
----

** Use the following command to delete the remote registry and forces the cache delete:

[source,terminal]
----
$ oc mirror delete --v2 --delete-yaml-file <previously-mirrored-work-folder>/delete/delete-images-v4.11.yaml --force-cache-delete true docker://<remote-registry> 
----

[IMPORTANT]
====
It is highly recommend to use the mirror-to-disk and disk-to-mirror workflows.

The mirror-to-mirror workflow was added for backward compatibility with Version 1. Use it only for mirroring a small number of images or for testing in a lab environment. Note that no images are cached when using the mirror-to-mirror workflow.

Also, note that if you previously used the mirror-to-mirror workflow and then switched to the other workflows, the delete generation and registry delete processes will fail.
====

[NOTE]
====
In the image delete workflow, oc-mirror only deletes the manifests of the images, which does not reduce the storage occupied in the registry.

To free up storage space from unnecessary images (those with deleted manifests), you need to enable the garbage collector on your container registry. The procedure for enabling the garbage collector varies depending on the container registry you are using. With the garbage collector enabled, the registry will delete the image blobs that no longer have references to any manifests, thereby reducing the storage previously occupied by the deleted blobs.
====

// About IDMS and ITMS
include::modules/oc-mirror-IDMS-ITMS-about.adoc[leveloffset=+1]

// Configuring your cluster to use the resources generated by oc-mirror
include::modules/oc-mirror-updating-cluster-manifests-v2.adoc[leveloffset=+2]

// Dry-run for V2
include::modules/oc-mirror-dry-run-v2.adoc[leveloffset=+1]

[id="oc-mirror-enclave-support-about"]
== About enclave support

The purpose of a network enclave is to restrict internal access to a specific network segment. A key difference between a DMZ (demilitarized zone) and a network enclave is that a DMZ allows inbound and outbound traffic across firewall boundaries, whereas an enclave does not.

oc-mirror already supports mirroring content to disconnected environments for installing and upgrading OCP clusters. This feature specifically addresses scenarios where mirroring is required for multiple enclaves (disconnected environments) secured by at least one intermediate disconnected network.

With enclave support:

- You can mirror content for multiple enclaves and centralize it in a single internal registry. Some customers want to run security checks on the mirrored content, vetting it before allowing mirroring to downstream enclaves.
- You can mirror content directly from the centralized internal registry to enclaves without restarting the mirroring process from the internet for each enclave.
- You can minimize data transfer between network stages, ensuring that a blob or image is transferred only once from one stage to another.

[Diagram for enclave support should be inserted here]

// Enclave Support
include::modules/oc-mirror-enclave-support.adoc[leveloffset=+1]

// Command reference for oc-mirror V2
include::modules/oc-mirror-command-reference-v2.adoc[leveloffset=+1]

[role="_additional-resources"]
[id="additional-resources_oc-mirror-v2"]
== Additional resources

* For information about viewing the CRI-O logs to view the image source, see xref:../../installing/validating-an-installation.adoc#viewing-the-image-pull-source_validating-an-installation[Viewing the image pull source].