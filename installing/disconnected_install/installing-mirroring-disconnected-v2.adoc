:_mod-docs-content-type: ASSEMBLY
[id="installing-mirroring-disconnected-v2"]
= Mirroring images for a disconnected installation using the V2
include::_attributes/common-attributes.adoc[]
:context: installing-mirroring-disconnected

toc::[]

:FeatureName: oc-mirror v2
include::snippets/technology-preview.adoc[]

Running your cluster in a restricted network without direct internet connectivity is possible by installing the cluster from a mirrored set of {product-title} container images in a private registry. This registry must be running at all times provided that the cluster is running. See the link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.15/html/installing/disconnected-installation-mirroring#prerequisites_installing-mirroring-disconnected[Prerequisites] section for more information.

You can use the oc-mirror OpenShift CLI (`oc`) plugin to mirror images to a mirror registry in your fully or partially disconnected environments. You must run oc-mirror from a system with internet connectivity in order to download the required images from the official Red Hat registries.

.High level workflow

The following steps outline the high-level workflow on how to use the oc-mirror plugin to mirror images to a mirror registry:

. Create an image set configuration file.

. Mirror the image set to the target mirror registry by using one of the following workflows:

** Mirror an image set directly to the target mirror registry (Mirror-to-Mirror).

** Mirror an image set to disk (Mirror-to-Disk), transfer the tar file to the target environment, then mirror the image set to the target mirror registry (Disk-to-Mirror).

. Configure your cluster to use the resources generated by the oc-mirror.

. Repeat these steps to update your target mirror registry as necessary.

// About V2
include::modules/oc-mirror-v2-about.adoc[leveloffset=+1]

// oc-mirror compatibility and support
include::modules/oc-mirror-support.adoc[leveloffset=+2]


[id="prerequisites_oc-mirror-v2"]
== Prerequisites

* You must have a container image registry that supports link:https://docs.docker.com/registry/spec/manifest-v2-2[Docker v2-2] in the location that will host the {product-title} cluster, such as Red Hat Quay.
+
[NOTE]
====
If you use Red Hat Quay, you must use version 3.6 or later with the oc-mirror plugin. If you have an entitlement to Red Hat Quay, see the documentation on deploying Red Hat Quay link:https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploy_red_hat_quay_for_proof-of-concept_non-production_purposes/[for proof-of-concept purposes] or link:https://access.redhat.com/documentation/en-us/red_hat_quay/3/html/deploying_the_red_hat_quay_operator_on_openshift_container_platform/index[by using the Red Hat Quay Operator]. If you need additional assistance selecting and installing a registry, contact your sales representative or Red Hat Support.
====

* Every machine in the provisioned clusters must have access to the mirror registry. If the registry is unreachable, tasks like installation, updating, or routine operations such as workload relocation may fail. Therefore, mirror registries must be operated in a highly available manner, ensuring their availability aligns with the production availability of your {product-title} clusters.

* You have set the umask parameter to `0022` on the operating system that uses oc-mirror.

//Preparing your mirror hosts
include::modules/oc-mirror-preparing-mirror-hosts.adoc[leveloffset=+1]

//Configuring credentials that allow images to be mirrored
include::modules/oc-mirror-configuring-credentials-v2.adoc[leveloffset=+1]

[id="using-oc-mirror"]
== Mirroring an image set to a mirror registry

This section describes all the steps required for each oc-mirror workflow.

[id="building-image-set-configuration"]
=== Building the image set configuration

The Image Set Configuration is the input file used by oc-mirror to discover which images are necessary to be mirrored.

.Example for the `ImageSetConfiguration` input file:

[source,yaml]
----
kind: ImageSetConfiguration
apiVersion: mirror.openshift.io/v2alpha1
mirror:
  platform:
    channels:
    - name: stable-4.13
      minVersion: 4.13.10
      maxVersion: 4.13.10
    graph: true
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.15
      packages:
       - name: aws-load-balancer-operator
       - name: 3scale-operator
       - name: node-observability-operator
  additionalImages: 
   - name: registry.redhat.io/ubi8/ubi:latest
   - name: registry.redhat.io/ubi9/ubi@sha256:20f695d2a91352d4eaa25107535126727b5945bff38ed36a3e59590f495046f0
----

//oc-mirror-workflows: mirroring in partially disconnected environment
include::modules/oc-mirror-workflows-partially-disconnected-v2.adoc[leveloffset=+2]

//Mirroring an image set in a fully disconnected environment: Mirror-to-Disk and Disk-to-Mirror
include::modules/oc-mirror-workflows-fully-disconnected-v2.adoc[leveloffset=+2]

// About custom resources generated by v2
include::modules/oc-mirror-IDMS-ITMS-about.adoc[leveloffset=+1]

// Configuring your cluster to use the resources generated by oc-mirror
include::modules/oc-mirror-updating-cluster-manifests-v2.adoc[leveloffset=+2]

//Delete Feature
include::modules/oc-mirror-workflows-delete-v2.adoc[leveloffset=+1]
include::modules/oc-mirror-procedure-delete-v2.adoc[leveloffset=+2]

// Dry-run for V2
include::modules/oc-mirror-dry-run-v2.adoc[leveloffset=+1]

//oc-mirror-enclave-support-about
include::modules//oc-mirror-enclave-support-about.adoc[leveloffset=+1]

// How to mirror to an Enclave
include::modules/oc-mirror-enclave-support.adoc[leveloffset=+1]

//operator catalog filtering
include::modules/oc-mirror-operator-catalog-filtering.adoc[leveloffset=+1]

//Image set configuration parameters
include::modules/oc-mirror-imageset-config-parameters-v2.adoc[leveloffset=+1]

// Command reference for oc-mirror V2
include::modules/oc-mirror-command-reference-v2.adoc[leveloffset=+1]


[role="_additional-resources"]
[id="additional-resources_oc-mirror-v2"]
== Additional resources

* For information about viewing the CRI-O logs to view the image source, see xref:../../installing/validating-an-installation.adoc#viewing-the-image-pull-source_validating-an-installation[Viewing the image pull source].


* For more information on CLI plugins, see xref:../../cli_reference/openshift_cli/extending-cli-plugins#cli-installing-plugins_cli-extend-plugins[Installing and using CLI plugins].