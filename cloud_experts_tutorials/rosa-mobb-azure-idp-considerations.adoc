:_content-type: ASSEMBLY
[id="rosa-mobb-azure-idp-considerations"]
= Tutorial: What to consider when using Microsoft Azure AD as IDP?
include::_attributes/attributes-openshift-dedicated.adoc[]
:context: rosa-mobb-azure-idp-considerations

toc::[]

//Mobb content metadata
//Brought into ROSA product docs 2023-09-18
//---
// date: '2023-05-24'
// title: What to consider when using Azure AD as IDP?
// tags: ["Azure", "IDP", "ARO", "ROSA"]
// authors:
//   - Ricardo Martins
// ---

This guide discusses key considerations when you use Microsoft Azure Active Directory (AAD) as the Identity Provider (IDP) for your ARO or ROSA cluster. Below are some helpful references:

* link:https://mobb.ninja/docs/idp/azuread-aro/[Configure ARO to Use Azure AD]
* link:https://mobb.ninja/docs/idp/azuread/[Configuring IDP for ROSA, OSD, and ARO]

[id="rosa-mobb-azure-idp-considerations-default-access"]
== Default access for all users in Microsoft Azure Active Directory

After you set up AAD as the IDP for your cluster, it is important to note that by default, all users in your Microsoft Azure Active Directory instance will have access to the cluster. They can log in by using their AAD credentials through the OpenShift Web Console endpoint:

image::aro-login.png[OpenShift Web Console Login]

However, for security purposes, it is recommended to restrict access and only allow specific users who are assigned to access the cluster.

[id="rosa-mobb-azure-idp-considerations-restricting-access"]
== Restricting access

To implement access restrictions, follow these steps:

. Log in to the Microsoft Azure portal and navigate to your AAD instance.
. Under Enterprise applications, select the application created for the ARO IDP configuration.
+
image::pick-application.png[Select Application]

. In the selected Enterprise application, go to Properties and switch the **"Assignment required?"** option to **YES**.
+
image::assignment-required.png[Assignment Required]

. If you attempt to log in at this point, you will receive a denial error:
+
Enter your username:
+
image::login-attempt.png[Login Attempt]
+
Enter your password:
+
image::login-attempt-2.png[Login Attempt 2]
+
The error message indicates that only users specifically granted access to the application are allowed:
+
image::access-denied.png[Access Denied]

. To allow access, go to Users and groups in the main blade, click **+ Add user/group**, and add the desired users/groups who should have access to the ARO cluster.
+
image::add-user.png[Add User]
+
Search for the desired user/group and click **Select**.
+
image::assign-user.png[Assign User]
+
Verify that the user has been assigned:
+
image::user-assigned.png[User Assigned]

. You should now be able to log in with the specified user/group to your cluster:
+
Enter your username:
+
image::login-attempt.png[Login Attempt]
+
Enter your password:
+
image::login-attempt-2.png[Login Attempt 2]
+
You will then be logged in:
+
image::logged-in.png[Logged In]

[id="rosa-mobb-azure-idp-considerations-approval-workflow"]
== Approval workflow

If you receive a message such as the following, it means that your AAD has the link:https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/configure-admin-consent-workflow[admin consent workflow] enabled:

image::approval-required.png[Approval Required]

In this case, you will need to request and wait for approval from your AAD domain admin. To request access, fill out the request form:

image::approval-request.png[Approval Request]

Wait for approval:

image::request-sent.png[Request Sent]

[id="rosa-mobb-azure-idp-considerations-self-approval"]
== Self-approval process

If you have administrative privileges, you can self-approve the request by following these steps:

[NOTE]
====
These steps are based on the official guidance from Microsoft, which is link:https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/review-admin-consent-requests[available here].
====

. Go to your Microsoft Azure Active Directory Tenant > Enterprise Applications > *Admin Consent Requests* > All (Preview):
+
image::admin-consent-requests.png[Admin Consent Request]

. Select the application (OpenShift, in this case) and click **Review permissions and consent**:
+
image::details-admin-consent-requests.png[Details Admin Consent Request]

. A new window will open, prompting you to log in with credentials of an admin with permissions:
+
image::admin-login.png[Admin Login]

. Click **Accept** to consent to the permission:
+
image::permissions-requested.png[Permissions Requested]
+
You will then see that the request was approved:
+
image::request-approved.png[Request Approved]
+
Now, you will be able to log in through the AAD option:
+
image::aro-login.png[OpenShift Web Console Login]
+
Enter your username:
+
image::login-attempt.png[Login Attempt]
+
Enter your password:
+
image::login-attempt-2.png[Login Attempt 2]
+
image::logged-in.png[Logged In]
+
As a best practice, it is recommended that you remove the `kubeadmin` user after setting up an identity provider. See link:https://docs.openshift.com/container-platform/4.13/authentication/remove-kubeadmin.html[the product documentation for removing a Kubeadmin] for instructions.

[id="rosa-mobb-azure-idp-considerations-group-sync-operator"]
== Using the Group Sync Operator

Integrating groups from external identity providers with OpenShift, such as synchronizing groups from AAD, can be a valuable feature to enhance your system's functionality. You do this by using the link:https://github.com/redhat-cop/group-sync-operator[Group Sync Operator]. 

See link:https://mobb.ninja/docs/idp/az-ad-grp-sync/[Using Group Sync Operator with Azure Active Directory and ROSA] for instructions for configuring the Group Sync Operator. By following these instructions, you will be able to seamlessly synchronize AAD groups into your OpenShift environment, optimizing your workflow and streamlining access management.