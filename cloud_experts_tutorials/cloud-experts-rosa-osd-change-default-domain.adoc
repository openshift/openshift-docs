:_mod-docs-content-type: ASSEMBLY
[id="cloud-experts-rosa-osd-change-default-domain"]
= Tutorial: Changing the Console, OAuth, and Downloads domains and TLS certificate on ROSA and OSD
include::_attributes/attributes-openshift-dedicated.adoc[]
:context: cloud-experts-rosa-osd-change-default-domain

toc::[]

//Content metadata
//Brought into ROSA product docs 2023-12-14
//---
//date: '2022-12-07'
//title: Changing the Console, OAuth, and Downloads Domain and TLS Certificate on ROSA and OSD
//weight: 1
//tags: ["AWS", "ROSA", "OSD"]
//authors:
//   Hector Kemp
//---

//Footnote definitions
ifdef::openshift-dedicated[]
:fn-supported-cli: footnote:[The example commands in this guide use the ROSA CLI, but similar commands with the same function are available in the OCM CLI version 0.1.68 and higher for {product-title} (OSD) clusters.]
:fn-supported-versions: footnote:[Modifying these routes on OSD versions prior to 4.14 is not typically supported. However, if you have a cluster using version 4.13, you can request for Red Hat Support to enable support for this feature on your version 4.13 cluster by link:https://access.redhat.com/support/cases/new[opening a support case].]
:fn-term-component-routes: footnote:[We use the term "component routes" to refer to the `OAuth`, `Console`, and `Downloads` routes that are provided when OSD are first installed.]
endif::openshift-dedicated[]
ifdef::openshift-rosa[]
:fn-supported-versions: footnote:[Modifying these routes on {product-title} ROSA versions prior to 4.14 is not typically supported. However, if you have a cluster using version 4.13, you can request for Red Hat Support to enable support for this feature on your version 4.13 cluster by link:https://access.redhat.com/support/cases/new[opening a support case].]
:fn-term-component-routes: footnote:[We use the term "component routes" to refer to the `OAuth`, `Console`, and `Downloads` routes that are provided when ROSA are first installed. The ROSA CLI also uses the term "cluster routes" to refer to these resources.]
endif::openshift-rosa[]


//Article text
ifdef::openshift-dedicated[]
This guide demonstrates how to modify the hostname and TLS certificate of the Web console, OAuth server, and Downloads component routes in {product-title} (OSD) version 4.14 and above.{fn-supported-versions}
endif::openshift-dedicated[]
ifdef::openshift-rosa[]
This guide demonstrates how to modify the hostname and TLS certificate of the Web console, OAuth server, and Downloads component routes in {product-title} (ROSA) version 4.14 and above.{fn-supported-versions}
endif::openshift-rosa[]

The changes that we make to the component routes{fn-term-component-routes} in this guide are described in greater detail in the customizing the link:https://docs.openshift.com/container-platform/latest/authentication/configuring-internal-oauth.html#customizing-the-oauth-server-url_configuring-internal-oauth[internal OAuth server URL], link:https://docs.openshift.com/container-platform/latest/web_console/customizing-the-web-console.html#customizing-the-console-route_customizing-web-console[console route], and link:https://docs.openshift.com/container-platform/latest/web_console/customizing-the-web-console.html#customizing-the-download-route_customizing-web-console[download route] OpenShift Container Platform documentation. 

[id="prerequisites_{context}"]
== Prerequisites
ifdef::openshift-dedicated[]
* OCM CLI (`rosa`) version 0.1.68 and higher
* An OSD cluster
endif::openshift-dedicated[]
ifdef::openshift-rosa[]
* ROSA CLI (`rosa`) version 1.2.27 or higher
* AWS CLI (`aws`)
* A ROSA cluster
endif::openshift-rosa[]
* OpenShift CLI (`oc`)
* Access to the cluster as a user with the `cluster-admin` role.
* A unique domain, such as `openshift.example.com`
* `jq`
* [Optional] OpenSSL (for generating the demonstration SSL certificate), which can be downloaded and installed from link:https://www.openssl.org/source/[OpenSSL.org]

[id="environment-setup_{context}"]
== Setting up your environment

. Configure the following environment variables:
+
[NOTE]
====
You must be logged in as an administrator.
====
+
[source,terminal]
----
$ export NEW_BASE_DOMAIN=openshift.example.com <1>
$ export CLUSTER_NAME=$(oc get infrastructure cluster -o=jsonpath="{.status.infrastructureName}"  | sed 's/-[a-z0-9]\{5\}$//')
$ export INGRESS_JSON=$(rosa list ingress -c ${CLUSTER_NAME} -o json)
$ export INGRESS_ID=$(echo $INGRESS_JSON | jq -cr '.[] | select( .default == true ) | .id')
$ export DEFAULT_BASE_DOMAIN=$(echo $INGRESS_JSON | jq -cr '.[] | select( .default == true ) | .dns_name')
$ export SCRATCH="/tmp/${CLUSTER_NAME}/component-route-change"
$ mkdir -p ${SCRATCH}
----
<1> The custom base domain you wish to use for your component routes.

. Ensure all fields output correctly before moving to the next section:
+
[source,terminal]
----
$ echo "Cluster: ${CLUSTER_NAME}, Default Base Domain: ${DEFAULT_BASE_DOMAIN}, New Base Domain: ${NEW_BASE_DOMAIN}, Ingress ID: ${INGRESS_ID}"
----
+
.Example output
+
[source,text]
----
Cluster: my-rosa-cluster, Default Base Domain: apps.my-rosa-cluster.e2eg.p1.openshiftapps.com, New Base Domain: openshift.example.com, Ingress ID: k5p6
----

[id="find-current-routes_{context}"]
== Find the current routes

. List the default component routes by getting the routes in `openshift-console` and `openshift-authentication`.
+
[source,bash]
----
$ oc get routes -n openshift-console
$ oc get routes -n openshift-authentication
----
+
.Example output
+
[source,text]
----
NAME              HOST/PORT                                                                     PATH   SERVICES          PORT   TERMINATION            WILDCARD
console           console-openshift-console.apps.my-rosa-cluster.e2eg.p1.openshiftapps.com             console           https  reencrypt/Redirect     None
downloads         downloads-openshift-console.apps.my-rosa-cluster.e2eg.p1.openshiftapps.com           downloads         http   edge/Redirect          None
NAME              HOST/PORT                                                                     PATH   SERVICES          PORT   TERMINATION            WILDCARD
oauth-openshift   oauth-openshift.apps.my-rosa-cluster.e2eg.p1.openshiftapps.com                       oauth-openshift   6443   passthrough/Redirect   None
----
+
As you can see from the example output, our routes shares the base domain of our default ingress: `apps.my-rosa-cluster.e2eg.p1.openshiftapps.com`.
+
We can use the `rosa edit ingress` command to change this base domain (and provide a matching TLS certificate) for all of our component routes. The relevant parameters are shown in this excerpt of the command line help for the `rosa edit ingress` command:
+
[source,bash]
----
$ rosa edit ingress -h
Edit a cluster ingress for a cluster. Usage:
  rosa edit ingress ID [flags]
  [...]
  --cluster-routes-hostname string         Components route hostname for oauth, console, download.
  --cluster-routes-tls-secret-ref string   Components route TLS secret reference for oauth, console, download.
----
+
Note that when we use this command to change the component routes, it will change the base domain for all three routes at the same time.
+
If we choose a new base domain of `openshift.example.com`, our new component routes for our cluster will be:
+
* _console-openshift-console.openshift.example.com_ for the Web console
* _downloads-openshift-console.openshift.example.com_ for Downloads
* _oauth-openshift.openshift.example.com_ for the OAuth server

[id="create-tls-certificate-for-routes_{context}"]
== Create a valid TLS certificate for each component route

[WARNING]
====
You must create three separate certificates for each component route to avoid problems with link:https://daniel.haxx.se/blog/2016/08/18/http2-connection-coalescing/[HTTP/2 connection coalescing]. Using a wildcard or SAN certificate for the component routes *will not work* and result in unexpected errors for most modern browsers.
====

In this section, we create three separate self-signed certificates. This is for demonstration purposes only, and is *not recommended* as a solution for production workloads. Consult your certificate authority to understand how to create a certificate with similar attributes for your production workloads.

To work correctly, the certificates we create needs a Common Name (CN) that match each of the individual component routes.

. To generate our certificates, we can run the following `openssl` commands:
+
[source,bash]
----
$ openssl req -newkey rsa:2048 -new -nodes -x509 -days 365 -keyout ${SCRATCH}/key-console.pem -out ${SCRATCH}/cert-console.pem -subj "/CN=console-openshift-console.${NEW_BASE_DOMAIN}"
$ openssl req -newkey rsa:2048 -new -nodes -x509 -days 365 -keyout ${SCRATCH}/key-downloads.pem -out ${SCRATCH}/cert-downloads.pem -subj "/CN=downloads-openshift-console.${NEW_BASE_DOMAIN}"
$ openssl req -newkey rsa:2048 -new -nodes -x509 -days 365 -keyout ${SCRATCH}/key-oauth.pem -out ${SCRATCH}/cert-oauth.pem -subj "/CN=oauth-openshift.${NEW_BASE_DOMAIN}"
----
+
This will generate six `.pem` files, a certificate and key for each component route in our scratch directory.
+
. Next, we need to concatenate both the keys and certificates into their own individual file. To do so, run the following command:
+
[source,bash]
----
$ cat ${SCRATCH}/cert-console.pem ${SCRATCH}/cert-downloads.pem ${SCRATCH}/cert-oauth.pem > ${SCRATCH}/combined-certs.pem
$ cat ${SCRATCH}/key-console.pem ${SCRATCH}/key-downloads.pem ${SCRATCH}/key-oauth.pem > ${SCRATCH}/combined-keys.pem
----

[id="add-certificate-as-cluster-secret_{context}"]
== Add the certificate to the cluster as a secret

. Create a TLS secret in the `openshift-config` namespace that contains your concatenated.
+
The `custom-component-tls` secret becomes your secret reference when you update the component routes later in this guide.
+
[source,bash]
----
$ oc -n openshift-config create secret tls custom-component-tls --cert=${SCRATCH}/combined-certs.pem --key=${SCRATCH}/combined-keys.pem
----

[id="add-routes-to-dns_{context}"]
== Add component route DNS records to your DNS provider

When you create a ROSA cluster, ROSA automatically creates a load balancer. AWS generates a hostname for that load balancer that we need to be able to create DNS records for our cluster.

. To get the hostname of the default IngressController load balancer, run the following command:
+
[source,bash]
----
$ export DEFAULT_INGRESS_LB=$(oc -n openshift-ingress get svc/router-default -o jsonpath='{.status.loadBalancer.ingress[].hostname}')
$ echo "Load Balancer Domain: ${DEFAULT_INGRESS_LB}"
----
+
.Example output
[source,text]
----
Load Balancer Domain: a188c08ca91714ce989a9096646d41f4-1955205717.us-west-2.elb.amazonaws.com
----
+
. At your domain's DNS provider, add three new CNAME DNS records that map each of your new component routes to the load balancer hostname we looked up in the previous step. The below command will output the records that you need to create:
+
[source,bash]
----
$ echo "console-openshift-console.${NEW_BASE_DOMAIN}.  300  IN  CNAME ${DEFAULT_INGRESS_LB} "
$ echo "downloads-openshift-console.${NEW_BASE_DOMAIN}.  300 IN  CNAME ${DEFAULT_INGRESS_LB}"
$ echo "oauth-openshift.${NEW_BASE_DOMAIN}.  300 IN  CNAME ${DEFAULT_INGRESS_LB}"
----
+
[NOTE]
====
You can take the output of this command and import the records directly into link:https://aws.amazon.com/route53/[Amazon Route 53].
====
+
.Example output
[source,text]
----
console-openshift-console.openshift.example.com. 300 IN CNAME a188c08ca91714ce989a9096646d41f4-1955205717.us-west-2.elb.amazonaws.com
downloads-openshift-console.openshift.example.com. 300 IN CNAME a188c08ca91714ce989a9096646d41f4-1955205717.us-west-2.elb.amazonaws.com
oauth-openshift.openshift.example.com. 300 IN CNAME a188c08ca91714ce989a9096646d41f4-1955205717.us-west-2.elb.amazonaws.com
----


[id="update-routes-tls-using-rosa-cli_{context}"]
== Update the component routes and TLS secret using the ROSA CLI

Once your DNS records have been created, you can use the ROSA CLI to change the component routes.

. Use the `rosa edit ingress` command to update your default ingress with the new component routes and the secret (which contains the TLS cert/key) that we created earlier.
+
[source,bash]
----
$ rosa edit ingress -c ${CLUSTER_NAME} ${INGRESS_ID} --cluster-routes-hostname="${NEW_BASE_DOMAIN}" --cluster-routes-tls-secret-ref="custom-component-tls"
----
+
[source,text]
----
Output coming when cluster creation finishes...
----

// ID    APPLICATION ROUTER                                             PRIVATE  DEFAULT  [...]  LB-TYPE  [...]  WILDCARD POLICY      NAMESPACE OWNERSHIP  HOSTNAME           TLS SECRET REF
// r3l6  https://apps.my-example-cluster-aws.z9a9.p1.openshiftapps.com  yes      yes      [...]  nlb      [...]  WildcardsDisallowed  Strict               my-new-domain.dev  component-tls
// ----

If you are using a self-signed certificate, you should temporarily add your certificate to the trust store on your local system to ensure you can successfully access the web console, OAuth server, and downloads components.