:_content-type: ASSEMBLY
[id="rosa-mobb-groupsync-okta"]
= Tutorial: Using Group Sync Operator with Okta and ROSA
include::_attributes/attributes-openshift-dedicated.adoc[]
:context: rosa-mobb-groupsync-okta

toc::[]

//Mobb content metadata
//Brought into ROSA product docs 2023-09-18
//---
//date: '2023-07-25
//title: Using Group Sync Operator with Okta and ROSA
//authors:
//  - Thatcher Hubbard
//---

This guide focuses on how to synchronize Identity Provider (IDP) groups and users after configuring authentication in Red Hat OpenShift Cluster Manager (OCM).

To set up group synchronization from Okta to ROSA you must:

. Define groups and assign users in Okta.
. Install the Group Sync Operator from the OpenShift OperatorHub.
. Create and configure a new Group Sync instance.
. Set a synchronization schedule.
. Test the synchronization process.

[id="rosa-mobb-groupsync-okta-define-groups"]
== Define groups and assign users in Okta

To synchronize groups and users with ROSA, they must exist in Okta.

. Create the groups to synchronize with ROSA if they do not already exist:
+
image::okta-grp.png[Okta Groups]

. Create user IDs to synchronize with ROSA if they do not already exist:
+
image::okta-usr.png[Okta Users]

. Assign the newly created users to the appropriate group:
+
image::okta-assign.png[Okta add user to group]

[id="rosa-mobb-groupsync-okta-install-group-sync"]
== Install the Group Sync Operator from the OpenShift OperatorHub

. In the OpenShift Operator Hub, select the **Group Sync Operator**:
+
image::grp-sync-opr-hub.png[Group Sync in OperatorHub]

. Install the Operator in the `group-sync-operator` namespace:
+
image::grp-sync-opr-inst.png[Group Sync installation]

[id="rosa-mobb-groupsync-okta-okta-admin"]
== Optional: Create an Okta Group Sync Administrator

[NOTE]
====
Tokens are created with whatever permissions the currently logged-in user has, which is typically 'Super Admin' for a developer account. This is obviously not good practice for anything other than the most basic testing.
====

Ideally, a user would be created inside the Okta organization that was specifically for group synchronizations, which should only need to be able to read groups. Creating a user with 'Read Administrator' permissions on the account would be a good place to start for following the principle of "least privilege." That user can then issue a token that includes only those permissions.

[id="rosa-mobb-groupsync-okta-access-token"]
== Create an Okta API Access Token

* Log in as a user that has minimally has Group and User read permissions and generate an API token in Okta:
+
image::okta-api-token.png[Okta API token creation]

[id="rosa-mobb-groupsync-okta-group-sync-instance"]
== Create and configure a new Group Sync instance

. Create a new secret named `okta-group-sync` in the **group-sync-operator** namespace. This will contain the Okta API key that was just created.

. Using the OpenShift CLI (`oc`), create the secret using the following format:
+
[source,terminal]
----
$ oc create secret generic okta-api-token --from-literal='okta-api-token=${API_TOKEN}' -n group-sync-operator
----

. Obtain values from Okta for the AppId and URL. The AppId is the client ID under the application created to support OpenID for the {product-name-first} cluster(s). The URL is the same as the one used to admin Okta, without the `-admin` in the first term and should look something like this:
+
[source,terminal]
----
https://dev-34278011.okta.com/
----

. Create a new Group Sync instance in the `group-sync-operator` namespace:
+
image::grp-sync-instance.png[Group Sync instance]

. Using the example below, customize the YAML to match the group names and save the configuration:
+
image::grp-sync-yaml.png[Instance YAML modification]
+
.Sample YAML
[source,yaml]
----
apiVersion: redhatcop.redhat.io/v1alpha1
kind: GroupSync
metadata:
  name: okta-sync
spec:
  schedule: "*/1 * * * *"
  providers:
    - name: okta
      okta:
        credentialsSecret:
          name: okta-api-token
          namespace: group-sync-operator
        groups:
          - ocp-admins
          - ocp-restricted-users
        prune: true
        url: "<Okta URL here>"
        appId: <Okta AppID here>
----

[id="rosa-mobb-groupsync-okta-sync-schedule"]
== Set a synchronization schedule

The Group Sync Operator provides a cron-based scheduling parameter for specifying how often the groups and users should be synchronized. This can be set in the instance YAML file during initial configuration or at any time after.

The schedule setting of `schedule: "* * * * \*"` would result in synchronization occurring every minute. It also supports the cron "slash" notation (e.g., "*/5 * * * *", which would synchronize every five minutes).

[id="rosa-mobb-groupsync-okta-test-sync"]
== Testing the synchronization process

. Check to see if the Group Sync process has completed with a `Condition: ReconcileSuccess` message:
+
image::grp-sync-success.png[Successful Sync]

. Check to see that all the groups specified in the configuration YAML file show up in the ROSA Groups list:
+
image::grp-sync-success-grp.png[Groups added]

. Validate that all users specified in Okta also show up as members of the associated group in ROSA:
+
image::grp-sync-success-usr.png[Users added]

. Add a new user in Okta and assign it to the admin group:
+
image::grp-sync-new-usr.png[New User added]

. Verify that the user now appears in ROSA after the specified synchronization time:
+
image::grp-sync-new-admin.png[New admin added]

. Deactivate a user from the Okta admin group:
+
image::grp-sync-deactivate-admin.png[Delete admin user]

. Verify the user has been deleted from the ROSA admin group:
+
image::grp-sync-verify-del-admin.png[Verify Delete admin user]

[id="rosa-mobb-groupsync-okta-bind-groups"]
== Binding Groups to Roles

The preceding steps provide a method to get group membership information into OpenShift, but the final step in translating that into user authorization control requires binding each group to a role or roles on the cluster. This can be done via the OCP web console by opening the Group detail, or by applying YAML via the CLI.

[id="rosa-mobb-groupsync-okta-config-options"]
== Additional Okta configuration options

. There are also other options that are provider-specific that are covered in the link:https://github.com/redhat-cop/group-sync-operator#okta[Operator documentation] that should be kept in mind:

- Pruning groups that cease to exist on Okta
- A numeric limit on the number of groups to sync
- A list of groups to match against

. If there is a need to have multiple GroupSync configurations against multiple providers, note that there is no "merge" functionality in the Operator when it comes to group membership. If a group named `ocp-admins` is present in two directories with sync jobs, they will effectively overwrite each other each time the sync job runs. It is recommended to name groups intended for use on OCP such that they indicate from which directory they originate (e.g., `okta-ocp-admins` or something like `okta-contoso-ocp-admins` in the case of multiple Okta providers). Bind multiple groups with the same permissions needs to the same `Role` or `ClusterRole` as needed.