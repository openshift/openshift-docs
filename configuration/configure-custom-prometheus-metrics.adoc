:_mod-docs-content-type: ASSEMBLY
[id="configure-custom-prometheus-metrics"]
= Configuring custom Prometheus metrics
include::modules/common-attributes.adoc[]
:context: configure-custom-prometheus-metrics

toc::[]

[role="_abstract"]
With {product-title}, you can enable some Prometheus metrics to be exposed on the `/metrics` path of the central API endpoint.

The available metric categories include:

* Image vulnerabilities;
* Node vulnerabilities;
* Policy violations;
* Total policy numbers;
* Cluster health;
* Certificate expiry.


Each category is configured with a data gathering period and a list of metrics. A metric is associated with a set of labels.

[NOTE]
====
The `/metrics` path is accessible for API tokens with Administration resource view permissions. The values of the labels are subject to Scoped Access Control.
====

The currently enabled metrics, if any, are shown on the *System Configuration* page of the *Platform Configuration* section of the {product-title} UI. In edit mode, the UI allows you to enable or disable one of the predefined metrics.

The `/v1/config` API allows for configuring metrics with custom metric names and a custom set of labels.

Accepted image vulnerability labels:

* Cluster
* Namespace
* Deployment
* IsPlatformWorkload
* ImageID
* ImageRegistry
* ImageRemote
* ImageTag
* Component
* ComponentVersion
* OperatingSystem
* CVE
* CVSS
* Severity
* EPSSPercentile
* EPSSProbability
* IsFixable

Accepted node vulnerability labels:

* Cluster
* Node
* Kernel
* OperatingSystem
* OSImage
* Component
* ComponentVersion
* CVE
* CVSS
* Severity
* EPSSPercentile
* EPSSProbability
* IsFixable
* IsSnoozed

Accepted policy violation labels:

* Cluster
* Namespace
* Resource
* Deployment
* IsDeploymentActive
* IsPlatformComponent
* Policy
* Categories
* Severity
* Action
* Message
* Stage
* State
* Entity
* EntityName

The total policy numbers are exposed as `rox_central_cfg_total_policies` metric, and contains the following label:

* Enabled

The cluster health metric is exposed as `rox_central_health_cluster_info`, and contains the following labels:

* Cluster
* Type
* Status
* Upgradability

The certificate expiry metric is exposed as `rox_central_cert_exp_hours`, and contains the following label:

* Component

== Configuring User Workload monitoring

.Prerequisites

Ensure that the user workload monitoring is enabled in the cluster by checking the content of the `cluster-monitoring-config` `ConfigMap` in the `openshift-monitoring` namespace.
If the `ConfigMap` does not exist, create it with the following content:

[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-monitoring-config
  namespace: openshift-monitoring
data:
  config.yaml: 'enableUserWorkload: true'
----

.Procedure

. Create a service account to be used for authorization in the namespace where the central is installed.
. Create a service account token secret in the namespace where the central is installed:
+
[source,yaml]
----
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
 name: <secret-name>
 annotations:
   kubernetes.io/service-account.name: <service account name>
----
. Go to *Platform Configuration* -> *Access Control* -> *Permission sets* and create a permission set with Read Access to the following resources:

    * Administration
    * Alert
    * Cluster
    * Deployment
    * Image
    * Namespace
    * Node
    * WorkflowAdministration

. Go to *Platform Configuration* -> *Access Control* -> *Roles* and create a role with a desired access scope and the previously created permission set.
. Go to *Platform Configuration* -> *Integrations* -> *Machine access configuration*, click on *Kubernetes service account*, click *Edit*, and add a new rule with a role mapping for key 'sub', value 'system:serviceaccount:<central namespace>:<service account name>' and the role, created in the previous step.
. Create the following `ServiceMonitor` resource in the namespace where the central is installed:
+
[source,yaml]
----
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
name: <some service monitor name>
spec:
endpoints:
- authorization:
    type: Bearer
    credentials:
      name: <secret name>
      key: token
  path: /metrics
  port: https
  scheme: https
  tlsConfig:
    insecureSkipVerify: true
selector:
  matchLabels:
    app.kubernetes.io/component: central
----

After a few minutes the metrics should become available in *OpenShift Console* -> *Observe* -> *Metrics*.
