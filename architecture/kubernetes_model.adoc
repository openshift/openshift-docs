= Kubernetes Model
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc:
:toc-placement!:
:toc-title:

toc::[]

== Pod

In a Kubernetes environment, a pod is a group of shared Docker containers on a host, and the smallest deployable unit that can be created, scheduled, and managed.

Each pod has its own IP address, therefore owning its entire port space. Containers within pods can also share storage. Pods can be "tagged" with one or more labels, which are then used to select and manage pod groups in a single operation.

The following JSON example was retrieved from an OpenShift system by running `osc get pods/<pod_id>`.

.Sample JSON output for a Kubernetes pod object.
----
{
    "annotations": {
        "deployment": "docker-registry-1" <1>
    },
    "apiVersion": "v1beta1",
    "creationTimestamp": "2015-01-08T13:12:31-05:00",
    "currentState": {
        "host": "host.example.com",
        "info": {
            "deployment": {
                "containerID": "docker://0d9b9c3dee08c6b5f22ef5d6fcba2f3991d713c6b337d036d5434b496ae207ef",
                "image": "openshift/origin-deployer",
                "restartCount": 0,
                "state": {
                    "termination": {
                        "exitCode": 255,
                        "finishedAt": "2015-01-08T18:12:42Z",
                        "startedAt": "2015-01-08T18:12:41Z"
                    }
                }
            },
            "net": {
                "containerID": "docker://4617946052b093310d14516e14279232da1a220bcf81a46b50dc94ae11065ea2",
                "image": "kubernetes/pause:latest",
                "podIP": "172.17.0.2",
                "restartCount": 1,
                "state": {
                    "running": {
                        "startedAt": "2015-01-13T12:10:50Z"
                    }
                }
            }
        },
        "manifest": {
            "containers": null,
            "id": "",
            "restartPolicy": {},
            "version": "",
            "volumes": null
        },
        "podIP": "172.17.0.2",
        "status": "Terminated"
    },
    "desiredState": {
        "manifest": {
            "containers": [
                {
                    "env": [
                        {
                            "key": "OPENSHIFT_DEPLOYMENT_NAME",
                            "name": "OPENSHIFT_DEPLOYMENT_NAME",
                            "value": "docker-registry-1"
                        },
                        {
                            "key": "OPENSHIFT_DEPLOYMENT_NAMESPACE",
                            "name": "OPENSHIFT_DEPLOYMENT_NAMESPACE",
                            "value": "default"
                        },
                        {
                            "key": "KUBERNETES_MASTER",
                            "name": "KUBERNETES_MASTER",
                            "value": "http://10.18.57.24:8080"
                        },
                        {
                            "key": "OPENSHIFT_MASTER",
                            "name": "OPENSHIFT_MASTER",
                            "value": "http://10.18.57.24:8080"
                        }
                    ],
                    "image": "openshift/origin-deployer", <2>
                    "imagePullPolicy": "PullIfNotPresent",
                    "name": "deployment"
                }
            ],
            "id": "",
            "restartPolicy": {
                "never": {}
            },
            "version": "v1beta2",
            "volumes": null
        }
    },
    "id": "e9bae2ce-9761-11e4-86f8-f0def1de880f",
    "kind": "Pod",
    "namespace": "default",
    "resourceVersion": 14,
    "selfLink": "/api/v1beta1/pods/e9bae2ce-9761-11e4-86f8-f0def1de880f?namespace=default",
    "uid": "e9bae2ce-9761-11e4-86f8-f0def1de880f"
}
----
<1> The labels are stored in key/value format in the `annotation` hash. The original label in this example is `deployment=docker-registry-1`.
<2> The Docker image(s) that define the pod are provided in the `containers` list along with related environment variable mappings.

== Label

Labels are used to organize, group, or select objects and resources, such as pods. Pods are "tagged" with labels, and then services and replication controllers use labels to indicate the pods they relate to. This makes it possible for services and replication controllers to reference whole groups of pods, or treat pods with potentially different Docker containers as similar entities.

Labels are a Key/Value pair, and shown in the following example:

----

"labels": {
  "key1" : "value1",
  "key2" : "value2"
}
----

Consider:

* A pod consisting of an nginx Docker container, with the label "role=webserver"
* A pod consisting of an Apache Docker container, with the same label "role=webserver"

A service or replication controller that is defined to use pods with the "role=webserver" label will treat both of these pods as part of the same group. 

For more information on labels, refer to the https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/labels.md[Kubernetes documentation]. 

== Replication Controller

A replication controller ensures that a specific number of pods set with the particular label are running at all times. If one of the matching pods or a Kubernetes host goes down, the replication controller will re-instantiate matching pods up to the defined number across the cluster. Likewise, if there are too many running, it will kill the required amount of hosts. Any new pods are created by the template set in the replication controller object.

The replication controller does not perform the auto-scaling, rather, it is controlled by an external auto-scaler, which changes the `replicas` field (see below). Replication controllers are only appropriate for pods with `RestartPolicy = Always`, and a pod with a different restart policy will be refused.  

The most important elements in the JSON structure of a replication controller object are the `replicas` and `replicaSelector` values, as shown in the following example:

----
{
    "kind": "ReplicationControllerList",
    "creationTimestamp": null,
    "selfLink": "/api/v1beta1/replicationControllers",
    "resourceVersion": 27,
    "apiVersion": "v1beta1",
    "items": [
        {
            "id": "docker-registry-1",
            "uid": "7fa58610-9b31-11e4-9dff-f0def1de880f",
            "creationTimestamp": "2015-01-13T09:36:02-05:00",
            "selfLink": "/api/v1beta1/replicationControllers/docker-registry-1?namespace=default",
            "resourceVersion": 26,
            "namespace": "default",
            "annotations": {
                ...
            },
            "desiredState": {
                "replicas": 1, <1>
                "replicaSelector": {
                    "name": "registrypod" <2>
                },
----
<1> The number of copies of the pod to run.
<2> The label selector of the pod to run.

These determine which pods to maintain. For more on replication controllers, see the https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/replication-controller.md[Kubernetes documentation].

== Service

A service provides functionality to a set of pods running inside of a Kubernetes cluster, and are determined by the defined policy (sometimes called a micro-service) used to assess the set of pods. Pods can be added or taken away from a service any number of times.

Services assign clients an IP address and port pair that, when accessed, redirect to the appropriate back end. A service uses a label selector to find all the containers running that provide a certain network service on a certain port. The service is then bound to a local port, so to access the service from inside your application or container you simply bind to the local network on the port number for the service.

Like pods, services are REST objects. To create a new service, they can be POSTed to the apiserver. The following example creates a new service with a name of "myapp", which resolves to TCP port 9376 on any pod with the "app=MyApp" label attached:

----
{
  "id": "myapp",
  "selector": {
    "app": "MyApp"
  },
  "containerPort": 9376,
  "protocol": "TCP",
  "port": 8765
}
----

For more on services, see the https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/services.md[Kubernetes documentation].
