// Module included in the following assemblies:
//
// * admin_guide/aws-getting-started.adoc

[id='aws-getting-started-before-{context}']
= Before you begin deploying the AWS Service Broker

Before you can get started deploying the AWS Service Broker, make sure you meet the prerequisites described in this topic.

.Prerequisites 

The following items are required to deploy the AWS Service Broker into {product-title}.

{product-title}::
You must have an {product-title} cluster configured to run the Service Catalog.

////
AWS Service Broker:: 
You must have an link:https://aws.amazon.com/partners/servicebroker/[AWS Service Broker] configured with an appropriate registry, such as link:https://hub.docker.com/u/awsservicebroker/[docker.io/awsservicebroker].
////

AWS Service Instance Policy::
You must create specific credential and permissions policies in AWS for the AWS Service Broker user or role.

You can create the two required policies using the xref:creating-policies[provided JSON samples], then assign the policies to the AWS Service Broker user or role or to a separate role, see link:https://github.com/awslabs/aws-servicebroker/tree/master/docs#managing-resources-via-assumed-role[Managing Resources Via Assumed Role] in the AWS Service Broker documentation repository.

One policy assigns credentials for provisioning service instances and for broker operations, such as  
fetching the catalog and reading and writing metadata to DynamoDB.

The second policy assigns permissions for provisioning, binding, and deprovisioning service instances. 

AWS User::
The AWS Service Broker requires an link:https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html[AWS Identity Access Management (IAM) user] and the associated link:http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html[IAM keys] to provision AWS services. When creating the user, select *Programmatic access* and *AWS Management Console* access types, then add the two policies you created.

IAM Role::
The AWS Service Broker requires an IAM Role to access link:https://aws.amazon.com/cloudformation/[AWS CloudFormation] when provisioning services. 
The role must allow full create and manage permissions for CloudFormation. 

Use the the AWS Management Web Console to create this role for the *CloudFormation* entity and assign *AdministratorAccess* to the role.

Amazon Resource Name::
After creating the role, locate the Amazon Resource Name (ARN) on the role access summary page using the AWS console. You need the role ARN during the deployment process.

The role ARN has the following format:

[source,bash]
----
arn:aws:iam::47458525407874:role/CloudFormation
----

[NOTE]
====
Optionally, the AWS Service Broker can link:https://github.com/awslabs/aws-servicebroker/tree/master/docs#managing-resources-via-assumed-role[manage multiple clusters across AWS accounts using a single role].
====

AWS Command Line Interface::
If you want to use the command line to work with AWS, you must install the link:https://docs.aws.amazon.com/cli/latest/userguide/installing.html[AWS Command Line Interface], which requires
link:https://developers.redhat.com/blog/2018/08/13/install-python3-rhel/[Python], and link:https://access.redhat.com/solutions/1519803[pip].

After installing the AWS CLI, you need to set up the CLI:

----
# aws configure
AWS Access Key ID [None]: 4742874 
AWS Secret Access Key [None]: OxkHnH96RENVJzL8/UlGZA5t75
Default region name [None]: us-east-1
Default output format [None]: json <1>
----

<1> Default output format can be either `json`, `text`, or `table`. `json` is the default. 


DynamoDB Table::
You need to create an link:https://aws.amazon.com/dynamodb/[Amazon DynamoDB] table for persistent storage.

Run the following command in the AWS CLI to create the table:

[source,bash]
----
# aws dynamodb create-table --attribute-definitions \
AttributeName=id,AttributeType=S AttributeName=userid,AttributeType=S \
AttributeName=type,AttributeType=S --key-schema AttributeName=id,KeyType=HASH \
AttributeName=userid,KeyType=RANGE --global-secondary-indexes \
'IndexName=type-userid-index,KeySchema=[{AttributeName=type,KeyType=HASH},{AttributeName=userid,KeyType=RANGE}],Projection={ProjectionType=INCLUDE,NonKeyAttributes=[id,userid,type,locked]},ProvisionedThroughput={ReadCapacityUnits=5,WriteCapacityUnits=5}' \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--region us-east-1 --table-name awssb <1>
----

<1> Change the `--region` and `--table-name` parameters as needed. 

The command output reports that the table is created or there is an error. The output for a successful creation includes:

----
"CreationDateTime": 1539185077.534
----

You can also use the DynamoDB dashboard in AWS to see the table. 

[[creating-policies]]
== Creating the required AWS policies

You must create specific credential and permissions policies in AWS for the AWS Service Broker user or role.

Both of these policies take your AWS account ID, user ID and ARN. You can find this information in AWS. If you have the 
AWS CLI, use the following command to get your AWS account information:

[source,bash]
----
# aws sts get-caller-identity
{
    "Account": "474574", 
    "UserId": "AIDAA7ZGME4S", 
    "Arn": "arn:aws:iam::474574:user/Administrator"
----

.Procedure

To create the required policies:

. In the *Policies* page of the AWS IAM Dashboard, enter the following JSON code for the credentials policy:
+
[source-json]
----
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": [
         "s3:GetObject",
         "s3:ListBucket"
      ],
      "Resource": [
         "arn:aws:s3:::awsservicebroker/templates/*",
         "arn:aws:s3:::awsservicebroker"
      ],
      "Effect": "Allow"
    },
    {
      "Action": [
        "dynamodb:PutItem",
        "dynamodb:GetItem"
      ],
      "Resource": "arn:aws:dynamodb:<REGION>:<ACCOUNT_ID>:table/<TABLE_NAME>", <1>
      "Effect": "Allow"
    },
    {
      "Action": [
        "ssm:GetParameter",
        "ssm:GetParameters"
      ],
      "Resource": "arn:aws:ssm:<REGION>:<ACCOUNT_ID>:parameter/asb-*", <2>
      "Effect": "Allow"
    }
  ]
}
----
+
<1> Replace the parameters with your AWS region, your AWS account ID, and the name of the DynamoDB table you created.
<2> Replace the parameters with your AWS region and your AWS account ID.

. In the *Policies* page of the AWS IAM Dashboard, enter the following JSON code for the permissions policy:
+
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "SsmForSecretBindings",
        "Action": "ssm:PutParameter",
        "Resource": "arn:aws:ssm:<REGION>:<ACCOUNT_ID>:parameter/asb-*",
        "Effect": "Allow"
      },
      {
        "Sid": "AllowCfnToGetTemplates",
        "Action": "s3:GetObject",
        "Resource": "arn:aws:s3:::awsservicebroker/templates/*",
        "Effect": "Allow"
      },
      {
         "Sid": "CloudFormation",
         "Action": [
            "cloudformation:CreateStack",
            "cloudformation:DeleteStack",
            "cloudformation:DescribeStacks",
            "cloudformation:UpdateStack",
            "cloudformation:CancelUpdateStack"
         ],
         "Resource": [
            "arn:aws:cloudformation:<REGION>:<ACCOUNT_ID>:stack/aws-service-broker-*/*" <1>
         ],
         "Effect": "Allow"
      },
     {
        "Sid": "ServiceClassPermissions",
        "Action": [
           "athena:*",
           "dynamodb:*",
           "kms:*",
           "elasticache:*",
           "elasticmapreduce:*",
           "kinesis:*",
           "rds:*",
           "redshift:*",
           "route53:*",
           "s3:*",
           "sns:*",
           "sns:*",
           "sqs:*",
           "ec2:*",
           "iam:*",
           "lambda:*"
        ],
        "Resource": [
           "*"
        ],
        "Effect": "Allow"
     }
   ]
}
----
+
<1> Replace the parameters with your AWS region and your AWS account ID.


