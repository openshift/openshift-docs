[[scaling-performance-optimizing-storage]]
= Optimizing Storage
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

== Optimizing Storage

== General Storage Guidance

The following is a matrix which details the persistent storage backend types {product-title} can be used with, and includes implementation examples and vendors.

=== Available Storage Options
[format="csv",width="70%",cols="3"]
[options="header]
|=======================
Type,Examples,Vendors
hostPath,"hostPath pod mounted volumes.  A specific type of Block Storage.  File paths on the node mounted onto running pods.",Others
Block,"Block Storage.  VMDK, iSCSI, Fibre Channel, Ceph RBD, OpenStack Cinder, Dell/EMC Scale.IO, AWS EBS ^(1)^, GCE Persistent Disk ^(1)^, Azure Disk","RedHat, Seagate, WesternDigital, Toshiba, HGST, Intel, Samsung, OCZ, Plextor, PNY, Kingston, SanDisk, AWS, Azure, GCE, VMware, Dell/EMC, HPE, Others"
File,"Network Attached File Storage.  CNS GlusterFS ^(1)^, GlusterFS ^(1)^, RHEL NFS, NetApp NFS ^(2)^, Azure File, Vendor NFS, Vendor GlusterFS ^(3)^, Loopback Image over NFS","RedHat, NetApp, Azure, Others"
Object,"Object Storage.  Ceph Object Storage, OpenStack Swift,  AWS S3, Google Cloud Storage, Vendor S3 ^(3)^, Vendor Swift ^(3)^","RedHat, AWS, GCE, Others"
|=======================
NOTE: ^(1)^ Ceph RBD, OpenStack Cinder, GlusterFS, AWS EBS, Azure Disk, GCE Persistent Disk support Dynamic PV Provisioning natively in {product-title}.

NOTE: ^(2)^ NetApp NFS supports Dynamic PV Provisioning when using the Trident Plugin

WARNING: ^(3)^ Vendor GlusterFS, Vendor S3, and Vendor Swift supportability and configurability may vary.

=== Storage Backend Recommendations
Below is a matrix that summarizes which storage backend types are Recommended, Supported, and Configurable for the given
{product-title} application and useful attributes.
[format="csv",width="70%",cols="9"]
[options="header]
|=======================
Type,Tied to Node?,ROM,RWX,Registry,Scaled Registry,Metrics,Logging,Apps
hostPath,Yes,No,No,Configurable,Not Configurable,Recommended,Recommended,Configurable
Block,No^(1)^,Yes^(2)^,No,Supported,Not Configurable,Recommended,Recommended,Recommended
File,No,Yes^(2)^,Yes,Supported,Configurable,Configurable,Configurable,Recommended
Object,No,Yes,Yes,Recommended,Recommended,Not Configurable,Not Configurable,Recommended^(3)^
|=======================
NOTE: ^(1)^ This does not apply to VMDK.  This storage type is tied to the node.

NOTE: ^(2)^ This does not apply to Physical Disk, VM Physical Disk, VMDK, Loopback over NFS, AWS EBS, and Azure Disk.

NOTE: ^(3)^Object Storage is not used via {product-title}'s PVs.  Apps must integrate with the Object Storage API.

==== Specific Application & Storage Recommendations
===== Registry
In a non-scaled/HA {product-title} Internal Docker Registry cluster deployment, the preferred Storage Backend is Ojbect Storage
followed by Block Storage.  The Storage Backend does not need to support ReadWriteMany Access Mode.  The Storage Backend *must
ensure Read-After-Write-Consistency*.  All Network Attached File Storage Backends are expressly *not recommended* for Internal
Docker Registry cluster deployment.  While hostPath volumes are configurable for a non-scaled/HA {product-title} Internal Docker Registry cluster deployment, they are not recommended.

===== Scaled Registry
In a scaled/HA {product-title} Internal Docker Registry cluster deployment, the preferred Storage Backend is Ojbect Storage.
The Storage Backend *must support ReadWriteMany* Access Mode and *must ensure Read-After-Write-Consistency*.  Block Storage is
expressly *not recommended* for a scaled/HA {product-title} Internal Docker Registry cluster deployment.  All Network File
Storage Backends are expressly *not recommended* for Internal Docker Registry cluster deployment.

===== Metrics
In {product-title} Hosted Metrics cluster deployment, the preferred Storage Backend is Block Storage.  All Network Attached File
Storage Backends are expressly *not recommended* for Hosted Metrics cluster deployment.

===== Logging
In {product-title} Hosted Logging cluster deployment, the preferred Storage Backend is Block Storage.  All Network Attached File
Storage Backends are expressly *not recommended* for Hosted Logging cluster deployment.

===== Apps
Application use cases vary from app to app.  Storage Backends which support Dynamic PV Provisioning, have low mount time latencies, and are not tied to nodes support a healthy cluster.  NFS does not gurantee Read-After-Write-Consistency and is not recommended for applications which require it.  Applications which depend on writing to the same NFS export may experience issues at high volume.

==== Other Specific Application Storage Recommendations
===== {product-title} Internal etcd
For the best etcd reliability, the lowest consistent latency Storage Backend is preferrable.

===== OpenStack Cinder
OpenStack Cinder tends to be adept in ReadOnlyMany use cases.

===== Databases
Databases (RDBMSs, NoSQL, etc.) tend to perform best with dedicated Block Storage.


== Choosing a Docker graph driver

Docker stores images and containers in a graph driver (a pluggable storage
backend), such as Device Mapper, Overlay, and Btrfs. Each have advantages and
disadvantages. For example, Overlay is faster than Device Mapper at starting and
stopping containers, but is not POSIX compliant because of the architectural
limitations of a union file system, and does not yet support SELinux.

For more information about Overlay, including supportability and usage caveats,
link:https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html-single/7.3_Release_Notes/index.html#technology_previews_file_systems[see
the RHEL 7.3 Release Notes].

In production environments, using a LVM thin pool on top of regular block
devices (not loop devices) for container images and container root file systems
storage is recommended. 

[NOTE]
====
Using a Loop device back-end can affect performance issues. While you can still
continue to use it, Docker logs a warning message. For example:

----
devmapper: Usage of loopback devices is strongly discouraged for production use.
Please use `--storage-opt dm.thinpooldev` or use `man docker` to refer to
dm.thinpooldev section.
----
====

To ease Docker backend storage configuration, use the
`docker-storage-setup` utility, which automates much of the configuration
details:

. If you had a separate disk drive dedicated to Docker storage (for example,
*_/dev/xvdb_*), add the following to the *_/etc/sysconfig/docker-storage-setup_*
file:
+
----
DEVS=/dev/xvdb
VG=docker_vg
----

. Restart the `docker-storage-setup` service:
+
----
# systemctl restart docker-storage-setup
----
+
After the restart, `docker-storage-setup` sets up a volume group named
`docker_vg` and creates a thin pool logical volume. Documentation for thin
provisioning on RHEL is available in the
link:https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html-single/Logical_Volume_Manager_Administration/index.html[LVM
Administrator Guide]. View the newly created volumes with the `lsblk` command:
+
----
# lsblk /dev/xvdb
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
xvdb 202:16 0 20G 0 disk
└─xvdb1 202:17 0 10G 0 part
  ├─docker_vg-docker--pool_tmeta 253:0 0 12M 0 lvm
  │ └─docker_vg-docker--pool 253:2 0 6.9G 0 lvm
  └─docker_vg-docker--pool_tdata 253:1 0 6.9G 0 lvm
  └─docker_vg-docker--pool 253:2 0 6.9G 0 lvm
----
+
[NOTE]
====
Thin-provisioned volumes are not mounted and have no file system (individual
containers do have an XFS file system), thus they will not show up in “df”
output.
====

. To verify that Docker is using a LVM thin pool, and to monitor disk space
utilization, use the `docker info` command. The `Pool Name` will correspond with
the `VG` you specified in *_/etc/sysconfig/docker-storage-setup_*:
+
----
# docker info | egrep -i 'storage|pool|space|filesystem'
Storage Driver: devicemapper
 Pool Name: docker_vg-docker--pool
 Pool Blocksize: 524.3 kB
 Backing Filesystem: xfs
 Data Space Used: 62.39 MB
 Data Space Total: 6.434 GB
 Data Space Available: 6.372 GB
 Metadata Space Used: 40.96 kB
 Metadata Space Total: 16.78 MB
 Metadata Space Available: 16.74 MB
----

By default, a thin pool is configured to use 40% of the underlying block device.
As you use the storage, LVM automatically extends the thin pool up to 100%. This
is why the `Data Space Total` value does not match the full size of the
underlying LVM device. This auto-extend technique was used to unify the storage
approach taken in both Red Hat Enterprise Linux and Red Hat Atomic Host, which
only uses a single partition.

In development, Docker in Red Hat distributions defaults to a
loopback mounted sparse file. To see if your system is using the loopback mode:

----
# docker info|grep loop0
 Data file: /dev/loop0
refarch-feedback@redhat.com 16 www.redhat.com
----

[IMPORTANT]
====
Red Hat strongly recommends using the Device Mapper storage driver in thin pool
mode for production workloads.
====

Overlay is also supported for Docker use cases as of Red Hat Enterprise Linux
7.2, and provides faster start up time and page cache sharing, which can
potentially improve density by reducing overall memory utilization.



