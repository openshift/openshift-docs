[id='odo-disconnected-env']
= Running odo in environment disconnected from the Internet
include::modules/openshift-developer-cli-attributes.adoc[]
include::modules/common-attributes.adoc[]
:context: odo-running-in-disconnected-envs
toc::[]

// TODO -> general steps for both java/nodejs
// Question: Is only node.js and java supported for this?
// TODO: windows
// todo: do you have to be logged in to https://catalog.redhat.com/ to access to containers? (registry.redhat.io -> seems=yes, registry.access.redhat.com -> seems that login is not required). All links are registry.access.redhat.com so no login required.

.Prerequisites
* oc installed in the disconnected cluster
* odo installed in the disconnected cluster
* A mirror registry created in the disconnected cluster
// https://docs.openshift.com/container-platform/4.2/installing/install_config/installing-restricted-networks-preparations.html
// TODO -> find docs how to setup a disconnected cluster
// ^ yes they are there

== Mirroring the `odo-init-image` into the cluster's local registry from upstream registry
// How to upload the init image and export it through env ODO_BOOTSTRAPPER_IMAGE in a disconnected environment having a mirror registry
// cluster can have multiple local registries
// mirror registry != local registry
//How to setup a mirror registry?

. Encode the mirror registry's root CA content
+
----
$ echo <ContentOf_additional_ca> | base64 -d > disconnect-ca.crt
----
//mirror registry root certificate -> 
. Trust root CA certificate in your client platform and login to OpenShift mirror registry with Docker
//copy the certificate, run update-ca-trust, restart docker and login to docker with 
+
----
$ sudo cp ./disconnect-ca.crt /etc/pki/ca-trust/source/anchors/<mirror-registry>.crt
$ sudo update-ca-trust enable
$ sudo systemctl daemon-reload
$ sudo systemctl restart docker
$ docker login <mirror-registry>:<port> -u <mirror_registry_username> -p <mirror_registry_password>
----
+
[NOTE]
====
CA certificate path varies between different operating systems.
====
//where is it on RHEL?

//TODO: prereq: create a mirror registry in the disconnected cluster 
. Mirror the `odo-init-image` into the local mirror registry
----
$ oc image mirror registry.access.redhat.com/openshiftdo/odo-init-image-rhel7:latest <mirror-registry>:<port>/openshiftdo/odo-init-image-rhel7:latest
----

. Overwrite the `odo-init-image` path using the environment variable `ODO_BOOTSTRAPPER_IMAGE`
//linux win variable
//todo: macOS/windows
//odo uses this variable as an override for default path ("default" registry)
----
$ export ODO_BOOTSTRAPPER_IMAGE=<mirror-registry>:<port>/openshiftdo/odo-init-image-rhel7:latest
----


[id="deploy_nodejs_in_restricted_env_{context}"]
== Deploying a Node.js app using odo in a restricted environment

.Prerequisites
* Mirror and export the odo-init-image

=== Creating a Node.js component in a disconnected cluster:

. Check that the `nodejs` builder image is available. This example did not find the `nodejs` builder image.
// This example 
// registry.access.redhat.com/openshiftdo/odo-init-image-rhel7:latest
// hostname/namespace/imagename
// if namespace==openshift -> everything can use the image
// use this command to check if the builder image is available "globally"
// (`odo catalog list components` is run by the logged in odo user, and the user might have private images (from private image streams, not available globally))
----
$ oc describe is nodejs -n openshift
Name:                   nodejs
Namespace:              openshift
[...]

10
  tagged from <mirror-registry>:<port>/rhoar-nodejs/nodejs-10
    prefer registry pullthrough when referencing this tag

  Build and run Node.js 10 applications on RHEL 7. For more information about using this builder image, including OpenShift considerations, see https://github.com/nodeshift/centos7-s2i-nodejs.
  Tags: builder, nodejs, hidden
  Example Repo: https://github.com/sclorg/nodejs-ex.git

  ! error: Import failed (NotFound): dockerimage.image.openshift.io "<mirror-registry>:<port>/rhoar-nodejs/nodejs-10:latest" not found
      About an hour ago

10-SCL (latest)
  tagged from <mirror-registry>:<port>/rhscl/nodejs-10-rhel7
    prefer registry pullthrough when referencing this tag

  Build and run Node.js 10 applications on RHEL 7. For more information about using this builder image, including OpenShift considerations, see https://github.com/nodeshift/centos7-s2i-nodejs.
  Tags: builder, nodejs
  Example Repo: https://github.com/sclorg/nodejs-ex.git

  ! error: Import failed (NotFound): dockerimage.image.openshift.io "<mirror-registry>:<port>/rhscl/nodejs-10-rhel7:latest" not found
      About an hour ago

[...]
----


. Import the `nodejs` builder image from the Red Hat image registry to the local mirror registry.
+
----
$ oc image mirror registry.access.redhat.com/rhscl/nodejs-10-rhel7:latest <mirror-registry>:<port>/rhscl/nodejs-10-rhel7:latest
----

. Update the image stream in the local mirror registry.
+
----
$ oc tag <mirror-registry>:<port>/rhscl/nodejs-10-rhel7:latest nodejs-10-rhel7:latest --scheduled
----
// if you import an image to the local registry, you have to refresh the registry's path's
// tl;dr https://docs.openshift.com/container-platform/4.1/openshift_images/image-streams-manage.html#images-imagestreams-import_image-streams-managing
// no automatic image refresh, you have to enforce it with ^
// happens immediately

. Check that the  `nodejs` builder image has been imported into the `openshift` namespace. (From the Red Hat image registry to the local mirror registry).
//just run oc describe ... again
+
----
$ oc describe is nodejs -n openshift
Name:                   nodejs
[...]
10-SCL (latest)
  tagged from <mirror-registry>:<port>/rhscl/nodejs-10-rhel7
    prefer registry pullthrough when referencing this tag

  Build and run Node.js 10 applications on RHEL 7. For more information about using this builder image, including OpenShift considerations, see https://github.com/nodeshift/centos7-s2i-nodejs.
  Tags: builder, nodejs
  Example Repo: https://github.com/sclorg/nodejs-ex.git

  * <mirror-registry>:<port>/rhscl/nodejs-10-rhel7@sha256:d669ecbc11ac88293de50219dae8619832c6a0f5b04883b480e073590fab7c54
      3 minutes ago

[...]
----

. Create a project `nodejs` with Node.js component sourced from a local Git repository
//Prereq: git repository for this (local)
//git component =~ managed by git
//option 1 --git = if your source code lives in git and you want to source it directly (--git https://github.com/openshift)
//option 2 --context = source is in local source (local pc)
//todo rewrite this a little, according to ^ (you either create a project with git as a source or local source(as a source))
+
----
$ odo component create nodejs --project nodejs --git <your_git_source>
 ✓  Validating component [717ms]

Please use `odo push` command to create the component with source deployed
----

. (OR) Create a project `nodejs` with Node.js component sourced from a local folder.
// building from source
+
----
$ odo component create nodejs --project nodejs --context <your_local_source>
 ✓  Validating component [717ms]

Please use `odo push` command to create the component with source deployed
----


//this vvvvvvv has to be a prereq. TODO-> create a local npm registry. Not in a container, but so the openshift can access it.
[NOTE]
====
A mirror of `npm` registry has to be created and configured within the cluster, so that the npm packages will be sourced form the cluster's registry. To overwrite the mirror registry use 
`odo config set --env NPM_MIRROR=<npm_mirror_registry>` or 
`odo component create nodejs --env NPM_MIRROR=<npm_mirror_registry>`.
====
//`odo config set --env NPM_MIRROR=<npm_mirror_registry>` -> setting the variable to an existing project
//`odo component create nodejs --env NPM_MIRROR=<npm_mirror_registry>`. -> set the variable when creating the project

//maybe a note? -> setup an internal npm repository if you use packages from private repos (that are not in public npm.

. Push the `nodejs` component into the cluster.
+
[NOTE]
====
Use `odo push --context`<source_directory>` when running the command from outside the component's directory.
====
+
----
$ odo push
Validation
 ✓  Checking component [1s]

Configuration changes
 ✓  Initializing component
 ✓  Creating component [3s]
 ✓  Triggering build from git [327ms]
 ✓  Waiting for build to finish [57s]
 ✓  Deploying component nodejs-nfou [20s]

Pushing to component nodejs-nfou of type git
 ✓  Changes successfully pushed to component
----

. Create a route for the `nodejs` component
+
----
$ odo url create
 ✓  URL nodejs-nfou-8080 created for component: nodejs-nfou

To create URL on the OpenShift Cluster, please use `odo push`
----
+
[NOTE]
====
Use `odo url create --context`<source_directory>` when running the command from outside the component's directory.
====

. Push the component to the cluster again to apply the route. Note down the route.
+
[NOTE]
====
Use `odo push --context`<source_directory>` when running the command from outside the component's directory.
====
+
----
$ odo push
Validation
 ✓  Checking component [1s]

Configuration changes
 ✓  Retrieving component data [2s]
 ✓  Triggering build from git [336ms]
 ✓  Waiting for build to finish [1m]
 ✓  Applying configuration [26s]

Applying URL changes
 ✓  URL nodejs-nfou-8080: http://<route> created

Pushing to component nodejs-nfou of type git
 ✓  Changes successfully pushed to component
----

. Verify that the component is pushed into the cluster by accessing the route from the output of the previous command.
+
----
$ curl -I http://<route>
HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 40430
ETag: W/"9dee-3nm2OJV/pDUlKWUTQSk1Z/pOG6E"
Date: Wed, 15 Jan 2020 14:42:13 GMT
Set-Cookie: 2cef9c93633b1f9f7c3099d544c96c9f=f432286f4f4c7989d049174ac42cffa6; path=/; HttpOnly
Cache-control: private
----





[id="deploy_java_in_restricted_env_{context}"]
== Deploying a Java app using odo in a restricted environment

1. Mirror and export the odo-init-image
//todo reuse module(whatever) ^ reuse the Mirror and export the odo-init-image
2. Create and push the component
   option a git component
   option b local source code
   option c locally compiled binary (.jar/.war)

=== How to create and push a java component:

. Check that the `java` builder image is available. This example did not find the `java` builder image.

----
$ oc describe is java -n openshift
Name:                   java
[...]
11 (latest)
  tagged from <mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest
    prefer registry pullthrough when referencing this tag

  Build and run Java applications using Maven and OpenJDK 11.
  Tags: builder, java, openjdk
  Supports: java:11, java
  Example Repo: https://github.com/jboss-openshift/openshift-quickstarts

  ! error: Import failed (NotFound): dockerimage.image.openshift.io "<mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest" not found
      46 hours ago

[...]
----

. Import the `java` builder image from the Red Hat image registry to the local mirror registry.
+
----
$ oc image mirror registry.access.redhat.com/openjdk/openjdk-11-rhel7:latest <mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest
----

. Update the image stream in the local mirror registry.
+
----
$ oc tag <mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest openjdk-11-rhel7:latest --scheduled
----

. Check that the  `java` builder image has been imported into the `openshift` namespace. (From the Red Hat image registry to the local mirror registry).
+
----
$ oc describe is java -n openshift
Name:                   java
[...]

11 (latest)
  tagged from <mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest
    prefer registry pullthrough when referencing this tag

  Build and run Java applications using Maven and OpenJDK 11.
  Tags: builder, java, openjdk
  Supports: java:11, java
  Example Repo: https://github.com/jboss-openshift/openshift-quickstarts

  * <mirror-registry>:<port>/openjdk/openjdk-11-rhel7@sha256:4453c8ab3c428d81b69258500908386c006f7dbacad02024b032cb56fa836f75
      19 hours ago
[...]
----

. Create a project `java` with Java component sourced from a local Git repository
+
----
$ odo component create java --project java --git <your_git_source>
 ✓  Validating component [697ms]

Please use `odo push` command to create the component with source deployed
----

. (OR) Create a project `java` with Java component sourced from a local folder.
+
----
$ odo component create java --project java --context <your_local_source>
 ✓  Validating component [697ms]

Please use `odo push` command to create the component with source deployed
----

. (OR) Create a project `java` with Java component sourced from a local folder with a compiled Java binary.
+
----
$ odo component create java --project java --context <your_bin_source>
 ✓  Validating component [697ms]

Please use `odo push` command to create the component with source deployed
----
+
//TODO, rewrite this to be more nice vvvvvvvvvv, and add as a prereq
[NOTE]
====
A mirror maven registry should be created and configure with the cluster, so that maven packages will be downloaded form the mirror registry. To overwrite the mirror registry you can use odo config set --env MAVEN_MIRROR_URL=<mvn_mirror_registry> or odo component create nodejs --env MAVEN_MIRROR_URL=<mvn_mirror_registry>.
====

. Push the `java` component into the cluster.
+
[NOTE]
====
Use `odo push --context`<source_directory>` when running the command from outside the component's directory.
====
----
$ odo push
Validation
 ✓  Checking component [920ms]

Configuration changes
 ✓  Initializing component
 ✓  Creating component [4s]
 ✓  Triggering build from git [342ms]
 ✓  Waiting for build to finish [1m]
 ✓  Deploying component java-tjfl [21s]

Pushing to component java-tjfl of type git
 ✓  Changes successfully pushed to component
----


. Create a route for the `java` component
+
[NOTE]
====
Use `odo url create --context`<source_directory>` when running the command from outside the component's directory.
====
+
----
$ odo url create --port 8080
 ✓  URL java-tjfl-8080 created for component: java-tjfl

To create URL on the OpenShift Cluster, please use `odo push`
----

. Push the component to the cluster again to apply the route. Note down the route.
+
[NOTE]
====
Use `odo push --context`<source_directory>` when running the command from outside the component's directory.
====
+
----
$ odo push
Validation
 ✓  Checking component [924ms]

Configuration changes
 ✓  Retrieving component data [2s]
 ✓  Triggering build from git [342ms]
 ✓  Waiting for build to finish [1m]
 ✓  Applying configuration [29s]

Applying URL changes
 ✓  URL java-tjfl-8080: http://<route> created

Pushing to component java-tjfl of type git
 ✓  Changes successfully pushed to component
----

. Verify that the component is pushed into the cluster by accessing the route from the output of the previous command.
+
----
$ curl -I http://<route>
HTTP/1.1 200 OK
Date: Thu, 16 Jan 2020 04:02:12 GMT
Server: Javalin
Content-Type: text/plain
Content-Length: 0
Set-Cookie: 4a9b3b647e5e9e233eba98f2787d2097=954da7db821af3f383e552014a822644; path=/; HttpOnly
Cache-control: private
----