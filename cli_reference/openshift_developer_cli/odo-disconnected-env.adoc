[id='odo-disconnected-env']
= Running odo in environment disconnected from the Internet
include::modules/openshift-developer-cli-attributes.adoc[]
include::modules/common-attributes.adoc[]
:context: odo-running-in-disconnected-envs
toc::[]

// TODO -> general steps for both java/nodejs
// Question: Is only node.js and java supported for this?

. Prerequisites
* oc installed in the disconnected cluster
* odo installed in the disconnected cluster

[id="deploy_nodejs_in_restricted_env_{context}"]
== Deploying a Node.js app using odo in a restricted environment

To deploy a nodejs component using odo in a restricted environment follow these steps:

- Mirror and export the odo-init-image
- Create and push the component (git component and a local source)

=== How to upload the init image and export it through env ODO_BOOTSTRAPPER_IMAGE in a disconnected environment having a mirror registry :

. Use base64 -w0 to encode your mirror registry's root CA content
//Do I have to create the local registry?
+
----
$ echo <ContentOf_additional_ca> | base64 -d > disconnect-ca.crt
----

. Trust root CA certificate in your client platform and login to OpenShift mirror registry
//copy the certificate, run update-ca-trust, restart docker and login to docker with 
+
----
$ sudo cp ./disconnect-ca.crt /etc/pki/ca-trust/source/anchors/<mirror-registry>.crt
$ sudo update-ca-trust enable
$ sudo systemctl daemon-reload
$ sudo systemctl restart docker
$ docker login <mirror-registry>:<port> -u <mirror_registry_username> -p <mirror_registry_password>
----
+
[NOTE]
====
CA certificate path varies between different operating systems.
====

. Mirror the odo init image

----
$ oc image mirror registry.access.redhat.com/openshiftdo/odo-init-image-rhel7:latest <mirror-registry>:<port>/openshiftdo/odo-init-image-rhel7:latest
----

.Step 5: Overwrite init image using environment variale ODO_BOOTSTRAPPER_IMAGE

----
$ export ODO_BOOTSTRAPPER_IMAGE=<mirror-registry>:<port>/openshiftdo/odo-init-image-rhel7:latest
----

=== Creating a Node.js component in a disconnected cluster:

. Check nodejs image stream in OpenShift namespace

----
$ oc describe is nodejs -n openshift
Name:                   nodejs
Namespace:              openshift
[...]

10
  tagged from <mirror-registry>:<port>/rhoar-nodejs/nodejs-10
    prefer registry pullthrough when referencing this tag

  Build and run Node.js 10 applications on RHEL 7. For more information about using this builder image, including OpenShift considerations, see https://github.com/nodeshift/centos7-s2i-nodejs.
  Tags: builder, nodejs, hidden
  Example Repo: https://github.com/sclorg/nodejs-ex.git

  ! error: Import failed (NotFound): dockerimage.image.openshift.io "<mirror-registry>:<port>/rhoar-nodejs/nodejs-10:latest" not found
      About an hour ago

10-SCL (latest)
  tagged from <mirror-registry>:<port>/rhscl/nodejs-10-rhel7
    prefer registry pullthrough when referencing this tag

  Build and run Node.js 10 applications on RHEL 7. For more information about using this builder image, including OpenShift considerations, see https://github.com/nodeshift/centos7-s2i-nodejs.
  Tags: builder, nodejs
  Example Repo: https://github.com/sclorg/nodejs-ex.git

  ! error: Import failed (NotFound): dockerimage.image.openshift.io "<mirror-registry>:<port>/rhscl/nodejs-10-rhel7:latest" not found
      About an hour ago

[...]
----

. Import `nodejs` builder image to the tag specified `latest`
//don't understand what does this mean

----
$ oc image mirror registry.access.redhat.com/rhscl/nodejs-10-rhel7:latest <mirror-registry>:<port>/rhscl/nodejs-10-rhel7:latest
----

. Update the image stream in the mirrored local registry

----
$ oc tag <mirror-registry>:<port>/rhscl/nodejs-10-rhel7:latest nodejs-10-rhel7:latest --scheduled
----

. Check that the  `nodejs` builder image has been imported to the openshift namespace
//Which namespace?

----
$ oc describe is nodejs -n openshift
Name:                   nodejs
[...]
10-SCL (latest)
  tagged from <mirror-registry>:<port>/rhscl/nodejs-10-rhel7
    prefer registry pullthrough when referencing this tag

  Build and run Node.js 10 applications on RHEL 7. For more information about using this builder image, including OpenShift considerations, see https://github.com/nodeshift/centos7-s2i-nodejs.
  Tags: builder, nodejs
  Example Repo: https://github.com/sclorg/nodejs-ex.git

  * <mirror-registry>:<port>/rhscl/nodejs-10-rhel7@sha256:d669ecbc11ac88293de50219dae8619832c6a0f5b04883b480e073590fab7c54
      3 minutes ago

[...]
----

. Create a nodejs component
 git component

----
$ odo component create nodejs --project nodejs --git <your_git_source>
 ✓  Validating component [717ms]

Please use `odo push` command to create the component with source deployed
----

- Source component

----
$ odo component create nodejs --project nodejs --context <your_local_source>
 ✓  Validating component [717ms]

Please use `odo push` command to create the component with source deployed
----

[NOTE]
====
A mirror npm registry should be created and configure with the cluster, so that npm packages will be downloaded form the mirror registry. To overwrite the mirror registry you can use odo config set --env NPM_MIRROR=<npm_mirror_registry> or odo component create nodejs --env NPM_MIRROR=<npm_mirror_registry>.
====

.Step 6: Push the nodejs component

----
$ odo push
Validation
 ✓  Checking component [1s]

Configuration changes
 ✓  Initializing component
 ✓  Creating component [3s]
 ✓  Triggering build from git [327ms]
 ✓  Waiting for build to finish [57s]
 ✓  Deploying component nodejs-nfou [20s]

Pushing to component nodejs-nfou of type git
 ✓  Changes successfully pushed to component

NOTE: For local source push the component along with --context <your_local_source> flag if source is not present in the working directory.
----

.Step 7: Create the route

----
$ odo url create
 ✓  URL nodejs-nfou-8080 created for component: nodejs-nfou

To create URL on the OpenShift Cluster, please use `odo push`

NOTE: Use --context <your_local_source> flag if source is not present in the working directory.

Step 8: Push to apply the route

$ odo push
Validation
 ✓  Checking component [1s]

Configuration changes
 ✓  Retrieving component data [2s]
 ✓  Triggering build from git [336ms]
 ✓  Waiting for build to finish [1m]
 ✓  Applying configuration [26s]

Applying URL changes
 ✓  URL nodejs-nfou-8080: http://<route> created

Pushing to component nodejs-nfou of type git
 ✓  Changes successfully pushed to component

NOTE: Use --context <your_local_source> flag if source is not present in the working directory.

Step 9: Access the route

$ curl -I http://<route>
HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 40430
ETag: W/"9dee-3nm2OJV/pDUlKWUTQSk1Z/pOG6E"
Date: Wed, 15 Jan 2020 14:42:13 GMT
Set-Cookie: 2cef9c93633b1f9f7c3099d544c96c9f=f432286f4f4c7989d049174ac42cffa6; path=/; HttpOnly
Cache-control: private
----































[id="deploy_java_in_restricted_env_{context}"]
== Deploying a java app using odo in a restricted environment

There are two major steps to deploy a java component using odo in a restricted environment.

1. Mirror and export the odo-init-image
2.Create and push the component
    a. git component
    b. local source
    c. local binary

How to upload the init image and exporting it through env ODO_BOOTSTRAPPER_IMAGE in a disconnected environment having a mirror registry :

.Step 1: Use base64 -w0 to encode your mirror registry's root CA content

----
$ echo <ContentOf_additional_ca> | base64 -d > disconnect-ca.crt
----

.Step 2: Trust root CA certificate in your client platform and login to OpenShift mirror registry

----
$ sudo cp ./disconnect-ca.crt /etc/pki/ca-trust/source/anchors/<mirror-registry>.crt
$ sudo update-ca-trust enable
$ sudo systemctl daemon-reload
$ sudo systemctl restart docker
$ docker login <mirror-registry>:<port> -u <mirror_registry_username> -p <mirror_registry_password>
----
[NOTE]
====
CA certificate path varies platform wise. Here Fedora is being used as client platform.
====

.Step 4: Mirror the odo init image

----
$ oc image mirror registry.access.redhat.com/openshiftdo/odo-init-image-rhel7:latest <mirror-registry>:<port>/openshiftdo/odo-init-image-rhel7:latest
----

.Step 5: Overwrite init image using environment variable ODO_BOOTSTRAPPER_IMAGE

----
$ export ODO_BOOTSTRAPPER_IMAGE=<mirror-registry>:<port>/openshiftdo/odo-init-image-rhel7:latest
----

=== How to create and push a java component:

.Step 1: Check java image stream in OpenShift namespace

----
$ oc describe is java -n openshift
Name:                   java
[...]
11 (latest)
  tagged from <mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest
    prefer registry pullthrough when referencing this tag

  Build and run Java applications using Maven and OpenJDK 11.
  Tags: builder, java, openjdk
  Supports: java:11, java
  Example Repo: https://github.com/jboss-openshift/openshift-quickstarts

  ! error: Import failed (NotFound): dockerimage.image.openshift.io "<mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest" not found
      46 hours ago

[...]
----

.Step 2: Import java builder image to the tag specified (latest)

----
$ oc image mirror registry.access.redhat.com/openjdk/openjdk-11-rhel7:latest <mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest
----

.Step 3: Update the image stream

----
$ oc tag <mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest openjdk-11-rhel7:latest --scheduled
----

.Step 4: Check the image is imported to openshift namespace

----
$ oc describe is java -n openshift
Name:                   java
[...]

11 (latest)
  tagged from <mirror-registry>:<port>/openjdk/openjdk-11-rhel7:latest
    prefer registry pullthrough when referencing this tag

  Build and run Java applications using Maven and OpenJDK 11.
  Tags: builder, java, openjdk
  Supports: java:11, java
  Example Repo: https://github.com/jboss-openshift/openshift-quickstarts

  * <mirror-registry>:<port>/openjdk/openjdk-11-rhel7@sha256:4453c8ab3c428d81b69258500908386c006f7dbacad02024b032cb56fa836f75
      19 hours ago
[...]
----

.Step 5: Create a java component


- git component
----
$ odo component create java --project java --git <your_git_source>
 ✓  Validating component [697ms]

Please use `odo push` command to create the component with source deployed
----

- Source component

----
$ odo component create java --project java --context <your_local_source>
 ✓  Validating component [697ms]

Please use `odo push` command to create the component with source deployed
----

- Binary component

----
$ odo component create java --project java --context <your_bin_source>
 ✓  Validating component [697ms]

Please use `odo push` command to create the component with source deployed
----

[NOTE]
====
A mirror maven registry should be created and configure with the cluster, so that maven packages will be downloaded form the mirror registry. To overwrite the mirror registry you can use odo config set --env MAVEN_MIRROR_URL=<mvn_mirror_registry> or odo component create nodejs --env MAVEN_MIRROR_URL=<mvn_mirror_registry>.
====

.Step 6: Push the java component

----
$ odo push
Validation
 ✓  Checking component [920ms]

Configuration changes
 ✓  Initializing component
 ✓  Creating component [4s]
 ✓  Triggering build from git [342ms]
 ✓  Waiting for build to finish [1m]
 ✓  Deploying component java-tjfl [21s]

Pushing to component java-tjfl of type git
 ✓  Changes successfully pushed to component
----

[NOTE]
====
For local source or binary, push the component along with --context <your local source or binary> flag if source is not present in the working directory.
====

.Step 7: Create the route

----
$ odo url create --port 8080
 ✓  URL java-tjfl-8080 created for component: java-tjfl

To create URL on the OpenShift Cluster, please use `odo push`
----


[NOTE]
====
Use --context <your local source or binary> flag if source is not present in the working directory.
====

.Step 8: Push to apply the route

----
$ odo push
Validation
 ✓  Checking component [924ms]

Configuration changes
 ✓  Retrieving component data [2s]
 ✓  Triggering build from git [342ms]
 ✓  Waiting for build to finish [1m]
 ✓  Applying configuration [29s]

Applying URL changes
 ✓  URL java-tjfl-8080: http://<route> created

Pushing to component java-tjfl of type git
 ✓  Changes successfully pushed to component
----

[NOTE]
====
Use --context flag if source is not present in the working directory.
====

.Step 9: Access the route

----
$ curl -I http://<route>
HTTP/1.1 200 OK
Date: Thu, 16 Jan 2020 04:02:12 GMT
Server: Javalin
Content-Type: text/plain
Content-Length: 0
Set-Cookie: 4a9b3b647e5e9e233eba98f2787d2097=954da7db821af3f383e552014a822644; path=/; HttpOnly
Cache-control: private
----