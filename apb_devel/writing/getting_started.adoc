[[apb-devel-writing-getting-started]]
= Writing APBs: Getting Started
{product-author}
{product-version]
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

[[apb-devel-writing-gs-overview]]
== Overview

In this tutorial, you will walk through the creation of some sample Ansible
Playbook Bundles (APBs). You will create actions for them to allow provision,
deprovision, bind, and unbind. You can find more information about the design of
APBs in the xref:../index.adoc#apb-devel-intro-design[Design] topic. More in-depth
information about writing APBs is available in the
xref:reference.adoc#apb-devel-writing-reference[Reference] topic.

[NOTE]
====
For the remainder of this tutorial, substitute your own information for items
marked in brackets; for example, `<host>:<port>` might need to be replaced with
`172.17.0.1.nip.io:8443`.
====

[[apb-devel-writing-gs-dev-env]]
== Before You Begin

Before getting started creating your own APBs, you must set up your development
environment:

. Ensure you have access to an {product-title} cluster.

. Install the APB tools as documented in the
xref:../cli_tooling.adoc#apb-devel-cli[CLI Tooling] topic. To verify, you can
run the `apb help` command and check for a valid response.

[[apb-devel-writing-gs-creating]]
== Create your first APB

In this tutorial, you will create an APB for a containerized
link:https://hub.docker.com/r/ansibleplaybookbundle/hello-world/[hello world application].  You will work through a basic APB that will mirror the APB
link:https://github.com/ansibleplaybookbundle/hello-world-apb[*hello-world-apb*].

[[initialize-apb-project]]
=== Initialize APB project

. Initialize the APB using the `ansible-galaxy` command. This creates
the skeleton for your APB.
+
[source,bash]
----
$ ansible-galaxy init --type apb my-test-apb
----
+
After initialization, you will see the following file structure:
+
[source,bash]
----
my-test-apb/
├── apb.yml
├── defaults
│   └── main.yml
├── Dockerfile
├── files
├── handlers
│   └── main.yml
├── Makefile
├── meta
│   └── main.yml
├── playbooks
│   ├── deprovision.yml
│   └── provision.yml
├── README.md
├── tasks
│   └── main.yml
├── templates
├── tests
│   ├── ansible.cfg
│   ├── inventory
│   └── test.yml
└── vars
    └── main.yml
----
+
Two files were created at the root directory: an *_apb.yml_* (the APB spec file)
and a *_Dockerfile_*. These are the minimum files required for any APB. For more
information about the APB spec file, see the
xref:reference.adoc#apb-devel-writing-ref-spec[Reference] topic. There is
also an explanation of what you can do in the
xref:reference.adoc#apb-devel-writing-ref-dockerfile[*_Dockerfile_*].
+
.*_apb.yml_*
[source,yaml]
----
version: 1.0.0
name: my-test-apb
description: This is a sample application generated by apb init
bindable: False
async: optional
metadata:
  displayName: my-test
plans:
  - name: default
    description: This default plan deploys my-test-apb
    free: True
    metadata: {}
    parameters: []
----
+
.*_Dockerfile_*
[source]
----
FROM ansibleplaybookbundle/apb-base

LABEL "com.redhat.apb.spec"=\

COPY playbooks /opt/apb/actions
COPY . /opt/ansible/roles/my-test-apb
RUN chmod -R g=u /opt/{ansible,apb}
USER apb
----

. In the *_Dockerfile_*, there are two updates to make:

.. Change the `FROM` directive to use the image from the Red Hat Container Catalog.
The first line should now read:
+
[source]
----
FROM openshift3/apb-base
----

.. Update `com.redhat.apb.spec` in the `LABEL` instruction with a base64 encoded
version of *_apb.yml_*. To do this, run `apb prepare`:
+
[source,bash]
----
$ cd my-test-apb
$ apb prepare
----
+
This updates the *_Dockerfile_* as follows:
+
.*_Dockerfile_*
[source]
----
FROM openshift3/apb-base

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IG15LXRlc3QtYXBiCmRlc2NyaXB0aW9uOiBUaGlzIGlzIGEgc2Ft\
cGxlIGFwcGxpY2F0aW9uIGdlbmVyYXRlZCBieSBhcGIgaW5pdApiaW5kYWJsZTogRmFsc2UKYXN5\
bmM6IG9wdGlvbmFsCm1ldGFkYXRhOgogIGRpc3BsYXlOYW1lOiBteS10ZXN0CnBsYW5zOgogIC0g\
bmFtZTogZGVmYXVsdAogICAgZGVzY3JpcHRpb246IFRoaXMgZGVmYXVsdCBwbGFuIGRlcGxveXMg\
bXktdGVzdC1hcGIKICAgIGZyZWU6IFRydWUKICAgIG1ldGFkYXRhOiB7fQogICAgcGFyYW1ldGVy\
czogW10="

COPY playbooks /opt/apb/actions
COPY . /opt/ansible/roles/my-test-apb
RUN chmod -R g=u /opt/{ansible,apb}
USER apb
----

[[build-publish-apb-project]]
=== Build and publish APB project

At this point, you have a fully formed APB that you can build.

In this example, we'll build an APB using the OpenShift build system. 

. Let's first create a `buildconfig` for the APB. Perform this step when you're building a new APB that you haven't previously built on OpenShift:
+
[source, bash]
----
$ oc new-build --binary=true --name <apb-name>
----

. To start the build from the current directory and follow the logs:
[source, bash]
----
$ oc start-build --follow --from-dir . <apb-name>
----

. If the build completes successfully, you'll see some newly available
imagestream:
[source, bash]
----
$ oc get is                    
NAME          DOCKER REPO                       TAGS      UPDATED     
apb-base      172.30.1.1:5000/<namespace>/apb-base      latest    4 minutes ago
my-test-apb   172.30.1.1:5000/<namespace>/my-test-apb   latest    3 seconds ago
----

. add the internal OpenShift registry to our list of configured registries:
[source, bash]
----
$ apb registry add my-registry --type local_openshift --namespaces foo
Getting specs for registry: [my-registry]
INFO == REGISTRY CX ==                            
INFO Name: my-registry                            
INFO Type: local_openshift                        
INFO Url:                                         
INFO Validating specs...                          
WARN Spec [  ] failed validation for the following reason: [ Spec [] failed version validation ]. It will not be made available. 
WARN 1 specs of 2 discovered specs failed validation from registry: openshift-registry 
INFO Registry my-registry has 1 valid APBs available from 2 images scanned 
 APB             IMAGE                               REGISTRY    
  ----------- -+- ------------------------------- -+- ----------- 
  my-test-apb  |  172.30.1.1:5000/foo/my-test-apb  |  my-registry 
----

[[running-apb-project]]
=== Run APB
Now that apb is aware of the my-test-apb APB in the registry, we can perform any
supported action against the APB. The `apb bundle` subcommand gives you some
actions you can perform on a specific bundle in a registry. You can use the
`--help` option to see which commands and options are available:

[source, bash]
----
$ apb bundle --help
List, execute and build APBs

Usage:
  apb bundle [command]

Available Commands:
  deprovision Deprovision APB images
  info        Print info on APB image
  list        List APB images
  prepare     Stamp APB metadata onto Dockerfile as b64
  provision   Provision APB images
  test        Test APB images

Flags:
  -h, --help                help for bundle
  -k, --kubeconfig string   Path to kubeconfig to use

Global Flags:
      --config string   configuration file (default is $HOME/.apb)
  -v, --verbose         verbose output

Use "apb bundle [command] --help" for more information about a command.
----

. We can provision the my-test-apb that now exists in the registry by running:
+
[source, bash]
----
$ apb bundle provision my-test-apb --follow <1>
----
<1> The `--follow` option used above will show logs produced by the running APB.
