[[apb-devel-cli]]
= CLI Tooling
{product-author}
{product-version]
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

[[apb-devel-cli-overview]]
== Overview

The `apb` CLI tool helps Ansible Playbook Bundle (APB) authors create, build,
and publish their APBs to container registries. It enforces best practices and
takes care of the details so they should be easy to deploy.

[[apb-devel-cli-install]]
== Installing the Tool

[[apb-devel-cli-install-prereqs]]
=== Prerequisites

link:https://golang.org/[Go] must be installed and running on the system.

[[apb-devel-cli-install-prereqs-access-permissions]]
==== Access Permissions

The `apb` tool requires you to be logged in as a tokened cluster user; the
default *system:admin* system user is not sufficient because it does not have a
token that can be used for the tool's authentication. In addition, there are a
number of local roles (project-scoped) and cluster roles (cluster-wide) that
must exist to permit the full breadth of the `apb` tool's functions (see
xref:../architecture/additional_concepts/authorization.adoc#cluster-and-local-rbac[Cluster and Local RBAC]).

The easiest option is to ensure the user has the *cluster-admin* cluster role.
To add this role to another user, you can run the following as a user that
already has such permissions (for example, the *system:admin* default system
user):

[WARNING]
====
This is effectively cluster *root* and should only be used in a development
setting.
====

[source,bash]
----
$ oc adm policy add-cluster-role-to-user cluster-admin <user>
$ oc login -u <user> <openshift_server>
----

If you would like a more strictly permissioned environment, an OpenShift
template is provided that by default will permission a user called *developer*.
The template must be run by a user with sufficient permissions to create the
various roles. The *developer* user does not have such permissions, but the
*system:admin* user is sufficient.

To run the template:

. Download the
link:https://raw.githubusercontent.com/ansibleplaybookbundle/ansible-playbook-bundle/master/templates/openshift-permissions.template.yaml[*_openshift-permissions.template.yaml_*]
file locally.

. Run the following command:
+
[source,bash]
----
$ oc process -f openshift-permissions.template.yaml \
   -p BROKER_NAMESPACE=openshift-ansible-service-broker \
   [-p USER=<your_desired_user>] \//<1>
   | oc create -f -
----
<1> By default, the template will permission the *developer* user. You can
optionally use the `-p` flag to override this default value with your desired
user.

ifdef::openshift-origin[]
[[apb-devel-cli-install-containerized]]
=== Running From a Container

To run the `apb` tool from a container:

. Pull the container:
+
[source,bash]
----
$ docker pull docker.io/ansibleplaybookbundle/apb-tools[:<tag>]
----
+
There are three tags to choose from:
+
--
- `latest`: more stable, less frequent releases.
- `nightly`: following upstream commits, installed from RPM.
- `canary`: following upstream commits, installed from source build.
--

. Choose one of the following:

.. Create an alias in your *_.bashrc_* or somewhere else for your shell:
+
----
alias apb='docker run --rm --privileged -v $PWD:/mnt -v $HOME/.kube:/.kube -v /var/run/docker.sock:/var/run/docker.sock -u $UID docker.io/ansibleplaybookbundle/apb-tools'
----

.. If you would prefer to use `atomic` rather than an alias:
+
[source,bash]
----
$ atomic run docker.io/ansibleplaybookbundle/apb-tools init my_apb
----

. Start working by running the command:
+
[source,bash]
----
$ apb init my_apb
----
+
The first run may take awhile if you did not pull the image beforehand.
endif::[]

[[apb-devel-cli-install-rpm]]
=== Installing via RPM

ifdef::openshift-enterprise[]
The APB CLI tool is provided by the *apb* package, which is available from the
`rhel-7-server-ose-3.7-rpms` channel:

[source,bash]
----
$ sudo yum install apb
----
endif::[]
ifdef::openshift-origin[]
For RHEL or CentOS 7:

[source,bash]
----
$ su -c 'wget https://copr.fedorainfracloud.org/coprs/g/ansible-service-broker/ansible-service-broker-latest/repo/epel-7/group_ansible-service-broker-ansible-service-broker-latest-epel-7.repo -O /etc/yum.repos.d/ansible-service-broker.repo'

$ sudo yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
$ sudo yum -y install apb
----

For Fedora 26, Fedora 27, or Fedora 28:
[source,bash]
----
$ sudo dnf -y install dnf-plugins-core
$ sudo dnf -y copr enable @ansible-service-broker/ansible-service-broker-latest
$ sudo dnf -y install apb
----
endif::[]

ifdef::openshift-origin[]
[[apb-devel-cli-install-source]]
=== Installing from Source

[[apb-devel-cli-install-source-go]]
==== Installing from Source: Go

. Install Go:
[source, bash]
----
$ sudo dnf install -y golang
----

. Clone the apb repository into your `$GOPATH`:
[source, bash]
----
$ git clone https://github.com/automationbroker/apb.git
----

. Install the apb CLI tool into `$GOBIN`:
[source, bash]
----
$ cd apb && make install
----

[[apb-devel-cli-install-source-tito]]
==== Installing from Source: Tito

Alternatively, you can use link:http://github.com/dgoodwin/tito[`tito`] to
install:

----
# tito build --test --rpm -i
----
endif::[]

[[apb-devel-cli-install-source-tito]]
=== Verifying the Installation

Run `apb help` to make sure the tool is installed correctly:

----
$ apb help
WARN Didn't find config file /root/.apb/registries.json, creating.
WARN Didn't find config file /root/.apb/defaults.json, creating.
Tool for working with Ansible Playbook Bundles

Usage:
  apb [command]

Available Commands:
  binding     Manage bindings
  broker      Interact with Automation Broker
  bundle      Interact with APBs
  catalog     Interact with OpenShift Service Catalog
  completion  Generates shell completion scripts
  config      Set tool defaults
  help        Help about any command
  registry    Configure registry adapters
  version     Get version

Flags:
      --config string   configuration directory (default is $HOME/.apb)
  -h, --help            help for apb
  -v, --verbose         verbose output

Use "apb [command] --help" for more information about a command.

----

[[apb-devel-cli-workflows]]
== Create and test APBs

`apb` version `2.0.0` and above, allows you to develop and test APB images
without using an Ansible Service Broker. You can store the images
locally in *_~/.apb_* directory and configure registries to source the APBs from
there.

Use anible-galaxy to initalize the APB:
[source, bash]
----
$ ansible-galaxy init --type apb <apb-name>
----

[[apb-devel-cli-workflows-local-registry]]
=== Using internal {product-tile} registry

After modifying the APB, create a `buildconfig`. Doing this populates
`imagestream` in namespace which `apb` can read from. 

Although `apb` works with APB images placed in any namespcae, it is recommended to put APB images into the `openshift` namespace, because
images in this namespaces are accessible to all authenticated users by default.

To make APB imagestreams in a namespace accessible to the `apb` CLI tool, add a
new registry adapter:
[source, bash]
----
apb registry add lo --type local_openshift --namespaces <namespace-name>
----

[[apb-devel-cli-workflows-remote-registry]]
=== Using a remote registry
//work in progress
Once your image is pushed to an organization on Dockerhub, you can configure apb
to check the registry for available APBs. If your images exist in organization
foo, you can configure a new registry adapter with:

[source, bash]
----
$ apb registry add foo-dockerhub --type dockerhub --org foo
----

. Run the provision playbook:
+
[source, bash]
----
$ apb bundle provision <apb_name> 
----

. View available APBs:
+
[source, bash]
----
$ apb bundle list
----

[[apb-devel-cli-creation-commands]]
== APB command reference

[[apb-devel-cli-bundle]]
=== `bundle`

[discrete]
===== Description

Interact with Ansible Playbook Bundle images present in the `apb` tool.

[discrete]
===== Usage

----
$ apb bundle [COMMAND] [OPTIONS]
----

[discrete]
===== Commands

[cols="1,2",options="header",]
|===
| Subcommand    | Description
| `deprovision` | Deprovision APB image
| `info`        | Print info about APB image
| `list`        | List available APB images
| `prepare`     | Stamp APB metadata onto Dockerfile in base64 encoding
| `provision`   | Provision APB images
| `test`        | Test APB images

|===

[discrete]
===== Options

[options="header"]
|===
| Option, shorthand      | Description
| `--help, -h`           | Show help message
| `--kubeconfig`, `-k`   | Path to kubeconfig to use
|===

[discrete]
===== Examples

* Provision `mediawiki-apb` APB image:
+
[source, bash]
----
$ apb bundle provision mediawiki-apb
----

* Provision `mediawiki-apb` and follow APB logs:
+
[source, bash]
----
$ apb bundle provision mediawiki-apb --follow
----

* Provision `mediawiki-apb` using _admin_ sandbox-role:
+
[source, bash]
----
$ apb bundle provision mediawiki-apb --sandbox-role admin
----

* Deprovision `mediawiki-apb` without prompting for parameters and follow APB logs:

+
[source, bash]
----
$ apb bundle deprovision --skip-params --follow
----


[[apb-devel-cli-binding]]
=== `binding`

[discrete]
===== Description

Manage bindings on an {product-title} cluster.

[discrete]
===== Usage

[source,bash]
----
apb binding [command]
----

[discrete]
===== Commands

[cols="1,2",options="header",]
|===
|Subcommand |Description
|`add` |Add bind credentials to an application
|===

[discrete]
===== Options

[cols="1,2",options="header",]
|===
|Option, shorthand |Description
|`--help`, `-h` |Show help message for binding
|`--namespace`, `-n` |Namespace of binding
|===

[discrete]
===== Examples

* Create binding out of secret `foo-secret` and add it to Deployment
Config `bar-dc`:
+
[source,bash]
----
apb binding add foo-secret bar-dc
----

Our example APBs create secrets that match the name of the APB pod.

To bind Postgresql APB to Mediawiki: 

. Provision Postgresql
`apb bundle provision postgresql-apb`
. Provision Mediawiki
`apb bundle provision mediawiki-apb`
. Wait for APBs to finish
provisioning 
. Run `oc get secret`, look for a secret named `bundle-<hash>` that matches the hash from your Postgres APB run 
. Run `oc get dc` and identify the DeploymentConfig you want to add your bind
secrets to 
. If the DeploymentConfig is named `mediawiki-1234` and the
bundle hash is `772f6e70-[...]` a binding command may look like:
+
[source, bash]
----
$ apb binding add bundle-772f6e70-3ee5-4fce-9c26-1dec57cc0c40 mediawiki-1234

INFO Create a binding using secret [bundle-772f6e70-3ee5-4fce-9c26-1dec57cc0c40] to app [mediawiki-1234]                           
Successfully created secret [bundle-772f6e70-3ee5-4fce-9c26-1dec57cc0c40-creds] in namespace [apb].                                

Use the following command to attach the binding to your application:
oc set env dc/mediawiki-1234 --from=secret/bundle-772f6e70-3ee5-4fce-9c26-1dec57cc0c40-creds
----

+
Type the recommended command to complete the binding:
+
[source, bash]
----
$ oc set env dc/mediawiki-1234 --from=secret/bundle-772f6e70-3ee5-4fce-9c26-1dec57cc0c40-creds
deploymentconfig "mediawiki-1234" updated
----
+
This will redeploy Mediawiki pod and you should see the full application
backed by a Postgresql instance.

[[apb-devel-cli-broker]]
=== `broker`

[discrete]
===== Description

Interact with Ansible Service Broker

Bootstrap and list available APBs in an Ansible Service Broker instance

[discrete]
===== Usage

[source,bash]
----
apb broker [command]
----

[discrete]
===== Commands

[cols="1,2",options="header",]
|===
|Subcommand |Description
|`bootstrap` |Bootstrap an Ansible Service Broker instance
|`catalog` |List available APBs in Anisble Service Broker catalog
|===

[discrete]
===== Options

[cols="<,<",options="header",]
|===
|Option, shorthand |Description
|`--help`, `-h` |Show help message for broker
|`--name`, `-n` |Name of Ansible Service Broker instance
|===

[discrete]
===== Examples

* Bootstrap an Ansible Service Broker instance with the name
`openshift-ansible-service-broker`
+
[source,bash]
----
apb broker bootstrap --name openshift-ansible-service-broker
----

* List available APBs in an Ansible Service Broker instance with the name
`foo-broker`
+
[source,bash]
----
apb broker catalog --name foo-broker
----

[[apb-devel-cli-catalog]]
=== `catalog`

[discrete]
===== Description

Interact with OpenShift Service Catalog. Force the Service Catalog to
relist its available APBs from an Ansible Service Broker instance

[discrete]
===== Usage

[source,bash]
----
apb catalog [COMMAND] [OPTIONS]
----

[discrete]
===== Commands

[cols="1,2",options="header",]
|===
|Subcommand |Description
|`relist` |Force a relist of the OpenShift Service Catalog
|===

[discrete]
===== Options

[cols="1,2",options="header",]
|===
|Option, shorthand |Description
|`--help`, `-h` |Show help message
|`--name`, `-n` |Name of clusterservicebroker to relist
|===

[discrete]
===== Examples

* Force a relist of clusterservicebroker `foo-broker`
+
[source,bash]
----
apb catalog relist --name foo-broker
----

[[apb-devel-cli-config]]
=== `config`

[discrete]
===== Description

Runs an interactive prompt to configure defaults for the `apb` tool

[discrete]
===== Usage

[source,bash]
----
apb config [OPTIONS]
----

[discrete]
===== Options

[cols="1,2",options="header",]
|===
|Option, shorthand |Description
|`--help`, `-h` |Show help message
|===

[discrete]
===== Examples

* Set new defaults for `apb`
+
[source,bash]
----
$ apb config
Broker namespace [default: openshift-automation-service-broker]:
Broker resource URL [default: /apis/servicecatalog.k8s.io/v1beta1/clusterservicebrokers/]:
Broker route name [default: openshift-automation-service-broker]:
clusterservicebroker resource name [default: openshift-automation-service-broker]:
# Broker route suffix values:
# -------------------------------
# 3.9:   "ansible-service-broker"
# 3.10:  "ansible-service-broker"
# 3.11+: "osb"
Broker route suffix [default: osb]:

Saving new configuration....
----

[[apb-devel-cli-completion]]
=== `completion`

[discrete]
===== Description

Generates shell completion scripts. This gives completion scripts for
bash and zsh.

[discrete]
===== Usage

[source,bash]
----
apb completion [COMMAND] [OPTIONS]
----

[discrete]
===== Commands

[cols="1,2",options="header",]
|===
|Subcommand |Description
|`bash` |Generate shell completion script for bash
|`zsh` |Generate shell completion script for zsh
|===

[discrete]
===== Options

[cols="1,2",options="header",]
|===
|Option, shorthand |Description
|`--help`, `-h` |Show help message
|===

[discrete]
===== Examples

Generate bash completion script

[source,bash]
----
apb completion bash
----

[[apb-devel-cli-registry]]
=== `registry`

[discrete]
===== Description

Add, list, or remove registry configurations from the `apb` tool. We
support all available registry types available within the Ansible
Service Broker

[discrete]
===== Usage

[source,bash]
----
apb registry [COMMAND] [OPTIONS]
----

[discrete]
===== Commands

[cols="1,2",options="header",]
|===
|Subcommand |Description
|`add` |Add a new registry adapter
|`list` |List the configured registry adapters
|`remove` |Remove a registry adapter
|===

[discrete]
===== Options

[cols="1,2",options="header",]
|===
|Option, shorthand |Description
|`--help`, `-h` |Show help message
|===

[discrete]
===== Examples

* Add a registry named `dockerhub` configured to use organization `dune`
from Dockerhub
+
[source,bash]
----
apb registry add dockerhub --org dune
----

* List configured registries
+
[source,bash]
----
apb registry list
----

* Remove registry named `dockerhub`
+
[source,bash]
----
apb registry remove dockerhub
----

[[apb-devel-cli-version]]
=== `version`

[discrete]
===== Description

Displays current version of `apb` tool

[discrete]
===== Usage

[source,bash]
----
apb version
----

[[apb-devel-cli-help]]
=== `help`

[discrete]
===== Description

Get help information for any command

[discrete]
===== Usage

[source,bash]
----
apb help [COMMAND]
----

[discrete]
===== Examples

* Get more information about the `apb broker` subcommand
+
[source,bash]
----
apb help broker
----