[id="nw-control-dns-records-public-hosted-zone-gcp_{context}"]
= Creating DNS records on an public managed zone for GCP by using Red Hat External DNS Operato

.Procedure

. Export the kubeconfig file.
+
[source,terminal]
----
$ export KUBECONFIG=~/<path to>/kubeconfig
----

. Check the user. The user must have access to the `kube-system` namespace if you donâ€™t have the credentials as you can fetch the credentials from the `kube-system` namespace to use the cloud provider client.
+
[source,terminal]
----
$ oc whoami
----
+
.Example output
[source,terminal]
----
system:admin
----

. Copy the value of service_account.json in gcp-credentials secret in a file encoded-gcloud.json
+
[source,terminal]
----
$ oc get secret gcp-credentials -n kube-system --template='{{$v := index .data "service_account.json"}}{{$v}}' | base64 -d - > decoded-gcloud.json
----

. Export Google credentials:
+
[source,terminal]
----
$ export GOOGLE_CREDENTIALS=decoded-gcloud.json
----

. Activate your account:
+
[source,terminal]
----
$ gcloud auth activate-service-account  <client_email as per decoded-gcloud.json> --key-file=decoded-gcloud.json
----

. Set your project
+
[source,terminal]
----
$ gcloud config set project <project_id as per decoded-gcloud.json>
----

. Get the routes to check the domain
+
[source,terminal]
----
$ oc get routes --all-namespaces | grep console
----
+
.Example output
[source,terminal]
----
openshift-console          console             console-openshift-console.apps.qe.gcp.devcluster.openshift.com                       console             https   reencrypt/Redirect     None
openshift-console          downloads           downloads-openshift-console.apps.qe.gcp.devcluster.openshift.com                     downloads           http    edge/Redirect          None
----

. Get your zone which was created by the installer
+
[source,terminal]
----
$ gcloud dns managed-zones list | grep qe.gcp.devcluster.openshift.com

qe-cvs4g-private-zone qe.gcp.devcluster.openshift.com
----

. Check the zone doesn't have DNS records other than `NS` and `SOA`
+
[source,terminal]
----
$ gcloud dns record-sets list --zone=qe-cvs4g-private-zone
----

. Create a ExternalDNS CR
+
[source,yaml]
----
apiVersion: externaldns.olm.openshift.io/v1alpha1
kind: ExternalDNS
metadata:
  name: sample-gcp <1>
spec:
  domains:
    - filterType: Include <2>
      matchType: Exact <3>
      name: qe.gcp.devcluster.openshift.com <4>
  provider:
    type: GCP <5>
  source:
    openshiftRouteOptions: <6>
      routerName: default <7>
    type: OpenShiftRoute <8>
----

<1> Name of external dns CR which will cause the operator to create a deployment and thereby the external-dns pods in external-dns namespace with this name prefixed.
<2> By default all hosted zones are selected as potential targets. But it's possible to include only the one(s) we need.
<3> The matching of the target zone's domain has to be exact (as opposed to regular expression match).
<4> The exact domain of the zone we want to udpdate. Note that the hostname of the routes should be subdomains of this one.
<5> To publish records on public hosted zone on GCP public DNS.
<6> You can define an option for route source under this field.
<7> If the source is openshift-route then you can pass the ingress controller name. Based on this name external-dns will select the respective router from the route status and map that routerCanonicalHostname to the route host while creating a CNAME record.
<8> Defines source route i.e dns records for routes will be created on your cloud DNS.

. Now you shall see records created for OCP routes using the following command
+
[source,terminal]
----
$ gcloud dns record-sets list --zone=qe-cvs4g-private-zone
----

. You can try to create a route with a sample app.
+
[source,terminal]
----
$ oc new-app --docker-image=openshift/hello-openshift -l app=hello-openshift
$ oc expose service/hello-openshift -l app=hello-openshift
----

. Check the record for the hello-openshift route
+
[source,terminal]
----
$ gcloud dns record-sets list --zone=qe-cvs4g-private-zone | grep hello-openshift
----

. To delete the route and app, run the following command:
+
[source,terminal]
----
$ oc delete all -l app=hello-openshift
----

. Check whether the records are absent.
+
[source,terminal]
----
$ gcloud dns record-sets list --zone=qe-cvs4g-private-zone | grep hello-openshift
----
