[id="nw-control-dns-records-public-hosted-zone-azure_{context}"]
= Creating DNS records on an public hosted zone for Azure by using Red Hat External DNS Operator

.Procedure

. Export the kubeconfig file.
+
[source,terminal]
----
$ export KUBECONFIG=~/<path to>/kubeconfig
----

. Check the user. The user must have access to the `kube-system` namespace if you donâ€™t have the credentials as you can fetch the credentials from the `kube-system` namespace to use the cloud provider client.
+
[source,terminal]
----
$ oc whoami
----
+
.Example output
[source,terminal]
----
system:admin
----

. Fetch the values from azure-credentials secret present in `kube-system` namespace.
+
[source,terminal]
----
$ CLIENT_ID=$(oc get secrets azure-credentials  -n kube-system  --template={{.data.azure_client_id}} | base64 -d)
$ CLIENT_SECRET=$(oc get secrets azure-credentials  -n kube-system  --template={{.data.azure_client_secret}} | base64 -d)
$ RESOURCE_GROUP=$(oc get secrets azure-credentials  -n kube-system  --template={{.data.azure_resourcegroup}} | base64 -d)
$ SUBSCRIPTION_ID=$(oc get secrets azure-credentials  -n kube-system  --template={{.data.azure_subscription_id}} | base64 -d)
$ TENANT_ID=$(oc get secrets azure-credentials  -n kube-system  --template={{.data.azure_tenant_id}} | base64 -d)
----

. Login to azure with base64 decoded values.
+
[source,terminal]
----
$ az login --service-principal -u "${CLIENT_ID}" -p "${CLIENT_SECRET}" --tenant "${TENANT_ID}"
----

. Get the routes to check the domain
+
[source,terminal]
----
$ oc get routes --all-namespaces | grep console
----
+
.Example output
[source,terminal]
----
openshift-console          console             console-openshift-console.apps.test-azure.qe.azure.devcluster.openshift.com                       console             https   reencrypt/Redirect     None
openshift-console          downloads           downloads-openshift-console.apps.test-azure.qe.azure.devcluster.openshift.com                     downloads           http    edge/Redirect          None
----

.  Get the dns zone list with respect to your resource group.
+
[source,terminal]
----
$ az network dns zone list --resource-group "${RESOURCE_GROUP}"
----

. Create ExternalDNS CR.
+
[source,yaml]
----
  apiVersion: externaldns.olm.openshift.io/v1alpha1
kind: ExternalDNS
metadata:
  name: sample-azure <1>
spec:
  domains:
  - filterType: Include <2>
    matchType: Exact <3>
  zones:
  - "/subscriptions/53b4f551-f0fc-4bea-8cba-11111111111/resourceGroups/test-azure1-nxkxm-rg/providers/Microsoft.Network/dnszones/test-azure.qe.azure.devcluster.openshift.com" <4>"
  provider:
    type: Azure <5>
  source:
    openshiftRouteOptions: <6>
      routerName: default <7>
    type: OpenShiftRoute <8>
----

<1> Name of external dns CR which will cause the operator to create a deployment and thereby the pods with this name.
<2> Checks if the domain is included as a part of the route hostname.
<3> Defines how to check if a domain is a part of the route hostname.
<4> Define the zone ID
<5> To publish records on public hosted zone on azure public DNS.
<6> You can define an option for route source under this field.
<7> If the source is openshift-route then you can pass the ingress controller name. Based on this name external-dns will select the respective router from the route status and map that routerCanonicalHostname to the route host while creating a CNAME record.
<8> Defines source route i.e dns records for routes will be created on your cloud DNS.

. Check the records for OCP created routes using the following command:
+
[source,terminal]
----
$ az network dns record-set list -g "${RESOURCE_GROUP}"  -z test-azure.qe.azure.devcluster.openshift.com  > record-list-azure.txt
----

.  Create a route.
+
[source,terminal]
----
$ oc new-app --docker-image=openshift/hello-openshift -l app=hello-openshift
$ oc expose service/hello-openshift -l app=hello-openshift
----

. Check whether `hello-openshift` DNS records exist in the zone:
+
[source,terminal]
----
$ az network dns record-set list -g "${RESOURCE_GROUP}" -z test-azure.qe.azure.devcluster.openshift.com | grep -c "hello-openshift"
----

[NOTE]
====
To create records on private hosted zones on private dns you need to specify the private zone under zones which will populate the provider type to azure-private-dns in the external dns container args.
====
