[id="configuring-additional-network"]
= Configuring an additional network
include::modules/common-attributes.adoc[]
:context: configuring-additional-network

toc::[]

As a cluster administrator, you can configure an additional network for your cluster. The following additional network types are supported:

* macvlan
* ipvlan
* bridge
* host-device

== Approaches to managing an additional network

You can manage the life cycle of an additional network by two mutually exclusively approaches:

Modify the Cluster Network Operator (CNO) configuration::
The CNO automatically creates and manages the `NetworkAttachmentDefinition` object.

Applying a YAML manifest::
You can manage the additional network directly by creating an `NetworkAttachmentDefinition` object.

=== Configure an additional network through the Cluster Network Operator

The configuration for an additional network attachment that uses the ipvlan
Container Network Interface (CNI) plug-in is provided in two parts:

* Cluster Network Operator (CNO) configuration
* CNI plug-in configuration

The CNO configuration specifies the name for the additional network attachment and the namespace to create the attachment in. The plug-in is configured by a JSON object specified by the `rawCNIConfig` parameter in the CNO configuration.

The following YAML describes the configuration parameters for the CNO:

.Cluster Network Operator configuration
[source,yaml]
----
name: <name> <1>
namespace: <namespace> <2>
rawCNIConfig: |- <3>
  {
    ...
  }
type: Raw
----
<1> Specify a name for the additional network attachment that you are
creating. The name must be unique within the specified `namespace`.

<2> Specify the namespace to create the network attachment in. If
you do not specify a value, then the `default` namespace is used.

<3> Specify the CNI plug-in configuration in JSON format, which
is based on the following template.

=== Configure an additional network from a YAML manifest

This works as you'd expect. `oc create`.

== IP address assignment

== Configuration for additional network types

The specific configuration fields for additional networks is described in the following sections.

include::modules/nw-multus-bridge-object.adoc[leveloffset=+2]
include::modules/nw-multus-host-device-object.adoc[leveloffset=+2]
include::modules/nw-multus-ipvlan-object.adoc[leveloffset=+2]
include::modules/nw-multus-macvlan-object.adoc[leveloffset=+2]

// IP address assignment

include::modules/nw-multus-ipam-object.adoc[leveloffset=+1]

= Creating an additional network attachment

The Cluster Network Operator (CNO) manages additional network definitions. When
you specify an additional network to create, the CNO creates the
`NetworkAttachmentDefinition` object automatically.

[IMPORTANT]
====
Do not edit the `NetworkAttachmentDefinition` objects that the Cluster Network
Operator manages. Doing so might disrupt network traffic on your additional
network.
====

.Prerequisites

* Install the OpenShift CLI (`oc`).
* Log in as a user with `cluster-admin` privileges.

.Procedure

To create an additional network for your cluster, complete the following steps:

. To edit the CNO configuration, enter the following command:
+
[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

. Modify the CR that you are creating by adding the configuration for the
additional network you are creating, as in the following example CR.
+
ifdef::yaml[]
The following YAML configures the {plugin} CNI plug-in:
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  additionalNetworks: <1>
  - name: test-network-1
    namespace: test-1
    type: SimpleMacvlan
    simpleMacvlanConfig:
      ipamConfig:
        type: static
        staticIPAMConfig:
          addresses:
          - address: 10.1.1.7/24
----
endif::yaml[]
ifdef::json[]
The following YAML configures the {plugin} CNI plug-in:
endif::json[]
+
ifeval::["{plugin}" == "bridge"]
[source,yaml,subs="attributes+"]
----
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  additionalNetworks: <1>
  - name: test-network-1
    namespace: test-1
    type: Raw
    rawCNIConfig: '{
      "cniVersion": "0.3.1",
      "name": "test-network-1",
      "type": "{plugin}",
      "ipam": {
        "type": "static",
        "addresses": [
          {
            "address": "192.168.1.23/24"
          }
        ]
      }
    }'
----
endif::[]
ifeval::["{plugin}" == "host-device"]
[source,yaml,subs="attributes+"]
----
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  additionalNetworks: <1>
  - name: test-network-1
    namespace: test-1
    type: Raw
    rawCNIConfig: '{
      "cniVersion": "0.3.1",
      "name": "test-network-1",
      "type": "{plugin}",
      "device": "eth1",
      "ipam": {
        "type": "static",
        "addresses": [
          {
            "address": "192.168.1.23/24"
          }
        ]
      }
    }'
----
endif::[]
ifeval::["{plugin}" == "ipvlan"]
[source,yaml,subs="attributes+"]
----
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  additionalNetworks: <1>
  - name: test-network-1
    namespace: test-1
    type: Raw
    rawCNIConfig: '{
      "cniVersion": "0.3.1",
      "name": "test-network-1",
      "type": "{plugin}",
      "master": "eth1",
      "mode": "l2",
      "ipam": {
        "type": "static",
        "addresses": [
          {
            "address": "192.168.1.23/24"
          }
        ]
      }
    }'
----
endif::[]
ifdef::macvlan+json[]
[source,yaml,subs="attributes+"]
----
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  additionalNetworks: <1>
  - name: test-network-1
    namespace: test-1
    type: Raw
    rawCNIConfig: '{
      "cniVersion": "0.3.1",
      "name": "test-network-1",
      "type": "{plugin}",
      "master": "eth1",
      "ipam": {
        "type": "static",
        "addresses": [
          {
            "address": "192.168.1.23/24"
          }
        ]
      }
    }'
----
endif::[]
<1> Specify the configuration for the additional network attachment definition.

. Save your changes and quit the text editor to commit your changes.

. Confirm that the CNO created the NetworkAttachmentDefinition object by running the following command. Replace `<namespace>` with the namespace that you specified when configuring the network attachment. There might be a delay before the CNO creates the object.
+
[source,terminal]
----
$ oc get network-attachment-definitions -n <namespace>
----
+
.Example output
[source,terminal]
----
NAME                 AGE
test-network-1       14m
----
