[id="configuring-secondary-external-gw"]
= Configure an external gateway through a secondary network interface
include::modules/common-attributes.adoc[]
:context: configuring-secondary-external-gw

toc::[]

As a cluster administrator, you can configure an external gateway on a secondary network. After configuring the external gateway you can apply a label to a namespace so that network traffic from pods in that namespace use the external gateway egress cluster traffic.

This uses an ECMP route.

.Prerequisites

You must have two NIC devices in a system to configure that system to use a secondary network interface as an external gateway.

## How the configuration process works

User-initiated steps
- Apply a label to each node that requires an external gateway
- Create a machine config pool to manage the new machine configuration
- Create a machine config that writes the secondary network interface name to a file

Cluster activity
- Does this make sense? Only after the last step does anything happen.

## Configuring an external gateway for a node

As a cluster administrator, you can configure a node to use a secondary network interface for the external gateway.

.Procedure

. Create a machine config pool:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfigPool
metadata:
  name: worker-cnf
spec:
  machineConfigSelector:
    matchExpressions:
      - {key: machineconfiguration.openshift.io/role, operator: In, values: [worker,worker-cnf]}
  nodeSelector:
    matchLabels:
      node-role.kubernetes.io/worker-cnf: ""
----

. Create a machine config for the machine config pool in the previous step:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
 labels:
 machineconfiguration.openshift.io/role: worker-cnf
 name: create-second-bridge
spec:
 config:
 ignition:
 version: 3.2.0
 storage:
 files:
 - contents:
 source: data:text/plain;charset=utf-8,eno2
 filesystem: root
 mode: 420
 path: /etc/ovnk/extra_bridge
----

. To add a label to the node, enter the following command:
+
[source,terminal]
---
$ oc label node <node> node-role.kubernetes.io/worker-cnf=
---
+
--
where:

`<node>`:: Specifies the name of the node to apply the apply to.
--

.Verification

oc debug node/worer1
chroot /host
ip a show br-ex1
nmcli conn

[source,text]
----
oc debug node/cnfdt08.lab.eng.tlv2.redhat.com
Starting pod/cnfdt08labengtlv2redhatcom-debug ...
To use host binaries, run `chroot /host`
Pod IP: 10.46.55.22
If you don't see a command prompt, try pressing enter.
sh-4.4# chroot /host
sh-4.4#
sh-4.4# ip a show dev br-ex
12: br-ex: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 0c:42:a1:6c:af:7c brd ff:ff:ff:ff:ff:ff
    inet 10.46.55.22/24 brd 10.46.55.255 scope global dynamic noprefixroute br-ex
       valid_lft 30554sec preferred_lft 30554sec
    inet6 fe80::aed4:5ac0:fa9a:2c9b/64 scope link noprefixroute
       valid_lft forever preferred_lft forever

sh-4.4# ip a show dev br-ex1
14: br-ex1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 0c:42:a1:6c:af:7d brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.50/24 brd 192.168.1.255 scope global noprefixroute br-ex1
       valid_lft forever preferred_lft forever
    inet6 fe80::80dd:8b2b:efd5:a118/64 scope link noprefixroute
       valid_lft forever preferred_lft forever

sh-4.4# nmcli conn show
NAME              UUID                                  TYPE           DEVICE
ovs-if-br-ex      4a727543-6ea4-40ee-91c8-a2e70d3137a7  ovs-interface  br-ex
ovs-if-br-ex1     64c6e4c6-9b2b-473e-8ca4-de418567fd6e  ovs-interface  br-ex1
br-ex             cd3fdad1-67c0-4e29-b732-dd0aad820152  ovs-bridge     br-ex
br-ex1            deae697f-5dd6-4d37-8176-e45ad42e2b6c  ovs-bridge     br-ex1
ovs-if-phys0      716e81a9-2e24-414f-b04c-c7c6b9a8e4f5  ethernet       eno1
ovs-if-phys1      e7418b82-931b-47f5-9abf-cc28bd9d109d  ethernet       eno2
ovs-port-br-ex    941fc8c4-d4f2-4187-89d0-785506c2fbd0  ovs-port       br-ex
ovs-port-br-ex1   2f873db1-ed4d-4e01-8fa5-4ad287d0c389  ovs-port       br-ex1
ovs-port-phys0    4dc36b5b-5690-405f-a4cd-b95d9f0fa772  ovs-port       eno1
ovs-port-phys1    3034f602-9f0c-4856-94a7-4f6128798a46  ovs-port       eno2
Wired Connection  85446fbd-802b-4c7f-b501-86506c5eaf3b  ethernet       --
Wired Connection  18e51b16-9e1e-4503-8386-dce770ca49c5  ethernet       --
eno2              e82a18cf-080b-4c52-acae-faaa69458afe  ethernet       --
----

.Procedure

oc annotate namespaces z1 "k8s.ovn.org/routing-external-gws"="192.168.1.51"

.Verification

. Find pods for OVN-Kubernetes.

oc rsh -n openshift-ovn-kuberentes ovnkube-master-4glh2

ovn-nbctl lr-route-list GR_cnfdt08.lab.eng.tlv2.redhat.com

IPv4 Routes
              10.132.2.48              192.168.1.51 src-ip exgw-rtoe-GR_cnfdt08.lab.eng.tlv2.redhat.com ecmp-symmetric-reply
            10.132.0.0/14                100.64.0.1 dst-ip
                0.0.0.0/0              10.46.55.254 dst-ip rtoe-GR_cnfdt08.lab.eng.tlv2.redhat.com

