////
etcd restore

Module included in the following assemblies:

* admin_guide/assembly_restoring-cluster.adoc
* day_two_guide/host_level_tasks.adoc
* upgrading/downgrade.adoc
////

[id='restoring-etcd_{context}']
= Restoring etcd

== Restoring the etcd configuration file

If an etcd host has become corrupted and the `/etc/etcd/etcd.conf` file is lost,
restore it using the following procedure:

. Access your etcd host:
+
----
$ ssh master-0 <1>
----
<1> Replace `master-0` with the name of your etcd host.

. Copy the backup `etcd.conf` file to `/etc/etcd/`:
+
----
# cp /backup/etcd-config-<timestamp>/etcd/etcd.conf /etc/etcd/etcd.conf
----

. Set the required permissions and selinux context on the file:
+
----
# restorecon -RvF /etc/etcd/etcd.conf
----

In this example, the backup file is stored in the
`/backup/etcd-config-<timestamp>/etcd/etcd.conf` path where it can be used as an
external NFS share, S3 bucket, or other storage solution.

After the etcd configuration file is restored, you must restart the static pod. This is done after you restore the etcd data.

== Restoring etcd data

Before restoring etcd on a static pod:

* `etcdctl` binaries must be available or, in containerized installations,
the `rhel7/etcd` container must be available.
+
You can install the `etcdctl` binary with the etcd package by running the following commands:
+
----
# yum install etcd
----
+
The package also installs the systemd service. Disable and mask the service so that it does not run as a systemd service when etcd runs in static pod. By disabling and masking the service, you ensure that you do not accidentally start it and prevent it from automatically restarting when you reboot the system.
+
----
# systemctl disable etcd.service
----
+
----
# systemctl mask etcd.service
----

To restore etcd on a static pod:

. If the pod is running, stop the etcd pod by moving the pod manifest YAML file
to another directory:
+
----
# mkdir -p /etc/origin/node/pods-stopped
----
+
----
# mv /etc/origin/node/pods/etcd.yaml /etc/origin/node/pods-stopped
----

. Move all old data:
+
----
# mv /var/lib/etcd /var/lib/etcd.old
----
+
You use the etcdctl to recreate the data in the node where you restore the pod.

. Restore the etcd snapshot to the mount path for the etcd pod:
+
----
# export ETCDCTL_API=3
----
+
----
# etcdctl snapshot restore /etc/etcd/backup/etcd/snapshot.db \
	 --data-dir /var/lib/etcd/ \
	 --name ip-172-18-3-48.ec2.internal \
	 --initial-cluster "ip-172-18-3-48.ec2.internal=https://172.18.3.48:2380" \
	 --initial-cluster-token "etcd-cluster-1" \
	 --initial-advertise-peer-urls https://172.18.3.48:2380 \
	 --skip-hash-check=true
----
+
Obtain the appropriate values for your cluster from your backup *_etcd.conf_* file.

. Set required permissions and selinux context on the data directory:
+
----
# restorecon -RvF /var/lib/etcd/
----

. Restart the etcd pod by moving the pod manifest YAML file to the required
directory:
+
----
# mv /etc/origin/node/pods-stopped/etcd.yaml /etc/origin/node/pods/
----
