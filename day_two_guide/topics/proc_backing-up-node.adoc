////
Creating a node host backup

Module included in the following assemblies:

* day_two_guide/host_level_tasks.adoc
* day_two_guide/environment_backup.adoc
////

[id='backing-up-node_{context}']
= Creating a node host backup

Creating a backup of a node host is a different use case from backing up a
master host. Because master hosts contain many important files, creating a
backup is highly recommended. However, the nature of nodes is that anything
special is replicated over the nodes in case of failover, and they typically do
not contain data that is necessary to run an environment. If a backup of a node
contains something necessary to run an environment, then a creating a backup is
recommended.

The backup process is to be performed before any change to the infrastructure,
such as a system update, upgrade, or any other significant modification. Backups
should be performed on a regular basis to ensure the most recent data is
available if a failure occurs.

*{product-title} files*

Node instances run applications in the form of pods, which are based on
containers. The `/etc/origin/` and `/etc/origin/node` directories house
important files, such as:

* The configuration of the node services 
* Certificates generated by the installation
* Cloud provider-related configuration
* Keys and other authentication files, such as the `dnsmasq` configuration

The {product-title} services can be customized to increase the log level, use
proxies, and more, and the configuration files are stored in the
`/etc/sysconfig` directory.

[discrete]
== Procedure

. Create a backup of the node configuration files:
+
----
$ MYBACKUPDIR=/backup/$(hostname)/$(date +%Y%m%d)
$ sudo mkdir -p ${MYBACKUPDIR}/etc/sysconfig
$ sudo cp -aR /etc/origin ${MYBACKUPDIR}/etc
$ sudo cp -aR /etc/sysconfig/atomic-openshift-node ${MYBACKUPDIR}/etc/sysconfig/
----

. {product-title} uses specific files that must be taken into account when
planning the backup policy, including:
+
|===
^|File ^|Description
|`/etc/cni/*` |Container Network Interface configuration (if used)
| `/etc/sysconfig/iptables` |Where the `iptables` rules are stored
| `/etc/sysconfig/docker-storage-setup` |The input file for `container-storage-setup` command
| `/etc/sysconfig/docker` |The `docker` configuration file
| `/etc/sysconfig/docker-network` |`docker` networking configuration (i.e. MTU)
| `/etc/sysconfig/docker-storage` |`docker` storage configuration (generated by `container-storage-setup`)
| `/etc/dnsmasq.conf` |Main configuration file for `dnsmasq`
| `/etc/dnsmasq.d/*` |Different `dnsmasq` configuration files
| `/etc/sysconfig/flanneld` |`flannel` configuration file (if used)
| `/etc/pki/ca-trust/source/anchors/` |Certificates added to the system (i.e. for external registries)
|===
+
To create those files:
+
----
$ MYBACKUPDIR=/backup/$(hostname)/$(date +%Y%m%d)
$ sudo mkdir -p ${MYBACKUPDIR}/etc/sysconfig
$ sudo mkdir -p ${MYBACKUPDIR}/etc/pki/ca-trust/source/anchors
$ sudo cp -aR /etc/sysconfig/{iptables,docker-*,flanneld} \
    ${MYBACKUPDIR}/etc/sysconfig/
$ sudo cp -aR /etc/dnsmasq* /etc/cni ${MYBACKUPDIR}/etc/
$ sudo cp -aR /etc/pki/ca-trust/source/anchors/* \
    ${MYBACKUPDIR}/etc/pki/ca-trust/source/anchors/
----

. If a package is accidentally removed, or a file included in an `rpm`
package should be restored, having a list of `rhel` packages installed on the
system can be useful.
+
[NOTE]
====
If using Red Hat Satellite features, such as content views or the facts store,
provide a proper mechanism to reinstall the missing packages and a historical
data of packages installed in the systems.
====
+
To create a list of the current `rhel` packages installed in the system:
+
----
$ MYBACKUPDIR=/backup/$(hostname)/$(date +%Y%m%d)
$ sudo mkdir -p ${MYBACKUPDIR}
$ rpm -qa | sort | sudo tee $MYBACKUPDIR/packages.txt
----

. The following files should now be present in the backup directory:
+
----
$ MYBACKUPDIR=/backup/$(hostname)/$(date +%Y%m%d)
$ sudo find ${MYBACKUPDIR} -mindepth 1 -type f -printf '%P\n'
etc/sysconfig/atomic-openshift-node
etc/sysconfig/flanneld
etc/sysconfig/iptables
etc/sysconfig/docker-network
etc/sysconfig/docker-storage
etc/sysconfig/docker-storage-setup
etc/sysconfig/docker-storage-setup.rpmnew
etc/origin/node/system:node:app-node-0.example.com.crt
etc/origin/node/system:node:app-node-0.example.com.key
etc/origin/node/ca.crt
etc/origin/node/system:node:app-node-0.example.com.kubeconfig
etc/origin/node/server.crt
etc/origin/node/server.key
etc/origin/node/node-dnsmasq.conf
etc/origin/node/resolv.conf
etc/origin/node/node-config.yaml
etc/origin/node/flannel.etcd-client.key
etc/origin/node/flannel.etcd-client.csr
etc/origin/node/flannel.etcd-client.crt
etc/origin/node/flannel.etcd-ca.crt
etc/origin/cloudprovider/openstack.conf
etc/pki/ca-trust/source/anchors/openshift-ca.crt
etc/pki/ca-trust/source/anchors/registry-ca.crt
etc/dnsmasq.conf
etc/dnsmasq.d/origin-dns.conf
etc/dnsmasq.d/origin-upstream-dns.conf
etc/dnsmasq.d/node-dnsmasq.conf
packages.txt
----
+
If needed, the files can be compressed to save space:
+
----
$ MYBACKUPDIR=/backup/$(hostname)/$(date +%Y%m%d)
$ sudo tar -zcvf /backup/$(hostname)-$(date +%Y%m%d).tar.gz $MYBACKUPDIR
$ sudo rm -Rf ${MYBACKUPDIR}
----

To create any of these files from scratch, the `openshift-ansible-contrib`
repository contains the `backup_master_node.sh` script, which performs the
previous steps. The script creates a directory on the host running the script
and copies all the files previously mentioned.

[NOTE]
====
The `openshift-ansible-contrib` script is not supported by Red Hat, but the
reference architecture team performs testing to ensure the code operates as
defined and is secure.
====

The script can be executed on every master host with:

----
$ mkdir ~/git
$ cd ~/git
$ git clone https://github.com/openshift/openshift-ansible-contrib.git
$ cd openshift-ansible-contrib/reference-architecture/day2ops/scripts
$ ./backup_master_node.sh -h
----
