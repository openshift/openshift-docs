////
Creating a master host backup

Module included in the following assemblies:

* day_two_guide/host_level_tasks.adoc
////

The backup process is to be performed before any change to the infrastructure,
such as a system update, upgrade, or any other significant modification. Backups
should be performed on a regular basis to ensure the most recent data is
available if a failure occurs.

*{product-title} files*

The master instances run important services, such as the API, controllers. The `/etc/origin/master` directory stores many important files:

* The configuration the API, controllers, services, and more
* Certificates generated by the installation
* All cloud provider-related configuration
* Keys and other authentication files, such as `htpasswd` if using htpasswd
* And more

The {product-title} services can be customized to increase the log level, use
proxies, and so on. The configuration files are stored in the `/etc/sysconfig`
directory.

Because the masters are also unschedulable nodes, back up the entire
`/etc/origin` directory.

[discrete]
== Procedure

. Create a backup of the master host configuration files:
+
----
$ MYBACKUPDIR=/backup/$(hostname)/$(date +%Y%m%d)
$ sudo mkdir -p ${MYBACKUPDIR}/etc/sysconfig
$ sudo cp -aR /etc/origin ${MYBACKUPDIR}/etc
$ sudo cp -aR /etc/sysconfig/atomic-* ${MYBACKUPDIR}/etc/sysconfig/
----
+
[NOTE]
====
On a single master cluster installation the configuration file is stored in the
`/etc/sysconfig/atomic-openshift-master`, whereas in a multi-master environment
`/etc/sysconfig/atomic-openshift-master-api`, and
`/etc/sysconfig/atomic-openshift-master-controllers` are used.
====
+
[WARNING]
====
At the time of writing, the `/etc/origin/master/ca.serial.txt` file is generated
onto only the first master listed in the Ansible host inventory. This is being
investigated to be fixed for future {product-title} releases in the
https://bugzilla.redhat.com/show_bug.cgi?id=1469358[1469358 bugzilla]. If
deprecating the first master host, copy the `/etc/origin/master/ca.serial.txt`
file to the rest of master hosts before the process.
====

. Other important files that need to be considered  when planning a backup
include:
+
|===
^|File ^|Description
|`/etc/cni/*` |Container Network Interface configuration (if used)
| `/etc/sysconfig/iptables` |Where the `iptables` rules are stored
| `/etc/sysconfig/docker-storage-setup` |The input file for `container-storage-setup` command
| `/etc/sysconfig/docker` |The `docker` configuration file
| `/etc/sysconfig/docker-network` |`docker` networking configuration (i.e. MTU)
| `/etc/sysconfig/docker-storage` |`docker` storage configuration (generated by `container-storage-setup`)
| `/etc/dnsmasq.conf` |Main configuration file for `dnsmasq`
| `/etc/dnsmasq.d/*` |Different `dnsmasq` configuration files
| `/etc/sysconfig/flanneld` |`flannel` configuration file (if used)
| `/etc/pki/ca-trust/source/anchors/` |Certificates added to the system (i.e. for external registries)
|===
+
Create a backup of those files:
+
----
$ MYBACKUPDIR=/backup/$(hostname)/$(date +%Y%m%d)
$ sudo mkdir -p ${MYBACKUPDIR}/etc/sysconfig
$ sudo mkdir -p ${MYBACKUPDIR}/etc/pki/ca-trust/source/anchors
$ sudo cp -aR /etc/sysconfig/{iptables,docker-*,flanneld} \
    ${MYBACKUPDIR}/etc/sysconfig/
$ sudo cp -aR /etc/dnsmasq* /etc/cni ${MYBACKUPDIR}/etc/
$ sudo cp -aR /etc/pki/ca-trust/source/anchors/* \
    ${MYBACKUPDIR}/etc/pki/ca-trust/source/anchors/
----

. If a package is accidentally removed, or a file included in an `rpm`
package should be restored, having a list of `rhel` packages installed on the
system can be useful.
+
[NOTE]
====
If using Red Hat Satellite features, such as content views or the facts store,
provide a proper mechanism to reinstall the missing packages and a historical
data of packages installed in the systems.
====
+
To create a list of the current `rhel` packages installed in the system:
+
----
$ MYBACKUPDIR=/backup/$(hostname)/$(date +%Y%m%d)
$ sudo mkdir -p ${MYBACKUPDIR}
$ rpm -qa | sort | sudo tee $MYBACKUPDIR/packages.txt
----

. If using the previous steps, the following files should now be present in the
backup directory:
+
----
$ MYBACKUPDIR=/backup/$(hostname)/$(date +%Y%m%d)
$ sudo find ${MYBACKUPDIR} -mindepth 1 -type f -printf '%P\n'
etc/sysconfig/atomic-openshift-master
etc/sysconfig/atomic-openshift-master-api
etc/sysconfig/atomic-openshift-master-controllers
etc/sysconfig/atomic-openshift-node
etc/sysconfig/flanneld
etc/sysconfig/iptables
etc/sysconfig/docker-network
etc/sysconfig/docker-storage
etc/sysconfig/docker-storage-setup
etc/sysconfig/docker-storage-setup.rpmnew
etc/origin/master/ca.crt
etc/origin/master/ca.key
etc/origin/master/ca.serial.txt
etc/origin/master/ca-bundle.crt
etc/origin/master/master.proxy-client.crt
etc/origin/master/master.proxy-client.key
etc/origin/master/service-signer.crt
etc/origin/master/service-signer.key
etc/origin/master/serviceaccounts.private.key
etc/origin/master/serviceaccounts.public.key
etc/origin/master/openshift-master.crt
etc/origin/master/openshift-master.key
etc/origin/master/openshift-master.kubeconfig
etc/origin/master/master.server.crt
etc/origin/master/master.server.key
etc/origin/master/master.kubelet-client.crt
etc/origin/master/master.kubelet-client.key
etc/origin/master/admin.crt
etc/origin/master/admin.key
etc/origin/master/admin.kubeconfig
etc/origin/master/etcd.server.crt
etc/origin/master/etcd.server.key
etc/origin/master/master.etcd-client.key
etc/origin/master/master.etcd-client.csr
etc/origin/master/master.etcd-client.crt
etc/origin/master/master.etcd-ca.crt
etc/origin/master/policy.json
etc/origin/master/scheduler.json
etc/origin/master/htpasswd
etc/origin/master/session-secrets.yaml
etc/origin/master/openshift-router.crt
etc/origin/master/openshift-router.key
etc/origin/master/registry.crt
etc/origin/master/registry.key
etc/origin/master/master-config.yaml
etc/origin/generated-configs/master-master-1.example.com/master.server.crt
...[OUTPUT OMITTED]...
etc/origin/cloudprovider/openstack.conf
etc/origin/node/system:node:master-0.example.com.crt
etc/origin/node/system:node:master-0.example.com.key
etc/origin/node/ca.crt
etc/origin/node/system:node:master-0.example.com.kubeconfig
etc/origin/node/server.crt
etc/origin/node/server.key
etc/origin/node/node-dnsmasq.conf
etc/origin/node/resolv.conf
etc/origin/node/node-config.yaml
etc/origin/node/flannel.etcd-client.key
etc/origin/node/flannel.etcd-client.csr
etc/origin/node/flannel.etcd-client.crt
etc/origin/node/flannel.etcd-ca.crt
etc/pki/ca-trust/source/anchors/openshift-ca.crt
etc/pki/ca-trust/source/anchors/registry-ca.crt
etc/dnsmasq.conf
etc/dnsmasq.d/origin-dns.conf
etc/dnsmasq.d/origin-upstream-dns.conf
etc/dnsmasq.d/node-dnsmasq.conf
packages.txt
----
+
If needed, the files can be compressed to save space:
+
----
$ MYBACKUPDIR=*/backup/$(hostname)/$(date +%Y%m%d)*
$ sudo tar -zcvf */backup/*$(hostname)-$(date +%Y%m%d).tar.gz $MYBACKUPDIR
$ sudo rm -Rf ${MYBACKUPDIR}
----

To create any of these files from scratch, the `openshift-ansible-contrib`
repository contains the `backup_master_node.sh` script, which performs the
previous steps. The script creates a directory on the host running the script
and copies all the files previously mentioned.

[NOTE]
====
The `openshift-ansible-contrib` script is not supported by Red Hat, but the
reference architecture team performs testing to ensure the code operates as
defined and is secure.
====

The script can be executed on every master host with:

----
$ mkdir ~/git
$ cd ~/git
$ git clone https://github.com/openshift/openshift-ansible-contrib.git
$ cd openshift-ansible-contrib/reference-architecture/day2ops/scripts
$ ./backup_master_node.sh -h
----

