= Creating Prow jobs for openshift-docs branches

To populate the `$HOME/release/ci-operator/config/openshift/openshift-docs` directory with a new Prow job branch configuration, use the `add-new-prow-config.sh` script.

The script uses the `./openshift-openshift-docs-BRANCH.yaml` template file to create the new job config.

To create the Prow jobs, you must run the CI make jobs. Then, open a pull request against the https://github.com/openshift/release repository to make the Prow job live for that branch.

.Prerequisites

. You have installed link:https://podman.io/docs/installation[Podman].

. You have forked the https://github.com/openshift/release repository.
+
For more information on how to fork a repository, see link:https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/fork-a-repo[Fork a repository] (GitHub documentation).

. You have cloned the OpenShift release repository to `$HOME/release`:
+
[IMPORTANT]
====
If you have already cloned the repository, ensure that it is up to date by running the following commands:

[source,terminal]
----
$ cd $HOME/release
----
[source,terminal]
----
$ git checkout master
----
[source,terminal]
----
$ git fetch upstream
----
[source,terminal]
----
$ git rebase upstream/master
----
====

.. To clone the OpenShift release repository, run the `git clone` command, and save it to the `$HOME/release` directory on your local machine.

.. To add the OpenShift release repository as an upstream remote, run the following command:
+
[source,terminal]
----
$ git remote add upstream git@github.com:openshift/release.git
----

. Create a local branch in your fork of the `release` repository:
.. To switch to the `$HOME/release` directory, run the following command:
+
[source,terminal]
----
cd $HOME/release
----
.. To create a new branch, run the following command:
+
[source,terminal]
----
$ git checkout -b <new_branch_name> upstream/master
----

. MacOS only: You have installed the `gettext` package:
** To install the the `gettext` package, run the following commands:
+
[source,terminal]
----
$ brew install gettext
----
+
[source,terminal]
----
$ brew link --force gettext
----

.Procedure

. Switch to your `openshift-docs` directory.
. Check out the `main` branch, fetch from upstream, and rebase against upstream.
. To create the new branch config, run the `add-new-prow-config.sh` script passing the `$VERSION`, `$BRANCH` and `$DISTROS` variables, for example:
+
[source,terminal]
----
./scripts/prow/add-new-prow-config.sh 4.15 enterprise-4.15 "openshift-enterprise openshift-rosa openshift-rosa-hcp openshift-dedicated microshift"
----
+
The script copies the new job YAML to the ci-operator config folder in the `$HOME/release` directory.
+
[IMPORTANT]
====
`openshift-rosa`, `openshift-rosa-hcp`, and `openshift-osd` distros should be included in `main`, current, and future enterprise branch builds only.
When you add a new enterprise branch, remember to remove `openshift-rosa`, `openshift-rosa-hcp`, and `openshift-osd` distros from the most recent enterprise branch.

For example, when the current version is 4.15, and you create a enterprise-4.16 branch, remove `openshift-rosa` and `openshift-osd` distros from the enterprise-4.15 branch build.

For more information about how to add an `openshift-docs-vale-review` and `openshift-docs-jira-links` test step to the `validate-asciidoc` job, see link:https://steps.ci.openshift.org/job?org=openshift&repo=openshift-docs&branch=main&test=validate-asciidoc[openshift-docs test steps].
====

. Switch to the `$HOME/release` directory.
. To verify that the new build config has been added, run the following command by using the prow job you created in the previous step, for example:
+
[source,terminal]
----
$ ls /home/agantony/release/ci-operator/config/openshift/openshift-docs/openshift-openshift-docs-rhacs-docs-4.8.yaml
----

. To generate the rest of the Prow build configuration, run the following commands:
+
[source,terminal]
----
$ make prow-config CONTAINER_ENGINE=podman WHAT=openshift/openshift-docs
----
+
[source,terminal]
----
$ make CONTAINER_ENGINE=podman ci-operator-config WHAT=openshift/openshift-docs
----
+
[source,terminal]
----
$ make jobs CONTAINER_ENGINE=podman WHAT=openshift/openshift-docs
----
+
[IMPORTANT]
====
Ensure that the each of the `make` commands completes without displaying an error.
====

. To verify that the OpenShift CI configuration files are present, run the `git status` command.

. Commit your changes and open a pull request (PR) against the `openshift/release` `master` branch. Ensure that all Prow CI tests pass. Add a `/pj-rehearse` comment in the PR to verify the new build.

. Get an `/lgtm` approval from someone in the openshift-docs link:https://github.com/openshift/release/blob/master/ci-operator/config/openshift/openshift-docs/OWNERS[OWNERS] file.

. When you want to schedule the job for merge, add a `/pj-rehearse ack` comment to the pull request.
The PR is merged automatically when all required approvals are provided and the PR passes all the required CI jobs.
When the PR is merged, the job goes live on the relevant openshift-docs branch PRs.
+
[IMPORTANT]
====
Rebase often on the release branch when you open a pull request.
The repository is very busy and the underlying infrastructure changes daily.
Every time you rebase, rerun the CI make jobs.
====
+
For more information, see link:https://docs.ci.openshift.org/docs/how-tos/contributing-openshift-release/[Contributing CI configuration to the openshift/release repository].