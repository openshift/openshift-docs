:_mod-docs-content-type: ASSEMBLY
[id="rosa-hcp-creating-cluster-with-aws-kms-key"]
= Creating ROSA with HCP clusters using a custom AWS KMS encryption key
include::includes/attributes-openshift-dedicated.adoc[]
:context: rosa-hcp-creating-cluster-with-aws-kms-key


Create a {product-title} (ROSA) with a {hcp} (HCP) cluster  using a custom AWS Key Management Service (KMS) key.

//include::includes/rosa-sts-creating-a-cluster-quickly-ocm.adoc[leveloffset=+1]
//include::includes/rosa-sts-associating-your-aws-account.adoc[leveloffset=+2]

[id="rosa-hcp-creating-cluster-with-aws-kms-key-prereqs"]
== {hcp-title} Prerequisites

To create a {hcp-title} cluster, you must have the following items:

* A configured virtual private cloud (VPC)
* Account-wide roles
* An OIDC configuration
* Operator roles

[id="rosa-hcp-creating-cluster-with-aws-kms-key-creating-vpc"]
=== Creating a Virtual Private Cloud for your {hcp-title} clusters

You must have a Virtual Private Cloud (VPC) to create {hcp-title} cluster. You can use the following methods to create a VPC: 

* Create a VPC by using a Terraform template
* Manually create the VPC resources in the AWS console

[NOTE]
====
The Terraform instructions are for testing and demonstration purposes. Your own installation requires some modifications to the VPC for your own use. You should also ensure that when you use this Terraform script it is in the same region that you intend to install your cluster. In these examples, use `us-east-2`.
====

include::includes/imp-rosa-hcp-no-shared-vpc-support.adoc[leveloffset=+0]

[discrete]
include::includes/rosa-hcp-vpc-terraform.adoc[leveloffset=+3]

[role="_additional-resources"]
.Additional resources

* See the link:https://github.com/openshift-cs/terraform-vpc-example[Terraform VPC] repository for a detailed list of all options available when customizing the VPC for your needs.

[discrete]
include::includes/rosa-hcp-vpc-manual.adoc[leveloffset=+3]

[role="_additional-resources"]
.Additional resources

* link:https://docs.aws.amazon.com/vpc/latest/userguide/vpc-getting-started.html[Get Started with Amazon VPC]
* link:https://developer.hashicorp.com/terraform[HashiCorp Terraform documentation]

include::includes/rosa-hcp-creating-account-wide-sts-roles-and-policies.adoc[leveloffset=+2]

include::includes/rosa-sts-byo-oidc.adoc[leveloffset=+2]

include::includes/rosa-operator-config.adoc[leveloffset=+2]

include::includes/creating-cluster-with-aws-kms-key.adoc[leveloffset=+2]

[role="_additional-resources"]
[id="additional-resources_rosa-hcp-operator-prefix"]

[id="next-steps-2_{context}"]
== Next steps

* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.16/html-single/install_rosa_classic_clusters/#rosa-sts-accessing-cluster[Accessing a ROSA cluster]

[role="_additional-resources"]
[id="additional-resources_rosa-hcp-creating-cluster-with-aws-kms-key"]
== Additional resources

* For information on using the CLI to create a cluster, see xref:rosa-hcp-sts-creating-a-cluster-cli_rosa-hcp-sts-creating-a-cluster-quickly[Creating a ROSA with HCP cluster using the CLI].
* For steps to deploy a ROSA cluster using manual mode, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.16/html-single/install_rosa_classic_clusters/#rosa-sts-creating-cluster-using-customizations_rosa-sts-creating-a-cluster-with-customizations[Creating a cluster using customizations].
* For more information about the AWS Identity Access Management (IAM) resources required to deploy {product-title} with STS, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.16/html-single/introduction_to_rosa/#rosa-sts-about-iam-resources[About IAM resources for clusters that use STS].
* For details about optionally setting an Operator role name prefix, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.16/html-single/introduction_to_rosa/#rosa-sts-about-operator-role-prefixes_rosa-sts-about-iam-resources[About custom Operator IAM role prefixes].
* For information about the prerequisites to installing ROSA with STS, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.16/html-single/prepare_your_environment/#rosa-sts-aws-prereqs[AWS prerequisites for ROSA with STS].
* For details about using the `auto` and `manual` modes to create the required STS resources, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.16/html-single/install_rosa_classic_clusters/#rosa-understanding-deployment-modes_rosa-sts-creating-a-cluster-with-customizations[Understanding the auto and manual deployment modes].
* For more information about using OpenID Connect (OIDC) identity providers in AWS IAM, see link:https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html[Creating OpenID Connect (OIDC) identity providers].
* For more information about troubleshooting ROSA cluster installations, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.16/html-single/support/#rosa-troubleshooting-installations[Troubleshooting installations].
* For steps to contact Red Hat Support for assistance, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.16/html-single/support/#getting-support[Getting support for Red Hat OpenShift Service on AWS].
