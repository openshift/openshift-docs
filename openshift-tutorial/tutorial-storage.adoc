[[openshift-tutorial-configure]]
= Add Some Storage
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]
{nbsp} +


== Overview


[[deploy-internal-registry]]
== Deploy an Internal Registry

Openshift provides an internal, xref:../architecture/infrastructure_components/image_registry.adoc#integrated-openshift-registry[integrated Docker registry] that can be deployed
to locally manage images. OpenShift uses the *docker-registry* to store,
retrieve, and build Docker images, as well as deploy and manage them throughout
their lifecycle.

The installer creates a default registry.

. Delete the default registry using the following command.
+
----
oc delete all -l docker-registry=default
----

. Create the *docker-registry* service in the *default* project using the
*registry* service account.
+
----
$ oadm registry
----

[[create-persistent-storage-for-registry]]
== Create Persistent Storage for the Registry

The registry that you created in the previous step stores images and metadata,
and uses an ephemeral volume for any pod deployment if persistent storage is not
configured. This ephemeral volume is destroyed when the pod exits, losing all
data, including any images built or pushed into the registry.

To configure persistent storage for the registry:

* Provision a volume that points to a storage server on your network (we will just
create it on the master).
* Create a volume claim.
* Manually add the claim to the registry service.

NOTE: The following steps to configure persistent storage for the registry apply
to storage for any image that requires persistent data and not just for the
registry. The registry is just another image in the OpenShift environment.

[[provision-persistent-volume]]
=== Provision the Persistent Volume

. Create a registry volume file on your master, as shown here, and call it
*_registry-volume.yaml_*.
+
[subs="verbatim,macros"]
----
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pass:quotes[_registry-volume_]
spec:
  capacity:
    storage: pass:quotes[_3Gi_]
  accessModes:
  - ReadWriteMany
  nfs:
    path: /root/storage
    server: master.openshift.example.com
----
+
The folder *_/root/storage_* must exist. Make sure to change the server entry to
point to your master.

. Create the registry persistent volume in OpenShift.
+
----
$ oc create -f registry-volume.yaml
----

[[create-persistent-volume-claim]]
=== Create the Persistent Volume Claim

Create a claim to bind the persistent volume created earlier. This claim is what
ties the registry service to the persistent volume.

. Create another file called *_registry-volume-claim.yaml_*.
+
[subs="verbatim,macros"]
----
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pass:quotes[_registry-volume-claim_]
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 3Gi
----

. Create the claim.
+
----
$ oc create -f registry-volume-claim.yaml
----

You have now created the Persistent Volume and the Persistent Volume Claim, and
now need to add this claim to the registry.

[[add-claim-to-registry]]
=== Add the Persistent Volume Claim to the Registry

[subs="verbatim,macros"]
----
$ oc volume dc/docker-registry --add --overwrite -t persistentVolumeClaim --claim-name=pass:quotes[_registry-volume-claim_] --name=registry-storage
----

The *docker-registry* will now use the 3 GB persistent volume created for
storing image and metadata.

